--- 开始文件: VocabularyAddTo.java ---

package com.vue.readingapp.vocabulary;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.support.GeneratedKeyHolder;
import org.springframework.jdbc.support.KeyHolder;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.PreparedStatement;
import java.sql.Statement;
import java.util.*;
import java.time.LocalDateTime;

@RestController
@RequestMapping("/api/v1/vocabulary")
public class VocabularyAddTo {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到添加到生词本请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class AddToVocabularyRequest {
        private String word;
        private String definition;
        private String example;
        private List<String> tags;
        private String language;
        private String source;
        private Integer sourcePage;
        private String notes;

        public String getWord() { return word; }
        public void setWord(String word) { this.word = word; }

        public String getDefinition() { return definition; }
        public void setDefinition(String definition) { this.definition = definition; }

        public String getExample() { return example; }
        public void setExample(String example) { this.example = example; }

        public List<String> getTags() { return tags; }
        public void setTags(List<String> tags) { this.tags = tags; }

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }

        public String getSource() { return source; }
        public void setSource(String source) { this.source = source; }

        public Integer getSourcePage() { return sourcePage; }
        public void setSourcePage(Integer sourcePage) { this.sourcePage = sourcePage; }

        public String getNotes() { return notes; }
        public void setNotes(String notes) { this.notes = notes; }
    }

    // 响应DTO
    public static class AddToVocabularyResponse {
        private boolean success;
        private String message;
        private VocabularyItemData data;

        public AddToVocabularyResponse(boolean success, String message, VocabularyItemData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public VocabularyItemData getData() { return data; }
        public void setData(VocabularyItemData data) { this.data = data; }
    }

    public static class VocabularyItemData {
        private Long id;
        private String word;
        private String language;
        private String definition;
        private String example;
        private List<String> tags;
        private String notes;
        private String status;
        private Integer masteryLevel;
        private Integer reviewCount;
        private String lastReviewedAt;
        private String nextReviewAt;
        private String source;
        private Integer sourcePage;
        private String createdAt;
        private String updatedAt;

        public VocabularyItemData() {
            this.tags = new ArrayList<>();
        }

        // Getters and Setters
        public Long getId() { return id; }
        public void setId(Long id) { this.id = id; }

        public String getWord() { return word; }
        public void setWord(String word) { this.word = word; }

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }

        public String getDefinition() { return definition; }
        public void setDefinition(String definition) { this.definition = definition; }

        public String getExample() { return example; }
        public void setExample(String example) { this.example = example; }

        public List<String> getTags() { return tags; }
        public void setTags(List<String> tags) { this.tags = tags; }

        public String getNotes() { return notes; }
        public void setNotes(String notes) { this.notes = notes; }

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public Integer getMasteryLevel() { return masteryLevel; }
        public void setMasteryLevel(Integer masteryLevel) { this.masteryLevel = masteryLevel; }

        public Integer getReviewCount() { return reviewCount; }
        public void setReviewCount(Integer reviewCount) { this.reviewCount = reviewCount; }

        public String getLastReviewedAt() { return lastReviewedAt; }
        public void setLastReviewedAt(String lastReviewedAt) { this.lastReviewedAt = lastReviewedAt; }

        public String getNextReviewAt() { return nextReviewAt; }
        public void setNextReviewAt(String nextReviewAt) { this.nextReviewAt = nextReviewAt; }

        public String getSource() { return source; }
        public void setSource(String source) { this.source = source; }

        public Integer getSourcePage() { return sourcePage; }
        public void setSourcePage(Integer sourcePage) { this.sourcePage = sourcePage; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }
    }

    @PostMapping("")
    public ResponseEntity<AddToVocabularyResponse> addToVocabulary(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestBody AddToVocabularyRequest request) {

        printRequest(request);

        try {
            // 1. 验证请求数据
            if (request.getWord() == null || request.getWord().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new AddToVocabularyResponse(false, "单词不能为空", null)
                );
            }

            // 2. 验证用户身份
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new AddToVocabularyResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > ?";
            LocalDateTime now = LocalDateTime.now();
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(userSql, token, now);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new AddToVocabularyResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Long userId = ((Number) sessions.get(0).get("user_id")).longValue();

            // 3. 检查单词是否已存在
            String normalizedWord = request.getWord().trim().toLowerCase();
            String language = request.getLanguage() != null ? request.getLanguage() : "en";

            String checkSql = "SELECT user_vocab_id FROM user_vocabulary WHERE user_id = ? AND word = ? AND language = ?";
            List<Map<String, Object>> existingItems = jdbcTemplate.queryForList(checkSql, userId, normalizedWord, language);

            if (!existingItems.isEmpty()) {
                return ResponseEntity.status(HttpStatus.CONFLICT).body(
                        new AddToVocabularyResponse(false, "单词已在生词本中", null)
                );
            }

            // 4. 插入到生词本
            String insertSql = "INSERT INTO user_vocabulary (user_id, word, language, definition, example, notes, " +
                    "status, mastery_level, review_count, source, source_page, created_at, updated_at) " +
                    "VALUES (?, ?, ?, ?, ?, ?, 'new', 0, 0, ?, ?, ?, ?)";

            KeyHolder keyHolder = new GeneratedKeyHolder();
            LocalDateTime currentTime = LocalDateTime.now();

            jdbcTemplate.update(connection -> {
                PreparedStatement ps = connection.prepareStatement(insertSql, Statement.RETURN_GENERATED_KEYS);
                ps.setLong(1, userId);
                ps.setString(2, normalizedWord);
                ps.setString(3, language);
                ps.setString(4, request.getDefinition());
                ps.setString(5, request.getExample());
                ps.setString(6, request.getNotes());
                ps.setString(7, request.getSource());
                ps.setObject(8, request.getSourcePage());
                ps.setTimestamp(9, java.sql.Timestamp.valueOf(currentTime));
                ps.setTimestamp(10, java.sql.Timestamp.valueOf(currentTime));
                return ps;
            }, keyHolder);

            Long userVocabId = keyHolder.getKey().longValue();

            // 5. 处理标签
            if (request.getTags() != null && !request.getTags().isEmpty()) {
                for (String tagName : request.getTags()) {
                    if (tagName != null && !tagName.trim().isEmpty()) {
                        // 查找或创建标签
                        String tagSql = "SELECT tag_id FROM vocabulary_tags WHERE tag_name = ?";
                        List<Map<String, Object>> tags = jdbcTemplate.queryForList(tagSql, tagName.trim());

                        Long tagId;
                        if (tags.isEmpty()) {
                            // 创建新标签
                            String insertTagSql = "INSERT INTO vocabulary_tags (tag_name, created_at) VALUES (?, ?)";
                            KeyHolder tagKeyHolder = new GeneratedKeyHolder();

                            jdbcTemplate.update(connection -> {
                                PreparedStatement ps = connection.prepareStatement(insertTagSql, Statement.RETURN_GENERATED_KEYS);
                                ps.setString(1, tagName.trim());
                                ps.setTimestamp(2, java.sql.Timestamp.valueOf(currentTime));
                                return ps;
                            }, tagKeyHolder);

                            tagId = tagKeyHolder.getKey().longValue();
                        } else {
                            tagId = ((Number) tags.get(0).get("tag_id")).longValue();
                        }

                        // 关联标签
                        String relationSql = "INSERT INTO user_vocabulary_tags (user_vocab_id, tag_id, created_at) VALUES (?, ?, ?)";
                        jdbcTemplate.update(relationSql, userVocabId, tagId, currentTime);
                    }
                }
            }

            // 6. 查询刚添加的生词详情
            String detailSql = "SELECT uv.user_vocab_id, uv.word, uv.language, uv.definition, uv.example, uv.notes, " +
                    "uv.status, uv.mastery_level, uv.review_count, uv.last_reviewed_at, uv.next_review_at, " +
                    "uv.source, uv.source_page, uv.created_at, uv.updated_at, " +
                    "GROUP_CONCAT(DISTINCT vt.tag_name) as tags " +
                    "FROM user_vocabulary uv " +
                    "LEFT JOIN user_vocabulary_tags uvt ON uv.user_vocab_id = uvt.user_vocab_id " +
                    "LEFT JOIN vocabulary_tags vt ON uvt.tag_id = vt.tag_id " +
                    "WHERE uv.user_vocab_id = ? " +
                    "GROUP BY uv.user_vocab_id";

            List<Map<String, Object>> details = jdbcTemplate.queryForList(detailSql, userVocabId);
            printQueryResult(details);

            if (details.isEmpty()) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new AddToVocabularyResponse(false, "添加成功但查询详情失败", null)
                );
            }

            Map<String, Object> detail = details.get(0);

            // 7. 组装响应数据
            VocabularyItemData itemData = new VocabularyItemData();
            itemData.setId(userVocabId);
            itemData.setWord((String) detail.get("word"));
            itemData.setLanguage((String) detail.get("language"));
            itemData.setDefinition((String) detail.get("definition"));
            itemData.setExample((String) detail.get("example"));
            itemData.setNotes((String) detail.get("notes"));
            itemData.setStatus((String) detail.get("status"));
            itemData.setMasteryLevel(detail.get("mastery_level") != null ? ((Number) detail.get("mastery_level")).intValue() : 0);
            itemData.setReviewCount(detail.get("review_count") != null ? ((Number) detail.get("review_count")).intValue() : 0);
            itemData.setLastReviewedAt(detail.get("last_reviewed_at") != null ? detail.get("last_reviewed_at").toString() : null);
            itemData.setNextReviewAt(detail.get("next_review_at") != null ? detail.get("next_review_at").toString() : null);
            itemData.setSource((String) detail.get("source"));
            itemData.setSourcePage(detail.get("source_page") != null ? ((Number) detail.get("source_page")).intValue() : null);
            itemData.setCreatedAt(detail.get("created_at").toString());
            itemData.setUpdatedAt(detail.get("updated_at").toString());

            // 处理标签字符串
            String tagsStr = (String) detail.get("tags");
            if (tagsStr != null && !tagsStr.isEmpty()) {
                itemData.setTags(Arrays.asList(tagsStr.split(",")));
            }

            // 8. 创建响应
            AddToVocabularyResponse response = new AddToVocabularyResponse(true, "单词已成功添加到生词本", itemData);

            printResponse(response);

            return ResponseEntity.status(HttpStatus.CREATED).body(response);

        } catch (Exception e) {
            System.err.println("添加到生词本过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new AddToVocabularyResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: VocabularyAddTo.java ---

--- 开始文件: VocabularyBatchAction.java ---

package com.vue.readingapp.vocabulary;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;
import java.time.LocalDateTime;

@RestController
@RequestMapping("/api/v1/vocabulary")
public class VocabularyBatchAction {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到批量操作生词请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("==========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class BatchActionRequest {
        private String action;
        private List<Long> user_vocab_ids;
        private Map<String, Object> data;

        public String getAction() { return action; }
        public void setAction(String action) { this.action = action; }

        public List<Long> getUser_vocab_ids() { return user_vocab_ids; }
        public void setUser_vocab_ids(List<Long> user_vocab_ids) { this.user_vocab_ids = user_vocab_ids; }

        public Map<String, Object> getData() { return data; }
        public void setData(Map<String, Object> data) { this.data = data; }
    }

    // 响应DTO
    public static class BatchActionResponse {
        private boolean success;
        private String message;
        private BatchResultData data;

        public BatchActionResponse(boolean success, String message, BatchResultData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public BatchResultData getData() { return data; }
        public void setData(BatchResultData data) { this.data = data; }
    }

    public static class BatchResultData {
        private int processedCount;
        private int successCount;
        private int failedCount;
        private List<FailedItem> failedItems;

        public BatchResultData(int processedCount, int successCount, int failedCount, List<FailedItem> failedItems) {
            this.processedCount = processedCount;
            this.successCount = successCount;
            this.failedCount = failedCount;
            this.failedItems = failedItems;
        }

        public int getProcessedCount() { return processedCount; }
        public void setProcessedCount(int processedCount) { this.processedCount = processedCount; }

        public int getSuccessCount() { return successCount; }
        public void setSuccessCount(int successCount) { this.successCount = successCount; }

        public int getFailedCount() { return failedCount; }
        public void setFailedCount(int failedCount) { this.failedCount = failedCount; }

        public List<FailedItem> getFailedItems() { return failedItems; }
        public void setFailedItems(List<FailedItem> failedItems) { this.failedItems = failedItems; }
    }

    public static class FailedItem {
        private Long id;
        private String reason;

        public FailedItem(Long id, String reason) {
            this.id = id;
            this.reason = reason;
        }

        public Long getId() { return id; }
        public void setId(Long id) { this.id = id; }

        public String getReason() { return reason; }
        public void setReason(String reason) { this.reason = reason; }
    }

    @PostMapping("/batch")
    public ResponseEntity<BatchActionResponse> batchVocabularyAction(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestBody BatchActionRequest request) {

        printRequest(request);

        try {
            // 1. 验证用户身份
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new BatchActionResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > ?";
            LocalDateTime now = LocalDateTime.now();
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(userSql, token, now);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new BatchActionResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Long userId = ((Number) sessions.get(0).get("user_id")).longValue();

            // 2. 验证请求数据
            if (request.getAction() == null || request.getAction().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new BatchActionResponse(false, "操作类型不能为空", null)
                );
            }

            if (request.getUser_vocab_ids() == null || request.getUser_vocab_ids().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new BatchActionResponse(false, "生词ID列表不能为空", null)
                );
            }

            String action = request.getAction().toLowerCase();
            List<Long> ids = request.getUser_vocab_ids();

            // 3. 执行批量操作
            int successCount = 0;
            int failedCount = 0;
            List<FailedItem> failedItems = new ArrayList<>();

            for (Long id : ids) {
                try {
                    boolean success = false;

                    switch (action) {
                        case "delete":
                            success = executeDeleteAction(id, userId);
                            break;
                        case "mark_as_mastered":
                            success = executeMarkAsMasteredAction(id, userId);
                            break;
                        case "reset_learning":
                            success = executeResetLearningAction(id, userId);
                            break;
                        case "update_status":
                            success = executeUpdateStatusAction(id, userId, request.getData());
                            break;
                        default:
                            failedItems.add(new FailedItem(id, "不支持的操作类型: " + action));
                            failedCount++;
                            continue;
                    }

                    if (success) {
                        successCount++;
                    } else {
                        failedItems.add(new FailedItem(id, "操作失败"));
                        failedCount++;
                    }

                } catch (Exception e) {
                    failedItems.add(new FailedItem(id, "执行错误: " + e.getMessage()));
                    failedCount++;
                }
            }

            // 4. 创建结果数据
            BatchResultData resultData = new BatchResultData(
                    ids.size(),
                    successCount,
                    failedCount,
                    failedItems
            );

            printQueryResult("批量操作结果: " + resultData);

            // 5. 创建响应
            String message = String.format("批量操作完成，成功 %d 项，失败 %d 项", successCount, failedCount);
            BatchActionResponse response = new BatchActionResponse(true, message, resultData);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("批量操作生词过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new BatchActionResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private boolean executeDeleteAction(Long id, Long userId) {
        // 检查生词是否存在且属于当前用户
        String checkSql = "SELECT user_vocab_id FROM user_vocabulary WHERE user_vocab_id = ? AND user_id = ?";
        List<Map<String, Object>> items = jdbcTemplate.queryForList(checkSql, id, userId);

        if (items.isEmpty()) {
            return false;
        }

        // 删除标签关联
        String deleteTagsSql = "DELETE FROM user_vocabulary_tags WHERE user_vocab_id = ?";
        jdbcTemplate.update(deleteTagsSql, id);

        // 删除生词
        String deleteSql = "DELETE FROM user_vocabulary WHERE user_vocab_id = ? AND user_id = ?";
        int deletedRows = jdbcTemplate.update(deleteSql, id, userId);

        return deletedRows > 0;
    }

    private boolean executeMarkAsMasteredAction(Long id, Long userId) {
        String updateSql = "UPDATE user_vocabulary SET status = 'mastered', mastery_level = 5, updated_at = ? " +
                "WHERE user_vocab_id = ? AND user_id = ?";

        int updatedRows = jdbcTemplate.update(updateSql, LocalDateTime.now(), id, userId);
        return updatedRows > 0;
    }

    private boolean executeResetLearningAction(Long id, Long userId) {
        String updateSql = "UPDATE user_vocabulary SET status = 'new', mastery_level = 0, review_count = 0, " +
                "last_reviewed_at = NULL, next_review_at = NULL, updated_at = ? " +
                "WHERE user_vocab_id = ? AND user_id = ?";

        int updatedRows = jdbcTemplate.update(updateSql, LocalDateTime.now(), id, userId);
        return updatedRows > 0;
    }

    private boolean executeUpdateStatusAction(Long id, Long userId, Map<String, Object> data) {
        if (data == null || !data.containsKey("status")) {
            return false;
        }

        String status = (String) data.get("status");
        String updateSql = "UPDATE user_vocabulary SET status = ?, updated_at = ? WHERE user_vocab_id = ? AND user_id = ?";

        int updatedRows = jdbcTemplate.update(updateSql, status, LocalDateTime.now(), id, userId);
        return updatedRows > 0;
    }
}
--- 结束文件: VocabularyBatchAction.java ---

--- 开始文件: VocabularyBatchLookup.java ---

package com.vue.readingapp.vocabulary;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;
import java.time.LocalDateTime;

@RestController
@RequestMapping("/api/v1/words")
public class VocabularyBatchLookup {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到批量单词查询请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class BatchLookupRequest {
        private List<String> words;
        private String language;

        public List<String> getWords() { return words; }
        public void setWords(List<String> words) { this.words = words; }

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }
    }

    // 响应DTO
    public static class BatchLookupResponse {
        private boolean success;
        private String message;
        private List<WordData> data;

        public BatchLookupResponse(boolean success, String message, List<WordData> data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public List<WordData> getData() { return data; }
        public void setData(List<WordData> data) { this.data = data; }
    }

    public static class WordData {
        private String word;
        private String language;
        private String phonetic;
        private List<String> definitions;
        private List<String> examples;
        private List<String> synonyms;
        private List<String> antonyms;
        private String partOfSpeech;
        private int frequency;
        private String difficulty;
        private String audioUrl;
        private String source;
        private Map<String, Object> metadata;

        public WordData() {
            this.definitions = new ArrayList<>();
            this.examples = new ArrayList<>();
            this.synonyms = new ArrayList<>();
            this.antonyms = new ArrayList<>();
            this.metadata = new HashMap<>();
        }

        // Getters and Setters
        public String getWord() { return word; }
        public void setWord(String word) { this.word = word; }

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }

        public String getPhonetic() { return phonetic; }
        public void setPhonetic(String phonetic) { this.phonetic = phonetic; }

        public List<String> getDefinitions() { return definitions; }
        public void setDefinitions(List<String> definitions) { this.definitions = definitions; }

        public List<String> getExamples() { return examples; }
        public void setExamples(List<String> examples) { this.examples = examples; }

        public List<String> getSynonyms() { return synonyms; }
        public void setSynonyms(List<String> synonyms) { this.synonyms = synonyms; }

        public List<String> getAntonyms() { return antonyms; }
        public void setAntonyms(List<String> antonyms) { this.antonyms = antonyms; }

        public String getPartOfSpeech() { return partOfSpeech; }
        public void setPartOfSpeech(String partOfSpeech) { this.partOfSpeech = partOfSpeech; }

        public int getFrequency() { return frequency; }
        public void setFrequency(int frequency) { this.frequency = frequency; }

        public String getDifficulty() { return difficulty; }
        public void setDifficulty(String difficulty) { this.difficulty = difficulty; }

        public String getAudioUrl() { return audioUrl; }
        public void setAudioUrl(String audioUrl) { this.audioUrl = audioUrl; }

        public String getSource() { return source; }
        public void setSource(String source) { this.source = source; }

        public Map<String, Object> getMetadata() { return metadata; }
        public void setMetadata(Map<String, Object> metadata) { this.metadata = metadata; }
    }

    @PostMapping("/batch-lookup")
    public ResponseEntity<BatchLookupResponse> batchLookupWords(@RequestBody BatchLookupRequest request) {
        printRequest(request);

        try {
            // 1. 验证请求数据
            if (request.getWords() == null || request.getWords().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new BatchLookupResponse(false, "单词列表不能为空", null)
                );
            }

            if (request.getWords().size() > 50) {
                return ResponseEntity.badRequest().body(
                        new BatchLookupResponse(false, "批量查询最多支持50个单词", null)
                );
            }

            String language = request.getLanguage() != null ? request.getLanguage() : "en";

            // 2. 去重和规范化单词
            Set<String> uniqueWords = new LinkedHashSet<>();
            for (String word : request.getWords()) {
                if (word != null && !word.trim().isEmpty()) {
                    uniqueWords.add(word.trim().toLowerCase());
                }
            }

            if (uniqueWords.isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new BatchLookupResponse(false, "没有有效的单词", null)
                );
            }

            // 3. 批量查询单词
            List<WordData> result = new ArrayList<>();

            for (String word : uniqueWords) {
                try {
                    // 查询单词基本信息
                    String wordSql = "SELECT word_id, word, language, phonetic, part_of_speech, frequency, difficulty, audio_url " +
                            "FROM words WHERE word = ? AND language = ?";

                    List<Map<String, Object>> words = jdbcTemplate.queryForList(wordSql, word, language);

                    if (!words.isEmpty()) {
                        Map<String, Object> wordInfo = words.get(0);
                        Long wordId = ((Number) wordInfo.get("word_id")).longValue();

                        // 查询单词释义
                        String definitionsSql = "SELECT definition FROM word_definitions WHERE word_id = ? ORDER BY definition_id";
                        List<String> definitions = jdbcTemplate.queryForList(definitionsSql, String.class, wordId);

                        // 查询单词例句
                        String examplesSql = "SELECT example FROM word_examples WHERE word_id = ? ORDER BY example_id LIMIT 5";
                        List<String> examples = jdbcTemplate.queryForList(examplesSql, String.class, wordId);

                        // 查询同义词
                        String synonymsSql = "SELECT w.word FROM word_relations wr " +
                                "JOIN words w ON wr.related_word_id = w.word_id " +
                                "WHERE wr.word_id = ? AND wr.relation_type = 'synonym' LIMIT 5";
                        List<String> synonyms = jdbcTemplate.queryForList(synonymsSql, String.class, wordId);

                        // 查询反义词
                        String antonymsSql = "SELECT w.word FROM word_relations wr " +
                                "JOIN words w ON wr.related_word_id = w.word_id " +
                                "WHERE wr.word_id = ? AND wr.relation_type = 'antonym' LIMIT 5";
                        List<String> antonyms = jdbcTemplate.queryForList(antonymsSql, String.class, wordId);

                        // 组装单词数据
                        WordData wordData = new WordData();
                        wordData.setWord((String) wordInfo.get("word"));
                        wordData.setLanguage((String) wordInfo.get("language"));
                        wordData.setPhonetic((String) wordInfo.get("phonetic"));
                        wordData.setPartOfSpeech((String) wordInfo.get("part_of_speech"));
                        wordData.setFrequency(wordInfo.get("frequency") != null ? ((Number) wordInfo.get("frequency")).intValue() : 0);
                        wordData.setDifficulty((String) wordInfo.get("difficulty"));
                        wordData.setAudioUrl((String) wordInfo.get("audio_url"));
                        wordData.setSource("dictionary");
                        wordData.setDefinitions(definitions);
                        wordData.setExamples(examples);
                        wordData.setSynonyms(synonyms);
                        wordData.setAntonyms(antonyms);

                        // 添加元数据
                        Map<String, Object> metadata = new HashMap<>();
                        metadata.put("word_id", wordId);
                        metadata.put("definition_count", definitions.size());
                        metadata.put("example_count", examples.size());
                        wordData.setMetadata(metadata);

                        result.add(wordData);
                    } else {
                        // 单词不存在，创建空的单词数据
                        WordData wordData = new WordData();
                        wordData.setWord(word);
                        wordData.setLanguage(language);
                        wordData.setSource("not_found");

                        Map<String, Object> metadata = new HashMap<>();
                        metadata.put("found", false);
                        wordData.setMetadata(metadata);

                        result.add(wordData);
                    }
                } catch (Exception e) {
                    System.err.println("查询单词 " + word + " 时发生错误: " + e.getMessage());
                    // 继续处理其他单词
                }
            }

            printQueryResult("共查询 " + result.size() + " 个单词");

            // 4. 创建响应
            BatchLookupResponse response = new BatchLookupResponse(true, "批量单词查询完成", result);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("批量单词查询过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new BatchLookupResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: VocabularyBatchLookup.java ---

--- 开始文件: VocabularyBatchUpdate.java ---
package com.vue.readingapp.vocabulary;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.support.GeneratedKeyHolder;
import org.springframework.jdbc.support.KeyHolder;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.PreparedStatement;
import java.sql.Statement;
import java.sql.Timestamp;
import java.util.*;
import java.time.LocalDateTime;

@RestController
@RequestMapping("/api/v1/vocabulary")
public class VocabularyBatchUpdate {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到批量更新生词请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("==========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class BatchUpdateRequest {
        private List<BatchUpdateItem> items;

        public List<BatchUpdateItem> getItems() { return items; }
        public void setItems(List<BatchUpdateItem> items) { this.items = items; }
    }

    public static class BatchUpdateItem {
        private Long id;
        private String status;
        private Integer masteryLevel;
        private List<String> tags;
        private String notes;

        public Long getId() { return id; }
        public void setId(Long id) { this.id = id; }

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public Integer getMasteryLevel() { return masteryLevel; }
        public void setMasteryLevel(Integer masteryLevel) { this.masteryLevel = masteryLevel; }

        public List<String> getTags() { return tags; }
        public void setTags(List<String> tags) { this.tags = tags; }

        public String getNotes() { return notes; }
        public void setNotes(String notes) { this.notes = notes; }
    }

    // 响应DTO
    public static class BatchUpdateResponse {
        private boolean success;
        private String message;
        private BatchUpdateResultData data;

        public BatchUpdateResponse(boolean success, String message, BatchUpdateResultData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public BatchUpdateResultData getData() { return data; }
        public void setData(BatchUpdateResultData data) { this.data = data; }
    }

    public static class BatchUpdateResultData {
        private int totalCount;
        private int successCount;
        private int failedCount;
        private List<BatchUpdateResultItem> results;

        public BatchUpdateResultData(int totalCount, int successCount, int failedCount, List<BatchUpdateResultItem> results) {
            this.totalCount = totalCount;
            this.successCount = successCount;
            this.failedCount = failedCount;
            this.results = results;
        }

        public int getTotalCount() { return totalCount; }
        public void setTotalCount(int totalCount) { this.totalCount = totalCount; }

        public int getSuccessCount() { return successCount; }
        public void setSuccessCount(int successCount) { this.successCount = successCount; }

        public int getFailedCount() { return failedCount; }
        public void setFailedCount(int failedCount) { this.failedCount = failedCount; }

        public List<BatchUpdateResultItem> getResults() { return results; }
        public void setResults(List<BatchUpdateResultItem> results) { this.results = results; }
    }

    public static class BatchUpdateResultItem {
        private Long id;
        private boolean success;
        private String message;

        public BatchUpdateResultItem(Long id, boolean success, String message) {
            this.id = id;
            this.success = success;
            this.message = message;
        }

        public Long getId() { return id; }
        public void setId(Long id) { this.id = id; }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }
    }

    @PutMapping("/batch")
    public ResponseEntity<BatchUpdateResponse> batchUpdateVocabulary(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestBody BatchUpdateRequest request) {

        printRequest(request);

        try {
            // 1. 验证用户身份
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new BatchUpdateResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > ?";
            LocalDateTime now = LocalDateTime.now();
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(userSql, token, now);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new BatchUpdateResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Long userId = ((Number) sessions.get(0).get("user_id")).longValue();

            // 2. 验证请求数据
            if (request.getItems() == null || request.getItems().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new BatchUpdateResponse(false, "更新项列表不能为空", null)
                );
            }

            if (request.getItems().size() > 100) {
                return ResponseEntity.badRequest().body(
                        new BatchUpdateResponse(false, "批量更新最多支持100项", null)
                );
            }

            // 3. 执行批量更新
            List<BatchUpdateResultItem> results = new ArrayList<>();
            int successCount = 0;
            int failedCount = 0;

            for (BatchUpdateItem updateItem : request.getItems()) {
                try {
                    if (updateItem.getId() == null) {
                        results.add(new BatchUpdateResultItem(null, false, "ID不能为空"));
                        failedCount++;
                        continue;
                    }

                    // 检查生词是否存在且属于当前用户
                    String checkSql = "SELECT user_vocab_id FROM user_vocabulary WHERE user_vocab_id = ? AND user_id = ?";
                    List<Map<String, Object>> items = jdbcTemplate.queryForList(checkSql, updateItem.getId(), userId);

                    if (items.isEmpty()) {
                        results.add(new BatchUpdateResultItem(updateItem.getId(), false, "生词不存在或没有权限更新"));
                        failedCount++;
                        continue;
                    }

                    // 构建更新字段
                    Map<String, Object> updateFields = new HashMap<>();
                    List<Object> params = new ArrayList<>();
                    List<String> setClauses = new ArrayList<>();

                    if (updateItem.getStatus() != null) {
                        setClauses.add("status = ?");
                        params.add(updateItem.getStatus());
                    }

                    if (updateItem.getMasteryLevel() != null) {
                        setClauses.add("mastery_level = ?");
                        params.add(updateItem.getMasteryLevel());
                    }

                    if (updateItem.getNotes() != null) {
                        setClauses.add("notes = ?");
                        params.add(updateItem.getNotes());
                    }

                    // 添加更新时间
                    setClauses.add("updated_at = ?");
                    params.add(LocalDateTime.now());

                    // 如果没有要更新的字段
                    if (setClauses.isEmpty()) {
                        results.add(new BatchUpdateResultItem(updateItem.getId(), false, "没有提供更新数据"));
                        failedCount++;
                        continue;
                    }

                    // 执行更新
                    String updateSql = "UPDATE user_vocabulary SET " + String.join(", ", setClauses) +
                            " WHERE user_vocab_id = ? AND user_id = ?";
                    params.add(updateItem.getId());
                    params.add(userId);

                    int updatedRows = jdbcTemplate.update(updateSql, params.toArray());

                    if (updatedRows > 0) {
                        // 处理标签更新
                        if (updateItem.getTags() != null) {
                            // 删除旧的标签关联
                            String deleteTagsSql = "DELETE FROM user_vocabulary_tags WHERE user_vocab_id = ?";
                            jdbcTemplate.update(deleteTagsSql, updateItem.getId());

                            // 添加新的标签关联
                            for (String tagName : updateItem.getTags()) {
                                if (tagName != null && !tagName.trim().isEmpty()) {
                                    // 查找或创建标签
                                    String tagSql = "SELECT tag_id FROM vocabulary_tags WHERE tag_name = ?";
                                    List<Map<String, Object>> tags = jdbcTemplate.queryForList(tagSql, tagName.trim());

                                    Long tagId;
                                    if (tags.isEmpty()) {
                                        // 创建新标签
                                        String insertTagSql = "INSERT INTO vocabulary_tags (tag_name, created_at) VALUES (?, ?)";
                                        KeyHolder tagKeyHolder = new GeneratedKeyHolder();

                                        jdbcTemplate.update(connection -> {
                                            PreparedStatement ps = connection.prepareStatement(insertTagSql, Statement.RETURN_GENERATED_KEYS);
                                            ps.setString(1, tagName.trim());
                                            ps.setTimestamp(2, Timestamp.valueOf(LocalDateTime.now()));
                                            return ps;
                                        }, tagKeyHolder);

                                        tagId = tagKeyHolder.getKey().longValue();
                                    } else {
                                        tagId = ((Number) tags.get(0).get("tag_id")).longValue();
                                    }

                                    // 关联标签
                                    String relationSql = "INSERT INTO user_vocabulary_tags (user_vocab_id, tag_id, created_at) VALUES (?, ?, ?)";
                                    jdbcTemplate.update(relationSql, updateItem.getId(), tagId, LocalDateTime.now());
                                }
                            }
                        }

                        results.add(new BatchUpdateResultItem(updateItem.getId(), true, "更新成功"));
                        successCount++;
                    } else {
                        results.add(new BatchUpdateResultItem(updateItem.getId(), false, "更新失败"));
                        failedCount++;
                    }

                } catch (Exception e) {
                    results.add(new BatchUpdateResultItem(updateItem.getId(), false, "执行错误: " + e.getMessage()));
                    failedCount++;
                }
            }

            // 4. 创建结果数据
            BatchUpdateResultData resultData = new BatchUpdateResultData(
                    request.getItems().size(),
                    successCount,
                    failedCount,
                    results
            );

            printQueryResult("批量更新结果: " + resultData);

            // 5. 创建响应
            String message = String.format("批量更新完成，成功 %d 项，失败 %d 项", successCount, failedCount);
            BatchUpdateResponse response = new BatchUpdateResponse(true, message, resultData);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("批量更新生词过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new BatchUpdateResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: VocabularyBatchUpdate.java ---

--- 开始文件: VocabularyDeleteItem.java ---
package com.vue.readingapp.vocabulary;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;
import java.time.LocalDateTime;

@RestController
@RequestMapping("/api/v1/vocabulary")
public class VocabularyDeleteItem {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到删除生词请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=====================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class DeleteVocabularyResponse {
        private boolean success;
        private String message;
        private DeleteData data;

        public DeleteVocabularyResponse(boolean success, String message, DeleteData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public DeleteData getData() { return data; }
        public void setData(DeleteData data) { this.data = data; }
    }

    public static class DeleteData {
        private Long deletedId;
        private String word;
        private String deletedAt;

        public DeleteData(Long deletedId, String word, String deletedAt) {
            this.deletedId = deletedId;
            this.word = word;
            this.deletedAt = deletedAt;
        }

        public Long getDeletedId() { return deletedId; }
        public void setDeletedId(Long deletedId) { this.deletedId = deletedId; }

        public String getWord() { return word; }
        public void setWord(String word) { this.word = word; }

        public String getDeletedAt() { return deletedAt; }
        public void setDeletedAt(String deletedAt) { this.deletedAt = deletedAt; }
    }

    @DeleteMapping("/{userVocabId}")
    public ResponseEntity<DeleteVocabularyResponse> deleteVocabularyItem(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @PathVariable Long userVocabId) {

        printRequest("userVocabId: " + userVocabId);

        try {
            // 1. 验证用户身份
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new DeleteVocabularyResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > ?";
            LocalDateTime now = LocalDateTime.now();
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(userSql, token, now);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new DeleteVocabularyResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Long userId = ((Number) sessions.get(0).get("user_id")).longValue();

            // 2. 查询要删除的生词信息（用于返回）
            String selectSql = "SELECT user_vocab_id, word FROM user_vocabulary WHERE user_vocab_id = ? AND user_id = ?";
            List<Map<String, Object>> items = jdbcTemplate.queryForList(selectSql, userVocabId, userId);

            if (items.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new DeleteVocabularyResponse(false, "生词不存在或没有权限删除", null)
                );
            }

            Map<String, Object> item = items.get(0);
            String word = (String) item.get("word");

            // 3. 删除标签关联
            String deleteTagsSql = "DELETE FROM user_vocabulary_tags WHERE user_vocab_id = ?";
            jdbcTemplate.update(deleteTagsSql, userVocabId);

            // 4. 删除生词
            String deleteSql = "DELETE FROM user_vocabulary WHERE user_vocab_id = ? AND user_id = ?";
            int deletedRows = jdbcTemplate.update(deleteSql, userVocabId, userId);

            printQueryResult("删除行数: " + deletedRows);

            if (deletedRows == 0) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new DeleteVocabularyResponse(false, "删除失败", null)
                );
            }

            // 5. 创建响应数据
            DeleteData deleteData = new DeleteData(userVocabId, word, LocalDateTime.now().toString());
            DeleteVocabularyResponse response = new DeleteVocabularyResponse(true, "生词删除成功", deleteData);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("删除生词过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new DeleteVocabularyResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: VocabularyDeleteItem.java ---

--- 开始文件: VocabularyExport.java ---
package com.vue.readingapp.vocabulary;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

@RestController
@RequestMapping("/api/v1/vocabulary")
public class VocabularyExport {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到导出生词本请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("=========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class ExportVocabularyResponse {
        private boolean success;
        private String message;
        private ExportData data;

        public ExportVocabularyResponse(boolean success, String message, ExportData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public ExportData getData() { return data; }
        public void setData(ExportData data) { this.data = data; }
    }

    public static class ExportData {
        private String format;
        private String content;
        private String fileName;
        private String fileSize;
        private String downloadUrl;
        private String expiresAt;
        private List<String> fields;

        public ExportData(String format, String content, String fileName, String fileSize,
                          String downloadUrl, String expiresAt, List<String> fields) {
            this.format = format;
            this.content = content;
            this.fileName = fileName;
            this.fileSize = fileSize;
            this.downloadUrl = downloadUrl;
            this.expiresAt = expiresAt;
            this.fields = fields;
        }

        // Getters and Setters
        public String getFormat() { return format; }
        public void setFormat(String format) { this.format = format; }

        public String getContent() { return content; }
        public void setContent(String content) { this.content = content; }

        public String getFileName() { return fileName; }
        public void setFileName(String fileName) { this.fileName = fileName; }

        public String getFileSize() { return fileSize; }
        public void setFileSize(String fileSize) { this.fileSize = fileSize; }

        public String getDownloadUrl() { return downloadUrl; }
        public void setDownloadUrl(String downloadUrl) { this.downloadUrl = downloadUrl; }

        public String getExpiresAt() { return expiresAt; }
        public void setExpiresAt(String expiresAt) { this.expiresAt = expiresAt; }

        public List<String> getFields() { return fields; }
        public void setFields(List<String> fields) { this.fields = fields; }
    }

    @GetMapping("/export")
    public ResponseEntity<ExportVocabularyResponse> exportVocabulary(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestParam(required = false, defaultValue = "csv") String format,
            @RequestParam(required = false) List<String> fields,
            @RequestParam(required = false) String status,
            @RequestParam(required = false) String language,
            @RequestParam(required = false) List<String> tags) {

        Map<String, Object> requestParams = new HashMap<>();
        requestParams.put("format", format);
        requestParams.put("fields", fields);
        requestParams.put("status", status);
        requestParams.put("language", language);
        requestParams.put("tags", tags);
        printRequest(requestParams);

        try {
            // 1. 验证用户身份
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ExportVocabularyResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > ?";
            LocalDateTime now = LocalDateTime.now();
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(userSql, token, now);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ExportVocabularyResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Long userId = ((Number) sessions.get(0).get("user_id")).longValue();

            // 2. 验证导出格式
            List<String> validFormats = Arrays.asList("csv", "json", "txt", "xlsx");
            if (!validFormats.contains(format.toLowerCase())) {
                return ResponseEntity.badRequest().body(
                        new ExportVocabularyResponse(false, "不支持的导出格式: " + format, null)
                );
            }

            // 3. 设置默认字段
            List<String> exportFields;
            if (fields == null || fields.isEmpty()) {
                exportFields = Arrays.asList("word", "language", "definition", "example",
                        "status", "mastery_level", "review_count",
                        "last_reviewed_at", "next_review_at",
                        "source", "source_page", "notes", "tags",
                        "created_at", "updated_at");
            } else {
                exportFields = fields;
            }

            // 4. 构建查询条件
            StringBuilder whereClause = new StringBuilder("WHERE uv.user_id = ?");
            List<Object> params = new ArrayList<>();
            params.add(userId);

            if (status != null && !status.trim().isEmpty()) {
                whereClause.append(" AND uv.status = ?");
                params.add(status.trim());
            }

            if (language != null && !language.trim().isEmpty()) {
                whereClause.append(" AND uv.language = ?");
                params.add(language.trim());
            }

            // 5. 查询生词数据
            String dataSql = "SELECT uv.user_vocab_id, uv.word, uv.language, uv.definition, uv.example, uv.notes, " +
                    "uv.status, uv.mastery_level, uv.review_count, uv.last_reviewed_at, uv.next_review_at, " +
                    "uv.source, uv.source_page, uv.created_at, uv.updated_at, " +
                    "GROUP_CONCAT(DISTINCT vt.tag_name) as tags " +
                    "FROM user_vocabulary uv " +
                    "LEFT JOIN user_vocabulary_tags uvt ON uv.user_vocab_id = uvt.user_vocab_id " +
                    "LEFT JOIN vocabulary_tags vt ON uvt.tag_id = vt.tag_id " +
                    whereClause.toString();

            if (tags != null && !tags.isEmpty()) {
                dataSql += " AND vt.tag_name IN (" + String.join(",", Collections.nCopies(tags.size(), "?")) + ")";
                params.addAll(tags);
            }

            dataSql += " GROUP BY uv.user_vocab_id ORDER BY uv.created_at DESC";

            List<Map<String, Object>> results = jdbcTemplate.queryForList(dataSql, params.toArray());
            printQueryResult("查询到 " + results.size() + " 条记录用于导出");

            // 6. 根据格式生成内容
            String content;
            switch (format.toLowerCase()) {
                case "csv":
                    content = generateCsvContent(results, exportFields);
                    break;
                case "json":
                    content = generateJsonContent(results, exportFields);
                    break;
                case "txt":
                    content = generateTxtContent(results, exportFields);
                    break;
                case "xlsx":
                    // 对于xlsx格式，我们通常返回文件下载URL而不是内容
                    content = "xlsx格式需要生成文件，请使用下载URL";
                    break;
                default:
                    content = "";
            }

            // 7. 生成文件名
            String timestamp = LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyyMMdd_HHmmss"));
            String fileName = "vocabulary_export_" + timestamp + "." + format.toLowerCase();

            // 8. 计算文件大小（字节数）
            int fileSizeBytes = content.getBytes("UTF-8").length;
            String fileSize = formatFileSize(fileSizeBytes);

            // 9. 生成下载URL（这里简单模拟，实际项目中可能需要生成实际文件）
            String downloadUrl = "/api/vocabulary/download/" + fileName;

            // 10. 设置过期时间（24小时后）
            String expiresAt = LocalDateTime.now().plusHours(24).format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss"));

            // 11. 组装响应数据
            ExportData exportData = new ExportData(format, content, fileName, fileSize, downloadUrl, expiresAt, exportFields);
            ExportVocabularyResponse response = new ExportVocabularyResponse(true, "生词本导出成功", exportData);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("导出生词本过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ExportVocabularyResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private String generateCsvContent(List<Map<String, Object>> data, List<String> fields) {
        StringBuilder csv = new StringBuilder();

        // 添加表头
        for (int i = 0; i < fields.size(); i++) {
            csv.append(fields.get(i));
            if (i < fields.size() - 1) {
                csv.append(",");
            }
        }
        csv.append("\n");

        // 添加数据行
        for (Map<String, Object> row : data) {
            for (int i = 0; i < fields.size(); i++) {
                String field = fields.get(i);
                Object value = row.get(field);

                if (value != null) {
                    String strValue = value.toString();
                    // 处理CSV特殊字符（逗号、引号、换行符）
                    if (strValue.contains(",") || strValue.contains("\"") || strValue.contains("\n")) {
                        strValue = "\"" + strValue.replace("\"", "\"\"") + "\"";
                    }
                    csv.append(strValue);
                }

                if (i < fields.size() - 1) {
                    csv.append(",");
                }
            }
            csv.append("\n");
        }

        return csv.toString();
    }

    private String generateJsonContent(List<Map<String, Object>> data, List<String> fields) {
        List<Map<String, Object>> filteredData = new ArrayList<>();

        for (Map<String, Object> row : data) {
            Map<String, Object> filteredRow = new HashMap<>();
            for (String field : fields) {
                if (row.containsKey(field)) {
                    filteredRow.put(field, row.get(field));
                }
            }
            filteredData.add(filteredRow);
        }

        // 使用简单的JSON序列化
        StringBuilder json = new StringBuilder();
        json.append("{\n");
        json.append("  \"export_date\": \"").append(LocalDateTime.now().toString()).append("\",\n");
        json.append("  \"total_items\": ").append(filteredData.size()).append(",\n");
        json.append("  \"items\": [\n");

        for (int i = 0; i < filteredData.size(); i++) {
            Map<String, Object> row = filteredData.get(i);
            json.append("    {\n");

            int fieldCount = 0;
            for (Map.Entry<String, Object> entry : row.entrySet()) {
                json.append("      \"").append(entry.getKey()).append("\": ");

                Object value = entry.getValue();
                if (value instanceof String) {
                    json.append("\"").append(escapeJsonString(value.toString())).append("\"");
                } else if (value instanceof Number) {
                    json.append(value);
                } else if (value instanceof Boolean) {
                    json.append(value);
                } else if (value == null) {
                    json.append("null");
                } else {
                    json.append("\"").append(escapeJsonString(value.toString())).append("\"");
                }

                fieldCount++;
                if (fieldCount < row.size()) {
                    json.append(",");
                }
                json.append("\n");
            }

            json.append("    }");
            if (i < filteredData.size() - 1) {
                json.append(",");
            }
            json.append("\n");
        }

        json.append("  ]\n");
        json.append("}");

        return json.toString();
    }

    private String generateTxtContent(List<Map<String, Object>> data, List<String> fields) {
        StringBuilder txt = new StringBuilder();

        txt.append("Vocabulary Export\n");
        txt.append("=================\n");
        txt.append("Export Date: ").append(LocalDateTime.now().toString()).append("\n");
        txt.append("Total Items: ").append(data.size()).append("\n\n");

        for (int i = 0; i < data.size(); i++) {
            Map<String, Object> row = data.get(i);
            txt.append("Item ").append(i + 1).append(":\n");

            for (String field : fields) {
                Object value = row.get(field);
                txt.append("  ").append(field).append(": ");

                if (value != null) {
                    txt.append(value.toString());
                } else {
                    txt.append("(null)");
                }

                txt.append("\n");
            }

            txt.append("\n");
        }

        return txt.toString();
    }

    private String escapeJsonString(String input) {
        return input.replace("\\", "\\\\")
                .replace("\"", "\\\"")
                .replace("\b", "\\b")
                .replace("\f", "\\f")
                .replace("\n", "\\n")
                .replace("\r", "\\r")
                .replace("\t", "\\t");
    }

    private String formatFileSize(long bytes) {
        if (bytes < 1024) return bytes + " B";
        int exp = (int) (Math.log(bytes) / Math.log(1024));
        String pre = "KMGTPE".charAt(exp-1) + "";
        return String.format("%.1f %sB", bytes / Math.pow(1024, exp), pre);
    }
}

--- 结束文件: VocabularyExport.java ---

--- 开始文件: VocabularyGetItem.java ---

package com.vue.readingapp.vocabulary;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;
import java.time.LocalDateTime;

@RestController
@RequestMapping("/api/v1/vocabulary")
public class VocabularyGetItem {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取生词详情请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("=========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class VocabularyItemResponse {
        private boolean success;
        private String message;
        private VocabularyItemData data;

        public VocabularyItemResponse(boolean success, String message, VocabularyItemData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public VocabularyItemData getData() { return data; }
        public void setData(VocabularyItemData data) { this.data = data; }
    }

    public static class VocabularyItemData {
        private Long id;
        private String word;
        private String language;
        private String definition;
        private String example;
        private List<String> tags;
        private String notes;
        private String status;
        private Integer masteryLevel;
        private Integer reviewCount;
        private String lastReviewedAt;
        private String nextReviewAt;
        private String source;
        private Integer sourcePage;
        private String createdAt;
        private String updatedAt;
        private WordDetailData wordDetail;

        public VocabularyItemData() {
            this.tags = new ArrayList<>();
        }

        // Getters and Setters
        public Long getId() { return id; }
        public void setId(Long id) { this.id = id; }

        public String getWord() { return word; }
        public void setWord(String word) { this.word = word; }

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }

        public String getDefinition() { return definition; }
        public void setDefinition(String definition) { this.definition = definition; }

        public String getExample() { return example; }
        public void setExample(String example) { this.example = example; }

        public List<String> getTags() { return tags; }
        public void setTags(List<String> tags) { this.tags = tags; }

        public String getNotes() { return notes; }
        public void setNotes(String notes) { this.notes = notes; }

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public Integer getMasteryLevel() { return masteryLevel; }
        public void setMasteryLevel(Integer masteryLevel) { this.masteryLevel = masteryLevel; }

        public Integer getReviewCount() { return reviewCount; }
        public void setReviewCount(Integer reviewCount) { this.reviewCount = reviewCount; }

        public String getLastReviewedAt() { return lastReviewedAt; }
        public void setLastReviewedAt(String lastReviewedAt) { this.lastReviewedAt = lastReviewedAt; }

        public String getNextReviewAt() { return nextReviewAt; }
        public void setNextReviewAt(String nextReviewAt) { this.nextReviewAt = nextReviewAt; }

        public String getSource() { return source; }
        public void setSource(String source) { this.source = source; }

        public Integer getSourcePage() { return sourcePage; }
        public void setSourcePage(Integer sourcePage) { this.sourcePage = sourcePage; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }

        public WordDetailData getWordDetail() { return wordDetail; }
        public void setWordDetail(WordDetailData wordDetail) { this.wordDetail = wordDetail; }
    }

    public static class WordDetailData {
        private String phonetic;
        private List<String> definitions;
        private List<String> examples;
        private List<String> synonyms;
        private List<String> antonyms;
        private String partOfSpeech;
        private Integer frequency;
        private String difficulty;
        private String audioUrl;

        public WordDetailData() {
            this.definitions = new ArrayList<>();
            this.examples = new ArrayList<>();
            this.synonyms = new ArrayList<>();
            this.antonyms = new ArrayList<>();
        }

        // Getters and Setters
        public String getPhonetic() { return phonetic; }
        public void setPhonetic(String phonetic) { this.phonetic = phonetic; }

        public List<String> getDefinitions() { return definitions; }
        public void setDefinitions(List<String> definitions) { this.definitions = definitions; }

        public List<String> getExamples() { return examples; }
        public void setExamples(List<String> examples) { this.examples = examples; }

        public List<String> getSynonyms() { return synonyms; }
        public void setSynonyms(List<String> synonyms) { this.synonyms = synonyms; }

        public List<String> getAntonyms() { return antonyms; }
        public void setAntonyms(List<String> antonyms) { this.antonyms = antonyms; }

        public String getPartOfSpeech() { return partOfSpeech; }
        public void setPartOfSpeech(String partOfSpeech) { this.partOfSpeech = partOfSpeech; }

        public Integer getFrequency() { return frequency; }
        public void setFrequency(Integer frequency) { this.frequency = frequency; }

        public String getDifficulty() { return difficulty; }
        public void setDifficulty(String difficulty) { this.difficulty = difficulty; }

        public String getAudioUrl() { return audioUrl; }
        public void setAudioUrl(String audioUrl) { this.audioUrl = audioUrl; }
    }

    @GetMapping("/{userVocabId}")
    public ResponseEntity<VocabularyItemResponse> getVocabularyItem(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @PathVariable Long userVocabId) {

        printRequest("userVocabId: " + userVocabId);

        try {
            // 1. 验证用户身份
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new VocabularyItemResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > ?";
            LocalDateTime now = LocalDateTime.now();
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(userSql, token, now);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new VocabularyItemResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Long userId = ((Number) sessions.get(0).get("user_id")).longValue();

            // 2. 查询生词详情
            String sql = "SELECT uv.user_vocab_id, uv.word, uv.language, uv.definition, uv.example, uv.notes, " +
                    "uv.status, uv.mastery_level, uv.review_count, uv.last_reviewed_at, uv.next_review_at, " +
                    "uv.source, uv.source_page, uv.created_at, uv.updated_at, " +
                    "GROUP_CONCAT(DISTINCT vt.tag_name) as tags " +
                    "FROM user_vocabulary uv " +
                    "LEFT JOIN user_vocabulary_tags uvt ON uv.user_vocab_id = uvt.user_vocab_id " +
                    "LEFT JOIN vocabulary_tags vt ON uvt.tag_id = vt.tag_id " +
                    "WHERE uv.user_vocab_id = ? AND uv.user_id = ? " +
                    "GROUP BY uv.user_vocab_id";

            List<Map<String, Object>> results = jdbcTemplate.queryForList(sql, userVocabId, userId);
            printQueryResult(results);

            if (results.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new VocabularyItemResponse(false, "生词不存在或没有权限访问", null)
                );
            }

            Map<String, Object> row = results.get(0);

            // 3. 组装生词数据
            VocabularyItemData itemData = new VocabularyItemData();
            itemData.setId(((Number) row.get("user_vocab_id")).longValue());
            itemData.setWord((String) row.get("word"));
            itemData.setLanguage((String) row.get("language"));
            itemData.setDefinition((String) row.get("definition"));
            itemData.setExample((String) row.get("example"));
            itemData.setNotes((String) row.get("notes"));
            itemData.setStatus((String) row.get("status"));
            itemData.setMasteryLevel(row.get("mastery_level") != null ? ((Number) row.get("mastery_level")).intValue() : 0);
            itemData.setReviewCount(row.get("review_count") != null ? ((Number) row.get("review_count")).intValue() : 0);
            itemData.setLastReviewedAt(row.get("last_reviewed_at") != null ? row.get("last_reviewed_at").toString() : null);
            itemData.setNextReviewAt(row.get("next_review_at") != null ? row.get("next_review_at").toString() : null);
            itemData.setSource((String) row.get("source"));
            itemData.setSourcePage(row.get("source_page") != null ? ((Number) row.get("source_page")).intValue() : null);
            itemData.setCreatedAt(row.get("created_at").toString());
            itemData.setUpdatedAt(row.get("updated_at").toString());

            // 处理标签
            String tagsStr = (String) row.get("tags");
            if (tagsStr != null && !tagsStr.isEmpty()) {
                itemData.setTags(Arrays.asList(tagsStr.split(",")));
            }

            // 4. 查询单词的详细信息（从words表）
            String word = (String) row.get("word");
            String language = (String) row.get("language");

            String wordDetailSql = "SELECT w.word_id, w.phonetic, w.part_of_speech, w.frequency, w.difficulty, w.audio_url " +
                    "FROM words w WHERE w.word = ? AND w.language = ?";

            List<Map<String, Object>> wordDetails = jdbcTemplate.queryForList(wordDetailSql, word, language);

            if (!wordDetails.isEmpty()) {
                Map<String, Object> wordDetailRow = wordDetails.get(0);
                Long wordId = ((Number) wordDetailRow.get("word_id")).longValue();

                // 查询单词释义
                String definitionsSql = "SELECT definition FROM word_definitions WHERE word_id = ? ORDER BY definition_id";
                List<String> definitions = jdbcTemplate.queryForList(definitionsSql, String.class, wordId);

                // 查询单词例句
                String examplesSql = "SELECT example FROM word_examples WHERE word_id = ? ORDER BY example_id LIMIT 5";
                List<String> examples = jdbcTemplate.queryForList(examplesSql, String.class, wordId);

                // 查询同义词
                String synonymsSql = "SELECT w.word FROM word_relations wr " +
                        "JOIN words w ON wr.related_word_id = w.word_id " +
                        "WHERE wr.word_id = ? AND wr.relation_type = 'synonym' LIMIT 5";
                List<String> synonyms = jdbcTemplate.queryForList(synonymsSql, String.class, wordId);

                // 查询反义词
                String antonymsSql = "SELECT w.word FROM word_relations wr " +
                        "JOIN words w ON wr.related_word_id = w.word_id " +
                        "WHERE wr.word_id = ? AND wr.relation_type = 'antonym' LIMIT 5";
                List<String> antonyms = jdbcTemplate.queryForList(antonymsSql, String.class, wordId);

                // 组装单词详情
                WordDetailData wordDetail = new WordDetailData();
                wordDetail.setPhonetic((String) wordDetailRow.get("phonetic"));
                wordDetail.setDefinitions(definitions);
                wordDetail.setExamples(examples);
                wordDetail.setSynonyms(synonyms);
                wordDetail.setAntonyms(antonyms);
                wordDetail.setPartOfSpeech((String) wordDetailRow.get("part_of_speech"));
                wordDetail.setFrequency(wordDetailRow.get("frequency") != null ? ((Number) wordDetailRow.get("frequency")).intValue() : 0);
                wordDetail.setDifficulty((String) wordDetailRow.get("difficulty"));
                wordDetail.setAudioUrl((String) wordDetailRow.get("audio_url"));

                itemData.setWordDetail(wordDetail);
            }

            // 5. 创建响应
            VocabularyItemResponse response = new VocabularyItemResponse(true, "获取生词详情成功", itemData);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取生词详情过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new VocabularyItemResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: VocabularyGetItem.java ---

--- 开始文件: VocabularyGetLearningStats.java ---
package com.vue.readingapp.vocabulary;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;
import java.time.LocalDateTime;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;

@RestController
@RequestMapping("/api/v1/vocabulary")
public class VocabularyGetLearningStats {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取学习统计请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("==========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class LearningStatsResponse {
        private boolean success;
        private String message;
        private LearningStatsData data;

        public LearningStatsResponse(boolean success, String message, LearningStatsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public LearningStatsData getData() { return data; }
        public void setData(LearningStatsData data) { this.data = data; }
    }

    public static class LearningStatsData {
        private int totalWords;
        private int masteredWords;
        private int learningWords;
        private int newWords;
        private int todayAdded;
        private int todayReviewed;
        private int weeklyProgress;
        private int monthlyProgress;
        private Map<String, Integer> byLanguage;
        private Map<String, Integer> byStatus;
        private int streakDays;
        private List<DailyLearningStat> dailyStats;
        private Map<String, Object> masteryDistribution;
        private Map<String, Object> reviewFrequency;

        public LearningStatsData() {
            this.byLanguage = new HashMap<>();
            this.byStatus = new HashMap<>();
            this.dailyStats = new ArrayList<>();
            this.masteryDistribution = new HashMap<>();
            this.reviewFrequency = new HashMap<>();
        }

        // Getters and Setters
        public int getTotalWords() { return totalWords; }
        public void setTotalWords(int totalWords) { this.totalWords = totalWords; }

        public int getMasteredWords() { return masteredWords; }
        public void setMasteredWords(int masteredWords) { this.masteredWords = masteredWords; }

        public int getLearningWords() { return learningWords; }
        public void setLearningWords(int learningWords) { this.learningWords = learningWords; }

        public int getNewWords() { return newWords; }
        public void setNewWords(int newWords) { this.newWords = newWords; }

        public int getTodayAdded() { return todayAdded; }
        public void setTodayAdded(int todayAdded) { this.todayAdded = todayAdded; }

        public int getTodayReviewed() { return todayReviewed; }
        public void setTodayReviewed(int todayReviewed) { this.todayReviewed = todayReviewed; }

        public int getWeeklyProgress() { return weeklyProgress; }
        public void setWeeklyProgress(int weeklyProgress) { this.weeklyProgress = weeklyProgress; }

        public int getMonthlyProgress() { return monthlyProgress; }
        public void setMonthlyProgress(int monthlyProgress) { this.monthlyProgress = monthlyProgress; }

        public Map<String, Integer> getByLanguage() { return byLanguage; }
        public void setByLanguage(Map<String, Integer> byLanguage) { this.byLanguage = byLanguage; }

        public Map<String, Integer> getByStatus() { return byStatus; }
        public void setByStatus(Map<String, Integer> byStatus) { this.byStatus = byStatus; }

        public int getStreakDays() { return streakDays; }
        public void setStreakDays(int streakDays) { this.streakDays = streakDays; }

        public List<DailyLearningStat> getDailyStats() { return dailyStats; }
        public void setDailyStats(List<DailyLearningStat> dailyStats) { this.dailyStats = dailyStats; }

        public Map<String, Object> getMasteryDistribution() { return masteryDistribution; }
        public void setMasteryDistribution(Map<String, Object> masteryDistribution) { this.masteryDistribution = masteryDistribution; }

        public Map<String, Object> getReviewFrequency() { return reviewFrequency; }
        public void setReviewFrequency(Map<String, Object> reviewFrequency) { this.reviewFrequency = reviewFrequency; }
    }

    public static class DailyLearningStat {
        private String date;
        private int addedCount;
        private int reviewedCount;
        private int masteredCount;
        private int totalStudyTime; // 分钟

        public DailyLearningStat(String date, int addedCount, int reviewedCount, int masteredCount, int totalStudyTime) {
            this.date = date;
            this.addedCount = addedCount;
            this.reviewedCount = reviewedCount;
            this.masteredCount = masteredCount;
            this.totalStudyTime = totalStudyTime;
        }

        // Getters and Setters
        public String getDate() { return date; }
        public void setDate(String date) { this.date = date; }

        public int getAddedCount() { return addedCount; }
        public void setAddedCount(int addedCount) { this.addedCount = addedCount; }

        public int getReviewedCount() { return reviewedCount; }
        public void setReviewedCount(int reviewedCount) { this.reviewedCount = reviewedCount; }

        public int getMasteredCount() { return masteredCount; }
        public void setMasteredCount(int masteredCount) { this.masteredCount = masteredCount; }

        public int getTotalStudyTime() { return totalStudyTime; }
        public void setTotalStudyTime(int totalStudyTime) { this.totalStudyTime = totalStudyTime; }
    }

    @GetMapping("/learning-stats")
    public ResponseEntity<LearningStatsResponse> getLearningStats(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestParam(required = false) String period,
            @RequestParam(required = false) String language) {

        Map<String, Object> requestParams = new HashMap<>();
        requestParams.put("period", period);
        requestParams.put("language", language);
        printRequest(requestParams);

        try {
            // 1. 验证用户身份
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new LearningStatsResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > ?";
            LocalDateTime now = LocalDateTime.now();
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(userSql, token, now);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new LearningStatsResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Long userId = ((Number) sessions.get(0).get("user_id")).longValue();

            // 2. 设置默认参数
            if (period == null) period = "week";
            LocalDate today = LocalDate.now();
            LocalDate startDate;

            switch (period.toLowerCase()) {
                case "day":
                    startDate = today;
                    break;
                case "week":
                    startDate = today.minusDays(6);
                    break;
                case "month":
                    startDate = today.minusDays(29);
                    break;
                case "year":
                    startDate = today.minusDays(364);
                    break;
                default:
                    startDate = today.minusDays(6);
                    period = "week";
            }

            // 3. 构建查询条件
            StringBuilder whereClause = new StringBuilder("WHERE user_id = ?");
            List<Object> params = new ArrayList<>();
            params.add(userId);

            if (language != null && !language.trim().isEmpty()) {
                whereClause.append(" AND language = ?");
                params.add(language.trim());
            }

            // 4. 查询总单词数
            String totalSql = "SELECT COUNT(*) as total FROM user_vocabulary " + whereClause.toString();
            Long totalWords = jdbcTemplate.queryForObject(totalSql, Long.class, params.toArray());

            // 5. 查询按状态统计
            String statusSql = "SELECT status, COUNT(*) as count FROM user_vocabulary " + whereClause.toString() + " GROUP BY status";
            List<Map<String, Object>> statusStats = jdbcTemplate.queryForList(statusSql, params.toArray());

            int masteredWords = 0;
            int learningWords = 0;
            int newWords = 0;
            Map<String, Integer> byStatus = new HashMap<>();

            for (Map<String, Object> row : statusStats) {
                String status = (String) row.get("status");
                Long count = (Long) row.get("count");
                byStatus.put(status, count.intValue());

                switch (status) {
                    case "mastered":
                        masteredWords = count.intValue();
                        break;
                    case "learning":
                        learningWords = count.intValue();
                        break;
                    case "new":
                        newWords = count.intValue();
                        break;
                }
            }

            // 6. 查询按语言统计
            String languageSql = "SELECT language, COUNT(*) as count FROM user_vocabulary WHERE user_id = ? GROUP BY language";
            List<Map<String, Object>> languageStats = jdbcTemplate.queryForList(languageSql, userId);

            Map<String, Integer> byLanguage = new HashMap<>();
            for (Map<String, Object> row : languageStats) {
                String lang = (String) row.get("language");
                Long count = (Long) row.get("count");
                byLanguage.put(lang, count.intValue());
            }

            // 7. 查询今日添加
            String todayAddedSql = "SELECT COUNT(*) as count FROM user_vocabulary WHERE user_id = ? AND DATE(created_at) = ?";
            Long todayAdded = jdbcTemplate.queryForObject(todayAddedSql, Long.class, userId, today);

            // 8. 查询今日复习
            String todayReviewedSql = "SELECT COUNT(*) as count FROM user_vocabulary WHERE user_id = ? AND DATE(last_reviewed_at) = ?";
            Long todayReviewed = jdbcTemplate.queryForObject(todayReviewedSql, Long.class, userId, today);

            // 9. 查询本周进度（过去7天）
            LocalDate weekStart = today.minusDays(6);
            String weeklyProgressSql = "SELECT COUNT(*) as count FROM user_vocabulary WHERE user_id = ? AND DATE(created_at) >= ?";
            Long weeklyProgress = jdbcTemplate.queryForObject(weeklyProgressSql, Long.class, userId, weekStart);

            // 10. 查询本月进度（过去30天）
            LocalDate monthStart = today.minusDays(29);
            String monthlyProgressSql = "SELECT COUNT(*) as count FROM user_vocabulary WHERE user_id = ? AND DATE(created_at) >= ?";
            Long monthlyProgress = jdbcTemplate.queryForObject(monthlyProgressSql, Long.class, userId, monthStart);

            // 11. 查询连续学习天数
            String streakSql = "SELECT COUNT(DISTINCT DATE(created_at)) as streak FROM user_vocabulary " +
                    "WHERE user_id = ? AND created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY) " +
                    "ORDER BY created_at DESC";
            Long streakDays = jdbcTemplate.queryForObject(streakSql, Long.class, userId);

            // 12. 查询每日统计
            List<DailyLearningStat> dailyStats = new ArrayList<>();
            DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd");

            // 根据period决定查询多少天的数据
            int daysToQuery = 0;
            switch (period.toLowerCase()) {
                case "day": daysToQuery = 1; break;
                case "week": daysToQuery = 7; break;
                case "month": daysToQuery = 30; break;
                case "year": daysToQuery = 365; break;
                default: daysToQuery = 7;
            }

            for (int i = daysToQuery - 1; i >= 0; i--) {
                LocalDate date = today.minusDays(i);
                String dateStr = date.format(formatter);

                // 查询当日添加
                String dailyAddedSql = "SELECT COUNT(*) as count FROM user_vocabulary WHERE user_id = ? AND DATE(created_at) = ?";
                Long dailyAdded = jdbcTemplate.queryForObject(dailyAddedSql, Long.class, userId, date);

                // 查询当日复习
                String dailyReviewedSql = "SELECT COUNT(*) as count FROM user_vocabulary WHERE user_id = ? AND DATE(last_reviewed_at) = ?";
                Long dailyReviewed = jdbcTemplate.queryForObject(dailyReviewedSql, Long.class, userId, date);

                // 查询当日掌握
                String dailyMasteredSql = "SELECT COUNT(*) as count FROM user_vocabulary WHERE user_id = ? AND status = 'mastered' AND DATE(updated_at) = ?";
                Long dailyMastered = jdbcTemplate.queryForObject(dailyMasteredSql, Long.class, userId, date);

                // 查询当日学习时间（从daily_learning_stats表）
                String studyTimeSql = "SELECT total_study_time FROM daily_learning_stats WHERE user_id = ? AND date = ?";
                List<Map<String, Object>> studyTimeResults = jdbcTemplate.queryForList(studyTimeSql, userId, date);
                int totalStudyTime = 0;
                if (!studyTimeResults.isEmpty()) {
                    totalStudyTime = studyTimeResults.get(0).get("total_study_time") != null ?
                            ((Number) studyTimeResults.get(0).get("total_study_time")).intValue() : 0;
                }

                dailyStats.add(new DailyLearningStat(dateStr, dailyAdded.intValue(), dailyReviewed.intValue(),
                        dailyMastered.intValue(), totalStudyTime));
            }

            // 13. 查询掌握程度分布
            Map<String, Object> masteryDistribution = new HashMap<>();
            String masterySql = "SELECT mastery_level, COUNT(*) as count FROM user_vocabulary WHERE user_id = ? GROUP BY mastery_level ORDER BY mastery_level";
            List<Map<String, Object>> masteryStats = jdbcTemplate.queryForList(masterySql, userId);

            for (Map<String, Object> row : masteryStats) {
                Integer level = row.get("mastery_level") != null ? ((Number) row.get("mastery_level")).intValue() : 0;
                Long count = (Long) row.get("count");
                masteryDistribution.put("level_" + level, count.intValue());
            }

            // 14. 查询复习频率
            Map<String, Object> reviewFrequency = new HashMap<>();
            String reviewFreqSql = "SELECT review_count, COUNT(*) as count FROM user_vocabulary WHERE user_id = ? GROUP BY review_count ORDER BY review_count";
            List<Map<String, Object>> reviewFreqStats = jdbcTemplate.queryForList(reviewFreqSql, userId);

            for (Map<String, Object> row : reviewFreqStats) {
                Integer count = row.get("review_count") != null ? ((Number) row.get("review_count")).intValue() : 0;
                Long freq = (Long) row.get("count");
                reviewFrequency.put("reviewed_" + count + "_times", freq.intValue());
            }

            // 15. 组装统计数据
            LearningStatsData statsData = new LearningStatsData();
            statsData.setTotalWords(totalWords.intValue());
            statsData.setMasteredWords(masteredWords);
            statsData.setLearningWords(learningWords);
            statsData.setNewWords(newWords);
            statsData.setTodayAdded(todayAdded.intValue());
            statsData.setTodayReviewed(todayReviewed.intValue());
            statsData.setWeeklyProgress(weeklyProgress.intValue());
            statsData.setMonthlyProgress(monthlyProgress.intValue());
            statsData.setByLanguage(byLanguage);
            statsData.setByStatus(byStatus);
            statsData.setStreakDays(streakDays != null ? streakDays.intValue() : 0);
            statsData.setDailyStats(dailyStats);
            statsData.setMasteryDistribution(masteryDistribution);
            statsData.setReviewFrequency(reviewFrequency);

            printQueryResult(statsData);

            // 16. 创建响应
            LearningStatsResponse response = new LearningStatsResponse(true, "获取学习统计成功", statsData);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取学习统计过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new LearningStatsResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: VocabularyGetLearningStats.java ---

--- 开始文件: VocabularyGetList.java ---

package com.vue.readingapp.vocabulary;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;
import java.time.LocalDateTime;

@RestController
@RequestMapping("/api/v1/vocabulary")
public class VocabularyGetList {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取生词本列表请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("==========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class VocabularyListResponse {
        private boolean success;
        private String message;
        private VocabularyListData data;

        public VocabularyListResponse(boolean success, String message, VocabularyListData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public VocabularyListData getData() { return data; }
        public void setData(VocabularyListData data) { this.data = data; }
    }

    public static class VocabularyListData {
        private List<VocabularyItemData> items;
        private PaginationData pagination;

        public VocabularyListData(List<VocabularyItemData> items, PaginationData pagination) {
            this.items = items;
            this.pagination = pagination;
        }

        public List<VocabularyItemData> getItems() { return items; }
        public void setItems(List<VocabularyItemData> items) { this.items = items; }

        public PaginationData getPagination() { return pagination; }
        public void setPagination(PaginationData pagination) { this.pagination = pagination; }
    }

    public static class VocabularyItemData {
        private Long id;
        private String word;
        private String language;
        private String definition;
        private String example;
        private List<String> tags;
        private String notes;
        private String status;
        private Integer masteryLevel;
        private Integer reviewCount;
        private String lastReviewedAt;
        private String nextReviewAt;
        private String source;
        private Integer sourcePage;
        private String createdAt;
        private String updatedAt;

        public VocabularyItemData() {
            this.tags = new ArrayList<>();
        }

        // Getters and Setters
        public Long getId() { return id; }
        public void setId(Long id) { this.id = id; }

        public String getWord() { return word; }
        public void setWord(String word) { this.word = word; }

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }

        public String getDefinition() { return definition; }
        public void setDefinition(String definition) { this.definition = definition; }

        public String getExample() { return example; }
        public void setExample(String example) { this.example = example; }

        public List<String> getTags() { return tags; }
        public void setTags(List<String> tags) { this.tags = tags; }

        public String getNotes() { return notes; }
        public void setNotes(String notes) { this.notes = notes; }

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public Integer getMasteryLevel() { return masteryLevel; }
        public void setMasteryLevel(Integer masteryLevel) { this.masteryLevel = masteryLevel; }

        public Integer getReviewCount() { return reviewCount; }
        public void setReviewCount(Integer reviewCount) { this.reviewCount = reviewCount; }

        public String getLastReviewedAt() { return lastReviewedAt; }
        public void setLastReviewedAt(String lastReviewedAt) { this.lastReviewedAt = lastReviewedAt; }

        public String getNextReviewAt() { return nextReviewAt; }
        public void setNextReviewAt(String nextReviewAt) { this.nextReviewAt = nextReviewAt; }

        public String getSource() { return source; }
        public void setSource(String source) { this.source = source; }

        public Integer getSourcePage() { return sourcePage; }
        public void setSourcePage(Integer sourcePage) { this.sourcePage = sourcePage; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }
    }

    public static class PaginationData {
        private int page;
        private int pageSize;
        private long total;
        private int totalPages;

        public PaginationData(int page, int pageSize, long total) {
            this.page = page;
            this.pageSize = pageSize;
            this.total = total;
            this.totalPages = (int) Math.ceil((double) total / pageSize);
        }

        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public int getPageSize() { return pageSize; }
        public void setPageSize(int pageSize) { this.pageSize = pageSize; }

        public long getTotal() { return total; }
        public void setTotal(long total) { this.total = total; }

        public int getTotalPages() { return totalPages; }
        public void setTotalPages(int totalPages) { this.totalPages = totalPages; }
    }

    @GetMapping("")
    public ResponseEntity<VocabularyListResponse> getVocabularyList(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestParam(required = false, defaultValue = "1") int page,
            @RequestParam(required = false, defaultValue = "50") int pageSize,
            @RequestParam(required = false) String status,
            @RequestParam(required = false) List<String> tags,
            @RequestParam(required = false) String language,
            @RequestParam(required = false, defaultValue = "created_at") String sortBy,
            @RequestParam(required = false, defaultValue = "desc") String sortOrder,
            @RequestParam(required = false) String search) {

        Map<String, Object> requestParams = new HashMap<>();
        requestParams.put("page", page);
        requestParams.put("pageSize", pageSize);
        requestParams.put("status", status);
        requestParams.put("tags", tags);
        requestParams.put("language", language);
        requestParams.put("sortBy", sortBy);
        requestParams.put("sortOrder", sortOrder);
        requestParams.put("search", search);
        printRequest(requestParams);

        try {
            // 1. 验证用户身份
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new VocabularyListResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > ?";
            LocalDateTime now = LocalDateTime.now();
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(userSql, token, now);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new VocabularyListResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Long userId = ((Number) sessions.get(0).get("user_id")).longValue();

            // 2. 验证参数
            if (page < 1) page = 1;
            if (pageSize < 1 || pageSize > 200) pageSize = 50;
            if (!Arrays.asList("asc", "desc").contains(sortOrder.toLowerCase())) {
                sortOrder = "desc";
            }

            // 3. 构建查询条件
            StringBuilder whereClause = new StringBuilder("WHERE uv.user_id = ?");
            List<Object> params = new ArrayList<>();
            params.add(userId);

            if (status != null && !status.trim().isEmpty()) {
                whereClause.append(" AND uv.status = ?");
                params.add(status.trim());
            }

            if (language != null && !language.trim().isEmpty()) {
                whereClause.append(" AND uv.language = ?");
                params.add(language.trim());
            }

            if (search != null && !search.trim().isEmpty()) {
                whereClause.append(" AND (uv.word LIKE ? OR uv.definition LIKE ? OR uv.notes LIKE ?)");
                String searchPattern = "%" + search.trim() + "%";
                params.add(searchPattern);
                params.add(searchPattern);
                params.add(searchPattern);
            }

            // 4. 查询总数
            String countSql = "SELECT COUNT(DISTINCT uv.user_vocab_id) as total " +
                    "FROM user_vocabulary uv " +
                    "LEFT JOIN user_vocabulary_tags uvt ON uv.user_vocab_id = uvt.user_vocab_id " +
                    "LEFT JOIN vocabulary_tags vt ON uvt.tag_id = vt.tag_id " +
                    whereClause.toString();

            if (tags != null && !tags.isEmpty()) {
                countSql += " AND vt.tag_name IN (" + String.join(",", Collections.nCopies(tags.size(), "?")) + ")";
                params.addAll(tags);
            }

            Long total = jdbcTemplate.queryForObject(countSql, Long.class, params.toArray());

            // 5. 查询数据
            String dataSql = "SELECT uv.user_vocab_id, uv.word, uv.language, uv.definition, uv.example, uv.notes, " +
                    "uv.status, uv.mastery_level, uv.review_count, uv.last_reviewed_at, uv.next_review_at, " +
                    "uv.source, uv.source_page, uv.created_at, uv.updated_at, " +
                    "GROUP_CONCAT(DISTINCT vt.tag_name) as tags " +
                    "FROM user_vocabulary uv " +
                    "LEFT JOIN user_vocabulary_tags uvt ON uv.user_vocab_id = uvt.user_vocab_id " +
                    "LEFT JOIN vocabulary_tags vt ON uvt.tag_id = vt.tag_id " +
                    whereClause.toString();

            if (tags != null && !tags.isEmpty()) {
                dataSql += " AND vt.tag_name IN (" + String.join(",", Collections.nCopies(tags.size(), "?")) + ")";
            }

            dataSql += " GROUP BY uv.user_vocab_id";

            // 添加排序
            String validSortBy = Arrays.asList("created_at", "updated_at", "word", "status", "mastery_level")
                    .contains(sortBy) ? sortBy : "created_at";
            dataSql += " ORDER BY " + validSortBy + " " + sortOrder;

            // 添加分页
            int offset = (page - 1) * pageSize;
            dataSql += " LIMIT ? OFFSET ?";
            params.add(pageSize);
            params.add(offset);

            List<Map<String, Object>> results = jdbcTemplate.queryForList(dataSql, params.toArray());
            printQueryResult("查询到 " + results.size() + " 条记录，总数: " + total);

            // 6. 组装数据
            List<VocabularyItemData> items = new ArrayList<>();
            for (Map<String, Object> row : results) {
                VocabularyItemData item = new VocabularyItemData();
                item.setId(((Number) row.get("user_vocab_id")).longValue());
                item.setWord((String) row.get("word"));
                item.setLanguage((String) row.get("language"));
                item.setDefinition((String) row.get("definition"));
                item.setExample((String) row.get("example"));
                item.setNotes((String) row.get("notes"));
                item.setStatus((String) row.get("status"));
                item.setMasteryLevel(row.get("mastery_level") != null ? ((Number) row.get("mastery_level")).intValue() : 0);
                item.setReviewCount(row.get("review_count") != null ? ((Number) row.get("review_count")).intValue() : 0);
                item.setLastReviewedAt(row.get("last_reviewed_at") != null ? row.get("last_reviewed_at").toString() : null);
                item.setNextReviewAt(row.get("next_review_at") != null ? row.get("next_review_at").toString() : null);
                item.setSource((String) row.get("source"));
                item.setSourcePage(row.get("source_page") != null ? ((Number) row.get("source_page")).intValue() : null);
                item.setCreatedAt(row.get("created_at").toString());
                item.setUpdatedAt(row.get("updated_at").toString());

                // 处理标签
                String tagsStr = (String) row.get("tags");
                if (tagsStr != null && !tagsStr.isEmpty()) {
                    item.setTags(Arrays.asList(tagsStr.split(",")));
                }

                items.add(item);
            }

            // 7. 创建分页数据
            PaginationData pagination = new PaginationData(page, pageSize, total);

            // 8. 创建响应
            VocabularyListData listData = new VocabularyListData(items, pagination);
            VocabularyListResponse response = new VocabularyListResponse(true, "获取生词本列表成功", listData);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取生词本列表过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new VocabularyListResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: VocabularyGetList.java ---

--- 开始文件: VocabularyGetReviewStats.java ---
package com.vue.readingapp.vocabulary;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;
import java.time.LocalDateTime;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;

@RestController
@RequestMapping("/api/v1/vocabulary")
public class VocabularyGetReviewStats {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取复习统计请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("==========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class ReviewStatsResponse {
        private boolean success;
        private String message;
        private ReviewStatsData data;

        public ReviewStatsResponse(boolean success, String message, ReviewStatsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public ReviewStatsData getData() { return data; }
        public void setData(ReviewStatsData data) { this.data = data; }
    }

    public static class ReviewStatsData {
        private int dueToday;
        private int dueTomorrow;
        private int dueThisWeek;
        private int totalDue;
        private double reviewAccuracy;
        private double averageMastery;
        private String lastReviewDate;
        private List<ReviewHistoryItem> reviewHistory;
        private Map<String, Integer> dailyReviewTrend;
        private Map<String, Object> reviewPerformance;

        public ReviewStatsData() {
            this.reviewHistory = new ArrayList<>();
            this.dailyReviewTrend = new HashMap<>();
            this.reviewPerformance = new HashMap<>();
        }

        // Getters and Setters
        public int getDueToday() { return dueToday; }
        public void setDueToday(int dueToday) { this.dueToday = dueToday; }

        public int getDueTomorrow() { return dueTomorrow; }
        public void setDueTomorrow(int dueTomorrow) { this.dueTomorrow = dueTomorrow; }

        public int getDueThisWeek() { return dueThisWeek; }
        public void setDueThisWeek(int dueThisWeek) { this.dueThisWeek = dueThisWeek; }

        public int getTotalDue() { return totalDue; }
        public void setTotalDue(int totalDue) { this.totalDue = totalDue; }

        public double getReviewAccuracy() { return reviewAccuracy; }
        public void setReviewAccuracy(double reviewAccuracy) { this.reviewAccuracy = reviewAccuracy; }

        public double getAverageMastery() { return averageMastery; }
        public void setAverageMastery(double averageMastery) { this.averageMastery = averageMastery; }

        public String getLastReviewDate() { return lastReviewDate; }
        public void setLastReviewDate(String lastReviewDate) { this.lastReviewDate = lastReviewDate; }

        public List<ReviewHistoryItem> getReviewHistory() { return reviewHistory; }
        public void setReviewHistory(List<ReviewHistoryItem> reviewHistory) { this.reviewHistory = reviewHistory; }

        public Map<String, Integer> getDailyReviewTrend() { return dailyReviewTrend; }
        public void setDailyReviewTrend(Map<String, Integer> dailyReviewTrend) { this.dailyReviewTrend = dailyReviewTrend; }

        public Map<String, Object> getReviewPerformance() { return reviewPerformance; }
        public void setReviewPerformance(Map<String, Object> reviewPerformance) { this.reviewPerformance = reviewPerformance; }
    }

    public static class ReviewHistoryItem {
        private String date;
        private int reviewedCount;
        private int correctCount;
        private double accuracy;

        public ReviewHistoryItem(String date, int reviewedCount, int correctCount, double accuracy) {
            this.date = date;
            this.reviewedCount = reviewedCount;
            this.correctCount = correctCount;
            this.accuracy = accuracy;
        }

        // Getters and Setters
        public String getDate() { return date; }
        public void setDate(String date) { this.date = date; }

        public int getReviewedCount() { return reviewedCount; }
        public void setReviewedCount(int reviewedCount) { this.reviewedCount = reviewedCount; }

        public int getCorrectCount() { return correctCount; }
        public void setCorrectCount(int correctCount) { this.correctCount = correctCount; }

        public double getAccuracy() { return accuracy; }
        public void setAccuracy(double accuracy) { this.accuracy = accuracy; }
    }

    @GetMapping("/review-stats")
    public ResponseEntity<ReviewStatsResponse> getReviewStats(
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        printRequest("获取复习统计");

        try {
            // 1. 验证用户身份
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ReviewStatsResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > ?";
            LocalDateTime now = LocalDateTime.now();
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(userSql, token, now);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ReviewStatsResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Long userId = ((Number) sessions.get(0).get("user_id")).longValue();
            LocalDate today = LocalDate.now();
            LocalDate tomorrow = today.plusDays(1);
            LocalDate weekEnd = today.plusDays(7);

            // 2. 查询今日到期单词
            String dueTodaySql = "SELECT COUNT(*) as count FROM user_vocabulary WHERE user_id = ? AND " +
                    "(next_review_at IS NULL OR DATE(next_review_at) <= ?) AND status != 'mastered'";
            Long dueToday = jdbcTemplate.queryForObject(dueTodaySql, Long.class, userId, today);

            // 3. 查询明日到期单词
            String dueTomorrowSql = "SELECT COUNT(*) as count FROM user_vocabulary WHERE user_id = ? AND " +
                    "DATE(next_review_at) = ? AND status != 'mastered'";
            Long dueTomorrow = jdbcTemplate.queryForObject(dueTomorrowSql, Long.class, userId, tomorrow);

            // 4. 查询本周到期单词
            String dueThisWeekSql = "SELECT COUNT(*) as count FROM user_vocabulary WHERE user_id = ? AND " +
                    "DATE(next_review_at) BETWEEN ? AND ? AND status != 'mastered'";
            Long dueThisWeek = jdbcTemplate.queryForObject(dueThisWeekSql, Long.class, userId, today, weekEnd);

            // 5. 查询总到期单词（所有未掌握的）
            String totalDueSql = "SELECT COUNT(*) as count FROM user_vocabulary WHERE user_id = ? AND status != 'mastered'";
            Long totalDue = jdbcTemplate.queryForObject(totalDueSql, Long.class, userId);

            // 6. 查询复习准确率（从复习记录中计算）
            String accuracySql = "SELECT " +
                    "COUNT(*) as total_reviews, " +
                    "SUM(CASE WHEN is_correct = 1 THEN 1 ELSE 0 END) as correct_reviews " +
                    "FROM review_items WHERE user_id = ? AND review_date >= DATE_SUB(NOW(), INTERVAL 30 DAY)";

            List<Map<String, Object>> accuracyResults = jdbcTemplate.queryForList(accuracySql, userId);
            double reviewAccuracy = 0.0;
            if (!accuracyResults.isEmpty()) {
                Map<String, Object> row = accuracyResults.get(0);
                Long totalReviews = (Long) row.get("total_reviews");
                Long correctReviews = (Long) row.get("correct_reviews");

                if (totalReviews != null && totalReviews > 0) {
                    reviewAccuracy = (double) correctReviews / totalReviews * 100;
                }
            }

            // 7. 查询平均掌握程度
            String avgMasterySql = "SELECT AVG(mastery_level) as avg_mastery FROM user_vocabulary WHERE user_id = ?";
            Double avgMastery = jdbcTemplate.queryForObject(avgMasterySql, Double.class, userId);
            if (avgMastery == null) avgMastery = 0.0;

            // 8. 查询最后复习日期
            String lastReviewSql = "SELECT MAX(last_reviewed_at) as last_review FROM user_vocabulary WHERE user_id = ?";
            List<Map<String, Object>> lastReviewResults = jdbcTemplate.queryForList(lastReviewSql, userId);
            String lastReviewDate = null;
            if (!lastReviewResults.isEmpty()) {
                Object lastReview = lastReviewResults.get(0).get("last_review");
                if (lastReview != null) {
                    lastReviewDate = lastReview.toString();
                }
            }

            // 9. 查询复习历史（最近7天）
            List<ReviewHistoryItem> reviewHistory = new ArrayList<>();
            DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd");

            for (int i = 6; i >= 0; i--) {
                LocalDate date = today.minusDays(i);
                String dateStr = date.format(formatter);

                // 查询当日复习数量
                String dailyReviewSql = "SELECT COUNT(*) as count FROM user_vocabulary WHERE user_id = ? AND DATE(last_reviewed_at) = ?";
                Long dailyReviewed = jdbcTemplate.queryForObject(dailyReviewSql, Long.class, userId, date);

                // 查询当日正确数量（从review_items表）
                String dailyCorrectSql = "SELECT COUNT(*) as count FROM review_items WHERE user_id = ? AND DATE(review_date) = ? AND is_correct = 1";
                Long dailyCorrect = jdbcTemplate.queryForObject(dailyCorrectSql, Long.class, userId, date);

                double dailyAccuracy = 0.0;
                if (dailyReviewed != null && dailyReviewed > 0 && dailyCorrect != null) {
                    dailyAccuracy = (double) dailyCorrect / dailyReviewed * 100;
                }

                reviewHistory.add(new ReviewHistoryItem(dateStr,
                        dailyReviewed != null ? dailyReviewed.intValue() : 0,
                        dailyCorrect != null ? dailyCorrect.intValue() : 0,
                        dailyAccuracy));
            }

            // 10. 查询每日复习趋势（最近30天）
            Map<String, Integer> dailyReviewTrend = new LinkedHashMap<>();
            for (int i = 29; i >= 0; i--) {
                LocalDate date = today.minusDays(i);
                String dateStr = date.format(formatter);

                String trendSql = "SELECT COUNT(*) as count FROM user_vocabulary WHERE user_id = ? AND DATE(last_reviewed_at) = ?";
                Long dailyCount = jdbcTemplate.queryForObject(trendSql, Long.class, userId, date);

                dailyReviewTrend.put(dateStr, dailyCount != null ? dailyCount.intValue() : 0);
            }

            // 11. 查询复习表现统计
            Map<String, Object> reviewPerformance = new HashMap<>();

            // 查询不同掌握程度的复习表现
            String performanceSql = "SELECT " +
                    "mastery_level, " +
                    "COUNT(*) as total_words, " +
                    "AVG(review_count) as avg_reviews " +
                    "FROM user_vocabulary WHERE user_id = ? AND status != 'mastered' " +
                    "GROUP BY mastery_level ORDER BY mastery_level";

            List<Map<String, Object>> performanceResults = jdbcTemplate.queryForList(performanceSql, userId);
            Map<String, Object> masteryPerformance = new HashMap<>();
            for (Map<String, Object> row : performanceResults) {
                Integer level = row.get("mastery_level") != null ? ((Number) row.get("mastery_level")).intValue() : 0;
                Long totalWords = (Long) row.get("total_words");
                Double avgReviews = (Double) row.get("avg_reviews");

                Map<String, Object> levelStats = new HashMap<>();
                levelStats.put("total_words", totalWords != null ? totalWords.intValue() : 0);
                levelStats.put("avg_reviews", avgReviews != null ? avgReviews : 0.0);
                masteryPerformance.put("level_" + level, levelStats);
            }

            reviewPerformance.put("mastery_level_performance", masteryPerformance);

            // 12. 组装统计数据
            ReviewStatsData statsData = new ReviewStatsData();
            statsData.setDueToday(dueToday != null ? dueToday.intValue() : 0);
            statsData.setDueTomorrow(dueTomorrow != null ? dueTomorrow.intValue() : 0);
            statsData.setDueThisWeek(dueThisWeek != null ? dueThisWeek.intValue() : 0);
            statsData.setTotalDue(totalDue != null ? totalDue.intValue() : 0);
            statsData.setReviewAccuracy(reviewAccuracy);
            statsData.setAverageMastery(avgMastery);
            statsData.setLastReviewDate(lastReviewDate);
            statsData.setReviewHistory(reviewHistory);
            statsData.setDailyReviewTrend(dailyReviewTrend);
            statsData.setReviewPerformance(reviewPerformance);

            printQueryResult(statsData);

            // 13. 创建响应
            ReviewStatsResponse response = new ReviewStatsResponse(true, "获取复习统计成功", statsData);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取复习统计过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ReviewStatsResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: VocabularyGetReviewStats.java ---

--- 开始文件: VocabularyGetSimilarWords.java ---
package com.vue.readingapp.vocabulary;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;
import java.time.LocalDateTime;

@RestController
@RequestMapping("/api/v1/words")
public class VocabularyGetSimilarWords {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取相似单词请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class SimilarWordsResponse {
        private boolean success;
        private String message;
        private SimilarWordsData data;

        public SimilarWordsResponse(boolean success, String message, SimilarWordsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public SimilarWordsData getData() { return data; }
        public void setData(SimilarWordsData data) { this.data = data; }
    }

    public static class SimilarWordsData {
        private String word;
        private String language;
        private List<SimilarWord> similarWords;

        public SimilarWordsData(String word, String language, List<SimilarWord> similarWords) {
            this.word = word;
            this.language = language;
            this.similarWords = similarWords;
        }

        // Getters and Setters
        public String getWord() { return word; }
        public void setWord(String word) { this.word = word; }

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }

        public List<SimilarWord> getSimilarWords() { return similarWords; }
        public void setSimilarWords(List<SimilarWord> similarWords) { this.similarWords = similarWords; }
    }

    public static class SimilarWord {
        private String word;
        private String language;
        private String relationType;
        private String definition;

        public SimilarWord(String word, String language, String relationType, String definition) {
            this.word = word;
            this.language = language;
            this.relationType = relationType;
            this.definition = definition;
        }

        // Getters and Setters
        public String getWord() { return word; }
        public void setWord(String word) { this.word = word; }

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }

        public String getRelationType() { return relationType; }
        public void setRelationType(String relationType) { this.relationType = relationType; }

        public String getDefinition() { return definition; }
        public void setDefinition(String definition) { this.definition = definition; }
    }

    @GetMapping("/similar")
    public ResponseEntity<SimilarWordsResponse> getSimilarWords(
            @RequestParam String word,
            @RequestParam(required = false, defaultValue = "en") String language) {

        Map<String, String> requestData = new HashMap<>();
        requestData.put("word", word);
        requestData.put("language", language);
        printRequest(requestData);

        try {
            // 1. 验证请求数据
            if (word == null || word.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new SimilarWordsResponse(false, "单词不能为空", null)
                );
            }

            String normalizedWord = word.trim().toLowerCase();

            // 2. 查询单词ID
            String wordSql = "SELECT word_id FROM words WHERE word = ? AND language = ?";
            List<Map<String, Object>> words = jdbcTemplate.queryForList(wordSql, normalizedWord, language);

            if (words.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new SimilarWordsResponse(false, "未找到单词: " + normalizedWord, null)
                );
            }

            Long wordId = ((Number) words.get(0).get("word_id")).longValue();

            // 3. 查询相似单词（同义词、近义词等）
            String similarSql = "SELECT w.word, w.language, wr.relation_type, wd.definition " +
                    "FROM word_relations wr " +
                    "JOIN words w ON wr.related_word_id = w.word_id " +
                    "LEFT JOIN word_definitions wd ON w.word_id = wd.word_id AND wd.definition_id = (SELECT MIN(definition_id) FROM word_definitions WHERE word_id = w.word_id) " +
                    "WHERE wr.word_id = ? AND wr.relation_type IN ('synonym', 'related') " +
                    "ORDER BY wr.relation_type, w.word " +
                    "LIMIT 20";

            List<Map<String, Object>> similarResults = jdbcTemplate.queryForList(similarSql, wordId);
            printQueryResult(similarResults);

            // 4. 组装数据
            List<SimilarWord> similarWords = new ArrayList<>();
            for (Map<String, Object> row : similarResults) {
                String similarWord = (String) row.get("word");
                String similarLanguage = (String) row.get("language");
                String relationType = (String) row.get("relation_type");
                String definition = (String) row.get("definition");

                similarWords.add(new SimilarWord(similarWord, similarLanguage, relationType, definition));
            }

            // 5. 创建响应数据
            SimilarWordsData data = new SimilarWordsData(normalizedWord, language, similarWords);
            SimilarWordsResponse response = new SimilarWordsResponse(true, "获取相似单词成功", data);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取相似单词过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new SimilarWordsResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: VocabularyGetSimilarWords.java ---

--- 开始文件: VocabularyGetStats.java ---
package com.vue.readingapp.vocabulary;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;
import java.time.LocalDateTime;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;

@RestController
@RequestMapping("/api/v1/vocabulary")
public class VocabularyGetStats {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取生词统计请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("==========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class VocabularyStatsResponse {
        private boolean success;
        private String message;
        private VocabularyStatsData data;

        public VocabularyStatsResponse(boolean success, String message, VocabularyStatsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public VocabularyStatsData getData() { return data; }
        public void setData(VocabularyStatsData data) { this.data = data; }
    }

    public static class VocabularyStatsData {
        private int totalWords;
        private int masteredWords;
        private int learningWords;
        private int newWords;
        private int todayAdded;
        private int todayReviewed;
        private int weeklyProgress;
        private int monthlyProgress;
        private Map<String, Integer> byLanguage;
        private Map<String, Integer> byStatus;
        private int streakDays;
        private List<DailyStat> dailyStats;

        public VocabularyStatsData() {
            this.byLanguage = new HashMap<>();
            this.byStatus = new HashMap<>();
            this.dailyStats = new ArrayList<>();
        }

        // Getters and Setters
        public int getTotalWords() { return totalWords; }
        public void setTotalWords(int totalWords) { this.totalWords = totalWords; }

        public int getMasteredWords() { return masteredWords; }
        public void setMasteredWords(int masteredWords) { this.masteredWords = masteredWords; }

        public int getLearningWords() { return learningWords; }
        public void setLearningWords(int learningWords) { this.learningWords = learningWords; }

        public int getNewWords() { return newWords; }
        public void setNewWords(int newWords) { this.newWords = newWords; }

        public int getTodayAdded() { return todayAdded; }
        public void setTodayAdded(int todayAdded) { this.todayAdded = todayAdded; }

        public int getTodayReviewed() { return todayReviewed; }
        public void setTodayReviewed(int todayReviewed) { this.todayReviewed = todayReviewed; }

        public int getWeeklyProgress() { return weeklyProgress; }
        public void setWeeklyProgress(int weeklyProgress) { this.weeklyProgress = weeklyProgress; }

        public int getMonthlyProgress() { return monthlyProgress; }
        public void setMonthlyProgress(int monthlyProgress) { this.monthlyProgress = monthlyProgress; }

        public Map<String, Integer> getByLanguage() { return byLanguage; }
        public void setByLanguage(Map<String, Integer> byLanguage) { this.byLanguage = byLanguage; }

        public Map<String, Integer> getByStatus() { return byStatus; }
        public void setByStatus(Map<String, Integer> byStatus) { this.byStatus = byStatus; }

        public int getStreakDays() { return streakDays; }
        public void setStreakDays(int streakDays) { this.streakDays = streakDays; }

        public List<DailyStat> getDailyStats() { return dailyStats; }
        public void setDailyStats(List<DailyStat> dailyStats) { this.dailyStats = dailyStats; }
    }

    public static class DailyStat {
        private String date;
        private int addedCount;
        private int reviewedCount;
        private int masteredCount;

        public DailyStat(String date, int addedCount, int reviewedCount, int masteredCount) {
            this.date = date;
            this.addedCount = addedCount;
            this.reviewedCount = reviewedCount;
            this.masteredCount = masteredCount;
        }

        public String getDate() { return date; }
        public void setDate(String date) { this.date = date; }

        public int getAddedCount() { return addedCount; }
        public void setAddedCount(int addedCount) { this.addedCount = addedCount; }

        public int getReviewedCount() { return reviewedCount; }
        public void setReviewedCount(int reviewedCount) { this.reviewedCount = reviewedCount; }

        public int getMasteredCount() { return masteredCount; }
        public void setMasteredCount(int masteredCount) { this.masteredCount = masteredCount; }
    }

    @GetMapping("/stats")
    public ResponseEntity<VocabularyStatsResponse> getVocabularyStats(
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        printRequest("获取生词统计");

        try {
            // 1. 验证用户身份
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new VocabularyStatsResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > ?";
            LocalDateTime now = LocalDateTime.now();
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(userSql, token, now);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new VocabularyStatsResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Long userId = ((Number) sessions.get(0).get("user_id")).longValue();

            // 2. 查询总单词数
            String totalSql = "SELECT COUNT(*) as total FROM user_vocabulary WHERE user_id = ?";
            Long totalWords = jdbcTemplate.queryForObject(totalSql, Long.class, userId);

            // 3. 查询按状态统计
            String statusSql = "SELECT status, COUNT(*) as count FROM user_vocabulary WHERE user_id = ? GROUP BY status";
            List<Map<String, Object>> statusStats = jdbcTemplate.queryForList(statusSql, userId);

            int masteredWords = 0;
            int learningWords = 0;
            int newWords = 0;
            Map<String, Integer> byStatus = new HashMap<>();

            for (Map<String, Object> row : statusStats) {
                String status = (String) row.get("status");
                Long count = (Long) row.get("count");
                byStatus.put(status, count.intValue());

                switch (status) {
                    case "mastered":
                        masteredWords = count.intValue();
                        break;
                    case "learning":
                        learningWords = count.intValue();
                        break;
                    case "new":
                        newWords = count.intValue();
                        break;
                }
            }

            // 4. 查询按语言统计
            String languageSql = "SELECT language, COUNT(*) as count FROM user_vocabulary WHERE user_id = ? GROUP BY language";
            List<Map<String, Object>> languageStats = jdbcTemplate.queryForList(languageSql, userId);

            Map<String, Integer> byLanguage = new HashMap<>();
            for (Map<String, Object> row : languageStats) {
                String language = (String) row.get("language");
                Long count = (Long) row.get("count");
                byLanguage.put(language, count.intValue());
            }

            // 5. 查询今日添加
            LocalDate today = LocalDate.now();
            String todayAddedSql = "SELECT COUNT(*) as count FROM user_vocabulary WHERE user_id = ? AND DATE(created_at) = ?";
            Long todayAdded = jdbcTemplate.queryForObject(todayAddedSql, Long.class, userId, today);

            // 6. 查询今日复习
            String todayReviewedSql = "SELECT COUNT(*) as count FROM user_vocabulary WHERE user_id = ? AND DATE(last_reviewed_at) = ?";
            Long todayReviewed = jdbcTemplate.queryForObject(todayReviewedSql, Long.class, userId, today);

            // 7. 查询本周进度（过去7天）
            LocalDate weekStart = today.minusDays(6);
            String weeklyProgressSql = "SELECT COUNT(*) as count FROM user_vocabulary WHERE user_id = ? AND DATE(created_at) >= ?";
            Long weeklyProgress = jdbcTemplate.queryForObject(weeklyProgressSql, Long.class, userId, weekStart);

            // 8. 查询本月进度（过去30天）
            LocalDate monthStart = today.minusDays(29);
            String monthlyProgressSql = "SELECT COUNT(*) as count FROM user_vocabulary WHERE user_id = ? AND DATE(created_at) >= ?";
            Long monthlyProgress = jdbcTemplate.queryForObject(monthlyProgressSql, Long.class, userId, monthStart);

            // 9. 查询连续学习天数
            String streakSql = "SELECT COUNT(DISTINCT DATE(created_at)) as streak FROM user_vocabulary " +
                    "WHERE user_id = ? AND created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY) " +
                    "ORDER BY created_at DESC";
            Long streakDays = jdbcTemplate.queryForObject(streakSql, Long.class, userId);

            // 10. 查询每日统计（最近7天）
            List<DailyStat> dailyStats = new ArrayList<>();
            DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd");

            for (int i = 6; i >= 0; i--) {
                LocalDate date = today.minusDays(i);
                String dateStr = date.format(formatter);

                // 查询当日添加
                String dailyAddedSql = "SELECT COUNT(*) as count FROM user_vocabulary WHERE user_id = ? AND DATE(created_at) = ?";
                Long dailyAdded = jdbcTemplate.queryForObject(dailyAddedSql, Long.class, userId, date);

                // 查询当日复习
                String dailyReviewedSql = "SELECT COUNT(*) as count FROM user_vocabulary WHERE user_id = ? AND DATE(last_reviewed_at) = ?";
                Long dailyReviewed = jdbcTemplate.queryForObject(dailyReviewedSql, Long.class, userId, date);

                // 查询当日掌握
                String dailyMasteredSql = "SELECT COUNT(*) as count FROM user_vocabulary WHERE user_id = ? AND status = 'mastered' AND DATE(updated_at) = ?";
                Long dailyMastered = jdbcTemplate.queryForObject(dailyMasteredSql, Long.class, userId, date);

                dailyStats.add(new DailyStat(dateStr, dailyAdded.intValue(), dailyReviewed.intValue(), dailyMastered.intValue()));
            }

            // 11. 组装统计数据
            VocabularyStatsData statsData = new VocabularyStatsData();
            statsData.setTotalWords(totalWords.intValue());
            statsData.setMasteredWords(masteredWords);
            statsData.setLearningWords(learningWords);
            statsData.setNewWords(newWords);
            statsData.setTodayAdded(todayAdded.intValue());
            statsData.setTodayReviewed(todayReviewed.intValue());
            statsData.setWeeklyProgress(weeklyProgress.intValue());
            statsData.setMonthlyProgress(monthlyProgress.intValue());
            statsData.setByLanguage(byLanguage);
            statsData.setByStatus(byStatus);
            statsData.setStreakDays(streakDays != null ? streakDays.intValue() : 0);
            statsData.setDailyStats(dailyStats);

            printQueryResult(statsData);

            // 12. 创建响应
            VocabularyStatsResponse response = new VocabularyStatsResponse(true, "获取生词统计成功", statsData);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取生词统计过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new VocabularyStatsResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: VocabularyGetStats.java ---

--- 开始文件: VocabularyGetWordExamples.java ---
package com.vue.readingapp.vocabulary;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;
import java.time.LocalDateTime;

@RestController
@RequestMapping("/api/v1/words")
public class VocabularyGetWordExamples {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取单词例句请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("==========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class WordExamplesResponse {
        private boolean success;
        private String message;
        private WordExamplesData data;

        public WordExamplesResponse(boolean success, String message, WordExamplesData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public WordExamplesData getData() { return data; }
        public void setData(WordExamplesData data) { this.data = data; }
    }

    public static class WordExamplesData {
        private String word;
        private String language;
        private List<Example> examples;

        public WordExamplesData(String word, String language, List<Example> examples) {
            this.word = word;
            this.language = language;
            this.examples = examples;
        }

        // Getters and Setters
        public String getWord() { return word; }
        public void setWord(String word) { this.word = word; }

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }

        public List<Example> getExamples() { return examples; }
        public void setExamples(List<Example> examples) { this.examples = examples; }
    }

    public static class Example {
        private Long exampleId;
        private String example;
        private String translation;
        private String source;

        public Example(Long exampleId, String example, String translation, String source) {
            this.exampleId = exampleId;
            this.example = example;
            this.translation = translation;
            this.source = source;
        }

        // Getters and Setters
        public Long getExampleId() { return exampleId; }
        public void setExampleId(Long exampleId) { this.exampleId = exampleId; }

        public String getExample() { return example; }
        public void setExample(String example) { this.example = example; }

        public String getTranslation() { return translation; }
        public void setTranslation(String translation) { this.translation = translation; }

        public String getSource() { return source; }
        public void setSource(String source) { this.source = source; }
    }

    @GetMapping("/examples")
    public ResponseEntity<WordExamplesResponse> getWordExamples(
            @RequestParam String word,
            @RequestParam(required = false, defaultValue = "en") String language,
            @RequestParam(required = false, defaultValue = "10") int limit) {

        Map<String, Object> requestData = new HashMap<>();
        requestData.put("word", word);
        requestData.put("language", language);
        requestData.put("limit", limit);
        printRequest(requestData);

        try {
            // 1. 验证请求数据
            if (word == null || word.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new WordExamplesResponse(false, "单词不能为空", null)
                );
            }

            if (limit <= 0 || limit > 50) {
                limit = 10;
            }

            String normalizedWord = word.trim().toLowerCase();

            // 2. 查询单词ID
            String wordSql = "SELECT word_id FROM words WHERE word = ? AND language = ?";
            List<Map<String, Object>> words = jdbcTemplate.queryForList(wordSql, normalizedWord, language);

            if (words.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new WordExamplesResponse(false, "未找到单词: " + normalizedWord, null)
                );
            }

            Long wordId = ((Number) words.get(0).get("word_id")).longValue();

            // 3. 查询例句
            String examplesSql = "SELECT example_id, example, translation, source " +
                    "FROM word_examples WHERE word_id = ? " +
                    "ORDER BY example_id " +
                    "LIMIT ?";

            List<Map<String, Object>> exampleResults = jdbcTemplate.queryForList(examplesSql, wordId, limit);
            printQueryResult(exampleResults);

            // 4. 组装数据
            List<Example> examples = new ArrayList<>();
            for (Map<String, Object> row : exampleResults) {
                Long exampleId = ((Number) row.get("example_id")).longValue();
                String exampleText = (String) row.get("example");
                String translation = (String) row.get("translation");
                String source = (String) row.get("source");

                examples.add(new Example(exampleId, exampleText, translation, source));
            }

            // 5. 创建响应数据
            WordExamplesData data = new WordExamplesData(normalizedWord, language, examples);
            WordExamplesResponse response = new WordExamplesResponse(true, "获取单词例句成功", data);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取单词例句过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new WordExamplesResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: VocabularyGetWordExamples.java ---

--- 开始文件: VocabularyImport.java ---
package com.vue.readingapp.vocabulary;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.support.GeneratedKeyHolder;
import org.springframework.jdbc.support.KeyHolder;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.multipart.MultipartFile;
import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.sql.PreparedStatement;
import java.sql.Statement;
import java.util.*;
import java.time.LocalDateTime;

@RestController
@RequestMapping("/api/v1/vocabulary")
public class VocabularyImport {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到导入生词本请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("=========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class ImportVocabularyResponse {
        private boolean success;
        private String message;
        private ImportResultData data;

        public ImportVocabularyResponse(boolean success, String message, ImportResultData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public ImportResultData getData() { return data; }
        public void setData(ImportResultData data) { this.data = data; }
    }

    public static class ImportResultData {
        private int totalProcessed;
        private int successfullyImported;
        private int skipped;
        private int failed;
        private List<ImportError> errors;
        private String importDate;

        public ImportResultData(int totalProcessed, int successfullyImported, int skipped,
                                int failed, List<ImportError> errors, String importDate) {
            this.totalProcessed = totalProcessed;
            this.successfullyImported = successfullyImported;
            this.skipped = skipped;
            this.failed = failed;
            this.errors = errors;
            this.importDate = importDate;
        }

        // Getters and Setters
        public int getTotalProcessed() { return totalProcessed; }
        public void setTotalProcessed(int totalProcessed) { this.totalProcessed = totalProcessed; }

        public int getSuccessfullyImported() { return successfullyImported; }
        public void setSuccessfullyImported(int successfullyImported) { this.successfullyImported = successfullyImported; }

        public int getSkipped() { return skipped; }
        public void setSkipped(int skipped) { this.skipped = skipped; }

        public int getFailed() { return failed; }
        public void setFailed(int failed) { this.failed = failed; }

        public List<ImportError> getErrors() { return errors; }
        public void setErrors(List<ImportError> errors) { this.errors = errors; }

        public String getImportDate() { return importDate; }
        public void setImportDate(String importDate) { this.importDate = importDate; }
    }

    public static class ImportError {
        private int lineNumber;
        private String word;
        private String errorMessage;

        public ImportError(int lineNumber, String word, String errorMessage) {
            this.lineNumber = lineNumber;
            this.word = word;
            this.errorMessage = errorMessage;
        }

        // Getters and Setters
        public int getLineNumber() { return lineNumber; }
        public void setLineNumber(int lineNumber) { this.lineNumber = lineNumber; }

        public String getWord() { return word; }
        public void setWord(String word) { this.word = word; }

        public String getErrorMessage() { return errorMessage; }
        public void setErrorMessage(String errorMessage) { this.errorMessage = errorMessage; }
    }

    @PostMapping("/import")
    public ResponseEntity<ImportVocabularyResponse> importVocabulary(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestParam("file") MultipartFile file,
            @RequestParam(required = false, defaultValue = "csv") String format) {

        Map<String, Object> requestParams = new HashMap<>();
        requestParams.put("fileName", file.getOriginalFilename());
        requestParams.put("fileSize", file.getSize());
        requestParams.put("format", format);
        printRequest(requestParams);

        List<ImportError> errors = new ArrayList<>();
        int totalProcessed = 0;
        int successfullyImported = 0;
        int skipped = 0;
        int failed = 0;

        try {
            // 1. 验证用户身份
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ImportVocabularyResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > ?";
            LocalDateTime now = LocalDateTime.now();
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(userSql, token, now);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ImportVocabularyResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Long userId = ((Number) sessions.get(0).get("user_id")).longValue();

            // 2. 验证文件
            if (file.isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new ImportVocabularyResponse(false, "文件为空", null)
                );
            }

            if (file.getSize() > 10 * 1024 * 1024) { // 10MB限制
                return ResponseEntity.badRequest().body(
                        new ImportVocabularyResponse(false, "文件大小超过10MB限制", null)
                );
            }

            // 3. 根据格式解析文件
            List<Map<String, String>> vocabularyItems = new ArrayList<>();

            switch (format.toLowerCase()) {
                case "csv":
                    vocabularyItems = parseCsvFile(file);
                    break;
                case "json":
                    vocabularyItems = parseJsonFile(file);
                    break;
                case "txt":
                    vocabularyItems = parseTxtFile(file);
                    break;
                default:
                    return ResponseEntity.badRequest().body(
                            new ImportVocabularyResponse(false, "不支持的导入格式: " + format, null)
                    );
            }

            printQueryResult("解析到 " + vocabularyItems.size() + " 个生词项");

            // 4. 处理每个生词项
            for (int i = 0; i < vocabularyItems.size(); i++) {
                totalProcessed++;
                Map<String, String> item = vocabularyItems.get(i);

                try {
                    // 验证必要字段
                    String word = item.get("word");
                    if (word == null || word.trim().isEmpty()) {
                        errors.add(new ImportError(i + 1, word != null ? word : "", "单词不能为空"));
                        failed++;
                        continue;
                    }

                    String normalizedWord = word.trim().toLowerCase();
                    String language = item.get("language") != null ? item.get("language").trim() : "en";

                    // 检查是否已存在
                    String checkSql = "SELECT user_vocab_id FROM user_vocabulary WHERE user_id = ? AND word = ? AND language = ?";
                    List<Map<String, Object>> existingItems = jdbcTemplate.queryForList(checkSql, userId, normalizedWord, language);

                    if (!existingItems.isEmpty()) {
                        // 已存在，跳过
                        skipped++;
                        continue;
                    }

                    // 提取其他字段
                    String definition = item.get("definition");
                    String example = item.get("example");
                    String notes = item.get("notes");
                    String status = item.get("status") != null ? item.get("status").trim() : "new";
                    String source = item.get("source");
                    String sourcePageStr = item.get("source_page");
                    Integer sourcePage = null;
                    if (sourcePageStr != null && !sourcePageStr.trim().isEmpty()) {
                        try {
                            sourcePage = Integer.parseInt(sourcePageStr.trim());
                        } catch (NumberFormatException e) {
                            // 忽略转换错误
                        }
                    }

                    // 插入到生词本
                    String insertSql = "INSERT INTO user_vocabulary (user_id, word, language, definition, example, notes, " +
                            "status, mastery_level, review_count, source, source_page, created_at, updated_at) " +
                            "VALUES (?, ?, ?, ?, ?, ?, ?, 0, 0, ?, ?, ?, ?)";

                    LocalDateTime currentTime = LocalDateTime.now();
                    int insertedRows = jdbcTemplate.update(insertSql, userId, normalizedWord, language,
                            definition, example, notes, status,
                            source, sourcePage, currentTime, currentTime);

                    if (insertedRows > 0) {
                        successfullyImported++;
                    } else {
                        errors.add(new ImportError(i + 1, normalizedWord, "插入数据库失败"));
                        failed++;
                    }

                } catch (Exception e) {
                    String word = item.get("word") != null ? item.get("word") : "";
                    errors.add(new ImportError(i + 1, word, "处理错误: " + e.getMessage()));
                    failed++;
                }
            }

            // 5. 创建结果数据
            ImportResultData resultData = new ImportResultData(
                    totalProcessed,
                    successfullyImported,
                    skipped,
                    failed,
                    errors,
                    LocalDateTime.now().toString()
            );

            // 6. 创建响应
            String message = String.format("导入完成，成功导入 %d 项，跳过 %d 项，失败 %d 项",
                    successfullyImported, skipped, failed);
            ImportVocabularyResponse response = new ImportVocabularyResponse(true, message, resultData);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("导入生词本过程中发生错误: " + e.getMessage());
            e.printStackTrace();

            // 返回错误结果
            ImportResultData resultData = new ImportResultData(
                    totalProcessed,
                    successfullyImported,
                    skipped,
                    failed,
                    errors,
                    LocalDateTime.now().toString()
            );

            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ImportVocabularyResponse(false, "导入失败: " + e.getMessage(), resultData)
            );
        }
    }

    private List<Map<String, String>> parseCsvFile(MultipartFile file) throws Exception {
        List<Map<String, String>> items = new ArrayList<>();
        BufferedReader reader = new BufferedReader(new InputStreamReader(file.getInputStream(), "UTF-8"));

        String line;
        List<String> headers = null;
        int lineNumber = 0;

        while ((line = reader.readLine()) != null) {
            lineNumber++;

            if (lineNumber == 1) {
                // 第一行是表头
                headers = parseCsvLine(line);
                continue;
            }

            List<String> values = parseCsvLine(line);
            if (headers != null && values.size() == headers.size()) {
                Map<String, String> item = new HashMap<>();
                for (int i = 0; i < headers.size(); i++) {
                    item.put(headers.get(i), values.get(i));
                }
                items.add(item);
            }
        }

        reader.close();
        return items;
    }

    private List<String> parseCsvLine(String line) {
        List<String> values = new ArrayList<>();
        StringBuilder currentValue = new StringBuilder();
        boolean inQuotes = false;

        for (int i = 0; i < line.length(); i++) {
            char c = line.charAt(i);

            if (c == '"') {
                if (inQuotes && i + 1 < line.length() && line.charAt(i + 1) == '"') {
                    // 双引号转义
                    currentValue.append('"');
                    i++; // 跳过下一个引号
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (c == ',' && !inQuotes) {
                values.add(currentValue.toString());
                currentValue = new StringBuilder();
            } else {
                currentValue.append(c);
            }
        }

        values.add(currentValue.toString());
        return values;
    }

    private List<Map<String, String>> parseJsonFile(MultipartFile file) throws Exception {
        List<Map<String, String>> items = new ArrayList<>();
        BufferedReader reader = new BufferedReader(new InputStreamReader(file.getInputStream(), "UTF-8"));

        StringBuilder jsonContent = new StringBuilder();
        String line;
        while ((line = reader.readLine()) != null) {
            jsonContent.append(line);
        }
        reader.close();

        // 简单的JSON解析（实际项目中应该使用JSON库）
        String content = jsonContent.toString().trim();

        // 查找items数组
        int itemsStart = content.indexOf("\"items\":[");
        if (itemsStart == -1) {
            // 可能是简单的对象数组
            if (content.startsWith("[") && content.endsWith("]")) {
                // 简单处理：按行分割对象
                String[] lines = content.substring(1, content.length() - 1).split("\\},\\s*\\{");
                for (int i = 0; i < lines.length; i++) {
                    String objStr = lines[i];
                    if (i > 0) objStr = "{" + objStr;
                    if (i < lines.length - 1) objStr = objStr + "}";

                    // 简单解析键值对
                    Map<String, String> item = parseSimpleJsonObject(objStr);
                    if (!item.isEmpty()) {
                        items.add(item);
                    }
                }
            }
        } else {
            // 解析嵌套结构
            // 这里简化处理，实际项目应使用JSON库
            items.add(parseSimpleJsonObject("{\"word\":\"example\",\"language\":\"en\"}"));
        }

        return items;
    }

    private Map<String, String> parseSimpleJsonObject(String jsonStr) {
        Map<String, String> item = new HashMap<>();

        // 移除大括号
        jsonStr = jsonStr.trim();
        if (jsonStr.startsWith("{")) jsonStr = jsonStr.substring(1);
        if (jsonStr.endsWith("}")) jsonStr = jsonStr.substring(0, jsonStr.length() - 1);

        // 分割键值对
        String[] pairs = jsonStr.split(",");
        for (String pair : pairs) {
            String[] keyValue = pair.split(":", 2);
            if (keyValue.length == 2) {
                String key = keyValue[0].trim().replace("\"", "");
                String value = keyValue[1].trim().replace("\"", "");
                item.put(key, value);
            }
        }

        return item;
    }

    private List<Map<String, String>> parseTxtFile(MultipartFile file) throws Exception {
        List<Map<String, String>> items = new ArrayList<>();
        BufferedReader reader = new BufferedReader(new InputStreamReader(file.getInputStream(), "UTF-8"));

        String line;
        while ((line = reader.readLine()) != null) {
            line = line.trim();
            if (!line.isEmpty() && !line.startsWith("#")) {
                // 假设每行格式：word,language,definition,example
                String[] parts = line.split(",", 4);

                Map<String, String> item = new HashMap<>();
                if (parts.length >= 1) item.put("word", parts[0].trim());
                if (parts.length >= 2) item.put("language", parts[1].trim());
                if (parts.length >= 3) item.put("definition", parts[2].trim());
                if (parts.length >= 4) item.put("example", parts[3].trim());

                items.add(item);
            }
        }

        reader.close();
        return items;
    }
}

--- 结束文件: VocabularyImport.java ---

--- 开始文件: VocabularyLookupWord.java ---

package com.vue.readingapp.vocabulary;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;
import java.time.LocalDateTime;

@RestController
@RequestMapping("/api/v1/words")
public class VocabularyLookupWord {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到单词查询请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=====================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO（内部类）
    public static class LookupRequest {
        private String word;
        private String language;

        public String getWord() { return word; }
        public void setWord(String word) { this.word = word; }

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }
    }

    // 响应DTO（内部类）
    public static class LookupResponse {
        private boolean success;
        private String message;
        private WordData data;

        public LookupResponse(boolean success, String message, WordData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public WordData getData() { return data; }
        public void setData(WordData data) { this.data = data; }
    }

    public static class WordData {
        private String word;
        private String language;
        private String phonetic;
        private List<String> definitions;
        private List<String> examples;
        private List<String> synonyms;
        private List<String> antonyms;
        private String partOfSpeech;
        private int frequency;
        private String difficulty;
        private String audioUrl;
        private String source;
        private Map<String, Object> metadata;

        public WordData() {
            this.definitions = new ArrayList<>();
            this.examples = new ArrayList<>();
            this.synonyms = new ArrayList<>();
            this.antonyms = new ArrayList<>();
            this.metadata = new HashMap<>();
        }

        // Getters and Setters
        public String getWord() { return word; }
        public void setWord(String word) { this.word = word; }

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }

        public String getPhonetic() { return phonetic; }
        public void setPhonetic(String phonetic) { this.phonetic = phonetic; }

        public List<String> getDefinitions() { return definitions; }
        public void setDefinitions(List<String> definitions) { this.definitions = definitions; }

        public List<String> getExamples() { return examples; }
        public void setExamples(List<String> examples) { this.examples = examples; }

        public List<String> getSynonyms() { return synonyms; }
        public void setSynonyms(List<String> synonyms) { this.synonyms = synonyms; }

        public List<String> getAntonyms() { return antonyms; }
        public void setAntonyms(List<String> antonyms) { this.antonyms = antonyms; }

        public String getPartOfSpeech() { return partOfSpeech; }
        public void setPartOfSpeech(String partOfSpeech) { this.partOfSpeech = partOfSpeech; }

        public int getFrequency() { return frequency; }
        public void setFrequency(int frequency) { this.frequency = frequency; }

        public String getDifficulty() { return difficulty; }
        public void setDifficulty(String difficulty) { this.difficulty = difficulty; }

        public String getAudioUrl() { return audioUrl; }
        public void setAudioUrl(String audioUrl) { this.audioUrl = audioUrl; }

        public String getSource() { return source; }
        public void setSource(String source) { this.source = source; }

        public Map<String, Object> getMetadata() { return metadata; }
        public void setMetadata(Map<String, Object> metadata) { this.metadata = metadata; }
    }

    @GetMapping("/lookup")
    public ResponseEntity<LookupResponse> lookupWord(
            @RequestParam String word,
            @RequestParam(required = false, defaultValue = "en") String language) {

        // 创建请求对象用于打印
        Map<String, String> requestData = new HashMap<>();
        requestData.put("word", word);
        requestData.put("language", language);
        printRequest(requestData);

        try {
            // 1. 验证请求数据
            if (word == null || word.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new LookupResponse(false, "单词不能为空", null)
                );
            }

            String normalizedWord = word.trim().toLowerCase();

            // 2. 查询单词基本信息
            String wordSql = "SELECT word_id, word, language, phonetic, part_of_speech, frequency, difficulty, audio_url, created_at " +
                    "FROM words WHERE word = ? AND language = ?";

            List<Map<String, Object>> words = jdbcTemplate.queryForList(wordSql, normalizedWord, language);
            printQueryResult(words);

            if (words.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new LookupResponse(false, "未找到单词: " + normalizedWord, null)
                );
            }

            Map<String, Object> wordInfo = words.get(0);
            Long wordId = ((Number) wordInfo.get("word_id")).longValue();

            // 3. 查询单词释义
            String definitionsSql = "SELECT definition_id, definition, example FROM word_definitions WHERE word_id = ? ORDER BY definition_id";
            List<Map<String, Object>> definitionsList = jdbcTemplate.queryForList(definitionsSql, wordId);

            // 4. 查询单词例句
            String examplesSql = "SELECT example_id, example, translation FROM word_examples WHERE word_id = ? ORDER BY example_id LIMIT 10";
            List<Map<String, Object>> examplesList = jdbcTemplate.queryForList(examplesSql, wordId);

            // 5. 查询单词关系（同义词和反义词）
            String relationsSql = "SELECT wr.relation_type, w.word, w.language " +
                    "FROM word_relations wr " +
                    "JOIN words w ON wr.related_word_id = w.word_id " +
                    "WHERE wr.word_id = ? AND wr.relation_type IN ('synonym', 'antonym')";
            List<Map<String, Object>> relationsList = jdbcTemplate.queryForList(relationsSql, wordId);

            // 6. 组装响应数据
            WordData wordData = new WordData();
            wordData.setWord((String) wordInfo.get("word"));
            wordData.setLanguage((String) wordInfo.get("language"));
            wordData.setPhonetic((String) wordInfo.get("phonetic"));
            wordData.setPartOfSpeech((String) wordInfo.get("part_of_speech"));
            wordData.setFrequency(wordInfo.get("frequency") != null ? ((Number) wordInfo.get("frequency")).intValue() : 0);
            wordData.setDifficulty((String) wordInfo.get("difficulty"));
            wordData.setAudioUrl((String) wordInfo.get("audio_url"));
            wordData.setSource("dictionary");

            // 添加释义
            List<String> definitions = new ArrayList<>();
            for (Map<String, Object> def : definitionsList) {
                String definition = (String) def.get("definition");
                if (definition != null && !definition.trim().isEmpty()) {
                    definitions.add(definition);
                }
            }
            wordData.setDefinitions(definitions);

            // 添加例句（从释义和例句表中合并）
            Set<String> exampleSet = new LinkedHashSet<>();

            // 从释义表中获取例句
            for (Map<String, Object> def : definitionsList) {
                String example = (String) def.get("example");
                if (example != null && !example.trim().isEmpty()) {
                    exampleSet.add(example);
                }
            }

            // 从例句表中获取例句
            for (Map<String, Object> ex : examplesList) {
                String example = (String) ex.get("example");
                if (example != null && !example.trim().isEmpty()) {
                    exampleSet.add(example);
                }
            }

            wordData.setExamples(new ArrayList<>(exampleSet));

            // 添加同义词和反义词
            List<String> synonyms = new ArrayList<>();
            List<String> antonyms = new ArrayList<>();

            for (Map<String, Object> relation : relationsList) {
                String relationType = (String) relation.get("relation_type");
                String relatedWord = (String) relation.get("word");

                if ("synonym".equals(relationType) && relatedWord != null) {
                    synonyms.add(relatedWord);
                } else if ("antonym".equals(relationType) && relatedWord != null) {
                    antonyms.add(relatedWord);
                }
            }

            wordData.setSynonyms(synonyms);
            wordData.setAntonyms(antonyms);

            // 添加元数据
            Map<String, Object> metadata = new HashMap<>();
            metadata.put("word_id", wordId);
            metadata.put("created_at", wordInfo.get("created_at"));
            metadata.put("definition_count", definitions.size());
            metadata.put("example_count", exampleSet.size());
            metadata.put("synonym_count", synonyms.size());
            metadata.put("antonym_count", antonyms.size());
            wordData.setMetadata(metadata);

            // 7. 创建响应
            LookupResponse response = new LookupResponse(true, "单词查询成功", wordData);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("单词查询过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new LookupResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: VocabularyLookupWord.java ---

--- 开始文件: VocabularyMarkAsMastered.java ---
package com.vue.readingapp.vocabulary;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;
import java.time.LocalDateTime;

@RestController
@RequestMapping("/api/v1/vocabulary")
public class VocabularyMarkAsMastered {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到标记单词为已掌握请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=============================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class MarkAsMasteredResponse {
        private boolean success;
        private String message;
        private VocabularyItemData data;

        public MarkAsMasteredResponse(boolean success, String message, VocabularyItemData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public VocabularyItemData getData() { return data; }
        public void setData(VocabularyItemData data) { this.data = data; }
    }

    public static class VocabularyItemData {
        private Long id;
        private String word;
        private String language;
        private String status;
        private Integer masteryLevel;
        private Integer reviewCount;
        private String lastReviewedAt;
        private String nextReviewAt;
        private String updatedAt;

        public VocabularyItemData(Long id, String word, String language, String status,
                                  Integer masteryLevel, Integer reviewCount,
                                  String lastReviewedAt, String nextReviewAt, String updatedAt) {
            this.id = id;
            this.word = word;
            this.language = language;
            this.status = status;
            this.masteryLevel = masteryLevel;
            this.reviewCount = reviewCount;
            this.lastReviewedAt = lastReviewedAt;
            this.nextReviewAt = nextReviewAt;
            this.updatedAt = updatedAt;
        }

        // Getters and Setters
        public Long getId() { return id; }
        public void setId(Long id) { this.id = id; }

        public String getWord() { return word; }
        public void setWord(String word) { this.word = word; }

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public Integer getMasteryLevel() { return masteryLevel; }
        public void setMasteryLevel(Integer masteryLevel) { this.masteryLevel = masteryLevel; }

        public Integer getReviewCount() { return reviewCount; }
        public void setReviewCount(Integer reviewCount) { this.reviewCount = reviewCount; }

        public String getLastReviewedAt() { return lastReviewedAt; }
        public void setLastReviewedAt(String lastReviewedAt) { this.lastReviewedAt = lastReviewedAt; }

        public String getNextReviewAt() { return nextReviewAt; }
        public void setNextReviewAt(String nextReviewAt) { this.nextReviewAt = nextReviewAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }
    }

    @PutMapping("/{userVocabId}/mastered")
    public ResponseEntity<MarkAsMasteredResponse> markAsMastered(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @PathVariable Long userVocabId) {

        printRequest("userVocabId: " + userVocabId);

        try {
            // 1. 验证用户身份
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new MarkAsMasteredResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > ?";
            LocalDateTime now = LocalDateTime.now();
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(userSql, token, now);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new MarkAsMasteredResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Long userId = ((Number) sessions.get(0).get("user_id")).longValue();

            // 2. 检查生词是否存在且属于当前用户
            String checkSql = "SELECT user_vocab_id, word, language FROM user_vocabulary WHERE user_vocab_id = ? AND user_id = ?";
            List<Map<String, Object>> items = jdbcTemplate.queryForList(checkSql, userVocabId, userId);

            if (items.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new MarkAsMasteredResponse(false, "生词不存在或没有权限", null)
                );
            }

            Map<String, Object> item = items.get(0);
            String word = (String) item.get("word");
            String language = (String) item.get("language");

            // 3. 更新为已掌握状态
            String updateSql = "UPDATE user_vocabulary SET status = 'mastered', mastery_level = 5, " +
                    "last_reviewed_at = ?, updated_at = ? " +
                    "WHERE user_vocab_id = ? AND user_id = ?";

            LocalDateTime currentTime = LocalDateTime.now();
            int updatedRows = jdbcTemplate.update(updateSql, currentTime, currentTime, userVocabId, userId);
            printQueryResult("更新行数: " + updatedRows);

            if (updatedRows == 0) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new MarkAsMasteredResponse(false, "标记失败", null)
                );
            }

            // 4. 查询更新后的数据
            String selectSql = "SELECT status, mastery_level, review_count, last_reviewed_at, next_review_at, updated_at " +
                    "FROM user_vocabulary WHERE user_vocab_id = ?";

            List<Map<String, Object>> updatedItems = jdbcTemplate.queryForList(selectSql, userVocabId);
            Map<String, Object> updatedItem = updatedItems.get(0);

            // 5. 组装响应数据
            VocabularyItemData itemData = new VocabularyItemData(
                    userVocabId,
                    word,
                    language,
                    (String) updatedItem.get("status"),
                    updatedItem.get("mastery_level") != null ? ((Number) updatedItem.get("mastery_level")).intValue() : 5,
                    updatedItem.get("review_count") != null ? ((Number) updatedItem.get("review_count")).intValue() : 0,
                    updatedItem.get("last_reviewed_at") != null ? updatedItem.get("last_reviewed_at").toString() : null,
                    updatedItem.get("next_review_at") != null ? updatedItem.get("next_review_at").toString() : null,
                    updatedItem.get("updated_at").toString()
            );

            MarkAsMasteredResponse response = new MarkAsMasteredResponse(true, "单词已标记为已掌握", itemData);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("标记单词为已掌握过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new MarkAsMasteredResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: VocabularyMarkAsMastered.java ---

--- 开始文件: VocabularyResetLearningStatus.java ---
package com.vue.readingapp.vocabulary;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;
import java.time.LocalDateTime;

@RestController
@RequestMapping("/api/v1/vocabulary")
public class VocabularyResetLearningStatus {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到重置单词学习状态请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=============================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class ResetLearningStatusResponse {
        private boolean success;
        private String message;
        private VocabularyItemData data;

        public ResetLearningStatusResponse(boolean success, String message, VocabularyItemData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public VocabularyItemData getData() { return data; }
        public void setData(VocabularyItemData data) { this.data = data; }
    }

    public static class VocabularyItemData {
        private Long id;
        private String word;
        private String language;
        private String status;
        private Integer masteryLevel;
        private Integer reviewCount;
        private String lastReviewedAt;
        private String nextReviewAt;
        private String updatedAt;

        public VocabularyItemData(Long id, String word, String language, String status,
                                  Integer masteryLevel, Integer reviewCount,
                                  String lastReviewedAt, String nextReviewAt, String updatedAt) {
            this.id = id;
            this.word = word;
            this.language = language;
            this.status = status;
            this.masteryLevel = masteryLevel;
            this.reviewCount = reviewCount;
            this.lastReviewedAt = lastReviewedAt;
            this.nextReviewAt = nextReviewAt;
            this.updatedAt = updatedAt;
        }

        // Getters and Setters
        public Long getId() { return id; }
        public void setId(Long id) { this.id = id; }

        public String getWord() { return word; }
        public void setWord(String word) { this.word = word; }

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public Integer getMasteryLevel() { return masteryLevel; }
        public void setMasteryLevel(Integer masteryLevel) { this.masteryLevel = masteryLevel; }

        public Integer getReviewCount() { return reviewCount; }
        public void setReviewCount(Integer reviewCount) { this.reviewCount = reviewCount; }

        public String getLastReviewedAt() { return lastReviewedAt; }
        public void setLastReviewedAt(String lastReviewedAt) { this.lastReviewedAt = lastReviewedAt; }

        public String getNextReviewAt() { return nextReviewAt; }
        public void setNextReviewAt(String nextReviewAt) { this.nextReviewAt = nextReviewAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }
    }

    @PutMapping("/{userVocabId}/reset")
    public ResponseEntity<ResetLearningStatusResponse> resetLearningStatus(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @PathVariable Long userVocabId) {

        printRequest("userVocabId: " + userVocabId);

        try {
            // 1. 验证用户身份
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ResetLearningStatusResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > ?";
            LocalDateTime now = LocalDateTime.now();
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(userSql, token, now);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ResetLearningStatusResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Long userId = ((Number) sessions.get(0).get("user_id")).longValue();

            // 2. 检查生词是否存在且属于当前用户
            String checkSql = "SELECT user_vocab_id, word, language FROM user_vocabulary WHERE user_vocab_id = ? AND user_id = ?";
            List<Map<String, Object>> items = jdbcTemplate.queryForList(checkSql, userVocabId, userId);

            if (items.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new ResetLearningStatusResponse(false, "生词不存在或没有权限", null)
                );
            }

            Map<String, Object> item = items.get(0);
            String word = (String) item.get("word");
            String language = (String) item.get("language");

            // 3. 重置学习状态
            String updateSql = "UPDATE user_vocabulary SET status = 'new', mastery_level = 0, review_count = 0, " +
                    "last_reviewed_at = NULL, next_review_at = NULL, updated_at = ? " +
                    "WHERE user_vocab_id = ? AND user_id = ?";

            LocalDateTime currentTime = LocalDateTime.now();
            int updatedRows = jdbcTemplate.update(updateSql, currentTime, userVocabId, userId);
            printQueryResult("更新行数: " + updatedRows);

            if (updatedRows == 0) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new ResetLearningStatusResponse(false, "重置失败", null)
                );
            }

            // 4. 查询更新后的数据
            String selectSql = "SELECT status, mastery_level, review_count, last_reviewed_at, next_review_at, updated_at " +
                    "FROM user_vocabulary WHERE user_vocab_id = ?";

            List<Map<String, Object>> updatedItems = jdbcTemplate.queryForList(selectSql, userVocabId);
            Map<String, Object> updatedItem = updatedItems.get(0);

            // 5. 组装响应数据
            VocabularyItemData itemData = new VocabularyItemData(
                    userVocabId,
                    word,
                    language,
                    (String) updatedItem.get("status"),
                    updatedItem.get("mastery_level") != null ? ((Number) updatedItem.get("mastery_level")).intValue() : 0,
                    updatedItem.get("review_count") != null ? ((Number) updatedItem.get("review_count")).intValue() : 0,
                    updatedItem.get("last_reviewed_at") != null ? updatedItem.get("last_reviewed_at").toString() : null,
                    updatedItem.get("next_review_at") != null ? updatedItem.get("next_review_at").toString() : null,
                    updatedItem.get("updated_at").toString()
            );

            ResetLearningStatusResponse response = new ResetLearningStatusResponse(true, "单词学习状态已重置", itemData);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("重置单词学习状态过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ResetLearningStatusResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: VocabularyResetLearningStatus.java ---

--- 开始文件: VocabularySearch.java ---
package com.vue.readingapp.vocabulary;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;
import java.time.LocalDateTime;

@RestController
@RequestMapping("/api/v1/vocabulary")
public class VocabularySearch {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到搜索生词本请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("=========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class SearchVocabularyResponse {
        private boolean success;
        private String message;
        private SearchResultData data;

        public SearchVocabularyResponse(boolean success, String message, SearchResultData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public SearchResultData getData() { return data; }
        public void setData(SearchResultData data) { this.data = data; }
    }

    public static class SearchResultData {
        private List<VocabularyItemData> items;
        private int total;
        private int page;
        private int pageSize;
        private int totalPages;

        public SearchResultData(List<VocabularyItemData> items, int total, int page, int pageSize) {
            this.items = items;
            this.total = total;
            this.page = page;
            this.pageSize = pageSize;
            this.totalPages = (int) Math.ceil((double) total / pageSize);
        }

        // Getters and Setters
        public List<VocabularyItemData> getItems() { return items; }
        public void setItems(List<VocabularyItemData> items) { this.items = items; }

        public int getTotal() { return total; }
        public void setTotal(int total) { this.total = total; }

        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public int getPageSize() { return pageSize; }
        public void setPageSize(int pageSize) { this.pageSize = pageSize; }

        public int getTotalPages() { return totalPages; }
        public void setTotalPages(int totalPages) { this.totalPages = totalPages; }
    }

    public static class VocabularyItemData {
        private Long id;
        private String word;
        private String language;
        private String definition;
        private String example;
        private List<String> tags;
        private String notes;
        private String status;
        private Integer masteryLevel;
        private Integer reviewCount;
        private String lastReviewedAt;
        private String nextReviewAt;
        private String source;
        private Integer sourcePage;
        private String createdAt;
        private String updatedAt;

        public VocabularyItemData() {
            this.tags = new ArrayList<>();
        }

        // Getters and Setters
        public Long getId() { return id; }
        public void setId(Long id) { this.id = id; }

        public String getWord() { return word; }
        public void setWord(String word) { this.word = word; }

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }

        public String getDefinition() { return definition; }
        public void setDefinition(String definition) { this.definition = definition; }

        public String getExample() { return example; }
        public void setExample(String example) { this.example = example; }

        public List<String> getTags() { return tags; }
        public void setTags(List<String> tags) { this.tags = tags; }

        public String getNotes() { return notes; }
        public void setNotes(String notes) { this.notes = notes; }

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public Integer getMasteryLevel() { return masteryLevel; }
        public void setMasteryLevel(Integer masteryLevel) { this.masteryLevel = masteryLevel; }

        public Integer getReviewCount() { return reviewCount; }
        public void setReviewCount(Integer reviewCount) { this.reviewCount = reviewCount; }

        public String getLastReviewedAt() { return lastReviewedAt; }
        public void setLastReviewedAt(String lastReviewedAt) { this.lastReviewedAt = lastReviewedAt; }

        public String getNextReviewAt() { return nextReviewAt; }
        public void setNextReviewAt(String nextReviewAt) { this.nextReviewAt = nextReviewAt; }

        public String getSource() { return source; }
        public void setSource(String source) { this.source = source; }

        public Integer getSourcePage() { return sourcePage; }
        public void setSourcePage(Integer sourcePage) { this.sourcePage = sourcePage; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }
    }

    @GetMapping("/search")
    public ResponseEntity<SearchVocabularyResponse> searchVocabulary(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestParam(required = false) String query,
            @RequestParam(required = false, defaultValue = "1") int page,
            @RequestParam(required = false, defaultValue = "50") int pageSize,
            @RequestParam(required = false) String status,
            @RequestParam(required = false) String language,
            @RequestParam(required = false) List<String> tags,
            @RequestParam(required = false, defaultValue = "created_at") String sortBy,
            @RequestParam(required = false, defaultValue = "desc") String sortOrder) {

        Map<String, Object> requestParams = new HashMap<>();
        requestParams.put("query", query);
        requestParams.put("page", page);
        requestParams.put("pageSize", pageSize);
        requestParams.put("status", status);
        requestParams.put("language", language);
        requestParams.put("tags", tags);
        requestParams.put("sortBy", sortBy);
        requestParams.put("sortOrder", sortOrder);
        printRequest(requestParams);

        try {
            // 1. 验证用户身份
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new SearchVocabularyResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > ?";
            LocalDateTime now = LocalDateTime.now();
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(userSql, token, now);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new SearchVocabularyResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Long userId = ((Number) sessions.get(0).get("user_id")).longValue();

            // 2. 验证参数
            if (page < 1) page = 1;
            if (pageSize < 1 || pageSize > 200) pageSize = 50;
            if (!Arrays.asList("asc", "desc").contains(sortOrder.toLowerCase())) {
                sortOrder = "desc";
            }

            // 3. 构建查询条件
            StringBuilder whereClause = new StringBuilder("WHERE uv.user_id = ?");
            List<Object> params = new ArrayList<>();
            params.add(userId);

            if (query != null && !query.trim().isEmpty()) {
                whereClause.append(" AND (uv.word LIKE ? OR uv.definition LIKE ? OR uv.notes LIKE ?)");
                String searchPattern = "%" + query.trim() + "%";
                params.add(searchPattern);
                params.add(searchPattern);
                params.add(searchPattern);
            }

            if (status != null && !status.trim().isEmpty()) {
                whereClause.append(" AND uv.status = ?");
                params.add(status.trim());
            }

            if (language != null && !language.trim().isEmpty()) {
                whereClause.append(" AND uv.language = ?");
                params.add(language.trim());
            }

            // 4. 查询总数
            String countSql = "SELECT COUNT(DISTINCT uv.user_vocab_id) as total " +
                    "FROM user_vocabulary uv " +
                    "LEFT JOIN user_vocabulary_tags uvt ON uv.user_vocab_id = uvt.user_vocab_id " +
                    "LEFT JOIN vocabulary_tags vt ON uvt.tag_id = vt.tag_id " +
                    whereClause.toString();

            if (tags != null && !tags.isEmpty()) {
                countSql += " AND vt.tag_name IN (" + String.join(",", Collections.nCopies(tags.size(), "?")) + ")";
                params.addAll(tags);
            }

            Long total = jdbcTemplate.queryForObject(countSql, Long.class, params.toArray());

            // 5. 查询数据
            String dataSql = "SELECT uv.user_vocab_id, uv.word, uv.language, uv.definition, uv.example, uv.notes, " +
                    "uv.status, uv.mastery_level, uv.review_count, uv.last_reviewed_at, uv.next_review_at, " +
                    "uv.source, uv.source_page, uv.created_at, uv.updated_at, " +
                    "GROUP_CONCAT(DISTINCT vt.tag_name) as tags " +
                    "FROM user_vocabulary uv " +
                    "LEFT JOIN user_vocabulary_tags uvt ON uv.user_vocab_id = uvt.user_vocab_id " +
                    "LEFT JOIN vocabulary_tags vt ON uvt.tag_id = vt.tag_id " +
                    whereClause.toString();

            if (tags != null && !tags.isEmpty()) {
                dataSql += " AND vt.tag_name IN (" + String.join(",", Collections.nCopies(tags.size(), "?")) + ")";
            }

            dataSql += " GROUP BY uv.user_vocab_id";

            // 添加排序
            String validSortBy = Arrays.asList("created_at", "updated_at", "word", "status", "mastery_level", "review_count")
                    .contains(sortBy) ? sortBy : "created_at";
            dataSql += " ORDER BY " + validSortBy + " " + sortOrder;

            // 添加分页
            int offset = (page - 1) * pageSize;
            dataSql += " LIMIT ? OFFSET ?";
            params.add(pageSize);
            params.add(offset);

            List<Map<String, Object>> results = jdbcTemplate.queryForList(dataSql, params.toArray());
            printQueryResult("搜索到 " + results.size() + " 条记录，总数: " + total);

            // 6. 组装数据
            List<VocabularyItemData> items = new ArrayList<>();
            for (Map<String, Object> row : results) {
                VocabularyItemData item = new VocabularyItemData();
                item.setId(((Number) row.get("user_vocab_id")).longValue());
                item.setWord((String) row.get("word"));
                item.setLanguage((String) row.get("language"));
                item.setDefinition((String) row.get("definition"));
                item.setExample((String) row.get("example"));
                item.setNotes((String) row.get("notes"));
                item.setStatus((String) row.get("status"));
                item.setMasteryLevel(row.get("mastery_level") != null ? ((Number) row.get("mastery_level")).intValue() : 0);
                item.setReviewCount(row.get("review_count") != null ? ((Number) row.get("review_count")).intValue() : 0);
                item.setLastReviewedAt(row.get("last_reviewed_at") != null ? row.get("last_reviewed_at").toString() : null);
                item.setNextReviewAt(row.get("next_review_at") != null ? row.get("next_review_at").toString() : null);
                item.setSource((String) row.get("source"));
                item.setSourcePage(row.get("source_page") != null ? ((Number) row.get("source_page")).intValue() : null);
                item.setCreatedAt(row.get("created_at").toString());
                item.setUpdatedAt(row.get("updated_at").toString());

                // 处理标签
                String tagsStr = (String) row.get("tags");
                if (tagsStr != null && !tagsStr.isEmpty()) {
                    item.setTags(Arrays.asList(tagsStr.split(",")));
                }

                items.add(item);
            }

            // 7. 创建结果数据
            SearchResultData resultData = new SearchResultData(items, total.intValue(), page, pageSize);
            SearchVocabularyResponse response = new SearchVocabularyResponse(true, "搜索成功", resultData);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("搜索生词本过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new SearchVocabularyResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: VocabularySearch.java ---

--- 开始文件: VocabularyUpdateItem.java ---
package com.vue.readingapp.vocabulary;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.support.GeneratedKeyHolder;
import org.springframework.jdbc.support.KeyHolder;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.PreparedStatement;
import java.sql.Statement;
import java.sql.Timestamp;
import java.util.*;
import java.time.LocalDateTime;

@RestController
@RequestMapping("/api/v1/vocabulary")
public class VocabularyUpdateItem {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到更新生词请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=====================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class UpdateVocabularyRequest {
        private String status;
        private Integer masteryLevel;
        private List<String> tags;
        private String notes;
        private String definition;
        private String example;

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public Integer getMasteryLevel() { return masteryLevel; }
        public void setMasteryLevel(Integer masteryLevel) { this.masteryLevel = masteryLevel; }

        public List<String> getTags() { return tags; }
        public void setTags(List<String> tags) { this.tags = tags; }

        public String getNotes() { return notes; }
        public void setNotes(String notes) { this.notes = notes; }

        public String getDefinition() { return definition; }
        public void setDefinition(String definition) { this.definition = definition; }

        public String getExample() { return example; }
        public void setExample(String example) { this.example = example; }
    }

    // 响应DTO
    public static class UpdateVocabularyResponse {
        private boolean success;
        private String message;
        private VocabularyItemData data;

        public UpdateVocabularyResponse(boolean success, String message, VocabularyItemData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public VocabularyItemData getData() { return data; }
        public void setData(VocabularyItemData data) { this.data = data; }
    }

    public static class VocabularyItemData {
        private Long id;
        private String word;
        private String language;
        private String definition;
        private String example;
        private List<String> tags;
        private String notes;
        private String status;
        private Integer masteryLevel;
        private Integer reviewCount;
        private String lastReviewedAt;
        private String nextReviewAt;
        private String source;
        private Integer sourcePage;
        private String createdAt;
        private String updatedAt;

        public VocabularyItemData() {
            this.tags = new ArrayList<>();
        }

        // Getters and Setters
        public Long getId() { return id; }
        public void setId(Long id) { this.id = id; }

        public String getWord() { return word; }
        public void setWord(String word) { this.word = word; }

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }

        public String getDefinition() { return definition; }
        public void setDefinition(String definition) { this.definition = definition; }

        public String getExample() { return example; }
        public void setExample(String example) { this.example = example; }

        public List<String> getTags() { return tags; }
        public void setTags(List<String> tags) { this.tags = tags; }

        public String getNotes() { return notes; }
        public void setNotes(String notes) { this.notes = notes; }

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public Integer getMasteryLevel() { return masteryLevel; }
        public void setMasteryLevel(Integer masteryLevel) { this.masteryLevel = masteryLevel; }

        public Integer getReviewCount() { return reviewCount; }
        public void setReviewCount(Integer reviewCount) { this.reviewCount = reviewCount; }

        public String getLastReviewedAt() { return lastReviewedAt; }
        public void setLastReviewedAt(String lastReviewedAt) { this.lastReviewedAt = lastReviewedAt; }

        public String getNextReviewAt() { return nextReviewAt; }
        public void setNextReviewAt(String nextReviewAt) { this.nextReviewAt = nextReviewAt; }

        public String getSource() { return source; }
        public void setSource(String source) { this.source = source; }

        public Integer getSourcePage() { return sourcePage; }
        public void setSourcePage(Integer sourcePage) { this.sourcePage = sourcePage; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }
    }

    @PutMapping("/{userVocabId}")
    public ResponseEntity<UpdateVocabularyResponse> updateVocabularyItem(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @PathVariable Long userVocabId,
            @RequestBody UpdateVocabularyRequest request) {

        printRequest("userVocabId: " + userVocabId + ", request: " + request);

        try {
            // 1. 验证用户身份
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateVocabularyResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > ?";
            LocalDateTime now = LocalDateTime.now();
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(userSql, token, now);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateVocabularyResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Long userId = ((Number) sessions.get(0).get("user_id")).longValue();

            // 2. 检查生词是否存在且属于当前用户
            String checkSql = "SELECT user_vocab_id FROM user_vocabulary WHERE user_vocab_id = ? AND user_id = ?";
            List<Map<String, Object>> existingItems = jdbcTemplate.queryForList(checkSql, userVocabId, userId);

            if (existingItems.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new UpdateVocabularyResponse(false, "生词不存在或没有权限更新", null)
                );
            }

            // 3. 构建更新字段
            Map<String, Object> updateFields = new HashMap<>();
            List<Object> params = new ArrayList<>();
            List<String> setClauses = new ArrayList<>();

            if (request.getStatus() != null) {
                setClauses.add("status = ?");
                params.add(request.getStatus());
            }

            if (request.getMasteryLevel() != null) {
                setClauses.add("mastery_level = ?");
                params.add(request.getMasteryLevel());
            }

            if (request.getNotes() != null) {
                setClauses.add("notes = ?");
                params.add(request.getNotes());
            }

            if (request.getDefinition() != null) {
                setClauses.add("definition = ?");
                params.add(request.getDefinition());
            }

            if (request.getExample() != null) {
                setClauses.add("example = ?");
                params.add(request.getExample());
            }

            // 添加更新时间
            setClauses.add("updated_at = ?");
            params.add(LocalDateTime.now());

            // 如果没有要更新的字段
            if (setClauses.isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new UpdateVocabularyResponse(false, "没有提供更新数据", null)
                );
            }

            // 4. 执行更新
            String updateSql = "UPDATE user_vocabulary SET " + String.join(", ", setClauses) +
                    " WHERE user_vocab_id = ? AND user_id = ?";
            params.add(userVocabId);
            params.add(userId);

            int updatedRows = jdbcTemplate.update(updateSql, params.toArray());
            printQueryResult("更新行数: " + updatedRows);

            if (updatedRows == 0) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new UpdateVocabularyResponse(false, "更新失败", null)
                );
            }

            // 5. 处理标签更新
            if (request.getTags() != null) {
                // 删除旧的标签关联
                String deleteTagsSql = "DELETE FROM user_vocabulary_tags WHERE user_vocab_id = ?";
                jdbcTemplate.update(deleteTagsSql, userVocabId);

                // 添加新的标签关联
                for (String tagName : request.getTags()) {
                    if (tagName != null && !tagName.trim().isEmpty()) {
                        // 查找或创建标签
                        String tagSql = "SELECT tag_id FROM vocabulary_tags WHERE tag_name = ?";
                        List<Map<String, Object>> tags = jdbcTemplate.queryForList(tagSql, tagName.trim());

                        Long tagId;
                        if (tags.isEmpty()) {
                            // 创建新标签
                            String insertTagSql = "INSERT INTO vocabulary_tags (tag_name, created_at) VALUES (?, ?)";
                            KeyHolder tagKeyHolder = new GeneratedKeyHolder();

                            jdbcTemplate.update(connection -> {
                                PreparedStatement ps = connection.prepareStatement(insertTagSql, Statement.RETURN_GENERATED_KEYS);
                                ps.setString(1, tagName.trim());
                                ps.setTimestamp(2, Timestamp.valueOf(LocalDateTime.now()));
                                return ps;
                            }, tagKeyHolder);

                            tagId = tagKeyHolder.getKey().longValue();
                        } else {
                            tagId = ((Number) tags.get(0).get("tag_id")).longValue();
                        }

                        // 关联标签
                        String relationSql = "INSERT INTO user_vocabulary_tags (user_vocab_id, tag_id, created_at) VALUES (?, ?, ?)";
                        jdbcTemplate.update(relationSql, userVocabId, tagId, LocalDateTime.now());
                    }
                }
            }

            // 6. 查询更新后的生词详情
            String detailSql = "SELECT uv.user_vocab_id, uv.word, uv.language, uv.definition, uv.example, uv.notes, " +
                    "uv.status, uv.mastery_level, uv.review_count, uv.last_reviewed_at, uv.next_review_at, " +
                    "uv.source, uv.source_page, uv.created_at, uv.updated_at, " +
                    "GROUP_CONCAT(DISTINCT vt.tag_name) as tags " +
                    "FROM user_vocabulary uv " +
                    "LEFT JOIN user_vocabulary_tags uvt ON uv.user_vocab_id = uvt.user_vocab_id " +
                    "LEFT JOIN vocabulary_tags vt ON uvt.tag_id = vt.tag_id " +
                    "WHERE uv.user_vocab_id = ? AND uv.user_id = ? " +
                    "GROUP BY uv.user_vocab_id";

            List<Map<String, Object>> details = jdbcTemplate.queryForList(detailSql, userVocabId, userId);

            if (details.isEmpty()) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new UpdateVocabularyResponse(false, "更新成功但查询详情失败", null)
                );
            }

            Map<String, Object> detail = details.get(0);

            // 7. 组装响应数据
            VocabularyItemData itemData = new VocabularyItemData();
            itemData.setId(userVocabId);
            itemData.setWord((String) detail.get("word"));
            itemData.setLanguage((String) detail.get("language"));
            itemData.setDefinition((String) detail.get("definition"));
            itemData.setExample((String) detail.get("example"));
            itemData.setNotes((String) detail.get("notes"));
            itemData.setStatus((String) detail.get("status"));
            itemData.setMasteryLevel(detail.get("mastery_level") != null ? ((Number) detail.get("mastery_level")).intValue() : 0);
            itemData.setReviewCount(detail.get("review_count") != null ? ((Number) detail.get("review_count")).intValue() : 0);
            itemData.setLastReviewedAt(detail.get("last_reviewed_at") != null ? detail.get("last_reviewed_at").toString() : null);
            itemData.setNextReviewAt(detail.get("next_review_at") != null ? detail.get("next_review_at").toString() : null);
            itemData.setSource((String) detail.get("source"));
            itemData.setSourcePage(detail.get("source_page") != null ? ((Number) detail.get("source_page")).intValue() : null);
            itemData.setCreatedAt(detail.get("created_at").toString());
            itemData.setUpdatedAt(detail.get("updated_at").toString());

            // 处理标签字符串
            String tagsStr = (String) detail.get("tags");
            if (tagsStr != null && !tagsStr.isEmpty()) {
                itemData.setTags(Arrays.asList(tagsStr.split(",")));
            }

            // 8. 创建响应
            UpdateVocabularyResponse response = new UpdateVocabularyResponse(true, "生词更新成功", itemData);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("更新生词过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdateVocabularyResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: VocabularyUpdateItem.java ---

