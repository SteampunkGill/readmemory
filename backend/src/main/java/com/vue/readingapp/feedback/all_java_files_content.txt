--- 开始文件: FeedbackAddComment.java ---
package com.vue.readingapp.feedback;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.UUID;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.core.type.TypeReference;

@RestController
@RequestMapping("/api/v1//feedback")
public class FeedbackAddComment {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到添加评论请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=====================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class AddCommentRequest {
        private String feedbackId;
        private String content;
        private Boolean isInternal;
        private List<Map<String, Object>> attachments;

        public String getFeedbackId() { return feedbackId; }
        public void setFeedbackId(String feedbackId) { this.feedbackId = feedbackId; }

        public String getContent() { return content; }
        public void setContent(String content) { this.content = content; }

        public Boolean getIsInternal() { return isInternal; }
        public void setIsInternal(Boolean isInternal) { this.isInternal = isInternal; }

        public List<Map<String, Object>> getAttachments() { return attachments; }
        public void setAttachments(List<Map<String, Object>> attachments) { this.attachments = attachments; }
    }

    // 响应DTO
    public static class AddCommentResponse {
        private boolean success;
        private String message;
        private CommentData data;

        public AddCommentResponse(boolean success, String message, CommentData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public CommentData getData() { return data; }
        public void setData(CommentData data) { this.data = data; }
    }

    public static class CommentData {
        private String id;
        private String feedbackId;
        private String content;
        private String userId;
        private String userName;
        private String userAvatar;
        private boolean isInternal;
        private List<Map<String, Object>> attachments;
        private String createdAt;
        private String updatedAt;
        private boolean edited;

        public CommentData(String id, String feedbackId, String content, String userId, String userName,
                           String userAvatar, boolean isInternal, List<Map<String, Object>> attachments,
                           String createdAt, String updatedAt, boolean edited) {
            this.id = id;
            this.feedbackId = feedbackId;
            this.content = content;
            this.userId = userId;
            this.userName = userName;
            this.userAvatar = userAvatar;
            this.isInternal = isInternal;
            this.attachments = attachments;
            this.createdAt = createdAt;
            this.updatedAt = updatedAt;
            this.edited = edited;
        }

        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getFeedbackId() { return feedbackId; }
        public void setFeedbackId(String feedbackId) { this.feedbackId = feedbackId; }

        public String getContent() { return content; }
        public void setContent(String content) { this.content = content; }

        public String getUserId() { return userId; }
        public void setUserId(String userId) { this.userId = userId; }

        public String getUserName() { return userName; }
        public void setUserName(String userName) { this.userName = userName; }

        public String getUserAvatar() { return userAvatar; }
        public void setUserAvatar(String userAvatar) { this.userAvatar = userAvatar; }

        public boolean isInternal() { return isInternal; }
        public void setInternal(boolean isInternal) { this.isInternal = isInternal; }

        public List<Map<String, Object>> getAttachments() { return attachments; }
        public void setAttachments(List<Map<String, Object>> attachments) { this.attachments = attachments; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }

        public boolean isEdited() { return edited; }
        public void setEdited(boolean edited) { this.edited = edited; }
    }

    @PostMapping("/{feedbackId}/comments")
    public ResponseEntity<AddCommentResponse> addCommentToFeedback(
            @PathVariable String feedbackId,
            @RequestBody AddCommentRequest request,
            @RequestHeader(value = "X-User-Id", required = false) String userId) {

        // 设置feedbackId
        request.setFeedbackId(feedbackId);

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证参数
            if (feedbackId == null || feedbackId.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new AddCommentResponse(false, "反馈ID不能为空", null)
                );
            }

            if (request.getContent() == null || request.getContent().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new AddCommentResponse(false, "评论内容不能为空", null)
                );
            }

            // 2. 验证用户身份
            if (userId == null || userId.trim().isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new AddCommentResponse(false, "用户未登录", null)
                );
            }

            // 3. 检查反馈是否存在
            String checkSql = "SELECT feedback_id FROM user_feedback WHERE feedback_id = ?";
            List<Map<String, Object>> feedbackList = jdbcTemplate.queryForList(checkSql, feedbackId);

            if (feedbackList.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new AddCommentResponse(false, "未找到指定的反馈", null)
                );
            }

            // 4. 获取用户信息
            String userSql = "SELECT username, avatar_url FROM users WHERE user_id = ?";
            List<Map<String, Object>> userList = jdbcTemplate.queryForList(userSql, userId);

            if (userList.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new AddCommentResponse(false, "用户不存在", null)
                );
            }

            Map<String, Object> user = userList.get(0);
            String userName = (String) user.get("username");
            String userAvatar = (String) user.get("avatar_url");

            // 5. 处理attachments
            String attachmentsJson = "[]";
            if (request.getAttachments() != null && !request.getAttachments().isEmpty()) {
                attachmentsJson = objectMapper.writeValueAsString(request.getAttachments());
            }

            // 6. 生成评论ID
            String commentId = "cmt_" + UUID.randomUUID().toString().substring(0, 8);

            // 7. 插入评论记录（使用feedback_replies表）
            String insertSql = "INSERT INTO feedback_replies (reply_id, feedback_id, user_id, message, is_internal, attachments, created_at, updated_at) " +
                    "VALUES (?, ?, ?, ?, ?, ?, NOW(), NOW())";

            boolean isInternal = request.getIsInternal() != null ? request.getIsInternal() : false;

            int rowsAffected = jdbcTemplate.update(insertSql,
                    commentId,
                    feedbackId,
                    userId,
                    request.getContent(),
                    isInternal,
                    attachmentsJson
            );

            printQueryResult("插入评论行数: " + rowsAffected);

            if (rowsAffected == 0) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new AddCommentResponse(false, "添加评论失败", null)
                );
            }

            // 8. 更新反馈的评论数量
            String updateCommentCountSql = "UPDATE user_feedback SET comment_count = comment_count + 1, updated_at = NOW() WHERE feedback_id = ?";
            jdbcTemplate.update(updateCommentCountSql, feedbackId);

            // 9. 查询刚插入的评论
            String selectSql = "SELECT * FROM feedback_replies WHERE reply_id = ?";
            List<Map<String, Object>> commentList = jdbcTemplate.queryForList(selectSql, commentId);
            printQueryResult("评论详情: " + commentList);

            if (commentList.isEmpty()) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new AddCommentResponse(false, "无法获取评论信息", null)
                );
            }

            Map<String, Object> comment = commentList.get(0);

            // 10. 准备响应数据
            List<Map<String, Object>> responseAttachments = request.getAttachments();
            if (responseAttachments == null) {
                responseAttachments = new ArrayList<>();
            }

            CommentData commentData = new CommentData(
                    commentId,
                    feedbackId,
                    request.getContent(),
                    userId,
                    userName,
                    userAvatar,
                    isInternal,
                    responseAttachments,
                    comment.get("created_at").toString(),
                    comment.get("updated_at").toString(),
                    !comment.get("created_at").equals(comment.get("updated_at"))
            );

            AddCommentResponse response = new AddCommentResponse(
                    true, "添加评论成功", commentData
            );

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("添加评论过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new AddCommentResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: FeedbackAddComment.java ---

--- 开始文件: FeedbackBatchAction.java ---
package com.vue.readingapp.feedback;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.UUID;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.core.type.TypeReference;

@RestController
@RequestMapping("/api/v1/feedback")
public class FeedbackBatchAction {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到批量操作反馈请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=======================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class BatchActionRequest {
        private String action;
        private List<String> feedbackIds;
        private String status;
        private String reason;

        public String getAction() { return action; }
        public void setAction(String action) { this.action = action; }

        public List<String> getFeedbackIds() { return feedbackIds; }
        public void setFeedbackIds(List<String> feedbackIds) { this.feedbackIds = feedbackIds; }

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public String getReason() { return reason; }
        public void setReason(String reason) { this.reason = reason; }
    }

    // 响应DTO
    public static class BatchActionResponse {
        private boolean success;
        private String message;
        private BatchActionData data;

        public BatchActionResponse(boolean success, String message, BatchActionData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public BatchActionData getData() { return data; }
        public void setData(BatchActionData data) { this.data = data; }
    }

    public static class BatchActionData {
        private int total;
        private int successCount;
        private int failCount;
        private List<BatchResult> results;

        public BatchActionData(int total, int successCount, int failCount, List<BatchResult> results) {
            this.total = total;
            this.successCount = successCount;
            this.failCount = failCount;
            this.results = results;
        }

        public int getTotal() { return total; }
        public void setTotal(int total) { this.total = total; }

        public int getSuccessCount() { return successCount; }
        public void setSuccessCount(int successCount) { this.successCount = successCount; }

        public int getFailCount() { return failCount; }
        public void setFailCount(int failCount) { this.failCount = failCount; }

        public List<BatchResult> getResults() { return results; }
        public void setResults(List<BatchResult> results) { this.results = results; }
    }

    public static class BatchResult {
        private String feedbackId;
        private boolean success;
        private String message;

        public BatchResult(String feedbackId, boolean success, String message) {
            this.feedbackId = feedbackId;
            this.success = success;
            this.message = message;
        }

        public String getFeedbackId() { return feedbackId; }
        public void setFeedbackId(String feedbackId) { this.feedbackId = feedbackId; }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }
    }

    @PostMapping("/batch")
    public ResponseEntity<BatchActionResponse> batchActionFeedback(
            @RequestBody BatchActionRequest request,
            @RequestHeader(value = "X-User-Id", required = false) String userId) {

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证参数
            if (request.getAction() == null || request.getAction().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new BatchActionResponse(false, "操作类型不能为空", null)
                );
            }

            if (request.getFeedbackIds() == null || request.getFeedbackIds().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new BatchActionResponse(false, "反馈ID列表不能为空", null)
                );
            }

            // 2. 验证用户身份（需要管理员权限）
            if (userId == null || userId.trim().isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new BatchActionResponse(false, "用户未登录", null)
                );
            }

            // 检查是否是管理员
            String adminCheckSql = "SELECT role FROM users WHERE user_id = ?";
            List<Map<String, Object>> userList = jdbcTemplate.queryForList(adminCheckSql, userId);

            boolean isAdmin = false;
            if (!userList.isEmpty()) {
                Map<String, Object> user = userList.get(0);
                String role = (String) user.get("role");
                isAdmin = "admin".equals(role) || "moderator".equals(role);
            }

            if (!isAdmin) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN).body(
                        new BatchActionResponse(false, "需要管理员权限", null)
                );
            }

            // 3. 根据操作类型执行批量操作
            String action = request.getAction();
            List<BatchResult> results = new ArrayList<>();
            int successCount = 0;
            int failCount = 0;

            switch (action) {
                case "update_status":
                    results = batchUpdateStatus(request, userId);
                    break;
                case "delete":
                    results = batchDelete(request, userId);
                    break;
                case "mark_as_read":
                    results = batchMarkAsRead(request, userId);
                    break;
                case "mark_as_resolved":
                    results = batchMarkAsResolved(request, userId);
                    break;
                default:
                    return ResponseEntity.badRequest().body(
                            new BatchActionResponse(false, "不支持的操作类型: " + action, null)
                    );
            }

            // 4. 统计成功和失败数量
            for (BatchResult result : results) {
                if (result.isSuccess()) {
                    successCount++;
                } else {
                    failCount++;
                }
            }

            // 5. 准备响应数据
            BatchActionData actionData = new BatchActionData(
                    request.getFeedbackIds().size(),
                    successCount,
                    failCount,
                    results
            );

            BatchActionResponse response = new BatchActionResponse(
                    true,
                    String.format("批量操作完成，成功: %d, 失败: %d", successCount, failCount),
                    actionData
            );

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("批量操作反馈过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new BatchActionResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private List<BatchResult> batchUpdateStatus(BatchActionRequest request, String userId) {
        List<BatchResult> results = new ArrayList<>();
        String newStatus = request.getStatus();
        String reason = request.getReason() != null ? request.getReason() : "批量更新状态";

        // 验证状态值
        List<String> validStatuses = List.of("pending", "reviewing", "in_progress", "completed", "rejected", "duplicate");
        if (newStatus == null || !validStatuses.contains(newStatus)) {
            for (String feedbackId : request.getFeedbackIds()) {
                results.add(new BatchResult(feedbackId, false, "无效的状态值"));
            }
            return results;
        }

        for (String feedbackId : request.getFeedbackIds()) {
            try {
                // 检查反馈是否存在
                String checkSql = "SELECT feedback_id, status FROM user_feedback WHERE feedback_id = ?";
                List<Map<String, Object>> feedbackList = jdbcTemplate.queryForList(checkSql, feedbackId);

                if (feedbackList.isEmpty()) {
                    results.add(new BatchResult(feedbackId, false, "反馈不存在"));
                    continue;
                }

                Map<String, Object> feedback = feedbackList.get(0);
                String oldStatus = (String) feedback.get("status");

                // 如果状态没有变化，直接记录成功
                if (oldStatus.equals(newStatus)) {
                    results.add(new BatchResult(feedbackId, true, "状态未发生变化"));
                    continue;
                }

                // 更新状态
                String updateSql = "UPDATE user_feedback SET status = ?, updated_at = NOW() WHERE feedback_id = ?";
                int rowsAffected = jdbcTemplate.update(updateSql, newStatus, feedbackId);

                if (rowsAffected > 0) {
                    // 记录变更日志
                    String logSql = "INSERT INTO feedback_change_log (feedback_id, field, old_value, new_value, changed_by, reason, created_at) " +
                            "VALUES (?, 'status', ?, ?, ?, ?, NOW())";

                    jdbcTemplate.update(logSql,
                            feedbackId,
                            oldStatus,
                            newStatus,
                            userId,
                            reason
                    );

                    // 如果新状态是completed，设置完成时间
                    if ("completed".equals(newStatus)) {
                        String completeSql = "UPDATE user_feedback SET completed_at = NOW() WHERE feedback_id = ?";
                        jdbcTemplate.update(completeSql, feedbackId);
                    }

                    results.add(new BatchResult(feedbackId, true, "状态更新成功"));
                } else {
                    results.add(new BatchResult(feedbackId, false, "状态更新失败"));
                }

            } catch (Exception e) {
                results.add(new BatchResult(feedbackId, false, "操作失败: " + e.getMessage()));
            }
        }

        return results;
    }

    private List<BatchResult> batchDelete(BatchActionRequest request, String userId) {
        List<BatchResult> results = new ArrayList<>();

        for (String feedbackId : request.getFeedbackIds()) {
            try {
                // 检查反馈是否存在
                String checkSql = "SELECT feedback_id FROM user_feedback WHERE feedback_id = ?";
                List<Map<String, Object>> feedbackList = jdbcTemplate.queryForList(checkSql, feedbackId);

                if (feedbackList.isEmpty()) {
                    results.add(new BatchResult(feedbackId, false, "反馈不存在"));
                    continue;
                }

                // 先删除相关的投票记录
                String deleteVotesSql = "DELETE FROM feedback_votes WHERE feedback_id = ?";
                jdbcTemplate.update(deleteVotesSql, feedbackId);

                // 先删除相关的回复记录
                String deleteRepliesSql = "DELETE FROM feedback_replies WHERE feedback_id = ?";
                jdbcTemplate.update(deleteRepliesSql, feedbackId);

                // 先删除相关的变更日志
                String deleteLogsSql = "DELETE FROM feedback_change_log WHERE feedback_id = ?";
                jdbcTemplate.update(deleteLogsSql, feedbackId);

                // 删除反馈主记录
                String deleteFeedbackSql = "DELETE FROM user_feedback WHERE feedback_id = ?";
                int rowsAffected = jdbcTemplate.update(deleteFeedbackSql, feedbackId);

                if (rowsAffected > 0) {
                    results.add(new BatchResult(feedbackId, true, "删除成功"));
                } else {
                    results.add(new BatchResult(feedbackId, false, "删除失败"));
                }

            } catch (Exception e) {
                results.add(new BatchResult(feedbackId, false, "删除失败: " + e.getMessage()));
            }
        }

        return results;
    }

    private List<BatchResult> batchMarkAsRead(BatchActionRequest request, String userId) {
        List<BatchResult> results = new ArrayList<>();

        for (String feedbackId : request.getFeedbackIds()) {
            try {
                // 检查反馈是否存在
                String checkSql = "SELECT feedback_id FROM user_feedback WHERE feedback_id = ?";
                List<Map<String, Object>> feedbackList = jdbcTemplate.queryForList(checkSql, feedbackId);

                if (feedbackList.isEmpty()) {
                    results.add(new BatchResult(feedbackId, false, "反馈不存在"));
                    continue;
                }

                // 更新view_count（增加一次查看）
                String updateSql = "UPDATE user_feedback SET view_count = view_count + 1, updated_at = NOW() WHERE feedback_id = ?";
                int rowsAffected = jdbcTemplate.update(updateSql, feedbackId);

                if (rowsAffected > 0) {
                    results.add(new BatchResult(feedbackId, true, "标记为已读成功"));
                } else {
                    results.add(new BatchResult(feedbackId, false, "标记为已读失败"));
                }

            } catch (Exception e) {
                results.add(new BatchResult(feedbackId, false, "操作失败: " + e.getMessage()));
            }
        }

        return results;
    }

    private List<BatchResult> batchMarkAsResolved(BatchActionRequest request, String userId) {
        List<BatchResult> results = new ArrayList<>();

        for (String feedbackId : request.getFeedbackIds()) {
            try {
                // 检查反馈是否存在
                String checkSql = "SELECT feedback_id, status FROM user_feedback WHERE feedback_id = ?";
                List<Map<String, Object>> feedbackList = jdbcTemplate.queryForList(checkSql, feedbackId);

                if (feedbackList.isEmpty()) {
                    results.add(new BatchResult(feedbackId, false, "反馈不存在"));
                    continue;
                }

                Map<String, Object> feedback = feedbackList.get(0);
                String currentStatus = (String) feedback.get("status");

                // 检查是否已经是已处理状态
                List<String> resolvedStatuses = List.of("completed", "rejected", "duplicate");
                if (resolvedStatuses.contains(currentStatus)) {
                    results.add(new BatchResult(feedbackId, true, "反馈已经是已处理状态"));
                    continue;
                }

                // 更新反馈状态为completed（已处理）
                String updateSql = "UPDATE user_feedback SET status = 'completed', completed_at = NOW(), updated_at = NOW() WHERE feedback_id = ?";
                int rowsAffected = jdbcTemplate.update(updateSql, feedbackId);

                if (rowsAffected > 0) {
                    // 记录变更日志
                    String logSql = "INSERT INTO feedback_change_log (feedback_id, field, old_value, new_value, changed_by, reason, created_at) " +
                            "VALUES (?, 'status', ?, 'completed', ?, '批量标记为已处理', NOW())";

                    jdbcTemplate.update(logSql,
                            feedbackId,
                            currentStatus,
                            userId
                    );

                    results.add(new BatchResult(feedbackId, true, "标记为已处理成功"));
                } else {
                    results.add(new BatchResult(feedbackId, false, "标记为已处理失败"));
                }

            } catch (Exception e) {
                results.add(new BatchResult(feedbackId, false, "操作失败: " + e.getMessage()));
            }
        }

        return results;
    }
}
--- 结束文件: FeedbackBatchAction.java ---

--- 开始文件: FeedbackCreateCategory.java ---
package com.vue.readingapp.feedback;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.UUID;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.core.type.TypeReference;

@RestController
@RequestMapping("/api/v1/feedback")
public class FeedbackCreateCategory {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到创建反馈分类请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=======================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class CreateCategoryRequest {
        private String name;
        private String value;
        private String description;
        private String icon;
        private String color;

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getValue() { return value; }
        public void setValue(String value) { this.value = value; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }

        public String getIcon() { return icon; }
        public void setIcon(String icon) { this.icon = icon; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }
    }

    // 响应DTO
    public static class CreateCategoryResponse {
        private boolean success;
        private String message;
        private CategoryData data;

        public CreateCategoryResponse(boolean success, String message, CategoryData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public CategoryData getData() { return data; }
        public void setData(CategoryData data) { this.data = data; }
    }

    public static class CategoryData {
        private String id;
        private String name;
        private String value;
        private String description;
        private String icon;
        private String color;
        private String createdAt;

        public CategoryData(String id, String name, String value, String description,
                            String icon, String color, String createdAt) {
            this.id = id;
            this.name = name;
            this.value = value;
            this.description = description;
            this.icon = icon;
            this.color = color;
            this.createdAt = createdAt;
        }

        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getValue() { return value; }
        public void setValue(String value) { this.value = value; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }

        public String getIcon() { return icon; }
        public void setIcon(String icon) { this.icon = icon; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }
    }

    @PostMapping("/categories")
    public ResponseEntity<CreateCategoryResponse> createFeedbackCategory(
            @RequestBody CreateCategoryRequest request,
            @RequestHeader(value = "X-User-Id", required = false) String userId) {

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证参数
            if (request.getName() == null || request.getName().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new CreateCategoryResponse(false, "分类名称不能为空", null)
                );
            }

            if (request.getValue() == null || request.getValue().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new CreateCategoryResponse(false, "分类值不能为空", null)
                );
            }

            // 2. 验证用户身份（需要管理员权限）
            if (userId == null || userId.trim().isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new CreateCategoryResponse(false, "用户未登录", null)
                );
            }

            // 检查是否是管理员
            String adminCheckSql = "SELECT role FROM users WHERE user_id = ?";
            List<Map<String, Object>> userList = jdbcTemplate.queryForList(adminCheckSql, userId);

            boolean isAdmin = false;
            if (!userList.isEmpty()) {
                Map<String, Object> user = userList.get(0);
                String role = (String) user.get("role");
                isAdmin = "admin".equals(role) || "moderator".equals(role);
            }

            if (!isAdmin) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN).body(
                        new CreateCategoryResponse(false, "需要管理员权限", null)
                );
            }

            // 3. 检查分类值是否已存在
            String checkSql = "SELECT COUNT(*) as count FROM feedback_categories WHERE value = ?";
            Integer count = jdbcTemplate.queryForObject(checkSql, Integer.class, request.getValue());

            if (count != null && count > 0) {
                return ResponseEntity.badRequest().body(
                        new CreateCategoryResponse(false, "分类值已存在: " + request.getValue(), null)
                );
            }

            // 4. 生成分类ID
            String categoryId = "cat_" + UUID.randomUUID().toString().substring(0, 8);

            // 5. 插入分类记录
            String insertSql = "INSERT INTO feedback_categories (category_id, name, value, description, icon, color, order_index, is_active, created_at, updated_at) " +
                    "VALUES (?, ?, ?, ?, ?, ?, 0, TRUE, NOW(), NOW())";

            int rowsAffected = jdbcTemplate.update(insertSql,
                    categoryId,
                    request.getName(),
                    request.getValue(),
                    request.getDescription() != null ? request.getDescription() : "",
                    request.getIcon() != null ? request.getIcon() : "tag",
                    request.getColor() != null ? request.getColor() : "#607D8B"
            );

            printQueryResult("插入行数: " + rowsAffected);

            if (rowsAffected == 0) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new CreateCategoryResponse(false, "创建分类失败", null)
                );
            }

            // 6. 查询刚插入的分类
            String selectSql = "SELECT * FROM feedback_categories WHERE category_id = ?";
            List<Map<String, Object>> categoryList = jdbcTemplate.queryForList(selectSql, categoryId);
            printQueryResult("分类详情: " + categoryList);

            if (categoryList.isEmpty()) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new CreateCategoryResponse(false, "无法获取创建的分类信息", null)
                );
            }

            Map<String, Object> category = categoryList.get(0);

            // 7. 准备响应数据
            CategoryData categoryData = new CategoryData(
                    categoryId,
                    request.getName(),
                    request.getValue(),
                    request.getDescription() != null ? request.getDescription() : "",
                    request.getIcon() != null ? request.getIcon() : "tag",
                    request.getColor() != null ? request.getColor() : "#607D8B",
                    category.get("created_at").toString()
            );

            CreateCategoryResponse response = new CreateCategoryResponse(
                    true, "创建反馈分类成功", categoryData
            );

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("创建反馈分类过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new CreateCategoryResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: FeedbackCreateCategory.java ---

--- 开始文件: FeedbackDelete.java ---
package com.vue.readingapp.feedback;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.UUID;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.core.type.TypeReference;

@RestController
@RequestMapping("/api/v1/feedback")
public class FeedbackDelete {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到删除反馈请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=====================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class DeleteRequest {
        private String feedbackId;

        public String getFeedbackId() { return feedbackId; }
        public void setFeedbackId(String feedbackId) { this.feedbackId = feedbackId; }
    }

    // 响应DTO
    public static class DeleteResponse {
        private boolean success;
        private String message;
        private DeleteData data;

        public DeleteResponse(boolean success, String message, DeleteData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public DeleteData getData() { return data; }
        public void setData(DeleteData data) { this.data = data; }
    }

    public static class DeleteData {
        private String feedbackId;
        private boolean deleted;
        private String deletedAt;

        public DeleteData(String feedbackId, boolean deleted, String deletedAt) {
            this.feedbackId = feedbackId;
            this.deleted = deleted;
            this.deletedAt = deletedAt;
        }

        public String getFeedbackId() { return feedbackId; }
        public void setFeedbackId(String feedbackId) { this.feedbackId = feedbackId; }

        public boolean isDeleted() { return deleted; }
        public void setDeleted(boolean deleted) { this.deleted = deleted; }

        public String getDeletedAt() { return deletedAt; }
        public void setDeletedAt(String deletedAt) { this.deletedAt = deletedAt; }
    }

    @DeleteMapping("/{feedbackId}")
    public ResponseEntity<DeleteResponse> deleteFeedback(
            @PathVariable String feedbackId,
            @RequestHeader(value = "X-User-Id", required = false) String userId) {

        // 创建请求对象用于打印
        DeleteRequest request = new DeleteRequest();
        request.setFeedbackId(feedbackId);

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证参数
            if (feedbackId == null || feedbackId.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new DeleteResponse(false, "反馈ID不能为空", null)
                );
            }

            // 2. 检查反馈是否存在
            String checkSql = "SELECT feedback_id, user_id FROM user_feedback WHERE feedback_id = ?";
            List<Map<String, Object>> feedbackList = jdbcTemplate.queryForList(checkSql, feedbackId);

            if (feedbackList.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new DeleteResponse(false, "未找到指定的反馈", null)
                );
            }

            Map<String, Object> feedback = feedbackList.get(0);
            String feedbackUserId = (String) feedback.get("user_id");

            // 3. 检查权限（只有反馈创建者或管理员可以删除）
            // 这里简化处理，实际项目中应该有更完善的权限控制
            if (userId != null && !userId.equals(feedbackUserId)) {
                // 检查是否是管理员（简化处理）
                String adminCheckSql = "SELECT role FROM users WHERE user_id = ?";
                List<Map<String, Object>> userList = jdbcTemplate.queryForList(adminCheckSql, userId);

                if (!userList.isEmpty()) {
                    Map<String, Object> user = userList.get(0);
                    String role = (String) user.get("role");

                    if (!"admin".equals(role) && !"moderator".equals(role)) {
                        return ResponseEntity.status(HttpStatus.FORBIDDEN).body(
                                new DeleteResponse(false, "没有权限删除此反馈", null)
                        );
                    }
                } else {
                    return ResponseEntity.status(HttpStatus.FORBIDDEN).body(
                            new DeleteResponse(false, "没有权限删除此反馈", null)
                    );
                }
            }

            // 4. 先删除相关的投票记录
            String deleteVotesSql = "DELETE FROM feedback_votes WHERE feedback_id = ?";
            int votesDeleted = jdbcTemplate.update(deleteVotesSql, feedbackId);
            printQueryResult("删除投票记录: " + votesDeleted + " 条");

            // 5. 先删除相关的回复记录
            String deleteRepliesSql = "DELETE FROM feedback_replies WHERE feedback_id = ?";
            int repliesDeleted = jdbcTemplate.update(deleteRepliesSql, feedbackId);
            printQueryResult("删除回复记录: " + repliesDeleted + " 条");

            // 6. 先删除相关的变更日志
            String deleteLogsSql = "DELETE FROM feedback_change_log WHERE feedback_id = ?";
            int logsDeleted = jdbcTemplate.update(deleteLogsSql, feedbackId);
            printQueryResult("删除变更日志: " + logsDeleted + " 条");

            // 7. 删除反馈主记录
            String deleteFeedbackSql = "DELETE FROM user_feedback WHERE feedback_id = ?";
            int feedbackDeleted = jdbcTemplate.update(deleteFeedbackSql, feedbackId);
            printQueryResult("删除反馈记录: " + feedbackDeleted + " 条");

            if (feedbackDeleted == 0) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new DeleteResponse(false, "删除反馈失败", null)
                );
            }

            // 8. 准备响应数据
            DeleteData deleteData = new DeleteData(
                    feedbackId,
                    true,
                    LocalDateTime.now().toString()
            );

            DeleteResponse response = new DeleteResponse(
                    true, "反馈删除成功", deleteData
            );

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("删除反馈过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new DeleteResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: FeedbackDelete.java ---

--- 开始文件: FeedbackDeleteCategory.java ---
package com.vue.readingapp.feedback;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.UUID;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.core.type.TypeReference;

@RestController
@RequestMapping("/api/v1/feedback")
public class FeedbackDeleteCategory {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到删除反馈分类请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=======================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class DeleteCategoryRequest {
        private String categoryId;

        public String getCategoryId() { return categoryId; }
        public void setCategoryId(String categoryId) { this.categoryId = categoryId; }
    }

    // 响应DTO
    public static class DeleteCategoryResponse {
        private boolean success;
        private String message;
        private DeleteData data;

        public DeleteCategoryResponse(boolean success, String message, DeleteData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public DeleteData getData() { return data; }
        public void setData(DeleteData data) { this.data = data; }
    }

    public static class DeleteData {
        private String categoryId;
        private boolean deleted;
        private String deletedAt;

        public DeleteData(String categoryId, boolean deleted, String deletedAt) {
            this.categoryId = categoryId;
            this.deleted = deleted;
            this.deletedAt = deletedAt;
        }

        public String getCategoryId() { return categoryId; }
        public void setCategoryId(String categoryId) { this.categoryId = categoryId; }

        public boolean isDeleted() { return deleted; }
        public void setDeleted(boolean deleted) { this.deleted = deleted; }

        public String getDeletedAt() { return deletedAt; }
        public void setDeletedAt(String deletedAt) { this.deletedAt = deletedAt; }
    }

    @DeleteMapping("/categories/{categoryId}")
    public ResponseEntity<DeleteCategoryResponse> deleteFeedbackCategory(
            @PathVariable String categoryId,
            @RequestHeader(value = "X-User-Id", required = false) String userId) {

        // 创建请求对象用于打印
        DeleteCategoryRequest request = new DeleteCategoryRequest();
        request.setCategoryId(categoryId);

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证参数
            if (categoryId == null || categoryId.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new DeleteCategoryResponse(false, "分类ID不能为空", null)
                );
            }

            // 2. 验证用户身份（需要管理员权限）
            if (userId == null || userId.trim().isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new DeleteCategoryResponse(false, "用户未登录", null)
                );
            }

            // 检查是否是管理员
            String adminCheckSql = "SELECT role FROM users WHERE user_id = ?";
            List<Map<String, Object>> userList = jdbcTemplate.queryForList(adminCheckSql, userId);

            boolean isAdmin = false;
            if (!userList.isEmpty()) {
                Map<String, Object> user = userList.get(0);
                String role = (String) user.get("role");
                isAdmin = "admin".equals(role) || "moderator".equals(role);
            }

            if (!isAdmin) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN).body(
                        new DeleteCategoryResponse(false, "需要管理员权限", null)
                );
            }

            // 3. 检查分类是否存在
            String checkSql = "SELECT * FROM feedback_categories WHERE category_id = ?";
            List<Map<String, Object>> categoryList = jdbcTemplate.queryForList(checkSql, categoryId);

            if (categoryList.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new DeleteCategoryResponse(false, "未找到指定的分类", null)
                );
            }

            Map<String, Object> category = categoryList.get(0);
            String categoryValue = (String) category.get("value");

            // 4. 检查是否有反馈使用此分类
            String feedbackCheckSql = "SELECT COUNT(*) as count FROM user_feedback WHERE type = ?";
            Integer feedbackCount = jdbcTemplate.queryForObject(feedbackCheckSql, Integer.class, categoryValue);

            if (feedbackCount != null && feedbackCount > 0) {
                // 如果有反馈使用此分类，不能直接删除，可以标记为不活跃
                String deactivateSql = "UPDATE feedback_categories SET is_active = FALSE, updated_at = NOW() WHERE category_id = ?";
                int rowsAffected = jdbcTemplate.update(deactivateSql, categoryId);

                printQueryResult("标记为不活跃行数: " + rowsAffected);

                if (rowsAffected > 0) {
                    DeleteData deleteData = new DeleteData(
                            categoryId,
                            true,
                            LocalDateTime.now().toString()
                    );

                    DeleteCategoryResponse response = new DeleteCategoryResponse(
                            true, "分类已被标记为不活跃（有反馈使用此分类）", deleteData
                    );

                    printResponse(response);
                    return ResponseEntity.ok(response);
                } else {
                    return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                            new DeleteCategoryResponse(false, "标记分类为不活跃失败", null)
                    );
                }
            }

            // 5. 删除分类记录
            String deleteSql = "DELETE FROM feedback_categories WHERE category_id = ?";
            int rowsAffected = jdbcTemplate.update(deleteSql, categoryId);

            printQueryResult("删除行数: " + rowsAffected);

            if (rowsAffected == 0) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new DeleteCategoryResponse(false, "删除分类失败", null)
                );
            }

            // 6. 准备响应数据
            DeleteData deleteData = new DeleteData(
                    categoryId,
                    true,
                    LocalDateTime.now().toString()
            );

            DeleteCategoryResponse response = new DeleteCategoryResponse(
                    true, "删除反馈分类成功", deleteData
            );

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("删除反馈分类过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new DeleteCategoryResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: FeedbackDeleteCategory.java ---

--- 开始文件: FeedbackExport.java ---
package com.vue.readingapp.feedback;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.UUID;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.core.type.TypeReference;

@RestController
@RequestMapping("/api/v1/feedback")
public class FeedbackExport {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();
    private DateTimeFormatter dateFormatter = DateTimeFormatter.ofPattern("yyyy-MM-dd");

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到导出反馈数据请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=======================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class ExportRequest {
        private String format;
        private String type;
        private String status;
        private String startDate;
        private String endDate;

        public String getFormat() { return format; }
        public void setFormat(String format) { this.format = format; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public String getStartDate() { return startDate; }
        public void setStartDate(String startDate) { this.startDate = startDate; }

        public String getEndDate() { return endDate; }
        public void setEndDate(String endDate) { this.endDate = endDate; }
    }

    // 响应DTO
    public static class ExportResponse {
        private boolean success;
        private String message;
        private ExportData data;

        public ExportResponse(boolean success, String message, ExportData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public ExportData getData() { return data; }
        public void setData(ExportData data) { this.data = data; }
    }

    public static class ExportData {
        private Map<String, Object> metadata;
        private List<Map<String, Object>> data;

        public ExportData(Map<String, Object> metadata, List<Map<String, Object>> data) {
            this.metadata = metadata;
            this.data = data;
        }

        public Map<String, Object> getMetadata() { return metadata; }
        public void setMetadata(Map<String, Object> metadata) { this.metadata = metadata; }

        public List<Map<String, Object>> getData() { return data; }
        public void setData(List<Map<String, Object>> data) { this.data = data; }
    }

    @GetMapping("/export")
    public ResponseEntity<ExportResponse> exportFeedbackData(
            @RequestParam(defaultValue = "csv") String format,
            @RequestParam(required = false) String type,
            @RequestParam(required = false) String status,
            @RequestParam(required = false) String startDate,
            @RequestParam(required = false) String endDate,
            @RequestHeader(value = "X-User-Id", required = false) String userId) {

        // 创建请求对象用于打印
        ExportRequest request = new ExportRequest();
        request.setFormat(format);
        request.setType(type);
        request.setStatus(status);
        request.setStartDate(startDate);
        request.setEndDate(endDate);

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证用户身份（需要管理员权限）
            if (userId == null || userId.trim().isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ExportResponse(false, "用户未登录", null)
                );
            }

            // 检查是否是管理员
            String adminCheckSql = "SELECT role FROM users WHERE user_id = ?";
            List<Map<String, Object>> userList = jdbcTemplate.queryForList(adminCheckSql, userId);

            boolean isAdmin = false;
            if (!userList.isEmpty()) {
                Map<String, Object> user = userList.get(0);
                String role = (String) user.get("role");
                isAdmin = "admin".equals(role) || "moderator".equals(role);
            }

            if (!isAdmin) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN).body(
                        new ExportResponse(false, "需要管理员权限", null)
                );
            }

            // 2. 构建查询条件
            List<Object> params = new ArrayList<>();
            StringBuilder whereClause = new StringBuilder(" WHERE 1=1 ");

            // 处理type条件
            if (type != null && !type.isEmpty() && !"all".equals(type)) {
                whereClause.append(" AND type = ? ");
                params.add(type);
            }

            // 处理status条件
            if (status != null && !status.isEmpty() && !"all".equals(status)) {
                whereClause.append(" AND status = ? ");
                params.add(status);
            }

            // 处理日期范围条件
            if (startDate != null && !startDate.trim().isEmpty()) {
                whereClause.append(" AND DATE(created_at) >= ? ");
                params.add(startDate);
            }

            if (endDate != null && !endDate.trim().isEmpty()) {
                whereClause.append(" AND DATE(created_at) <= ? ");
                params.add(endDate);
            }

            // 3. 查询反馈数据
            String querySql = "SELECT f.*, u.username as user_name, u.email as user_email " +
                    "FROM user_feedback f " +
                    "LEFT JOIN users u ON f.user_id = u.user_id " +
                    whereClause.toString() +
                    " ORDER BY f.created_at DESC";

            List<Map<String, Object>> feedbackList = jdbcTemplate.queryForList(querySql, params.toArray());
            printQueryResult("导出 " + feedbackList.size() + " 条记录");

            // 4. 转换数据为导出格式
            List<Map<String, Object>> exportData = new ArrayList<>();
            for (Map<String, Object> row : feedbackList) {
                Map<String, Object> exportRow = new HashMap<>();

                // 添加基本字段
                exportRow.put("id", row.get("feedback_id"));
                exportRow.put("title", row.get("title"));
                exportRow.put("type", row.get("type"));
                exportRow.put("status", row.get("status"));
                exportRow.put("priority", row.get("priority"));
                exportRow.put("upvotes", row.get("upvotes"));
                exportRow.put("downvotes", row.get("downvotes"));
                exportRow.put("userName", row.get("user_name"));
                exportRow.put("userEmail", row.get("user_email"));
                exportRow.put("createdAt", row.get("created_at").toString());
                exportRow.put("updatedAt", row.get("updated_at").toString());
                exportRow.put("assignedTo", row.get("assigned_to"));
                exportRow.put("assignedAt", row.get("assigned_at") != null ? row.get("assigned_at").toString() : null);
                exportRow.put("completedAt", row.get("completed_at") != null ? row.get("completed_at").toString() : null);
                exportRow.put("viewCount", row.get("view_count"));
                exportRow.put("commentCount", row.get("comment_count"));

                // 处理metadata JSON
                String metadataJson = (String) row.get("metadata");
                if (metadataJson != null && !metadataJson.isEmpty() && !"{}".equals(metadataJson)) {
                    try {
                        Map<String, Object> metadata = objectMapper.readValue(
                                metadataJson, new TypeReference<Map<String, Object>>() {});
                        exportRow.put("metadata", metadata);
                    } catch (Exception e) {
                        exportRow.put("metadata", new HashMap<>());
                    }
                } else {
                    exportRow.put("metadata", new HashMap<>());
                }

                exportData.add(exportRow);
            }

            // 5. 准备元数据
            Map<String, Object> metadata = new HashMap<>();
            metadata.put("exportDate", LocalDateTime.now().toString());
            metadata.put("exportFormat", format);
            metadata.put("totalRecords", feedbackList.size());

            Map<String, Object> filters = new HashMap<>();
            filters.put("type", type != null ? type : "all");
            filters.put("status", status != null ? status : "all");
            filters.put("startDate", startDate);
            filters.put("endDate", endDate);
            metadata.put("filters", filters);

            // 6. 根据格式处理数据
            if ("csv".equals(format)) {
                // 对于CSV格式，我们可以将数据扁平化
                List<Map<String, Object>> csvData = new ArrayList<>();
                for (Map<String, Object> row : exportData) {
                    Map<String, Object> csvRow = new HashMap<>(row);

                    // 将metadata中的字段提取出来
                    Map<String, Object> metadataMap = (Map<String, Object>) csvRow.get("metadata");
                    if (metadataMap != null) {
                        for (Map.Entry<String, Object> entry : metadataMap.entrySet()) {
                            csvRow.put("metadata_" + entry.getKey(), entry.getValue());
                        }
                    }
                    csvRow.remove("metadata");

                    csvData.add(csvRow);
                }
                exportData = csvData;
            }

            // 7. 准备响应数据
            ExportData exportDataObj = new ExportData(metadata, exportData);

            ExportResponse response = new ExportResponse(
                    true, "导出反馈数据成功", exportDataObj
            );

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("导出反馈数据过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ExportResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: FeedbackExport.java ---

--- 开始文件: FeedbackGetById.java ---
package com.vue.readingapp.feedback;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.UUID;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.core.type.TypeReference;

@RestController
@RequestMapping("/api/v1/feedback")
public class FeedbackGetById {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取反馈详情请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=======================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class GetByIdRequest {
        private String feedbackId;

        public String getFeedbackId() { return feedbackId; }
        public void setFeedbackId(String feedbackId) { this.feedbackId = feedbackId; }
    }

    // 响应DTO
    public static class GetByIdResponse {
        private boolean success;
        private String message;
        private FeedbackDetailData data;

        public GetByIdResponse(boolean success, String message, FeedbackDetailData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public FeedbackDetailData getData() { return data; }
        public void setData(FeedbackDetailData data) { this.data = data; }
    }

    public static class FeedbackDetailData {
        private String id;
        private String type;
        private String title;
        private String content;
        private String status;
        private String priority;
        private int upvotes;
        private int downvotes;
        private List<String> upvotedBy;
        private List<String> downvotedBy;
        private String userId;
        private String userName;
        private String userEmail;
        private List<Attachment> attachments;
        private List<Comment> comments;
        private Map<String, Object> metadata;
        private int viewCount;
        private int commentCount;
        private List<String> relatedFeedback;
        private List<ChangeLog> changeLog;
        private String estimatedCompletion;
        private String createdAt;
        private String updatedAt;
        private String assignedTo;
        private String assignedAt;
        private String completedAt;

        // Getters and Setters
        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public String getTitle() { return title; }
        public void setTitle(String title) { this.title = title; }

        public String getContent() { return content; }
        public void setContent(String content) { this.content = content; }

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public String getPriority() { return priority; }
        public void setPriority(String priority) { this.priority = priority; }

        public int getUpvotes() { return upvotes; }
        public void setUpvotes(int upvotes) { this.upvotes = upvotes; }

        public int getDownvotes() { return downvotes; }
        public void setDownvotes(int downvotes) { this.downvotes = downvotes; }

        public List<String> getUpvotedBy() { return upvotedBy; }
        public void setUpvotedBy(List<String> upvotedBy) { this.upvotedBy = upvotedBy; }

        public List<String> getDownvotedBy() { return downvotedBy; }
        public void setDownvotedBy(List<String> downvotedBy) { this.downvotedBy = downvotedBy; }

        public String getUserId() { return userId; }
        public void setUserId(String userId) { this.userId = userId; }

        public String getUserName() { return userName; }
        public void setUserName(String userName) { this.userName = userName; }

        public String getUserEmail() { return userEmail; }
        public void setUserEmail(String userEmail) { this.userEmail = userEmail; }

        public List<Attachment> getAttachments() { return attachments; }
        public void setAttachments(List<Attachment> attachments) { this.attachments = attachments; }

        public List<Comment> getComments() { return comments; }
        public void setComments(List<Comment> comments) { this.comments = comments; }

        public Map<String, Object> getMetadata() { return metadata; }
        public void setMetadata(Map<String, Object> metadata) { this.metadata = metadata; }

        public int getViewCount() { return viewCount; }
        public void setViewCount(int viewCount) { this.viewCount = viewCount; }

        public int getCommentCount() { return commentCount; }
        public void setCommentCount(int commentCount) { this.commentCount = commentCount; }

        public List<String> getRelatedFeedback() { return relatedFeedback; }
        public void setRelatedFeedback(List<String> relatedFeedback) { this.relatedFeedback = relatedFeedback; }

        public List<ChangeLog> getChangeLog() { return changeLog; }
        public void setChangeLog(List<ChangeLog> changeLog) { this.changeLog = changeLog; }

        public String getEstimatedCompletion() { return estimatedCompletion; }
        public void setEstimatedCompletion(String estimatedCompletion) { this.estimatedCompletion = estimatedCompletion; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }

        public String getAssignedTo() { return assignedTo; }
        public void setAssignedTo(String assignedTo) { this.assignedTo = assignedTo; }

        public String getAssignedAt() { return assignedAt; }
        public void setAssignedAt(String assignedAt) { this.assignedAt = assignedAt; }

        public String getCompletedAt() { return completedAt; }
        public void setCompletedAt(String completedAt) { this.completedAt = completedAt; }
    }

    public static class Attachment {
        private String id;
        private String name;
        private String url;
        private long size;
        private String type;

        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getUrl() { return url; }
        public void setUrl(String url) { this.url = url; }

        public long getSize() { return size; }
        public void setSize(long size) { this.size = size; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }
    }

    public static class Comment {
        private String id;
        private String content;
        private String userId;
        private String userName;
        private String userAvatar;
        private boolean isInternal;
        private List<Attachment> attachments;
        private String createdAt;
        private String updatedAt;
        private boolean edited;

        // Getters and Setters
        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getContent() { return content; }
        public void setContent(String content) { this.content = content; }

        public String getUserId() { return userId; }
        public void setUserId(String userId) { this.userId = userId; }

        public String getUserName() { return userName; }
        public void setUserName(String userName) { this.userName = userName; }

        public String getUserAvatar() { return userAvatar; }
        public void setUserAvatar(String userAvatar) { this.userAvatar = userAvatar; }

        public boolean isInternal() { return isInternal; }
        public void setInternal(boolean isInternal) { this.isInternal = isInternal; }

        public List<Attachment> getAttachments() { return attachments; }
        public void setAttachments(List<Attachment> attachments) { this.attachments = attachments; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }

        public boolean isEdited() { return edited; }
        public void setEdited(boolean edited) { this.edited = edited; }
    }

    public static class ChangeLog {
        private String id;
        private String field;
        private String oldValue;
        private String newValue;
        private String changedBy;
        private String changedByName;
        private String changedAt;
        private String reason;

        // Getters and Setters
        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getField() { return field; }
        public void setField(String field) { this.field = field; }

        public String getOldValue() { return oldValue; }
        public void setOldValue(String oldValue) { this.oldValue = oldValue; }

        public String getNewValue() { return newValue; }
        public void setNewValue(String newValue) { this.newValue = newValue; }

        public String getChangedBy() { return changedBy; }
        public void setChangedBy(String changedBy) { this.changedBy = changedBy; }

        public String getChangedByName() { return changedByName; }
        public void setChangedByName(String changedByName) { this.changedByName = changedByName; }

        public String getChangedAt() { return changedAt; }
        public void setChangedAt(String changedAt) { this.changedAt = changedAt; }

        public String getReason() { return reason; }
        public void setReason(String reason) { this.reason = reason; }
    }

    @GetMapping("/{feedbackId}")
    public ResponseEntity<GetByIdResponse> getFeedbackById(
            @PathVariable String feedbackId) {

        // 创建请求对象用于打印
        GetByIdRequest request = new GetByIdRequest();
        request.setFeedbackId(feedbackId);

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证参数
            if (feedbackId == null || feedbackId.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new GetByIdResponse(false, "反馈ID不能为空", null)
                );
            }

            // 2. 查询反馈基本信息
            String feedbackSql = "SELECT f.*, u.username as user_name, u.email as user_email " +
                    "FROM user_feedback f " +
                    "LEFT JOIN users u ON f.user_id = u.user_id " +
                    "WHERE f.feedback_id = ?";

            List<Map<String, Object>> feedbackList = jdbcTemplate.queryForList(feedbackSql, feedbackId);
            printQueryResult("反馈基本信息: " + feedbackList);

            if (feedbackList.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new GetByIdResponse(false, "未找到指定的反馈", null)
                );
            }

            Map<String, Object> feedback = feedbackList.get(0);

            // 3. 更新查看次数
            String updateViewSql = "UPDATE user_feedback SET view_count = view_count + 1 WHERE feedback_id = ?";
            jdbcTemplate.update(updateViewSql, feedbackId);

            // 4. 查询投票信息
            List<String> upvotedBy = getVotedUsers(feedbackId, "upvote");
            List<String> downvotedBy = getVotedUsers(feedbackId, "downvote");

            // 5. 查询回复/评论
            List<Comment> comments = getFeedbackComments(feedbackId);

            // 6. 查询变更日志
            List<ChangeLog> changeLog = getFeedbackChangeLog(feedbackId);

            // 7. 处理attachments JSON
            List<Attachment> attachments = new ArrayList<>();
            String attachmentsJson = (String) feedback.get("attachments");
            if (attachmentsJson != null && !attachmentsJson.isEmpty() && !"[]".equals(attachmentsJson)) {
                try {
                    List<Map<String, Object>> attachmentList = objectMapper.readValue(
                            attachmentsJson, new TypeReference<List<Map<String, Object>>>() {});

                    for (Map<String, Object> att : attachmentList) {
                        Attachment attachment = new Attachment();
                        attachment.setId("att_" + UUID.randomUUID().toString().substring(0, 8));
                        attachment.setName((String) att.get("name"));
                        attachment.setUrl((String) att.get("url"));
                        attachment.setSize(((Number) att.get("size")).longValue());

                        // 根据文件名猜测类型
                        String name = attachment.getName().toLowerCase();
                        if (name.endsWith(".png") || name.endsWith(".jpg") || name.endsWith(".jpeg") || name.endsWith(".gif")) {
                            attachment.setType("image");
                        } else if (name.endsWith(".pdf")) {
                            attachment.setType("pdf");
                        } else if (name.endsWith(".doc") || name.endsWith(".docx")) {
                            attachment.setType("document");
                        } else {
                            attachment.setType("file");
                        }

                        attachments.add(attachment);
                    }
                } catch (Exception e) {
                    System.err.println("解析attachments失败: " + e.getMessage());
                }
            }

            // 8. 处理metadata JSON
            Map<String, Object> metadata = new HashMap<>();
            String metadataJson = (String) feedback.get("metadata");
            if (metadataJson != null && !metadataJson.isEmpty() && !"{}".equals(metadataJson)) {
                try {
                    metadata = objectMapper.readValue(metadataJson, new TypeReference<Map<String, Object>>() {});
                } catch (Exception e) {
                    System.err.println("解析metadata失败: " + e.getMessage());
                }
            }

            // 9. 构建响应数据
            FeedbackDetailData detailData = new FeedbackDetailData();
            detailData.setId(feedbackId);
            detailData.setType((String) feedback.get("type"));
            detailData.setTitle((String) feedback.get("title"));
            detailData.setContent((String) feedback.get("content"));
            detailData.setStatus((String) feedback.get("status"));
            detailData.setPriority((String) feedback.get("priority"));
            detailData.setUpvotes(((Number) feedback.get("upvotes")).intValue());
            detailData.setDownvotes(((Number) feedback.get("downvotes")).intValue());
            detailData.setUpvotedBy(upvotedBy);
            detailData.setDownvotedBy(downvotedBy);
            detailData.setUserId((String) feedback.get("user_id"));
            detailData.setUserName((String) feedback.get("user_name"));
            detailData.setUserEmail((String) feedback.get("user_email"));
            detailData.setAttachments(attachments);
            detailData.setComments(comments);
            detailData.setMetadata(metadata);
            detailData.setViewCount(((Number) feedback.get("view_count")).intValue());
            detailData.setCommentCount(comments.size());
            detailData.setRelatedFeedback(new ArrayList<>()); // 简化处理，实际需要查询相关反馈
            detailData.setChangeLog(changeLog);
            detailData.setEstimatedCompletion(feedback.get("estimated_completion") != null ?
                    feedback.get("estimated_completion").toString() : null);
            detailData.setCreatedAt(feedback.get("created_at").toString());
            detailData.setUpdatedAt(feedback.get("updated_at").toString());
            detailData.setAssignedTo((String) feedback.get("assigned_to"));
            detailData.setAssignedAt(feedback.get("assigned_at") != null ?
                    feedback.get("assigned_at").toString() : null);
            detailData.setCompletedAt(feedback.get("completed_at") != null ?
                    feedback.get("completed_at").toString() : null);

            GetByIdResponse response = new GetByIdResponse(true, "获取反馈详情成功", detailData);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取反馈详情过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new GetByIdResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private List<String> getVotedUsers(String feedbackId, String voteType) {
        List<String> users = new ArrayList<>();
        try {
            String sql = "SELECT user_id FROM feedback_votes WHERE feedback_id = ? AND vote_type = ?";
            List<Map<String, Object>> votes = jdbcTemplate.queryForList(sql, feedbackId, voteType);

            for (Map<String, Object> vote : votes) {
                users.add((String) vote.get("user_id"));
            }
        } catch (Exception e) {
            System.err.println("获取投票用户失败: " + e.getMessage());
        }
        return users;
    }

    private List<Comment> getFeedbackComments(String feedbackId) {
        List<Comment> comments = new ArrayList<>();
        try {
            String sql = "SELECT r.*, u.username as user_name, u.avatar_url as user_avatar " +
                    "FROM feedback_replies r " +
                    "LEFT JOIN users u ON r.user_id = u.user_id " +
                    "WHERE r.feedback_id = ? " +
                    "ORDER BY r.created_at ASC";

            List<Map<String, Object>> replyList = jdbcTemplate.queryForList(sql, feedbackId);

            for (Map<String, Object> reply : replyList) {
                Comment comment = new Comment();
                comment.setId("cmt_" + reply.get("reply_id"));
                comment.setContent((String) reply.get("message"));
                comment.setUserId((String) reply.get("user_id"));
                comment.setUserName((String) reply.get("user_name"));
                comment.setUserAvatar((String) reply.get("user_avatar"));
                comment.setInternal((Boolean) reply.get("is_internal"));
                comment.setCreatedAt(reply.get("created_at").toString());
                comment.setUpdatedAt(reply.get("updated_at").toString());
                comment.setEdited(!reply.get("created_at").equals(reply.get("updated_at")));
                comment.setAttachments(new ArrayList<>()); // 简化处理

                comments.add(comment);
            }
        } catch (Exception e) {
            System.err.println("获取评论失败: " + e.getMessage());
        }
        return comments;
    }

    private List<ChangeLog> getFeedbackChangeLog(String feedbackId) {
        List<ChangeLog> changeLogs = new ArrayList<>();
        try {
            String sql = "SELECT l.*, u.username as changed_by_name " +
                    "FROM feedback_change_log l " +
                    "LEFT JOIN users u ON l.changed_by = u.user_id " +
                    "WHERE l.feedback_id = ? " +
                    "ORDER BY l.created_at ASC";

            List<Map<String, Object>> logList = jdbcTemplate.queryForList(sql, feedbackId);

            for (Map<String, Object> log : logList) {
                ChangeLog changeLog = new ChangeLog();
                changeLog.setId("log_" + log.get("log_id"));
                changeLog.setField((String) log.get("field"));
                changeLog.setOldValue((String) log.get("old_value"));
                changeLog.setNewValue((String) log.get("new_value"));
                changeLog.setChangedBy((String) log.get("changed_by"));
                changeLog.setChangedByName((String) log.get("changed_by_name"));
                changeLog.setChangedAt(log.get("created_at").toString());
                changeLog.setReason((String) log.get("reason"));

                changeLogs.add(changeLog);
            }
        } catch (Exception e) {
            System.err.println("获取变更日志失败: " + e.getMessage());
        }
        return changeLogs;
    }
}
--- 结束文件: FeedbackGetById.java ---

--- 开始文件: FeedbackGetCategories.java ---
package com.vue.readingapp.feedback;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.UUID;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.core.type.TypeReference;

@RestController
@RequestMapping("/api/v1/feedback")
public class FeedbackGetCategories {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取反馈分类请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=======================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class GetCategoriesResponse {
        private boolean success;
        private String message;
        private List<CategoryData> data;

        public GetCategoriesResponse(boolean success, String message, List<CategoryData> data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public List<CategoryData> getData() { return data; }
        public void setData(List<CategoryData> data) { this.data = data; }
    }

    public static class CategoryData {
        private String id;
        private String name;
        private String value;
        private String description;
        private String icon;
        private String color;

        public CategoryData(String id, String name, String value, String description, String icon, String color) {
            this.id = id;
            this.name = name;
            this.value = value;
            this.description = description;
            this.icon = icon;
            this.color = color;
        }

        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getValue() { return value; }
        public void setValue(String value) { this.value = value; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }

        public String getIcon() { return icon; }
        public void setIcon(String icon) { this.icon = icon; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }
    }

    @GetMapping("/categories")
    public ResponseEntity<GetCategoriesResponse> getFeedbackCategories() {

        // 打印接收到的请求
        printRequest("获取所有反馈分类");

        try {
            // 1. 查询所有激活的分类
            String sql = "SELECT category_id, name, value, description, icon, color " +
                    "FROM feedback_categories " +
                    "WHERE is_active = TRUE " +
                    "ORDER BY order_index, name";

            List<Map<String, Object>> categoryList = jdbcTemplate.queryForList(sql);
            printQueryResult("查询到 " + categoryList.size() + " 个分类");

            // 2. 转换数据
            List<CategoryData> categories = new ArrayList<>();

            // 添加默认分类
            categories.add(new CategoryData("bug", "错误报告", "bug", "系统功能异常或错误", "bug", "#F44336"));
            categories.add(new CategoryData("feature", "功能建议", "feature", "新功能或改进建议", "light-bulb", "#2196F3"));
            categories.add(new CategoryData("improvement", "改进建议", "improvement", "现有功能优化建议", "chart-bar", "#4CAF50"));
            categories.add(new CategoryData("question", "问题咨询", "question", "使用问题或咨询", "question-mark-circle", "#FF9800"));
            categories.add(new CategoryData("other", "其他反馈", "other", "其他类型的反馈", "chat-alt-2", "#9C27B0"));

            // 添加数据库中的自定义分类
            for (Map<String, Object> row : categoryList) {
                CategoryData category = new CategoryData(
                        String.valueOf(row.get("category_id")),
                        (String) row.get("name"),
                        (String) row.get("value"),
                        (String) row.get("description"),
                        (String) row.get("icon"),
                        (String) row.get("color")
                );
                categories.add(category);
            }

            // 3. 准备响应数据
            GetCategoriesResponse response = new GetCategoriesResponse(
                    true, "获取反馈分类成功", categories
            );

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取反馈分类过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new GetCategoriesResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: FeedbackGetCategories.java ---

--- 开始文件: FeedbackGetDetail.java ---
package com.vue.readingapp.feedback;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.UUID;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.core.type.TypeReference;

@RestController
@RequestMapping("/api/v1/feedback")
public class FeedbackGetDetail {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取反馈详情请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=======================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class GetDetailRequest {
        private String feedbackId;

        public String getFeedbackId() { return feedbackId; }
        public void setFeedbackId(String feedbackId) { this.feedbackId = feedbackId; }
    }

    // 响应DTO
    public static class GetDetailResponse {
        private boolean success;
        private String message;
        private FeedbackDetailData data;

        public GetDetailResponse(boolean success, String message, FeedbackDetailData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public FeedbackDetailData getData() { return data; }
        public void setData(FeedbackDetailData data) { this.data = data; }
    }

    public static class FeedbackDetailData {
        private String id;
        private String type;
        private String title;
        private String content;
        private String status;
        private String priority;
        private int upvotes;
        private int downvotes;
        private List<String> upvotedBy;
        private List<String> downvotedBy;
        private String userId;
        private String userName;
        private String userEmail;
        private List<Attachment> attachments;
        private List<Comment> comments;
        private Map<String, Object> metadata;
        private int viewCount;
        private int commentCount;
        private List<String> relatedFeedback;
        private List<ChangeLog> changeLog;
        private String estimatedCompletion;
        private String createdAt;
        private String updatedAt;
        private String assignedTo;
        private String assignedAt;
        private String completedAt;

        // Getters and Setters
        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public String getTitle() { return title; }
        public void setTitle(String title) { this.title = title; }

        public String getContent() { return content; }
        public void setContent(String content) { this.content = content; }

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public String getPriority() { return priority; }
        public void setPriority(String priority) { this.priority = priority; }

        public int getUpvotes() { return upvotes; }
        public void setUpvotes(int upvotes) { this.upvotes = upvotes; }

        public int getDownvotes() { return downvotes; }
        public void setDownvotes(int downvotes) { this.downvotes = downvotes; }

        public List<String> getUpvotedBy() { return upvotedBy; }
        public void setUpvotedBy(List<String> upvotedBy) { this.upvotedBy = upvotedBy; }

        public List<String> getDownvotedBy() { return downvotedBy; }
        public void setDownvotedBy(List<String> downvotedBy) { this.downvotedBy = downvotedBy; }

        public String getUserId() { return userId; }
        public void setUserId(String userId) { this.userId = userId; }

        public String getUserName() { return userName; }
        public void setUserName(String userName) { this.userName = userName; }

        public String getUserEmail() { return userEmail; }
        public void setUserEmail(String userEmail) { this.userEmail = userEmail; }

        public List<Attachment> getAttachments() { return attachments; }
        public void setAttachments(List<Attachment> attachments) { this.attachments = attachments; }

        public List<Comment> getComments() { return comments; }
        public void setComments(List<Comment> comments) { this.comments = comments; }

        public Map<String, Object> getMetadata() { return metadata; }
        public void setMetadata(Map<String, Object> metadata) { this.metadata = metadata; }

        public int getViewCount() { return viewCount; }
        public void setViewCount(int viewCount) { this.viewCount = viewCount; }

        public int getCommentCount() { return commentCount; }
        public void setCommentCount(int commentCount) { this.commentCount = commentCount; }

        public List<String> getRelatedFeedback() { return relatedFeedback; }
        public void setRelatedFeedback(List<String> relatedFeedback) { this.relatedFeedback = relatedFeedback; }

        public List<ChangeLog> getChangeLog() { return changeLog; }
        public void setChangeLog(List<ChangeLog> changeLog) { this.changeLog = changeLog; }

        public String getEstimatedCompletion() { return estimatedCompletion; }
        public void setEstimatedCompletion(String estimatedCompletion) { this.estimatedCompletion = estimatedCompletion; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }

        public String getAssignedTo() { return assignedTo; }
        public void setAssignedTo(String assignedTo) { this.assignedTo = assignedTo; }

        public String getAssignedAt() { return assignedAt; }
        public void setAssignedAt(String assignedAt) { this.assignedAt = assignedAt; }

        public String getCompletedAt() { return completedAt; }
        public void setCompletedAt(String completedAt) { this.completedAt = completedAt; }
    }

    public static class Attachment {
        private String id;
        private String name;
        private String url;
        private long size;
        private String type;

        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getUrl() { return url; }
        public void setUrl(String url) { this.url = url; }

        public long getSize() { return size; }
        public void setSize(long size) { this.size = size; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }
    }

    public static class Comment {
        private String id;
        private String content;
        private String userId;
        private String userName;
        private String userAvatar;
        private boolean isInternal;
        private List<Attachment> attachments;
        private String createdAt;
        private String updatedAt;
        private boolean edited;

        // Getters and Setters
        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getContent() { return content; }
        public void setContent(String content) { this.content = content; }

        public String getUserId() { return userId; }
        public void setUserId(String userId) { this.userId = userId; }

        public String getUserName() { return userName; }
        public void setUserName(String userName) { this.userName = userName; }

        public String getUserAvatar() { return userAvatar; }
        public void setUserAvatar(String userAvatar) { this.userAvatar = userAvatar; }

        public boolean isInternal() { return isInternal; }
        public void setInternal(boolean isInternal) { this.isInternal = isInternal; }

        public List<Attachment> getAttachments() { return attachments; }
        public void setAttachments(List<Attachment> attachments) { this.attachments = attachments; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }

        public boolean isEdited() { return edited; }
        public void setEdited(boolean edited) { this.edited = edited; }
    }

    public static class ChangeLog {
        private String id;
        private String field;
        private String oldValue;
        private String newValue;
        private String changedBy;
        private String changedByName;
        private String changedAt;
        private String reason;

        // Getters and Setters
        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getField() { return field; }
        public void setField(String field) { this.field = field; }

        public String getOldValue() { return oldValue; }
        public void setOldValue(String oldValue) { this.oldValue = oldValue; }

        public String getNewValue() { return newValue; }
        public void setNewValue(String newValue) { this.newValue = newValue; }

        public String getChangedBy() { return changedBy; }
        public void setChangedBy(String changedBy) { this.changedBy = changedBy; }

        public String getChangedByName() { return changedByName; }
        public void setChangedByName(String changedByName) { this.changedByName = changedByName; }

        public String getChangedAt() { return changedAt; }
        public void setChangedAt(String changedAt) { this.changedAt = changedAt; }

        public String getReason() { return reason; }
        public void setReason(String reason) { this.reason = reason; }
    }

    @GetMapping("/detail/{feedbackId}")
    public ResponseEntity<GetDetailResponse> getFeedbackDetail(
            @PathVariable String feedbackId) {

        // 创建请求对象用于打印
        GetDetailRequest request = new GetDetailRequest();
        request.setFeedbackId(feedbackId);

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证参数
            if (feedbackId == null || feedbackId.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new GetDetailResponse(false, "反馈ID不能为空", null)
                );
            }

            // 2. 查询反馈基本信息
            String feedbackSql = "SELECT f.*, u.username as user_name, u.email as user_email " +
                    "FROM user_feedback f " +
                    "LEFT JOIN users u ON f.user_id = u.user_id " +
                    "WHERE f.feedback_id = ?";

            List<Map<String, Object>> feedbackList = jdbcTemplate.queryForList(feedbackSql, feedbackId);
            printQueryResult("反馈基本信息: " + feedbackList);

            if (feedbackList.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new GetDetailResponse(false, "未找到指定的反馈", null)
                );
            }

            Map<String, Object> feedback = feedbackList.get(0);

            // 3. 更新查看次数
            String updateViewSql = "UPDATE user_feedback SET view_count = view_count + 1 WHERE feedback_id = ?";
            jdbcTemplate.update(updateViewSql, feedbackId);

            // 4. 查询投票信息
            List<String> upvotedBy = getVotedUsers(feedbackId, "upvote");
            List<String> downvotedBy = getVotedUsers(feedbackId, "downvote");

            // 5. 查询评论
            List<Comment> comments = getFeedbackComments(feedbackId);

            // 6. 查询变更日志
            List<ChangeLog> changeLog = getFeedbackChangeLog(feedbackId);

            // 7. 处理attachments JSON
            List<Attachment> attachments = new ArrayList<>();
            String attachmentsJson = (String) feedback.get("attachments");
            if (attachmentsJson != null && !attachmentsJson.isEmpty() && !"[]".equals(attachmentsJson)) {
                try {
                    List<Map<String, Object>> attachmentList = objectMapper.readValue(
                            attachmentsJson, new TypeReference<List<Map<String, Object>>>() {});

                    for (Map<String, Object> att : attachmentList) {
                        Attachment attachment = new Attachment();
                        attachment.setId("att_" + UUID.randomUUID().toString().substring(0, 8));
                        attachment.setName((String) att.get("name"));
                        attachment.setUrl((String) att.get("url"));
                        attachment.setSize(((Number) att.get("size")).longValue());

                        // 根据文件名猜测类型
                        String name = attachment.getName().toLowerCase();
                        if (name.endsWith(".png") || name.endsWith(".jpg") || name.endsWith(".jpeg") || name.endsWith(".gif")) {
                            attachment.setType("image");
                        } else if (name.endsWith(".pdf")) {
                            attachment.setType("pdf");
                        } else if (name.endsWith(".doc") || name.endsWith(".docx")) {
                            attachment.setType("document");
                        } else {
                            attachment.setType("file");
                        }

                        attachments.add(attachment);
                    }
                } catch (Exception e) {
                    System.err.println("解析attachments失败: " + e.getMessage());
                }
            }

            // 8. 处理metadata JSON
            Map<String, Object> metadata = new HashMap<>();
            String metadataJson = (String) feedback.get("metadata");
            if (metadataJson != null && !metadataJson.isEmpty() && !"{}".equals(metadataJson)) {
                try {
                    metadata = objectMapper.readValue(metadataJson, new TypeReference<Map<String, Object>>() {});
                } catch (Exception e) {
                    System.err.println("解析metadata失败: " + e.getMessage());
                }
            }

            // 9. 查询相关反馈（简化处理：查询同一用户的其他反馈）
            List<String> relatedFeedback = getRelatedFeedback(feedbackId, (String) feedback.get("user_id"));

            // 10. 构建响应数据
            FeedbackDetailData detailData = new FeedbackDetailData();
            detailData.setId(feedbackId);
            detailData.setType((String) feedback.get("type"));
            detailData.setTitle((String) feedback.get("title"));
            detailData.setContent((String) feedback.get("content"));
            detailData.setStatus((String) feedback.get("status"));
            detailData.setPriority((String) feedback.get("priority"));
            detailData.setUpvotes(((Number) feedback.get("upvotes")).intValue());
            detailData.setDownvotes(((Number) feedback.get("downvotes")).intValue());
            detailData.setUpvotedBy(upvotedBy);
            detailData.setDownvotedBy(downvotedBy);
            detailData.setUserId((String) feedback.get("user_id"));
            detailData.setUserName((String) feedback.get("user_name"));
            detailData.setUserEmail((String) feedback.get("user_email"));
            detailData.setAttachments(attachments);
            detailData.setComments(comments);
            detailData.setMetadata(metadata);
            detailData.setViewCount(((Number) feedback.get("view_count")).intValue());
            detailData.setCommentCount(comments.size());
            detailData.setRelatedFeedback(relatedFeedback);
            detailData.setChangeLog(changeLog);
            detailData.setEstimatedCompletion(feedback.get("estimated_completion") != null ?
                    feedback.get("estimated_completion").toString() : null);
            detailData.setCreatedAt(feedback.get("created_at").toString());
            detailData.setUpdatedAt(feedback.get("updated_at").toString());
            detailData.setAssignedTo((String) feedback.get("assigned_to"));
            detailData.setAssignedAt(feedback.get("assigned_at") != null ?
                    feedback.get("assigned_at").toString() : null);
            detailData.setCompletedAt(feedback.get("completed_at") != null ?
                    feedback.get("completed_at").toString() : null);

            GetDetailResponse response = new GetDetailResponse(
                    true, "获取反馈详情成功", detailData
            );

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取反馈详情过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new GetDetailResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private List<String> getVotedUsers(String feedbackId, String voteType) {
        List<String> users = new ArrayList<>();
        try {
            String sql = "SELECT user_id FROM feedback_votes WHERE feedback_id = ? AND vote_type = ?";
            List<Map<String, Object>> votes = jdbcTemplate.queryForList(sql, feedbackId, voteType);

            for (Map<String, Object> vote : votes) {
                users.add((String) vote.get("user_id"));
            }
        } catch (Exception e) {
            System.err.println("获取投票用户失败: " + e.getMessage());
        }
        return users;
    }

    private List<Comment> getFeedbackComments(String feedbackId) {
        List<Comment> comments = new ArrayList<>();
        try {
            String sql = "SELECT r.*, u.username as user_name, u.avatar_url as user_avatar " +
                    "FROM feedback_replies r " +
                    "LEFT JOIN users u ON r.user_id = u.user_id " +
                    "WHERE r.feedback_id = ? " +
                    "ORDER BY r.created_at ASC";

            List<Map<String, Object>> replyList = jdbcTemplate.queryForList(sql, feedbackId);

            for (Map<String, Object> reply : replyList) {
                Comment comment = new Comment();
                comment.setId("cmt_" + reply.get("reply_id"));
                comment.setContent((String) reply.get("message"));
                comment.setUserId((String) reply.get("user_id"));
                comment.setUserName((String) reply.get("user_name"));
                comment.setUserAvatar((String) reply.get("user_avatar"));
                comment.setInternal((Boolean) reply.get("is_internal"));
                comment.setCreatedAt(reply.get("created_at").toString());
                comment.setUpdatedAt(reply.get("updated_at").toString());
                comment.setEdited(!reply.get("created_at").equals(reply.get("updated_at")));
                comment.setAttachments(new ArrayList<>()); // 简化处理

                comments.add(comment);
            }
        } catch (Exception e) {
            System.err.println("获取评论失败: " + e.getMessage());
        }
        return comments;
    }

    private List<ChangeLog> getFeedbackChangeLog(String feedbackId) {
        List<ChangeLog> changeLogs = new ArrayList<>();
        try {
            String sql = "SELECT l.*, u.username as changed_by_name " +
                    "FROM feedback_change_log l " +
                    "LEFT JOIN users u ON l.changed_by = u.user_id " +
                    "WHERE l.feedback_id = ? " +
                    "ORDER BY l.created_at DESC";

            List<Map<String, Object>> logList = jdbcTemplate.queryForList(sql, feedbackId);

            for (Map<String, Object> log : logList) {
                ChangeLog changeLog = new ChangeLog();
                changeLog.setId("log_" + log.get("log_id"));
                changeLog.setField((String) log.get("field"));
                changeLog.setOldValue((String) log.get("old_value"));
                changeLog.setNewValue((String) log.get("new_value"));
                changeLog.setChangedBy((String) log.get("changed_by"));
                changeLog.setChangedByName((String) log.get("changed_by_name"));
                changeLog.setChangedAt(log.get("created_at").toString());
                changeLog.setReason((String) log.get("reason"));

                changeLogs.add(changeLog);
            }
        } catch (Exception e) {
            System.err.println("获取变更日志失败: " + e.getMessage());
        }
        return changeLogs;
    }

    private List<String> getRelatedFeedback(String feedbackId, String userId) {
        List<String> relatedFeedback = new ArrayList<>();
        try {
            // 查询同一用户的其他反馈（排除当前反馈）
            String sql = "SELECT feedback_id FROM user_feedback WHERE user_id = ? AND feedback_id != ? ORDER BY created_at DESC LIMIT 5";
            List<Map<String, Object>> feedbackList = jdbcTemplate.queryForList(sql, userId, feedbackId);

            for (Map<String, Object> row : feedbackList) {
                relatedFeedback.add((String) row.get("feedback_id"));
            }
        } catch (Exception e) {
            System.err.println("获取相关反馈失败: " + e.getMessage());
        }
        return relatedFeedback;
    }
}
--- 结束文件: FeedbackGetDetail.java ---

--- 开始文件: FeedbackGetReplies.java ---
package com.vue.readingapp.feedback;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.UUID;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.core.type.TypeReference;

@RestController
@RequestMapping("/api/v1/feedback")
public class FeedbackGetReplies {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取反馈回复请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=======================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class GetRepliesRequest {
        private String feedbackId;
        private Integer page;
        private Integer pageSize;
        private Boolean includeInternal;

        public String getFeedbackId() { return feedbackId; }
        public void setFeedbackId(String feedbackId) { this.feedbackId = feedbackId; }

        public Integer getPage() { return page; }
        public void setPage(Integer page) { this.page = page; }

        public Integer getPageSize() { return pageSize; }
        public void setPageSize(Integer pageSize) { this.pageSize = pageSize; }

        public Boolean getIncludeInternal() { return includeInternal; }
        public void setIncludeInternal(Boolean includeInternal) { this.includeInternal = includeInternal; }
    }

    // 响应DTO
    public static class GetRepliesResponse {
        private boolean success;
        private String message;
        private RepliesData data;

        public GetRepliesResponse(boolean success, String message, RepliesData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public RepliesData getData() { return data; }
        public void setData(RepliesData data) { this.data = data; }
    }

    public static class RepliesData {
        private int total;
        private int page;
        private int pageSize;
        private int totalPages;
        private List<ReplyDetail> replies;

        public RepliesData(int total, int page, int pageSize, int totalPages, List<ReplyDetail> replies) {
            this.total = total;
            this.page = page;
            this.pageSize = pageSize;
            this.totalPages = totalPages;
            this.replies = replies;
        }

        public int getTotal() { return total; }
        public void setTotal(int total) { this.total = total; }

        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public int getPageSize() { return pageSize; }
        public void setPageSize(int pageSize) { this.pageSize = pageSize; }

        public int getTotalPages() { return totalPages; }
        public void setTotalPages(int totalPages) { this.totalPages = totalPages; }

        public List<ReplyDetail> getReplies() { return replies; }
        public void setReplies(List<ReplyDetail> replies) { this.replies = replies; }
    }

    public static class ReplyDetail {
        private String id;
        private String feedbackId;
        private String message;
        private String userId;
        private String userName;
        private String userAvatar;
        private boolean isInternal;
        private List<Map<String, Object>> attachments;
        private String createdAt;
        private String updatedAt;
        private boolean edited;

        // Getters and Setters
        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getFeedbackId() { return feedbackId; }
        public void setFeedbackId(String feedbackId) { this.feedbackId = feedbackId; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public String getUserId() { return userId; }
        public void setUserId(String userId) { this.userId = userId; }

        public String getUserName() { return userName; }
        public void setUserName(String userName) { this.userName = userName; }

        public String getUserAvatar() { return userAvatar; }
        public void setUserAvatar(String userAvatar) { this.userAvatar = userAvatar; }

        public boolean isInternal() { return isInternal; }
        public void setInternal(boolean isInternal) { this.isInternal = isInternal; }

        public List<Map<String, Object>> getAttachments() { return attachments; }
        public void setAttachments(List<Map<String, Object>> attachments) { this.attachments = attachments; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }

        public boolean isEdited() { return edited; }
        public void setEdited(boolean edited) { this.edited = edited; }
    }

    @GetMapping("/{feedbackId}/replies")
    public ResponseEntity<GetRepliesResponse> getFeedbackReplies(
            @PathVariable String feedbackId,
            @RequestParam(defaultValue = "1") Integer page,
            @RequestParam(defaultValue = "20") Integer pageSize,
            @RequestParam(defaultValue = "false") Boolean includeInternal) {

        // 创建请求对象用于打印
        GetRepliesRequest request = new GetRepliesRequest();
        request.setFeedbackId(feedbackId);
        request.setPage(page);
        request.setPageSize(pageSize);
        request.setIncludeInternal(includeInternal);

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证参数
            if (feedbackId == null || feedbackId.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new GetRepliesResponse(false, "反馈ID不能为空", null)
                );
            }

            // 2. 参数验证和默认值设置
            if (page == null || page < 1) page = 1;
            if (pageSize == null || pageSize < 1) pageSize = 20;
            if (pageSize > 100) pageSize = 100;

            // 3. 检查反馈是否存在
            String checkSql = "SELECT feedback_id FROM user_feedback WHERE feedback_id = ?";
            List<Map<String, Object>> feedbackList = jdbcTemplate.queryForList(checkSql, feedbackId);

            if (feedbackList.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new GetRepliesResponse(false, "未找到指定的反馈", null)
                );
            }

            // 4. 构建查询条件
            List<Object> params = new ArrayList<>();
            StringBuilder whereClause = new StringBuilder(" WHERE feedback_id = ? ");
            params.add(feedbackId);

            // 处理是否包含内部回复
            if (!includeInternal) {
                whereClause.append(" AND is_internal = false ");
            }

            // 5. 获取总数
            String countSql = "SELECT COUNT(*) as total FROM feedback_replies " + whereClause.toString();
            Integer total = jdbcTemplate.queryForObject(countSql, Integer.class, params.toArray());
            if (total == null) total = 0;

            // 6. 计算分页
            int totalPages = (int) Math.ceil((double) total / pageSize);
            int offset = (page - 1) * pageSize;

            // 7. 查询回复数据
            String querySql = "SELECT r.*, u.username as user_name, u.avatar_url as user_avatar " +
                    "FROM feedback_replies r " +
                    "LEFT JOIN users u ON r.user_id = u.user_id " +
                    whereClause.toString() +
                    " ORDER BY r.created_at ASC " +
                    " LIMIT ? OFFSET ?";

            List<Object> queryParams = new ArrayList<>(params);
            queryParams.add(pageSize);
            queryParams.add(offset);

            List<Map<String, Object>> replyList = jdbcTemplate.queryForList(querySql, queryParams.toArray());
            printQueryResult("查询到 " + replyList.size() + " 条回复");

            // 8. 转换数据
            List<ReplyDetail> replies = new ArrayList<>();
            for (Map<String, Object> row : replyList) {
                ReplyDetail reply = new ReplyDetail();
                reply.setId((String) row.get("reply_id"));
                reply.setFeedbackId((String) row.get("feedback_id"));
                reply.setMessage((String) row.get("message"));
                reply.setUserId((String) row.get("user_id"));
                reply.setUserName((String) row.get("user_name"));
                reply.setUserAvatar((String) row.get("user_avatar"));
                reply.setInternal((Boolean) row.get("is_internal"));
                reply.setCreatedAt(row.get("created_at").toString());
                reply.setUpdatedAt(row.get("updated_at").toString());
                reply.setEdited(!row.get("created_at").equals(row.get("updated_at")));

                // 处理attachments JSON
                String attachmentsJson = (String) row.get("attachments");
                if (attachmentsJson != null && !attachmentsJson.isEmpty() && !"[]".equals(attachmentsJson)) {
                    try {
                        List<Map<String, Object>> attachments = objectMapper.readValue(
                                attachmentsJson, new TypeReference<List<Map<String, Object>>>() {});
                        reply.setAttachments(attachments);
                    } catch (Exception e) {
                        reply.setAttachments(new ArrayList<>());
                    }
                } else {
                    reply.setAttachments(new ArrayList<>());
                }

                replies.add(reply);
            }

            // 9. 准备响应数据
            RepliesData repliesData = new RepliesData(
                    total, page, pageSize, totalPages, replies
            );

            GetRepliesResponse response = new GetRepliesResponse(
                    true, "获取反馈回复成功", repliesData
            );

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取反馈回复过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new GetRepliesResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: FeedbackGetReplies.java ---

--- 开始文件: FeedbackGetStatistics.java ---
package com.vue.readingapp.feedback;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.UUID;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import java.util.LinkedHashMap;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.core.type.TypeReference;

@RestController
@RequestMapping("/api/v1/feedback")
public class FeedbackGetStatistics {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();
    private DateTimeFormatter dateFormatter = DateTimeFormatter.ofPattern("yyyy-MM-dd");
    private DateTimeFormatter monthFormatter = DateTimeFormatter.ofPattern("yyyy-MM");

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取详细统计请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=======================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class GetStatisticsRequest {
        private String timeRange;
        private String type;
        private String status;
        private String priority;

        public String getTimeRange() { return timeRange; }
        public void setTimeRange(String timeRange) { this.timeRange = timeRange; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public String getPriority() { return priority; }
        public void setPriority(String priority) { this.priority = priority; }
    }

    // 响应DTO
    public static class GetStatisticsResponse {
        private boolean success;
        private String message;
        private StatisticsData data;

        public GetStatisticsResponse(boolean success, String message, StatisticsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public StatisticsData getData() { return data; }
        public void setData(StatisticsData data) { this.data = data; }
    }

    public static class StatisticsData {
        private int total;
        private Map<String, Integer> byType;
        private Map<String, Integer> byStatus;
        private Map<String, Integer> byPriority;
        private Map<String, Integer> byDay;
        private Map<String, Integer> byMonth;
        private List<Map<String, Object>> topContributors;
        private List<Map<String, Object>> recentActivity;
        private int averageResponseTime;
        private double resolutionRate;
        private double satisfactionScore;
        private Map<String, Object> trends;

        public StatisticsData(int total, Map<String, Integer> byType, Map<String, Integer> byStatus,
                              Map<String, Integer> byPriority, Map<String, Integer> byDay,
                              Map<String, Integer> byMonth, List<Map<String, Object>> topContributors,
                              List<Map<String, Object>> recentActivity, int averageResponseTime,
                              double resolutionRate, double satisfactionScore, Map<String, Object> trends) {
            this.total = total;
            this.byType = byType;
            this.byStatus = byStatus;
            this.byPriority = byPriority;
            this.byDay = byDay;
            this.byMonth = byMonth;
            this.topContributors = topContributors;
            this.recentActivity = recentActivity;
            this.averageResponseTime = averageResponseTime;
            this.resolutionRate = resolutionRate;
            this.satisfactionScore = satisfactionScore;
            this.trends = trends;
        }

        public int getTotal() { return total; }
        public void setTotal(int total) { this.total = total; }

        public Map<String, Integer> getByType() { return byType; }
        public void setByType(Map<String, Integer> byType) { this.byType = byType; }

        public Map<String, Integer> getByStatus() { return byStatus; }
        public void setByStatus(Map<String, Integer> byStatus) { this.byStatus = byStatus; }

        public Map<String, Integer> getByPriority() { return byPriority; }
        public void setByPriority(Map<String, Integer> byPriority) { this.byPriority = byPriority; }

        public Map<String, Integer> getByDay() { return byDay; }
        public void setByDay(Map<String, Integer> byDay) { this.byDay = byDay; }

        public Map<String, Integer> getByMonth() { return byMonth; }
        public void setByMonth(Map<String, Integer> byMonth) { this.byMonth = byMonth; }

        public List<Map<String, Object>> getTopContributors() { return topContributors; }
        public void setTopContributors(List<Map<String, Object>> topContributors) { this.topContributors = topContributors; }

        public List<Map<String, Object>> getRecentActivity() { return recentActivity; }
        public void setRecentActivity(List<Map<String, Object>> recentActivity) { this.recentActivity = recentActivity; }

        public int getAverageResponseTime() { return averageResponseTime; }
        public void setAverageResponseTime(int averageResponseTime) { this.averageResponseTime = averageResponseTime; }

        public double getResolutionRate() { return resolutionRate; }
        public void setResolutionRate(double resolutionRate) { this.resolutionRate = resolutionRate; }

        public double getSatisfactionScore() { return satisfactionScore; }
        public void setSatisfactionScore(double satisfactionScore) { this.satisfactionScore = satisfactionScore; }

        public Map<String, Object> getTrends() { return trends; }
        public void setTrends(Map<String, Object> trends) { this.trends = trends; }
    }

    @GetMapping("/statistics")
    public ResponseEntity<GetStatisticsResponse> getFeedbackStatistics(
            @RequestParam(defaultValue = "month") String timeRange,
            @RequestParam(required = false) String type,
            @RequestParam(required = false) String status,
            @RequestParam(required = false) String priority) {

        // 创建请求对象用于打印
        GetStatisticsRequest request = new GetStatisticsRequest();
        request.setTimeRange(timeRange);
        request.setType(type);
        request.setStatus(status);
        request.setPriority(priority);

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 构建基础查询条件
            List<Object> params = new ArrayList<>();
            StringBuilder whereClause = new StringBuilder(" WHERE 1=1 ");

            // 处理type条件
            if (type != null && !type.isEmpty() && !"all".equals(type)) {
                whereClause.append(" AND type = ? ");
                params.add(type);
            }

            // 处理status条件
            if (status != null && !status.isEmpty() && !"all".equals(status)) {
                whereClause.append(" AND status = ? ");
                params.add(status);
            }

            // 处理priority条件
            if (priority != null && !priority.isEmpty() && !"all".equals(priority)) {
                whereClause.append(" AND priority = ? ");
                params.add(priority);
            }

            // 处理时间范围条件
            String dateCondition = "";
            if ("week".equals(timeRange)) {
                dateCondition = " AND created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY) ";
            } else if ("month".equals(timeRange)) {
                dateCondition = " AND created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY) ";
            } else if ("quarter".equals(timeRange)) {
                dateCondition = " AND created_at >= DATE_SUB(NOW(), INTERVAL 90 DAY) ";
            } else if ("year".equals(timeRange)) {
                dateCondition = " AND created_at >= DATE_SUB(NOW(), INTERVAL 365 DAY) ";
            }
            whereClause.append(dateCondition);

            // 2. 获取总数
            String totalSql = "SELECT COUNT(*) as total FROM user_feedback " + whereClause.toString();
            Integer total = jdbcTemplate.queryForObject(totalSql, Integer.class, params.toArray());
            if (total == null) total = 0;

            // 3. 按类型统计
            Map<String, Integer> byType = getStatsByType(whereClause.toString(), params);

            // 4. 按状态统计
            Map<String, Integer> byStatus = getStatsByStatus(whereClause.toString(), params);

            // 5. 按优先级统计
            Map<String, Integer> byPriority = getStatsByPriority(whereClause.toString(), params);

            // 6. 按天统计
            Map<String, Integer> byDay = getStatsByDay(whereClause.toString(), params, timeRange);

            // 7. 按月统计
            Map<String, Integer> byMonth = getStatsByMonth(whereClause.toString(), params, timeRange);

            // 8. 获取顶级贡献者
            List<Map<String, Object>> topContributors = getTopContributors(whereClause.toString(), params);

            // 9. 获取最近活动
            List<Map<String, Object>> recentActivity = getRecentActivity(whereClause.toString(), params);

            // 10. 计算平均响应时间
            int averageResponseTime = calculateAverageResponseTime(whereClause.toString(), params);

            // 11. 计算解决率
            double resolutionRate = calculateResolutionRate(whereClause.toString(), params);

            // 12. 计算满意度分数
            double satisfactionScore = calculateSatisfactionScore(whereClause.toString(), params);

            // 13. 计算趋势
            Map<String, Object> trends = calculateTrends(whereClause.toString(), params, timeRange);

            // 14. 准备响应数据
            StatisticsData statisticsData = new StatisticsData(
                    total, byType, byStatus, byPriority, byDay, byMonth, topContributors,
                    recentActivity, averageResponseTime, resolutionRate, satisfactionScore, trends
            );

            GetStatisticsResponse response = new GetStatisticsResponse(
                    true, "获取详细统计成功", statisticsData
            );

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取详细统计过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new GetStatisticsResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private Map<String, Integer> getStatsByType(String whereClause, List<Object> params) {
        Map<String, Integer> result = new LinkedHashMap<>();

        try {
            String sql = "SELECT type, COUNT(*) as count FROM user_feedback " +
                    whereClause + " GROUP BY type ORDER BY count DESC";

            List<Map<String, Object>> rows = jdbcTemplate.queryForList(sql, params.toArray());

            // 初始化所有可能的类型
            List<String> allTypes = List.of("bug", "feature", "improvement", "question", "other");
            for (String type : allTypes) {
                result.put(type, 0);
            }

            // 填充实际数据
            for (Map<String, Object> row : rows) {
                String type = (String) row.get("type");
                int count = ((Number) row.get("count")).intValue();
                result.put(type, count);
            }

        } catch (Exception e) {
            System.err.println("按类型统计失败: " + e.getMessage());
        }

        return result;
    }

    private Map<String, Integer> getStatsByStatus(String whereClause, List<Object> params) {
        Map<String, Integer> result = new LinkedHashMap<>();

        try {
            String sql = "SELECT status, COUNT(*) as count FROM user_feedback " +
                    whereClause + " GROUP BY status ORDER BY FIELD(status, 'pending', 'reviewing', 'in_progress', 'completed', 'rejected', 'duplicate')";

            List<Map<String, Object>> rows = jdbcTemplate.queryForList(sql, params.toArray());

            // 初始化所有可能的状态
            List<String> allStatuses = List.of("pending", "reviewing", "in_progress", "completed", "rejected", "duplicate");
            for (String status : allStatuses) {
                result.put(status, 0);
            }

            // 填充实际数据
            for (Map<String, Object> row : rows) {
                String status = (String) row.get("status");
                int count = ((Number) row.get("count")).intValue();
                result.put(status, count);
            }

        } catch (Exception e) {
            System.err.println("按状态统计失败: " + e.getMessage());
        }

        return result;
    }

    private Map<String, Integer> getStatsByPriority(String whereClause, List<Object> params) {
        Map<String, Integer> result = new LinkedHashMap<>();

        try {
            String sql = "SELECT priority, COUNT(*) as count FROM user_feedback " +
                    whereClause + " GROUP BY priority ORDER BY FIELD(priority, 'critical', 'high', 'medium', 'low')";

            List<Map<String, Object>> rows = jdbcTemplate.queryForList(sql, params.toArray());

            // 初始化所有可能的优先级
            List<String> allPriorities = List.of("critical", "high", "medium", "low");
            for (String priority : allPriorities) {
                result.put(priority, 0);
            }

            // 填充实际数据
            for (Map<String, Object> row : rows) {
                String priority = (String) row.get("priority");
                int count = ((Number) row.get("count")).intValue();
                result.put(priority, count);
            }

        } catch (Exception e) {
            System.err.println("按优先级统计失败: " + e.getMessage());
        }

        return result;
    }

    private Map<String, Integer> getStatsByDay(String whereClause, List<Object> params, String timeRange) {
        Map<String, Integer> result = new LinkedHashMap<>();

        try {
            // 根据时间范围确定要查询的天数
            int daysToShow = 7; // 默认显示最近7天
            if ("week".equals(timeRange)) {
                daysToShow = 7;
            } else if ("month".equals(timeRange)) {
                daysToShow = 30;
            } else if ("quarter".equals(timeRange)) {
                daysToShow = 90;
            } else if ("year".equals(timeRange)) {
                daysToShow = 365;
            }

            // 生成最近几天的日期列表
            LocalDateTime now = LocalDateTime.now();
            for (int i = daysToShow - 1; i >= 0; i--) {
                LocalDateTime day = now.minusDays(i);
                String dayKey = day.format(dateFormatter);
                result.put(dayKey, 0);
            }

            // 查询实际数据
            String sql = "SELECT DATE(created_at) as day, COUNT(*) as count " +
                    "FROM user_feedback " + whereClause +
                    " GROUP BY DATE(created_at) " +
                    "ORDER BY day";

            List<Map<String, Object>> rows = jdbcTemplate.queryForList(sql, params.toArray());

            // 填充实际数据
            for (Map<String, Object> row : rows) {
                String day = (String) row.get("day");
                int count = ((Number) row.get("count")).intValue();
                if (result.containsKey(day)) {
                    result.put(day, count);
                }
            }

        } catch (Exception e) {
            System.err.println("按天统计失败: " + e.getMessage());
        }

        return result;
    }

    private Map<String, Integer> getStatsByMonth(String whereClause, List<Object> params, String timeRange) {
        Map<String, Integer> result = new LinkedHashMap<>();

        try {
            // 根据时间范围确定要查询的月份数量
            int monthsToShow = 6; // 默认显示最近6个月
            if ("year".equals(timeRange)) {
                monthsToShow = 12;
            } else if ("quarter".equals(timeRange)) {
                monthsToShow = 3;
            } else if ("month".equals(timeRange)) {
                monthsToShow = 1;
            } else if ("week".equals(timeRange)) {
                monthsToShow = 1;
            }

            // 生成最近几个月的月份列表
            LocalDateTime now = LocalDateTime.now();
            for (int i = monthsToShow - 1; i >= 0; i--) {
                LocalDateTime month = now.minusMonths(i);
                String monthKey = month.format(monthFormatter);
                result.put(monthKey, 0);
            }

            // 查询实际数据
            String sql = "SELECT DATE_FORMAT(created_at, '%Y-%m') as month, COUNT(*) as count " +
                    "FROM user_feedback " + whereClause +
                    " GROUP BY DATE_FORMAT(created_at, '%Y-%m') " +
                    "ORDER BY month";

            List<Map<String, Object>> rows = jdbcTemplate.queryForList(sql, params.toArray());

            // 填充实际数据
            for (Map<String, Object> row : rows) {
                String month = (String) row.get("month");
                int count = ((Number) row.get("count")).intValue();
                if (result.containsKey(month)) {
                    result.put(month, count);
                }
            }

        } catch (Exception e) {
            System.err.println("按月统计失败: " + e.getMessage());
        }

        return result;
    }

    private List<Map<String, Object>> getTopContributors(String whereClause, List<Object> params) {
        List<Map<String, Object>> result = new ArrayList<>();

        try {
            String sql = "SELECT u.user_id, u.username as user_name, COUNT(f.feedback_id) as feedback_count, " +
                    "SUM(f.upvotes) as upvotes_received, AVG(f.upvotes) as avg_upvotes " +
                    "FROM user_feedback f " +
                    "LEFT JOIN users u ON f.user_id = u.user_id " +
                    whereClause +
                    " GROUP BY u.user_id, u.username " +
                    "ORDER BY feedback_count DESC, upvotes_received DESC " +
                    "LIMIT 10";

            List<Map<String, Object>> rows = jdbcTemplate.queryForList(sql, params.toArray());

            for (Map<String, Object> row : rows) {
                Map<String, Object> contributor = new HashMap<>();
                contributor.put("userId", row.get("user_id"));
                contributor.put("userName", row.get("user_name"));
                contributor.put("feedbackCount", row.get("feedback_count"));
                contributor.put("upvotesReceived", row.get("upvotes_received"));
                contributor.put("avgUpvotes", row.get("avg_upvotes"));
                result.add(contributor);
            }

        } catch (Exception e) {
            System.err.println("获取顶级贡献者失败: " + e.getMessage());
        }

        return result;
    }

    private List<Map<String, Object>> getRecentActivity(String whereClause, List<Object> params) {
        List<Map<String, Object>> result = new ArrayList<>();

        try {
            // 获取最近的反馈和回复
            String sql = "(SELECT 'feedback' as type, feedback_id as id, title, user_id, created_at " +
                    "FROM user_feedback " + whereClause +
                    " ORDER BY created_at DESC LIMIT 10) " +
                    "UNION ALL " +
                    "(SELECT 'reply' as type, reply_id as id, LEFT(message, 50) as title, user_id, created_at " +
                    "FROM feedback_replies r " +
                    "WHERE EXISTS (SELECT 1 FROM user_feedback f WHERE f.feedback_id = r.feedback_id " +
                    whereClause.replace("user_feedback", "f") + ") " +
                    "ORDER BY created_at DESC LIMIT 10) " +
                    "ORDER BY created_at DESC LIMIT 20";

            List<Map<String, Object>> rows = jdbcTemplate.queryForList(sql, params.toArray());

            for (Map<String, Object> row : rows) {
                Map<String, Object> activity = new HashMap<>();
                activity.put("type", row.get("type"));
                activity.put("id", row.get("id"));
                activity.put("title", row.get("title"));
                activity.put("userId", row.get("user_id"));
                activity.put("createdAt", row.get("created_at"));
                result.add(activity);
            }

        } catch (Exception e) {
            System.err.println("获取最近活动失败: " + e.getMessage());
        }

        return result;
    }

    private int calculateAverageResponseTime(String whereClause, List<Object> params) {
        int averageResponseTime = 48; // 默认值

        try {
            // 计算从创建到第一次回复的平均时间（小时）
            String sql = "SELECT AVG(TIMESTAMPDIFF(HOUR, f.created_at, r.created_at)) as avg_response_hours " +
                    "FROM user_feedback f " +
                    "INNER JOIN feedback_replies r ON f.feedback_id = r.feedback_id " +
                    "WHERE r.created_at = (SELECT MIN(created_at) FROM feedback_replies WHERE feedback_id = f.feedback_id) " +
                    whereClause.replace("user_feedback", "f");

            Double avgHours = jdbcTemplate.queryForObject(sql, Double.class, params.toArray());
            if (avgHours != null && !avgHours.isNaN()) {
                averageResponseTime = avgHours.intValue();
            }

        } catch (Exception e) {
            System.err.println("计算平均响应时间失败: " + e.getMessage());
        }

        return averageResponseTime;
    }

    private double calculateResolutionRate(String whereClause, List<Object> params) {
        double resolutionRate = 0.75; // 默认值

        try {
            // 计算解决率：已完成的反馈 / 所有反馈
            String totalSql = "SELECT COUNT(*) as total FROM user_feedback " + whereClause;
            Integer total = jdbcTemplate.queryForObject(totalSql, Integer.class, params.toArray());

            if (total != null && total > 0) {
                String resolvedSql = "SELECT COUNT(*) as resolved FROM user_feedback " +
                        whereClause + " AND status IN ('completed', 'rejected', 'duplicate')";
                Integer resolved = jdbcTemplate.queryForObject(resolvedSql, Integer.class, params.toArray());

                if (resolved != null) {
                    resolutionRate = (double) resolved / total;
                }
            }

        } catch (Exception e) {
            System.err.println("计算解决率失败: " + e.getMessage());
        }

        return Math.round(resolutionRate * 100.0) / 100.0; // 保留两位小数
    }

    private double calculateSatisfactionScore(String whereClause, List<Object> params) {
        double satisfactionScore = 4.2; // 默认值

        try {
            // 计算满意度分数：基于投票比例（简化处理）
            String sql = "SELECT AVG(CASE WHEN upvotes + downvotes > 0 THEN upvotes * 5.0 / (upvotes + downvotes) ELSE 4.2 END) as avg_score " +
                    "FROM user_feedback " + whereClause;

            Double avgScore = jdbcTemplate.queryForObject(sql, Double.class, params.toArray());
            if (avgScore != null && !avgScore.isNaN()) {
                satisfactionScore = Math.round(avgScore * 10.0) / 10.0; // 保留一位小数
            }

        } catch (Exception e) {
            System.err.println("计算满意度分数失败: " + e.getMessage());
        }

        return satisfactionScore;
    }

    private Map<String, Object> calculateTrends(String whereClause, List<Object> params, String timeRange) {
        Map<String, Object> trends = new HashMap<>();

        try {
            // 计算最近几个时间段的趋势
            if ("week".equals(timeRange)) {
                // 计算最近7天每天的趋势
                String sql = "SELECT DATE(created_at) as day, COUNT(*) as count " +
                        "FROM user_feedback " + whereClause +
                        " GROUP BY DATE(created_at) " +
                        "ORDER BY day DESC LIMIT 7";

                List<Map<String, Object>> rows = jdbcTemplate.queryForList(sql, params.toArray());

                if (rows.size() >= 2) {
                    // 计算增长率
                    int currentCount = ((Number) rows.get(0).get("count")).intValue();
                    int previousCount = ((Number) rows.get(1).get("count")).intValue();

                    double growthRate = 0.0;
                    if (previousCount > 0) {
                        growthRate = ((double) (currentCount - previousCount) / previousCount) * 100;
                    }

                    trends.put("growthRate", Math.round(growthRate * 10.0) / 10.0); // 保留一位小数
                    trends.put("currentCount", currentCount);
                    trends.put("previousCount", previousCount);
                    trends.put("trend", growthRate > 0 ? "up" : (growthRate < 0 ? "down" : "stable"));
                }
            } else if ("month".equals(timeRange)) {
                // 计算最近30天每周的趋势
                String sql = "SELECT WEEK(created_at) as week, COUNT(*) as count " +
                        "FROM user_feedback " + whereClause +
                        " GROUP BY WEEK(created_at) " +
                        "ORDER BY week DESC LIMIT 4";

                List<Map<String, Object>> rows = jdbcTemplate.queryForList(sql, params.toArray());

                if (rows.size() >= 2) {
                    int currentCount = ((Number) rows.get(0).get("count")).intValue();
                    int previousCount = ((Number) rows.get(1).get("count")).intValue();

                    double growthRate = 0.0;
                    if (previousCount > 0) {
                        growthRate = ((double) (currentCount - previousCount) / previousCount) * 100;
                    }

                    trends.put("growthRate", Math.round(growthRate * 10.0) / 10.0);
                    trends.put("currentCount", currentCount);
                    trends.put("previousCount", previousCount);
                    trends.put("trend", growthRate > 0 ? "up" : (growthRate < 0 ? "down" : "stable"));
                }
            }

        } catch (Exception e) {
            System.err.println("计算趋势失败: " + e.getMessage());
        }

        return trends;
    }
}
--- 结束文件: FeedbackGetStatistics.java ---

--- 开始文件: FeedbackGetStats.java ---
package com.vue.readingapp.feedback;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.UUID;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import java.util.LinkedHashMap;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.core.type.TypeReference;

@RestController
@RequestMapping("/api/v1/feedback")
public class FeedbackGetStats {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();
    private DateTimeFormatter monthFormatter = DateTimeFormatter.ofPattern("yyyy-MM");

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取反馈统计请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=======================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class GetStatsRequest {
        private String timeRange;
        private String type;

        public String getTimeRange() { return timeRange; }
        public void setTimeRange(String timeRange) { this.timeRange = timeRange; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }
    }

    // 响应DTO
    public static class GetStatsResponse {
        private boolean success;
        private String message;
        private FeedbackStatsData data;

        public GetStatsResponse(boolean success, String message, FeedbackStatsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public FeedbackStatsData getData() { return data; }
        public void setData(FeedbackStatsData data) { this.data = data; }
    }

    public static class FeedbackStatsData {
        private int total;
        private Map<String, Integer> byType;
        private Map<String, Integer> byStatus;
        private Map<String, Integer> byPriority;
        private Map<String, Integer> byMonth;
        private List<Map<String, Object>> topContributors;
        private int averageResponseTime;
        private double resolutionRate;
        private double satisfactionScore;

        public FeedbackStatsData(int total, Map<String, Integer> byType, Map<String, Integer> byStatus,
                                 Map<String, Integer> byPriority, Map<String, Integer> byMonth,
                                 List<Map<String, Object>> topContributors, int averageResponseTime,
                                 double resolutionRate, double satisfactionScore) {
            this.total = total;
            this.byType = byType;
            this.byStatus = byStatus;
            this.byPriority = byPriority;
            this.byMonth = byMonth;
            this.topContributors = topContributors;
            this.averageResponseTime = averageResponseTime;
            this.resolutionRate = resolutionRate;
            this.satisfactionScore = satisfactionScore;
        }

        public int getTotal() { return total; }
        public void setTotal(int total) { this.total = total; }

        public Map<String, Integer> getByType() { return byType; }
        public void setByType(Map<String, Integer> byType) { this.byType = byType; }

        public Map<String, Integer> getByStatus() { return byStatus; }
        public void setByStatus(Map<String, Integer> byStatus) { this.byStatus = byStatus; }

        public Map<String, Integer> getByPriority() { return byPriority; }
        public void setByPriority(Map<String, Integer> byPriority) { this.byPriority = byPriority; }

        public Map<String, Integer> getByMonth() { return byMonth; }
        public void setByMonth(Map<String, Integer> byMonth) { this.byMonth = byMonth; }

        public List<Map<String, Object>> getTopContributors() { return topContributors; }
        public void setTopContributors(List<Map<String, Object>> topContributors) { this.topContributors = topContributors; }

        public int getAverageResponseTime() { return averageResponseTime; }
        public void setAverageResponseTime(int averageResponseTime) { this.averageResponseTime = averageResponseTime; }

        public double getResolutionRate() { return resolutionRate; }
        public void setResolutionRate(double resolutionRate) { this.resolutionRate = resolutionRate; }

        public double getSatisfactionScore() { return satisfactionScore; }
        public void setSatisfactionScore(double satisfactionScore) { this.satisfactionScore = satisfactionScore; }
    }

    @GetMapping("/stats")
    public ResponseEntity<GetStatsResponse> getFeedbackStats(
            @RequestParam(defaultValue = "month") String timeRange,
            @RequestParam(required = false) String type) {

        // 创建请求对象用于打印
        GetStatsRequest request = new GetStatsRequest();
        request.setTimeRange(timeRange);
        request.setType(type);

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 构建基础查询条件
            List<Object> params = new ArrayList<>();
            StringBuilder whereClause = new StringBuilder(" WHERE 1=1 ");

            // 处理type条件
            if (type != null && !type.isEmpty() && !"all".equals(type)) {
                whereClause.append(" AND type = ? ");
                params.add(type);
            }

            // 处理时间范围条件
            String dateCondition = "";
            if ("week".equals(timeRange)) {
                dateCondition = " AND created_at >= DATE_SUB(NOW(), INTERVAL 7 DAY) ";
            } else if ("month".equals(timeRange)) {
                dateCondition = " AND created_at >= DATE_SUB(NOW(), INTERVAL 30 DAY) ";
            } else if ("quarter".equals(timeRange)) {
                dateCondition = " AND created_at >= DATE_SUB(NOW(), INTERVAL 90 DAY) ";
            } else if ("year".equals(timeRange)) {
                dateCondition = " AND created_at >= DATE_SUB(NOW(), INTERVAL 365 DAY) ";
            }
            whereClause.append(dateCondition);

            // 2. 获取总数
            String totalSql = "SELECT COUNT(*) as total FROM user_feedback " + whereClause.toString();
            Integer total = jdbcTemplate.queryForObject(totalSql, Integer.class, params.toArray());
            if (total == null) total = 0;

            // 3. 按类型统计
            Map<String, Integer> byType = getStatsByType(whereClause.toString(), params);

            // 4. 按状态统计
            Map<String, Integer> byStatus = getStatsByStatus(whereClause.toString(), params);

            // 5. 按优先级统计
            Map<String, Integer> byPriority = getStatsByPriority(whereClause.toString(), params);

            // 6. 按月统计
            Map<String, Integer> byMonth = getStatsByMonth(whereClause.toString(), params, timeRange);

            // 7. 获取顶级贡献者
            List<Map<String, Object>> topContributors = getTopContributors(whereClause.toString(), params);

            // 8. 计算平均响应时间
            int averageResponseTime = calculateAverageResponseTime(whereClause.toString(), params);

            // 9. 计算解决率
            double resolutionRate = calculateResolutionRate(whereClause.toString(), params);

            // 10. 计算满意度分数（简化处理）
            double satisfactionScore = calculateSatisfactionScore(whereClause.toString(), params);

            // 11. 准备响应数据
            FeedbackStatsData statsData = new FeedbackStatsData(
                    total, byType, byStatus, byPriority, byMonth, topContributors,
                    averageResponseTime, resolutionRate, satisfactionScore
            );

            GetStatsResponse response = new GetStatsResponse(
                    true, "获取反馈统计成功", statsData
            );

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取反馈统计过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new GetStatsResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private Map<String, Integer> getStatsByType(String whereClause, List<Object> params) {
        Map<String, Integer> result = new LinkedHashMap<>();

        try {
            String sql = "SELECT type, COUNT(*) as count FROM user_feedback " +
                    whereClause + " GROUP BY type ORDER BY count DESC";

            List<Map<String, Object>> rows = jdbcTemplate.queryForList(sql, params.toArray());

            // 初始化所有可能的类型
            List<String> allTypes = List.of("bug", "feature", "improvement", "question", "other");
            for (String type : allTypes) {
                result.put(type, 0);
            }

            // 填充实际数据
            for (Map<String, Object> row : rows) {
                String type = (String) row.get("type");
                int count = ((Number) row.get("count")).intValue();
                result.put(type, count);
            }

        } catch (Exception e) {
            System.err.println("按类型统计失败: " + e.getMessage());
        }

        return result;
    }

    private Map<String, Integer> getStatsByStatus(String whereClause, List<Object> params) {
        Map<String, Integer> result = new LinkedHashMap<>();

        try {
            String sql = "SELECT status, COUNT(*) as count FROM user_feedback " +
                    whereClause + " GROUP BY status ORDER BY FIELD(status, 'pending', 'reviewing', 'in_progress', 'completed', 'rejected', 'duplicate')";

            List<Map<String, Object>> rows = jdbcTemplate.queryForList(sql, params.toArray());

            // 初始化所有可能的状态
            List<String> allStatuses = List.of("pending", "reviewing", "in_progress", "completed", "rejected", "duplicate");
            for (String status : allStatuses) {
                result.put(status, 0);
            }

            // 填充实际数据
            for (Map<String, Object> row : rows) {
                String status = (String) row.get("status");
                int count = ((Number) row.get("count")).intValue();
                result.put(status, count);
            }

        } catch (Exception e) {
            System.err.println("按状态统计失败: " + e.getMessage());
        }

        return result;
    }

    private Map<String, Integer> getStatsByPriority(String whereClause, List<Object> params) {
        Map<String, Integer> result = new LinkedHashMap<>();

        try {
            String sql = "SELECT priority, COUNT(*) as count FROM user_feedback " +
                    whereClause + " GROUP BY priority ORDER BY FIELD(priority, 'critical', 'high', 'medium', 'low')";

            List<Map<String, Object>> rows = jdbcTemplate.queryForList(sql, params.toArray());

            // 初始化所有可能的优先级
            List<String> allPriorities = List.of("critical", "high", "medium", "low");
            for (String priority : allPriorities) {
                result.put(priority, 0);
            }

            // 填充实际数据
            for (Map<String, Object> row : rows) {
                String priority = (String) row.get("priority");
                int count = ((Number) row.get("count")).intValue();
                result.put(priority, count);
            }

        } catch (Exception e) {
            System.err.println("按优先级统计失败: " + e.getMessage());
        }

        return result;
    }

    private Map<String, Integer> getStatsByMonth(String whereClause, List<Object> params, String timeRange) {
        Map<String, Integer> result = new LinkedHashMap<>();

        try {
            // 根据时间范围确定要查询的月份数量
            int monthsToShow = 6; // 默认显示最近6个月
            if ("year".equals(timeRange)) {
                monthsToShow = 12;
            } else if ("quarter".equals(timeRange)) {
                monthsToShow = 3;
            } else if ("month".equals(timeRange)) {
                monthsToShow = 1;
            } else if ("week".equals(timeRange)) {
                monthsToShow = 1;
            }

            // 生成最近几个月的月份列表
            LocalDateTime now = LocalDateTime.now();
            for (int i = monthsToShow - 1; i >= 0; i--) {
                LocalDateTime month = now.minusMonths(i);
                String monthKey = month.format(monthFormatter);
                result.put(monthKey, 0);
            }

            // 查询实际数据
            String sql = "SELECT DATE_FORMAT(created_at, '%Y-%m') as month, COUNT(*) as count " +
                    "FROM user_feedback " + whereClause +
                    " GROUP BY DATE_FORMAT(created_at, '%Y-%m') " +
                    "ORDER BY month";

            List<Map<String, Object>> rows = jdbcTemplate.queryForList(sql, params.toArray());

            // 填充实际数据
            for (Map<String, Object> row : rows) {
                String month = (String) row.get("month");
                int count = ((Number) row.get("count")).intValue();
                if (result.containsKey(month)) {
                    result.put(month, count);
                }
            }

        } catch (Exception e) {
            System.err.println("按月统计失败: " + e.getMessage());
        }

        return result;
    }

    private List<Map<String, Object>> getTopContributors(String whereClause, List<Object> params) {
        List<Map<String, Object>> result = new ArrayList<>();

        try {
            String sql = "SELECT u.user_id, u.username as user_name, COUNT(f.feedback_id) as feedback_count, " +
                    "SUM(f.upvotes) as upvotes_received " +
                    "FROM user_feedback f " +
                    "LEFT JOIN users u ON f.user_id = u.user_id " +
                    whereClause +
                    " GROUP BY u.user_id, u.username " +
                    "ORDER BY feedback_count DESC, upvotes_received DESC " +
                    "LIMIT 10";

            List<Map<String, Object>> rows = jdbcTemplate.queryForList(sql, params.toArray());

            for (Map<String, Object> row : rows) {
                Map<String, Object> contributor = new HashMap<>();
                contributor.put("userId", row.get("user_id"));
                contributor.put("userName", row.get("user_name"));
                contributor.put("feedbackCount", row.get("feedback_count"));
                contributor.put("upvotesReceived", row.get("upvotes_received"));
                result.add(contributor);
            }

        } catch (Exception e) {
            System.err.println("获取顶级贡献者失败: " + e.getMessage());
        }

        return result;
    }

    private int calculateAverageResponseTime(String whereClause, List<Object> params) {
        int averageResponseTime = 48; // 默认值

        try {
            // 计算从创建到第一次回复的平均时间（小时）
            String sql = "SELECT AVG(TIMESTAMPDIFF(HOUR, f.created_at, r.created_at)) as avg_response_hours " +
                    "FROM user_feedback f " +
                    "INNER JOIN feedback_replies r ON f.feedback_id = r.feedback_id " +
                    "WHERE r.created_at = (SELECT MIN(created_at) FROM feedback_replies WHERE feedback_id = f.feedback_id) " +
                    whereClause.replace("user_feedback", "f");

            Double avgHours = jdbcTemplate.queryForObject(sql, Double.class, params.toArray());
            if (avgHours != null && !avgHours.isNaN()) {
                averageResponseTime = avgHours.intValue();
            }

        } catch (Exception e) {
            System.err.println("计算平均响应时间失败: " + e.getMessage());
        }

        return averageResponseTime;
    }

    private double calculateResolutionRate(String whereClause, List<Object> params) {
        double resolutionRate = 0.75; // 默认值

        try {
            // 计算解决率：已完成的反馈 / 所有反馈
            String totalSql = "SELECT COUNT(*) as total FROM user_feedback " + whereClause;
            Integer total = jdbcTemplate.queryForObject(totalSql, Integer.class, params.toArray());

            if (total != null && total > 0) {
                String resolvedSql = "SELECT COUNT(*) as resolved FROM user_feedback " +
                        whereClause + " AND status IN ('completed', 'rejected', 'duplicate')";
                Integer resolved = jdbcTemplate.queryForObject(resolvedSql, Integer.class, params.toArray());

                if (resolved != null) {
                    resolutionRate = (double) resolved / total;
                }
            }

        } catch (Exception e) {
            System.err.println("计算解决率失败: " + e.getMessage());
        }

        return Math.round(resolutionRate * 100.0) / 100.0; // 保留两位小数
    }

    private double calculateSatisfactionScore(String whereClause, List<Object> params) {
        double satisfactionScore = 4.2; // 默认值

        try {
            // 计算满意度分数：基于投票比例（简化处理）
            String sql = "SELECT AVG(CASE WHEN upvotes + downvotes > 0 THEN upvotes * 5.0 / (upvotes + downvotes) ELSE 4.2 END) as avg_score " +
                    "FROM user_feedback " + whereClause;

            Double avgScore = jdbcTemplate.queryForObject(sql, Double.class, params.toArray());
            if (avgScore != null && !avgScore.isNaN()) {
                satisfactionScore = Math.round(avgScore * 10.0) / 10.0; // 保留一位小数
            }

        } catch (Exception e) {
            System.err.println("计算满意度分数失败: " + e.getMessage());
        }

        return satisfactionScore;
    }
}
--- 结束文件: FeedbackGetStats.java ---

--- 开始文件: FeedbackGetTypes.java ---
package com.vue.readingapp.feedback;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.UUID;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.core.type.TypeReference;

@RestController
@RequestMapping("/api/v1/feedback")
public class FeedbackGetTypes {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取反馈类型请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=======================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class GetTypesResponse {
        private boolean success;
        private String message;
        private List<TypeData> data;

        public GetTypesResponse(boolean success, String message, List<TypeData> data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public List<TypeData> getData() { return data; }
        public void setData(List<TypeData> data) { this.data = data; }
    }

    public static class TypeData {
        private String id;
        private String name;
        private String value;
        private String description;
        private String icon;
        private String color;
        private int feedbackCount;

        public TypeData(String id, String name, String value, String description,
                        String icon, String color, int feedbackCount) {
            this.id = id;
            this.name = name;
            this.value = value;
            this.description = description;
            this.icon = icon;
            this.color = color;
            this.feedbackCount = feedbackCount;
        }

        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getValue() { return value; }
        public void setValue(String value) { this.value = value; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }

        public String getIcon() { return icon; }
        public void setIcon(String icon) { this.icon = icon; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public int getFeedbackCount() { return feedbackCount; }
        public void setFeedbackCount(int feedbackCount) { this.feedbackCount = feedbackCount; }
    }

    @GetMapping("/types")
    public ResponseEntity<GetTypesResponse> getFeedbackTypes() {

        // 打印接收到的请求
        printRequest("获取所有反馈类型");

        try {
            // 1. 查询所有反馈类型及其统计
            List<TypeData> types = new ArrayList<>();

            // 2. 添加默认类型
            // bug类型
            int bugCount = getFeedbackCountByType("bug");
            types.add(new TypeData("bug", "错误报告", "bug", "系统功能异常或错误", "bug", "#F44336", bugCount));

            // feature类型
            int featureCount = getFeedbackCountByType("feature");
            types.add(new TypeData("feature", "功能建议", "feature", "新功能或改进建议", "light-bulb", "#2196F3", featureCount));

            // improvement类型
            int improvementCount = getFeedbackCountByType("improvement");
            types.add(new TypeData("improvement", "改进建议", "improvement", "现有功能优化建议", "chart-bar", "#4CAF50", improvementCount));

            // question类型
            int questionCount = getFeedbackCountByType("question");
            types.add(new TypeData("question", "问题咨询", "question", "使用问题或咨询", "question-mark-circle", "#FF9800", questionCount));

            // other类型
            int otherCount = getFeedbackCountByType("other");
            types.add(new TypeData("other", "其他反馈", "other", "其他类型的反馈", "chat-alt-2", "#9C27B0", otherCount));

            // 3. 查询自定义类型
            String customSql = "SELECT c.category_id, c.name, c.value, c.description, c.icon, c.color, " +
                    "COUNT(f.feedback_id) as feedback_count " +
                    "FROM feedback_categories c " +
                    "LEFT JOIN user_feedback f ON c.value = f.type " +
                    "WHERE c.is_active = TRUE " +
                    "GROUP BY c.category_id, c.name, c.value, c.description, c.icon, c.color " +
                    "ORDER BY c.order_index, c.name";

            List<Map<String, Object>> customTypes = jdbcTemplate.queryForList(customSql);
            printQueryResult("自定义类型: " + customTypes);

            for (Map<String, Object> row : customTypes) {
                TypeData type = new TypeData(
                        (String) row.get("category_id"),
                        (String) row.get("name"),
                        (String) row.get("value"),
                        (String) row.get("description"),
                        (String) row.get("icon"),
                        (String) row.get("color"),
                        ((Number) row.get("feedback_count")).intValue()
                );
                types.add(type);
            }

            // 4. 按反馈数量排序
            types.sort((a, b) -> Integer.compare(b.getFeedbackCount(), a.getFeedbackCount()));

            // 5. 准备响应数据
            GetTypesResponse response = new GetTypesResponse(
                    true, "获取反馈类型成功", types
            );

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取反馈类型过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new GetTypesResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private int getFeedbackCountByType(String type) {
        try {
            String sql = "SELECT COUNT(*) as count FROM user_feedback WHERE type = ?";
            Integer count = jdbcTemplate.queryForObject(sql, Integer.class, type);
            return count != null ? count : 0;
        } catch (Exception e) {
            System.err.println("获取类型统计失败: " + e.getMessage());
            return 0;
        }
    }
}
--- 结束文件: FeedbackGetTypes.java ---

--- 开始文件: FeedbackList.java ---
package com.vue.readingapp.feedback;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.UUID;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.core.type.TypeReference;

@RestController
@RequestMapping("/api/v1/feedback")
public class FeedbackList {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取反馈列表请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=======================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class ListRequest {
        private String type;
        private String status;
        private String priority;
        private Integer page;
        private Integer pageSize;
        private String sortBy;
        private String sortOrder;
        private Boolean includeClosed;
        private Boolean myFeedback;

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public String getPriority() { return priority; }
        public void setPriority(String priority) { this.priority = priority; }

        public Integer getPage() { return page; }
        public void setPage(Integer page) { this.page = page; }

        public Integer getPageSize() { return pageSize; }
        public void setPageSize(Integer pageSize) { this.pageSize = pageSize; }

        public String getSortBy() { return sortBy; }
        public void setSortBy(String sortBy) { this.sortBy = sortBy; }

        public String getSortOrder() { return sortOrder; }
        public void setSortOrder(String sortOrder) { this.sortOrder = sortOrder; }

        public Boolean getIncludeClosed() { return includeClosed; }
        public void setIncludeClosed(Boolean includeClosed) { this.includeClosed = includeClosed; }

        public Boolean getMyFeedback() { return myFeedback; }
        public void setMyFeedback(Boolean myFeedback) { this.myFeedback = myFeedback; }
    }

    // 响应DTO
    public static class ListResponse {
        private boolean success;
        private String message;
        private FeedbackListData data;

        public ListResponse(boolean success, String message, FeedbackListData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public FeedbackListData getData() { return data; }
        public void setData(FeedbackListData data) { this.data = data; }
    }

    public static class FeedbackListData {
        private int total;
        private int page;
        private int pageSize;
        private int totalPages;
        private List<FeedbackItem> items;
        private Map<String, Object> filters;
        private Map<String, Object> statistics;

        public FeedbackListData(int total, int page, int pageSize, int totalPages,
                                List<FeedbackItem> items, Map<String, Object> filters,
                                Map<String, Object> statistics) {
            this.total = total;
            this.page = page;
            this.pageSize = pageSize;
            this.totalPages = totalPages;
            this.items = items;
            this.filters = filters;
            this.statistics = statistics;
        }

        public int getTotal() { return total; }
        public void setTotal(int total) { this.total = total; }

        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public int getPageSize() { return pageSize; }
        public void setPageSize(int pageSize) { this.pageSize = pageSize; }

        public int getTotalPages() { return totalPages; }
        public void setTotalPages(int totalPages) { this.totalPages = totalPages; }

        public List<FeedbackItem> getItems() { return items; }
        public void setItems(List<FeedbackItem> items) { this.items = items; }

        public Map<String, Object> getFilters() { return filters; }
        public void setFilters(Map<String, Object> filters) { this.filters = filters; }

        public Map<String, Object> getStatistics() { return statistics; }
        public void setStatistics(Map<String, Object> statistics) { this.statistics = statistics; }
    }

    public static class FeedbackItem {
        private String id;
        private String type;
        private String title;
        private String content;
        private String status;
        private String priority;
        private int upvotes;
        private int downvotes;
        private String userId;
        private String userName;
        private List<Map<String, Object>> attachments;
        private Map<String, Object> metadata;
        private String createdAt;
        private String updatedAt;
        private String assignedTo;
        private String assignedAt;
        private String completedAt;

        // Getters and Setters
        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public String getTitle() { return title; }
        public void setTitle(String title) { this.title = title; }

        public String getContent() { return content; }
        public void setContent(String content) { this.content = content; }

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public String getPriority() { return priority; }
        public void setPriority(String priority) { this.priority = priority; }

        public int getUpvotes() { return upvotes; }
        public void setUpvotes(int upvotes) { this.upvotes = upvotes; }

        public int getDownvotes() { return downvotes; }
        public void setDownvotes(int downvotes) { this.downvotes = downvotes; }

        public String getUserId() { return userId; }
        public void setUserId(String userId) { this.userId = userId; }

        public String getUserName() { return userName; }
        public void setUserName(String userName) { this.userName = userName; }

        public List<Map<String, Object>> getAttachments() { return attachments; }
        public void setAttachments(List<Map<String, Object>> attachments) { this.attachments = attachments; }

        public Map<String, Object> getMetadata() { return metadata; }
        public void setMetadata(Map<String, Object> metadata) { this.metadata = metadata; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }

        public String getAssignedTo() { return assignedTo; }
        public void setAssignedTo(String assignedTo) { this.assignedTo = assignedTo; }

        public String getAssignedAt() { return assignedAt; }
        public void setAssignedAt(String assignedAt) { this.assignedAt = assignedAt; }

        public String getCompletedAt() { return completedAt; }
        public void setCompletedAt(String completedAt) { this.completedAt = completedAt; }
    }

    @GetMapping("/list")
    public ResponseEntity<ListResponse> getFeedbackList(
            @RequestParam(required = false) String type,
            @RequestParam(required = false) String status,
            @RequestParam(required = false) String priority,
            @RequestParam(defaultValue = "1") Integer page,
            @RequestParam(defaultValue = "20") Integer pageSize,
            @RequestParam(defaultValue = "created_at") String sortBy,
            @RequestParam(defaultValue = "desc") String sortOrder,
            @RequestParam(defaultValue = "false") Boolean includeClosed,
            @RequestParam(defaultValue = "false") Boolean myFeedback,
            @RequestHeader(value = "X-User-Id", required = false) String userId) {

        // 创建请求对象用于打印
        ListRequest request = new ListRequest();
        request.setType(type);
        request.setStatus(status);
        request.setPriority(priority);
        request.setPage(page);
        request.setPageSize(pageSize);
        request.setSortBy(sortBy);
        request.setSortOrder(sortOrder);
        request.setIncludeClosed(includeClosed);
        request.setMyFeedback(myFeedback);

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 参数验证和默认值设置
            if (page == null || page < 1) page = 1;
            if (pageSize == null || pageSize < 1) pageSize = 20;
            if (pageSize > 100) pageSize = 100; // 限制最大页大小

            // 2. 构建查询条件
            List<Object> params = new ArrayList<>();
            StringBuilder whereClause = new StringBuilder(" WHERE 1=1 ");

            // 处理type条件
            if (type != null && !type.isEmpty() && !"all".equals(type)) {
                whereClause.append(" AND type = ? ");
                params.add(type);
            }

            // 处理status条件
            if (status != null && !status.isEmpty() && !"all".equals(status)) {
                whereClause.append(" AND status = ? ");
                params.add(status);
            } else if (!includeClosed) {
                // 如果不包含已关闭的，排除completed, rejected, duplicate
                whereClause.append(" AND status NOT IN ('completed', 'rejected', 'duplicate') ");
            }

            // 处理priority条件
            if (priority != null && !priority.isEmpty() && !"all".equals(priority)) {
                whereClause.append(" AND priority = ? ");
                params.add(priority);
            }

            // 处理myFeedback条件
            if (myFeedback && userId != null) {
                whereClause.append(" AND user_id = ? ");
                params.add(userId);
            }

            // 3. 获取总数
            String countSql = "SELECT COUNT(*) as total FROM user_feedback " + whereClause.toString();
            Integer total = jdbcTemplate.queryForObject(countSql, Integer.class, params.toArray());
            if (total == null) total = 0;

            // 4. 计算分页
            int totalPages = (int) Math.ceil((double) total / pageSize);
            int offset = (page - 1) * pageSize;

            // 5. 构建排序
            String orderByClause = " ORDER BY ";
            if ("upvotes".equals(sortBy)) {
                orderByClause += "upvotes ";
            } else if ("priority".equals(sortBy)) {
                orderByClause += "FIELD(priority, 'critical', 'high', 'medium', 'low') ";
            } else {
                orderByClause += sortBy + " ";
            }

            orderByClause += "desc".equalsIgnoreCase(sortOrder) ? "DESC" : "ASC";

            // 6. 查询数据
            String querySql = "SELECT f.*, u.username as user_name " +
                    "FROM user_feedback f " +
                    "LEFT JOIN users u ON f.user_id = u.user_id " +
                    whereClause.toString() +
                    orderByClause +
                    " LIMIT ? OFFSET ?";

            List<Object> queryParams = new ArrayList<>(params);
            queryParams.add(pageSize);
            queryParams.add(offset);

            List<Map<String, Object>> feedbackList = jdbcTemplate.queryForList(querySql, queryParams.toArray());
            printQueryResult("查询到 " + feedbackList.size() + " 条记录");

            // 7. 转换数据
            List<FeedbackItem> items = new ArrayList<>();
            for (Map<String, Object> row : feedbackList) {
                FeedbackItem item = new FeedbackItem();
                item.setId((String) row.get("feedback_id"));
                item.setType((String) row.get("type"));
                item.setTitle((String) row.get("title"));
                item.setContent((String) row.get("content"));
                item.setStatus((String) row.get("status"));
                item.setPriority((String) row.get("priority"));
                item.setUpvotes(((Number) row.get("upvotes")).intValue());
                item.setDownvotes(((Number) row.get("downvotes")).intValue());
                item.setUserId((String) row.get("user_id"));
                item.setUserName((String) row.get("user_name"));

                // 处理attachments JSON
                String attachmentsJson = (String) row.get("attachments");
                if (attachmentsJson != null && !attachmentsJson.isEmpty() && !"[]".equals(attachmentsJson)) {
                    try {
                        List<Map<String, Object>> attachments = objectMapper.readValue(
                                attachmentsJson, new TypeReference<List<Map<String, Object>>>() {});
                        item.setAttachments(attachments);
                    } catch (Exception e) {
                        item.setAttachments(new ArrayList<>());
                    }
                } else {
                    item.setAttachments(new ArrayList<>());
                }

                // 处理metadata JSON
                String metadataJson = (String) row.get("metadata");
                if (metadataJson != null && !metadataJson.isEmpty() && !"{}".equals(metadataJson)) {
                    try {
                        Map<String, Object> metadata = objectMapper.readValue(
                                metadataJson, new TypeReference<Map<String, Object>>() {});
                        item.setMetadata(metadata);
                    } catch (Exception e) {
                        item.setMetadata(new HashMap<>());
                    }
                } else {
                    item.setMetadata(new HashMap<>());
                }

                item.setCreatedAt(row.get("created_at").toString());
                item.setUpdatedAt(row.get("updated_at").toString());
                item.setAssignedTo((String) row.get("assigned_to"));
                item.setAssignedAt(row.get("assigned_at") != null ? row.get("assigned_at").toString() : null);
                item.setCompletedAt(row.get("completed_at") != null ? row.get("completed_at").toString() : null);

                items.add(item);
            }

            // 8. 获取统计信息
            Map<String, Object> statistics = getFeedbackStatistics();

            // 9. 构建过滤器信息
            Map<String, Object> filters = new HashMap<>();
            filters.put("type", type != null ? type : "all");
            filters.put("status", status != null ? status : "all");
            filters.put("priority", priority != null ? priority : "all");
            filters.put("sortBy", sortBy);
            filters.put("sortOrder", sortOrder);

            // 10. 准备响应数据
            FeedbackListData listData = new FeedbackListData(
                    total, page, pageSize, totalPages, items, filters, statistics
            );

            ListResponse response = new ListResponse(true, "获取反馈列表成功", listData);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取反馈列表过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ListResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private Map<String, Object> getFeedbackStatistics() {
        Map<String, Object> statistics = new HashMap<>();

        try {
            // 获取按类型统计
            String typeSql = "SELECT type, COUNT(*) as count FROM user_feedback GROUP BY type";
            List<Map<String, Object>> typeStats = jdbcTemplate.queryForList(typeSql);

            Map<String, Integer> byType = new HashMap<>();
            for (Map<String, Object> row : typeStats) {
                byType.put((String) row.get("type"), ((Number) row.get("count")).intValue());
            }
            statistics.put("byType", byType);

            // 获取按状态统计
            String statusSql = "SELECT status, COUNT(*) as count FROM user_feedback GROUP BY status";
            List<Map<String, Object>> statusStats = jdbcTemplate.queryForList(statusSql);

            Map<String, Integer> byStatus = new HashMap<>();
            for (Map<String, Object> row : statusStats) {
                byStatus.put((String) row.get("status"), ((Number) row.get("count")).intValue());
            }
            statistics.put("byStatus", byStatus);

            // 获取按优先级统计
            String prioritySql = "SELECT priority, COUNT(*) as count FROM user_feedback GROUP BY priority";
            List<Map<String, Object>> priorityStats = jdbcTemplate.queryForList(prioritySql);

            Map<String, Integer> byPriority = new HashMap<>();
            for (Map<String, Object> row : priorityStats) {
                byPriority.put((String) row.get("priority"), ((Number) row.get("count")).intValue());
            }
            statistics.put("byPriority", byPriority);

            // 获取总数
            String totalSql = "SELECT COUNT(*) as total FROM user_feedback";
            Integer total = jdbcTemplate.queryForObject(totalSql, Integer.class);
            statistics.put("total", total != null ? total : 0);

        } catch (Exception e) {
            System.err.println("获取统计信息失败: " + e.getMessage());
            statistics.put("total", 0);
            statistics.put("byType", new HashMap<>());
            statistics.put("byStatus", new HashMap<>());
            statistics.put("byPriority", new HashMap<>());
        }

        return statistics;
    }
}
--- 结束文件: FeedbackList.java ---

--- 开始文件: FeedbackMarkAsRead.java ---
package com.vue.readingapp.feedback;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.UUID;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.core.type.TypeReference;

@RestController
@RequestMapping("/api/v1/feedback")
public class FeedbackMarkAsRead {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到标记反馈为已读请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class MarkAsReadRequest {
        private String feedbackId;

        public String getFeedbackId() { return feedbackId; }
        public void setFeedbackId(String feedbackId) { this.feedbackId = feedbackId; }
    }

    // 响应DTO
    public static class MarkAsReadResponse {
        private boolean success;
        private String message;
        private MarkAsReadData data;

        public MarkAsReadResponse(boolean success, String message, MarkAsReadData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public MarkAsReadData getData() { return data; }
        public void setData(MarkAsReadData data) { this.data = data; }
    }

    public static class MarkAsReadData {
        private String feedbackId;
        private boolean markedAsRead;
        private String markedAt;

        public MarkAsReadData(String feedbackId, boolean markedAsRead, String markedAt) {
            this.feedbackId = feedbackId;
            this.markedAsRead = markedAsRead;
            this.markedAt = markedAt;
        }

        public String getFeedbackId() { return feedbackId; }
        public void setFeedbackId(String feedbackId) { this.feedbackId = feedbackId; }

        public boolean isMarkedAsRead() { return markedAsRead; }
        public void setMarkedAsRead(boolean markedAsRead) { this.markedAsRead = markedAsRead; }

        public String getMarkedAt() { return markedAt; }
        public void setMarkedAt(String markedAt) { this.markedAt = markedAt; }
    }

    @PutMapping("/{feedbackId}/read")
    public ResponseEntity<MarkAsReadResponse> markFeedbackAsRead(
            @PathVariable String feedbackId,
            @RequestHeader(value = "X-User-Id", required = false) String userId) {

        // 创建请求对象用于打印
        MarkAsReadRequest request = new MarkAsReadRequest();
        request.setFeedbackId(feedbackId);

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证参数
            if (feedbackId == null || feedbackId.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new MarkAsReadResponse(false, "反馈ID不能为空", null)
                );
            }

            // 2. 验证用户身份
            if (userId == null || userId.trim().isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new MarkAsReadResponse(false, "用户未登录", null)
                );
            }

            // 3. 检查反馈是否存在
            String checkSql = "SELECT feedback_id, user_id FROM user_feedback WHERE feedback_id = ?";
            List<Map<String, Object>> feedbackList = jdbcTemplate.queryForList(checkSql, feedbackId);

            if (feedbackList.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new MarkAsReadResponse(false, "未找到指定的反馈", null)
                );
            }

            Map<String, Object> feedback = feedbackList.get(0);
            String feedbackUserId = (String) feedback.get("user_id");

            // 4. 检查权限（只有反馈创建者可以标记为已读）
            if (!userId.equals(feedbackUserId)) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN).body(
                        new MarkAsReadResponse(false, "没有权限标记此反馈", null)
                );
            }

            // 5. 检查是否已经标记为已读
            // 这里我们假设有一个字段来记录是否已读，但我们的表中没有这个字段
            // 为了简化，我们可以创建一个新的表来记录阅读状态，或者使用现有的view_count
            // 这里我们使用一个简化方案：更新view_count并记录最后一次阅读时间

            // 首先获取当前的view_count
            String getViewSql = "SELECT view_count FROM user_feedback WHERE feedback_id = ?";
            Integer currentViewCount = jdbcTemplate.queryForObject(getViewSql, Integer.class, feedbackId);

            if (currentViewCount == null) {
                currentViewCount = 0;
            }

            // 6. 更新view_count（增加一次查看）
            String updateSql = "UPDATE user_feedback SET view_count = view_count + 1, updated_at = NOW() WHERE feedback_id = ?";
            int rowsAffected = jdbcTemplate.update(updateSql, feedbackId);

            printQueryResult("更新行数: " + rowsAffected);

            if (rowsAffected == 0) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new MarkAsReadResponse(false, "标记为已读失败", null)
                );
            }

            // 7. 记录阅读历史（可选，这里简化处理）
            // 在实际项目中，可能需要创建一个专门的表来记录用户的阅读历史

            // 8. 准备响应数据
            MarkAsReadData readData = new MarkAsReadData(
                    feedbackId,
                    true,
                    LocalDateTime.now().toString()
            );

            MarkAsReadResponse response = new MarkAsReadResponse(
                    true, "反馈已标记为已读", readData
            );

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("标记反馈为已读过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new MarkAsReadResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: FeedbackMarkAsRead.java ---

--- 开始文件: FeedbackMarkAsResolved.java ---
package com.vue.readingapp.feedback;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.UUID;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.core.type.TypeReference;

@RestController
@RequestMapping("/api/v1/feedback")
public class FeedbackMarkAsResolved {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到标记反馈为已处理请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("===========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class MarkAsResolvedRequest {
        private String feedbackId;

        public String getFeedbackId() { return feedbackId; }
        public void setFeedbackId(String feedbackId) { this.feedbackId = feedbackId; }
    }

    // 响应DTO
    public static class MarkAsResolvedResponse {
        private boolean success;
        private String message;
        private MarkAsResolvedData data;

        public MarkAsResolvedResponse(boolean success, String message, MarkAsResolvedData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public MarkAsResolvedData getData() { return data; }
        public void setData(MarkAsResolvedData data) { this.data = data; }
    }

    public static class MarkAsResolvedData {
        private String feedbackId;
        private boolean resolved;
        private String resolvedAt;

        public MarkAsResolvedData(String feedbackId, boolean resolved, String resolvedAt) {
            this.feedbackId = feedbackId;
            this.resolved = resolved;
            this.resolvedAt = resolvedAt;
        }

        public String getFeedbackId() { return feedbackId; }
        public void setFeedbackId(String feedbackId) { this.feedbackId = feedbackId; }

        public boolean isResolved() { return resolved; }
        public void setResolved(boolean resolved) { this.resolved = resolved; }

        public String getResolvedAt() { return resolvedAt; }
        public void setResolvedAt(String resolvedAt) { this.resolvedAt = resolvedAt; }
    }

    @PutMapping("/{feedbackId}/resolve")
    public ResponseEntity<MarkAsResolvedResponse> markFeedbackAsResolved(
            @PathVariable String feedbackId,
            @RequestHeader(value = "X-User-Id", required = false) String userId) {

        // 创建请求对象用于打印
        MarkAsResolvedRequest request = new MarkAsResolvedRequest();
        request.setFeedbackId(feedbackId);

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证参数
            if (feedbackId == null || feedbackId.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new MarkAsResolvedResponse(false, "反馈ID不能为空", null)
                );
            }

            // 2. 验证用户身份
            if (userId == null || userId.trim().isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new MarkAsResolvedResponse(false, "用户未登录", null)
                );
            }

            // 3. 检查反馈是否存在
            String checkSql = "SELECT feedback_id, user_id, status FROM user_feedback WHERE feedback_id = ?";
            List<Map<String, Object>> feedbackList = jdbcTemplate.queryForList(checkSql, feedbackId);

            if (feedbackList.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new MarkAsResolvedResponse(false, "未找到指定的反馈", null)
                );
            }

            Map<String, Object> feedback = feedbackList.get(0);
            String feedbackUserId = (String) feedback.get("user_id");
            String currentStatus = (String) feedback.get("status");

            // 4. 检查权限（只有反馈创建者或管理员可以标记为已处理）
            boolean hasPermission = false;

            if (userId.equals(feedbackUserId)) {
                hasPermission = true;
            } else {
                // 检查是否是管理员
                String adminCheckSql = "SELECT role FROM users WHERE user_id = ?";
                List<Map<String, Object>> userList = jdbcTemplate.queryForList(adminCheckSql, userId);

                if (!userList.isEmpty()) {
                    Map<String, Object> user = userList.get(0);
                    String role = (String) user.get("role");

                    if ("admin".equals(role) || "moderator".equals(role)) {
                        hasPermission = true;
                    }
                }
            }

            if (!hasPermission) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN).body(
                        new MarkAsResolvedResponse(false, "没有权限标记此反馈", null)
                );
            }

            // 5. 检查是否已经是已处理状态
            List<String> resolvedStatuses = List.of("completed", "rejected", "duplicate");
            if (resolvedStatuses.contains(currentStatus)) {
                MarkAsResolvedData resolvedData = new MarkAsResolvedData(
                        feedbackId,
                        true,
                        LocalDateTime.now().toString()
                );

                MarkAsResolvedResponse response = new MarkAsResolvedResponse(
                        true, "反馈已经是已处理状态", resolvedData
                );

                printResponse(response);
                return ResponseEntity.ok(response);
            }

            // 6. 更新反馈状态为completed（已处理）
            String updateSql = "UPDATE user_feedback SET status = 'completed', completed_at = NOW(), updated_at = NOW() WHERE feedback_id = ?";
            int rowsAffected = jdbcTemplate.update(updateSql, feedbackId);

            printQueryResult("更新行数: " + rowsAffected);

            if (rowsAffected == 0) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new MarkAsResolvedResponse(false, "标记为已处理失败", null)
                );
            }

            // 7. 记录变更日志
            String logSql = "INSERT INTO feedback_change_log (feedback_id, field, old_value, new_value, changed_by, reason, created_at) " +
                    "VALUES (?, 'status', ?, 'completed', ?, '标记为已处理', NOW())";

            jdbcTemplate.update(logSql,
                    feedbackId,
                    currentStatus,
                    userId
            );

            // 8. 准备响应数据
            MarkAsResolvedData resolvedData = new MarkAsResolvedData(
                    feedbackId,
                    true,
                    LocalDateTime.now().toString()
            );

            MarkAsResolvedResponse response = new MarkAsResolvedResponse(
                    true, "反馈已标记为已处理", resolvedData
            );

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("标记反馈为已处理过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new MarkAsResolvedResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: FeedbackMarkAsResolved.java ---

--- 开始文件: FeedbackReply.java ---
package com.vue.readingapp.feedback;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.UUID;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.core.type.TypeReference;

@RestController
@RequestMapping("/api/v1/feedback")
public class FeedbackReply {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到回复反馈请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=====================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class ReplyRequest {
        private String feedbackId;
        private String message;
        private Boolean isInternal;
        private List<Map<String, Object>> attachments;

        public String getFeedbackId() { return feedbackId; }
        public void setFeedbackId(String feedbackId) { this.feedbackId = feedbackId; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public Boolean getIsInternal() { return isInternal; }
        public void setIsInternal(Boolean isInternal) { this.isInternal = isInternal; }

        public List<Map<String, Object>> getAttachments() { return attachments; }
        public void setAttachments(List<Map<String, Object>> attachments) { this.attachments = attachments; }
    }

    // 响应DTO
    public static class ReplyResponse {
        private boolean success;
        private String message;
        private ReplyData data;

        public ReplyResponse(boolean success, String message, ReplyData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public ReplyData getData() { return data; }
        public void setData(ReplyData data) { this.data = data; }
    }

    public static class ReplyData {
        private String id;
        private String feedbackId;
        private String message;
        private String userId;
        private String userName;
        private String userAvatar;
        private boolean isInternal;
        private List<Map<String, Object>> attachments;
        private String createdAt;

        public ReplyData(String id, String feedbackId, String message, String userId, String userName,
                         String userAvatar, boolean isInternal, List<Map<String, Object>> attachments, String createdAt) {
            this.id = id;
            this.feedbackId = feedbackId;
            this.message = message;
            this.userId = userId;
            this.userName = userName;
            this.userAvatar = userAvatar;
            this.isInternal = isInternal;
            this.attachments = attachments;
            this.createdAt = createdAt;
        }

        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getFeedbackId() { return feedbackId; }
        public void setFeedbackId(String feedbackId) { this.feedbackId = feedbackId; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public String getUserId() { return userId; }
        public void setUserId(String userId) { this.userId = userId; }

        public String getUserName() { return userName; }
        public void setUserName(String userName) { this.userName = userName; }

        public String getUserAvatar() { return userAvatar; }
        public void setUserAvatar(String userAvatar) { this.userAvatar = userAvatar; }

        public boolean isInternal() { return isInternal; }
        public void setInternal(boolean isInternal) { this.isInternal = isInternal; }

        public List<Map<String, Object>> getAttachments() { return attachments; }
        public void setAttachments(List<Map<String, Object>> attachments) { this.attachments = attachments; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }
    }

    @PostMapping("/{feedbackId}/reply")
    public ResponseEntity<ReplyResponse> replyToFeedback(
            @PathVariable String feedbackId,
            @RequestBody ReplyRequest request,
            @RequestHeader(value = "X-User-Id", required = false) String userId) {

        // 设置feedbackId
        request.setFeedbackId(feedbackId);

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证参数
            if (feedbackId == null || feedbackId.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new ReplyResponse(false, "反馈ID不能为空", null)
                );
            }

            if (request.getMessage() == null || request.getMessage().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new ReplyResponse(false, "回复内容不能为空", null)
                );
            }

            // 2. 验证用户身份
            if (userId == null || userId.trim().isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ReplyResponse(false, "用户未登录", null)
                );
            }

            // 3. 检查反馈是否存在
            String checkSql = "SELECT feedback_id FROM user_feedback WHERE feedback_id = ?";
            List<Map<String, Object>> feedbackList = jdbcTemplate.queryForList(checkSql, feedbackId);

            if (feedbackList.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new ReplyResponse(false, "未找到指定的反馈", null)
                );
            }

            // 4. 获取用户信息
            String userSql = "SELECT username, avatar_url FROM users WHERE user_id = ?";
            List<Map<String, Object>> userList = jdbcTemplate.queryForList(userSql, userId);

            if (userList.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ReplyResponse(false, "用户不存在", null)
                );
            }

            Map<String, Object> user = userList.get(0);
            String userName = (String) user.get("username");
            String userAvatar = (String) user.get("avatar_url");

            // 5. 处理attachments
            String attachmentsJson = "[]";
            if (request.getAttachments() != null && !request.getAttachments().isEmpty()) {
                attachmentsJson = objectMapper.writeValueAsString(request.getAttachments());
            }

            // 6. 生成回复ID
            String replyId = "reply_" + UUID.randomUUID().toString().substring(0, 8);

            // 7. 插入回复记录
            String insertSql = "INSERT INTO feedback_replies (reply_id, feedback_id, user_id, message, is_internal, attachments, created_at, updated_at) " +
                    "VALUES (?, ?, ?, ?, ?, ?, NOW(), NOW())";

            boolean isInternal = request.getIsInternal() != null ? request.getIsInternal() : false;

            int rowsAffected = jdbcTemplate.update(insertSql,
                    replyId,
                    feedbackId,
                    userId,
                    request.getMessage(),
                    isInternal,
                    attachmentsJson
            );

            printQueryResult("插入回复行数: " + rowsAffected);

            if (rowsAffected == 0) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new ReplyResponse(false, "回复失败", null)
                );
            }

            // 8. 更新反馈的评论数量
            String updateCommentCountSql = "UPDATE user_feedback SET comment_count = comment_count + 1, updated_at = NOW() WHERE feedback_id = ?";
            jdbcTemplate.update(updateCommentCountSql, feedbackId);

            // 9. 查询刚插入的回复
            String selectSql = "SELECT * FROM feedback_replies WHERE reply_id = ?";
            List<Map<String, Object>> replyList = jdbcTemplate.queryForList(selectSql, replyId);
            printQueryResult("回复详情: " + replyList);

            if (replyList.isEmpty()) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new ReplyResponse(false, "无法获取回复信息", null)
                );
            }

            Map<String, Object> reply = replyList.get(0);

            // 10. 准备响应数据
            List<Map<String, Object>> responseAttachments = request.getAttachments();
            if (responseAttachments == null) {
                responseAttachments = new ArrayList<>();
            }

            ReplyData replyData = new ReplyData(
                    replyId,
                    feedbackId,
                    request.getMessage(),
                    userId,
                    userName,
                    userAvatar,
                    isInternal,
                    responseAttachments,
                    reply.get("created_at").toString()
            );

            ReplyResponse response = new ReplyResponse(true, "回复成功", replyData);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("回复反馈过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ReplyResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: FeedbackReply.java ---

--- 开始文件: FeedbackSearch.java ---
package com.vue.readingapp.feedback;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.UUID;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.core.type.TypeReference;

@RestController
@RequestMapping("/api/v1/feedback")
public class FeedbackSearch {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到搜索反馈请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=====================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class SearchRequest {
        private String keyword;
        private Integer page;
        private Integer pageSize;
        private String sortBy;
        private String sortOrder;
        private Boolean includeClosed;

        public String getKeyword() { return keyword; }
        public void setKeyword(String keyword) { this.keyword = keyword; }

        public Integer getPage() { return page; }
        public void setPage(Integer page) { this.page = page; }

        public Integer getPageSize() { return pageSize; }
        public void setPageSize(Integer pageSize) { this.pageSize = pageSize; }

        public String getSortBy() { return sortBy; }
        public void setSortBy(String sortBy) { this.sortBy = sortBy; }

        public String getSortOrder() { return sortOrder; }
        public void setSortOrder(String sortOrder) { this.sortOrder = sortOrder; }

        public Boolean getIncludeClosed() { return includeClosed; }
        public void setIncludeClosed(Boolean includeClosed) { this.includeClosed = includeClosed; }
    }

    // 响应DTO
    public static class SearchResponse {
        private boolean success;
        private String message;
        private SearchData data;

        public SearchResponse(boolean success, String message, SearchData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public SearchData getData() { return data; }
        public void setData(SearchData data) { this.data = data; }
    }

    public static class SearchData {
        private int total;
        private int page;
        private int pageSize;
        private int totalPages;
        private List<FeedbackItem> items;
        private Map<String, Object> filters;
        private Map<String, Object> statistics;

        public SearchData(int total, int page, int pageSize, int totalPages,
                          List<FeedbackItem> items, Map<String, Object> filters,
                          Map<String, Object> statistics) {
            this.total = total;
            this.page = page;
            this.pageSize = pageSize;
            this.totalPages = totalPages;
            this.items = items;
            this.filters = filters;
            this.statistics = statistics;
        }

        public int getTotal() { return total; }
        public void setTotal(int total) { this.total = total; }

        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public int getPageSize() { return pageSize; }
        public void setPageSize(int pageSize) { this.pageSize = pageSize; }

        public int getTotalPages() { return totalPages; }
        public void setTotalPages(int totalPages) { this.totalPages = totalPages; }

        public List<FeedbackItem> getItems() { return items; }
        public void setItems(List<FeedbackItem> items) { this.items = items; }

        public Map<String, Object> getFilters() { return filters; }
        public void setFilters(Map<String, Object> filters) { this.filters = filters; }

        public Map<String, Object> getStatistics() { return statistics; }
        public void setStatistics(Map<String, Object> statistics) { this.statistics = statistics; }
    }

    public static class FeedbackItem {
        private String id;
        private String type;
        private String title;
        private String content;
        private String status;
        private String priority;
        private int upvotes;
        private int downvotes;
        private String userId;
        private String userName;
        private List<Map<String, Object>> attachments;
        private Map<String, Object> metadata;
        private String createdAt;
        private String updatedAt;
        private String assignedTo;
        private String assignedAt;
        private String completedAt;

        // Getters and Setters
        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public String getTitle() { return title; }
        public void setTitle(String title) { this.title = title; }

        public String getContent() { return content; }
        public void setContent(String content) { this.content = content; }

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public String getPriority() { return priority; }
        public void setPriority(String priority) { this.priority = priority; }

        public int getUpvotes() { return upvotes; }
        public void setUpvotes(int upvotes) { this.upvotes = upvotes; }

        public int getDownvotes() { return downvotes; }
        public void setDownvotes(int downvotes) { this.downvotes = downvotes; }

        public String getUserId() { return userId; }
        public void setUserId(String userId) { this.userId = userId; }

        public String getUserName() { return userName; }
        public void setUserName(String userName) { this.userName = userName; }

        public List<Map<String, Object>> getAttachments() { return attachments; }
        public void setAttachments(List<Map<String, Object>> attachments) { this.attachments = attachments; }

        public Map<String, Object> getMetadata() { return metadata; }
        public void setMetadata(Map<String, Object> metadata) { this.metadata = metadata; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }

        public String getAssignedTo() { return assignedTo; }
        public void setAssignedTo(String assignedTo) { this.assignedTo = assignedTo; }

        public String getAssignedAt() { return assignedAt; }
        public void setAssignedAt(String assignedAt) { this.assignedAt = assignedAt; }

        public String getCompletedAt() { return completedAt; }
        public void setCompletedAt(String completedAt) { this.completedAt = completedAt; }
    }

    @GetMapping("/search")
    public ResponseEntity<SearchResponse> searchFeedback(
            @RequestParam(required = false) String keyword,
            @RequestParam(defaultValue = "1") Integer page,
            @RequestParam(defaultValue = "20") Integer pageSize,
            @RequestParam(defaultValue = "relevance") String sortBy,
            @RequestParam(defaultValue = "desc") String sortOrder,
            @RequestParam(defaultValue = "false") Boolean includeClosed) {

        // 创建请求对象用于打印
        SearchRequest request = new SearchRequest();
        request.setKeyword(keyword);
        request.setPage(page);
        request.setPageSize(pageSize);
        request.setSortBy(sortBy);
        request.setSortOrder(sortOrder);
        request.setIncludeClosed(includeClosed);

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 参数验证和默认值设置
            if (page == null || page < 1) page = 1;
            if (pageSize == null || pageSize < 1) pageSize = 20;
            if (pageSize > 100) pageSize = 100;

            // 2. 构建查询条件
            List<Object> params = new ArrayList<>();
            StringBuilder whereClause = new StringBuilder(" WHERE 1=1 ");

            // 处理关键词搜索
            if (keyword != null && !keyword.trim().isEmpty()) {
                String searchKeyword = "%" + keyword + "%";
                whereClause.append(" AND (title LIKE ? OR content LIKE ?) ");
                params.add(searchKeyword);
                params.add(searchKeyword);
            }

            // 处理是否包含已关闭的反馈
            if (!includeClosed) {
                whereClause.append(" AND status NOT IN ('completed', 'rejected', 'duplicate') ");
            }

            // 3. 获取总数
            String countSql = "SELECT COUNT(*) as total FROM user_feedback " + whereClause.toString();
            Integer total = jdbcTemplate.queryForObject(countSql, Integer.class, params.toArray());
            if (total == null) total = 0;

            // 4. 计算分页
            int totalPages = (int) Math.ceil((double) total / pageSize);
            int offset = (page - 1) * pageSize;

            // 5. 构建排序
            String orderByClause = " ORDER BY ";
            if ("relevance".equals(sortBy) && keyword != null && !keyword.trim().isEmpty()) {
                // 简单相关性排序：标题匹配优先于内容匹配
                orderByClause += "CASE WHEN title LIKE ? THEN 1 ELSE 2 END, ";
                params.add("%" + keyword + "%");
            }

            orderByClause += "created_at ";
            orderByClause += "desc".equalsIgnoreCase(sortOrder) ? "DESC" : "ASC";

            // 6. 查询数据
            String querySql = "SELECT f.*, u.username as user_name " +
                    "FROM user_feedback f " +
                    "LEFT JOIN users u ON f.user_id = u.user_id " +
                    whereClause.toString() +
                    orderByClause +
                    " LIMIT ? OFFSET ?";

            List<Object> queryParams = new ArrayList<>(params);
            queryParams.add(pageSize);
            queryParams.add(offset);

            List<Map<String, Object>> feedbackList = jdbcTemplate.queryForList(querySql, queryParams.toArray());
            printQueryResult("搜索到 " + feedbackList.size() + " 条记录");

            // 7. 转换数据
            List<FeedbackItem> items = new ArrayList<>();
            for (Map<String, Object> row : feedbackList) {
                FeedbackItem item = new FeedbackItem();
                item.setId((String) row.get("feedback_id"));
                item.setType((String) row.get("type"));
                item.setTitle((String) row.get("title"));
                item.setContent((String) row.get("content"));
                item.setStatus((String) row.get("status"));
                item.setPriority((String) row.get("priority"));
                item.setUpvotes(((Number) row.get("upvotes")).intValue());
                item.setDownvotes(((Number) row.get("downvotes")).intValue());
                item.setUserId((String) row.get("user_id"));
                item.setUserName((String) row.get("user_name"));

                // 处理attachments JSON
                String attachmentsJson = (String) row.get("attachments");
                if (attachmentsJson != null && !attachmentsJson.isEmpty() && !"[]".equals(attachmentsJson)) {
                    try {
                        List<Map<String, Object>> attachments = objectMapper.readValue(
                                attachmentsJson, new TypeReference<List<Map<String, Object>>>() {});
                        item.setAttachments(attachments);
                    } catch (Exception e) {
                        item.setAttachments(new ArrayList<>());
                    }
                } else {
                    item.setAttachments(new ArrayList<>());
                }

                // 处理metadata JSON
                String metadataJson = (String) row.get("metadata");
                if (metadataJson != null && !metadataJson.isEmpty() && !"{}".equals(metadataJson)) {
                    try {
                        Map<String, Object> metadata = objectMapper.readValue(
                                metadataJson, new TypeReference<Map<String, Object>>() {});
                        item.setMetadata(metadata);
                    } catch (Exception e) {
                        item.setMetadata(new HashMap<>());
                    }
                } else {
                    item.setMetadata(new HashMap<>());
                }

                item.setCreatedAt(row.get("created_at").toString());
                item.setUpdatedAt(row.get("updated_at").toString());
                item.setAssignedTo((String) row.get("assigned_to"));
                item.setAssignedAt(row.get("assigned_at") != null ? row.get("assigned_at").toString() : null);
                item.setCompletedAt(row.get("completed_at") != null ? row.get("completed_at").toString() : null);

                items.add(item);
            }

            // 8. 准备过滤器信息
            Map<String, Object> filters = new HashMap<>();
            filters.put("search", keyword);
            filters.put("sortBy", sortBy);
            filters.put("sortOrder", sortOrder);

            // 9. 准备统计信息（简化处理）
            Map<String, Object> statistics = new HashMap<>();
            statistics.put("total", total);

            // 10. 准备响应数据
            SearchData searchData = new SearchData(
                    total, page, pageSize, totalPages, items, filters, statistics
            );

            SearchResponse response = new SearchResponse(
                    true, "搜索反馈成功", searchData
            );

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("搜索反馈过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new SearchResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: FeedbackSearch.java ---

--- 开始文件: FeedbackSubmit.java ---
package com.vue.readingapp.feedback;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.UUID;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.core.type.TypeReference;

@RestController
@RequestMapping("/api/v1/feedback")
public class FeedbackSubmit {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到提交反馈请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=====================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class SubmitRequest {
        private String title;
        private String content;
        private String type;
        private String priority;
        private List<Attachment> attachments;
        private Map<String, Object> metadata;

        public String getTitle() { return title; }
        public void setTitle(String title) { this.title = title; }

        public String getContent() { return content; }
        public void setContent(String content) { this.content = content; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public String getPriority() { return priority; }
        public void setPriority(String priority) { this.priority = priority; }

        public List<Attachment> getAttachments() { return attachments; }
        public void setAttachments(List<Attachment> attachments) { this.attachments = attachments; }

        public Map<String, Object> getMetadata() { return metadata; }
        public void setMetadata(Map<String, Object> metadata) { this.metadata = metadata; }
    }

    public static class Attachment {
        private String name;
        private String url;
        private long size;

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getUrl() { return url; }
        public void setUrl(String url) { this.url = url; }

        public long getSize() { return size; }
        public void setSize(long size) { this.size = size; }
    }

    // 响应DTO
    public static class SubmitResponse {
        private boolean success;
        private String message;
        private FeedbackData data;

        public SubmitResponse(boolean success, String message, FeedbackData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public FeedbackData getData() { return data; }
        public void setData(FeedbackData data) { this.data = data; }
    }

    public static class FeedbackData {
        private String id;
        private String type;
        private String title;
        private String content;
        private String status;
        private String priority;
        private int upvotes;
        private int downvotes;
        private String userId;
        private String userName;
        private List<Attachment> attachments;
        private Map<String, Object> metadata;
        private String createdAt;

        public FeedbackData(String id, String type, String title, String content, String status,
                            String priority, int upvotes, int downvotes, String userId, String userName,
                            List<Attachment> attachments, Map<String, Object> metadata, String createdAt) {
            this.id = id;
            this.type = type;
            this.title = title;
            this.content = content;
            this.status = status;
            this.priority = priority;
            this.upvotes = upvotes;
            this.downvotes = downvotes;
            this.userId = userId;
            this.userName = userName;
            this.attachments = attachments;
            this.metadata = metadata;
            this.createdAt = createdAt;
        }

        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public String getTitle() { return title; }
        public void setTitle(String title) { this.title = title; }

        public String getContent() { return content; }
        public void setContent(String content) { this.content = content; }

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public String getPriority() { return priority; }
        public void setPriority(String priority) { this.priority = priority; }

        public int getUpvotes() { return upvotes; }
        public void setUpvotes(int upvotes) { this.upvotes = upvotes; }

        public int getDownvotes() { return downvotes; }
        public void setDownvotes(int downvotes) { this.downvotes = downvotes; }

        public String getUserId() { return userId; }
        public void setUserId(String userId) { this.userId = userId; }

        public String getUserName() { return userName; }
        public void setUserName(String userName) { this.userName = userName; }

        public List<Attachment> getAttachments() { return attachments; }
        public void setAttachments(List<Attachment> attachments) { this.attachments = attachments; }

        public Map<String, Object> getMetadata() { return metadata; }
        public void setMetadata(Map<String, Object> metadata) { this.metadata = metadata; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }
    }

    @PostMapping("/submit")
    public ResponseEntity<SubmitResponse> submitFeedback(
            @RequestBody SubmitRequest request,
            @RequestHeader(value = "X-User-Id", required = false) String userId,
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证用户身份
            String actualUserId = null;
            String userName = "匿名用户";

            if (authHeader != null && authHeader.startsWith("Bearer ")) {
                String token = authHeader.substring(7);
                // 从token中获取用户信息（简化处理）
                String userSql = "SELECT user_id, username FROM users WHERE user_id = ?";
                List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, userId);

                if (!users.isEmpty()) {
                    Map<String, Object> user = users.get(0);
                    actualUserId = String.valueOf(user.get("user_id"));
                    userName = (String) user.get("username");
                }
            }

            if (actualUserId == null) {
                // 如果没有用户ID，使用默认值（课设简化处理）
                actualUserId = "user_anonymous";
            }

            // 2. 验证请求数据
            if (request.getTitle() == null || request.getTitle().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new SubmitResponse(false, "反馈标题不能为空", null)
                );
            }

            if (request.getContent() == null || request.getContent().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new SubmitResponse(false, "反馈内容不能为空", null)
                );
            }

            // 3. 验证type和priority的合法性
            String type = request.getType();
            if (type == null) {
                type = "other";
            } else {
                List<String> validTypes = List.of("bug", "feature", "improvement", "question", "other");
                if (!validTypes.contains(type)) {
                    type = "other";
                }
            }

            String priority = request.getPriority();
            if (priority == null) {
                priority = "medium";
            } else {
                List<String> validPriorities = List.of("low", "medium", "high", "critical");
                if (!validPriorities.contains(priority)) {
                    priority = "medium";
                }
            }

            // 4. 处理attachments和metadata
            String attachmentsJson = "[]";
            if (request.getAttachments() != null && !request.getAttachments().isEmpty()) {
                attachmentsJson = objectMapper.writeValueAsString(request.getAttachments());
            }

            String metadataJson = "{}";
            if (request.getMetadata() != null && !request.getMetadata().isEmpty()) {
                metadataJson = objectMapper.writeValueAsString(request.getMetadata());
            }

            // 5. 生成反馈ID
            String feedbackId = "fb_" + UUID.randomUUID().toString().substring(0, 8);

            // 6. 插入数据库
            String insertSql = "INSERT INTO user_feedback (feedback_id, user_id, title, content, type, status, priority, " +
                    "upvotes, downvotes, view_count, comment_count, attachments, metadata, created_at, updated_at) " +
                    "VALUES (?, ?, ?, ?, ?, 'pending', ?, 0, 0, 0, 0, ?, ?, NOW(), NOW())";

            int rowsAffected = jdbcTemplate.update(insertSql,
                    feedbackId,
                    actualUserId,
                    request.getTitle(),
                    request.getContent(),
                    type,
                    priority,
                    attachmentsJson,
                    metadataJson
            );

            printQueryResult("插入行数: " + rowsAffected);

            if (rowsAffected == 0) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new SubmitResponse(false, "提交反馈失败", null)
                );
            }

            // 7. 查询刚插入的反馈
            String selectSql = "SELECT * FROM user_feedback WHERE feedback_id = ?";
            List<Map<String, Object>> feedbackList = jdbcTemplate.queryForList(selectSql, feedbackId);
            printQueryResult(feedbackList);

            if (feedbackList.isEmpty()) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new SubmitResponse(false, "无法获取提交的反馈信息", null)
                );
            }

            Map<String, Object> feedback = feedbackList.get(0);

            // 8. 准备响应数据
            List<Attachment> responseAttachments = request.getAttachments();
            Map<String, Object> responseMetadata = request.getMetadata();

            FeedbackData feedbackData = new FeedbackData(
                    feedbackId,
                    type,
                    request.getTitle(),
                    request.getContent(),
                    "pending",
                    priority,
                    0,
                    0,
                    actualUserId,
                    userName,
                    responseAttachments,
                    responseMetadata,
                    feedback.get("created_at").toString()
            );

            SubmitResponse response = new SubmitResponse(true, "反馈提交成功", feedbackData);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("提交反馈过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new SubmitResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: FeedbackSubmit.java ---

--- 开始文件: FeedbackUpdate.java ---
package com.vue.readingapp.feedback;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.UUID;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.core.type.TypeReference;

@RestController
@RequestMapping("/api/v1/feedback")
public class FeedbackUpdate {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到更新反馈请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=====================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class UpdateRequest {
        private String feedbackId;
        private String title;
        private String content;
        private String type;
        private String priority;
        private List<Map<String, Object>> attachments;
        private Map<String, Object> metadata;

        public String getFeedbackId() { return feedbackId; }
        public void setFeedbackId(String feedbackId) { this.feedbackId = feedbackId; }

        public String getTitle() { return title; }
        public void setTitle(String title) { this.title = title; }

        public String getContent() { return content; }
        public void setContent(String content) { this.content = content; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public String getPriority() { return priority; }
        public void setPriority(String priority) { this.priority = priority; }

        public List<Map<String, Object>> getAttachments() { return attachments; }
        public void setAttachments(List<Map<String, Object>> attachments) { this.attachments = attachments; }

        public Map<String, Object> getMetadata() { return metadata; }
        public void setMetadata(Map<String, Object> metadata) { this.metadata = metadata; }
    }

    // 响应DTO
    public static class UpdateResponse {
        private boolean success;
        private String message;
        private FeedbackData data;

        public UpdateResponse(boolean success, String message, FeedbackData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public FeedbackData getData() { return data; }
        public void setData(FeedbackData data) { this.data = data; }
    }

    public static class FeedbackData {
        private String id;
        private String type;
        private String title;
        private String content;
        private String status;
        private String priority;
        private int upvotes;
        private int downvotes;
        private String userId;
        private String userName;
        private List<Map<String, Object>> attachments;
        private Map<String, Object> metadata;
        private String createdAt;
        private String updatedAt;
        private String assignedTo;
        private String assignedAt;
        private String completedAt;

        public FeedbackData(String id, String type, String title, String content, String status,
                            String priority, int upvotes, int downvotes, String userId, String userName,
                            List<Map<String, Object>> attachments, Map<String, Object> metadata,
                            String createdAt, String updatedAt, String assignedTo, String assignedAt,
                            String completedAt) {
            this.id = id;
            this.type = type;
            this.title = title;
            this.content = content;
            this.status = status;
            this.priority = priority;
            this.upvotes = upvotes;
            this.downvotes = downvotes;
            this.userId = userId;
            this.userName = userName;
            this.attachments = attachments;
            this.metadata = metadata;
            this.createdAt = createdAt;
            this.updatedAt = updatedAt;
            this.assignedTo = assignedTo;
            this.assignedAt = assignedAt;
            this.completedAt = completedAt;
        }

        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public String getTitle() { return title; }
        public void setTitle(String title) { this.title = title; }

        public String getContent() { return content; }
        public void setContent(String content) { this.content = content; }

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public String getPriority() { return priority; }
        public void setPriority(String priority) { this.priority = priority; }

        public int getUpvotes() { return upvotes; }
        public void setUpvotes(int upvotes) { this.upvotes = upvotes; }

        public int getDownvotes() { return downvotes; }
        public void setDownvotes(int downvotes) { this.downvotes = downvotes; }

        public String getUserId() { return userId; }
        public void setUserId(String userId) { this.userId = userId; }

        public String getUserName() { return userName; }
        public void setUserName(String userName) { this.userName = userName; }

        public List<Map<String, Object>> getAttachments() { return attachments; }
        public void setAttachments(List<Map<String, Object>> attachments) { this.attachments = attachments; }

        public Map<String, Object> getMetadata() { return metadata; }
        public void setMetadata(Map<String, Object> metadata) { this.metadata = metadata; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }

        public String getAssignedTo() { return assignedTo; }
        public void setAssignedTo(String assignedTo) { this.assignedTo = assignedTo; }

        public String getAssignedAt() { return assignedAt; }
        public void setAssignedAt(String assignedAt) { this.assignedAt = assignedAt; }

        public String getCompletedAt() { return completedAt; }
        public void setCompletedAt(String completedAt) { this.completedAt = completedAt; }
    }

    @PutMapping("/{feedbackId}")
    public ResponseEntity<UpdateResponse> updateFeedback(
            @PathVariable String feedbackId,
            @RequestBody UpdateRequest request,
            @RequestHeader(value = "X-User-Id", required = false) String userId) {

        // 设置feedbackId
        request.setFeedbackId(feedbackId);

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证参数
            if (feedbackId == null || feedbackId.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new UpdateResponse(false, "反馈ID不能为空", null)
                );
            }

            // 2. 验证用户身份
            if (userId == null || userId.trim().isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateResponse(false, "用户未登录", null)
                );
            }

            // 3. 检查反馈是否存在
            String checkSql = "SELECT f.*, u.username as user_name FROM user_feedback f " +
                    "LEFT JOIN users u ON f.user_id = u.user_id " +
                    "WHERE f.feedback_id = ?";

            List<Map<String, Object>> feedbackList = jdbcTemplate.queryForList(checkSql, feedbackId);
            printQueryResult("原始反馈信息: " + feedbackList);

            if (feedbackList.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new UpdateResponse(false, "未找到指定的反馈", null)
                );
            }

            Map<String, Object> originalFeedback = feedbackList.get(0);
            String feedbackUserId = (String) originalFeedback.get("user_id");

            // 4. 检查权限（只有反馈创建者或管理员可以更新）
            boolean hasPermission = false;

            if (userId.equals(feedbackUserId)) {
                hasPermission = true;
            } else {
                // 检查是否是管理员
                String adminCheckSql = "SELECT role FROM users WHERE user_id = ?";
                List<Map<String, Object>> userList = jdbcTemplate.queryForList(adminCheckSql, userId);

                if (!userList.isEmpty()) {
                    Map<String, Object> user = userList.get(0);
                    String role = (String) user.get("role");

                    if ("admin".equals(role) || "moderator".equals(role)) {
                        hasPermission = true;
                    }
                }
            }

            if (!hasPermission) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN).body(
                        new UpdateResponse(false, "没有权限更新此反馈", null)
                );
            }

            // 5. 获取更新后的值
            String updateTitle = request.getTitle() != null ? request.getTitle() : (String) originalFeedback.get("title");
            String updateContent = request.getContent() != null ? request.getContent() : (String) originalFeedback.get("content");
            String updateType = request.getType() != null ? request.getType() : (String) originalFeedback.get("type");
            String updatePriority = request.getPriority() != null ? request.getPriority() : (String) originalFeedback.get("priority");

            // 验证type和priority的合法性
            List<String> validTypes = List.of("bug", "feature", "improvement", "question", "other");
            if (!validTypes.contains(updateType)) {
                updateType = "other";
            }

            List<String> validPriorities = List.of("low", "medium", "high", "critical");
            if (!validPriorities.contains(updatePriority)) {
                updatePriority = "medium";
            }

            // 6. 处理attachments
            String attachmentsJson = (String) originalFeedback.get("attachments");
            if (request.getAttachments() != null && !request.getAttachments().isEmpty()) {
                attachmentsJson = objectMapper.writeValueAsString(request.getAttachments());
            }

            // 7. 处理metadata
            String metadataJson = (String) originalFeedback.get("metadata");
            if (request.getMetadata() != null && !request.getMetadata().isEmpty()) {
                metadataJson = objectMapper.writeValueAsString(request.getMetadata());
            }

            // 8. 更新反馈记录
            String updateSql = "UPDATE user_feedback SET title = ?, content = ?, type = ?, priority = ?, " +
                    "attachments = ?, metadata = ?, updated_at = NOW() WHERE feedback_id = ?";

            int rowsAffected = jdbcTemplate.update(updateSql,
                    updateTitle,
                    updateContent,
                    updateType,
                    updatePriority,
                    attachmentsJson,
                    metadataJson,
                    feedbackId
            );

            printQueryResult("更新行数: " + rowsAffected);

            if (rowsAffected == 0) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new UpdateResponse(false, "更新反馈失败", null)
                );
            }

            // 9. 记录变更日志（如果字段有变化）
            recordFieldChange(feedbackId, userId, "title",
                    (String) originalFeedback.get("title"), updateTitle, "更新标题");

            recordFieldChange(feedbackId, userId, "content",
                    (String) originalFeedback.get("content"), updateContent, "更新内容");

            recordFieldChange(feedbackId, userId, "type",
                    (String) originalFeedback.get("type"), updateType, "更新类型");

            recordFieldChange(feedbackId, userId, "priority",
                    (String) originalFeedback.get("priority"), updatePriority, "更新优先级");

            // 10. 查询更新后的反馈
            String selectSql = "SELECT f.*, u.username as user_name FROM user_feedback f " +
                    "LEFT JOIN users u ON f.user_id = u.user_id " +
                    "WHERE f.feedback_id = ?";

            List<Map<String, Object>> updatedFeedbackList = jdbcTemplate.queryForList(selectSql, feedbackId);
            printQueryResult("更新后的反馈信息: " + updatedFeedbackList);

            if (updatedFeedbackList.isEmpty()) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new UpdateResponse(false, "无法获取更新后的反馈信息", null)
                );
            }

            Map<String, Object> updatedFeedback = updatedFeedbackList.get(0);

            // 11. 准备响应数据
            List<Map<String, Object>> responseAttachments = request.getAttachments();
            if (responseAttachments == null) {
                responseAttachments = new ArrayList<>();
                // 尝试从JSON解析
                String attJson = (String) updatedFeedback.get("attachments");
                if (attJson != null && !attJson.isEmpty() && !"[]".equals(attJson)) {
                    try {
                        responseAttachments = objectMapper.readValue(
                                attJson, new TypeReference<List<Map<String, Object>>>() {});
                    } catch (Exception e) {
                        // 忽略解析错误
                    }
                }
            }

            Map<String, Object> responseMetadata = request.getMetadata();
            if (responseMetadata == null) {
                responseMetadata = new HashMap<>();
                // 尝试从JSON解析
                String metaJson = (String) updatedFeedback.get("metadata");
                if (metaJson != null && !metaJson.isEmpty() && !"{}".equals(metaJson)) {
                    try {
                        responseMetadata = objectMapper.readValue(
                                metaJson, new TypeReference<Map<String, Object>>() {});
                    } catch (Exception e) {
                        // 忽略解析错误
                    }
                }
            }

            FeedbackData feedbackData = new FeedbackData(
                    feedbackId,
                    updateType,
                    updateTitle,
                    updateContent,
                    (String) updatedFeedback.get("status"),
                    updatePriority,
                    ((Number) updatedFeedback.get("upvotes")).intValue(),
                    ((Number) updatedFeedback.get("downvotes")).intValue(),
                    (String) updatedFeedback.get("user_id"),
                    (String) updatedFeedback.get("user_name"),
                    responseAttachments,
                    responseMetadata,
                    updatedFeedback.get("created_at").toString(),
                    updatedFeedback.get("updated_at").toString(),
                    (String) updatedFeedback.get("assigned_to"),
                    updatedFeedback.get("assigned_at") != null ? updatedFeedback.get("assigned_at").toString() : null,
                    updatedFeedback.get("completed_at") != null ? updatedFeedback.get("completed_at").toString() : null
            );

            UpdateResponse response = new UpdateResponse(
                    true, "更新反馈成功", feedbackData
            );

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("更新反馈过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdateResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private void recordFieldChange(String feedbackId, String userId, String field,
                                   String oldValue, String newValue, String reason) {
        try {
            if (oldValue == null) oldValue = "";
            if (newValue == null) newValue = "";

            // 只有当值发生变化时才记录
            if (!oldValue.equals(newValue)) {
                String logSql = "INSERT INTO feedback_change_log (feedback_id, field, old_value, new_value, " +
                        "changed_by, reason, created_at) VALUES (?, ?, ?, ?, ?, ?, NOW())";

                jdbcTemplate.update(logSql,
                        feedbackId,
                        field,
                        oldValue,
                        newValue,
                        userId,
                        reason
                );
            }
        } catch (Exception e) {
            System.err.println("记录字段变更失败: " + e.getMessage());
        }
    }
}
--- 结束文件: FeedbackUpdate.java ---

--- 开始文件: FeedbackUpdateCategory.java ---
package com.vue.readingapp.feedback;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.UUID;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.core.type.TypeReference;

@RestController
@RequestMapping("/api/v1/feedback")
public class FeedbackUpdateCategory {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到更新反馈分类请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=======================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class UpdateCategoryRequest {
        private String categoryId;
        private String name;
        private String description;

        public String getCategoryId() { return categoryId; }
        public void setCategoryId(String categoryId) { this.categoryId = categoryId; }

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }
    }

    // 响应DTO
    public static class UpdateCategoryResponse {
        private boolean success;
        private String message;
        private CategoryData data;

        public UpdateCategoryResponse(boolean success, String message, CategoryData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public CategoryData getData() { return data; }
        public void setData(CategoryData data) { this.data = data; }
    }

    public static class CategoryData {
        private String id;
        private String name;
        private String value;
        private String description;
        private String icon;
        private String color;
        private String updatedAt;

        public CategoryData(String id, String name, String value, String description,
                            String icon, String color, String updatedAt) {
            this.id = id;
            this.name = name;
            this.value = value;
            this.description = description;
            this.icon = icon;
            this.color = color;
            this.updatedAt = updatedAt;
        }

        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getValue() { return value; }
        public void setValue(String value) { this.value = value; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }

        public String getIcon() { return icon; }
        public void setIcon(String icon) { this.icon = icon; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }
    }

    @PutMapping("/categories/{categoryId}")
    public ResponseEntity<UpdateCategoryResponse> updateFeedbackCategory(
            @PathVariable String categoryId,
            @RequestBody UpdateCategoryRequest request,
            @RequestHeader(value = "X-User-Id", required = false) String userId) {

        // 设置categoryId
        request.setCategoryId(categoryId);

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证参数
            if (categoryId == null || categoryId.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new UpdateCategoryResponse(false, "分类ID不能为空", null)
                );
            }

            // 2. 验证用户身份（需要管理员权限）
            if (userId == null || userId.trim().isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateCategoryResponse(false, "用户未登录", null)
                );
            }

            // 检查是否是管理员
            String adminCheckSql = "SELECT role FROM users WHERE user_id = ?";
            List<Map<String, Object>> userList = jdbcTemplate.queryForList(adminCheckSql, userId);

            boolean isAdmin = false;
            if (!userList.isEmpty()) {
                Map<String, Object> user = userList.get(0);
                String role = (String) user.get("role");
                isAdmin = "admin".equals(role) || "moderator".equals(role);
            }

            if (!isAdmin) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN).body(
                        new UpdateCategoryResponse(false, "需要管理员权限", null)
                );
            }

            // 3. 检查分类是否存在
            String checkSql = "SELECT * FROM feedback_categories WHERE category_id = ?";
            List<Map<String, Object>> categoryList = jdbcTemplate.queryForList(checkSql, categoryId);

            if (categoryList.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new UpdateCategoryResponse(false, "未找到指定的分类", null)
                );
            }

            Map<String, Object> existingCategory = categoryList.get(0);

            // 4. 构建更新字段
            String updateName = request.getName() != null ? request.getName() : (String) existingCategory.get("name");
            String updateDescription = request.getDescription() != null ? request.getDescription() : (String) existingCategory.get("description");

            // 5. 更新分类记录
            String updateSql = "UPDATE feedback_categories SET name = ?, description = ?, updated_at = NOW() WHERE category_id = ?";

            int rowsAffected = jdbcTemplate.update(updateSql,
                    updateName,
                    updateDescription,
                    categoryId
            );

            printQueryResult("更新行数: " + rowsAffected);

            if (rowsAffected == 0) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new UpdateCategoryResponse(false, "更新分类失败", null)
                );
            }

            // 6. 查询更新后的分类
            String selectSql = "SELECT * FROM feedback_categories WHERE category_id = ?";
            List<Map<String, Object>> updatedCategoryList = jdbcTemplate.queryForList(selectSql, categoryId);
            printQueryResult("更新后的分类详情: " + updatedCategoryList);

            if (updatedCategoryList.isEmpty()) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new UpdateCategoryResponse(false, "无法获取更新的分类信息", null)
                );
            }

            Map<String, Object> updatedCategory = updatedCategoryList.get(0);

            // 7. 准备响应数据
            CategoryData categoryData = new CategoryData(
                    categoryId,
                    updateName,
                    (String) updatedCategory.get("value"),
                    updateDescription,
                    (String) updatedCategory.get("icon"),
                    (String) updatedCategory.get("color"),
                    updatedCategory.get("updated_at").toString()
            );

            UpdateCategoryResponse response = new UpdateCategoryResponse(
                    true, "更新反馈分类成功", categoryData
            );

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("更新反馈分类过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdateCategoryResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: FeedbackUpdateCategory.java ---

--- 开始文件: FeedbackUpdateStatus.java ---
package com.vue.readingapp.feedback;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.UUID;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.core.type.TypeReference;

@RestController
@RequestMapping("/api/v1/feedback")
public class FeedbackUpdateStatus {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到更新反馈状态请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=======================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class UpdateStatusRequest {
        private String feedbackId;
        private String status;
        private String reason;

        public String getFeedbackId() { return feedbackId; }
        public void setFeedbackId(String feedbackId) { this.feedbackId = feedbackId; }

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public String getReason() { return reason; }
        public void setReason(String reason) { this.reason = reason; }
    }

    // 响应DTO
    public static class UpdateStatusResponse {
        private boolean success;
        private String message;
        private FeedbackStatusData data;

        public UpdateStatusResponse(boolean success, String message, FeedbackStatusData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public FeedbackStatusData getData() { return data; }
        public void setData(FeedbackStatusData data) { this.data = data; }
    }

    public static class FeedbackStatusData {
        private String id;
        private String status;
        private String updatedAt;

        public FeedbackStatusData(String id, String status, String updatedAt) {
            this.id = id;
            this.status = status;
            this.updatedAt = updatedAt;
        }

        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }
    }

    @PutMapping("/{feedbackId}/status")
    public ResponseEntity<UpdateStatusResponse> updateFeedbackStatus(
            @PathVariable String feedbackId,
            @RequestBody UpdateStatusRequest request,
            @RequestHeader(value = "X-User-Id", required = false) String userId) {

        // 设置feedbackId
        request.setFeedbackId(feedbackId);

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证参数
            if (feedbackId == null || feedbackId.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new UpdateStatusResponse(false, "反馈ID不能为空", null)
                );
            }

            if (request.getStatus() == null || request.getStatus().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new UpdateStatusResponse(false, "状态不能为空", null)
                );
            }

            // 2. 验证状态值的合法性
            List<String> validStatuses = List.of("pending", "reviewing", "in_progress", "completed", "rejected", "duplicate");
            if (!validStatuses.contains(request.getStatus())) {
                return ResponseEntity.badRequest().body(
                        new UpdateStatusResponse(false, "无效的状态值", null)
                );
            }

            // 3. 检查反馈是否存在
            String checkSql = "SELECT feedback_id, status FROM user_feedback WHERE feedback_id = ?";
            List<Map<String, Object>> feedbackList = jdbcTemplate.queryForList(checkSql, feedbackId);

            if (feedbackList.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new UpdateStatusResponse(false, "未找到指定的反馈", null)
                );
            }

            Map<String, Object> feedback = feedbackList.get(0);
            String oldStatus = (String) feedback.get("status");

            // 4. 如果状态没有变化，直接返回成功
            if (oldStatus.equals(request.getStatus())) {
                FeedbackStatusData statusData = new FeedbackStatusData(
                        feedbackId,
                        request.getStatus(),
                        LocalDateTime.now().toString()
                );

                UpdateStatusResponse response = new UpdateStatusResponse(
                        true, "状态未发生变化", statusData
                );

                printResponse(response);
                return ResponseEntity.ok(response);
            }

            // 5. 更新反馈状态
            String updateSql = "UPDATE user_feedback SET status = ?, updated_at = NOW() WHERE feedback_id = ?";
            int rowsAffected = jdbcTemplate.update(updateSql, request.getStatus(), feedbackId);

            printQueryResult("更新行数: " + rowsAffected);

            if (rowsAffected == 0) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new UpdateStatusResponse(false, "更新反馈状态失败", null)
                );
            }

            // 6. 记录变更日志
            if (userId != null) {
                String logSql = "INSERT INTO feedback_change_log (feedback_id, field, old_value, new_value, changed_by, reason, created_at) " +
                        "VALUES (?, 'status', ?, ?, ?, ?, NOW())";

                jdbcTemplate.update(logSql,
                        feedbackId,
                        oldStatus,
                        request.getStatus(),
                        userId,
                        request.getReason() != null ? request.getReason() : "状态更新"
                );
            }

            // 7. 如果状态是completed，设置完成时间
            if ("completed".equals(request.getStatus())) {
                String completeSql = "UPDATE user_feedback SET completed_at = NOW() WHERE feedback_id = ?";
                jdbcTemplate.update(completeSql, feedbackId);
            }

            // 8. 查询更新后的反馈信息
            String selectSql = "SELECT feedback_id, status, updated_at FROM user_feedback WHERE feedback_id = ?";
            List<Map<String, Object>> updatedFeedback = jdbcTemplate.queryForList(selectSql, feedbackId);

            if (updatedFeedback.isEmpty()) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new UpdateStatusResponse(false, "无法获取更新后的反馈信息", null)
                );
            }

            Map<String, Object> updated = updatedFeedback.get(0);

            // 9. 准备响应数据
            FeedbackStatusData statusData = new FeedbackStatusData(
                    feedbackId,
                    (String) updated.get("status"),
                    updated.get("updated_at").toString()
            );

            UpdateStatusResponse response = new UpdateStatusResponse(
                    true, "反馈状态更新成功", statusData
            );

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("更新反馈状态过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdateStatusResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: FeedbackUpdateStatus.java ---

--- 开始文件: FeedbackVote.java ---
package com.vue.readingapp.feedback;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.UUID;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.core.type.TypeReference;

@RestController
@RequestMapping("/api/v1/feedback")
public class FeedbackVote {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到投票请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class VoteRequest {
        private String feedbackId;
        private String voteType;

        public String getFeedbackId() { return feedbackId; }
        public void setFeedbackId(String feedbackId) { this.feedbackId = feedbackId; }

        public String getVoteType() { return voteType; }
        public void setVoteType(String voteType) { this.voteType = voteType; }
    }

    // 响应DTO
    public static class VoteResponse {
        private boolean success;
        private String message;
        private VoteData data;

        public VoteResponse(boolean success, String message, VoteData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public VoteData getData() { return data; }
        public void setData(VoteData data) { this.data = data; }
    }

    public static class VoteData {
        private String feedbackId;
        private String voteType;
        private int upvotes;
        private int downvotes;
        private String votedAt;

        public VoteData(String feedbackId, String voteType, int upvotes, int downvotes, String votedAt) {
            this.feedbackId = feedbackId;
            this.voteType = voteType;
            this.upvotes = upvotes;
            this.downvotes = downvotes;
            this.votedAt = votedAt;
        }

        public String getFeedbackId() { return feedbackId; }
        public void setFeedbackId(String feedbackId) { this.feedbackId = feedbackId; }

        public String getVoteType() { return voteType; }
        public void setVoteType(String voteType) { this.voteType = voteType; }

        public int getUpvotes() { return upvotes; }
        public void setUpvotes(int upvotes) { this.upvotes = upvotes; }

        public int getDownvotes() { return downvotes; }
        public void setDownvotes(int downvotes) { this.downvotes = downvotes; }

        public String getVotedAt() { return votedAt; }
        public void setVotedAt(String votedAt) { this.votedAt = votedAt; }
    }

    @PostMapping("/{feedbackId}/vote")
    public ResponseEntity<VoteResponse> voteFeedback(
            @PathVariable String feedbackId,
            @RequestBody VoteRequest request,
            @RequestHeader(value = "X-User-Id", required = false) String userId) {

        // 设置feedbackId
        request.setFeedbackId(feedbackId);

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证参数
            if (feedbackId == null || feedbackId.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new VoteResponse(false, "反馈ID不能为空", null)
                );
            }

            if (request.getVoteType() == null || request.getVoteType().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new VoteResponse(false, "投票类型不能为空", null)
                );
            }

            // 验证投票类型
            List<String> validVoteTypes = List.of("upvote", "downvote");
            if (!validVoteTypes.contains(request.getVoteType())) {
                return ResponseEntity.badRequest().body(
                        new VoteResponse(false, "无效的投票类型", null)
                );
            }

            // 2. 验证用户身份
            if (userId == null || userId.trim().isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new VoteResponse(false, "用户未登录", null)
                );
            }

            // 3. 检查反馈是否存在
            String checkSql = "SELECT feedback_id, upvotes, downvotes FROM user_feedback WHERE feedback_id = ?";
            List<Map<String, Object>> feedbackList = jdbcTemplate.queryForList(checkSql, feedbackId);

            if (feedbackList.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new VoteResponse(false, "未找到指定的反馈", null)
                );
            }

            Map<String, Object> feedback = feedbackList.get(0);
            int currentUpvotes = ((Number) feedback.get("upvotes")).intValue();
            int currentDownvotes = ((Number) feedback.get("downvotes")).intValue();

            // 4. 检查用户是否已经投票
            String voteCheckSql = "SELECT vote_type FROM feedback_votes WHERE feedback_id = ? AND user_id = ?";
            List<Map<String, Object>> existingVotes = jdbcTemplate.queryForList(voteCheckSql, feedbackId, userId);

            String newVoteType = request.getVoteType();
            String oldVoteType = null;

            if (!existingVotes.isEmpty()) {
                // 用户已经投过票
                oldVoteType = (String) existingVotes.get(0).get("vote_type");

                if (oldVoteType.equals(newVoteType)) {
                    // 如果投的是同样的票，取消投票
                    String deleteVoteSql = "DELETE FROM feedback_votes WHERE feedback_id = ? AND user_id = ?";
                    int deleteRows = jdbcTemplate.update(deleteVoteSql, feedbackId, userId);

                    if (deleteRows > 0) {
                        // 更新反馈的投票计数
                        if ("upvote".equals(oldVoteType)) {
                            currentUpvotes--;
                        } else {
                            currentDownvotes--;
                        }

                        String updateFeedbackSql = "UPDATE user_feedback SET upvotes = ?, downvotes = ?, updated_at = NOW() WHERE feedback_id = ?";
                        jdbcTemplate.update(updateFeedbackSql, currentUpvotes, currentDownvotes, feedbackId);

                        VoteData voteData = new VoteData(
                                feedbackId,
                                "canceled",
                                currentUpvotes,
                                currentDownvotes,
                                LocalDateTime.now().toString()
                        );

                        VoteResponse response = new VoteResponse(
                                true, "投票已取消", voteData
                        );

                        printResponse(response);
                        return ResponseEntity.ok(response);
                    }
                } else {
                    // 用户改变投票类型
                    String updateVoteSql = "UPDATE feedback_votes SET vote_type = ?, created_at = NOW() WHERE feedback_id = ? AND user_id = ?";
                    int updateRows = jdbcTemplate.update(updateVoteSql, newVoteType, feedbackId, userId);

                    if (updateRows > 0) {
                        // 更新反馈的投票计数
                        if ("upvote".equals(oldVoteType)) {
                            // 原来是赞，现在是踩
                            currentUpvotes--;
                            currentDownvotes++;
                        } else {
                            // 原来是踩，现在是赞
                            currentDownvotes--;
                            currentUpvotes++;
                        }

                        String updateFeedbackSql = "UPDATE user_feedback SET upvotes = ?, downvotes = ?, updated_at = NOW() WHERE feedback_id = ?";
                        jdbcTemplate.update(updateFeedbackSql, currentUpvotes, currentDownvotes, feedbackId);

                        VoteData voteData = new VoteData(
                                feedbackId,
                                newVoteType,
                                currentUpvotes,
                                currentDownvotes,
                                LocalDateTime.now().toString()
                        );

                        VoteResponse response = new VoteResponse(
                                true, "投票类型已更改", voteData
                        );

                        printResponse(response);
                        return ResponseEntity.ok(response);
                    }
                }
            } else {
                // 用户第一次投票
                String insertVoteSql = "INSERT INTO feedback_votes (vote_id, feedback_id, user_id, vote_type, created_at) " +
                        "VALUES (?, ?, ?, ?, NOW())";

                String voteId = "vote_" + UUID.randomUUID().toString().substring(0, 8);

                int insertRows = jdbcTemplate.update(insertVoteSql,
                        voteId,
                        feedbackId,
                        userId,
                        newVoteType
                );

                if (insertRows > 0) {
                    // 更新反馈的投票计数
                    if ("upvote".equals(newVoteType)) {
                        currentUpvotes++;
                    } else {
                        currentDownvotes++;
                    }

                    String updateFeedbackSql = "UPDATE user_feedback SET upvotes = ?, downvotes = ?, updated_at = NOW() WHERE feedback_id = ?";
                    jdbcTemplate.update(updateFeedbackSql, currentUpvotes, currentDownvotes, feedbackId);

                    VoteData voteData = new VoteData(
                            feedbackId,
                            newVoteType,
                            currentUpvotes,
                            currentDownvotes,
                            LocalDateTime.now().toString()
                    );

                    VoteResponse response = new VoteResponse(
                            true, "投票成功", voteData
                    );

                    printResponse(response);
                    return ResponseEntity.ok(response);
                }
            }

            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new VoteResponse(false, "投票失败", null)
            );

        } catch (Exception e) {
            System.err.println("投票过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new VoteResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: FeedbackVote.java ---

