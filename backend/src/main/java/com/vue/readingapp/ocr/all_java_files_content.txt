--- 开始文件: OcrBatchProcess.java ---
package com.vue.readingapp.ocr;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import java.util.UUID;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.core.JsonProcessingException; // 添加这行导入
import com.fasterxml.jackson.core.type.TypeReference;

@RestController
@RequestMapping("/api/v1/documents")
public class OcrBatchProcess {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();
    private DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd'T'HH:mm:ss");

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到批量OCR处理请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=======================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class BatchOcrRequest {
        private List<String> documentIds;
        private BatchOcrOptions options;
        private Map<String, List<Integer>> pages;

        public List<String> getDocumentIds() { return documentIds; }
        public void setDocumentIds(List<String> documentIds) { this.documentIds = documentIds; }

        public BatchOcrOptions getOptions() { return options; }
        public void setOptions(BatchOcrOptions options) { this.options = options; }

        public Map<String, List<Integer>> getPages() { return pages; }
        public void setPages(Map<String, List<Integer>> pages) { this.pages = pages; }
    }

    public static class BatchOcrOptions {
        private String language;
        private Integer confidence;
        private Boolean preprocess;
        private String format;
        private Integer pageSegMode;

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }

        public Integer getConfidence() { return confidence; }
        public void setConfidence(Integer confidence) { this.confidence = confidence; }

        public Boolean getPreprocess() { return preprocess; }
        public void setPreprocess(Boolean preprocess) { this.preprocess = preprocess; }

        public String getFormat() { return format; }
        public void setFormat(String format) { this.format = format; }

        public Integer getPageSegMode() { return pageSegMode; }
        public void setPageSegMode(Integer pageSegMode) { this.pageSegMode = pageSegMode; }
    }

    // 响应DTO
    public static class BatchOcrResponse {
        private boolean success;
        private String message;
        private BatchTaskData data;

        public BatchOcrResponse(boolean success, String message, BatchTaskData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public BatchTaskData getData() { return data; }
        public void setData(BatchTaskData data) { this.data = data; }
    }

    public static class BatchTaskData {
        private String batchId;
        private Integer totalDocuments;
        private Integer totalPages;
        private Integer estimatedTime;

        public BatchTaskData(String batchId, Integer totalDocuments, Integer totalPages, Integer estimatedTime) {
            this.batchId = batchId;
            this.totalDocuments = totalDocuments;
            this.totalPages = totalPages;
            this.estimatedTime = estimatedTime;
        }

        public String getBatchId() { return batchId; }
        public void setBatchId(String batchId) { this.batchId = batchId; }

        public Integer getTotalDocuments() { return totalDocuments; }
        public void setTotalDocuments(Integer totalDocuments) { this.totalDocuments = totalDocuments; }

        public Integer getTotalPages() { return totalPages; }
        public void setTotalPages(Integer totalPages) { this.totalPages = totalPages; }

        public Integer getEstimatedTime() { return estimatedTime; }
        public void setEstimatedTime(Integer estimatedTime) { this.estimatedTime = estimatedTime; }
    }

    @PostMapping("/batch-ocr")
    public ResponseEntity<BatchOcrResponse> batchOcrProcess(@RequestBody BatchOcrRequest request) {
        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证请求数据
            if (request.getDocumentIds() == null || request.getDocumentIds().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new BatchOcrResponse(false, "文档ID列表不能为空", null)
                );
            }

            // 2. 检查所有文档是否存在
            List<String> notFoundDocs = new ArrayList<>();
            for (String docId : request.getDocumentIds()) {
                String checkDocumentSql = "SELECT COUNT(*) FROM documents WHERE document_id = ?";
                Integer documentCount = jdbcTemplate.queryForObject(checkDocumentSql, Integer.class, docId);

                if (documentCount == null || documentCount == 0) {
                    notFoundDocs.add(docId);
                }
            }

            if (!notFoundDocs.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new BatchOcrResponse(false, "以下文档不存在: " + String.join(", ", notFoundDocs), null)
                );
            }

            // 3. 解析选项
            BatchOcrOptions options = request.getOptions();
            if (options == null) {
                options = new BatchOcrOptions();
            }

            // 设置默认值
            if (options.getLanguage() == null) options.setLanguage("auto");
            if (options.getConfidence() == null) options.setConfidence(70);
            if (options.getPreprocess() == null) options.setPreprocess(true);
            if (options.getFormat() == null) options.setFormat("text");
            if (options.getPageSegMode() == null) options.setPageSegMode(6);

            // 4. 计算总页数
            int totalPages = 0;
            Map<String, List<Integer>> pagesMap = request.getPages();

            if (pagesMap != null && !pagesMap.isEmpty()) {
                for (List<Integer> pageList : pagesMap.values()) {
                    totalPages += pageList.size();
                }
            } else {
                // 如果没有指定页码，假设每个文档处理第一页
                totalPages = request.getDocumentIds().size();
            }

            // 5. 生成批量任务ID
            String batchId = "batch_ocr_" + UUID.randomUUID().toString().substring(0, 8);
            LocalDateTime now = LocalDateTime.now();

            // 6. 检查批量任务表是否存在
            String checkBatchTableSql = "SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'batch_ocr_tasks'";
            Integer batchTableCount = jdbcTemplate.queryForObject(checkBatchTableSql, Integer.class);

            if (batchTableCount == null || batchTableCount == 0) {
                // 创建批量任务表
                String createBatchTableSql = "CREATE TABLE batch_ocr_tasks (" +
                        "batch_id VARCHAR(50) PRIMARY KEY," +
                        "total_documents INT NOT NULL," +
                        "total_pages INT NOT NULL," +
                        "processed_documents INT DEFAULT 0," +
                        "processed_pages INT DEFAULT 0," +
                        "successful_pages INT DEFAULT 0," +
                        "failed_pages INT DEFAULT 0," +
                        "average_confidence DECIMAL(5,2) DEFAULT 0.0," +
                        "status VARCHAR(20) NOT NULL," +
                        "options_json TEXT," +
                        "results_json TEXT," +
                        "estimated_time INT," +
                        "started_at TIMESTAMP," +
                        "completed_at TIMESTAMP," +
                        "created_at TIMESTAMP," +
                        "updated_at TIMESTAMP" +
                        ")";
                jdbcTemplate.execute(createBatchTableSql);
                System.out.println("已创建 batch_ocr_tasks 表");
            }

            // 7. 创建批量任务记录
            String insertBatchSql = "INSERT INTO batch_ocr_tasks (batch_id, total_documents, total_pages, status, options_json, estimated_time, started_at, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)";

            String optionsJson;
            try {
                optionsJson = objectMapper.writeValueAsString(options);
            } catch (JsonProcessingException e) {
                System.err.println("序列化OCR选项失败: " + e.getMessage());
                optionsJson = "{}";
            }

            int estimatedTime = totalPages * 10; // 假设每页10秒

            jdbcTemplate.update(insertBatchSql,
                    batchId,
                    request.getDocumentIds().size(),
                    totalPages,
                    "processing",
                    optionsJson,
                    estimatedTime,
                    now,
                    now,
                    now
            );

            // 8. 使用final变量传递给lambda表达式
            final List<String> finalDocumentIds = new ArrayList<>(request.getDocumentIds());
            final Map<String, List<Integer>> finalPagesMap = pagesMap != null ? new HashMap<>(pagesMap) : new HashMap<>();
            final BatchOcrOptions finalOptions = options;
            final String finalBatchId = batchId;

            // 9. 启动异步处理任务
            new Thread(() -> {
                try {
                    processBatchDocuments(finalBatchId, finalDocumentIds, finalPagesMap, finalOptions);
                } catch (Exception e) {
                    System.err.println("批量OCR处理线程错误: " + e.getMessage());

                    // 更新任务为失败状态
                    String failBatchSql = "UPDATE batch_ocr_tasks SET status = 'failed', error_message = ?, updated_at = ? WHERE batch_id = ?";
                    jdbcTemplate.update(failBatchSql, e.getMessage(), LocalDateTime.now(), finalBatchId);
                }
            }).start();

            // 10. 准备响应数据
            BatchTaskData responseData = new BatchTaskData(
                    batchId,
                    request.getDocumentIds().size(),
                    totalPages,
                    estimatedTime
            );

            BatchOcrResponse response = new BatchOcrResponse(true, "批量OCR处理任务已启动", responseData);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("批量OCR处理过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new BatchOcrResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private void processBatchDocuments(String batchId, List<String> documentIds,
                                       Map<String, List<Integer>> pagesMap, BatchOcrOptions options) {
        try {
            LocalDateTime startTime = LocalDateTime.now();
            int processedDocuments = 0;
            int processedPages = 0;
            int successfulPages = 0;
            int failedPages = 0;
            double totalConfidence = 0.0;

            List<Map<String, Object>> results = new ArrayList<>();

            // 处理每个文档
            for (String docId : documentIds) {
                // 获取该文档要处理的页码
                List<Integer> pageList = new ArrayList<>();
                if (pagesMap != null && pagesMap.containsKey(docId)) {
                    pageList = new ArrayList<>(pagesMap.get(docId));
                } else {
                    // 默认处理第一页
                    pageList.add(1);
                }

                // 处理每个页面
                for (Integer page : pageList) {
                    try {
                        System.out.println("处理文档: " + docId + ", 页码: " + page);

                        // 模拟OCR处理
                        Thread.sleep(2000);

                        // 生成模拟的OCR结果
                        Map<String, Object> ocrResult = new HashMap<>();
                        ocrResult.put("text", "文档" + docId + "第" + page + "页的OCR识别文本内容。");
                        ocrResult.put("confidence", 85.0 + Math.random() * 15);

                        Map<String, Object> metadata = new HashMap<>();
                        metadata.put("engine", "tesseract");
                        metadata.put("language", options.getLanguage());
                        metadata.put("processingTime", 2000);
                        ocrResult.put("metadata", metadata);

                        // 保存OCR结果
                        String ocrResultId = "ocr_" + UUID.randomUUID().toString().substring(0, 8);
                        String insertOcrResultSql = "INSERT INTO document_ocr_results (ocr_id, document_id, page_number, ocr_text, confidence, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?)";

                        jdbcTemplate.update(insertOcrResultSql,
                                ocrResultId,
                                docId,
                                page,
                                (String) ocrResult.get("text"),
                                (Double) ocrResult.get("confidence"),
                                LocalDateTime.now(),
                                LocalDateTime.now()
                        );

                        // 记录结果
                        Map<String, Object> resultItem = new HashMap<>();
                        resultItem.put("documentId", docId);
                        resultItem.put("page", page);
                        resultItem.put("status", "success");
                        resultItem.put("confidence", ocrResult.get("confidence"));
                        resultItem.put("ocrId", ocrResultId);
                        results.add(resultItem);

                        successfulPages++;
                        totalConfidence += (Double) ocrResult.get("confidence");

                    } catch (Exception e) {
                        System.err.println("处理文档" + docId + "第" + page + "页失败: " + e.getMessage());

                        // 记录失败结果
                        Map<String, Object> resultItem = new HashMap<>();
                        resultItem.put("documentId", docId);
                        resultItem.put("page", page);
                        resultItem.put("status", "failed");
                        resultItem.put("error", e.getMessage());
                        results.add(resultItem);

                        failedPages++;
                    }

                    processedPages++;

                    // 更新批量任务进度
                    int progress = (int) ((processedPages * 100.0) / (documentIds.size() * (pagesMap != null ? pagesMap.get(docId).size() : 1)));
                    String updateProgressSql = "UPDATE batch_ocr_tasks SET processed_pages = ?, progress = ?, updated_at = ? WHERE batch_id = ?";
                    jdbcTemplate.update(updateProgressSql, processedPages, progress, LocalDateTime.now(), batchId);
                }

                processedDocuments++;

                // 更新已处理文档数
                String updateDocsSql = "UPDATE batch_ocr_tasks SET processed_documents = ?, updated_at = ? WHERE batch_id = ?";
                jdbcTemplate.update(updateDocsSql, processedDocuments, LocalDateTime.now(), batchId);
            }

            // 计算平均置信度
            double averageConfidence = successfulPages > 0 ? totalConfidence / successfulPages : 0.0;

            // 更新批量任务为完成状态
            String completeBatchSql = "UPDATE batch_ocr_tasks SET status = 'completed', successful_pages = ?, failed_pages = ?, average_confidence = ?, results_json = ?, completed_at = ?, updated_at = ? WHERE batch_id = ?";

            String resultsJson;
            try {
                resultsJson = objectMapper.writeValueAsString(results);
            } catch (JsonProcessingException e) {
                System.err.println("序列化结果失败: " + e.getMessage());
                resultsJson = "[]";
            }

            LocalDateTime endTime = LocalDateTime.now();

            jdbcTemplate.update(completeBatchSql,
                    successfulPages,
                    failedPages,
                    averageConfidence,
                    resultsJson,
                    endTime,
                    endTime,
                    batchId
            );

            System.out.println("批量OCR处理完成: " + batchId +
                    ", 成功页数: " + successfulPages +
                    ", 失败页数: " + failedPages +
                    ", 平均置信度: " + averageConfidence);

        } catch (Exception e) {
            System.err.println("批量文档处理过程中发生错误: " + e.getMessage());
            throw e;
        }
    }
}
--- 结束文件: OcrBatchProcess.java ---

--- 开始文件: OcrCancelTask.java ---
package com.vue.readingapp.ocr;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import com.fasterxml.jackson.databind.ObjectMapper;

@RestController
@RequestMapping("/api/v1/documents/ocr/tasks")
public class OcrCancelTask {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();
    private DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd'T'HH:mm:ss");

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到取消OCR任务请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=======================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class CancelTaskRequest {
        private String taskId;
        private String reason;

        public String getTaskId() { return taskId; }
        public void setTaskId(String taskId) { this.taskId = taskId; }

        public String getReason() { return reason; }
        public void setReason(String reason) { this.reason = reason; }
    }

    // 响应DTO
    public static class CancelTaskResponse {
        private boolean success;
        private String message;
        private CancelTaskData data;

        public CancelTaskResponse(boolean success, String message, CancelTaskData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public CancelTaskData getData() { return data; }
        public void setData(CancelTaskData data) { this.data = data; }
    }

    public static class CancelTaskData {
        private String taskId;
        private String status;
        private String cancelledAt;
        private String reason;

        public CancelTaskData(String taskId, String status, String cancelledAt, String reason) {
            this.taskId = taskId;
            this.status = status;
            this.cancelledAt = cancelledAt;
            this.reason = reason;
        }

        public String getTaskId() { return taskId; }
        public void setTaskId(String taskId) { this.taskId = taskId; }

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public String getCancelledAt() { return cancelledAt; }
        public void setCancelledAt(String cancelledAt) { this.cancelledAt = cancelledAt; }

        public String getReason() { return reason; }
        public void setReason(String reason) { this.reason = reason; }
    }

    @PostMapping("/{taskId}/cancel")
    public ResponseEntity<CancelTaskResponse> cancelTask(
            @PathVariable String taskId,
            @RequestBody CancelTaskRequest request) {

        // 设置任务ID
        request.setTaskId(taskId);

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证请求数据
            if (taskId == null || taskId.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new CancelTaskResponse(false, "任务ID不能为空", null)
                );
            }

            // 2. 先检查批量任务表
            String checkBatchTableSql = "SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'batch_ocr_tasks'";
            Integer batchTableCount = jdbcTemplate.queryForObject(checkBatchTableSql, Integer.class);

            if (batchTableCount != null && batchTableCount > 0) {
                // 查询批量任务
                String queryBatchSql = "SELECT batch_id, status FROM batch_ocr_tasks WHERE batch_id = ?";
                List<Map<String, Object>> batchTasks = jdbcTemplate.queryForList(queryBatchSql, taskId);

                if (!batchTasks.isEmpty()) {
                    Map<String, Object> batchTask = batchTasks.get(0);
                    String currentStatus = (String) batchTask.get("status");

                    // 检查任务是否可以取消
                    if ("completed".equals(currentStatus) || "failed".equals(currentStatus) || "cancelled".equals(currentStatus)) {
                        return ResponseEntity.badRequest().body(
                                new CancelTaskResponse(false, "任务已处于" + currentStatus + "状态，无法取消", null)
                        );
                    }

                    // 取消批量任务
                    LocalDateTime now = LocalDateTime.now();
                    String cancelBatchSql = "UPDATE batch_ocr_tasks SET status = 'cancelled', updated_at = ?, cancelled_at = ?, cancel_reason = ? WHERE batch_id = ?";

                    jdbcTemplate.update(cancelBatchSql,
                            now,
                            now,
                            request.getReason() != null ? request.getReason() : "用户取消",
                            taskId
                    );

                    System.out.println("批量OCR任务已取消: " + taskId);

                    // 准备响应数据
                    CancelTaskData responseData = new CancelTaskData(
                            taskId,
                            "cancelled",
                            now.format(formatter),
                            request.getReason()
                    );

                    CancelTaskResponse response = new CancelTaskResponse(true, "批量OCR任务取消成功", responseData);

                    // 打印返回数据
                    printResponse(response);

                    return ResponseEntity.ok(response);
                }
            }

            // 3. 检查普通OCR任务表
            String checkTaskTableSql = "SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'ocr_tasks'";
            Integer taskTableCount = jdbcTemplate.queryForObject(checkTaskTableSql, Integer.class);

            if (taskTableCount == null || taskTableCount == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new CancelTaskResponse(false, "任务不存在", null)
                );
            }

            // 4. 查询OCR任务
            String queryTaskSql = "SELECT task_id, status FROM ocr_tasks WHERE task_id = ?";
            List<Map<String, Object>> tasks = jdbcTemplate.queryForList(queryTaskSql, taskId);
            printQueryResult(tasks);

            if (tasks.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new CancelTaskResponse(false, "任务不存在", null)
                );
            }

            Map<String, Object> task = tasks.get(0);
            String currentStatus = (String) task.get("status");

            // 5. 检查任务是否可以取消
            if ("completed".equals(currentStatus) || "failed".equals(currentStatus) || "cancelled".equals(currentStatus)) {
                return ResponseEntity.badRequest().body(
                        new CancelTaskResponse(false, "任务已处于" + currentStatus + "状态，无法取消", null)
                );
            }

            // 6. 取消OCR任务
            LocalDateTime now = LocalDateTime.now();
            String cancelTaskSql = "UPDATE ocr_tasks SET status = 'cancelled', updated_at = ?, cancelled_at = ?, cancel_reason = ? WHERE task_id = ?";

            jdbcTemplate.update(cancelTaskSql,
                    now,
                    now,
                    request.getReason() != null ? request.getReason() : "用户取消",
                    taskId
            );

            System.out.println("OCR任务已取消: " + taskId);

            // 7. 准备响应数据
            CancelTaskData responseData = new CancelTaskData(
                    taskId,
                    "cancelled",
                    now.format(formatter),
                    request.getReason()
            );

            CancelTaskResponse response = new CancelTaskResponse(true, "OCR任务取消成功", responseData);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("取消OCR任务过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new CancelTaskResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: OcrCancelTask.java ---

--- 开始文件: OcrExportText.java ---
package com.vue.readingapp.ocr;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import java.util.UUID;
import com.fasterxml.jackson.databind.ObjectMapper;

@RestController
@RequestMapping("/api/v1/documents")
public class OcrExportText {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();
    private DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd'T'HH:mm:ss");

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到导出OCR文本请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=======================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class ExportOcrTextRequest {
        private String documentId;
        private List<Integer> pages;
        private String format;
        private Boolean includeMetadata;
        private Boolean includeConfidence;

        public String getDocumentId() { return documentId; }
        public void setDocumentId(String documentId) { this.documentId = documentId; }

        public List<Integer> getPages() { return pages; }
        public void setPages(List<Integer> pages) { this.pages = pages; }

        public String getFormat() { return format; }
        public void setFormat(String format) { this.format = format; }

        public Boolean getIncludeMetadata() { return includeMetadata; }
        public void setIncludeMetadata(Boolean includeMetadata) { this.includeMetadata = includeMetadata; }

        public Boolean getIncludeConfidence() { return includeConfidence; }
        public void setIncludeConfidence(Boolean includeConfidence) { this.includeConfidence = includeConfidence; }
    }

    // 响应DTO
    public static class ExportOcrTextResponse {
        private boolean success;
        private String message;
        private ExportData data;

        public ExportOcrTextResponse(boolean success, String message, ExportData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public ExportData getData() { return data; }
        public void setData(ExportData data) { this.data = data; }
    }

    public static class ExportData {
        private String exportId;
        private String documentId;
        private String format;
        private String downloadUrl;
        private Integer totalPages;
        private String createdAt;

        public ExportData(String exportId, String documentId, String format,
                          String downloadUrl, Integer totalPages, String createdAt) {
            this.exportId = exportId;
            this.documentId = documentId;
            this.format = format;
            this.downloadUrl = downloadUrl;
            this.totalPages = totalPages;
            this.createdAt = createdAt;
        }

        public String getExportId() { return exportId; }
        public void setExportId(String exportId) { this.exportId = exportId; }

        public String getDocumentId() { return documentId; }
        public void setDocumentId(String documentId) { this.documentId = documentId; }

        public String getFormat() { return format; }
        public void setFormat(String format) { this.format = format; }

        public String getDownloadUrl() { return downloadUrl; }
        public void setDownloadUrl(String downloadUrl) { this.downloadUrl = downloadUrl; }

        public Integer getTotalPages() { return totalPages; }
        public void setTotalPages(Integer totalPages) { this.totalPages = totalPages; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }
    }

    @PostMapping("/{documentId}/ocr/export")
    public ResponseEntity<ExportOcrTextResponse> exportOcrText(
            @PathVariable String documentId,
            @RequestBody ExportOcrTextRequest request) {

        // 设置文档ID
        request.setDocumentId(documentId);

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证请求数据
            if (documentId == null || documentId.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new ExportOcrTextResponse(false, "文档ID不能为空", null)
                );
            }

            // 设置默认值
            if (request.getFormat() == null) request.setFormat("txt");
            if (request.getIncludeMetadata() == null) request.setIncludeMetadata(true);
            if (request.getIncludeConfidence() == null) request.setIncludeConfidence(false);

            // 2. 检查文档是否存在
            String checkDocumentSql = "SELECT COUNT(*) FROM documents WHERE document_id = ?";
            Integer documentCount = jdbcTemplate.queryForObject(checkDocumentSql, Integer.class, documentId);

            if (documentCount == null || documentCount == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new ExportOcrTextResponse(false, "文档不存在", null)
                );
            }

            // 3. 检查OCR结果表是否存在
            String checkTableSql = "SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'document_ocr_results'";
            Integer tableCount = jdbcTemplate.queryForObject(checkTableSql, Integer.class);

            if (tableCount == null || tableCount == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new ExportOcrTextResponse(false, "没有OCR结果可供导出", null)
                );
            }

            // 4. 构建查询条件
            List<Object> params = new ArrayList<>();
            params.add(documentId);

            StringBuilder queryBuilder = new StringBuilder();
            queryBuilder.append("SELECT ocr_id, page_number, ocr_text, confidence, metadata_json ");
            queryBuilder.append("FROM document_ocr_results WHERE document_id = ?");

            // 添加页码条件
            if (request.getPages() != null && !request.getPages().isEmpty()) {
                queryBuilder.append(" AND page_number IN (");
                for (int i = 0; i < request.getPages().size(); i++) {
                    if (i > 0) queryBuilder.append(",");
                    queryBuilder.append("?");
                    params.add(request.getPages().get(i));
                }
                queryBuilder.append(")");
            }

            queryBuilder.append(" ORDER BY page_number");

            // 5. 执行查询
            List<Map<String, Object>> ocrResults = jdbcTemplate.queryForList(queryBuilder.toString(), params.toArray());
            printQueryResult(ocrResults);

            if (ocrResults.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new ExportOcrTextResponse(false, "没有找到符合条件的OCR结果", null)
                );
            }

            // 6. 生成导出内容
            String exportContent = generateExportContent(ocrResults, request);

            // 7. 生成导出ID和下载URL
            String exportId = "export_" + UUID.randomUUID().toString().substring(0, 8);
            String downloadUrl = "/api/exports/" + exportId + "." + request.getFormat();
            LocalDateTime now = LocalDateTime.now();

            // 8. 保存导出记录（需要创建导出记录表）
            String checkExportTableSql = "SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'ocr_exports'";
            Integer exportTableCount = jdbcTemplate.queryForObject(checkExportTableSql, Integer.class);

            if (exportTableCount == null || exportTableCount == 0) {
                // 创建导出记录表
                String createExportTableSql = "CREATE TABLE ocr_exports (" +
                        "export_id VARCHAR(50) PRIMARY KEY," +
                        "document_id VARCHAR(50) NOT NULL," +
                        "format VARCHAR(10) NOT NULL," +
                        "total_pages INT NOT NULL," +
                        "file_path VARCHAR(500)," +
                        "file_size BIGINT," +
                        "download_url VARCHAR(500)," +
                        "created_at TIMESTAMP," +
                        "expires_at TIMESTAMP," +
                        "FOREIGN KEY (document_id) REFERENCES documents(document_id) ON DELETE CASCADE" +
                        ")";
                jdbcTemplate.execute(createExportTableSql);
                System.out.println("已创建 ocr_exports 表");
            }

            // 插入导出记录
            String insertExportSql = "INSERT INTO ocr_exports (export_id, document_id, format, total_pages, file_path, file_size, download_url, created_at, expires_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)";

            String filePath = "/exports/" + exportId + "." + request.getFormat();
            long fileSize = exportContent.getBytes("UTF-8").length;
            LocalDateTime expiresAt = now.plusHours(24); // 24小时后过期

            jdbcTemplate.update(insertExportSql,
                    exportId,
                    documentId,
                    request.getFormat(),
                    ocrResults.size(),
                    filePath,
                    fileSize,
                    downloadUrl,
                    now,
                    expiresAt
            );

            // 9. 在实际项目中，这里应该将exportContent保存到文件系统或云存储
            // 为了课设演示，我们只打印内容
            System.out.println("=== 导出的OCR文本内容 ===");
            System.out.println(exportContent);
            System.out.println("======================");

            // 10. 准备响应数据
            ExportData responseData = new ExportData(
                    exportId,
                    documentId,
                    request.getFormat(),
                    downloadUrl,
                    ocrResults.size(),
                    now.format(formatter)
            );

            ExportOcrTextResponse response = new ExportOcrTextResponse(true, "OCR文本导出成功", responseData);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("导出OCR文本过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ExportOcrTextResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private String generateExportContent(List<Map<String, Object>> ocrResults, ExportOcrTextRequest request) {
        StringBuilder contentBuilder = new StringBuilder();

        // 添加标题
        contentBuilder.append("OCR Export - Document: ").append(request.getDocumentId()).append("\n");
        contentBuilder.append("Export Date: ").append(LocalDateTime.now().format(formatter)).append("\n");
        contentBuilder.append("Total Pages: ").append(ocrResults.size()).append("\n");
        contentBuilder.append("Format: ").append(request.getFormat().toUpperCase()).append("\n");
        contentBuilder.append("=".repeat(80)).append("\n\n");

        // 根据格式生成内容
        switch (request.getFormat().toLowerCase()) {
            case "txt":
                contentBuilder.append(generateTxtContent(ocrResults, request));
                break;
            case "json":
                contentBuilder.append(generateJsonContent(ocrResults, request));
                break;
            case "csv":
                contentBuilder.append(generateCsvContent(ocrResults, request));
                break;
            default:
                contentBuilder.append(generateTxtContent(ocrResults, request));
                break;
        }

        return contentBuilder.toString();
    }

    private String generateTxtContent(List<Map<String, Object>> ocrResults, ExportOcrTextRequest request) {
        StringBuilder txtBuilder = new StringBuilder();

        for (Map<String, Object> result : ocrResults) {
            Integer pageNumber = (Integer) result.get("page_number");
            String ocrText = (String) result.get("ocr_text");
            Double confidence = result.get("confidence") != null ? ((Number) result.get("confidence")).doubleValue() : 0.0;

            txtBuilder.append("Page ").append(pageNumber).append("\n");
            txtBuilder.append("-".repeat(40)).append("\n");

            if (request.getIncludeConfidence()) {
                txtBuilder.append("Confidence: ").append(String.format("%.2f", confidence)).append("%\n\n");
            }

            txtBuilder.append(ocrText).append("\n\n");

            if (request.getIncludeMetadata()) {
                String metadataJson = (String) result.get("metadata_json");
                if (metadataJson != null && !metadataJson.trim().isEmpty()) {
                    try {
                        Map<String, Object> metadata = objectMapper.readValue(metadataJson, Map.class);
                        txtBuilder.append("Metadata:\n");
                        for (Map.Entry<String, Object> entry : metadata.entrySet()) {
                            txtBuilder.append("  ").append(entry.getKey()).append(": ").append(entry.getValue()).append("\n");
                        }
                    } catch (Exception e) {
                        txtBuilder.append("Metadata: [Error parsing metadata]\n");
                    }
                }
                txtBuilder.append("\n");
            }

            txtBuilder.append("=".repeat(80)).append("\n\n");
        }

        return txtBuilder.toString();
    }

    private String generateJsonContent(List<Map<String, Object>> ocrResults, ExportOcrTextRequest request) {
        try {
            List<Map<String, Object>> exportData = new ArrayList<>();

            for (Map<String, Object> result : ocrResults) {
                Map<String, Object> item = new HashMap<>();
                item.put("page", result.get("page_number"));
                item.put("text", result.get("ocr_text"));

                if (request.getIncludeConfidence()) {
                    item.put("confidence", result.get("confidence"));
                }

                if (request.getIncludeMetadata()) {
                    String metadataJson = (String) result.get("metadata_json");
                    if (metadataJson != null && !metadataJson.trim().isEmpty()) {
                        try {
                            Map<String, Object> metadata = objectMapper.readValue(metadataJson, Map.class);
                            item.put("metadata", metadata);
                        } catch (Exception e) {
                            item.put("metadata", "Error parsing metadata");
                        }
                    }
                }

                exportData.add(item);
            }

            Map<String, Object> fullExport = new HashMap<>();
            fullExport.put("documentId", request.getDocumentId());
            fullExport.put("exportDate", LocalDateTime.now().format(formatter));
            fullExport.put("totalPages", ocrResults.size());
            fullExport.put("format", request.getFormat());
            fullExport.put("pages", exportData);

            return objectMapper.writerWithDefaultPrettyPrinter().writeValueAsString(fullExport);
        } catch (Exception e) {
            return "{\"error\": \"Failed to generate JSON content: " + e.getMessage() + "\"}";
        }
    }

    private String generateCsvContent(List<Map<String, Object>> ocrResults, ExportOcrTextRequest request) {
        StringBuilder csvBuilder = new StringBuilder();

        // CSV头部
        csvBuilder.append("Page,Text");
        if (request.getIncludeConfidence()) {
            csvBuilder.append(",Confidence");
        }
        if (request.getIncludeMetadata()) {
            csvBuilder.append(",Metadata");
        }
        csvBuilder.append("\n");

        // CSV数据行
        for (Map<String, Object> result : ocrResults) {
            Integer pageNumber = (Integer) result.get("page_number");
            String ocrText = (String) result.get("ocr_text");
            Double confidence = result.get("confidence") != null ? ((Number) result.get("confidence")).doubleValue() : 0.0;

            // 转义文本中的逗号和引号
            String escapedText = ocrText.replace("\"", "\"\"");
            if (escapedText.contains(",") || escapedText.contains("\"") || escapedText.contains("\n")) {
                escapedText = "\"" + escapedText + "\"";
            }

            csvBuilder.append(pageNumber).append(",").append(escapedText);

            if (request.getIncludeConfidence()) {
                csvBuilder.append(",").append(String.format("%.2f", confidence));
            }

            if (request.getIncludeMetadata()) {
                String metadataJson = (String) result.get("metadata_json");
                if (metadataJson != null && !metadataJson.trim().isEmpty()) {
                    String escapedMetadata = metadataJson.replace("\"", "\"\"");
                    if (escapedMetadata.contains(",") || escapedMetadata.contains("\"") || escapedMetadata.contains("\n")) {
                        escapedMetadata = "\"" + escapedMetadata + "\"";
                    }
                    csvBuilder.append(",").append(escapedMetadata);
                } else {
                    csvBuilder.append(",");
                }
            }

            csvBuilder.append("\n");
        }

        return csvBuilder.toString();
    }

    // 可选：获取导出文件
    @GetMapping("/exports/{exportId}")
    public ResponseEntity<String> getExportFile(@PathVariable String exportId) {
        try {
            // 检查导出记录是否存在
            String checkExportSql = "SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'ocr_exports'";
            Integer exportTableCount = jdbcTemplate.queryForObject(checkExportSql, Integer.class);

            if (exportTableCount == null || exportTableCount == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body("导出文件不存在");
            }

            String queryExportSql = "SELECT export_id, document_id, format, download_url, created_at FROM ocr_exports WHERE export_id = ?";
            List<Map<String, Object>> exports = jdbcTemplate.queryForList(queryExportSql, exportId);

            if (exports.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body("导出文件不存在");
            }

            Map<String, Object> export = exports.get(0);
            String format = (String) export.get("format");

            // 在实际项目中，这里应该从文件系统或云存储读取文件内容
            // 为了课设演示，我们返回一个模拟的下载链接
            String downloadUrl = "/api/exports/" + exportId + "." + format;

            return ResponseEntity.ok("导出文件下载链接: " + downloadUrl + "\n请在24小时内下载，过期后将失效。");

        } catch (Exception e) {
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body("获取导出文件失败: " + e.getMessage());
        }
    }
}
--- 结束文件: OcrExportText.java ---

--- 开始文件: OcrGetHistory.java ---
package com.vue.readingapp.ocr;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import com.fasterxml.jackson.databind.ObjectMapper;

@RestController
@RequestMapping("/api/v1/documents")
public class OcrGetHistory {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();
    private DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd'T'HH:mm:ss");

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取OCR历史请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("=======================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class GetOcrHistoryResponse {
        private boolean success;
        private String message;
        private List<OcrHistoryItem> data;

        public GetOcrHistoryResponse(boolean success, String message, List<OcrHistoryItem> data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public List<OcrHistoryItem> getData() { return data; }
        public void setData(List<OcrHistoryItem> data) { this.data = data; }
    }

    public static class OcrHistoryItem {
        private String id;
        private String documentId;
        private Integer page;
        private String text;
        private Double confidence;
        private String metadata;
        private String createdAt;
        private String updatedAt;

        public OcrHistoryItem(String id, String documentId, Integer page, String text,
                              Double confidence, String metadata, String createdAt, String updatedAt) {
            this.id = id;
            this.documentId = documentId;
            this.page = page;
            this.text = text;
            this.confidence = confidence;
            this.metadata = metadata;
            this.createdAt = createdAt;
            this.updatedAt = updatedAt;
        }

        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getDocumentId() { return documentId; }
        public void setDocumentId(String documentId) { this.documentId = documentId; }

        public Integer getPage() { return page; }
        public void setPage(Integer page) { this.page = page; }

        public String getText() { return text; }
        public void setText(String text) { this.text = text; }

        public Double getConfidence() { return confidence; }
        public void setConfidence(Double confidence) { this.confidence = confidence; }

        public String getMetadata() { return metadata; }
        public void setMetadata(String metadata) { this.metadata = metadata; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }
    }

    @GetMapping("/{documentId}/ocr/histories")
    public ResponseEntity<GetOcrHistoryResponse> getOcrHistory(
            @PathVariable String documentId,
            @RequestParam(required = false) Integer page,
            @RequestParam(required = false) String startDate,
            @RequestParam(required = false) String endDate) {

        // 构建请求信息
        Map<String, Object> requestInfo = new HashMap<>();
        requestInfo.put("documentId", documentId);
        requestInfo.put("page", page);
        requestInfo.put("startDate", startDate);
        requestInfo.put("endDate", endDate);

        // 打印接收到的请求
        printRequest(requestInfo);

        try {
            // 1. 验证请求数据
            if (documentId == null || documentId.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new GetOcrHistoryResponse(false, "文档ID不能为空", null)
                );
            }

            // 2. 检查文档是否存在
            String checkDocumentSql = "SELECT COUNT(*) FROM documents WHERE document_id = ?";
            Integer documentCount = jdbcTemplate.queryForObject(checkDocumentSql, Integer.class, documentId);

            if (documentCount == null || documentCount == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new GetOcrHistoryResponse(false, "文档不存在", null)
                );
            }

            // 3. 检查OCR结果表是否存在
            String checkTableSql = "SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'document_ocr_results'";
            Integer tableCount = jdbcTemplate.queryForObject(checkTableSql, Integer.class);

            if (tableCount == null || tableCount == 0) {
                return ResponseEntity.ok(
                        new GetOcrHistoryResponse(true, "没有OCR历史记录", new ArrayList<>())
                );
            }

            // 4. 构建查询SQL
            StringBuilder queryBuilder = new StringBuilder();
            queryBuilder.append("SELECT ocr_id, document_id, page_number, ocr_text, confidence, metadata_json, created_at, updated_at ");
            queryBuilder.append("FROM document_ocr_results WHERE document_id = ?");

            List<Object> params = new ArrayList<>();
            params.add(documentId);

            // 添加页码条件
            if (page != null && page > 0) {
                queryBuilder.append(" AND page_number = ?");
                params.add(page);
            }

            // 添加日期条件
            if (startDate != null && !startDate.trim().isEmpty()) {
                queryBuilder.append(" AND created_at >= ?");
                params.add(LocalDateTime.parse(startDate + "T00:00:00"));
            }

            if (endDate != null && !endDate.trim().isEmpty()) {
                queryBuilder.append(" AND created_at <= ?");
                params.add(LocalDateTime.parse(endDate + "T23:59:59"));
            }

            queryBuilder.append(" ORDER BY created_at DESC");

            // 5. 执行查询
            List<Map<String, Object>> historyList = jdbcTemplate.queryForList(queryBuilder.toString(), params.toArray());
            printQueryResult(historyList);

            // 6. 转换为响应数据
            List<OcrHistoryItem> responseData = new ArrayList<>();
            for (Map<String, Object> historyItem : historyList) {
                OcrHistoryItem item = new OcrHistoryItem(
                        (String) historyItem.get("ocr_id"),
                        (String) historyItem.get("document_id"),
                        (Integer) historyItem.get("page_number"),
                        (String) historyItem.get("ocr_text"),
                        historyItem.get("confidence") != null ? ((Number) historyItem.get("confidence")).doubleValue() : 0.0,
                        (String) historyItem.get("metadata_json"),
                        historyItem.get("created_at") != null ? ((LocalDateTime) historyItem.get("created_at")).format(formatter) : "",
                        historyItem.get("updated_at") != null ? ((LocalDateTime) historyItem.get("updated_at")).format(formatter) : ""
                );
                responseData.add(item);
            }

            GetOcrHistoryResponse response = new GetOcrHistoryResponse(true, "获取OCR历史成功", responseData);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取OCR历史过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new GetOcrHistoryResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    // 可选：获取所有文档的OCR历史
    @GetMapping("/ocr/histories")
    public ResponseEntity<GetAllOcrHistoryResponse> getAllOcrHistory(
            @RequestParam(required = false) String startDate,
            @RequestParam(required = false) String endDate,
            @RequestParam(defaultValue = "1") Integer pageNum,
            @RequestParam(defaultValue = "20") Integer pageSize) {

        try {
            // 1. 检查OCR结果表是否存在
            String checkTableSql = "SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'document_ocr_results'";
            Integer tableCount = jdbcTemplate.queryForObject(checkTableSql, Integer.class);

            if (tableCount == null || tableCount == 0) {
                return ResponseEntity.ok(
                        new GetAllOcrHistoryResponse(true, "没有OCR历史记录", new ArrayList<>(), 0, 0, 0)
                );
            }

            // 2. 构建查询SQL
            StringBuilder queryBuilder = new StringBuilder();
            queryBuilder.append("SELECT ocr_id, document_id, page_number, ocr_text, confidence, metadata_json, created_at, updated_at ");
            queryBuilder.append("FROM document_ocr_results WHERE 1=1");

            List<Object> params = new ArrayList<>();

            // 添加日期条件
            if (startDate != null && !startDate.trim().isEmpty()) {
                queryBuilder.append(" AND created_at >= ?");
                params.add(LocalDateTime.parse(startDate + "T00:00:00"));
            }

            if (endDate != null && !endDate.trim().isEmpty()) {
                queryBuilder.append(" AND created_at <= ?");
                params.add(LocalDateTime.parse(endDate + "T23:59:59"));
            }

            queryBuilder.append(" ORDER BY created_at DESC");

            // 3. 执行查询
            List<Map<String, Object>> historyList = jdbcTemplate.queryForList(queryBuilder.toString(), params.toArray());

            // 4. 分页处理
            int totalCount = historyList.size();
            int totalPages = (int) Math.ceil((double) totalCount / pageSize);
            int startIndex = (pageNum - 1) * pageSize;
            int endIndex = Math.min(startIndex + pageSize, totalCount);

            List<Map<String, Object>> pagedList = historyList.subList(startIndex, endIndex);

            // 5. 转换为响应数据
            List<OcrHistoryItem> responseData = new ArrayList<>();
            for (Map<String, Object> historyItem : pagedList) {
                OcrHistoryItem item = new OcrHistoryItem(
                        (String) historyItem.get("ocr_id"),
                        (String) historyItem.get("document_id"),
                        (Integer) historyItem.get("page_number"),
                        (String) historyItem.get("ocr_text"),
                        historyItem.get("confidence") != null ? ((Number) historyItem.get("confidence")).doubleValue() : 0.0,
                        (String) historyItem.get("metadata_json"),
                        historyItem.get("created_at") != null ? ((LocalDateTime) historyItem.get("created_at")).format(formatter) : "",
                        historyItem.get("updated_at") != null ? ((LocalDateTime) historyItem.get("updated_at")).format(formatter) : ""
                );
                responseData.add(item);
            }

            GetAllOcrHistoryResponse response = new GetAllOcrHistoryResponse(
                    true,
                    "获取所有OCR历史成功",
                    responseData,
                    totalCount,
                    totalPages,
                    pageNum
            );

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取所有OCR历史过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new GetAllOcrHistoryResponse(false, "服务器内部错误: " + e.getMessage(), null, 0, 0, 0)
            );
        }
    }

    // 获取所有OCR历史的响应DTO
    public static class GetAllOcrHistoryResponse {
        private boolean success;
        private String message;
        private List<OcrHistoryItem> data;
        private Integer totalCount;
        private Integer totalPages;
        private Integer currentPage;

        public GetAllOcrHistoryResponse(boolean success, String message, List<OcrHistoryItem> data,
                                        Integer totalCount, Integer totalPages, Integer currentPage) {
            this.success = success;
            this.message = message;
            this.data = data;
            this.totalCount = totalCount;
            this.totalPages = totalPages;
            this.currentPage = currentPage;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public List<OcrHistoryItem> getData() { return data; }
        public void setData(List<OcrHistoryItem> data) { this.data = data; }

        public Integer getTotalCount() { return totalCount; }
        public void setTotalCount(Integer totalCount) { this.totalCount = totalCount; }

        public Integer getTotalPages() { return totalPages; }
        public void setTotalPages(Integer totalPages) { this.totalPages = totalPages; }

        public Integer getCurrentPage() { return currentPage; }
        public void setCurrentPage(Integer currentPage) { this.currentPage = currentPage; }
    }
}
--- 结束文件: OcrGetHistory.java ---

--- 开始文件: OcrGetResult.java ---
package com.vue.readingapp.ocr;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import com.fasterxml.jackson.databind.ObjectMapper;

@RestController
@RequestMapping("/api/v1/documents")
public class OcrGetResult {@Autowired
private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();
    private DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd'T'HH:mm:ss");

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取OCR结果请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("=======================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class GetOcrResultResponse {
        private boolean success;
        private String message;
        private OcrResultData data;

        public GetOcrResultResponse(boolean success, String message, OcrResultData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public OcrResultData getData() { return data; }
        public void setData(OcrResultData data) { this.data = data; }
    }

    public static class OcrResultData {
        private String id;
        private Integer documentId;
        private Integer page;
        private String text;
        private Double confidence;
        private String words;
        private String lines;
        private String blocks;
        private String metadata;
        private LocalDateTime createdAt;
        private LocalDateTime updatedAt;

        public OcrResultData(String id, Integer documentId, Integer page, String text,
                             Double confidence, String words, String lines, String blocks,
                             String metadata, LocalDateTime createdAt, LocalDateTime updatedAt) {
            this.id = id;
            this.documentId = documentId;
            this.page = page;
            this.text = text;
            this.confidence = confidence;
            this.words = words;
            this.lines = lines;
            this.blocks = blocks;
            this.metadata = metadata;
            this.createdAt = createdAt;
            this.updatedAt = updatedAt;
        }

        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public Integer getDocumentId() { return documentId; }
        public void setDocumentId(Integer documentId) { this.documentId = documentId; }

        public Integer getPage() { return page; }
        public void setPage(Integer page) { this.page = page; }

        public String getText() { return text; }
        public void setText(String text) { this.text = text; }

        public Double getConfidence() { return confidence; }
        public void setConfidence(Double confidence) { this.confidence = confidence; }

        public String getWords() { return words; }
        public void setWords(String words) { this.words = words; }

        public String getLines() { return lines; }
        public void setLines(String lines) { this.lines = lines; }

        public String getBlocks() { return blocks; }
        public void setBlocks(String blocks) { this.blocks = blocks; }

        public String getMetadata() { return metadata; }
        public void setMetadata(String metadata) { this.metadata = metadata; }

        public LocalDateTime getCreatedAt() { return createdAt; }
        public void setCreatedAt(LocalDateTime createdAt) { this.createdAt = createdAt; }

        public LocalDateTime getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(LocalDateTime updatedAt) { this.updatedAt = updatedAt; }
    }

    @GetMapping("/{documentId}/ocr/{page}")
    public ResponseEntity<GetOcrResultResponse> getOcrResult(
            @PathVariable String documentId,
            @PathVariable Integer page) {

        // 打印接收到的请求
        Map<String, Object> requestInfo = new HashMap<>();
        requestInfo.put("documentId", documentId);
        requestInfo.put("page", page);
        printRequest(requestInfo);

        try {
            // 1. 验证请求数据
            if (documentId == null || documentId.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new GetOcrResultResponse(false, "文档ID不能为空", null)
                );
            }

            if (page == null || page <= 0) {
                return ResponseEntity.badRequest().body(
                        new GetOcrResultResponse(false, "页码必须大于0", null)
                );
            }

            // 2. 检查文档是否存在
            String checkDocumentSql = "SELECT COUNT(*) FROM documents WHERE document_id = ?";
            Integer documentCount = jdbcTemplate.queryForObject(checkDocumentSql, Integer.class, documentId);

            if (documentCount == null || documentCount == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new GetOcrResultResponse(false, "文档不存在", null)
                );
            }

            // 3. 查询OCR结果
            // 先检查OCR结果表是否存在
            String checkTableSql = "SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'document_ocr_results'";
            Integer tableCount = jdbcTemplate.queryForObject(checkTableSql, Integer.class);

            if (tableCount == null || tableCount == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new GetOcrResultResponse(false, "该页面没有OCR结果", null)
                );
            }

            // 查询OCR结果
            String queryOcrSql = "SELECT ocr_id, document_id, page_number, ocr_text, confidence, words_json, lines_json, blocks_json, metadata_json, created_at, updated_at FROM document_ocr_results WHERE document_id = ? AND page_number = ?";

            List<Map<String, Object>> ocrResults = jdbcTemplate.queryForList(queryOcrSql, documentId, page);
            printQueryResult(ocrResults);

            if (ocrResults.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new GetOcrResultResponse(false, "该页面没有OCR结果", null)
                );
            }

            Map<String, Object> ocrResult = ocrResults.get(0);

            // 4. 准备响应数据（保持LocalDateTime类型）
            OcrResultData responseData = new OcrResultData(
                    (String) ocrResult.get("ocr_id"),
                    (Integer) ocrResult.get("document_id"),
                    (Integer) ocrResult.get("page_number"),
                    (String) ocrResult.get("ocr_text"),
                    ocrResult.get("confidence") != null ? ((Number) ocrResult.get("confidence")).doubleValue() : 0.0,
                    (String) ocrResult.get("words_json"),
                    (String) ocrResult.get("lines_json"),
                    (String) ocrResult.get("blocks_json"),
                    (String) ocrResult.get("metadata_json"),
                    (LocalDateTime) ocrResult.get("created_at"),
                    (LocalDateTime) ocrResult.get("updated_at")
            );

            GetOcrResultResponse response = new GetOcrResultResponse(true, "获取OCR结果成功", responseData);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取OCR结果过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new GetOcrResultResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    // 可选：获取文档所有页的OCR结果
    @GetMapping("/{documentId}/ocr")
    public ResponseEntity<GetAllOcrResultResponse> getAllOcrResults(
            @PathVariable String documentId) {

        try {
            // 1. 验证文档ID
            if (documentId == null || documentId.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new GetAllOcrResultResponse(false, "文档ID不能为空", null)
                );
            }

            // 2. 检查文档是否存在
            String checkDocumentSql = "SELECT COUNT(*) FROM documents WHERE document_id = ?";
            Integer documentCount = jdbcTemplate.queryForObject(checkDocumentSql, Integer.class, documentId);

            if (documentCount == null || documentCount == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new GetAllOcrResultResponse(false, "文档不存在", null)
                );
            }

            // 3. 查询所有OCR结果
            String checkTableSql = "SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'document_ocr_results'";
            Integer tableCount = jdbcTemplate.queryForObject(checkTableSql, Integer.class);

            if (tableCount == null || tableCount == 0) {
                return ResponseEntity.ok(
                        new GetAllOcrResultResponse(true, "没有OCR结果", new ArrayList<>())
                );
            }

            String queryAllOcrSql = "SELECT ocr_id, document_id, page_number, ocr_text, confidence, words_json, lines_json, blocks_json, metadata_json, created_at, updated_at FROM document_ocr_results WHERE document_id = ? ORDER BY page_number";

            List<Map<String, Object>> allOcrResults = jdbcTemplate.queryForList(queryAllOcrSql, documentId);
            printQueryResult(allOcrResults);

            // 4. 转换为响应数据
            List<OcrResultData> responseDataList = new ArrayList<>();
            for (Map<String, Object> ocrResult : allOcrResults) {
                OcrResultData data = new OcrResultData(
                        (String) ocrResult.get("ocr_id"),
                        (Integer) ocrResult.get("document_id"),
                        (Integer) ocrResult.get("page_number"),
                        (String) ocrResult.get("ocr_text"),
                        ocrResult.get("confidence") != null ? ((Number) ocrResult.get("confidence")).doubleValue() : 0.0,
                        (String) ocrResult.get("words_json"),
                        (String) ocrResult.get("lines_json"),
                        (String) ocrResult.get("blocks_json"),
                        (String) ocrResult.get("metadata_json"),
                        (LocalDateTime) ocrResult.get("created_at"),
                        (LocalDateTime) ocrResult.get("updated_at")
                );
                responseDataList.add(data);
            }

            GetAllOcrResultResponse response = new GetAllOcrResultResponse(true, "获取所有OCR结果成功", responseDataList);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取所有OCR结果过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new GetAllOcrResultResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    // 获取所有OCR结果的响应DTO
    public static class GetAllOcrResultResponse {
        private boolean success;
        private String message;
        private List<OcrResultData> data;

        public GetAllOcrResultResponse(boolean success, String message, List<OcrResultData> data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public List<OcrResultData> getData() { return data; }
        public void setData(List<OcrResultData> data) { this.data = data; }
    }}
--- 结束文件: OcrGetResult.java ---

--- 开始文件: OcrGetSettings.java ---
package com.vue.readingapp.ocr;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import com.fasterxml.jackson.databind.ObjectMapper;

@RestController
@RequestMapping("/api/v1/documents")
public class OcrGetSettings {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();
    private DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd'T'HH:mm:ss");

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取OCR设置请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("=======================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class GetOcrSettingsResponse {
        private boolean success;
        private String message;
        private OcrSettingsData data;

        public GetOcrSettingsResponse(boolean success, String message, OcrSettingsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public OcrSettingsData getData() { return data; }
        public void setData(OcrSettingsData data) { this.data = data; }
    }

    public static class OcrSettingsData {
        private String documentId;
        private OcrSettings settings;
        private String updatedAt;

        public OcrSettingsData(String documentId, OcrSettings settings, String updatedAt) {
            this.documentId = documentId;
            this.settings = settings;
            this.updatedAt = updatedAt;
        }

        public String getDocumentId() { return documentId; }
        public void setDocumentId(String documentId) { this.documentId = documentId; }

        public OcrSettings getSettings() { return settings; }
        public void setSettings(OcrSettings settings) { this.settings = settings; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }
    }

    public static class OcrSettings {
        private String defaultLanguage;
        private Integer defaultConfidence;
        private Boolean autoPreprocess;
        private String supportedLanguages; // JSON数组字符串
        private String engine;

        public String getDefaultLanguage() { return defaultLanguage; }
        public void setDefaultLanguage(String defaultLanguage) { this.defaultLanguage = defaultLanguage; }

        public Integer getDefaultConfidence() { return defaultConfidence; }
        public void setDefaultConfidence(Integer defaultConfidence) { this.defaultConfidence = defaultConfidence; }

        public Boolean getAutoPreprocess() { return autoPreprocess; }
        public void setAutoPreprocess(Boolean autoPreprocess) { this.autoPreprocess = autoPreprocess; }

        public String getSupportedLanguages() { return supportedLanguages; }
        public void setSupportedLanguages(String supportedLanguages) { this.supportedLanguages = supportedLanguages; }

        public String getEngine() { return engine; }
        public void setEngine(String engine) { this.engine = engine; }
    }

    @GetMapping("/{documentId}/ocr/options")
    public ResponseEntity<GetOcrSettingsResponse> getOcrSettings(
            @PathVariable String documentId) {

        // 打印接收到的请求
        Map<String, Object> requestInfo = new HashMap<>();
        requestInfo.put("documentId", documentId);
        printRequest(requestInfo);

        try {
            // 1. 验证请求数据
            if (documentId == null || documentId.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new GetOcrSettingsResponse(false, "文档ID不能为空", null)
                );
            }

            // 2. 检查文档是否存在
            String checkDocumentSql = "SELECT COUNT(*) FROM documents WHERE document_id = ?";
            Integer documentCount = jdbcTemplate.queryForObject(checkDocumentSql, Integer.class, documentId);

            if (documentCount == null || documentCount == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new GetOcrSettingsResponse(false, "文档不存在", null)
                );
            }

            // 3. 检查OCR设置表是否存在
            String checkTableSql = "SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'document_ocr_settings'";
            Integer tableCount = jdbcTemplate.queryForObject(checkTableSql, Integer.class);

            if (tableCount == null || tableCount == 0) {
                // 创建OCR设置表
                String createTableSql = "CREATE TABLE document_ocr_settings (" +
                        "setting_id VARCHAR(50) PRIMARY KEY," +
                        "document_id VARCHAR(50) NOT NULL," +
                        "default_language VARCHAR(20)," +
                        "default_confidence INT," +
                        "auto_preprocess BOOLEAN," +
                        "supported_languages TEXT," +
                        "engine VARCHAR(50)," +
                        "created_at TIMESTAMP," +
                        "updated_at TIMESTAMP," +
                        "FOREIGN KEY (document_id) REFERENCES documents(document_id) ON DELETE CASCADE" +
                        ")";
                jdbcTemplate.execute(createTableSql);
                System.out.println("已创建 document_ocr_settings 表");

                // 返回默认设置
                return getDefaultSettings(documentId);
            }

            // 4. 查询OCR设置
            String querySettingsSql = "SELECT setting_id, document_id, default_language, default_confidence, auto_preprocess, supported_languages, engine, updated_at FROM document_ocr_settings WHERE document_id = ?";

            List<Map<String, Object>> settingsList = jdbcTemplate.queryForList(querySettingsSql, documentId);
            printQueryResult(settingsList);

            if (settingsList.isEmpty()) {
                // 返回默认设置
                return getDefaultSettings(documentId);
            }

            Map<String, Object> settings = settingsList.get(0);

            // 5. 准备响应数据
            OcrSettings ocrSettings = new OcrSettings();
            ocrSettings.setDefaultLanguage((String) settings.get("default_language"));
            ocrSettings.setDefaultConfidence(settings.get("default_confidence") != null ? ((Number) settings.get("default_confidence")).intValue() : 70);
            ocrSettings.setAutoPreprocess(settings.get("auto_preprocess") != null ? (Boolean) settings.get("auto_preprocess") : true);
            ocrSettings.setSupportedLanguages((String) settings.get("supported_languages"));
            ocrSettings.setEngine((String) settings.get("engine"));

            OcrSettingsData responseData = new OcrSettingsData(
                    (String) settings.get("document_id"),
                    ocrSettings,
                    settings.get("updated_at") != null ? ((LocalDateTime) settings.get("updated_at")).format(formatter) : ""
            );

            GetOcrSettingsResponse response = new GetOcrSettingsResponse(true, "获取OCR设置成功", responseData);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取OCR设置过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new GetOcrSettingsResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private ResponseEntity<GetOcrSettingsResponse> getDefaultSettings(String documentId) {
        try {
            // 创建默认OCR设置
            OcrSettings defaultSettings = new OcrSettings();
            defaultSettings.setDefaultLanguage("auto");
            defaultSettings.setDefaultConfidence(70);
            defaultSettings.setAutoPreprocess(true);

            // 默认支持的语言
            List<String> supportedLangs = new ArrayList<>();
            supportedLangs.add("zh");
            supportedLangs.add("en");
            supportedLangs.add("ja");
            supportedLangs.add("ko");
            defaultSettings.setSupportedLanguages(objectMapper.writeValueAsString(supportedLangs));

            defaultSettings.setEngine("tesseract");

            OcrSettingsData responseData = new OcrSettingsData(
                    documentId,
                    defaultSettings,
                    LocalDateTime.now().format(formatter)
            );

            GetOcrSettingsResponse response = new GetOcrSettingsResponse(true, "使用默认OCR设置", responseData);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("创建默认OCR设置失败: " + e.getMessage());
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new GetOcrSettingsResponse(false, "创建默认OCR设置失败", null)
            );
        }
    }
}
--- 结束文件: OcrGetSettings.java ---

--- 开始文件: OcrGetStatistics.java ---
package com.vue.readingapp.ocr;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import com.fasterxml.jackson.databind.ObjectMapper;

@RestController
@RequestMapping("/api/v1/documents")
public class OcrGetStatistics {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();
    private DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd'T'HH:mm:ss");

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取OCR统计请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("=======================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class GetOcrStatisticsResponse {
        private boolean success;
        private String message;
        private OcrStatisticsData data;

        public GetOcrStatisticsResponse(boolean success, String message, OcrStatisticsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public OcrStatisticsData getData() { return data; }
        public void setData(OcrStatisticsData data) { this.data = data; }
    }

    public static class OcrStatisticsData {
        private String documentId;
        private Integer totalPages;
        private Integer processedPages;
        private Double averageConfidence;
        private Map<String, Integer> languageDistribution;
        private Map<String, Integer> engineDistribution;
        private List<DailyStat> dailyStats;

        public OcrStatisticsData(String documentId, Integer totalPages, Integer processedPages,
                                 Double averageConfidence, Map<String, Integer> languageDistribution,
                                 Map<String, Integer> engineDistribution, List<DailyStat> dailyStats) {
            this.documentId = documentId;
            this.totalPages = totalPages;
            this.processedPages = processedPages;
            this.averageConfidence = averageConfidence;
            this.languageDistribution = languageDistribution;
            this.engineDistribution = engineDistribution;
            this.dailyStats = dailyStats;
        }

        public String getDocumentId() { return documentId; }
        public void setDocumentId(String documentId) { this.documentId = documentId; }

        public Integer getTotalPages() { return totalPages; }
        public void setTotalPages(Integer totalPages) { this.totalPages = totalPages; }

        public Integer getProcessedPages() { return processedPages; }
        public void setProcessedPages(Integer processedPages) { this.processedPages = processedPages; }

        public Double getAverageConfidence() { return averageConfidence; }
        public void setAverageConfidence(Double averageConfidence) { this.averageConfidence = averageConfidence; }

        public Map<String, Integer> getLanguageDistribution() { return languageDistribution; }
        public void setLanguageDistribution(Map<String, Integer> languageDistribution) { this.languageDistribution = languageDistribution; }

        public Map<String, Integer> getEngineDistribution() { return engineDistribution; }
        public void setEngineDistribution(Map<String, Integer> engineDistribution) { this.engineDistribution = engineDistribution; }

        public List<DailyStat> getDailyStats() { return dailyStats; }
        public void setDailyStats(List<DailyStat> dailyStats) { this.dailyStats = dailyStats; }
    }

    public static class DailyStat {
        private String date;
        private Integer processedPages;
        private Double averageConfidence;

        public DailyStat(String date, Integer processedPages, Double averageConfidence) {
            this.date = date;
            this.processedPages = processedPages;
            this.averageConfidence = averageConfidence;
        }

        public String getDate() { return date; }
        public void setDate(String date) { this.date = date; }

        public Integer getProcessedPages() { return processedPages; }
        public void setProcessedPages(Integer processedPages) { this.processedPages = processedPages; }

        public Double getAverageConfidence() { return averageConfidence; }
        public void setAverageConfidence(Double averageConfidence) { this.averageConfidence = averageConfidence; }
    }

    @GetMapping("/{documentId}/ocr/stats")
    public ResponseEntity<GetOcrStatisticsResponse> getOcrStatistics(
            @PathVariable String documentId,
            @RequestParam(required = false) String groupBy,
            @RequestParam(required = false) String startDate,
            @RequestParam(required = false) String endDate) {

        // 构建请求信息
        Map<String, Object> requestInfo = new HashMap<>();
        requestInfo.put("documentId", documentId);
        requestInfo.put("groupBy", groupBy);
        requestInfo.put("startDate", startDate);
        requestInfo.put("endDate", endDate);

        // 打印接收到的请求
        printRequest(requestInfo);

        try {
            // 1. 验证请求数据
            if (documentId == null || documentId.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new GetOcrStatisticsResponse(false, "文档ID不能为空", null)
                );
            }

            // 2. 检查文档是否存在
            String checkDocumentSql = "SELECT COUNT(*) FROM documents WHERE document_id = ?";
            Integer documentCount = jdbcTemplate.queryForObject(checkDocumentSql, Integer.class, documentId);

            if (documentCount == null || documentCount == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new GetOcrStatisticsResponse(false, "文档不存在", null)
                );
            }

            // 3. 检查OCR结果表是否存在
            String checkTableSql = "SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'document_ocr_results'";
            Integer tableCount = jdbcTemplate.queryForObject(checkTableSql, Integer.class);

            if (tableCount == null || tableCount == 0) {
                return getEmptyStatistics(documentId);
            }

            // 4. 构建基础统计查询
            StringBuilder baseQueryBuilder = new StringBuilder();
            baseQueryBuilder.append("SELECT COUNT(*) as total_pages, ");
            baseQueryBuilder.append("AVG(confidence) as avg_confidence ");
            baseQueryBuilder.append("FROM document_ocr_results WHERE document_id = ?");

            List<Object> baseParams = new ArrayList<>();
            baseParams.add(documentId);

            // 添加日期条件
            if (startDate != null && !startDate.trim().isEmpty()) {
                baseQueryBuilder.append(" AND created_at >= ?");
                baseParams.add(LocalDateTime.parse(startDate + "T00:00:00"));
            }

            if (endDate != null && !endDate.trim().isEmpty()) {
                baseQueryBuilder.append(" AND created_at <= ?");
                baseParams.add(LocalDateTime.parse(endDate + "T23:59:59"));
            }

            // 5. 执行基础统计查询
            Map<String, Object> baseStats = jdbcTemplate.queryForMap(baseQueryBuilder.toString(), baseParams.toArray());
            printQueryResult(baseStats);

            Integer totalPages = baseStats.get("total_pages") != null ? ((Number) baseStats.get("total_pages")).intValue() : 0;
            Double averageConfidence = baseStats.get("avg_confidence") != null ? ((Number) baseStats.get("avg_confidence")).doubleValue() : 0.0;

            // 6. 根据groupBy参数获取不同的统计
            Map<String, Integer> languageDistribution = new HashMap<>();
            Map<String, Integer> engineDistribution = new HashMap<>();
            List<DailyStat> dailyStats = new ArrayList<>();

            if (groupBy != null) {
                switch (groupBy.toLowerCase()) {
                    case "language":
                        languageDistribution = getLanguageDistribution(documentId, startDate, endDate);
                        break;
                    case "engine":
                        engineDistribution = getEngineDistribution(documentId, startDate, endDate);
                        break;
                    case "page":
                        // 按页面统计
                        dailyStats = getPageStats(documentId, startDate, endDate);
                        break;
                    default:
                        // 默认按日期统计
                        dailyStats = getDailyStats(documentId, startDate, endDate);
                        break;
                }
            } else {
                // 默认获取所有统计
                languageDistribution = getLanguageDistribution(documentId, startDate, endDate);
                engineDistribution = getEngineDistribution(documentId, startDate, endDate);
                dailyStats = getDailyStats(documentId, startDate, endDate);
            }

            // 7. 准备响应数据
            OcrStatisticsData responseData = new OcrStatisticsData(
                    documentId,
                    totalPages,
                    totalPages, // 假设所有页面都已处理
                    averageConfidence,
                    languageDistribution,
                    engineDistribution,
                    dailyStats
            );

            GetOcrStatisticsResponse response = new GetOcrStatisticsResponse(true, "获取OCR统计成功", responseData);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取OCR统计过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new GetOcrStatisticsResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private ResponseEntity<GetOcrStatisticsResponse> getEmptyStatistics(String documentId) {
        OcrStatisticsData emptyData = new OcrStatisticsData(
                documentId,
                0,
                0,
                0.0,
                new HashMap<>(),
                new HashMap<>(),
                new ArrayList<>()
        );

        GetOcrStatisticsResponse response = new GetOcrStatisticsResponse(true, "没有OCR统计数据", emptyData);

        // 打印返回数据
        printResponse(response);

        return ResponseEntity.ok(response);
    }

    private Map<String, Integer> getLanguageDistribution(String documentId, String startDate, String endDate) {
        Map<String, Integer> distribution = new HashMap<>();

        try {
            StringBuilder queryBuilder = new StringBuilder();
            queryBuilder.append("SELECT metadata_json FROM document_ocr_results WHERE document_id = ?");

            List<Object> params = new ArrayList<>();
            params.add(documentId);

            // 添加日期条件
            if (startDate != null && !startDate.trim().isEmpty()) {
                queryBuilder.append(" AND created_at >= ?");
                params.add(LocalDateTime.parse(startDate + "T00:00:00"));
            }

            if (endDate != null && !endDate.trim().isEmpty()) {
                queryBuilder.append(" AND created_at <= ?");
                params.add(LocalDateTime.parse(endDate + "T23:59:59"));
            }

            List<Map<String, Object>> results = jdbcTemplate.queryForList(queryBuilder.toString(), params.toArray());

            for (Map<String, Object> result : results) {
                String metadataJson = (String) result.get("metadata_json");
                if (metadataJson != null && !metadataJson.trim().isEmpty()) {
                    try {
                        Map<String, Object> metadata = objectMapper.readValue(metadataJson, Map.class);
                        String language = (String) metadata.get("language");
                        if (language != null) {
                            distribution.put(language, distribution.getOrDefault(language, 0) + 1);
                        }
                    } catch (Exception e) {
                        System.err.println("解析metadata失败: " + e.getMessage());
                    }
                }
            }
        } catch (Exception e) {
            System.err.println("获取语言分布失败: " + e.getMessage());
        }

        return distribution;
    }

    private Map<String, Integer> getEngineDistribution(String documentId, String startDate, String endDate) {
        Map<String, Integer> distribution = new HashMap<>();

        try {
            StringBuilder queryBuilder = new StringBuilder();
            queryBuilder.append("SELECT metadata_json FROM document_ocr_results WHERE document_id = ?");

            List<Object> params = new ArrayList<>();
            params.add(documentId);

            // 添加日期条件
            if (startDate != null && !startDate.trim().isEmpty()) {
                queryBuilder.append(" AND created_at >= ?");
                params.add(LocalDateTime.parse(startDate + "T00:00:00"));
            }

            if (endDate != null && !endDate.trim().isEmpty()) {
                queryBuilder.append(" AND created_at <= ?");
                params.add(LocalDateTime.parse(endDate + "T23:59:59"));
            }

            List<Map<String, Object>> results = jdbcTemplate.queryForList(queryBuilder.toString(), params.toArray());

            for (Map<String, Object> result : results) {
                String metadataJson = (String) result.get("metadata_json");
                if (metadataJson != null && !metadataJson.trim().isEmpty()) {
                    try {
                        Map<String, Object> metadata = objectMapper.readValue(metadataJson, Map.class);
                        String engine = (String) metadata.get("engine");
                        if (engine != null) {
                            distribution.put(engine, distribution.getOrDefault(engine, 0) + 1);
                        }
                    } catch (Exception e) {
                        System.err.println("解析metadata失败: " + e.getMessage());
                    }
                }
            }
        } catch (Exception e) {
            System.err.println("获取引擎分布失败: " + e.getMessage());
        }

        return distribution;
    }

    private List<DailyStat> getDailyStats(String documentId, String startDate, String endDate) {
        List<DailyStat> dailyStats = new ArrayList<>();

        try {
            StringBuilder queryBuilder = new StringBuilder();
            queryBuilder.append("SELECT DATE(created_at) as stat_date, ");
            queryBuilder.append("COUNT(*) as processed_pages, ");
            queryBuilder.append("AVG(confidence) as avg_confidence ");
            queryBuilder.append("FROM document_ocr_results WHERE document_id = ?");

            List<Object> params = new ArrayList<>();
            params.add(documentId);

            // 添加日期条件
            if (startDate != null && !startDate.trim().isEmpty()) {
                queryBuilder.append(" AND created_at >= ?");
                params.add(LocalDateTime.parse(startDate + "T00:00:00"));
            }

            if (endDate != null && !endDate.trim().isEmpty()) {
                queryBuilder.append(" AND created_at <= ?");
                params.add(LocalDateTime.parse(endDate + "T23:59:59"));
            }

            queryBuilder.append(" GROUP BY DATE(created_at) ORDER BY stat_date DESC");

            List<Map<String, Object>> results = jdbcTemplate.queryForList(queryBuilder.toString(), params.toArray());

            for (Map<String, Object> result : results) {
                String date = result.get("stat_date").toString();
                Integer processedPages = result.get("processed_pages") != null ? ((Number) result.get("processed_pages")).intValue() : 0;
                Double avgConfidence = result.get("avg_confidence") != null ? ((Number) result.get("avg_confidence")).doubleValue() : 0.0;

                dailyStats.add(new DailyStat(date, processedPages, avgConfidence));
            }
        } catch (Exception e) {
            System.err.println("获取每日统计失败: " + e.getMessage());
        }

        return dailyStats;
    }

    private List<DailyStat> getPageStats(String documentId, String startDate, String endDate) {
        List<DailyStat> pageStats = new ArrayList<>();

        try {
            StringBuilder queryBuilder = new StringBuilder();
            queryBuilder.append("SELECT page_number, ");
            queryBuilder.append("COUNT(*) as processed_count, ");
            queryBuilder.append("AVG(confidence) as avg_confidence ");
            queryBuilder.append("FROM document_ocr_results WHERE document_id = ?");

            List<Object> params = new ArrayList<>();
            params.add(documentId);

            // 添加日期条件
            if (startDate != null && !startDate.trim().isEmpty()) {
                queryBuilder.append(" AND created_at >= ?");
                params.add(LocalDateTime.parse(startDate + "T00:00:00"));
            }

            if (endDate != null && !endDate.trim().isEmpty()) {
                queryBuilder.append(" AND created_at <= ?");
                params.add(LocalDateTime.parse(endDate + "T23:59:59"));
            }

            queryBuilder.append(" GROUP BY page_number ORDER BY page_number");

            List<Map<String, Object>> results = jdbcTemplate.queryForList(queryBuilder.toString(), params.toArray());

            for (Map<String, Object> result : results) {
                String page = "Page " + result.get("page_number").toString();
                Integer processedCount = result.get("processed_count") != null ? ((Number) result.get("processed_count")).intValue() : 0;
                Double avgConfidence = result.get("avg_confidence") != null ? ((Number) result.get("avg_confidence")).doubleValue() : 0.0;

                pageStats.add(new DailyStat(page, processedCount, avgConfidence));
            }
        } catch (Exception e) {
            System.err.println("获取页面统计失败: " + e.getMessage());
        }

        return pageStats;
    }
}
--- 结束文件: OcrGetStatistics.java ---

--- 开始文件: OcrGetTaskStatus.java ---
package com.vue.readingapp.ocr;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import com.fasterxml.jackson.databind.ObjectMapper;

@RestController
@RequestMapping("/api/v1/documents/ocr/tasks")
public class OcrGetTaskStatus {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();
    private DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd'T'HH:mm:ss");

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取OCR任务状态请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("==========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class GetTaskStatusResponse {
        private boolean success;
        private String message;
        private TaskStatusData data;

        public GetTaskStatusResponse(boolean success, String message, TaskStatusData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public TaskStatusData getData() { return data; }
        public void setData(TaskStatusData data) { this.data = data; }
    }

    public static class TaskStatusData {
        private String taskId;
        private String status;
        private Integer progress;
        private String currentDocument;
        private Integer currentPage;
        private Integer totalPages;
        private Integer estimatedTimeRemaining;
        private TaskResult result;

        public TaskStatusData(String taskId, String status, Integer progress, String currentDocument,
                              Integer currentPage, Integer totalPages, Integer estimatedTimeRemaining,
                              TaskResult result) {
            this.taskId = taskId;
            this.status = status;
            this.progress = progress;
            this.currentDocument = currentDocument;
            this.currentPage = currentPage;
            this.totalPages = totalPages;
            this.estimatedTimeRemaining = estimatedTimeRemaining;
            this.result = result;
        }

        public String getTaskId() { return taskId; }
        public void setTaskId(String taskId) { this.taskId = taskId; }

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public Integer getProgress() { return progress; }
        public void setProgress(Integer progress) { this.progress = progress; }

        public String getCurrentDocument() { return currentDocument; }
        public void setCurrentDocument(String currentDocument) { this.currentDocument = currentDocument; }

        public Integer getCurrentPage() { return currentPage; }
        public void setCurrentPage(Integer currentPage) { this.currentPage = currentPage; }

        public Integer getTotalPages() { return totalPages; }
        public void setTotalPages(Integer totalPages) { this.totalPages = totalPages; }

        public Integer getEstimatedTimeRemaining() { return estimatedTimeRemaining; }
        public void setEstimatedTimeRemaining(Integer estimatedTimeRemaining) { this.estimatedTimeRemaining = estimatedTimeRemaining; }

        public TaskResult getResult() { return result; }
        public void setResult(TaskResult result) { this.result = result; }
    }

    public static class TaskResult {
        private Integer processedPages;
        private Integer successfulPages;
        private Integer failedPages;
        private Double averageConfidence;

        public TaskResult(Integer processedPages, Integer successfulPages, Integer failedPages, Double averageConfidence) {
            this.processedPages = processedPages;
            this.successfulPages = successfulPages;
            this.failedPages = failedPages;
            this.averageConfidence = averageConfidence;
        }

        public Integer getProcessedPages() { return processedPages; }
        public void setProcessedPages(Integer processedPages) { this.processedPages = processedPages; }

        public Integer getSuccessfulPages() { return successfulPages; }
        public void setSuccessfulPages(Integer successfulPages) { this.successfulPages = successfulPages; }

        public Integer getFailedPages() { return failedPages; }
        public void setFailedPages(Integer failedPages) { this.failedPages = failedPages; }

        public Double getAverageConfidence() { return averageConfidence; }
        public void setAverageConfidence(Double averageConfidence) { this.averageConfidence = averageConfidence; }
    }

    @GetMapping("/{taskId}/status")
    public ResponseEntity<GetTaskStatusResponse> getTaskStatus(@PathVariable String taskId) {
        // 打印接收到的请求
        Map<String, Object> requestInfo = new HashMap<>();
        requestInfo.put("taskId", taskId);
        printRequest(requestInfo);

        try {
            // 1. 验证请求数据
            if (taskId == null || taskId.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new GetTaskStatusResponse(false, "任务ID不能为空", null)
                );
            }

            // 2. 先检查批量任务表
            String checkBatchTableSql = "SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'batch_ocr_tasks'";
            Integer batchTableCount = jdbcTemplate.queryForObject(checkBatchTableSql, Integer.class);

            if (batchTableCount != null && batchTableCount > 0) {
                // 查询批量任务
                String queryBatchSql = "SELECT batch_id, status, progress, total_pages, processed_pages, successful_pages, failed_pages, average_confidence, estimated_time, started_at, completed_at FROM batch_ocr_tasks WHERE batch_id = ?";
                List<Map<String, Object>> batchTasks = jdbcTemplate.queryForList(queryBatchSql, taskId);

                if (!batchTasks.isEmpty()) {
                    Map<String, Object> batchTask = batchTasks.get(0);
                    printQueryResult(batchTask);

                    // 准备批量任务响应数据
                    String status = (String) batchTask.get("status");
                    Integer progress = batchTask.get("progress") != null ? ((Number) batchTask.get("progress")).intValue() : 0;
                    Integer totalPages = batchTask.get("total_pages") != null ? ((Number) batchTask.get("total_pages")).intValue() : 0;
                    Integer processedPages = batchTask.get("processed_pages") != null ? ((Number) batchTask.get("processed_pages")).intValue() : 0;

                    // 计算剩余时间
                    Integer estimatedTimeRemaining = 0;
                    if ("processing".equals(status) && progress > 0) {
                        LocalDateTime startedAt = (LocalDateTime) batchTask.get("started_at");
                        long elapsedSeconds = java.time.Duration.between(startedAt, LocalDateTime.now()).getSeconds();
                        int totalEstimatedSeconds = batchTask.get("estimated_time") != null ? ((Number) batchTask.get("estimated_time")).intValue() : 0;

                        if (progress > 0) {
                            int remainingSeconds = totalEstimatedSeconds - (int) elapsedSeconds;
                            estimatedTimeRemaining = Math.max(0, remainingSeconds);
                        }
                    }

                    // 准备结果数据
                    TaskResult result = null;
                    if ("completed".equals(status) || "failed".equals(status)) {
                        result = new TaskResult(
                                processedPages,
                                batchTask.get("successful_pages") != null ? ((Number) batchTask.get("successful_pages")).intValue() : 0,
                                batchTask.get("failed_pages") != null ? ((Number) batchTask.get("failed_pages")).intValue() : 0,
                                batchTask.get("average_confidence") != null ? ((Number) batchTask.get("average_confidence")).doubleValue() : 0.0
                        );
                    }

                    TaskStatusData responseData = new TaskStatusData(
                            taskId,
                            status,
                            progress,
                            null, // 当前文档
                            null, // 当前页码
                            totalPages,
                            estimatedTimeRemaining,
                            result
                    );

                    GetTaskStatusResponse response = new GetTaskStatusResponse(true, "获取批量OCR任务状态成功", responseData);

                    // 打印返回数据
                    printResponse(response);

                    return ResponseEntity.ok(response);
                }
            }

            // 3. 检查普通OCR任务表
            String checkTaskTableSql = "SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'ocr_tasks'";
            Integer taskTableCount = jdbcTemplate.queryForObject(checkTaskTableSql, Integer.class);

            if (taskTableCount == null || taskTableCount == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new GetTaskStatusResponse(false, "任务不存在", null)
                );
            }

            // 4. 查询OCR任务
            String queryTaskSql = "SELECT task_id, document_id, page_number, status, progress, estimated_time, started_at, completed_at, result_json FROM ocr_tasks WHERE task_id = ?";
            List<Map<String, Object>> tasks = jdbcTemplate.queryForList(queryTaskSql, taskId);
            printQueryResult(tasks);

            if (tasks.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new GetTaskStatusResponse(false, "任务不存在", null)
                );
            }

            Map<String, Object> task = tasks.get(0);

            // 5. 准备响应数据
            String status = (String) task.get("status");
            Integer progress = task.get("progress") != null ? ((Number) task.get("progress")).intValue() : 0;
            String currentDocument = (String) task.get("document_id");
            Integer currentPage = task.get("page_number") != null ? ((Number) task.get("page_number")).intValue() : null;
            Integer totalPages = 1; // 单页任务

            // 计算剩余时间
            Integer estimatedTimeRemaining = 0;
            if ("processing".equals(status) && progress > 0) {
                LocalDateTime startedAt = (LocalDateTime) task.get("started_at");
                long elapsedSeconds = java.time.Duration.between(startedAt, LocalDateTime.now()).getSeconds();
                int totalEstimatedSeconds = task.get("estimated_time") != null ? ((Number) task.get("estimated_time")).intValue() : 30;

                if (progress > 0) {
                    int remainingSeconds = totalEstimatedSeconds - (int) elapsedSeconds;
                    estimatedTimeRemaining = Math.max(0, remainingSeconds);
                }
            }

            // 准备结果数据
            TaskResult result = null;
            if ("completed".equals(status)) {
                try {
                    String resultJson = (String) task.get("result_json");
                    if (resultJson != null && !resultJson.trim().isEmpty()) {
                        Map<String, Object> resultMap = objectMapper.readValue(resultJson, Map.class);
                        Double confidence = resultMap.get("confidence") != null ? ((Number) resultMap.get("confidence")).doubleValue() : 0.0;

                        result = new TaskResult(1, 1, 0, confidence);
                    }
                } catch (Exception e) {
                    System.err.println("解析任务结果失败: " + e.getMessage());
                }
            } else if ("failed".equals(status)) {
                result = new TaskResult(1, 0, 1, 0.0);
            }

            TaskStatusData responseData = new TaskStatusData(
                    taskId,
                    status,
                    progress,
                    currentDocument,
                    currentPage,
                    totalPages,
                    estimatedTimeRemaining,
                    result
            );

            GetTaskStatusResponse response = new GetTaskStatusResponse(true, "获取OCR任务状态成功", responseData);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取OCR任务状态过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new GetTaskStatusResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: OcrGetTaskStatus.java ---

--- 开始文件: OcrProcessDocument.java ---
package com.vue.readingapp.ocr;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Map;
import java.util.HashMap;
import java.util.List; // 尽管导入了，但在这个方法中未直接使用
import java.util.UUID;
import com.fasterxml.jackson.databind.ObjectMapper;

@RestController
@RequestMapping("/api/v1/documents")
public class OcrProcessDocument {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();
    // DateTimeFormatter 在这里未被直接使用，但保留以防后续需求
    private DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd'T'HH:mm:ss");

    // --- 打印方法 (用于调试) ---
    private void printRequest(Object request) {
        System.out.println("=== 收到文档OCR处理请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=======================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // --- DTO 类 ---
    public static class ProcessDocumentRequest {
        private String documentId; // 虽然在 URL 中，但保留可能用于其他场景
        private Integer page;      // 同上
        private String options;    // OCR 处理选项

        public String getDocumentId() { return documentId; }
        public void setDocumentId(String documentId) { this.documentId = documentId; }

        public Integer getPage() { return page; }
        public void setPage(Integer page) { this.page = page; }

        public String getOptions() { return options; }
        public void setOptions(String options) { this.options = options; }

        @Override
        public String toString() {
            return "ProcessDocumentRequest{" +
                    "documentId='" + documentId + '\'' +
                    ", page=" + page +
                    ", options='" + options + '\'' +
                    '}';
        }
    }

    public static class ProcessDocumentResponse {
        private boolean success;
        private String message;
        private TaskData data;

        public ProcessDocumentResponse(boolean success, String message, TaskData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public TaskData getData() { return data; }
        public void setData(TaskData data) { this.data = data; }
    }

    public static class TaskData {
        private String taskId;
        private String status;
        private Integer progress;
        private Integer estimatedTime; // 可能是处理预估时间

        public TaskData(String taskId, String status, Integer progress, Integer estimatedTime) {
            this.taskId = taskId;
            this.status = status;
            this.progress = progress;
            this.estimatedTime = estimatedTime;
        }

        public String getTaskId() { return taskId; }
        public void setTaskId(String taskId) { this.taskId = taskId; }

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public Integer getProgress() { return progress; }
        public void setProgress(Integer progress) { this.progress = progress; }

        public Integer getEstimatedTime() { return estimatedTime; }
        public void setEstimatedTime(Integer estimatedTime) { this.estimatedTime = estimatedTime; }
    }

    @PostMapping("/{documentId}/pages/{page}/ocr")
    public ResponseEntity<ProcessDocumentResponse> processDocumentPage(
            @PathVariable String documentId,
            @PathVariable Integer page,
            @RequestBody ProcessDocumentRequest request) {

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证请求数据
            if (documentId == null || documentId.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new ProcessDocumentResponse(false, "文档ID不能为空", null)
                );
            }

            if (page == null || page <= 0) {
                return ResponseEntity.badRequest().body(
                        new ProcessDocumentResponse(false, "页码必须大于0", null)
                );
            }

            // 2. 检查文档是否存在 (假设 documents 表存在 document_id 列)
            String checkDocumentSql = "SELECT COUNT(*) FROM documents WHERE document_id = ?";
            Integer documentCount = jdbcTemplate.queryForObject(checkDocumentSql, Integer.class, documentId);

            if (documentCount == null || documentCount == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new ProcessDocumentResponse(false, "文档不存在", null)
                );
            }

            // 3. 生成任务ID
            String taskId = "ocr_task_" + UUID.randomUUID().toString().substring(0, 8);
            LocalDateTime now = LocalDateTime.now();

            // 4. 检查并创建 ocr_tasks 表 (如果不存在)
            String checkTaskTableSql = "SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'ocr_tasks'";
            Integer taskTableCount = jdbcTemplate.queryForObject(checkTaskTableSql, Integer.class);

            if (taskTableCount == null || taskTableCount == 0) {
                String createTaskTableSql = "CREATE TABLE ocr_tasks (" +
                        "task_id VARCHAR(50) PRIMARY KEY," +
                        "document_id VARCHAR(50) NOT NULL," +
                        "page_number INT," +
                        "status VARCHAR(20) NOT NULL," + // e.g., 'processing', 'completed', 'failed'
                        "progress INT DEFAULT 0," +       // 0-100
                        "options_json TEXT," +            // JSON string of options
                        "result_json TEXT," +             // JSON string of OCR results
                        "error_message TEXT," +           // Error message if status is 'failed'
                        "estimated_time INT," +           // Estimated processing time in seconds (example)
                        "started_at TIMESTAMP," +
                        "completed_at TIMESTAMP," +
                        "created_at TIMESTAMP," +
                        "updated_at TIMESTAMP," +
                        "FOREIGN KEY (document_id) REFERENCES documents(document_id) ON DELETE CASCADE" +
                        ")";
                jdbcTemplate.execute(createTaskTableSql);
                System.out.println("INFO: 已创建 ocr_tasks 表");
            }

            // 5. 插入 OCR 任务记录到 ocr_tasks 表
            String insertTaskSql = "INSERT INTO ocr_tasks (task_id, document_id, page_number, status, progress, options_json, estimated_time, started_at, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";

            jdbcTemplate.update(insertTaskSql,
                    taskId,
                    documentId,
                    page,
                    "processing", // Initial status
                    0,            // Initial progress
                    request.getOptions() != null ? request.getOptions() : "{}", // Store options
                    30,           // Example estimated time
                    now,          // Started at
                    now,          // Created at
                    now           // Updated at
            );

            // 6. 使用 final 变量传递给 lambda 表达式，用于异步线程
            final String finalDocumentId = documentId;
            final Integer finalPage = page;
            final String finalTaskId = taskId;

            // 7. 启动异步处理任务 (模拟 OCR 过程)
            new Thread(() -> {
                try {
                    // --- 模拟 OCR 处理过程 ---
                    // 假设处理时间较长，分步更新进度
                    int totalSteps = 10;
                    int sleepIntervalMillis = 1000; // 每一步间隔 1 秒

                    for (int i = 1; i <= totalSteps; i++) {
                        Thread.sleep(sleepIntervalMillis);
                        int currentProgress = (i * 100) / totalSteps;

                        // 更新任务进度
                        String updateProgressSql = "UPDATE ocr_tasks SET progress = ?, updated_at = ? WHERE task_id = ?";
                        jdbcTemplate.update(updateProgressSql, currentProgress, LocalDateTime.now(), finalTaskId);

                        System.out.println("OCR 任务进度更新: " + finalTaskId + " - " + currentProgress + "%");

                        // 模拟 OCR 结果生成 (当进度达到 100%)
                        if (currentProgress == 100) {
                            // 生成模拟的 OCR 结果
                            Map<String, Object> ocrResultMap = new HashMap<>();
                            ocrResultMap.put("text", "这是第 " + finalPage + " 页的OCR识别文本内容。\n模拟OCR处理完成。");
                            ocrResultMap.put("confidence", 92.5);

                            Map<String, Object> metadata = new HashMap<>();
                            metadata.put("engine", "simulated_ocr_engine");
                            metadata.put("language", "auto");
                            metadata.put("processingTime", 2500); // milliseconds
                            metadata.put("imageSize", Map.of("width", 800, "height", 1000));
                            ocrResultMap.put("metadata", metadata);

                            // 将 OCR 结果转换为 JSON 字符串
                            String resultJson = objectMapper.writeValueAsString(ocrResultMap);

                            // 更新任务为完成状态，并保存结果
                            String completeTaskSql = "UPDATE ocr_tasks SET status = 'completed', progress = 100, result_json = ?, completed_at = ?, updated_at = ? WHERE task_id = ?";
                            jdbcTemplate.update(completeTaskSql,
                                    resultJson,
                                    LocalDateTime.now(), // Completed at
                                    LocalDateTime.now(), // Updated at
                                    finalTaskId
                            );

                            System.out.println("OCR 任务完成: " + finalTaskId);

                            // !!! 注意: 根据您提供的第二个代码片段, OCR 结果直接保存在 ocr_tasks 表的 result_json 字段.
                            // !!! 如果您还需要将结果保存到 document_ocr_results 表，请取消下面的注释并确保该表存在。
                            /*
                            saveOcrResultToDatabase(finalDocumentId, finalPage, resultJson, ocrResultMap);
                            */
                        }
                    }
                } catch (InterruptedException e) {
                    // 线程被中断
                    Thread.currentThread().interrupt(); // Restore interrupted status
                    System.err.println("OCR 处理线程被中断: " + finalTaskId + " - " + e.getMessage());
                    // 更新任务为失败状态
                    String failTaskSql = "UPDATE ocr_tasks SET status = 'failed', error_message = ?, updated_at = ? WHERE task_id = ?";
                    jdbcTemplate.update(failTaskSql, "Thread interrupted: " + e.getMessage(), LocalDateTime.now(), finalTaskId);
                } catch (Exception e) {
                    // 其他处理错误
                    System.err.println("OCR 处理线程错误: " + finalTaskId + " - " + e.getMessage());
                    e.printStackTrace(); // 打印详细堆栈信息
                    // 更新任务为失败状态
                    String failTaskSql = "UPDATE ocr_tasks SET status = 'failed', error_message = ?, updated_at = ? WHERE task_id = ?";
                    jdbcTemplate.update(failTaskSql, e.getMessage(), LocalDateTime.now(), finalTaskId);
                }
            }).start(); // 启动新线程

            // 8. 准备响应数据
            TaskData responseData = new TaskData(
                    taskId,
                    "processing", // 任务刚启动，状态为 processing
                    0,            // 初始进度
                    30            // 预估时间
            );

            ProcessDocumentResponse response = new ProcessDocumentResponse(true, "OCR 处理任务已启动，请稍后查询状态", responseData);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("文档OCR处理请求处理时发生内部错误: " + e.getMessage());
            e.printStackTrace(); // 打印详细堆栈信息
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ProcessDocumentResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    // --- 如果需要将 OCR 结果保存到 document_ocr_results 表，请取消此方法的注释 ---

    private void saveOcrResultToDatabase(String documentId, Integer page, String resultJson, Map<String, Object> ocrResultMap) {
        try {
            // 假设 document_ocr_results 表结构如下，请根据实际情况调整
            // CREATE TABLE document_ocr_results (
            //     ocr_id VARCHAR(50) PRIMARY KEY,
            //     document_id VARCHAR(50) NOT NULL,
            //     page_number INT,
            //     ocr_text TEXT,
            //     confidence DOUBLE,
            //     words_json TEXT, // 如果 OCR 结果包含 words
            //     lines_json TEXT, // 如果 OCR 结果包含 lines
            //     metadata_json TEXT,
            //     created_at TIMESTAMP,
            //     updated_at TIMESTAMP,
            //     FOREIGN KEY (document_id) REFERENCES documents(document_id) ON DELETE CASCADE
            // );

            String ocrResultId = "ocr_" + UUID.randomUUID().toString().substring(0, 8);
            LocalDateTime now = LocalDateTime.now();

            String insertSql = "INSERT INTO document_ocr_results (ocr_id, document_id, page_number, ocr_text, confidence, words_json, lines_json, metadata_json, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";

            // 从 ocrResultMap 中提取数据，需要根据 OcrResult 类的实际结构来填充
            String ocrText = (String) ocrResultMap.get("text");
            Double confidence = (Double) ocrResultMap.get("confidence");

            // 假设 ocrResultMap 包含 words, lines, metadata 的 Map 或 List
            // 您需要根据 OcrResult 类的实际结构来解析和转换
            String wordsJson = objectMapper.writeValueAsString(ocrResultMap.getOrDefault("words", List.of())); // 示例
            String linesJson = objectMapper.writeValueAsString(ocrResultMap.getOrDefault("lines", List.of())); // 示例
            String metadataJson = objectMapper.writeValueAsString(ocrResultMap.getOrDefault("metadata", new HashMap<>())); // 示例

            jdbcTemplate.update(insertSql,
                ocrResultId,
                documentId,
                page,
                ocrText,
                confidence,
                wordsJson,
                linesJson,
                metadataJson,
                now,
                now
            );
            System.out.println("INFO: OCR 结果已保存到 document_ocr_results 表，ocr_id: " + ocrResultId);

        } catch (Exception e) {
            System.err.println("保存 OCR 结果到 document_ocr_results 数据库失败: " + e.getMessage());
            e.printStackTrace();
        }
    }

}
--- 结束文件: OcrProcessDocument.java ---

--- 开始文件: OcrProcessPage.java ---
package com.vue.readingapp.ocr;

// 引入 OcrResult 和 OcrProcessingService
import com.vue.readingapp.ocr.core.OcrResult;
import com.vue.readingapp.ocr.service.OcrProcessingService;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Map;
import java.util.HashMap;
import java.util.List; // Not directly used in this snippet, but kept as it was in original imports
import java.util.UUID;
import com.fasterxml.jackson.databind.ObjectMapper;

@RestController
@RequestMapping("/api/v1/documents")
public class OcrProcessPage {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // OcrProcessingService 仅在 isImageContent 为 true 时使用
    @Autowired
    private OcrProcessingService ocrProcessingService;

    private ObjectMapper objectMapper = new ObjectMapper();
    // DateTimeFormatter is declared but not used in the final code, can be removed if not needed elsewhere
    private DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd'T'HH:mm:ss");

    // --- 打印方法 (用于调试) ---
    private void printRequest(Object request) {
        System.out.println("=== 收到页面OCR处理请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=======================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // --- DTO 类 ---
    public static class ProcessPageRequest {
        // These fields are redundant if they are already in the URL path, but kept for consistency with provided code.
        // They will be set by the controller using @PathVariable.
        private String documentId;
        private Integer page;

        private String content; // The actual content to process (base64 image or HTML string)
        private Boolean isImageContent; // Flag to distinguish between image and HTML content
        private PageOcrOptions options; // OCR processing options

        public String getDocumentId() { return documentId; }
        public void setDocumentId(String documentId) { this.documentId = documentId; }

        public Integer getPage() { return page; }
        public void setPage(Integer page) { this.page = page; }

        public String getContent() { return content; }
        public void setContent(String content) { this.content = content; }

        public Boolean getIsImageContent() { return isImageContent; }
        public void setIsImageContent(Boolean isImageContent) { this.isImageContent = isImageContent; }

        public PageOcrOptions getOptions() { return options; }
        public void setOptions(PageOcrOptions options) { this.options = options; }

        @Override
        public String toString() {
            return "ProcessPageRequest{" +
                    "documentId='" + documentId + '\'' +
                    ", page=" + page +
                    ", content='" + (content != null ? content.substring(0, Math.min(content.length(), 50)) + (content.length() > 50 ? "..." : "") : "null") + '\'' + // Truncate content for logging
                    ", isImageContent=" + isImageContent +
                    ", options=" + options +
                    '}';
        }
    }

    public static class PageOcrOptions {
        private String language;
        private Integer confidence; // Confidence threshold (e.g., 75)
        private Boolean preprocess; // Whether to preprocess the image
        private String format;      // Expected output format (e.g., "text", "json")

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }

        public Integer getConfidence() { return confidence; }
        public void setConfidence(Integer confidence) { this.confidence = confidence; }

        public Boolean getPreprocess() { return preprocess; }
        public void setPreprocess(Boolean preprocess) { this.preprocess = preprocess; }

        public String getFormat() { return format; }
        public void setFormat(String format) { this.format = format; }

        @Override
        public String toString() {
            return "PageOcrOptions{" +
                    "language='" + language + '\'' +
                    ", confidence=" + confidence +
                    ", preprocess=" + preprocess +
                    ", format='" + format + '\'' +
                    '}';
        }
    }

    // Response DTO
    public static class ProcessPageResponse {
        private boolean success;
        private String message;
        private PageOcrResultData data; // Contains task details

        public ProcessPageResponse(boolean success, String message, PageOcrResultData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public PageOcrResultData getData() { return data; }
        public void setData(PageOcrResultData data) { this.data = data; }
    }

    public static class PageOcrResultData {
        private String taskId;
        private String status;      // e.g., "processing", "completed", "failed"
        private Integer progress;   // 0-100
        private Integer estimatedTime; // Estimated time in seconds for the task

        public PageOcrResultData(String taskId, String status, Integer progress, Integer estimatedTime) {
            this.taskId = taskId;
            this.status = status;
            this.progress = progress;
            this.estimatedTime = estimatedTime;
        }

        public String getTaskId() { return taskId; }
        public void setTaskId(String taskId) { this.taskId = taskId; }

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public Integer getProgress() { return progress; }
        public void setProgress(Integer progress) { this.progress = progress; }

        public Integer getEstimatedTime() { return estimatedTime; }
        public void setEstimatedTime(Integer estimatedTime) { this.estimatedTime = estimatedTime; }
    }

    @PostMapping("/{documentId}/pages/{page}/ocr-process")
    public ResponseEntity<ProcessPageResponse> processPage(
            @PathVariable String documentId,
            @PathVariable Integer page,
            @RequestBody ProcessPageRequest request) {

        // Set documentId and page from path variables to the request object.
        // This assumes the request body might not contain these if they are always in the URL.
        request.setDocumentId(documentId);
        request.setPage(page);

        // Print the received request for debugging
        printRequest(request);

        try {
            // 1. Validate input data
            if (documentId == null || documentId.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new ProcessPageResponse(false, "文档ID不能为空", null)
                );
            }

            if (page == null || page <= 0) {
                return ResponseEntity.badRequest().body(
                        new ProcessPageResponse(false, "页码必须大于0", null)
                );
            }

            if (request.getContent() == null || request.getContent().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new ProcessPageResponse(false, "内容不能为空", null)
                );
            }

            // 2. Check if the document exists in the database
            // Assumes 'documents' table exists with 'document_id' column
            String checkDocumentSql = "SELECT COUNT(*) FROM documents WHERE document_id = ?";
            Integer documentCount = jdbcTemplate.queryForObject(checkDocumentSql, Integer.class, documentId);

            if (documentCount == null || documentCount == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new ProcessPageResponse(false, "文档不存在", null)
                );
            }

            // 3. Parse and set default OCR options if not provided
            PageOcrOptions ocrOptions = request.getOptions();
            if (ocrOptions == null) {
                ocrOptions = new PageOcrOptions(); // Initialize if null
            }
            // Set default values if options are missing
            if (ocrOptions.getLanguage() == null) ocrOptions.setLanguage("zh"); // Default to Chinese
            if (ocrOptions.getConfidence() == null) ocrOptions.setConfidence(75); // Default confidence threshold
            if (ocrOptions.getPreprocess() == null) ocrOptions.setPreprocess(true); // Default to preprocess
            if (ocrOptions.getFormat() == null) ocrOptions.setFormat("text"); // Default output format

            // 4. Generate a unique task ID
            String taskId = "page_ocr_" + UUID.randomUUID().toString().substring(0, 8);
            LocalDateTime now = LocalDateTime.now();

            // 5. Check if the OCR task table exists, create it if not
            // This is a good practice for first-time deployment or testing
            String checkTaskTableSql = "SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'page_ocr_tasks'";
            Integer taskTableCount = jdbcTemplate.queryForObject(checkTaskTableSql, Integer.class);

            if (taskTableCount == null || taskTableCount == 0) {
                String createTaskTableSql = "CREATE TABLE page_ocr_tasks (" +
                        "task_id VARCHAR(50) PRIMARY KEY," +
                        "document_id VARCHAR(50) NOT NULL," +
                        "page_number INT NOT NULL," +
                        "content_type VARCHAR(20)," + // e.g., 'image', 'html'
                        "content_length INT," +        // Length of the content string
                        "status VARCHAR(20) NOT NULL," + // e.g., 'processing', 'completed', 'failed'
                        "progress INT DEFAULT 0," +       // Progress percentage (0-100)
                        "options_json TEXT," +            // JSON string of OCR options
                        "result_json TEXT," +             // JSON string of OCR result
                        "error_message TEXT," +           // Error message if status is 'failed'
                        "estimated_time INT," +           // Estimated processing time in seconds
                        "started_at TIMESTAMP," +
                        "completed_at TIMESTAMP," +
                        "created_at TIMESTAMP," +
                        "updated_at TIMESTAMP," +
                        "FOREIGN KEY (document_id) REFERENCES documents(document_id) ON DELETE CASCADE" +
                        ")";
                jdbcTemplate.execute(createTaskTableSql);
                System.out.println("INFO: Created table 'page_ocr_tasks'");
            }

            // 6. Insert a new record for the OCR task into the 'page_ocr_tasks' table
            String insertTaskSql = "INSERT INTO page_ocr_tasks (task_id, document_id, page_number, content_type, content_length, status, progress, options_json, estimated_time, started_at, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";

            String optionsJson = objectMapper.writeValueAsString(ocrOptions);
            String contentType = (request.getIsImageContent() != null && request.getIsImageContent()) ? "image" : "html";
            int contentLength = request.getContent().length();
            int estimatedTime = 15; // Example estimated time in seconds

            jdbcTemplate.update(insertTaskSql,
                    taskId,
                    documentId,
                    page,
                    contentType,
                    contentLength,
                    "processing", // Initial status
                    0,            // Initial progress
                    optionsJson,
                    estimatedTime,
                    now,          // Started at
                    now,          // Created at
                    now           // Updated at
            );

            // 7. Prepare final variables for use in the lambda expression (thread)
            final String finalDocumentId = documentId;
            final Integer finalPage = page;
            final String finalTaskId = taskId;
            final String finalContent = request.getContent();
            final Boolean finalIsImageContent = request.getIsImageContent();
            final PageOcrOptions finalOptions = ocrOptions; // Use the parsed/defaulted options

            // 8. Start an asynchronous thread to process the page content
            new Thread(() -> {
                try {
                    // Delegate the actual processing to a dedicated method
                    processPageContent(finalTaskId, finalDocumentId, finalPage, finalContent,
                            finalIsImageContent, finalOptions);
                } catch (Exception e) {
                    System.err.println("Page OCR processing thread encountered an error: " + e.getMessage());
                    e.printStackTrace(); // Log the stack trace
                    // Update task status to 'failed' if any exception occurs during processing
                    String failTaskSql = "UPDATE page_ocr_tasks SET status = 'failed', error_message = ?, updated_at = ? WHERE task_id = ?";
                    jdbcTemplate.update(failTaskSql, e.getMessage(), LocalDateTime.now(), finalTaskId);
                }
            }).start(); // Start the new thread

            // 9. Prepare the response data for the client
            PageOcrResultData responseData = new PageOcrResultData(
                    taskId,
                    "processing", // Task has been initiated, status is 'processing'
                    0,            // Initial progress
                    estimatedTime // The estimated time for this task
            );

            ProcessPageResponse response = new ProcessPageResponse(true, "页面OCR处理任务已启动", responseData);

            // Print the response before sending
            printResponse(response);

            // Return a successful response with the task details
            return ResponseEntity.ok(response);

        } catch (Exception e) {
            // Catch any unexpected exceptions during the initial request handling
            System.err.println("An unexpected error occurred during page OCR processing request: " + e.getMessage());
            e.printStackTrace(); // Log the stack trace
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ProcessPageResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    /**
     * Performs the actual OCR or HTML content processing asynchronously.
     * This method is called by the new thread.
     */
    private void processPageContent(String taskId, String documentId, Integer page,
                                    String content, Boolean isImageContent, PageOcrOptions options) {
        try {
            LocalDateTime startTime = LocalDateTime.now();
            System.out.println("Starting page content processing for TaskID: " + taskId + ", DocumentID: " + documentId + ", Page: " + page);
            System.out.println("Content Type: " + (isImageContent != null && isImageContent ? "Image" : "HTML"));
            System.out.println("Content Length: " + content.length());
            System.out.println("OCR Options: Language=" + options.getLanguage() + ", Confidence=" + options.getConfidence() + ", Preprocess=" + options.getPreprocess());

            // --- Simulate processing progress ---
            // This loop simulates a long-running OCR process by updating progress in steps.
            int totalSteps = 10; // Number of progress update steps
            int sleepIntervalMillis = 750; // Time to sleep between progress updates

            for (int i = 1; i <= totalSteps; i++) {
                Thread.sleep(sleepIntervalMillis);
                int currentProgress = (i * 100) / totalSteps; // Calculate progress percentage

                // Update task progress in the database
                String updateProgressSql = "UPDATE page_ocr_tasks SET progress = ?, updated_at = ? WHERE task_id = ?";
                jdbcTemplate.update(updateProgressSql, currentProgress, LocalDateTime.now(), taskId);

                System.out.println("Page OCR Task Progress Update: " + taskId + " - " + currentProgress + "%");

                // --- Simulate completion when progress reaches 100% ---
                if (currentProgress == 100) {
                    // Generate simulated OCR result
                    Map<String, Object> ocrResultMap = new HashMap<>();
                    Map<String, Object> metadata = new HashMap<>();

                    if (isImageContent != null && isImageContent) {
                        // Process as image content using OcrProcessingService
                        // The actual call to ocrProcessingService.processBase64Image happens here.
                        // For simulation, we create a mock OcrResult.
                        // In a real scenario, this would be:
                        // OcrResult ocrResult = ocrProcessingService.processBase64Image(content, extractOcrServiceOptions(options));

                        // Mock OcrResult for simulation
                        ocrResultMap.put("text", "这是从图片中识别出的文本内容。\nDocument ID: " + documentId + "\nPage: " + page +
                                "\nLanguage: " + options.getLanguage() + "\nConfidence Threshold: " + options.getConfidence());
                        ocrResultMap.put("confidence", 88.5f); // Example confidence value
                        ocrResultMap.put("words", List.of(Map.of("text", "图片", "boundingBox", "1,1,10,10"))); // Example words
                        ocrResultMap.put("lines", List.of(Map.of("text", "这是从图片中识别出的文本内容。", "boundingBox", "1,1,100,10"))); // Example lines

                        metadata.put("engine", "simulated_tesseract"); // Simulated engine name
                        metadata.put("language", options.getLanguage());
                        metadata.put("processingTime", 7500); // Simulated processing time in ms
                        metadata.put("contentType", "image");

                        // Note: OcrResult from service would typically have these fields.
                        // Here we populate them directly for the simulation.

                    } else {
                        // Process as HTML content
                        ocrResultMap.put("text", "这是从HTML内容中提取的文本。\nDocument ID: " + documentId + "\nPage: " + page +
                                "\nOriginal Content Length: " + content.length() + " characters");
                        ocrResultMap.put("confidence", 95.2f); // High confidence for direct text
                        ocrResultMap.put("words", List.of()); // No words if it's HTML text directly
                        ocrResultMap.put("lines", List.of()); // No lines if it's HTML text directly

                        metadata.put("engine", "html_parser"); // Simple parser as engine
                        metadata.put("language", options.getLanguage()); // Keep requested language
                        metadata.put("processingTime", 0); // Instantaneous for HTML
                        metadata.put("contentType", "html");
                    }
                    ocrResultMap.put("metadata", metadata);

                    // Convert the simulated OcrResult data to JSON string
                    String resultJson = objectMapper.writeValueAsString(ocrResultMap);

                    // Update the task to 'completed' status and save the result JSON
                    String completeTaskSql = "UPDATE page_ocr_tasks SET status = 'completed', progress = 100, result_json = ?, completed_at = ?, updated_at = ? WHERE task_id = ?";
                    jdbcTemplate.update(completeTaskSql,
                            resultJson,
                            LocalDateTime.now(), // Completed at
                            LocalDateTime.now(), // Updated at
                            taskId
                    );

                    System.out.println("Page OCR task completed successfully: " + taskId);

                    // --- Save OCR result to the 'document_ocr_results' table ---
                    // This part assumes 'document_ocr_results' table exists and has the specified columns.
                    String ocrResultId = "page_ocr_" + UUID.randomUUID().toString().substring(0, 8); // Unique ID for this specific OCR result
                    String insertOcrResultSql = "INSERT INTO document_ocr_results (ocr_id, document_id, page_number, ocr_text, confidence, metadata_json, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?)";

                    // Extract data for insertion into document_ocr_results
                    String extractedText = (String) ocrResultMap.get("text");
                    Double extractedConfidence = (Double) ocrResultMap.get("confidence");
                    String extractedMetadataJson = objectMapper.writeValueAsString(metadata); // Metadata already prepared

                    jdbcTemplate.update(insertOcrResultSql,
                            ocrResultId,
                            documentId,
                            page,
                            extractedText,
                            extractedConfidence,
                            extractedMetadataJson,
                            LocalDateTime.now(), // Created at
                            LocalDateTime.now()  // Updated at
                    );
                    System.out.println("Successfully saved OCR result to 'document_ocr_results' table for TaskID: " + taskId + ", OCR ID: " + ocrResultId);
                }
            }
        } catch (InterruptedException e) {
            // Handle thread interruption specifically
            Thread.currentThread().interrupt(); // Restore interrupted status
            System.err.println("Page content processing thread was interrupted: " + taskId + " - " + e.getMessage());
            // Update task status to 'failed' due to interruption
            String failTaskSql = "UPDATE page_ocr_tasks SET status = 'failed', error_message = ?, updated_at = ? WHERE task_id = ?";
            jdbcTemplate.update(failTaskSql, "Thread interrupted: " + e.getMessage(), LocalDateTime.now(), taskId);
        } catch (Exception e) {
            // Catch any other exceptions during the processing
            System.err.println("Error during page content processing for TaskID: " + taskId + " - " + e.getMessage());
            e.printStackTrace(); // Log the stack trace for detailed debugging
            // Update task status to 'failed' with the error message
            String failTaskSql = "UPDATE page_ocr_tasks SET status = 'failed', error_message = ?, updated_at = ? WHERE task_id = ?";
            jdbcTemplate.update(failTaskSql, e.getMessage(), LocalDateTime.now(), taskId);
        }
    }

    // Helper method to extract options for OcrProcessingService
    // This is necessary because PageOcrOptions might have fields not directly supported by OcrProcessingService
    // Or OcrProcessingService might expect a different structure for options.
    // Adjust this based on the actual signature and expected options of ocrProcessingService.processBase64Image
    private Map<String, Object> extractOcrServiceOptions(PageOcrOptions pageOptions) {
        Map<String, Object> serviceOptions = new HashMap<>();
        if (pageOptions.getLanguage() != null) {
            serviceOptions.put("language", pageOptions.getLanguage());
        }
        if (pageOptions.getConfidence() != null) {
            serviceOptions.put("confidence", pageOptions.getConfidence());
        }
        if (pageOptions.getPreprocess() != null) {
            serviceOptions.put("preprocess", pageOptions.getPreprocess());
        }
        // Add any other relevant options if needed by the service
        return serviceOptions;
    }
}
--- 结束文件: OcrProcessPage.java ---

--- 开始文件: OcrUpdateResult.java ---
package com.vue.readingapp.ocr;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import com.fasterxml.jackson.databind.ObjectMapper;

@RestController
@RequestMapping("/api/v1/documents")
public class OcrUpdateResult {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();
    private DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd'T'HH:mm:ss");

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到更新OCR结果请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=======================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class UpdateOcrResultRequest {
        private String documentId;
        private Integer page;
        private OcrData ocrData;

        public String getDocumentId() { return documentId; }
        public void setDocumentId(String documentId) { this.documentId = documentId; }

        public Integer getPage() { return page; }
        public void setPage(Integer page) { this.page = page; }

        public OcrData getOcrData() { return ocrData; }
        public void setOcrData(OcrData ocrData) { this.ocrData = ocrData; }
    }

    public static class OcrData {
        private String text;
        private Double confidence;
        private String words;
        private String lines;
        private String metadata;

        public String getText() { return text; }
        public void setText(String text) { this.text = text; }

        public Double getConfidence() { return confidence; }
        public void setConfidence(Double confidence) { this.confidence = confidence; }

        public String getWords() { return words; }
        public void setWords(String words) { this.words = words; }

        public String getLines() { return lines; }
        public void setLines(String lines) { this.lines = lines; }

        public String getMetadata() { return metadata; }
        public void setMetadata(String metadata) { this.metadata = metadata; }
    }

    // 响应DTO
    public static class UpdateOcrResultResponse {
        private boolean success;
        private String message;
        private UpdatedOcrData data;

        public UpdateOcrResultResponse(boolean success, String message, UpdatedOcrData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public UpdatedOcrData getData() { return data; }
        public void setData(UpdatedOcrData data) { this.data = data; }
    }

    public static class UpdatedOcrData {
        private String id;
        private Integer documentId;
        private Integer page;
        private String text;
        private Double confidence;
        private LocalDateTime updatedAt;

        public UpdatedOcrData(String id, Integer documentId, Integer page, String text, Double confidence, LocalDateTime updatedAt) {
            this.id = id;
            this.documentId = documentId;
            this.page = page;
            this.text = text;
            this.confidence = confidence;
            this.updatedAt = updatedAt;
        }

        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public Integer getDocumentId() { return documentId; }
        public void setDocumentId(Integer documentId) { this.documentId = documentId; }

        public Integer getPage() { return page; }
        public void setPage(Integer page) { this.page = page; }

        public String getText() { return text; }
        public void setText(String text) { this.text = text; }

        public Double getConfidence() { return confidence; }
        public void setConfidence(Double confidence) { this.confidence = confidence; }

        public LocalDateTime getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(LocalDateTime updatedAt) { this.updatedAt = updatedAt; }
    }

    @PutMapping("/{documentId}/ocr/{page}")
    public ResponseEntity<UpdateOcrResultResponse> updateOcrResult(
            @PathVariable String documentId,
            @PathVariable Integer page,
            @RequestBody UpdateOcrResultRequest request) {

        // 设置文档ID和页码
        request.setDocumentId(documentId);
        request.setPage(page);

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证请求数据
            if (documentId == null || documentId.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new UpdateOcrResultResponse(false, "文档ID不能为空", null)
                );
            }

            if (page == null || page <= 0) {
                return ResponseEntity.badRequest().body(
                        new UpdateOcrResultResponse(false, "页码必须大于0", null)
                );
            }

            if (request.getOcrData() == null) {
                return ResponseEntity.badRequest().body(
                        new UpdateOcrResultResponse(false, "OCR数据不能为空", null)
                );
            }

            if (request.getOcrData().getText() == null || request.getOcrData().getText().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new UpdateOcrResultResponse(false, "OCR文本不能为空", null)
                );
            }

            // 2. 检查文档是否存在
            String checkDocumentSql = "SELECT COUNT(*) FROM documents WHERE document_id = ?";
            Integer documentCount = jdbcTemplate.queryForObject(checkDocumentSql, Integer.class, documentId);

            if (documentCount == null || documentCount == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new UpdateOcrResultResponse(false, "文档不存在", null)
                );
            }

            // 3. 检查OCR结果表是否存在
            String checkTableSql = "SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'document_ocr_results'";
            Integer tableCount = jdbcTemplate.queryForObject(checkTableSql, Integer.class);

            if (tableCount == null || tableCount == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new UpdateOcrResultResponse(false, "OCR结果表不存在", null)
                );
            }

            // 4. 检查OCR结果是否存在
            String checkOcrSql = "SELECT ocr_id FROM document_ocr_results WHERE document_id = ? AND page_number = ?";
            List<Map<String, Object>> existingOcr = jdbcTemplate.queryForList(checkOcrSql, documentId, page);

            LocalDateTime now = LocalDateTime.now();
            String ocrId;

            if (existingOcr.isEmpty()) {
                // 创建新的OCR结果
                ocrId = "ocr_" + System.currentTimeMillis();
                String insertOcrSql = "INSERT INTO document_ocr_results (ocr_id, document_id, page_number, ocr_text, confidence, words_json, lines_json, metadata_json, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";

                jdbcTemplate.update(insertOcrSql,
                        ocrId,
                        documentId,
                        page,
                        request.getOcrData().getText(),
                        request.getOcrData().getConfidence() != null ? request.getOcrData().getConfidence() : 0.0,
                        request.getOcrData().getWords() != null ? request.getOcrData().getWords() : "[]",
                        request.getOcrData().getLines() != null ? request.getOcrData().getLines() : "[]",
                        request.getOcrData().getMetadata() != null ? request.getOcrData().getMetadata() : "{}",
                        now,
                        now
                );

                System.out.println("创建了新的OCR结果: " + ocrId);
            } else {
                // 更新现有的OCR结果
                ocrId = (String) existingOcr.get(0).get("ocr_id");
                String updateOcrSql = "UPDATE document_ocr_results SET ocr_text = ?, confidence = ?, words_json = ?, lines_json = ?, metadata_json = ?, updated_at = ? WHERE ocr_id = ?";

                jdbcTemplate.update(updateOcrSql,
                        request.getOcrData().getText(),
                        request.getOcrData().getConfidence() != null ? request.getOcrData().getConfidence() : 0.0,
                        request.getOcrData().getWords() != null ? request.getOcrData().getWords() : "[]",
                        request.getOcrData().getLines() != null ? request.getOcrData().getLines() : "[]",
                        request.getOcrData().getMetadata() != null ? request.getOcrData().getMetadata() : "{}",
                        now,
                        ocrId
                );

                System.out.println("更新了OCR结果: " + ocrId);
            }

            // 5. 查询更新后的OCR结果
            String queryOcrSql = "SELECT ocr_id, document_id, page_number, ocr_text, confidence, updated_at FROM document_ocr_results WHERE ocr_id = ?";
            List<Map<String, Object>> updatedOcr = jdbcTemplate.queryForList(queryOcrSql, ocrId);
            printQueryResult(updatedOcr);

            if (updatedOcr.isEmpty()) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new UpdateOcrResultResponse(false, "更新OCR结果失败", null)
                );
            }

            Map<String, Object> ocrResult = updatedOcr.get(0);

            // 6. 准备响应数据（保持LocalDateTime类型）
            UpdatedOcrData responseData = new UpdatedOcrData(
                    (String) ocrResult.get("ocr_id"),
                    (Integer) ocrResult.get("document_id"),
                    (Integer) ocrResult.get("page_number"),
                    (String) ocrResult.get("ocr_text"),
                    ocrResult.get("confidence") != null ? ((Number) ocrResult.get("confidence")).doubleValue() : 0.0,
                    (LocalDateTime) ocrResult.get("updated_at")
            );

            UpdateOcrResultResponse response = new UpdateOcrResultResponse(true, "OCR结果更新成功", responseData);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("更新OCR结果过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdateOcrResultResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: OcrUpdateResult.java ---

--- 开始文件: OcrUpdateSettings.java ---
package com.vue.readingapp.ocr;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.UUID;
import com.fasterxml.jackson.databind.ObjectMapper;

@RestController
@RequestMapping("/api/v1/documents")
public class OcrUpdateSettings {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();
    private DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd'T'HH:mm:ss");

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到更新OCR设置请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=======================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class UpdateOcrSettingsRequest {
        private String documentId;
        private OcrSettings settings;

        public String getDocumentId() { return documentId; }
        public void setDocumentId(String documentId) { this.documentId = documentId; }

        public OcrSettings getSettings() { return settings; }
        public void setSettings(OcrSettings settings) { this.settings = settings; }
    }

    public static class OcrSettings {
        private String defaultLanguage;
        private Integer defaultConfidence;
        private Boolean autoPreprocess;
        private String supportedLanguages; // JSON数组字符串
        private String engine;

        public String getDefaultLanguage() { return defaultLanguage; }
        public void setDefaultLanguage(String defaultLanguage) { this.defaultLanguage = defaultLanguage; }

        public Integer getDefaultConfidence() { return defaultConfidence; }
        public void setDefaultConfidence(Integer defaultConfidence) { this.defaultConfidence = defaultConfidence; }

        public Boolean getAutoPreprocess() { return autoPreprocess; }
        public void setAutoPreprocess(Boolean autoPreprocess) { this.autoPreprocess = autoPreprocess; }

        public String getSupportedLanguages() { return supportedLanguages; }
        public void setSupportedLanguages(String supportedLanguages) { this.supportedLanguages = supportedLanguages; }

        public String getEngine() { return engine; }
        public void setEngine(String engine) { this.engine = engine; }
    }

    // 响应DTO
    public static class UpdateOcrSettingsResponse {
        private boolean success;
        private String message;
        private UpdatedSettingsData data;

        public UpdateOcrSettingsResponse(boolean success, String message, UpdatedSettingsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public UpdatedSettingsData getData() { return data; }
        public void setData(UpdatedSettingsData data) { this.data = data; }
    }

    public static class UpdatedSettingsData {
        private String documentId;
        private OcrSettings settings;
        private String updatedAt;

        public UpdatedSettingsData(String documentId, OcrSettings settings, String updatedAt) {
            this.documentId = documentId;
            this.settings = settings;
            this.updatedAt = updatedAt;
        }

        public String getDocumentId() { return documentId; }
        public void setDocumentId(String documentId) { this.documentId = documentId; }

        public OcrSettings getSettings() { return settings; }
        public void setSettings(OcrSettings settings) { this.settings = settings; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }
    }

    @PutMapping("/{documentId}/ocr/options")
    public ResponseEntity<UpdateOcrSettingsResponse> updateOcrSettings(
            @PathVariable String documentId,
            @RequestBody UpdateOcrSettingsRequest request) {

        // 设置文档ID
        request.setDocumentId(documentId);

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证请求数据
            if (documentId == null || documentId.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new UpdateOcrSettingsResponse(false, "文档ID不能为空", null)
                );
            }

            if (request.getSettings() == null) {
                return ResponseEntity.badRequest().body(
                        new UpdateOcrSettingsResponse(false, "OCR设置不能为空", null)
                );
            }

            // 2. 检查文档是否存在
            String checkDocumentSql = "SELECT COUNT(*) FROM documents WHERE document_id = ?";
            Integer documentCount = jdbcTemplate.queryForObject(checkDocumentSql, Integer.class, documentId);

            if (documentCount == null || documentCount == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new UpdateOcrSettingsResponse(false, "文档不存在", null)
                );
            }

            // 3. 检查OCR设置表是否存在
            String checkTableSql = "SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'document_ocr_settings'";
            Integer tableCount = jdbcTemplate.queryForObject(checkTableSql, Integer.class);

            if (tableCount == null || tableCount == 0) {
                // 创建OCR设置表
                String createTableSql = "CREATE TABLE document_ocr_settings (" +
                        "setting_id VARCHAR(50) PRIMARY KEY," +
                        "document_id VARCHAR(50) NOT NULL," +
                        "default_language VARCHAR(20)," +
                        "default_confidence INT," +
                        "auto_preprocess BOOLEAN," +
                        "supported_languages TEXT," +
                        "engine VARCHAR(50)," +
                        "created_at TIMESTAMP," +
                        "updated_at TIMESTAMP," +
                        "FOREIGN KEY (document_id) REFERENCES documents(document_id) ON DELETE CASCADE" +
                        ")";
                jdbcTemplate.execute(createTableSql);
                System.out.println("已创建 document_ocr_settings 表");
            }

            // 4. 检查是否已存在设置
            String checkSettingsSql = "SELECT setting_id FROM document_ocr_settings WHERE document_id = ?";
            List<Map<String, Object>> existingSettings = jdbcTemplate.queryForList(checkSettingsSql, documentId);

            LocalDateTime now = LocalDateTime.now();
            String settingId;

            if (existingSettings.isEmpty()) {
                // 创建新的设置
                settingId = "setting_" + UUID.randomUUID().toString().substring(0, 8);
                String insertSettingsSql = "INSERT INTO document_ocr_settings (setting_id, document_id, default_language, default_confidence, auto_preprocess, supported_languages, engine, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)";

                jdbcTemplate.update(insertSettingsSql,
                        settingId,
                        documentId,
                        request.getSettings().getDefaultLanguage(),
                        request.getSettings().getDefaultConfidence(),
                        request.getSettings().getAutoPreprocess(),
                        request.getSettings().getSupportedLanguages(),
                        request.getSettings().getEngine(),
                        now,
                        now
                );

                System.out.println("创建了新的OCR设置: " + settingId);
            } else {
                // 更新现有的设置
                settingId = (String) existingSettings.get(0).get("setting_id");
                String updateSettingsSql = "UPDATE document_ocr_settings SET default_language = ?, default_confidence = ?, auto_preprocess = ?, supported_languages = ?, engine = ?, updated_at = ? WHERE setting_id = ?";

                jdbcTemplate.update(updateSettingsSql,
                        request.getSettings().getDefaultLanguage(),
                        request.getSettings().getDefaultConfidence(),
                        request.getSettings().getAutoPreprocess(),
                        request.getSettings().getSupportedLanguages(),
                        request.getSettings().getEngine(),
                        now,
                        settingId
                );

                System.out.println("更新了OCR设置: " + settingId);
            }

            // 5. 查询更新后的设置
            String querySettingsSql = "SELECT document_id, default_language, default_confidence, auto_preprocess, supported_languages, engine, updated_at FROM document_ocr_settings WHERE setting_id = ?";
            List<Map<String, Object>> updatedSettings = jdbcTemplate.queryForList(querySettingsSql, settingId);
            printQueryResult(updatedSettings);

            if (updatedSettings.isEmpty()) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new UpdateOcrSettingsResponse(false, "更新OCR设置失败", null)
                );
            }

            Map<String, Object> settings = updatedSettings.get(0);

            // 6. 准备响应数据
            OcrSettings ocrSettings = new OcrSettings();
            ocrSettings.setDefaultLanguage((String) settings.get("default_language"));
            ocrSettings.setDefaultConfidence(settings.get("default_confidence") != null ? ((Number) settings.get("default_confidence")).intValue() : 70);
            ocrSettings.setAutoPreprocess(settings.get("auto_preprocess") != null ? (Boolean) settings.get("auto_preprocess") : true);
            ocrSettings.setSupportedLanguages((String) settings.get("supported_languages"));
            ocrSettings.setEngine((String) settings.get("engine"));

            UpdatedSettingsData responseData = new UpdatedSettingsData(
                    (String) settings.get("document_id"),
                    ocrSettings,
                    settings.get("updated_at") != null ? ((LocalDateTime) settings.get("updated_at")).format(formatter) : ""
            );

            UpdateOcrSettingsResponse response = new UpdateOcrSettingsResponse(true, "OCR设置更新成功", responseData);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("更新OCR设置过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdateOcrSettingsResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: OcrUpdateSettings.java ---

--- 开始文件: OcrUploadDocument.java ---
package com.vue.readingapp.ocr;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.UUID;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.core.type.TypeReference;

@RestController
@RequestMapping("/api/v1/documents")
public class OcrUploadDocument {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到文档上传OCR请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=======================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class UploadWithOcrRequest {
        private String title;
        private String author;
        private String tags; // JSON字符串，前端传数组
        private String language;
        private String description;
        private boolean autoOCR;
        private String ocrResult; // JSON字符串
        private boolean extractImages;
        private boolean createThumbnails;
        private boolean preserveFormat;
        private String fileContent; // Base64编码的文件内容

        public String getTitle() { return title; }
        public void setTitle(String title) { this.title = title; }

        public String getAuthor() { return author; }
        public void setAuthor(String author) { this.author = author; }

        public String getTags() { return tags; }
        public void setTags(String tags) { this.tags = tags; }

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }

        public boolean isAutoOCR() { return autoOCR; }
        public void setAutoOCR(boolean autoOCR) { this.autoOCR = autoOCR; }

        public String getOcrResult() { return ocrResult; }
        public void setOcrResult(String ocrResult) { this.ocrResult = ocrResult; }

        public boolean isExtractImages() { return extractImages; }
        public void setExtractImages(boolean extractImages) { this.extractImages = extractImages; }

        public boolean isCreateThumbnails() { return createThumbnails; }
        public void setCreateThumbnails(boolean createThumbnails) { this.createThumbnails = createThumbnails; }

        public boolean isPreserveFormat() { return preserveFormat; }
        public void setPreserveFormat(boolean preserveFormat) { this.preserveFormat = preserveFormat; }

        public String getFileContent() { return fileContent; }
        public void setFileContent(String fileContent) { this.fileContent = fileContent; }
    }

    // OCR结果DTO
    public static class OcrResultData {
        private String text;
        private double confidence;
        private String words; // JSON字符串
        private String lines; // JSON字符串
        private String blocks; // JSON字符串
        private String metadata; // JSON字符串

        public String getText() { return text; }
        public void setText(String text) { this.text = text; }

        public double getConfidence() { return confidence; }
        public void setConfidence(double confidence) { this.confidence = confidence; }

        public String getWords() { return words; }
        public void setWords(String words) { this.words = words; }

        public String getLines() { return lines; }
        public void setLines(String lines) { this.lines = lines; }

        public String getBlocks() { return blocks; }
        public void setBlocks(String blocks) { this.blocks = blocks; }

        public String getMetadata() { return metadata; }
        public void setMetadata(String metadata) { this.metadata = metadata; }
    }

    // 响应DTO
    public static class UploadWithOcrResponse {
        private boolean success;
        private String message;
        private UploadData data;

        public UploadWithOcrResponse(boolean success, String message, UploadData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public UploadData getData() { return data; }
        public void setData(UploadData data) { this.data = data; }
    }

    public static class UploadData {
        private String id;
        private String documentId;
        private String title;
        private boolean ocrProcessed;
        private double ocrConfidence;
        private String ocrText;
        private String ocrPages; // JSON字符串
        private String createdAt;
        private String updatedAt;

        public UploadData(String id, String documentId, String title, boolean ocrProcessed,
                          double ocrConfidence, String ocrText, String ocrPages,
                          String createdAt, String updatedAt) {
            this.id = id;
            this.documentId = documentId;
            this.title = title;
            this.ocrProcessed = ocrProcessed;
            this.ocrConfidence = ocrConfidence;
            this.ocrText = ocrText;
            this.ocrPages = ocrPages;
            this.createdAt = createdAt;
            this.updatedAt = updatedAt;
        }

        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getDocumentId() { return documentId; }
        public void setDocumentId(String documentId) { this.documentId = documentId; }

        public String getTitle() { return title; }
        public void setTitle(String title) { this.title = title; }

        public boolean isOcrProcessed() { return ocrProcessed; }
        public void setOcrProcessed(boolean ocrProcessed) { this.ocrProcessed = ocrProcessed; }

        public double getOcrConfidence() { return ocrConfidence; }
        public void setOcrConfidence(double ocrConfidence) { this.ocrConfidence = ocrConfidence; }

        public String getOcrText() { return ocrText; }
        public void setOcrText(String ocrText) { this.ocrText = ocrText; }

        public String getOcrPages() { return ocrPages; }
        public void setOcrPages(String ocrPages) { this.ocrPages = ocrPages; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }
    }

    @PostMapping("/upload-with-ocr")
    public ResponseEntity<UploadWithOcrResponse> uploadWithOcr(@RequestBody UploadWithOcrRequest request) {
        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证请求数据
            if (request.getTitle() == null || request.getTitle().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new UploadWithOcrResponse(false, "文档标题不能为空", null)
                );
            }

            if (request.getFileContent() == null || request.getFileContent().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new UploadWithOcrResponse(false, "文件内容不能为空", null)
                );
            }

            // 2. 生成文档ID和OCR结果ID
            String documentId = "doc_" + UUID.randomUUID().toString().substring(0, 8);
            String ocrResultId = "ocr_" + UUID.randomUUID().toString().substring(0, 8);
            LocalDateTime now = LocalDateTime.now();

            // 3. 解析OCR结果（如果提供了）
            double ocrConfidence = 0.0;
            String ocrText = "";
            String ocrPagesJson = "[]";

            if (request.getOcrResult() != null && !request.getOcrResult().trim().isEmpty()) {
                try {
                    OcrResultData ocrData = objectMapper.readValue(request.getOcrResult(), OcrResultData.class);
                    ocrConfidence = ocrData.getConfidence();
                    ocrText = ocrData.getText();

                    // 创建OCR页面数据
                    List<Map<String, Object>> ocrPages = new ArrayList<>();
                    Map<String, Object> pageData = new HashMap<>();
                    pageData.put("page", 1);
                    pageData.put("text", ocrText);
                    pageData.put("confidence", ocrConfidence);
                    ocrPages.add(pageData);

                    ocrPagesJson = objectMapper.writeValueAsString(ocrPages);

                } catch (Exception e) {
                    System.err.println("解析OCR结果失败: " + e.getMessage());
                    return ResponseEntity.badRequest().body(
                            new UploadWithOcrResponse(false, "OCR结果格式错误", null)
                    );
                }
            }

            // 4. 保存文档到数据库
            String insertDocumentSql = "INSERT INTO documents (document_id, user_id, title, author, language, description, file_path, file_size, file_type, status, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";

            // 假设当前用户ID为1（课设简化处理）
            int userId = 1;
            String filePath = "/uploads/" + documentId + ".pdf"; // 假设文件路径
            long fileSize = request.getFileContent().length();
            String fileType = "application/pdf"; // 假设文件类型

            jdbcTemplate.update(insertDocumentSql,
                    documentId,
                    userId,
                    request.getTitle(),
                    request.getAuthor(),
                    request.getLanguage(),
                    request.getDescription(),
                    filePath,
                    fileSize,
                    fileType,
                    "processed", // 状态
                    now,
                    now
            );

            // 5. 保存OCR结果到数据库（需要创建OCR结果表）
            // 先检查表是否存在，如果不存在则创建
            String checkTableSql = "SELECT COUNT(*) FROM information_schema.tables WHERE table_name = 'document_ocr_results'";
            Integer tableCount = jdbcTemplate.queryForObject(checkTableSql, Integer.class);

            if (tableCount == null || tableCount == 0) {
                // 创建OCR结果表
                String createTableSql = "CREATE TABLE document_ocr_results (" +
                        "ocr_id VARCHAR(50) PRIMARY KEY," +
                        "document_id VARCHAR(50) NOT NULL," +
                        "page_number INT NOT NULL," +
                        "ocr_text TEXT," +
                        "confidence DECIMAL(5,2)," +
                        "words_json TEXT," +
                        "lines_json TEXT," +
                        "blocks_json TEXT," +
                        "metadata_json TEXT," +
                        "created_at TIMESTAMP," +
                        "updated_at TIMESTAMP," +
                        "FOREIGN KEY (document_id) REFERENCES documents(document_id) ON DELETE CASCADE" +
                        ")";
                jdbcTemplate.execute(createTableSql);
                System.out.println("已创建 document_ocr_results 表");
            }

            // 插入OCR结果
            String insertOcrSql = "INSERT INTO document_ocr_results (ocr_id, document_id, page_number, ocr_text, confidence, words_json, lines_json, blocks_json, metadata_json, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";

            OcrResultData ocrData = null;
            if (request.getOcrResult() != null && !request.getOcrResult().trim().isEmpty()) {
                ocrData = objectMapper.readValue(request.getOcrResult(), OcrResultData.class);
            }

            jdbcTemplate.update(insertOcrSql,
                    ocrResultId,
                    documentId,
                    1, // 第一页
                    ocrText,
                    ocrConfidence,
                    ocrData != null ? ocrData.getWords() : "[]",
                    ocrData != null ? ocrData.getLines() : "[]",
                    ocrData != null ? ocrData.getBlocks() : "[]",
                    ocrData != null ? ocrData.getMetadata() : "{}",
                    now,
                    now
            );

            // 6. 保存标签（如果需要）
            if (request.getTags() != null && !request.getTags().trim().isEmpty()) {
                try {
                    List<String> tags = objectMapper.readValue(request.getTags(), new TypeReference<List<String>>() {});

                    for (String tagName : tags) {
                        // 检查标签是否存在
                        String checkTagSql = "SELECT tag_id FROM document_tags WHERE tag_name = ?";
                        List<Map<String, Object>> existingTags = jdbcTemplate.queryForList(checkTagSql, tagName);

                        String tagId;
                        if (existingTags.isEmpty()) {
                            // 创建新标签
                            tagId = "tag_" + UUID.randomUUID().toString().substring(0, 8);
                            String insertTagSql = "INSERT INTO document_tags (tag_id, tag_name, created_at) VALUES (?, ?, ?)";
                            jdbcTemplate.update(insertTagSql, tagId, tagName, now);
                        } else {
                            tagId = (String) existingTags.get(0).get("tag_id");
                        }

                        // 创建文档标签关系
                        String relationId = "rel_" + UUID.randomUUID().toString().substring(0, 8);
                        String insertRelationSql = "INSERT INTO document_tag_relations (relation_id, document_id, tag_id, created_at) VALUES (?, ?, ?, ?)";
                        jdbcTemplate.update(insertRelationSql, relationId, documentId, tagId, now);
                    }
                } catch (Exception e) {
                    System.err.println("保存标签失败: " + e.getMessage());
                    // 不中断流程，继续执行
                }
            }

            // 7. 准备响应数据
            UploadData responseData = new UploadData(
                    ocrResultId,
                    documentId,
                    request.getTitle(),
                    request.getOcrResult() != null && !request.getOcrResult().trim().isEmpty(),
                    ocrConfidence,
                    ocrText,
                    ocrPagesJson,
                    now.toString(),
                    now.toString()
            );

            UploadWithOcrResponse response = new UploadWithOcrResponse(true, "文档上传并OCR处理成功", responseData);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("文档上传OCR处理过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UploadWithOcrResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: OcrUploadDocument.java ---

