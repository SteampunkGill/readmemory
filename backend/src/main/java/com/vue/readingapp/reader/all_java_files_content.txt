--- 开始文件: ReaderAddBookmark.java ---
package com.vue.readingapp.reader;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.*;

@RestController
@RequestMapping("/api/v1/reader")
public class ReaderAddBookmark {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到添加书签请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=====================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class BookmarkRequest {
        private int pageNumber;

        public int getPageNumber() { return pageNumber; }
        public void setPageNumber(int pageNumber) { this.pageNumber = pageNumber; }
    }

    // 响应DTO
    public static class BookmarkResponse {
        private boolean success;
        private String message;
        private BookmarkData data;

        public BookmarkResponse(boolean success, String message, BookmarkData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public BookmarkData getData() { return data; }
        public void setData(BookmarkData data) { this.data = data; }
    }

    public static class BookmarkData {
        private int id;
        private int documentId;
        private int page;
        private String title;
        private String createdAt;

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public int getDocumentId() { return documentId; }
        public void setDocumentId(int documentId) { this.documentId = documentId; }

        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public String getTitle() { return title; }
        public void setTitle(String title) { this.title = title; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }
    }

    @PostMapping("/documents/{documentId}/bookmarks")
    public ResponseEntity<BookmarkResponse> addBookmark(
            @PathVariable("documentId") int documentId,
            @RequestBody BookmarkRequest request,
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        // 打印接收到的请求
        Map<String, Object> requestInfo = new HashMap<>();
        requestInfo.put("documentId", documentId);
        requestInfo.put("request", request);
        requestInfo.put("authHeader", authHeader != null ? "provided" : "missing");
        printRequest(requestInfo);

        try {
            // 1. 验证认证
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new BookmarkResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);

            // 验证token
            String tokenSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, token);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new BookmarkResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) sessions.get(0).get("user_id");

            // 2. 验证文档权限
            String docSql = "SELECT * FROM documents WHERE document_id = ? AND (user_id = ? OR is_public = true)";
            List<Map<String, Object>> documents = jdbcTemplate.queryForList(docSql, documentId, userId);

            if (documents.isEmpty()) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN).body(
                        new BookmarkResponse(false, "没有权限在此文档添加书签", null)
                );
            }

            // 3. 验证请求数据
            if (request.getPageNumber() < 1) {
                return ResponseEntity.badRequest().body(
                        new BookmarkResponse(false, "页码必须大于0", null)
                );
            }

            // 4. 检查页面是否存在
            String pageSql = "SELECT COUNT(*) as page_count FROM document_pages WHERE document_id = ? AND page_number = ?";
            List<Map<String, Object>> pageCounts = jdbcTemplate.queryForList(pageSql, documentId, request.getPageNumber());
            int pageCount = pageCounts.isEmpty() ? 0 : ((Number) pageCounts.get(0).get("page_count")).intValue();

            if (pageCount == 0) {
                return ResponseEntity.badRequest().body(
                        new BookmarkResponse(false, "指定的页面不存在", null)
                );
            }

            // 5. 检查是否已存在书签
            String checkSql = "SELECT COUNT(*) as bookmark_count FROM reading_history " +
                    "WHERE user_id = ? AND document_id = ? AND page = ? AND is_bookmark = true";

            List<Map<String, Object>> bookmarkCounts = jdbcTemplate.queryForList(checkSql, userId, documentId, request.getPageNumber());
            int existingBookmarks = bookmarkCounts.isEmpty() ? 0 : ((Number) bookmarkCounts.get(0).get("bookmark_count")).intValue();

            if (existingBookmarks > 0) {
                return ResponseEntity.status(HttpStatus.CONFLICT).body(
                        new BookmarkResponse(false, "该页已有书签", null)
                );
            }

            // 6. 插入书签记录（使用reading_history表）
            String insertSql = "INSERT INTO reading_history (user_id, document_id, page, is_bookmark, created_at) " +
                    "VALUES (?, ?, ?, true, NOW())";

            jdbcTemplate.update(insertSql, userId, documentId, request.getPageNumber());

            // 7. 获取刚插入的书签ID
            String lastIdSql = "SELECT LAST_INSERT_ID() as history_id";
            List<Map<String, Object>> lastIds = jdbcTemplate.queryForList(lastIdSql);
            int bookmarkId = lastIds.isEmpty() ? 0 : ((Number) lastIds.get(0).get("history_id")).intValue();

            // 8. 获取完整的书签数据
            String bookmarkSql = "SELECT * FROM reading_history WHERE history_id = ?";
            List<Map<String, Object>> bookmarks = jdbcTemplate.queryForList(bookmarkSql, bookmarkId);
            printQueryResult(bookmarks);

            if (bookmarks.isEmpty()) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new BookmarkResponse(false, "创建书签失败", null)
                );
            }

            Map<String, Object> bookmark = bookmarks.get(0);

            // 9. 构建响应数据
            BookmarkData bookmarkData = new BookmarkData();
            bookmarkData.setId(bookmarkId);
            bookmarkData.setDocumentId(documentId);
            bookmarkData.setPage(request.getPageNumber());
            bookmarkData.setTitle("第 " + request.getPageNumber() + " 页");
            bookmarkData.setCreatedAt(bookmark.get("created_at").toString());

            BookmarkResponse response = new BookmarkResponse(true, "书签已添加", bookmarkData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("添加书签过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new BookmarkResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: ReaderAddBookmark.java ---

--- 开始文件: ReaderAddHighlight.java ---
package com.vue.readingapp.reader;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.*;

@RestController
@RequestMapping("/api/v1/reader")
public class ReaderAddHighlight {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到添加高亮请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=====================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class HighlightRequest {
        private String text;
        private int page;
        private Map<String, Object> position;
        private String color;
        private String note;

        public String getText() { return text; }
        public void setText(String text) { this.text = text; }

        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public Map<String, Object> getPosition() { return position; }
        public void setPosition(Map<String, Object> position) { this.position = position; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getNote() { return note; }
        public void setNote(String note) { this.note = note; }
    }

    // 响应DTO
    public static class HighlightResponse {
        private boolean success;
        private String message;
        private HighlightData data;

        public HighlightResponse(boolean success, String message, HighlightData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public HighlightData getData() { return data; }
        public void setData(HighlightData data) { this.data = data; }
    }

    public static class HighlightData {
        private int id;
        private int documentId;
        private String text;
        private int page;
        private Map<String, Object> position;
        private String color;
        private String note;
        private LocalDateTime createdAt;
        private LocalDateTime updatedAt;

        public HighlightData() {
            this.position = new HashMap<>();
        }

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public int getDocumentId() { return documentId; }
        public void setDocumentId(int documentId) { this.documentId = documentId; }

        public String getText() { return text; }
        public void setText(String text) { this.text = text; }

        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public Map<String, Object> getPosition() { return position; }
        public void setPosition(Map<String, Object> position) { this.position = position; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getNote() { return note; }
        public void setNote(String note) { this.note = note; }

        public LocalDateTime getCreatedAt() { return createdAt; }
        public void setCreatedAt(LocalDateTime createdAt) { this.createdAt = createdAt; }

        public LocalDateTime getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(LocalDateTime updatedAt) { this.updatedAt = updatedAt; }
    }

    @PostMapping("/documents/{documentId}/highlights")
    public ResponseEntity<HighlightResponse> addHighlight(
            @PathVariable("documentId") int documentId,
            @RequestBody HighlightRequest request,
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        // 打印接收到的请求
        Map<String, Object> requestInfo = new HashMap<>();
        requestInfo.put("documentId", documentId);
        requestInfo.put("request", request);
        requestInfo.put("authHeader", authHeader != null ? "provided" : "missing");
        printRequest(requestInfo);

        try {
            // 1. 验证认证
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new HighlightResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);

            // 验证token
            String tokenSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, token);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new HighlightResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) sessions.get(0).get("user_id");

            // 2. 验证文档权限
            String docSql = "SELECT * FROM documents WHERE document_id = ? AND (user_id = ? OR is_public = true)";
            List<Map<String, Object>> documents = jdbcTemplate.queryForList(docSql, documentId, userId);

            if (documents.isEmpty()) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN).body(
                        new HighlightResponse(false, "没有权限在此文档添加高亮", null)
                );
            }

            // 3. 验证请求数据
            if (request.getText() == null || request.getText().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new HighlightResponse(false, "高亮文本不能为空", null)
                );
            }

            if (request.getPage() < 1) {
                return ResponseEntity.badRequest().body(
                        new HighlightResponse(false, "页码必须大于0", null)
                );
            }

            // 4. 检查页面是否存在
            String pageSql = "SELECT COUNT(*) as page_count FROM document_pages WHERE document_id = ? AND page_number = ?";
            List<Map<String, Object>> pageCounts = jdbcTemplate.queryForList(pageSql, documentId, request.getPage());
            int pageCount = pageCounts.isEmpty() ? 0 : ((Number) pageCounts.get(0).get("page_count")).intValue();

            if (pageCount == 0) {
                return ResponseEntity.badRequest().body(
                        new HighlightResponse(false, "指定的页面不存在", null)
                );
            }

            // 5. 插入高亮记录
            String insertSql = "INSERT INTO document_highlights (document_id, user_id, text, page, position, color, note, created_at, updated_at) " +
                    "VALUES (?, ?, ?, ?, ?, ?, ?, NOW(), NOW())";

            // 将position map转换为JSON字符串
            String positionJson = "{}";
            if (request.getPosition() != null && !request.getPosition().isEmpty()) {
                try {
                    // 简单处理，实际应该使用JSON库
                    positionJson = request.getPosition().toString();
                } catch (Exception e) {
                    System.err.println("转换position为JSON失败: " + e.getMessage());
                }
            }

            jdbcTemplate.update(insertSql,
                    documentId,
                    userId,
                    request.getText().trim(),
                    request.getPage(),
                    positionJson,
                    request.getColor() != null ? request.getColor() : "yellow",
                    request.getNote() != null ? request.getNote().trim() : null
            );

            // 6. 获取刚插入的高亮ID
            String lastIdSql = "SELECT LAST_INSERT_ID() as highlight_id";
            List<Map<String, Object>> lastIds = jdbcTemplate.queryForList(lastIdSql);
            int highlightId = lastIds.isEmpty() ? 0 : ((Number) lastIds.get(0).get("highlight_id")).intValue();

            // 7. 获取完整的高亮数据
            String highlightSql = "SELECT * FROM document_highlights WHERE highlight_id = ?";
            List<Map<String, Object>> highlights = jdbcTemplate.queryForList(highlightSql, highlightId);
            printQueryResult(highlights);

            if (highlights.isEmpty()) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new HighlightResponse(false, "创建高亮失败", null)
                );
            }

            Map<String, Object> highlight = highlights.get(0);

            // 8. 构建响应数据
            HighlightData highlightData = new HighlightData();
            highlightData.setId(highlightId);
            highlightData.setDocumentId(documentId);
            highlightData.setText((String) highlight.get("text"));
            highlightData.setPage(((Number) highlight.get("page")).intValue());

            // 解析position JSON
            if (highlight.get("position") != null) {
                try {
                    String posStr = (String) highlight.get("position");
                    // 简单处理，实际应该使用JSON解析器
                    if (posStr.startsWith("{") && posStr.endsWith("}")) {
                        Map<String, Object> posMap = new HashMap<>();
                        posMap.put("x", 0);
                        posMap.put("y", 0);
                        posMap.put("width", 100);
                        posMap.put("height", 20);
                        highlightData.setPosition(posMap);
                    }
                } catch (Exception e) {
                    System.err.println("解析position JSON失败: " + e.getMessage());
                }
            }

            highlightData.setColor((String) highlight.get("color"));
            highlightData.setNote((String) highlight.get("note"));
            highlightData.setCreatedAt((LocalDateTime) highlight.get("created_at"));
            highlightData.setUpdatedAt((LocalDateTime) highlight.get("updated_at"));

            HighlightResponse response = new HighlightResponse(true, "高亮已添加", highlightData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("添加高亮过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new HighlightResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: ReaderAddHighlight.java ---

--- 开始文件: ReaderAddNote.java ---
package com.vue.readingapp.reader;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.*;

@RestController
@RequestMapping("/api/v1/reader")
public class ReaderAddNote {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到添加笔记请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=====================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class NoteRequest {
        private String content;
        private int page;
        private Map<String, Object> position;
        private Integer highlightId;

        public String getContent() { return content; }
        public void setContent(String content) { this.content = content; }

        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public Map<String, Object> getPosition() { return position; }
        public void setPosition(Map<String, Object> position) { this.position = position; }

        public Integer getHighlightId() { return highlightId; }
        public void setHighlightId(Integer highlightId) { this.highlightId = highlightId; }
    }

    // 响应DTO
    public static class NoteResponse {
        private boolean success;
        private String message;
        private NoteData data;

        public NoteResponse(boolean success, String message, NoteData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public NoteData getData() { return data; }
        public void setData(NoteData data) { this.data = data; }
    }

    public static class NoteData {
        private int id;
        private int documentId;
        private String content;
        private int page;
        private Map<String, Object> position;
        private Integer highlightId;
        private LocalDateTime createdAt;
        private LocalDateTime updatedAt;

        public NoteData() {
            this.position = new HashMap<>();
        }

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public int getDocumentId() { return documentId; }
        public void setDocumentId(int documentId) { this.documentId = documentId; }

        public String getContent() { return content; }
        public void setContent(String content) { this.content = content; }

        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public Map<String, Object> getPosition() { return position; }
        public void setPosition(Map<String, Object> position) { this.position = position; }

        public Integer getHighlightId() { return highlightId; }
        public void setHighlightId(Integer highlightId) { this.highlightId = highlightId; }

        public LocalDateTime getCreatedAt() { return createdAt; }
        public void setCreatedAt(LocalDateTime createdAt) { this.createdAt = createdAt; }

        public LocalDateTime getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(LocalDateTime updatedAt) { this.updatedAt = updatedAt; }
    }

    @PostMapping("/documents/{documentId}/notes")
    public ResponseEntity<NoteResponse> addNote(
            @PathVariable("documentId") int documentId,
            @RequestBody NoteRequest request,
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        // 打印接收到的请求
        Map<String, Object> requestInfo = new HashMap<>();
        requestInfo.put("documentId", documentId);
        requestInfo.put("request", request);
        requestInfo.put("authHeader", authHeader != null ? "provided" : "missing");
        printRequest(requestInfo);

        try {
            // 1. 验证认证
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new NoteResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);

            // 验证token
            String tokenSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, token);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new NoteResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) sessions.get(0).get("user_id");

            // 2. 验证文档权限
            String docSql = "SELECT * FROM documents WHERE document_id = ? AND (user_id = ? OR is_public = true)";
            List<Map<String, Object>> documents = jdbcTemplate.queryForList(docSql, documentId, userId);

            if (documents.isEmpty()) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN).body(
                        new NoteResponse(false, "没有权限在此文档添加笔记", null)
                );
            }

            // 3. 验证请求数据
            if (request.getContent() == null || request.getContent().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new NoteResponse(false, "笔记内容不能为空", null)
                );
            }

            if (request.getPage() < 1) {
                return ResponseEntity.badRequest().body(
                        new NoteResponse(false, "页码必须大于0", null)
                );
            }

            // 4. 检查页面是否存在
            String pageSql = "SELECT COUNT(*) as page_count FROM document_pages WHERE document_id = ? AND page_number = ?";
            List<Map<String, Object>> pageCounts = jdbcTemplate.queryForList(pageSql, documentId, request.getPage());
            int pageCount = pageCounts.isEmpty() ? 0 : ((Number) pageCounts.get(0).get("page_count")).intValue();

            if (pageCount == 0) {
                return ResponseEntity.badRequest().body(
                        new NoteResponse(false, "指定的页面不存在", null)
                );
            }

            // 5. 如果有关联的高亮，验证高亮是否存在且属于当前用户
            if (request.getHighlightId() != null) {
                String highlightSql = "SELECT * FROM document_highlights WHERE highlight_id = ? AND document_id = ? AND user_id = ?";
                List<Map<String, Object>> highlights = jdbcTemplate.queryForList(highlightSql, request.getHighlightId(), documentId, userId);

                if (highlights.isEmpty()) {
                    return ResponseEntity.badRequest().body(
                            new NoteResponse(false, "关联的高亮不存在或没有权限", null)
                    );
                }
            }

            // 6. 插入笔记记录
            String insertSql = "INSERT INTO document_notes (document_id, user_id, content, page, position, highlight_id, created_at, updated_at) " +
                    "VALUES (?, ?, ?, ?, ?, ?, NOW(), NOW())";

            // 将position map转换为JSON字符串
            String positionJson = "{}";
            if (request.getPosition() != null && !request.getPosition().isEmpty()) {
                try {
                    // 简单处理，实际应该使用JSON库
                    positionJson = request.getPosition().toString();
                } catch (Exception e) {
                    System.err.println("转换position为JSON失败: " + e.getMessage());
                }
            }

            jdbcTemplate.update(insertSql,
                    documentId,
                    userId,
                    request.getContent().trim(),
                    request.getPage(),
                    positionJson,
                    request.getHighlightId()
            );

            // 7. 获取刚插入的笔记ID
            String lastIdSql = "SELECT LAST_INSERT_ID() as note_id";
            List<Map<String, Object>> lastIds = jdbcTemplate.queryForList(lastIdSql);
            int noteId = lastIds.isEmpty() ? 0 : ((Number) lastIds.get(0).get("note_id")).intValue();

            // 8. 获取完整的笔记数据
            String noteSql = "SELECT * FROM document_notes WHERE note_id = ?";
            List<Map<String, Object>> notes = jdbcTemplate.queryForList(noteSql, noteId);
            printQueryResult(notes);

            if (notes.isEmpty()) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new NoteResponse(false, "创建笔记失败", null)
                );
            }

            Map<String, Object> note = notes.get(0);

            // 9. 构建响应数据
            NoteData noteData = new NoteData();
            noteData.setId(noteId);
            noteData.setDocumentId(documentId);
            noteData.setContent((String) note.get("content"));
            noteData.setPage(((Number) note.get("page")).intValue());
            noteData.setHighlightId(note.get("highlight_id") != null ?
                    ((Number) note.get("highlight_id")).intValue() : null);
            noteData.setCreatedAt((LocalDateTime) note.get("created_at"));
            noteData.setUpdatedAt((LocalDateTime) note.get("updated_at"));

            // 解析position JSON
            if (note.get("position") != null) {
                try {
                    String posStr = (String) note.get("position");
                    if (posStr.startsWith("{") && posStr.endsWith("}")) {
                        Map<String, Object> posMap = new HashMap<>();
                        posMap.put("x", 0);
                        posMap.put("y", 0);
                        posMap.put("width", 100);
                        posMap.put("height", 20);
                        noteData.setPosition(posMap);
                    }
                } catch (Exception e) {
                    System.err.println("解析position JSON失败: " + e.getMessage());
                }
            }

            NoteResponse response = new NoteResponse(true, "笔记已添加", noteData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("添加笔记过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new NoteResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: ReaderAddNote.java ---

--- 开始文件: ReaderBatchUpdateHighlights.java ---
package com.vue.readingapp.reader;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;

@RestController
@RequestMapping("/api/v1/reader")
public class ReaderBatchUpdateHighlights {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到批量更新高亮请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class BatchUpdateRequest {
        private List<Integer> highlightIds;
        private String color;
        private String note;

        public List<Integer> getHighlightIds() { return highlightIds; }
        public void setHighlightIds(List<Integer> highlightIds) { this.highlightIds = highlightIds; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getNote() { return note; }
        public void setNote(String note) { this.note = note; }
    }

    // 响应DTO
    public static class BatchUpdateResponse {
        private boolean success;
        private String message;
        private BatchUpdateData data;

        public BatchUpdateResponse(boolean success, String message, BatchUpdateData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public BatchUpdateData getData() { return data; }
        public void setData(BatchUpdateData data) { this.data = data; }
    }

    public static class BatchUpdateData {
        private int updatedCount;
        private List<Integer> updatedIds;
        private String updatedAt;

        public BatchUpdateData() {
            this.updatedIds = new ArrayList<>();
        }

        public int getUpdatedCount() { return updatedCount; }
        public void setUpdatedCount(int updatedCount) { this.updatedCount = updatedCount; }

        public List<Integer> getUpdatedIds() { return updatedIds; }
        public void setUpdatedIds(List<Integer> updatedIds) { this.updatedIds = updatedIds; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }
    }

    @PutMapping("/documents/{documentId}/highlights/batch")
    public ResponseEntity<BatchUpdateResponse> batchUpdateHighlights(
            @PathVariable("documentId") int documentId,
            @RequestBody BatchUpdateRequest request,
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        // 打印接收到的请求
        Map<String, Object> requestInfo = new HashMap<>();
        requestInfo.put("documentId", documentId);
        requestInfo.put("request", request);
        requestInfo.put("authHeader", authHeader != null ? "provided" : "missing");
        printRequest(requestInfo);

        try {
            // 1. 验证认证
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new BatchUpdateResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);

            // 验证token
            String tokenSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, token);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new BatchUpdateResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) sessions.get(0).get("user_id");

            // 2. 验证请求数据
            if (request.getHighlightIds() == null || request.getHighlightIds().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new BatchUpdateResponse(false, "高亮ID列表不能为空", null)
                );
            }

            // 检查是否有更新字段
            if (request.getColor() == null && request.getNote() == null) {
                return ResponseEntity.badRequest().body(
                        new BatchUpdateResponse(false, "没有提供更新数据", null)
                );
            }

            // 3. 构建更新字段
            List<String> updateFields = new ArrayList<>();
            List<Object> updateParams = new ArrayList<>();

            if (request.getColor() != null) {
                updateFields.add("color = ?");
                updateParams.add(request.getColor());
            }

            if (request.getNote() != null) {
                updateFields.add("note = ?");
                updateParams.add(request.getNote().trim());
            }

            // 添加更新时间
            updateFields.add("updated_at = NOW()");

            // 4. 构建IN子句参数
            String placeholders = String.join(",", Collections.nCopies(request.getHighlightIds().size(), "?"));

            // 5. 构建完整SQL
            String updateSql = "UPDATE document_highlights SET " + String.join(", ", updateFields) +
                    " WHERE highlight_id IN (" + placeholders + ") " +
                    " AND document_id = ? AND user_id = ?";

            // 6. 构建参数列表
            List<Object> sqlParams = new ArrayList<>(updateParams);
            sqlParams.addAll(request.getHighlightIds());
            sqlParams.add(documentId);
            sqlParams.add(userId);

            // 7. 执行批量更新
            int updatedRows = jdbcTemplate.update(updateSql, sqlParams.toArray());
            printQueryResult("更新了 " + updatedRows + " 条记录");

            if (updatedRows == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new BatchUpdateResponse(false, "没有找到匹配的高亮记录或没有权限修改", null)
                );
            }

            // 8. 获取更新后的高亮ID列表（验证哪些真的被更新了）
            String checkSql = "SELECT highlight_id FROM document_highlights " +
                    "WHERE highlight_id IN (" + placeholders + ") " +
                    "AND document_id = ? AND user_id = ?";

            List<Object> checkParams = new ArrayList<>(request.getHighlightIds());
            checkParams.add(documentId);
            checkParams.add(userId);

            List<Map<String, Object>> updatedHighlights = jdbcTemplate.queryForList(checkSql, checkParams.toArray());
            List<Integer> actuallyUpdatedIds = new ArrayList<>();

            for (Map<String, Object> row : updatedHighlights) {
                actuallyUpdatedIds.add(((Number) row.get("highlight_id")).intValue());
            }

            // 9. 构建响应数据
            BatchUpdateData batchData = new BatchUpdateData();
            batchData.setUpdatedCount(updatedRows);
            batchData.setUpdatedIds(actuallyUpdatedIds);
            batchData.setUpdatedAt(new Date().toString());

            BatchUpdateResponse response = new BatchUpdateResponse(true, "批量更新高亮成功", batchData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("批量更新高亮过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new BatchUpdateResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: ReaderBatchUpdateHighlights.java ---

--- 开始文件: ReaderClearReadingHistory.java ---

package com.vue.readingapp.reader;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;

@RestController
@RequestMapping("/api/v1/reader")
public class ReaderClearReadingHistory {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到清空阅读历史请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class ClearHistoryResponse {
        private boolean success;
        private String message;
        private ClearData data;

        public ClearHistoryResponse(boolean success, String message, ClearData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public ClearData getData() { return data; }
        public void setData(ClearData data) { this.data = data; }
    }

    public static class ClearData {
        private int clearedCount;
        private String clearedAt;

        public int getClearedCount() { return clearedCount; }
        public void setClearedCount(int clearedCount) { this.clearedCount = clearedCount; }

        public String getClearedAt() { return clearedAt; }
        public void setClearedAt(String clearedAt) { this.clearedAt = clearedAt; }
    }

    @DeleteMapping("/documents/{documentId}/reading-history")
    public ResponseEntity<ClearHistoryResponse> clearReadingHistory(
            @PathVariable("documentId") int documentId,
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        // 打印接收到的请求
        Map<String, Object> requestInfo = new HashMap<>();
        requestInfo.put("documentId", documentId);
        requestInfo.put("authHeader", authHeader != null ? "provided" : "missing");
        printRequest(requestInfo);

        try {
            // 1. 验证认证
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ClearHistoryResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);

            // 验证token
            String tokenSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, token);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ClearHistoryResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) sessions.get(0).get("user_id");

            // 2. 验证文档权限
            String docSql = "SELECT * FROM documents WHERE document_id = ? AND user_id = ?";
            List<Map<String, Object>> documents = jdbcTemplate.queryForList(docSql, documentId, userId);

            if (documents.isEmpty()) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN).body(
                        new ClearHistoryResponse(false, "没有权限清空此文档的阅读历史", null)
                );
            }

            // 3. 获取要删除的记录数
            String countSql = "SELECT COUNT(*) as total FROM reading_history WHERE user_id = ? AND document_id = ?";
            List<Map<String, Object>> counts = jdbcTemplate.queryForList(countSql, userId, documentId);
            int total = counts.isEmpty() ? 0 : ((Number) counts.get(0).get("total")).intValue();

            // 4. 删除阅读历史
            String deleteSql = "DELETE FROM reading_history WHERE user_id = ? AND document_id = ?";
            int deletedRows = jdbcTemplate.update(deleteSql, userId, documentId);

            if (deletedRows == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new ClearHistoryResponse(false, "没有找到阅读历史记录", null)
                );
            }

            // 5. 构建响应数据
            ClearData clearData = new ClearData();
            clearData.setClearedCount(deletedRows);
            clearData.setClearedAt(new Date().toString());

            ClearHistoryResponse response = new ClearHistoryResponse(true, "阅读历史已清空", clearData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("清空阅读历史过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ClearHistoryResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: ReaderClearReadingHistory.java ---

--- 开始文件: ReaderDeleteBookmark.java ---
package com.vue.readingapp.reader;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;

@RestController
@RequestMapping("/api/v1/reader")
public class ReaderDeleteBookmark {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到删除书签请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=====================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class DeleteBookmarkResponse {
        private boolean success;
        private String message;
        private DeleteData data;

        public DeleteBookmarkResponse(boolean success, String message, DeleteData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public DeleteData getData() { return data; }
        public void setData(DeleteData data) { this.data = data; }
    }

    public static class DeleteData {
        private int deletedId;
        private String deletedAt;

        public int getDeletedId() { return deletedId; }
        public void setDeletedId(int deletedId) { this.deletedId = deletedId; }

        public String getDeletedAt() { return deletedAt; }
        public void setDeletedAt(String deletedAt) { this.deletedAt = deletedAt; }
    }

    @DeleteMapping("/documents/{documentId}/bookmarks/{bookmarkId}")
    public ResponseEntity<DeleteBookmarkResponse> deleteBookmark(
            @PathVariable("documentId") int documentId,
            @PathVariable("bookmarkId") int bookmarkId,
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        // 打印接收到的请求
        Map<String, Object> requestInfo = new HashMap<>();
        requestInfo.put("documentId", documentId);
        requestInfo.put("bookmarkId", bookmarkId);
        requestInfo.put("authHeader", authHeader != null ? "provided" : "missing");
        printRequest(requestInfo);

        try {
            // 1. 验证认证
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new DeleteBookmarkResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);

            // 验证token
            String tokenSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, token);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new DeleteBookmarkResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) sessions.get(0).get("user_id");

            // 2. 验证书签是否存在且属于当前用户
            String bookmarkSql = "SELECT * FROM reading_history WHERE history_id = ? AND document_id = ? AND user_id = ? AND is_bookmark = true";
            List<Map<String, Object>> bookmarks = jdbcTemplate.queryForList(bookmarkSql, bookmarkId, documentId, userId);

            if (bookmarks.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new DeleteBookmarkResponse(false, "书签不存在或没有权限删除", null)
                );
            }

            // 3. 获取书签信息（用于返回）
            Map<String, Object> bookmark = bookmarks.get(0);

            // 4. 删除书签
            String deleteSql = "DELETE FROM reading_history WHERE history_id = ? AND document_id = ? AND user_id = ?";
            int deletedRows = jdbcTemplate.update(deleteSql, bookmarkId, documentId, userId);

            if (deletedRows == 0) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new DeleteBookmarkResponse(false, "删除书签失败", null)
                );
            }

            // 5. 构建响应数据
            DeleteData deleteData = new DeleteData();
            deleteData.setDeletedId(bookmarkId);
            deleteData.setDeletedAt(new Date().toString());

            DeleteBookmarkResponse response = new DeleteBookmarkResponse(true, "书签已删除", deleteData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("删除书签过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new DeleteBookmarkResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: ReaderDeleteBookmark.java ---

--- 开始文件: ReaderDeleteHighlight.java ---
package com.vue.readingapp.reader;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;

@RestController
@RequestMapping("/api/v1/reader")
public class ReaderDeleteHighlight {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到删除高亮请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=====================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class DeleteHighlightResponse {
        private boolean success;
        private String message;
        private DeleteData data;

        public DeleteHighlightResponse(boolean success, String message, DeleteData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public DeleteData getData() { return data; }
        public void setData(DeleteData data) { this.data = data; }
    }

    public static class DeleteData {
        private int deletedId;
        private String deletedAt;

        public int getDeletedId() { return deletedId; }
        public void setDeletedId(int deletedId) { this.deletedId = deletedId; }

        public String getDeletedAt() { return deletedAt; }
        public void setDeletedAt(String deletedAt) { this.deletedAt = deletedAt; }
    }

    @DeleteMapping("/documents/{documentId}/highlights/{highlightId}")
    public ResponseEntity<DeleteHighlightResponse> deleteHighlight(
            @PathVariable("documentId") int documentId,
            @PathVariable("highlightId") int highlightId,
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        // 打印接收到的请求
        Map<String, Object> requestInfo = new HashMap<>();
        requestInfo.put("documentId", documentId);
        requestInfo.put("highlightId", highlightId);
        requestInfo.put("authHeader", authHeader != null ? "provided" : "missing");
        printRequest(requestInfo);

        try {
            // 1. 验证认证
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new DeleteHighlightResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);

            // 验证token
            String tokenSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, token);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new DeleteHighlightResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) sessions.get(0).get("user_id");

            // 2. 验证高亮是否存在且属于当前用户
            String highlightSql = "SELECT * FROM document_highlights WHERE highlight_id = ? AND document_id = ? AND user_id = ?";
            List<Map<String, Object>> highlights = jdbcTemplate.queryForList(highlightSql, highlightId, documentId, userId);

            if (highlights.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new DeleteHighlightResponse(false, "高亮不存在或没有权限删除", null)
                );
            }

            // 3. 先获取高亮信息（用于返回）
            Map<String, Object> highlight = highlights.get(0);

            // 4. 删除关联的笔记（如果有外键约束会自动级联删除，这里显式删除）
            String deleteNotesSql = "DELETE FROM document_notes WHERE highlight_id = ? AND user_id = ?";
            jdbcTemplate.update(deleteNotesSql, highlightId, userId);

            // 5. 删除高亮
            String deleteSql = "DELETE FROM document_highlights WHERE highlight_id = ? AND document_id = ? AND user_id = ?";
            int deletedRows = jdbcTemplate.update(deleteSql, highlightId, documentId, userId);

            if (deletedRows == 0) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new DeleteHighlightResponse(false, "删除高亮失败", null)
                );
            }

            // 6. 构建响应数据
            DeleteData deleteData = new DeleteData();
            deleteData.setDeletedId(highlightId);
            deleteData.setDeletedAt(new Date().toString());

            DeleteHighlightResponse response = new DeleteHighlightResponse(true, "高亮已删除", deleteData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("删除高亮过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new DeleteHighlightResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: ReaderDeleteHighlight.java ---

--- 开始文件: ReaderDeleteNote.java ---
package com.vue.readingapp.reader;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;

@RestController
@RequestMapping("/api/v1/reader")
public class ReaderDeleteNote {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到删除笔记请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=====================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class DeleteNoteResponse {
        private boolean success;
        private String message;
        private DeleteData data;

        public DeleteNoteResponse(boolean success, String message, DeleteData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public DeleteData getData() { return data; }
        public void setData(DeleteData data) { this.data = data; }
    }

    public static class DeleteData {
        private int deletedId;
        private String deletedAt;

        public int getDeletedId() { return deletedId; }
        public void setDeletedId(int deletedId) { this.deletedId = deletedId; }

        public String getDeletedAt() { return deletedAt; }
        public void setDeletedAt(String deletedAt) { this.deletedAt = deletedAt; }
    }

    @DeleteMapping("/documents/{documentId}/notes/{noteId}")
    public ResponseEntity<DeleteNoteResponse> deleteNote(
            @PathVariable("documentId") int documentId,
            @PathVariable("noteId") int noteId,
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        // 打印接收到的请求
        Map<String, Object> requestInfo = new HashMap<>();
        requestInfo.put("documentId", documentId);
        requestInfo.put("noteId", noteId);
        requestInfo.put("authHeader", authHeader != null ? "provided" : "missing");
        printRequest(requestInfo);

        try {
            // 1. 验证认证
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new DeleteNoteResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);

            // 验证token
            String tokenSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, token);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new DeleteNoteResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) sessions.get(0).get("user_id");

            // 2. 验证笔记是否存在且属于当前用户
            String noteSql = "SELECT * FROM document_notes WHERE note_id = ? AND document_id = ? AND user_id = ?";
            List<Map<String, Object>> notes = jdbcTemplate.queryForList(noteSql, noteId, documentId, userId);

            if (notes.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new DeleteNoteResponse(false, "笔记不存在或没有权限删除", null)
                );
            }

            // 3. 获取笔记信息（用于返回）
            Map<String, Object> note = notes.get(0);

            // 4. 删除笔记
            String deleteSql = "DELETE FROM document_notes WHERE note_id = ? AND document_id = ? AND user_id = ?";
            int deletedRows = jdbcTemplate.update(deleteSql, noteId, documentId, userId);

            if (deletedRows == 0) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new DeleteNoteResponse(false, "删除笔记失败", null)
                );
            }

            // 5. 构建响应数据
            DeleteData deleteData = new DeleteData();
            deleteData.setDeletedId(noteId);
            deleteData.setDeletedAt(new Date().toString());

            DeleteNoteResponse response = new DeleteNoteResponse(true, "笔记已删除", deleteData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("删除笔记过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new DeleteNoteResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: ReaderDeleteNote.java ---

--- 开始文件: ReaderGetBookmarks.java ---
package com.vue.readingapp.reader;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;

@RestController
@RequestMapping("/api/v1/reader")
public class ReaderGetBookmarks {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取书签列表请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class BookmarksResponse {
        private boolean success;
        private String message;
        private BookmarksData data;

        public BookmarksResponse(boolean success, String message, BookmarksData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public BookmarksData getData() { return data; }
        public void setData(BookmarksData data) { this.data = data; }
    }

    public static class BookmarksData {
        private List<BookmarkItem> bookmarks;
        private PaginationInfo pagination;

        public BookmarksData() {
            this.bookmarks = new ArrayList<>();
            this.pagination = new PaginationInfo();
        }

        public List<BookmarkItem> getBookmarks() { return bookmarks; }
        public void setBookmarks(List<BookmarkItem> bookmarks) { this.bookmarks = bookmarks; }

        public PaginationInfo getPagination() { return pagination; }
        public void setPagination(PaginationInfo pagination) { this.pagination = pagination; }
    }

    public static class BookmarkItem {
        private int id;
        private int documentId;
        private int page;
        private String title;
        private String createdAt;
        private DocumentInfo document;

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public int getDocumentId() { return documentId; }
        public void setDocumentId(int documentId) { this.documentId = documentId; }

        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public String getTitle() { return title; }
        public void setTitle(String title) { this.title = title; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public DocumentInfo getDocument() { return document; }
        public void setDocument(DocumentInfo document) { this.document = document; }
    }

    public static class DocumentInfo {
        private int id;
        private String title;
        private String author;
        private String language;

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public String getTitle() { return title; }
        public void setTitle(String title) { this.title = title; }

        public String getAuthor() { return author; }
        public void setAuthor(String author) { this.author = author; }

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }
    }

    public static class PaginationInfo {
        private int page;
        private int pageSize;
        private int total;
        private int totalPages;

        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public int getPageSize() { return pageSize; }
        public void setPageSize(int pageSize) { this.pageSize = pageSize; }

        public int getTotal() { return total; }
        public void setTotal(int total) { this.total = total; }

        public int getTotalPages() { return totalPages; }
        public void setTotalPages(int totalPages) { this.totalPages = totalPages; }
    }

    @GetMapping("/documents/{documentId}/bookmarks")
    public ResponseEntity<BookmarksResponse> getBookmarks(
            @PathVariable("documentId") int documentId,
            @RequestParam(value = "page", defaultValue = "1") int page,
            @RequestParam(value = "pageSize", defaultValue = "20") int pageSize,
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        // 打印接收到的请求
        Map<String, Object> requestInfo = new HashMap<>();
        requestInfo.put("documentId", documentId);
        requestInfo.put("page", page);
        requestInfo.put("pageSize", pageSize);
        requestInfo.put("authHeader", authHeader != null ? "provided" : "missing");
        printRequest(requestInfo);

        try {
            // 1. 验证认证
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new BookmarksResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);

            // 验证token
            String tokenSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, token);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new BookmarksResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) sessions.get(0).get("user_id");

            // 2. 验证文档权限
            String docSql = "SELECT * FROM documents WHERE document_id = ? AND (user_id = ? OR is_public = true)";
            List<Map<String, Object>> documents = jdbcTemplate.queryForList(docSql, documentId, userId);

            if (documents.isEmpty()) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN).body(
                        new BookmarksResponse(false, "没有权限查看此文档的书签", null)
                );
            }

            // 3. 获取书签总数
            String countSql = "SELECT COUNT(*) as total FROM reading_history " +
                    "WHERE user_id = ? AND document_id = ? AND is_bookmark = true";

            List<Map<String, Object>> counts = jdbcTemplate.queryForList(countSql, userId, documentId);
            int total = counts.isEmpty() ? 0 : ((Number) counts.get(0).get("total")).intValue();

            // 4. 计算分页
            int totalPages = (int) Math.ceil((double) total / pageSize);
            int offset = (page - 1) * pageSize;

            // 5. 获取书签列表
            String querySql = "SELECT rh.*, d.title as document_title, d.author, d.language " +
                    "FROM reading_history rh " +
                    "JOIN documents d ON rh.document_id = d.document_id " +
                    "WHERE rh.user_id = ? AND rh.document_id = ? AND rh.is_bookmark = true " +
                    "ORDER BY rh.created_at DESC LIMIT ? OFFSET ?";

            List<Map<String, Object>> bookmarks = jdbcTemplate.queryForList(querySql, userId, documentId, pageSize, offset);
            printQueryResult(bookmarks);

            // 6. 构建响应数据
            BookmarksData bookmarksData = new BookmarksData();

            for (Map<String, Object> bookmark : bookmarks) {
                BookmarkItem item = new BookmarkItem();
                item.setId(((Number) bookmark.get("history_id")).intValue());
                item.setDocumentId(documentId);
                item.setPage(((Number) bookmark.get("page")).intValue());
                item.setTitle("第 " + bookmark.get("page") + " 页");
                item.setCreatedAt(bookmark.get("created_at").toString());

                // 设置文档信息
                DocumentInfo docInfo = new DocumentInfo();
                docInfo.setId(documentId);
                docInfo.setTitle((String) bookmark.get("document_title"));
                docInfo.setAuthor((String) bookmark.get("author"));
                docInfo.setLanguage((String) bookmark.get("language"));
                item.setDocument(docInfo);

                bookmarksData.getBookmarks().add(item);
            }

            // 设置分页信息
            PaginationInfo pagination = new PaginationInfo();
            pagination.setPage(page);
            pagination.setPageSize(pageSize);
            pagination.setTotal(total);
            pagination.setTotalPages(totalPages);
            bookmarksData.setPagination(pagination);

            BookmarksResponse response = new BookmarksResponse(true, "获取书签列表成功", bookmarksData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取书签列表过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new BookmarksResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: ReaderGetBookmarks.java ---

--- 开始文件: ReaderGetDocumentOutline.java ---
package com.vue.readingapp.reader;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;

@RestController
@RequestMapping("/api/v1/reader")
public class ReaderGetDocumentOutline {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取文档目录请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class OutlineResponse {
        private boolean success;
        private String message;
        private OutlineData data;

        public OutlineResponse(boolean success, String message, OutlineData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public OutlineData getData() { return data; }
        public void setData(OutlineData data) { this.data = data; }
    }

    public static class OutlineData {
        private List<OutlineItem> outline;

        public OutlineData() {
            this.outline = new ArrayList<>();
        }

        public List<OutlineItem> getOutline() { return outline; }
        public void setOutline(List<OutlineItem> outline) { this.outline = outline; }
    }

    public static class OutlineItem {
        private int level;
        private String title;
        private int page;
        private List<OutlineItem> children;

        public OutlineItem() {
            this.children = new ArrayList<>();
        }

        public int getLevel() { return level; }
        public void setLevel(int level) { this.level = level; }

        public String getTitle() { return title; }
        public void setTitle(String title) { this.title = title; }

        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public List<OutlineItem> getChildren() { return children; }
        public void setChildren(List<OutlineItem> children) { this.children = children; }
    }

    @GetMapping("/documents/{documentId}/outline")
    public ResponseEntity<OutlineResponse> getDocumentOutline(
            @PathVariable("documentId") int documentId,
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        // 打印接收到的请求
        Map<String, Object> requestInfo = new HashMap<>();
        requestInfo.put("documentId", documentId);
        requestInfo.put("authHeader", authHeader != null ? "provided" : "missing");
        printRequest(requestInfo);

        try {
            // 1. 验证认证
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new OutlineResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);

            // 验证token
            String tokenSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, token);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new OutlineResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) sessions.get(0).get("user_id");

            // 2. 验证文档权限
            String docSql = "SELECT * FROM documents WHERE document_id = ? AND (user_id = ? OR is_public = true)";
            List<Map<String, Object>> documents = jdbcTemplate.queryForList(docSql, documentId, userId);

            if (documents.isEmpty()) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN).body(
                        new OutlineResponse(false, "没有权限查看此文档的目录", null)
                );
            }

            // 3. 获取文档的目录信息
            // 在实际项目中，目录信息可能存储在单独的表中，或者从文档内容中解析
            // 这里我们假设有一个document_outlines表，或者从document_pages表中提取标题

            // 方法1：如果存在document_outlines表
            String outlineSql = "SELECT * FROM document_outlines WHERE document_id = ? ORDER BY order_index";
            List<Map<String, Object>> outlines = new ArrayList<>();

            try {
                outlines = jdbcTemplate.queryForList(outlineSql, documentId);
            } catch (Exception e) {
                System.out.println("document_outlines表不存在，尝试从document_pages提取");
                // 方法2：从document_pages表中提取第一行作为标题
                String pageSql = "SELECT page_number, SUBSTRING(content, 1, 100) as preview FROM document_pages WHERE document_id = ? ORDER BY page_number";
                outlines = jdbcTemplate.queryForList(pageSql, documentId);
            }

            printQueryResult(outlines);

            // 4. 构建目录结构
            List<OutlineItem> outlineItems = new ArrayList<>();

            for (Map<String, Object> outline : outlines) {
                OutlineItem item = new OutlineItem();

                // 设置级别（默认为1）
                item.setLevel(outline.get("level") != null ?
                        ((Number) outline.get("level")).intValue() : 1);

                // 设置标题
                if (outline.get("title") != null) {
                    item.setTitle((String) outline.get("title"));
                } else if (outline.get("preview") != null) {
                    String preview = (String) outline.get("preview");
                    // 取前30个字符作为标题
                    item.setTitle(preview.length() > 30 ? preview.substring(0, 30) + "..." : preview);
                } else {
                    item.setTitle("未命名章节");
                }

                // 设置页码
                if (outline.get("page_number") != null) {
                    item.setPage(((Number) outline.get("page_number")).intValue());
                } else if (outline.get("page") != null) {
                    item.setPage(((Number) outline.get("page")).intValue());
                } else {
                    item.setPage(1);
                }

                outlineItems.add(item);
            }

            // 5. 构建层次结构（这里简化处理，实际应该根据level字段构建树形结构）
            // 假设只有一级标题
            List<OutlineItem> rootItems = new ArrayList<>();
            for (OutlineItem item : outlineItems) {
                if (item.getLevel() == 1) {
                    rootItems.add(item);
                } else {
                    // 如果不是一级标题，添加到最后一个一级标题的子项中
                    if (!rootItems.isEmpty()) {
                        OutlineItem lastRoot = rootItems.get(rootItems.size() - 1);
                        lastRoot.getChildren().add(item);
                    } else {
                        // 如果没有一级标题，将其作为一级标题
                        item.setLevel(1);
                        rootItems.add(item);
                    }
                }
            }

            // 6. 构建响应数据
            OutlineData outlineData = new OutlineData();
            outlineData.setOutline(rootItems);

            OutlineResponse response = new OutlineResponse(true, "获取文档目录成功", outlineData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取文档目录过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new OutlineResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: ReaderGetDocumentOutline.java ---

--- 开始文件: ReaderGetDocumentPage.java ---

package com.vue.readingapp.reader;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.*;

@RestController
@RequestMapping("/api/v1/reader")
public class ReaderGetDocumentPage {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取文档页面请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=======================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class PageResponse {
        private boolean success;
        private String message;
        private PageData data;

        public PageResponse(boolean success, String message, PageData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public PageData getData() { return data; }
        public void setData(PageData data) { this.data = data; }
    }

    public static class PageData {
        private String id;
        private int documentId;
        private int pageNumber;
        private String content;
        private String htmlContent;
        private int wordCount;
        private int characterCount;
        private boolean hasImages;
        private List<Map<String, Object>> images;
        private List<Map<String, Object>> highlights;
        private List<Map<String, Object>> notes;
        private Map<String, Object> metadata;
        private Integer nextPage;
        private Integer prevPage;

        public PageData() {
            this.images = new ArrayList<>();
            this.highlights = new ArrayList<>();
            this.notes = new ArrayList<>();
            this.metadata = new HashMap<>();
        }

        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public int getDocumentId() { return documentId; }
        public void setDocumentId(int documentId) { this.documentId = documentId; }

        public int getPageNumber() { return pageNumber; }
        public void setPageNumber(int pageNumber) { this.pageNumber = pageNumber; }

        public String getContent() { return content; }
        public void setContent(String content) { this.content = content; }

        public String getHtmlContent() { return htmlContent; }
        public void setHtmlContent(String htmlContent) { this.htmlContent = htmlContent; }

        public int getWordCount() { return wordCount; }
        public void setWordCount(int wordCount) { this.wordCount = wordCount; }

        public int getCharacterCount() { return characterCount; }
        public void setCharacterCount(int characterCount) { this.characterCount = characterCount; }

        public boolean isHasImages() { return hasImages; }
        public void setHasImages(boolean hasImages) { this.hasImages = hasImages; }

        public List<Map<String, Object>> getImages() { return images; }
        public void setImages(List<Map<String, Object>> images) { this.images = images; }

        public List<Map<String, Object>> getHighlights() { return highlights; }
        public void setHighlights(List<Map<String, Object>> highlights) { this.highlights = highlights; }

        public List<Map<String, Object>> getNotes() { return notes; }
        public void setNotes(List<Map<String, Object>> notes) { this.notes = notes; }

        public Map<String, Object> getMetadata() { return metadata; }
        public void setMetadata(Map<String, Object> metadata) { this.metadata = metadata; }

        public Integer getNextPage() { return nextPage; }
        public void setNextPage(Integer nextPage) { this.nextPage = nextPage; }

        public Integer getPrevPage() { return prevPage; }
        public void setPrevPage(Integer prevPage) { this.prevPage = prevPage; }
    }

    @GetMapping("/documents/{documentId}/pages/{pageNumber}")
    public ResponseEntity<PageResponse> getDocumentPage(
            @PathVariable("documentId") int documentId,
            @PathVariable("pageNumber") int pageNumber,
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        // 打印接收到的请求
        Map<String, Object> requestInfo = new HashMap<>();
        requestInfo.put("documentId", documentId);
        requestInfo.put("pageNumber", pageNumber);
        requestInfo.put("authHeader", authHeader != null ? "provided" : "missing");
        printRequest(requestInfo);

        try {
            // 1. 验证认证
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new PageResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);

            // 验证token
            String tokenSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, token);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new PageResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) sessions.get(0).get("user_id");

            // 2. 验证文档权限
            String docSql = "SELECT d.*, dp.total_pages FROM documents d " +
                    "LEFT JOIN (SELECT document_id, COUNT(*) as total_pages FROM document_pages GROUP BY document_id) dp " +
                    "ON d.document_id = dp.document_id " +
                    "WHERE d.document_id = ? AND (d.user_id = ? OR d.is_public = true)";

            List<Map<String, Object>> documents = jdbcTemplate.queryForList(docSql, documentId, userId);
            printQueryResult(documents);

            if (documents.isEmpty()) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN).body(
                        new PageResponse(false, "没有权限查看此文档", null)
                );
            }

            Map<String, Object> document = documents.get(0);
            Integer totalPages = document.get("total_pages") != null ?
                    ((Number) document.get("total_pages")).intValue() : 0;

            // 3. 获取页面内容
            String pageSql = "SELECT * FROM document_pages WHERE document_id = ? AND page_number = ?";
            List<Map<String, Object>> pages = jdbcTemplate.queryForList(pageSql, documentId, pageNumber);

            if (pages.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new PageResponse(false, "页面不存在", null)
                );
            }

            Map<String, Object> page = pages.get(0);

            // 4. 获取该页面的高亮
            String highlightSql = "SELECT * FROM document_highlights WHERE document_id = ? AND page = ? AND user_id = ?";
            List<Map<String, Object>> highlights = jdbcTemplate.queryForList(highlightSql, documentId, pageNumber, userId);

            // 5. 获取该页面的笔记
            String noteSql = "SELECT * FROM document_notes WHERE document_id = ? AND page = ? AND user_id = ?";
            List<Map<String, Object>> notes = jdbcTemplate.queryForList(noteSql, documentId, pageNumber, userId);

            // 6. 构建响应数据
            PageData pageData = new PageData();
            pageData.setId("page_" + documentId + "_" + pageNumber);
            pageData.setDocumentId(documentId);
            pageData.setPageNumber(pageNumber);
            pageData.setContent((String) page.get("content"));
            pageData.setHtmlContent((String) page.get("html_content"));
            pageData.setWordCount(page.get("word_count") != null ? ((Number) page.get("word_count")).intValue() : 0);
            pageData.setCharacterCount(page.get("character_count") != null ? ((Number) page.get("character_count")).intValue() : 0);
            pageData.setHasImages(page.get("has_images") != null && (boolean) page.get("has_images"));

            // 设置图片
            if (page.get("images") != null) {
                try {
                    String imagesJson = (String) page.get("images");
                    // 简单处理，实际应该解析JSON
                    if (imagesJson.startsWith("[") && imagesJson.endsWith("]")) {
                        // 这里简化处理，实际应该使用JSON解析器
                        Map<String, Object> image = new HashMap<>();
                        image.put("url", "default_image.jpg");
                        image.put("alt", "文档图片");
                        pageData.getImages().add(image);
                    }
                } catch (Exception e) {
                    System.err.println("解析图片数据失败: " + e.getMessage());
                }
            }

            // 设置高亮
            for (Map<String, Object> highlight : highlights) {
                Map<String, Object> hl = new HashMap<>();
                hl.put("id", highlight.get("highlight_id"));
                hl.put("documentId", highlight.get("document_id"));
                hl.put("text", highlight.get("text"));
                hl.put("page", highlight.get("page"));
                hl.put("color", highlight.get("color"));
                hl.put("note", highlight.get("note"));
                hl.put("createdAt", highlight.get("created_at"));
                hl.put("updatedAt", highlight.get("updated_at"));
                pageData.getHighlights().add(hl);
            }

            // 设置笔记
            for (Map<String, Object> note : notes) {
                Map<String, Object> nt = new HashMap<>();
                nt.put("id", note.get("note_id"));
                nt.put("documentId", note.get("document_id"));
                nt.put("content", note.get("content"));
                nt.put("page", note.get("page"));
                nt.put("highlightId", note.get("highlight_id"));
                nt.put("createdAt", note.get("created_at"));
                nt.put("updatedAt", note.get("updated_at"));
                pageData.getNotes().add(nt);
            }

            // 设置元数据
            pageData.getMetadata().put("title", document.get("title"));
            pageData.getMetadata().put("author", document.get("author"));
            pageData.getMetadata().put("language", document.get("language"));

            // 设置上下页
            if (pageNumber < totalPages) {
                pageData.setNextPage(pageNumber + 1);
            }
            if (pageNumber > 1) {
                pageData.setPrevPage(pageNumber - 1);
            }

            // 7. 记录阅读历史
            String historySql = "INSERT INTO reading_history (user_id, document_id, page, start_time) VALUES (?, ?, ?, NOW()) " +
                    "ON DUPLICATE KEY UPDATE page = ?, start_time = NOW()";
            jdbcTemplate.update(historySql, userId, documentId, pageNumber, pageNumber);

            // 8. 准备响应
            PageResponse response = new PageResponse(true, "获取页面成功", pageData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取文档页面过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new PageResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: ReaderGetDocumentPage.java ---

--- 开始文件: ReaderGetHighlightById.java ---

package com.vue.readingapp.reader;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;

@RestController
@RequestMapping("/api/v1/reader")
public class ReaderGetHighlightById {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取高亮详情请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class HighlightDetailResponse {
        private boolean success;
        private String message;
        private HighlightDetailData data;

        public HighlightDetailResponse(boolean success, String message, HighlightDetailData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public HighlightDetailData getData() { return data; }
        public void setData(HighlightDetailData data) { this.data = data; }
    }

    public static class HighlightDetailData {
        private int id;
        private int documentId;
        private String text;
        private int page;
        private Map<String, Object> position;
        private String color;
        private String note;
        private String createdAt;
        private String updatedAt;
        private DocumentInfo document;
        private List<NoteInfo> notes;

        public HighlightDetailData() {
            this.position = new HashMap<>();
            this.notes = new ArrayList<>();
        }

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public int getDocumentId() { return documentId; }
        public void setDocumentId(int documentId) { this.documentId = documentId; }

        public String getText() { return text; }
        public void setText(String text) { this.text = text; }

        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public Map<String, Object> getPosition() { return position; }
        public void setPosition(Map<String, Object> position) { this.position = position; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getNote() { return note; }
        public void setNote(String note) { this.note = note; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }

        public DocumentInfo getDocument() { return document; }
        public void setDocument(DocumentInfo document) { this.document = document; }

        public List<NoteInfo> getNotes() { return notes; }
        public void setNotes(List<NoteInfo> notes) { this.notes = notes; }
    }

    public static class DocumentInfo {
        private int id;
        private String title;
        private String author;
        private String language;

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public String getTitle() { return title; }
        public void setTitle(String title) { this.title = title; }

        public String getAuthor() { return author; }
        public void setAuthor(String author) { this.author = author; }

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }
    }

    public static class NoteInfo {
        private int id;
        private String content;
        private String createdAt;
        private String updatedAt;

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public String getContent() { return content; }
        public void setContent(String content) { this.content = content; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }
    }

    @GetMapping("/documents/{documentId}/highlights/{highlightId}")
    public ResponseEntity<HighlightDetailResponse> getHighlightById(
            @PathVariable("documentId") int documentId,
            @PathVariable("highlightId") int highlightId,
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        // 打印接收到的请求
        Map<String, Object> requestInfo = new HashMap<>();
        requestInfo.put("documentId", documentId);
        requestInfo.put("highlightId", highlightId);
        requestInfo.put("authHeader", authHeader != null ? "provided" : "missing");
        printRequest(requestInfo);

        try {
            // 1. 验证认证
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new HighlightDetailResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);

            // 验证token
            String tokenSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, token);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new HighlightDetailResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) sessions.get(0).get("user_id");

            // 2. 验证文档权限
            String docSql = "SELECT * FROM documents WHERE document_id = ? AND (user_id = ? OR is_public = true)";
            List<Map<String, Object>> documents = jdbcTemplate.queryForList(docSql, documentId, userId);

            if (documents.isEmpty()) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN).body(
                        new HighlightDetailResponse(false, "没有权限查看此文档的高亮", null)
                );
            }

            // 3. 获取高亮详情
            String highlightSql = "SELECT * FROM document_highlights WHERE highlight_id = ? AND document_id = ? AND user_id = ?";
            List<Map<String, Object>> highlights = jdbcTemplate.queryForList(highlightSql, highlightId, documentId, userId);
            printQueryResult(highlights);

            if (highlights.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new HighlightDetailResponse(false, "高亮不存在", null)
                );
            }

            Map<String, Object> highlight = highlights.get(0);

            // 4. 获取文档信息
            DocumentInfo documentInfo = new DocumentInfo();
            Map<String, Object> document = documents.get(0);
            documentInfo.setId(documentId);
            documentInfo.setTitle((String) document.get("title"));
            documentInfo.setAuthor((String) document.get("author"));
            documentInfo.setLanguage((String) document.get("language"));

            // 5. 获取关联的笔记
            String noteSql = "SELECT * FROM document_notes WHERE highlight_id = ? AND user_id = ? ORDER BY created_at DESC";
            List<Map<String, Object>> notes = jdbcTemplate.queryForList(noteSql, highlightId, userId);

            List<NoteInfo> noteList = new ArrayList<>();
            for (Map<String, Object> note : notes) {
                NoteInfo noteInfo = new NoteInfo();
                noteInfo.setId(((Number) note.get("note_id")).intValue());
                noteInfo.setContent((String) note.get("content"));
                noteInfo.setCreatedAt(note.get("created_at").toString());
                noteInfo.setUpdatedAt(note.get("updated_at").toString());
                noteList.add(noteInfo);
            }

            // 6. 构建响应数据
            HighlightDetailData highlightData = new HighlightDetailData();
            highlightData.setId(highlightId);
            highlightData.setDocumentId(documentId);
            highlightData.setText((String) highlight.get("text"));
            highlightData.setPage(((Number) highlight.get("page")).intValue());
            highlightData.setColor((String) highlight.get("color"));
            highlightData.setNote((String) highlight.get("note"));
            highlightData.setCreatedAt(highlight.get("created_at").toString());
            highlightData.setUpdatedAt(highlight.get("updated_at").toString());
            highlightData.setDocument(documentInfo);
            highlightData.setNotes(noteList);

            // 解析position JSON
            if (highlight.get("position") != null) {
                try {
                    String posStr = (String) highlight.get("position");
                    if (posStr.startsWith("{") && posStr.endsWith("}")) {
                        Map<String, Object> posMap = new HashMap<>();
                        posMap.put("x", 0);
                        posMap.put("y", 0);
                        posMap.put("width", 100);
                        posMap.put("height", 20);
                        highlightData.setPosition(posMap);
                    }
                } catch (Exception e) {
                    System.err.println("解析position JSON失败: " + e.getMessage());
                }
            }

            HighlightDetailResponse response = new HighlightDetailResponse(true, "获取高亮详情成功", highlightData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取高亮详情过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new HighlightDetailResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: ReaderGetHighlightById.java ---

--- 开始文件: ReaderGetHighlights.java ---
package com.vue.readingapp.reader;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;

@RestController
@RequestMapping("/api/v1/reader")
public class ReaderGetHighlights {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取高亮列表请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class HighlightsResponse {
        private boolean success;
        private String message;
        private HighlightsData data;

        public HighlightsResponse(boolean success, String message, HighlightsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public HighlightsData getData() { return data; }
        public void setData(HighlightsData data) { this.data = data; }
    }

    public static class HighlightsData {
        private List<HighlightItem> highlights;
        private PaginationInfo pagination;

        public HighlightsData() {
            this.highlights = new ArrayList<>();
            this.pagination = new PaginationInfo();
        }

        public List<HighlightItem> getHighlights() { return highlights; }
        public void setHighlights(List<HighlightItem> highlights) { this.highlights = highlights; }

        public PaginationInfo getPagination() { return pagination; }
        public void setPagination(PaginationInfo pagination) { this.pagination = pagination; }
    }

    public static class HighlightItem {
        private int id;
        private int documentId;
        private String text;
        private int page;
        private Map<String, Object> position;
        private String color;
        private String note;
        private String createdAt;
        private String updatedAt;

        public HighlightItem() {
            this.position = new HashMap<>();
        }

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public int getDocumentId() { return documentId; }
        public void setDocumentId(int documentId) { this.documentId = documentId; }

        public String getText() { return text; }
        public void setText(String text) { this.text = text; }

        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public Map<String, Object> getPosition() { return position; }
        public void setPosition(Map<String, Object> position) { this.position = position; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getNote() { return note; }
        public void setNote(String note) { this.note = note; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }
    }

    public static class PaginationInfo {
        private int page;
        private int pageSize;
        private int total;
        private int totalPages;

        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public int getPageSize() { return pageSize; }
        public void setPageSize(int pageSize) { this.pageSize = pageSize; }

        public int getTotal() { return total; }
        public void setTotal(int total) { this.total = total; }

        public int getTotalPages() { return totalPages; }
        public void setTotalPages(int totalPages) { this.totalPages = totalPages; }
    }

    @GetMapping("/documents/{documentId}/highlights")
    public ResponseEntity<HighlightsResponse> getHighlights(
            @PathVariable("documentId") int documentId,
            @RequestParam(value = "page", defaultValue = "1") int page,
            @RequestParam(value = "pageSize", defaultValue = "20") int pageSize,
            @RequestParam(value = "pageNumber", required = false) Integer filterPage,
            @RequestParam(value = "color", required = false) String filterColor,
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        // 打印接收到的请求
        Map<String, Object> requestInfo = new HashMap<>();
        requestInfo.put("documentId", documentId);
        requestInfo.put("page", page);
        requestInfo.put("pageSize", pageSize);
        requestInfo.put("filterPage", filterPage);
        requestInfo.put("filterColor", filterColor);
        requestInfo.put("authHeader", authHeader != null ? "provided" : "missing");
        printRequest(requestInfo);

        try {
            // 1. 验证认证
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new HighlightsResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);

            // 验证token
            String tokenSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, token);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new HighlightsResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) sessions.get(0).get("user_id");

            // 2. 验证文档权限
            String docSql = "SELECT * FROM documents WHERE document_id = ? AND (user_id = ? OR is_public = true)";
            List<Map<String, Object>> documents = jdbcTemplate.queryForList(docSql, documentId, userId);

            if (documents.isEmpty()) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN).body(
                        new HighlightsResponse(false, "没有权限查看此文档的高亮", null)
                );
            }

            // 3. 构建查询条件和参数
            StringBuilder whereClause = new StringBuilder("WHERE document_id = ? AND user_id = ?");
            List<Object> params = new ArrayList<>();
            params.add(documentId);
            params.add(userId);

            if (filterPage != null) {
                whereClause.append(" AND page = ?");
                params.add(filterPage);
            }

            if (filterColor != null && !filterColor.isEmpty()) {
                whereClause.append(" AND color = ?");
                params.add(filterColor);
            }

            // 4. 获取总数
            String countSql = "SELECT COUNT(*) as total FROM document_highlights " + whereClause;
            List<Map<String, Object>> counts = jdbcTemplate.queryForList(countSql, params.toArray());
            int total = counts.isEmpty() ? 0 : ((Number) counts.get(0).get("total")).intValue();

            // 5. 计算分页
            int totalPages = (int) Math.ceil((double) total / pageSize);
            int offset = (page - 1) * pageSize;

            // 6. 获取高亮列表
            String querySql = "SELECT * FROM document_highlights " + whereClause +
                    " ORDER BY created_at DESC LIMIT ? OFFSET ?";

            // 添加分页参数
            List<Object> queryParams = new ArrayList<>(params);
            queryParams.add(pageSize);
            queryParams.add(offset);

            List<Map<String, Object>> highlights = jdbcTemplate.queryForList(querySql, queryParams.toArray());
            printQueryResult(highlights);

            // 7. 构建响应数据
            HighlightsData highlightsData = new HighlightsData();

            for (Map<String, Object> highlight : highlights) {
                HighlightItem item = new HighlightItem();
                item.setId(((Number) highlight.get("highlight_id")).intValue());
                item.setDocumentId(((Number) highlight.get("document_id")).intValue());
                item.setText((String) highlight.get("text"));
                item.setPage(((Number) highlight.get("page")).intValue());
                item.setColor((String) highlight.get("color"));
                item.setNote((String) highlight.get("note"));
                item.setCreatedAt(highlight.get("created_at").toString());
                item.setUpdatedAt(highlight.get("updated_at").toString());

                // 解析position JSON
                if (highlight.get("position") != null) {
                    try {
                        String posStr = (String) highlight.get("position");
                        if (posStr.startsWith("{") && posStr.endsWith("}")) {
                            Map<String, Object> posMap = new HashMap<>();
                            posMap.put("x", 0);
                            posMap.put("y", 0);
                            posMap.put("width", 100);
                            posMap.put("height", 20);
                            item.setPosition(posMap);
                        }
                    } catch (Exception e) {
                        System.err.println("解析position JSON失败: " + e.getMessage());
                    }
                }

                highlightsData.getHighlights().add(item);
            }

            // 设置分页信息
            PaginationInfo pagination = new PaginationInfo();
            pagination.setPage(page);
            pagination.setPageSize(pageSize);
            pagination.setTotal(total);
            pagination.setTotalPages(totalPages);
            highlightsData.setPagination(pagination);

            HighlightsResponse response = new HighlightsResponse(true, "获取高亮列表成功", highlightsData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取高亮列表过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new HighlightsResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: ReaderGetHighlights.java ---

--- 开始文件: ReaderGetNoteById.java ---
package com.vue.readingapp.reader;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;

@RestController
@RequestMapping("/api/v1/reader")
public class ReaderGetNoteById {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取笔记详情请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class NoteDetailResponse {
        private boolean success;
        private String message;
        private NoteDetailData data;

        public NoteDetailResponse(boolean success, String message, NoteDetailData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public NoteDetailData getData() { return data; }
        public void setData(NoteDetailData data) { this.data = data; }
    }

    public static class NoteDetailData {
        private int id;
        private int documentId;
        private String content;
        private int page;
        private Map<String, Object> position;
        private Integer highlightId;
        private String createdAt;
        private String updatedAt;
        private DocumentInfo document;
        private HighlightInfo highlight;

        public NoteDetailData() {
            this.position = new HashMap<>();
        }

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public int getDocumentId() { return documentId; }
        public void setDocumentId(int documentId) { this.documentId = documentId; }

        public String getContent() { return content; }
        public void setContent(String content) { this.content = content; }

        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public Map<String, Object> getPosition() { return position; }
        public void setPosition(Map<String, Object> position) { this.position = position; }

        public Integer getHighlightId() { return highlightId; }
        public void setHighlightId(Integer highlightId) { this.highlightId = highlightId; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }

        public DocumentInfo getDocument() { return document; }
        public void setDocument(DocumentInfo document) { this.document = document; }

        public HighlightInfo getHighlight() { return highlight; }
        public void setHighlight(HighlightInfo highlight) { this.highlight = highlight; }
    }

    public static class DocumentInfo {
        private int id;
        private String title;
        private String author;
        private String language;

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public String getTitle() { return title; }
        public void setTitle(String title) { this.title = title; }

        public String getAuthor() { return author; }
        public void setAuthor(String author) { this.author = author; }

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }
    }

    public static class HighlightInfo {
        private int id;
        private String text;
        private String color;

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public String getText() { return text; }
        public void setText(String text) { this.text = text; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }
    }

    @GetMapping("/documents/{documentId}/notes/{noteId}")
    public ResponseEntity<NoteDetailResponse> getNoteById(
            @PathVariable("documentId") int documentId,
            @PathVariable("noteId") int noteId,
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        // 打印接收到的请求
        Map<String, Object> requestInfo = new HashMap<>();
        requestInfo.put("documentId", documentId);
        requestInfo.put("noteId", noteId);
        requestInfo.put("authHeader", authHeader != null ? "provided" : "missing");
        printRequest(requestInfo);

        try {
            // 1. 验证认证
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new NoteDetailResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);

            // 验证token
            String tokenSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, token);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new NoteDetailResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) sessions.get(0).get("user_id");

            // 2. 验证文档权限
            String docSql = "SELECT * FROM documents WHERE document_id = ? AND (user_id = ? OR is_public = true)";
            List<Map<String, Object>> documents = jdbcTemplate.queryForList(docSql, documentId, userId);

            if (documents.isEmpty()) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN).body(
                        new NoteDetailResponse(false, "没有权限查看此文档的笔记", null)
                );
            }

            // 3. 获取笔记详情
            String noteSql = "SELECT * FROM document_notes WHERE note_id = ? AND document_id = ? AND user_id = ?";
            List<Map<String, Object>> notes = jdbcTemplate.queryForList(noteSql, noteId, documentId, userId);
            printQueryResult(notes);

            if (notes.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new NoteDetailResponse(false, "笔记不存在", null)
                );
            }

            Map<String, Object> note = notes.get(0);

            // 4. 获取文档信息
            DocumentInfo documentInfo = new DocumentInfo();
            Map<String, Object> document = documents.get(0);
            documentInfo.setId(documentId);
            documentInfo.setTitle((String) document.get("title"));
            documentInfo.setAuthor((String) document.get("author"));
            documentInfo.setLanguage((String) document.get("language"));

            // 5. 获取关联的高亮信息（如果有）
            HighlightInfo highlightInfo = null;
            if (note.get("highlight_id") != null) {
                String highlightSql = "SELECT * FROM document_highlights WHERE highlight_id = ? AND user_id = ?";
                List<Map<String, Object>> highlights = jdbcTemplate.queryForList(highlightSql, note.get("highlight_id"), userId);

                if (!highlights.isEmpty()) {
                    Map<String, Object> highlight = highlights.get(0);
                    highlightInfo = new HighlightInfo();
                    highlightInfo.setId(((Number) highlight.get("highlight_id")).intValue());
                    highlightInfo.setText((String) highlight.get("text"));
                    highlightInfo.setColor((String) highlight.get("color"));
                }
            }

            // 6. 构建响应数据
            NoteDetailData noteData = new NoteDetailData();
            noteData.setId(noteId);
            noteData.setDocumentId(documentId);
            noteData.setContent((String) note.get("content"));
            noteData.setPage(((Number) note.get("page")).intValue());
            noteData.setHighlightId(note.get("highlight_id") != null ?
                    ((Number) note.get("highlight_id")).intValue() : null);
            noteData.setCreatedAt(note.get("created_at").toString());
            noteData.setUpdatedAt(note.get("updated_at").toString());
            noteData.setDocument(documentInfo);
            noteData.setHighlight(highlightInfo);

            // 解析position JSON
            if (note.get("position") != null) {
                try {
                    String posStr = (String) note.get("position");
                    if (posStr.startsWith("{") && posStr.endsWith("}")) {
                        Map<String, Object> posMap = new HashMap<>();
                        posMap.put("x", 0);
                        posMap.put("y", 0);
                        posMap.put("width", 100);
                        posMap.put("height", 20);
                        noteData.setPosition(posMap);
                    }
                } catch (Exception e) {
                    System.err.println("解析position JSON失败: " + e.getMessage());
                }
            }

            NoteDetailResponse response = new NoteDetailResponse(true, "获取笔记详情成功", noteData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取笔记详情过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new NoteDetailResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: ReaderGetNoteById.java ---

--- 开始文件: ReaderGetNotes.java ---
package com.vue.readingapp.reader;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;

@RestController
@RequestMapping("/api/v1/reader")
public class ReaderGetNotes {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取笔记列表请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class NotesResponse {
        private boolean success;
        private String message;
        private NotesData data;

        public NotesResponse(boolean success, String message, NotesData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public NotesData getData() { return data; }
        public void setData(NotesData data) { this.data = data; }
    }

    public static class NotesData {
        private List<NoteItem> notes;
        private PaginationInfo pagination;

        public NotesData() {
            this.notes = new ArrayList<>();
            this.pagination = new PaginationInfo();
        }

        public List<NoteItem> getNotes() { return notes; }
        public void setNotes(List<NoteItem> notes) { this.notes = notes; }

        public PaginationInfo getPagination() { return pagination; }
        public void setPagination(PaginationInfo pagination) { this.pagination = pagination; }
    }

    public static class NoteItem {
        private int id;
        private int documentId;
        private String content;
        private int page;
        private Map<String, Object> position;
        private Integer highlightId;
        private String createdAt;
        private String updatedAt;
        private HighlightInfo highlight;

        public NoteItem() {
            this.position = new HashMap<>();
        }

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public int getDocumentId() { return documentId; }
        public void setDocumentId(int documentId) { this.documentId = documentId; }

        public String getContent() { return content; }
        public void setContent(String content) { this.content = content; }

        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public Map<String, Object> getPosition() { return position; }
        public void setPosition(Map<String, Object> position) { this.position = position; }

        public Integer getHighlightId() { return highlightId; }
        public void setHighlightId(Integer highlightId) { this.highlightId = highlightId; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }

        public HighlightInfo getHighlight() { return highlight; }
        public void setHighlight(HighlightInfo highlight) { this.highlight = highlight; }
    }

    public static class HighlightInfo {
        private int id;
        private String text;
        private String color;

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public String getText() { return text; }
        public void setText(String text) { this.text = text; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }
    }

    public static class PaginationInfo {
        private int page;
        private int pageSize;
        private int total;
        private int totalPages;

        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public int getPageSize() { return pageSize; }
        public void setPageSize(int pageSize) { this.pageSize = pageSize; }

        public int getTotal() { return total; }
        public void setTotal(int total) { this.total = total; }

        public int getTotalPages() { return totalPages; }
        public void setTotalPages(int totalPages) { this.totalPages = totalPages; }
    }

    @GetMapping("/documents/{documentId}/notes")
    public ResponseEntity<NotesResponse> getNotes(
            @PathVariable("documentId") int documentId,
            @RequestParam(value = "page", defaultValue = "1") int page,
            @RequestParam(value = "pageSize", defaultValue = "20") int pageSize,
            @RequestParam(value = "pageNumber", required = false) Integer filterPage,
            @RequestParam(value = "highlightId", required = false) Integer filterHighlightId,
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        // 打印接收到的请求
        Map<String, Object> requestInfo = new HashMap<>();
        requestInfo.put("documentId", documentId);
        requestInfo.put("page", page);
        requestInfo.put("pageSize", pageSize);
        requestInfo.put("filterPage", filterPage);
        requestInfo.put("filterHighlightId", filterHighlightId);
        requestInfo.put("authHeader", authHeader != null ? "provided" : "missing");
        printRequest(requestInfo);

        try {
            // 1. 验证认证
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new NotesResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);

            // 验证token
            String tokenSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, token);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new NotesResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) sessions.get(0).get("user_id");

            // 2. 验证文档权限
            String docSql = "SELECT * FROM documents WHERE document_id = ? AND (user_id = ? OR is_public = true)";
            List<Map<String, Object>> documents = jdbcTemplate.queryForList(docSql, documentId, userId);

            if (documents.isEmpty()) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN).body(
                        new NotesResponse(false, "没有权限查看此文档的笔记", null)
                );
            }

            // 3. 构建查询条件和参数
            StringBuilder whereClause = new StringBuilder("WHERE dn.document_id = ? AND dn.user_id = ?");
            List<Object> params = new ArrayList<>();
            params.add(documentId);
            params.add(userId);

            if (filterPage != null) {
                whereClause.append(" AND dn.page = ?");
                params.add(filterPage);
            }

            if (filterHighlightId != null) {
                whereClause.append(" AND dn.highlight_id = ?");
                params.add(filterHighlightId);
            }

            // 4. 获取总数
            String countSql = "SELECT COUNT(*) as total FROM document_notes dn " + whereClause;
            List<Map<String, Object>> counts = jdbcTemplate.queryForList(countSql, params.toArray());
            int total = counts.isEmpty() ? 0 : ((Number) counts.get(0).get("total")).intValue();

            // 5. 计算分页
            int totalPages = (int) Math.ceil((double) total / pageSize);
            int offset = (page - 1) * pageSize;

            // 6. 获取笔记列表（包含关联的高亮信息）
            String querySql = "SELECT dn.*, dh.text as highlight_text, dh.color as highlight_color " +
                    "FROM document_notes dn " +
                    "LEFT JOIN document_highlights dh ON dn.highlight_id = dh.highlight_id AND dh.user_id = ? " +
                    whereClause + " ORDER BY dn.created_at DESC LIMIT ? OFFSET ?";

            // 添加分页参数
            List<Object> queryParams = new ArrayList<>();
            queryParams.add(userId);
            queryParams.addAll(params);
            queryParams.add(pageSize);
            queryParams.add(offset);

            List<Map<String, Object>> notes = jdbcTemplate.queryForList(querySql, queryParams.toArray());
            printQueryResult(notes);

            // 7. 构建响应数据
            NotesData notesData = new NotesData();

            for (Map<String, Object> note : notes) {
                NoteItem item = new NoteItem();
                item.setId(((Number) note.get("note_id")).intValue());
                item.setDocumentId(documentId);
                item.setContent((String) note.get("content"));
                item.setPage(((Number) note.get("page")).intValue());

                // 设置高亮ID
                if (note.get("highlight_id") != null) {
                    item.setHighlightId(((Number) note.get("highlight_id")).intValue());

                    // 设置高亮信息
                    HighlightInfo highlightInfo = new HighlightInfo();
                    highlightInfo.setId(((Number) note.get("highlight_id")).intValue());
                    highlightInfo.setText((String) note.get("highlight_text"));
                    highlightInfo.setColor((String) note.get("highlight_color"));
                    item.setHighlight(highlightInfo);
                }

                item.setCreatedAt(note.get("created_at").toString());
                item.setUpdatedAt(note.get("updated_at").toString());

                // 解析position JSON
                if (note.get("position") != null) {
                    try {
                        String posStr = (String) note.get("position");
                        if (posStr.startsWith("{") && posStr.endsWith("}")) {
                            Map<String, Object> posMap = new HashMap<>();
                            posMap.put("x", 0);
                            posMap.put("y", 0);
                            posMap.put("width", 100);
                            posMap.put("height", 20);
                            item.setPosition(posMap);
                        }
                    } catch (Exception e) {
                        System.err.println("解析position JSON失败: " + e.getMessage());
                    }
                }

                notesData.getNotes().add(item);
            }

            // 设置分页信息
            PaginationInfo pagination = new PaginationInfo();
            pagination.setPage(page);
            pagination.setPageSize(pageSize);
            pagination.setTotal(total);
            pagination.setTotalPages(totalPages);
            notesData.setPagination(pagination);

            NotesResponse response = new NotesResponse(true, "获取笔记列表成功", notesData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取笔记列表过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new NotesResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: ReaderGetNotes.java ---

--- 开始文件: ReaderGetReadingHistory.java ---
package com.vue.readingapp.reader;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;

@RestController
@RequestMapping("/api/v1/reader")
public class ReaderGetReadingHistory {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取阅读历史请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class ReadingHistoryResponse {
        private boolean success;
        private String message;
        private ReadingHistoryData data;

        public ReadingHistoryResponse(boolean success, String message, ReadingHistoryData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public ReadingHistoryData getData() { return data; }
        public void setData(ReadingHistoryData data) { this.data = data; }
    }

    public static class ReadingHistoryData {
        private List<HistoryItem> history;
        private PaginationInfo pagination;

        public ReadingHistoryData() {
            this.history = new ArrayList<>();
            this.pagination = new PaginationInfo();
        }

        public List<HistoryItem> getHistory() { return history; }
        public void setHistory(List<HistoryItem> history) { this.history = history; }

        public PaginationInfo getPagination() { return pagination; }
        public void setPagination(PaginationInfo pagination) { this.pagination = pagination; }
    }

    public static class HistoryItem {
        private int id;
        private int documentId;
        private int page;
        private int readingTime;
        private String date;
        private DocumentInfo document;

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public int getDocumentId() { return documentId; }
        public void setDocumentId(int documentId) { this.documentId = documentId; }

        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public int getReadingTime() { return readingTime; }
        public void setReadingTime(int readingTime) { this.readingTime = readingTime; }

        public String getDate() { return date; }
        public void setDate(String date) { this.date = date; }

        public DocumentInfo getDocument() { return document; }
        public void setDocument(DocumentInfo document) { this.document = document; }
    }

    public static class DocumentInfo {
        private int id;
        private String title;
        private String author;
        private String language;

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public String getTitle() { return title; }
        public void setTitle(String title) { this.title = title; }

        public String getAuthor() { return author; }
        public void setAuthor(String author) { this.author = author; }

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }
    }

    public static class PaginationInfo {
        private int page;
        private int pageSize;
        private int total;
        private int totalPages;

        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public int getPageSize() { return pageSize; }
        public void setPageSize(int pageSize) { this.pageSize = pageSize; }

        public int getTotal() { return total; }
        public void setTotal(int total) { this.total = total; }

        public int getTotalPages() { return totalPages; }
        public void setTotalPages(int totalPages) { this.totalPages = totalPages; }
    }

    @GetMapping("/documents/{documentId}/reading-history")
    public ResponseEntity<ReadingHistoryResponse> getReadingHistory(
            @PathVariable("documentId") int documentId,
            @RequestParam(value = "limit", defaultValue = "10") int limit,
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        // 打印接收到的请求
        Map<String, Object> requestInfo = new HashMap<>();
        requestInfo.put("documentId", documentId);
        requestInfo.put("limit", limit);
        requestInfo.put("authHeader", authHeader != null ? "provided" : "missing");
        printRequest(requestInfo);

        try {
            // 1. 验证认证
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ReadingHistoryResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);

            // 验证token
            String tokenSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, token);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ReadingHistoryResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) sessions.get(0).get("user_id");

            // 2. 验证文档权限
            String docSql = "SELECT * FROM documents WHERE document_id = ? AND (user_id = ? OR is_public = true)";
            List<Map<String, Object>> documents = jdbcTemplate.queryForList(docSql, documentId, userId);

            if (documents.isEmpty()) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN).body(
                        new ReadingHistoryResponse(false, "没有权限查看此文档的阅读历史", null)
                );
            }

            // 3. 获取阅读历史记录
            String historySql = "SELECT * FROM reading_history " +
                    "WHERE user_id = ? AND document_id = ? " +
                    "ORDER BY created_at DESC LIMIT ?";

            List<Map<String, Object>> historyList = jdbcTemplate.queryForList(historySql, userId, documentId, limit);
            printQueryResult(historyList);

            // 4. 构建响应数据
            ReadingHistoryData historyData = new ReadingHistoryData();

            for (Map<String, Object> history : historyList) {
                HistoryItem item = new HistoryItem();
                item.setId(((Number) history.get("history_id")).intValue());
                item.setDocumentId(documentId);
                item.setPage(((Number) history.get("page")).intValue());
                item.setReadingTime(history.get("reading_time") != null ?
                        ((Number) history.get("reading_time")).intValue() : 0);
                item.setDate(history.get("created_at").toString());

                // 设置文档信息
                Map<String, Object> document = documents.get(0);
                DocumentInfo docInfo = new DocumentInfo();
                docInfo.setId(documentId);
                docInfo.setTitle((String) document.get("title"));
                docInfo.setAuthor((String) document.get("author"));
                docInfo.setLanguage((String) document.get("language"));
                item.setDocument(docInfo);

                historyData.getHistory().add(item);
            }

            // 设置分页信息（这里limit就是pageSize，我们只有一页）
            PaginationInfo pagination = new PaginationInfo();
            pagination.setPage(1);
            pagination.setPageSize(limit);
            pagination.setTotal(historyList.size());
            pagination.setTotalPages(1);
            historyData.setPagination(pagination);

            ReadingHistoryResponse response = new ReadingHistoryResponse(true, "获取阅读历史成功", historyData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取阅读历史过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ReadingHistoryResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: ReaderGetReadingHistory.java ---

--- 开始文件: ReaderLookupWord.java ---
package com.vue.readingapp.reader;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.*;

@RestController
@RequestMapping("/api/v1/reader")
public class ReaderLookupWord {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到查询单词请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=====================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class LookupWordResponse {
        private boolean success;
        private String message;
        private LookupData data;

        public LookupWordResponse(boolean success, String message, LookupData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public LookupData getData() { return data; }
        public void setData(LookupData data) { this.data = data; }
    }

    public static class LookupData {
        private String word;
        private String language;
        private List<Definition> definitions;
        private List<Example> examples;
        private List<RelatedWord> relatedWords;

        public LookupData() {
            this.definitions = new ArrayList<>();
            this.examples = new ArrayList<>();
            this.relatedWords = new ArrayList<>();
        }

        public String getWord() { return word; }
        public void setWord(String word) { this.word = word; }

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }

        public List<Definition> getDefinitions() { return definitions; }
        public void setDefinitions(List<Definition> definitions) { this.definitions = definitions; }

        public List<Example> getExamples() { return examples; }
        public void setExamples(List<Example> examples) { this.examples = examples; }

        public List<RelatedWord> getRelatedWords() { return relatedWords; }
        public void setRelatedWords(List<RelatedWord> relatedWords) { this.relatedWords = relatedWords; }
    }

    public static class Definition {
        private int id;
        private String partOfSpeech;
        private String definition;
        private String example;

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public String getPartOfSpeech() { return partOfSpeech; }
        public void setPartOfSpeech(String partOfSpeech) { this.partOfSpeech = partOfSpeech; }

        public String getDefinition() { return definition; }
        public void setDefinition(String definition) { this.definition = definition; }

        public String getExample() { return example; }
        public void setExample(String example) { this.example = example; }
    }

    public static class Example {
        private int id;
        private String example;
        private String translation;

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public String getExample() { return example; }
        public void setExample(String example) { this.example = example; }

        public String getTranslation() { return translation; }
        public void setTranslation(String translation) { this.translation = translation; }
    }

    public static class RelatedWord {
        private int id;
        private String word;
        private String relationship;

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public String getWord() { return word; }
        public void setWord(String word) { this.word = word; }

        public String getRelationship() { return relationship; }
        public void setRelationship(String relationship) { this.relationship = relationship; }
    }

    @GetMapping("/dictionary/lookup")
    public ResponseEntity<LookupWordResponse> lookupWord(
            @RequestParam("word") String word,
            @RequestParam(value = "language", defaultValue = "en") String language,
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        // 打印接收到的请求
        Map<String, Object> requestInfo = new HashMap<>();
        requestInfo.put("word", word);
        requestInfo.put("language", language);
        requestInfo.put("authHeader", authHeader != null ? "provided" : "missing");
        printRequest(requestInfo);

        try {
            // 1. 验证认证
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new LookupWordResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);

            // 验证token
            String tokenSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, token);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new LookupWordResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) sessions.get(0).get("user_id");

            // 2. 验证请求数据
            if (word == null || word.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new LookupWordResponse(false, "查询的单词不能为空", null)
                );
            }

            // 3. 查询单词基本信息
            String wordSql = "SELECT * FROM words WHERE word = ? AND language = ?";
            List<Map<String, Object>> words = jdbcTemplate.queryForList(wordSql, word.trim().toLowerCase(), language);

            if (words.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new LookupWordResponse(false, "单词未找到", null)
                );
            }

            Map<String, Object> wordInfo = words.get(0);
            int wordId = ((Number) wordInfo.get("word_id")).intValue();

            // 4. 查询单词释义
            String definitionSql = "SELECT * FROM word_definitions WHERE word_id = ? ORDER BY order_index";
            List<Map<String, Object>> definitions = jdbcTemplate.queryForList(definitionSql, wordId);

            // 5. 查询单词例句
            String exampleSql = "SELECT * FROM word_examples WHERE word_id = ? ORDER BY order_index";
            List<Map<String, Object>> examples = jdbcTemplate.queryForList(exampleSql, wordId);

            // 6. 查询相关单词
            String relatedSql = "SELECT wr.*, w.word as related_word FROM word_relations wr " +
                    "JOIN words w ON wr.related_word_id = w.word_id " +
                    "WHERE wr.word_id = ?";
            List<Map<String, Object>> relatedWords = jdbcTemplate.queryForList(relatedSql, wordId);

            printQueryResult("单词ID: " + wordId + ", 释义数: " + definitions.size() +
                    ", 例句数: " + examples.size() + ", 相关词数: " + relatedWords.size());

            // 7. 构建响应数据
            LookupData lookupData = new LookupData();
            lookupData.setWord(word);
            lookupData.setLanguage(language);

            // 设置释义
            for (Map<String, Object> definition : definitions) {
                Definition def = new Definition();
                def.setId(((Number) definition.get("definition_id")).intValue());
                def.setPartOfSpeech((String) definition.get("part_of_speech"));
                def.setDefinition((String) definition.get("definition"));
                def.setExample((String) definition.get("example"));
                lookupData.getDefinitions().add(def);
            }

            // 设置例句
            for (Map<String, Object> example : examples) {
                Example ex = new Example();
                ex.setId(((Number) example.get("example_id")).intValue());
                ex.setExample((String) example.get("example"));
                ex.setTranslation((String) example.get("translation"));
                lookupData.getExamples().add(ex);
            }

            // 设置相关单词
            for (Map<String, Object> relatedWord : relatedWords) {
                RelatedWord rw = new RelatedWord();
                rw.setId(((Number) relatedWord.get("relation_id")).intValue());
                rw.setWord((String) relatedWord.get("related_word"));
                rw.setRelationship((String) relatedWord.get("relationship_type"));
                lookupData.getRelatedWords().add(rw);
            }

            // 8. 记录查询历史
            String historySql = "INSERT INTO word_lookup_history (user_id, word_id, lookup_time) VALUES (?, ?, NOW())";
            jdbcTemplate.update(historySql, userId, wordId);

            LookupWordResponse response = new LookupWordResponse(true, "单词查询成功", lookupData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("查询单词过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new LookupWordResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: ReaderLookupWord.java ---

--- 开始文件: ReaderSearchDocumentContent.java ---
package com.vue.readingapp.reader;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;

@RestController
@RequestMapping("/api/v1/reader")
public class ReaderSearchDocumentContent {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到搜索文档内容请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class SearchResponse {
        private boolean success;
        private String message;
        private SearchData data;

        public SearchResponse(boolean success, String message, SearchData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public SearchData getData() { return data; }
        public void setData(SearchData data) { this.data = data; }
    }

    public static class SearchData {
        private String query;
        private int total;
        private List<SearchMatch> matches;

        public SearchData() {
            this.matches = new ArrayList<>();
        }

        public String getQuery() { return query; }
        public void setQuery(String query) { this.query = query; }

        public int getTotal() { return total; }
        public void setTotal(int total) { this.total = total; }

        public List<SearchMatch> getMatches() { return matches; }
        public void setMatches(List<SearchMatch> matches) { this.matches = matches; }
    }

    public static class SearchMatch {
        private int page;
        private String text;
        private String context;
        private List<String> highlights;

        public SearchMatch() {
            this.highlights = new ArrayList<>();
        }

        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public String getText() { return text; }
        public void setText(String text) { this.text = text; }

        public String getContext() { return context; }
        public void setContext(String context) { this.context = context; }

        public List<String> getHighlights() { return highlights; }
        public void setHighlights(List<String> highlights) { this.highlights = highlights; }
    }

    @GetMapping("/documents/{documentId}/search")
    public ResponseEntity<SearchResponse> searchDocumentContent(
            @PathVariable("documentId") int documentId,
            @RequestParam("query") String query,
            @RequestParam(value = "page", defaultValue = "1") int page,
            @RequestParam(value = "pageSize", defaultValue = "20") int pageSize,
            @RequestParam(value = "caseSensitive", defaultValue = "false") boolean caseSensitive,
            @RequestParam(value = "wholeWord", defaultValue = "false") boolean wholeWord,
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        // 打印接收到的请求
        Map<String, Object> requestInfo = new HashMap<>();
        requestInfo.put("documentId", documentId);
        requestInfo.put("query", query);
        requestInfo.put("page", page);
        requestInfo.put("pageSize", pageSize);
        requestInfo.put("caseSensitive", caseSensitive);
        requestInfo.put("wholeWord", wholeWord);
        requestInfo.put("authHeader", authHeader != null ? "provided" : "missing");
        printRequest(requestInfo);

        try {
            // 1. 验证认证
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new SearchResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);

            // 验证token
            String tokenSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, token);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new SearchResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) sessions.get(0).get("user_id");

            // 2. 验证文档权限
            String docSql = "SELECT * FROM documents WHERE document_id = ? AND (user_id = ? OR is_public = true)";
            List<Map<String, Object>> documents = jdbcTemplate.queryForList(docSql, documentId, userId);

            if (documents.isEmpty()) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN).body(
                        new SearchResponse(false, "没有权限在此文档搜索", null)
                );
            }

            // 3. 验证查询参数
            if (query == null || query.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new SearchResponse(false, "搜索关键词不能为空", null)
                );
            }

            // 4. 获取文档的所有页面
            String pagesSql = "SELECT * FROM document_pages WHERE document_id = ? ORDER BY page_number";
            List<Map<String, Object>> pages = jdbcTemplate.queryForList(pagesSql, documentId);

            // 5. 执行搜索
            List<SearchMatch> matches = new ArrayList<>();
            String searchQuery = query.trim();

            if (!caseSensitive) {
                searchQuery = searchQuery.toLowerCase();
            }

            for (Map<String, Object> pageData : pages) {
                int pageNumber = ((Number) pageData.get("page_number")).intValue();
                String content = (String) pageData.get("content");

                if (content == null) {
                    continue;
                }

                String searchContent = content;
                if (!caseSensitive) {
                    searchContent = content.toLowerCase();
                }

                // 简单的字符串搜索（实际项目中可能需要全文搜索）
                int index = 0;
                while ((index = searchContent.indexOf(searchQuery, index)) != -1) {
                    SearchMatch match = new SearchMatch();
                    match.setPage(pageNumber);

                    // 提取匹配的文本
                    int start = Math.max(0, index - 50);
                    int end = Math.min(content.length(), index + searchQuery.length() + 50);
                    String matchedText = content.substring(index, index + searchQuery.length());
                    String contextText = content.substring(start, end);

                    match.setText(matchedText);
                    match.setContext(contextText);

                    // 添加高亮标记
                    List<String> highlights = new ArrayList<>();
                    highlights.add(matchedText);
                    match.setHighlights(highlights);

                    matches.add(match);

                    // 移动到下一个位置
                    index += searchQuery.length();
                }
            }

            // 6. 分页处理
            int total = matches.size();
            int totalPages = (int) Math.ceil((double) total / pageSize);
            int offset = (page - 1) * pageSize;
            int endIndex = Math.min(offset + pageSize, total);

            List<SearchMatch> pagedMatches = new ArrayList<>();
            if (offset < total) {
                pagedMatches = matches.subList(offset, endIndex);
            }

            // 7. 构建响应数据
            SearchData searchData = new SearchData();
            searchData.setQuery(query);
            searchData.setTotal(total);
            searchData.setMatches(pagedMatches);

            SearchResponse response = new SearchResponse(true, "搜索完成", searchData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("搜索文档内容过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new SearchResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: ReaderSearchDocumentContent.java ---

--- 开始文件: ReaderUpdateHighlight.java ---
package com.vue.readingapp.reader;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;

@RestController
@RequestMapping("/api/v1/reader")
public class ReaderUpdateHighlight {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到更新高亮请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=====================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class UpdateHighlightRequest {
        private String color;
        private String note;

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getNote() { return note; }
        public void setNote(String note) { this.note = note; }
    }

    // 响应DTO
    public static class UpdateHighlightResponse {
        private boolean success;
        private String message;
        private HighlightData data;

        public UpdateHighlightResponse(boolean success, String message, HighlightData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public HighlightData getData() { return data; }
        public void setData(HighlightData data) { this.data = data; }
    }

    public static class HighlightData {
        private int id;
        private int documentId;
        private String text;
        private int page;
        private Map<String, Object> position;
        private String color;
        private String note;
        private String createdAt;
        private String updatedAt;

        public HighlightData() {
            this.position = new HashMap<>();
        }

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public int getDocumentId() { return documentId; }
        public void setDocumentId(int documentId) { this.documentId = documentId; }

        public String getText() { return text; }
        public void setText(String text) { this.text = text; }

        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public Map<String, Object> getPosition() { return position; }
        public void setPosition(Map<String, Object> position) { this.position = position; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getNote() { return note; }
        public void setNote(String note) { this.note = note; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }
    }

    @PutMapping("/documents/{documentId}/highlights/{highlightId}")
    public ResponseEntity<UpdateHighlightResponse> updateHighlight(
            @PathVariable("documentId") int documentId,
            @PathVariable("highlightId") int highlightId,
            @RequestBody UpdateHighlightRequest request,
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        // 打印接收到的请求
        Map<String, Object> requestInfo = new HashMap<>();
        requestInfo.put("documentId", documentId);
        requestInfo.put("highlightId", highlightId);
        requestInfo.put("request", request);
        requestInfo.put("authHeader", authHeader != null ? "provided" : "missing");
        printRequest(requestInfo);

        try {
            // 1. 验证认证
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateHighlightResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);

            // 验证token
            String tokenSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, token);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateHighlightResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) sessions.get(0).get("user_id");

            // 2. 验证高亮是否存在且属于当前用户
            String highlightSql = "SELECT * FROM document_highlights WHERE highlight_id = ? AND document_id = ? AND user_id = ?";
            List<Map<String, Object>> highlights = jdbcTemplate.queryForList(highlightSql, highlightId, documentId, userId);

            if (highlights.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new UpdateHighlightResponse(false, "高亮不存在或没有权限修改", null)
                );
            }

            // 3. 构建更新字段
            List<String> updateFields = new ArrayList<>();
            List<Object> updateParams = new ArrayList<>();

            if (request.getColor() != null) {
                updateFields.add("color = ?");
                updateParams.add(request.getColor());
            }

            if (request.getNote() != null) {
                updateFields.add("note = ?");
                updateParams.add(request.getNote().trim());
            }

            // 如果没有要更新的字段
            if (updateFields.isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new UpdateHighlightResponse(false, "没有提供更新数据", null)
                );
            }

            // 添加更新时间
            updateFields.add("updated_at = NOW()");

            // 添加WHERE条件参数
            updateParams.add(highlightId);
            updateParams.add(documentId);
            updateParams.add(userId);

            // 4. 执行更新
            String updateSql = "UPDATE document_highlights SET " + String.join(", ", updateFields) +
                    " WHERE highlight_id = ? AND document_id = ? AND user_id = ?";

            int updatedRows = jdbcTemplate.update(updateSql, updateParams.toArray());

            if (updatedRows == 0) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new UpdateHighlightResponse(false, "更新高亮失败", null)
                );
            }

            // 5. 获取更新后的高亮数据
            String getUpdatedSql = "SELECT * FROM document_highlights WHERE highlight_id = ?";
            List<Map<String, Object>> updatedHighlights = jdbcTemplate.queryForList(getUpdatedSql, highlightId);
            printQueryResult(updatedHighlights);

            if (updatedHighlights.isEmpty()) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new UpdateHighlightResponse(false, "获取更新后的高亮数据失败", null)
                );
            }

            Map<String, Object> updatedHighlight = updatedHighlights.get(0);

            // 6. 构建响应数据
            HighlightData highlightData = new HighlightData();
            highlightData.setId(highlightId);
            highlightData.setDocumentId(documentId);
            highlightData.setText((String) updatedHighlight.get("text"));
            highlightData.setPage(((Number) updatedHighlight.get("page")).intValue());
            highlightData.setColor((String) updatedHighlight.get("color"));
            highlightData.setNote((String) updatedHighlight.get("note"));
            highlightData.setCreatedAt(updatedHighlight.get("created_at").toString());
            highlightData.setUpdatedAt(updatedHighlight.get("updated_at").toString());

            // 解析position JSON
            if (updatedHighlight.get("position") != null) {
                try {
                    String posStr = (String) updatedHighlight.get("position");
                    if (posStr.startsWith("{") && posStr.endsWith("}")) {
                        Map<String, Object> posMap = new HashMap<>();
                        posMap.put("x", 0);
                        posMap.put("y", 0);
                        posMap.put("width", 100);
                        posMap.put("height", 20);
                        highlightData.setPosition(posMap);
                    }
                } catch (Exception e) {
                    System.err.println("解析position JSON失败: " + e.getMessage());
                }
            }

            UpdateHighlightResponse response = new UpdateHighlightResponse(true, "高亮已更新", highlightData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("更新高亮过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdateHighlightResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: ReaderUpdateHighlight.java ---

--- 开始文件: ReaderUpdateNote.java ---
package com.vue.readingapp.reader;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.*;

@RestController
@RequestMapping("/api/v1/reader")
public class ReaderUpdateNote {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到更新笔记请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=====================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class UpdateNoteRequest {
        private String content;
        private Map<String, Object> position;
        private Integer highlightId;

        public String getContent() { return content; }
        public void setContent(String content) { this.content = content; }

        public Map<String, Object> getPosition() { return position; }
        public void setPosition(Map<String, Object> position) { this.position = position; }

        public Integer getHighlightId() { return highlightId; }
        public void setHighlightId(Integer highlightId) { this.highlightId = highlightId; }
    }

    // 响应DTO
    public static class UpdateNoteResponse {
        private boolean success;
        private String message;
        private NoteData data;

        public UpdateNoteResponse(boolean success, String message, NoteData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public NoteData getData() { return data; }
        public void setData(NoteData data) { this.data = data; }
    }

    public static class NoteData {
        private int id;
        private int documentId;
        private String content;
        private int page;
        private Map<String, Object> position;
        private Integer highlightId;
        private String createdAt;
        private String updatedAt;

        public NoteData() {
            this.position = new HashMap<>();
        }

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public int getDocumentId() { return documentId; }
        public void setDocumentId(int documentId) { this.documentId = documentId; }

        public String getContent() { return content; }
        public void setContent(String content) { this.content = content; }

        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public Map<String, Object> getPosition() { return position; }
        public void setPosition(Map<String, Object> position) { this.position = position; }

        public Integer getHighlightId() { return highlightId; }
        public void setHighlightId(Integer highlightId) { this.highlightId = highlightId; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }
    }

    @PutMapping("/documents/{documentId}/notes/{noteId}")
    public ResponseEntity<UpdateNoteResponse> updateNote(
            @PathVariable("documentId") int documentId,
            @PathVariable("noteId") int noteId,
            @RequestBody UpdateNoteRequest request,
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        // 打印接收到的请求
        Map<String, Object> requestInfo = new HashMap<>();
        requestInfo.put("documentId", documentId);
        requestInfo.put("noteId", noteId);
        requestInfo.put("request", request);
        requestInfo.put("authHeader", authHeader != null ? "provided" : "missing");
        printRequest(requestInfo);

        try {
            // 1. 验证认证
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateNoteResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);

            // 验证token
            String tokenSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, token);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateNoteResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) sessions.get(0).get("user_id");

            // 2. 验证笔记是否存在且属于当前用户
            String noteSql = "SELECT * FROM document_notes WHERE note_id = ? AND document_id = ? AND user_id = ?";
            List<Map<String, Object>> notes = jdbcTemplate.queryForList(noteSql, noteId, documentId, userId);

            if (notes.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new UpdateNoteResponse(false, "笔记不存在或没有权限修改", null)
                );
            }

            // 3. 如果有关联的高亮，验证高亮是否存在且属于当前用户
            if (request.getHighlightId() != null) {
                String highlightSql = "SELECT * FROM document_highlights WHERE highlight_id = ? AND document_id = ? AND user_id = ?";
                List<Map<String, Object>> highlights = jdbcTemplate.queryForList(highlightSql, request.getHighlightId(), documentId, userId);

                if (highlights.isEmpty()) {
                    return ResponseEntity.badRequest().body(
                            new UpdateNoteResponse(false, "关联的高亮不存在或没有权限", null)
                    );
                }
            }

            // 4. 构建更新字段
            List<String> updateFields = new ArrayList<>();
            List<Object> updateParams = new ArrayList<>();

            if (request.getContent() != null) {
                updateFields.add("content = ?");
                updateParams.add(request.getContent().trim());
            }

            if (request.getPosition() != null) {
                // 将position map转换为JSON字符串
                String positionJson = "{}";
                try {
                    // 简单处理，实际应该使用JSON库
                    positionJson = request.getPosition().toString();
                } catch (Exception e) {
                    System.err.println("转换position为JSON失败: " + e.getMessage());
                }
                updateFields.add("position = ?");
                updateParams.add(positionJson);
            }

            if (request.getHighlightId() != null) {
                updateFields.add("highlight_id = ?");
                updateParams.add(request.getHighlightId());
            }

            // 如果没有要更新的字段
            if (updateFields.isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new UpdateNoteResponse(false, "没有提供更新数据", null)
                );
            }

            // 添加更新时间
            updateFields.add("updated_at = NOW()");

            // 添加WHERE条件参数
            updateParams.add(noteId);
            updateParams.add(documentId);
            updateParams.add(userId);

            // 5. 执行更新
            String updateSql = "UPDATE document_notes SET " + String.join(", ", updateFields) +
                    " WHERE note_id = ? AND document_id = ? AND user_id = ?";

            int updatedRows = jdbcTemplate.update(updateSql, updateParams.toArray());

            if (updatedRows == 0) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new UpdateNoteResponse(false, "更新笔记失败", null)
                );
            }

            // 6. 获取更新后的笔记数据
            String getUpdatedSql = "SELECT * FROM document_notes WHERE note_id = ?";
            List<Map<String, Object>> updatedNotes = jdbcTemplate.queryForList(getUpdatedSql, noteId);
            printQueryResult(updatedNotes);

            if (updatedNotes.isEmpty()) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new UpdateNoteResponse(false, "获取更新后的笔记数据失败", null)
                );
            }

            Map<String, Object> updatedNote = updatedNotes.get(0);

            // 7. 构建响应数据
            NoteData noteData = new NoteData();
            noteData.setId(noteId);
            noteData.setDocumentId(documentId);
            noteData.setContent((String) updatedNote.get("content"));
            noteData.setPage(((Number) updatedNote.get("page")).intValue());
            noteData.setHighlightId(updatedNote.get("highlight_id") != null ?
                    ((Number) updatedNote.get("highlight_id")).intValue() : null);
            noteData.setCreatedAt(updatedNote.get("created_at").toString());
            noteData.setUpdatedAt(updatedNote.get("updated_at").toString());

            // 解析position JSON
            if (updatedNote.get("position") != null) {
                try {
                    String posStr = (String) updatedNote.get("position");
                    if (posStr.startsWith("{") && posStr.endsWith("}")) {
                        Map<String, Object> posMap = new HashMap<>();
                        posMap.put("x", 0);
                        posMap.put("y", 0);
                        posMap.put("width", 100);
                        posMap.put("height", 20);
                        noteData.setPosition(posMap);
                    }
                } catch (Exception e) {
                    System.err.println("解析position JSON失败: " + e.getMessage());
                }
            }

            UpdateNoteResponse response = new UpdateNoteResponse(true, "笔记已更新", noteData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("更新笔记过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdateNoteResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: ReaderUpdateNote.java ---

--- 开始文件: ReaderUpdateReadingProgress.java ---
package com.vue.readingapp.reader;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.*;

@RestController
@RequestMapping("/api/v1/reader")
public class ReaderUpdateReadingProgress {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到更新阅读进度请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=======================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class ProgressRequest {
        private int page;
        private Double percentage;
        private Integer readingTime;

        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public Double getPercentage() { return percentage; }
        public void setPercentage(Double percentage) { this.percentage = percentage; }

        public Integer getReadingTime() { return readingTime; }
        public void setReadingTime(Integer readingTime) { this.readingTime = readingTime; }
    }

    // 响应DTO
    public static class ProgressResponse {
        private boolean success;
        private String message;
        private ProgressData data;

        public ProgressResponse(boolean success, String message, ProgressData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public ProgressData getData() { return data; }
        public void setData(ProgressData data) { this.data = data; }
    }

    public static class ProgressData {
        private int documentId;
        private int currentPage;
        private double progressPercentage;
        private int totalReadingTime;
        private String lastReadAt;

        public int getDocumentId() { return documentId; }
        public void setDocumentId(int documentId) { this.documentId = documentId; }

        public int getCurrentPage() { return currentPage; }
        public void setCurrentPage(int currentPage) { this.currentPage = currentPage; }

        public double getProgressPercentage() { return progressPercentage; }
        public void setProgressPercentage(double progressPercentage) { this.progressPercentage = progressPercentage; }

        public int getTotalReadingTime() { return totalReadingTime; }
        public void setTotalReadingTime(int totalReadingTime) { this.totalReadingTime = totalReadingTime; }

        public String getLastReadAt() { return lastReadAt; }
        public void setLastReadAt(String lastReadAt) { this.lastReadAt = lastReadAt; }
    }

    @PutMapping("/documents/{documentId}/reading-progress")
    public ResponseEntity<ProgressResponse> updateReadingProgress(
            @PathVariable("documentId") int documentId,
            @RequestBody ProgressRequest request,
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        // 打印接收到的请求
        Map<String, Object> requestInfo = new HashMap<>();
        requestInfo.put("documentId", documentId);
        requestInfo.put("request", request);
        requestInfo.put("authHeader", authHeader != null ? "provided" : "missing");
        printRequest(requestInfo);

        try {
            // 1. 验证认证
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ProgressResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);

            // 验证token
            String tokenSql = "SELECT user_id FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, token);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ProgressResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) sessions.get(0).get("user_id");

            // 2. 验证文档权限
            String docSql = "SELECT * FROM documents WHERE document_id = ? AND user_id = ?";
            List<Map<String, Object>> documents = jdbcTemplate.queryForList(docSql, documentId, userId);

            if (documents.isEmpty()) {
                return ResponseEntity.status(HttpStatus.FORBIDDEN).body(
                        new ProgressResponse(false, "没有权限更新此文档的进度", null)
                );
            }

            // 3. 获取文档总页数
            String pageCountSql = "SELECT COUNT(*) as total_pages FROM document_pages WHERE document_id = ?";
            List<Map<String, Object>> pageCounts = jdbcTemplate.queryForList(pageCountSql, documentId);
            int totalPages = pageCounts.isEmpty() ? 0 : ((Number) pageCounts.get(0).get("total_pages")).intValue();

            // 4. 计算进度百分比
            double progressPercentage;
            if (request.getPercentage() != null) {
                progressPercentage = request.getPercentage();
            } else {
                progressPercentage = totalPages > 0 ? (request.getPage() * 100.0 / totalPages) : 0;
                progressPercentage = Math.min(100.0, Math.max(0.0, progressPercentage));
            }

            // 5. 更新文档阅读进度
            String updateDocSql = "UPDATE documents SET read_progress = ?, current_page = ?, last_read_at = NOW() " +
                    "WHERE document_id = ?";
            jdbcTemplate.update(updateDocSql, progressPercentage, request.getPage(), documentId);

            // 6. 更新阅读历史
            String historySql = "UPDATE reading_history SET page = ?, end_time = NOW() " +
                    "WHERE user_id = ? AND document_id = ? AND end_time IS NULL";
            int updated = jdbcTemplate.update(historySql, request.getPage(), userId, documentId);

            if (updated == 0) {
                // 如果没有正在进行的阅读历史，创建新的
                String insertHistorySql = "INSERT INTO reading_history (user_id, document_id, page, start_time) " +
                        "VALUES (?, ?, ?, NOW())";
                jdbcTemplate.update(insertHistorySql, userId, documentId, request.getPage());
            }

            // 7. 更新每日学习统计
            LocalDateTime now = LocalDateTime.now();
            String dateStr = now.toLocalDate().toString();

            String statsSql = "INSERT INTO daily_learning_stats (user_id, date, documents_read, pages_read, reading_time) " +
                    "VALUES (?, ?, 1, 1, ?) " +
                    "ON DUPLICATE KEY UPDATE " +
                    "documents_read = documents_read + 1, " +
                    "pages_read = pages_read + 1, " +
                    "reading_time = reading_time + COALESCE(?, 0)";

            jdbcTemplate.update(statsSql, userId, dateStr,
                    request.getReadingTime() != null ? request.getReadingTime() : 0,
                    request.getReadingTime() != null ? request.getReadingTime() : 0);

            // 8. 构建响应数据
            ProgressData progressData = new ProgressData();
            progressData.setDocumentId(documentId);
            progressData.setCurrentPage(request.getPage());
            progressData.setProgressPercentage(progressPercentage);
            progressData.setTotalReadingTime(request.getReadingTime() != null ? request.getReadingTime() : 0);
            progressData.setLastReadAt(LocalDateTime.now().toString());

            ProgressResponse response = new ProgressResponse(true, "阅读进度已更新", progressData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("更新阅读进度过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ProgressResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: ReaderUpdateReadingProgress.java ---

