--- 开始文件: UserCancelSubscription.java ---
package com.vue.readingapp.user;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user")
public class UserCancelSubscription {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到取消订阅请求 ===");
        System.out.println("请求信息");
        System.out.println("=================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class CancelSubscriptionResponse {
        private boolean success;
        private String message;
        private UserGetSubscriptionInfo.SubscriptionData subscription;

        public CancelSubscriptionResponse(boolean success, String message, UserGetSubscriptionInfo.SubscriptionData subscription) {
            this.success = success;
            this.message = message;
            this.subscription = subscription;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public UserGetSubscriptionInfo.SubscriptionData getSubscription() { return subscription; }
        public void setSubscription(UserGetSubscriptionInfo.SubscriptionData subscription) { this.subscription = subscription; }
    }

    @DeleteMapping("/subscription")
    public ResponseEntity<CancelSubscriptionResponse> cancelSubscription(
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        // 打印接收到的请求
        printRequest("Authorization: " + authHeader);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new CancelSubscriptionResponse(false, "请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 验证token有效性
            String tokenSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new CancelSubscriptionResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            int userId = (int) session.get("user_id");

            // 3. 查询用户当前订阅状态
            String userSql = "SELECT user_id, username, email, user_type, created_at FROM users WHERE user_id = ?";
            List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, userId);

            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new CancelSubscriptionResponse(false, "用户不存在", null)
                );
            }

            Map<String, Object> user = users.get(0);
            String currentUserType = user.get("user_type") != null ? (String) user.get("user_type") : "free";

            // 4. 检查用户是否已经是免费用户
            if ("free".equals(currentUserType)) {
                return ResponseEntity.badRequest().body(
                        new CancelSubscriptionResponse(false, "您当前已经是免费用户", null)
                );
            }

            // 5. 更新用户类型为免费用户
            String updateSql = "UPDATE users SET user_type = 'free' WHERE user_id = ?";
            int rowsUpdated = jdbcTemplate.update(updateSql, userId);

            printQueryResult("取消订阅行数: " + rowsUpdated);

            if (rowsUpdated == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new CancelSubscriptionResponse(false, "用户不存在", null)
                );
            }

            // 6. 查询更新后的用户信息
            List<Map<String, Object>> updatedUsers = jdbcTemplate.queryForList(userSql, userId);

            if (updatedUsers.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new CancelSubscriptionResponse(false, "用户不存在", null)
                );
            }

            Map<String, Object> updatedUser = updatedUsers.get(0);

            // 7. 构建订阅数据（现在是免费用户）
            UserGetSubscriptionInfo.SubscriptionData subscription = new UserGetSubscriptionInfo.SubscriptionData();

            // 设置订阅类型和状态
            subscription.setType("free");
            subscription.setStatus("inactive");

            // 设置日期信息
            LocalDateTime now = LocalDateTime.now();
            DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");

            // 假设订阅开始时间是用户注册时间
            LocalDateTime startDate = (LocalDateTime) updatedUser.get("created_at");
            subscription.setStartDate(startDate.format(formatter));
            subscription.setEndDate("");
            subscription.setRenewalDate("");
            subscription.setAutoRenew(false);

            // 8. 构建计划数据
            UserGetSubscriptionInfo.PlanData plan = new UserGetSubscriptionInfo.PlanData(
                    "free",
                    "免费版",
                    0.00,
                    "CNY",
                    "none",
                    "基础功能，包括有限文档管理、基础词汇学习、基本学习统计"
            );
            subscription.setPlan(plan);

            // 9. 构建功能列表
            List<UserGetSubscriptionInfo.FeatureData> features = new java.util.ArrayList<>();
            features.add(new UserGetSubscriptionInfo.FeatureData("有限文档", "最多上传10个文档", true));
            features.add(new UserGetSubscriptionInfo.FeatureData("基础词汇管理", "基本的词汇添加和查看", true));
            features.add(new UserGetSubscriptionInfo.FeatureData("基本学习统计", "查看基础的学习数据", true));
            features.add(new UserGetSubscriptionInfo.FeatureData("离线同步", "基础数据同步", false));
            features.add(new UserGetSubscriptionInfo.FeatureData("标准支持", "获得标准技术支持", true));

            subscription.setFeatures(features);

            // 10. 构建账单数据
            UserGetSubscriptionInfo.BillingData billing = new UserGetSubscriptionInfo.BillingData(
                    "",
                    0.00,
                    "",
                    0.00,
                    ""
            );
            subscription.setBilling(billing);

            // 11. 准备响应数据
            CancelSubscriptionResponse response = new CancelSubscriptionResponse(
                    true, "订阅已成功取消，您现在是免费用户", subscription);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("取消订阅过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new CancelSubscriptionResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: UserCancelSubscription.java ---

--- 开始文件: UserDeleteAccount.java ---
package com.vue.readingapp.user;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user")
public class UserDeleteAccount {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到删除账户请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class DeleteAccountRequest {
        private String password;

        public String getPassword() { return password; }
        public void setPassword(String password) { this.password = password; }
    }

    // 响应DTO
    public static class DeleteAccountResponse {
        private boolean success;
        private String message;

        public DeleteAccountResponse(boolean success, String message) {
            this.success = success;
            this.message = message;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }
    }

    @DeleteMapping("/account")
    public ResponseEntity<DeleteAccountResponse> deleteAccount(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestBody DeleteAccountRequest request) {

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new DeleteAccountResponse(false, "请先登录")
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 验证token有效性
            String tokenSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new DeleteAccountResponse(false, "登录已过期，请重新登录")
                );
            }

            Map<String, Object> session = sessions.get(0);
            int userId = (int) session.get("user_id");

            // 3. 验证密码
            if (request.getPassword() == null || request.getPassword().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new DeleteAccountResponse(false, "密码不能为空")
                );
            }

            // 查询用户密码
            String passwordSql = "SELECT password_hash FROM users WHERE user_id = ?";
            List<Map<String, Object>> users = jdbcTemplate.queryForList(passwordSql, userId);

            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new DeleteAccountResponse(false, "用户不存在")
                );
            }

            Map<String, Object> user = users.get(0);
            String passwordHash = (String) user.get("password_hash");

            // 验证密码（课设简单处理，实际应该使用加密验证）
            if (!passwordHash.equals(request.getPassword())) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new DeleteAccountResponse(false, "密码错误")
                );
            }

            // 4. 开始删除用户数据（注意外键约束，需要按顺序删除）

            // 4.1 删除用户会话
            String deleteSessionsSql = "DELETE FROM user_sessions WHERE user_id = ?";
            jdbcTemplate.update(deleteSessionsSql, userId);

            // 4.2 删除第三方登录
            String deleteThirdPartySql = "DELETE FROM third_party_logins WHERE user_id = ?";
            jdbcTemplate.update(deleteThirdPartySql, userId);

            // 4.3 删除密码重置令牌
            String deleteResetTokensSql = "DELETE FROM password_reset_tokens WHERE user_id = ?";
            jdbcTemplate.update(deleteResetTokensSql, userId);

            // 4.4 删除用户成就
            String deleteUserAchievementsSql = "DELETE FROM user_achievements WHERE user_id = ?";
            jdbcTemplate.update(deleteUserAchievementsSql, userId);

            // 4.5 删除每日学习统计
            String deleteDailyStatsSql = "DELETE FROM daily_learning_stats WHERE user_id = ?";
            jdbcTemplate.update(deleteDailyStatsSql, userId);

            // 4.6 删除词汇掌握统计
            String deleteVocabStatsSql = "DELETE FROM vocabulary_mastery_stats WHERE user_id = ?";
            jdbcTemplate.update(deleteVocabStatsSql, userId);

            // 4.7 删除用户生词本
            String deleteUserVocabularySql = "DELETE FROM user_vocabulary WHERE user_id = ?";
            jdbcTemplate.update(deleteUserVocabularySql, userId);

            // 4.8 删除用户生词标签关系
            String deleteUserVocabTagsSql = "DELETE FROM user_vocabulary_tags WHERE user_id = ?";
            jdbcTemplate.update(deleteUserVocabTagsSql, userId);

            // 4.9 删除复习会话
            String deleteReviewSessionsSql = "DELETE FROM review_sessions WHERE user_id = ?";
            jdbcTemplate.update(deleteReviewSessionsSql, userId);

            // 4.10 删除复习项目
            String deleteReviewItemsSql = "DELETE FROM review_items WHERE user_id = ?";
            jdbcTemplate.update(deleteReviewItemsSql, userId);

            // 4.11 删除间隔重复计划
            String deleteSpacedRepetitionSql = "DELETE FROM spaced_repetition_schedule WHERE user_id = ?";
            jdbcTemplate.update(deleteSpacedRepetitionSql, userId);

            // 4.12 删除测验问题
            String deleteQuizQuestionsSql = "DELETE FROM quiz_questions WHERE user_id = ?";
            jdbcTemplate.update(deleteQuizQuestionsSql, userId);

            // 4.13 删除文档高亮
            String deleteHighlightsSql = "DELETE FROM document_highlights WHERE user_id = ?";
            jdbcTemplate.update(deleteHighlightsSql, userId);

            // 4.14 删除文档笔记
            String deleteNotesSql = "DELETE FROM document_notes WHERE user_id = ?";
            jdbcTemplate.update(deleteNotesSql, userId);

            // 4.15 删除笔记附件
            String deleteNoteAttachmentsSql = "DELETE FROM note_attachments WHERE user_id = ?";
            jdbcTemplate.update(deleteNoteAttachmentsSql, userId);

            // 4.16 删除阅读历史
            String deleteReadingHistorySql = "DELETE FROM reading_history WHERE user_id = ?";
            jdbcTemplate.update(deleteReadingHistorySql, userId);

            // 4.17 删除单词查询历史
            String deleteWordLookupHistorySql = "DELETE FROM word_lookup_history WHERE user_id = ?";
            jdbcTemplate.update(deleteWordLookupHistorySql, userId);

            // 4.18 删除搜索历史
            String deleteSearchHistorySql = "DELETE FROM search_history WHERE user_id = ?";
            jdbcTemplate.update(deleteSearchHistorySql, userId);

            // 4.19 删除通知
            String deleteNotificationsSql = "DELETE FROM notifications WHERE user_id = ?";
            jdbcTemplate.update(deleteNotificationsSql, userId);

            // 4.20 删除反馈消息
            String deleteFeedbackMessagesSql = "DELETE FROM feedback_messages WHERE user_id = ?";
            jdbcTemplate.update(deleteFeedbackMessagesSql, userId);

            // 4.21 删除离线文档
            String deleteOfflineDocumentsSql = "DELETE FROM offline_documents WHERE user_id = ?";
            jdbcTemplate.update(deleteOfflineDocumentsSql, userId);

            // 4.22 删除同步日志
            String deleteSyncLogsSql = "DELETE FROM sync_logs WHERE user_id = ?";
            jdbcTemplate.update(deleteSyncLogsSql, userId);

            // 4.23 删除用户设置
            // 注意：根据数据库设计，可能有多个设置表
            String deleteUserSettingsSql = "DELETE FROM user_settings WHERE user_id = ?";
            jdbcTemplate.update(deleteUserSettingsSql, userId);

            String deleteReadingSettingsSql = "DELETE FROM reading_settings WHERE user_id = ?";
            jdbcTemplate.update(deleteReadingSettingsSql, userId);

            String deleteReviewSettingsSql = "DELETE FROM review_settings WHERE user_id = ?";
            jdbcTemplate.update(deleteReviewSettingsSql, userId);

            String deleteNotificationSettingsSql = "DELETE FROM notification_settings WHERE user_id = ?";
            jdbcTemplate.update(deleteNotificationSettingsSql, userId);

            // 4.24 删除文档标签关系
            String deleteDocTagRelationsSql = "DELETE FROM document_tag_relations WHERE user_id = ?";
            jdbcTemplate.update(deleteDocTagRelationsSql, userId);

            // 4.25 删除用户文档（注意：文档表可能有外键约束，需要先删除相关记录）
            // 先删除文档分页
            String deleteDocPagesSql = "DELETE FROM document_pages WHERE document_id IN (SELECT document_id FROM documents WHERE user_id = ?)";
            jdbcTemplate.update(deleteDocPagesSql, userId);

            // 删除文档处理队列
            String deleteProcessingQueueSql = "DELETE FROM document_processing_queue WHERE document_id IN (SELECT document_id FROM documents WHERE user_id = ?)";
            jdbcTemplate.update(deleteProcessingQueueSql, userId);

            // 删除文档分类关系
            String deleteDocCategoriesSql = "DELETE FROM document_categories WHERE document_id IN (SELECT document_id FROM documents WHERE user_id = ?)";
            jdbcTemplate.update(deleteDocCategoriesSql, userId);

            // 最后删除文档
            String deleteDocumentsSql = "DELETE FROM documents WHERE user_id = ?";
            jdbcTemplate.update(deleteDocumentsSql, userId);

            // 4.26 最后删除用户
            String deleteUserSql = "DELETE FROM users WHERE user_id = ?";
            int rowsDeleted = jdbcTemplate.update(deleteUserSql, userId);

            printQueryResult("删除用户行数: " + rowsDeleted);

            if (rowsDeleted == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new DeleteAccountResponse(false, "用户不存在")
                );
            }

            // 5. 准备响应数据
            DeleteAccountResponse response = new DeleteAccountResponse(true, "账户删除成功");

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("删除账户过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new DeleteAccountResponse(false, "服务器内部错误: " + e.getMessage())
            );
        }
    }
}

--- 结束文件: UserDeleteAccount.java ---

--- 开始文件: UserExportData.java ---
package com.vue.readingapp.user;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;

@RestController
@RequestMapping("/api/v1/user")
public class UserExportData {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到导出用户数据请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("=================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class ExportDataRequest {
        private String format;
        private List<String> dataTypes;

        public String getFormat() { return format; }
        public void setFormat(String format) { this.format = format; }

        public List<String> getDataTypes() { return dataTypes; }
        public void setDataTypes(List<String> dataTypes) { this.dataTypes = dataTypes; }
    }

    // 响应DTO
    public static class ExportDataResponse {
        private boolean success;
        private String message;
        private ExportData data;

        public ExportDataResponse(boolean success, String message, ExportData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public ExportData getData() { return data; }
        public void setData(ExportData data) { this.data = data; }
    }

    public static class ExportData {
        private String requestId;
        private String status;
        private String format;
        private String estimatedSize;
        private String downloadUrl;
        private String expiresAt;
        private String createdAt;

        public ExportData(String requestId, String status, String format, String estimatedSize,
                          String downloadUrl, String expiresAt, String createdAt) {
            this.requestId = requestId;
            this.status = status;
            this.format = format;
            this.estimatedSize = estimatedSize;
            this.downloadUrl = downloadUrl;
            this.expiresAt = expiresAt;
            this.createdAt = createdAt;
        }

        public String getRequestId() { return requestId; }
        public void setRequestId(String requestId) { this.requestId = requestId; }

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public String getFormat() { return format; }
        public void setFormat(String format) { this.format = format; }

        public String getEstimatedSize() { return estimatedSize; }
        public void setEstimatedSize(String estimatedSize) { this.estimatedSize = estimatedSize; }

        public String getDownloadUrl() { return downloadUrl; }
        public void setDownloadUrl(String downloadUrl) { this.downloadUrl = downloadUrl; }

        public String getExpiresAt() { return expiresAt; }
        public void setExpiresAt(String expiresAt) { this.expiresAt = expiresAt; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }
    }

    @GetMapping("/export-data")
    public ResponseEntity<ExportDataResponse> exportUserData(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestParam(value = "format", defaultValue = "json") String format,
            @RequestParam(value = "dataTypes", required = false) List<String> dataTypes) {

        // 打印接收到的请求
        Map<String, Object> params = new HashMap<>();
        params.put("format", format);
        params.put("dataTypes", dataTypes);
        printRequest(params);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ExportDataResponse(false, "请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 验证token有效性
            String tokenSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ExportDataResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            int userId = (int) session.get("user_id");

            // 3. 验证导出格式
            String[] validFormats = {"json", "csv", "xlsx"};
            boolean validFormat = false;
            for (String f : validFormats) {
                if (f.equals(format)) {
                    validFormat = true;
                    break;
                }
            }
            if (!validFormat) {
                format = "json";
            }

            // 4. 验证数据类型
            if (dataTypes == null || dataTypes.isEmpty()) {
                dataTypes = new ArrayList<>();
                dataTypes.add("profile");
                dataTypes.add("documents");
                dataTypes.add("vocabulary");
                dataTypes.add("reviews");
            }

            // 5. 生成请求ID
            String requestId = "export_" + System.currentTimeMillis() + "_" + userId;

            // 6. 估算数据大小
            int estimatedSize = 0;

            // 估算用户信息大小
            if (dataTypes.contains("profile")) {
                estimatedSize += 1024; // 约1KB
            }

            // 估算文档数据大小
            if (dataTypes.contains("documents")) {
                String docsCountSql = "SELECT COUNT(*) as count FROM documents WHERE user_id = ?";
                Map<String, Object> docsCountResult = jdbcTemplate.queryForMap(docsCountSql, userId);
                int docsCount = ((Number) docsCountResult.get("count")).intValue();
                estimatedSize += docsCount * 5120; // 每个文档约5KB
            }

            // 估算词汇数据大小
            if (dataTypes.contains("vocabulary")) {
                String vocabCountSql = "SELECT COUNT(*) as count FROM user_vocabulary WHERE user_id = ?";
                Map<String, Object> vocabCountResult = jdbcTemplate.queryForMap(vocabCountSql, userId);
                int vocabCount = ((Number) vocabCountResult.get("count")).intValue();
                estimatedSize += vocabCount * 1024; // 每个单词约1KB
            }

            // 估算复习数据大小
            if (dataTypes.contains("reviews")) {
                String reviewsCountSql = "SELECT COUNT(*) as count FROM review_sessions WHERE user_id = ?";
                Map<String, Object> reviewsCountResult = jdbcTemplate.queryForMap(reviewsCountSql, userId);
                int reviewsCount = ((Number) reviewsCountResult.get("count")).intValue();
                estimatedSize += reviewsCount * 2048; // 每次复习约2KB
            }

            // 格式化估算大小
            String formattedSize;
            if (estimatedSize < 1024) {
                formattedSize = estimatedSize + " B";
            } else if (estimatedSize < 1024 * 1024) {
                formattedSize = String.format("%.1f KB", estimatedSize / 1024.0);
            } else {
                formattedSize = String.format("%.1f MB", estimatedSize / (1024.0 * 1024.0));
            }

            // 7. 生成下载URL（简化处理，实际应该生成一个临时文件）
            String downloadUrl = "/api/user/download-export/" + requestId + "." + format;

            // 8. 设置过期时间（24小时后）
            LocalDateTime now = LocalDateTime.now();
            LocalDateTime expiresAt = now.plusHours(24);
            DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");

            // 9. 构建导出数据
            ExportData exportData = new ExportData(
                    requestId,
                    "processing",
                    format,
                    formattedSize,
                    downloadUrl,
                    expiresAt.format(formatter),
                    now.format(formatter)
            );

            printQueryResult(exportData);

            // 10. 准备响应数据
            ExportDataResponse response = new ExportDataResponse(
                    true, "用户数据导出请求已提交，请稍后查看下载链接", exportData);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("导出用户数据过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ExportDataResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: UserExportData.java ---

--- 开始文件: UserGetAchievements.java ---
package com.vue.readingapp.user;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;

@RestController
@RequestMapping("/api/v1/user")
public class UserGetAchievements {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取用户成就请求 ===");
        System.out.println("请求信息");
        System.out.println("=================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class AchievementsResponse {
        private boolean success;
        private String message;
        private List<AchievementData> achievements;

        public AchievementsResponse(boolean success, String message, List<AchievementData> achievements) {
            this.success = success;
            this.message = message;
            this.achievements = achievements;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public List<AchievementData> getAchievements() { return achievements; }
        public void setAchievements(List<AchievementData> achievements) { this.achievements = achievements; }
    }

    public static class AchievementData {
        private int id;
        private String name;
        private String description;
        private String icon;
        private boolean unlocked;
        private String unlockedAt;
        private int progress;
        private int total;
        private String formattedProgress;
        private String category;
        private int points;
        private String rarity;

        // Getters and Setters
        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }

        public String getIcon() { return icon; }
        public void setIcon(String icon) { this.icon = icon; }

        public boolean isUnlocked() { return unlocked; }
        public void setUnlocked(boolean unlocked) { this.unlocked = unlocked; }

        public String getUnlockedAt() { return unlockedAt; }
        public void setUnlockedAt(String unlockedAt) { this.unlockedAt = unlockedAt; }

        public int getProgress() { return progress; }
        public void setProgress(int progress) { this.progress = progress; }

        public int getTotal() { return total; }
        public void setTotal(int total) { this.total = total; }

        public String getFormattedProgress() { return formattedProgress; }
        public void setFormattedProgress(String formattedProgress) { this.formattedProgress = formattedProgress; }

        public String getCategory() { return category; }
        public void setCategory(String category) { this.category = category; }

        public int getPoints() { return points; }
        public void setPoints(int points) { this.points = points; }

        public String getRarity() { return rarity; }
        public void setRarity(String rarity) { this.rarity = rarity; }
    }

    @GetMapping("/achievements")
    public ResponseEntity<AchievementsResponse> getUserAchievements(
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        // 打印接收到的请求
        printRequest("Authorization: " + authHeader);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new AchievementsResponse(false, "请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 验证token有效性
            String tokenSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new AchievementsResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            int userId = (int) session.get("user_id");

            // 3. 查询所有成就
            String allAchievementsSql = "SELECT achievement_id, name, description, icon_url, category, points, rarity, " +
                    "total_required FROM learning_achievements ORDER BY category, points DESC";
            List<Map<String, Object>> allAchievements = jdbcTemplate.queryForList(allAchievementsSql);

            // 4. 查询用户已解锁的成就
            String userAchievementsSql = "SELECT ua.achievement_id, ua.unlocked_at, la.name, la.description, la.icon_url, " +
                    "la.category, la.points, la.rarity, la.total_required " +
                    "FROM user_achievements ua " +
                    "JOIN learning_achievements la ON ua.achievement_id = la.achievement_id " +
                    "WHERE ua.user_id = ?";
            List<Map<String, Object>> userAchievements = jdbcTemplate.queryForList(userAchievementsSql, userId);

            // 5. 构建成就列表
            List<AchievementData> achievements = new ArrayList<>();

            // 5.1 处理已解锁的成就
            for (Map<String, Object> userAchievement : userAchievements) {
                AchievementData achievement = new AchievementData();
                achievement.setId(((Number) userAchievement.get("achievement_id")).intValue());
                achievement.setName((String) userAchievement.get("name"));
                achievement.setDescription((String) userAchievement.get("description"));
                achievement.setIcon(userAchievement.get("icon_url") != null ? (String) userAchievement.get("icon_url") : "");
                achievement.setUnlocked(true);
                achievement.setUnlockedAt(userAchievement.get("unlocked_at") != null ? userAchievement.get("unlocked_at").toString() : "");
                achievement.setProgress(((Number) userAchievement.get("total_required")).intValue());
                achievement.setTotal(((Number) userAchievement.get("total_required")).intValue());
                achievement.setFormattedProgress("100%");
                achievement.setCategory((String) userAchievement.get("category"));
                achievement.setPoints(((Number) userAchievement.get("points")).intValue());
                achievement.setRarity((String) userAchievement.get("rarity"));

                achievements.add(achievement);
            }

            // 5.2 处理未解锁的成就
            for (Map<String, Object> allAchievement : allAchievements) {
                int achievementId = ((Number) allAchievement.get("achievement_id")).intValue();

                // 检查是否已经处理过（已解锁）
                boolean alreadyProcessed = false;
                for (AchievementData processed : achievements) {
                    if (processed.getId() == achievementId) {
                        alreadyProcessed = true;
                        break;
                    }
                }

                if (!alreadyProcessed) {
                    AchievementData achievement = new AchievementData();
                    achievement.setId(achievementId);
                    achievement.setName((String) allAchievement.get("name"));
                    achievement.setDescription((String) allAchievement.get("description"));
                    achievement.setIcon(allAchievement.get("icon_url") != null ? (String) allAchievement.get("icon_url") : "");
                    achievement.setUnlocked(false);
                    achievement.setUnlockedAt("");

                    // 根据成就类型计算进度
                    int totalRequired = ((Number) allAchievement.get("total_required")).intValue();
                    int progress = 0;

                    // 这里需要根据成就的具体要求查询用户进度
                    // 例如：如果是阅读时间成就，查询用户总阅读时间
                    // 如果是单词数量成就，查询用户已学单词数量
                    // 这里简化处理，随机生成一个进度
                    String category = (String) allAchievement.get("category");
                    if ("reading".equals(category)) {
                        // 阅读相关成就
                        String readingProgressSql = "SELECT COALESCE(SUM(TIMESTAMPDIFF(SECOND, start_time, end_time)), 0) as total_seconds " +
                                "FROM reading_history WHERE user_id = ?";
                        Map<String, Object> readingResult = jdbcTemplate.queryForMap(readingProgressSql, userId);
                        progress = ((Number) readingResult.get("total_seconds")).intValue() / 3600; // 转换为小时
                    } else if ("vocabulary".equals(category)) {
                        // 词汇相关成就
                        String vocabProgressSql = "SELECT COUNT(*) as count FROM user_vocabulary WHERE user_id = ?";
                        Map<String, Object> vocabResult = jdbcTemplate.queryForMap(vocabProgressSql, userId);
                        progress = ((Number) vocabResult.get("count")).intValue();
                    } else if ("review".equals(category)) {
                        // 复习相关成就
                        String reviewProgressSql = "SELECT COUNT(*) as count FROM review_sessions WHERE user_id = ? AND status = 'completed'";
                        Map<String, Object> reviewResult = jdbcTemplate.queryForMap(reviewProgressSql, userId);
                        progress = ((Number) reviewResult.get("count")).intValue();
                    }

                    // 确保进度不超过总数
                    if (progress > totalRequired) {
                        progress = totalRequired;
                    }

                    achievement.setProgress(progress);
                    achievement.setTotal(totalRequired);

                    // 格式化进度
                    if (totalRequired > 0) {
                        double percentage = (double) progress / totalRequired * 100;
                        achievement.setFormattedProgress(String.format("%.0f%%", percentage));
                    } else {
                        achievement.setFormattedProgress("0%");
                    }

                    achievement.setCategory(category);
                    achievement.setPoints(((Number) allAchievement.get("points")).intValue());
                    achievement.setRarity((String) allAchievement.get("rarity"));

                    achievements.add(achievement);
                }
            }

            printQueryResult("成就数量: " + achievements.size());

            // 6. 准备响应数据
            AchievementsResponse response = new AchievementsResponse(true, "获取用户成就成功", achievements);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取用户成就过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new AchievementsResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: UserGetAchievements.java ---

--- 开始文件: UserGetActivityLog.java ---
package com.vue.readingapp.user;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;

@RestController
@RequestMapping("/api/v1/user")
public class UserGetActivityLog {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取用户活动日志请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("=================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class ActivityLogResponse {
        private boolean success;
        private String message;
        private List<ActivityData> activities;
        private PaginationData pagination;

        public ActivityLogResponse(boolean success, String message, List<ActivityData> activities, PaginationData pagination) {
            this.success = success;
            this.message = message;
            this.activities = activities;
            this.pagination = pagination;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public List<ActivityData> getActivities() { return activities; }
        public void setActivities(List<ActivityData> activities) { this.activities = activities; }

        public PaginationData getPagination() { return pagination; }
        public void setPagination(PaginationData pagination) { this.pagination = pagination; }
    }

    public static class ActivityData {
        private int id;
        private String type;
        private String action;
        private String targetType;
        private int targetId;
        private String targetName;
        private Map<String, Object> details;
        private String timestamp;
        private String formattedTime;

        // Getters and Setters
        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public String getAction() { return action; }
        public void setAction(String action) { this.action = action; }

        public String getTargetType() { return targetType; }
        public void setTargetType(String targetType) { this.targetType = targetType; }

        public int getTargetId() { return targetId; }
        public void setTargetId(int targetId) { this.targetId = targetId; }

        public String getTargetName() { return targetName; }
        public void setTargetName(String targetName) { this.targetName = targetName; }

        public Map<String, Object> getDetails() { return details; }
        public void setDetails(Map<String, Object> details) { this.details = details; }

        public String getTimestamp() { return timestamp; }
        public void setTimestamp(String timestamp) { this.timestamp = timestamp; }

        public String getFormattedTime() { return formattedTime; }
        public void setFormattedTime(String formattedTime) { this.formattedTime = formattedTime; }
    }

    public static class PaginationData {
        private int page;
        private int pageSize;
        private int total;
        private int totalPages;

        public PaginationData(int page, int pageSize, int total, int totalPages) {
            this.page = page;
            this.pageSize = pageSize;
            this.total = total;
            this.totalPages = totalPages;
        }

        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public int getPageSize() { return pageSize; }
        public void setPageSize(int pageSize) { this.pageSize = pageSize; }

        public int getTotal() { return total; }
        public void setTotal(int total) { this.total = total; }

        public int getTotalPages() { return totalPages; }
        public void setTotalPages(int totalPages) { this.totalPages = totalPages; }
    }

    @GetMapping("/activity-log")
    public ResponseEntity<ActivityLogResponse> getUserActivityLog(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestParam(value = "page", defaultValue = "1") int page,
            @RequestParam(value = "pageSize", defaultValue = "20") int pageSize,
            @RequestParam(value = "type", required = false) String type,
            @RequestParam(value = "startDate", required = false) String startDate,
            @RequestParam(value = "endDate", required = false) String endDate) {

        // 打印接收到的请求
        Map<String, Object> params = new HashMap<>();
        params.put("page", page);
        params.put("pageSize", pageSize);
        params.put("type", type);
        params.put("startDate", startDate);
        params.put("endDate", endDate);
        printRequest(params);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ActivityLogResponse(false, "请先登录", null, null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 验证token有效性
            String tokenSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ActivityLogResponse(false, "登录已过期，请重新登录", null, null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            int userId = (int) session.get("user_id");

            // 3. 验证参数
            if (page < 1) {
                page = 1;
            }

            if (pageSize < 1 || pageSize > 100) {
                pageSize = 20;
            }

            // 4. 构建查询条件
            StringBuilder whereClause = new StringBuilder("WHERE user_id = ?");
            List<Object> queryParams = new ArrayList<>();
            queryParams.add(userId);

            if (type != null && !type.trim().isEmpty()) {
                whereClause.append(" AND type = ?");
                queryParams.add(type);
            }

            if (startDate != null && !startDate.trim().isEmpty()) {
                whereClause.append(" AND DATE(created_at) >= ?");
                queryParams.add(startDate);
            }

            if (endDate != null && !endDate.trim().isEmpty()) {
                whereClause.append(" AND DATE(created_at) <= ?");
                queryParams.add(endDate);
            }

            // 5. 查询总记录数
            String countSql = "SELECT COUNT(*) as total FROM reading_history " + whereClause;
            Map<String, Object> countResult = jdbcTemplate.queryForMap(countSql, queryParams.toArray());
            int total = ((Number) countResult.get("total")).intValue();
            int totalPages = (int) Math.ceil((double) total / pageSize);

            // 6. 查询活动数据
            String activitySql = "SELECT activity_id, type, action, target_type, target_id, target_name, " +
                    "details, created_at FROM reading_history " + whereClause +
                    " ORDER BY created_at DESC LIMIT ? OFFSET ?";

            // 添加分页参数
            List<Object> activityParams = new ArrayList<>(queryParams);
            activityParams.add(pageSize);
            activityParams.add((page - 1) * pageSize);

            List<Map<String, Object>> activityResults = jdbcTemplate.queryForList(activitySql, activityParams.toArray());
            printQueryResult("活动记录数: " + activityResults.size());

            // 7. 格式化活动数据
            List<ActivityData> activities = new ArrayList<>();
            DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");

            for (Map<String, Object> activity : activityResults) {
                ActivityData activityData = new ActivityData();
                activityData.setId(((Number) activity.get("activity_id")).intValue());
                activityData.setType((String) activity.get("type"));
                activityData.setAction((String) activity.get("action"));
                activityData.setTargetType((String) activity.get("target_type"));
                activityData.setTargetId(((Number) activity.get("target_id")).intValue());
                activityData.setTargetName((String) activity.get("target_name"));

                // 处理details字段（假设是JSON字符串）
                String detailsStr = (String) activity.get("details");
                Map<String, Object> details = new HashMap<>();
                if (detailsStr != null && !detailsStr.trim().isEmpty()) {
                    // 简化处理，实际应该解析JSON
                    details.put("raw", detailsStr);
                }
                activityData.setDetails(details);

                // 格式化时间
                LocalDateTime timestamp = (LocalDateTime) activity.get("created_at");
                activityData.setTimestamp(timestamp.format(formatter));
                activityData.setFormattedTime(formatRelativeTime(timestamp));

                activities.add(activityData);
            }

            // 8. 构建分页数据
            PaginationData pagination = new PaginationData(page, pageSize, total, totalPages);

            // 9. 准备响应数据
            ActivityLogResponse response = new ActivityLogResponse(true, "获取用户活动日志成功", activities, pagination);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取用户活动日志过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ActivityLogResponse(false, "服务器内部错误: " + e.getMessage(), null, null)
            );
        }
    }

    // 格式化相对时间
    private String formatRelativeTime(LocalDateTime date) {
        if (date == null) return "";

        LocalDateTime now = LocalDateTime.now();
        long diffSec = java.time.Duration.between(date, now).getSeconds();
        long diffMin = diffSec / 60;
        long diffHour = diffMin / 60;
        long diffDay = diffHour / 24;

        if (diffSec < 60) {
            return "刚刚";
        } else if (diffMin < 60) {
            return diffMin + "分钟前";
        } else if (diffHour < 24) {
            return diffHour + "小时前";
        } else if (diffDay < 7) {
            return diffDay + "天前";
        } else {
            return date.format(DateTimeFormatter.ofPattern("MM-dd"));
        }
    }
}

--- 结束文件: UserGetActivityLog.java ---

--- 开始文件: UserGetLearningCalendar.java ---
package com.vue.readingapp.user;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.time.YearMonth;
import java.time.format.DateTimeFormatter;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;

@RestController
@RequestMapping("/api/v1/user")
public class UserGetLearningCalendar {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取学习日历请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("=================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class LearningCalendarResponse {
        private boolean success;
        private String message;
        private CalendarData calendar;

        public LearningCalendarResponse(boolean success, String message, CalendarData calendar) {
            this.success = success;
            this.message = message;
            this.calendar = calendar;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public CalendarData getCalendar() { return calendar; }
        public void setCalendar(CalendarData calendar) { this.calendar = calendar; }
    }

    public static class CalendarData {
        private int year;
        private int month;
        private List<DayData> days;
        private int totalStudyDays;
        private int longestStreak;
        private int currentStreak;
        private Map<String, Integer> heatmapData;
        private MonthlyStats monthlyStats;

        // Getters and Setters
        public int getYear() { return year; }
        public void setYear(int year) { this.year = year; }

        public int getMonth() { return month; }
        public void setMonth(int month) { this.month = month; }

        public List<DayData> getDays() { return days; }
        public void setDays(List<DayData> days) { this.days = days; }

        public int getTotalStudyDays() { return totalStudyDays; }
        public void setTotalStudyDays(int totalStudyDays) { this.totalStudyDays = totalStudyDays; }

        public int getLongestStreak() { return longestStreak; }
        public void setLongestStreak(int longestStreak) { this.longestStreak = longestStreak; }

        public int getCurrentStreak() { return currentStreak; }
        public void setCurrentStreak(int currentStreak) { this.currentStreak = currentStreak; }

        public Map<String, Integer> getHeatmapData() { return heatmapData; }
        public void setHeatmapData(Map<String, Integer> heatmapData) { this.heatmapData = heatmapData; }

        public MonthlyStats getMonthlyStats() { return monthlyStats; }
        public void setMonthlyStats(MonthlyStats monthlyStats) { this.monthlyStats = monthlyStats; }
    }

    public static class DayData {
        private String date;
        private int readingTime;
        private int wordsLearned;
        private int reviewsCompleted;
        private boolean hasStudyData;

        public DayData(String date, int readingTime, int wordsLearned, int reviewsCompleted, boolean hasStudyData) {
            this.date = date;
            this.readingTime = readingTime;
            this.wordsLearned = wordsLearned;
            this.reviewsCompleted = reviewsCompleted;
            this.hasStudyData = hasStudyData;
        }

        public String getDate() { return date; }
        public void setDate(String date) { this.date = date; }

        public int getReadingTime() { return readingTime; }
        public void setReadingTime(int readingTime) { this.readingTime = readingTime; }

        public int getWordsLearned() { return wordsLearned; }
        public void setWordsLearned(int wordsLearned) { this.wordsLearned = wordsLearned; }

        public int getReviewsCompleted() { return reviewsCompleted; }
        public void setReviewsCompleted(int reviewsCompleted) { this.reviewsCompleted = reviewsCompleted; }

        public boolean isHasStudyData() { return hasStudyData; }
        public void setHasStudyData(boolean hasStudyData) { this.hasStudyData = hasStudyData; }
    }

    public static class MonthlyStats {
        private int totalReadingTime;
        private int documentsRead;
        private int wordsLearned;

        public MonthlyStats(int totalReadingTime, int documentsRead, int wordsLearned) {
            this.totalReadingTime = totalReadingTime;
            this.documentsRead = documentsRead;
            this.wordsLearned = wordsLearned;
        }

        public int getTotalReadingTime() { return totalReadingTime; }
        public void setTotalReadingTime(int totalReadingTime) { this.totalReadingTime = totalReadingTime; }

        public int getDocumentsRead() { return documentsRead; }
        public void setDocumentsRead(int documentsRead) { this.documentsRead = documentsRead; }

        public int getWordsLearned() { return wordsLearned; }
        public void setWordsLearned(int wordsLearned) { this.wordsLearned = wordsLearned; }
    }

    @GetMapping("/learning-calendar")
    public ResponseEntity<LearningCalendarResponse> getUserLearningCalendar(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestParam(value = "year", required = false) Integer year,
            @RequestParam(value = "month", required = false) Integer month) {

        // 打印接收到的请求
        Map<String, Object> params = new HashMap<>();
        params.put("year", year);
        params.put("month", month);
        printRequest(params);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new LearningCalendarResponse(false, "请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 验证token有效性
            String tokenSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new LearningCalendarResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            int userId = (int) session.get("user_id");

            // 3. 验证参数
            LocalDateTime now = LocalDateTime.now();
            if (year == null || year < 2000 || year > 2100) {
                year = now.getYear();
            }

            if (month == null || month < 1 || month > 12) {
                month = now.getMonthValue();
            }

            // 4. 计算日期范围
            YearMonth yearMonth = YearMonth.of(year, month);
            LocalDateTime startDate = yearMonth.atDay(1).atStartOfDay();
            LocalDateTime endDate = yearMonth.atEndOfMonth().atTime(23, 59, 59);

            // 5. 查询每日学习数据
            String dailySql = "SELECT DATE(created_at) as date, " +
                    "SUM(TIMESTAMPDIFF(SECOND, start_time, end_time)) as reading_time, " +
                    "COUNT(DISTINCT CASE WHEN type = 'vocabulary' THEN target_id END) as words_learned, " +
                    "COUNT(DISTINCT CASE WHEN type = 'review' THEN target_id END) as reviews_completed " +
                    "FROM reading_history " +
                    "WHERE user_id = ? AND created_at >= ? AND created_at <= ? " +
                    "GROUP BY DATE(created_at) ORDER BY date";

            List<Map<String, Object>> dailyResults = jdbcTemplate.queryForList(
                    dailySql, userId, startDate, endDate);

            // 6. 构建每日数据
            List<DayData> days = new ArrayList<>();
            Map<String, Integer> heatmapData = new HashMap<>();
            int totalStudyDays = 0;

            // 获取该月的天数
            int daysInMonth = yearMonth.lengthOfMonth();

            for (int day = 1; day <= daysInMonth; day++) {
                String dateStr = String.format("%04d-%02d-%02d", year, month, day);

                // 查找当天的数据
                int readingTime = 0;
                int wordsLearned = 0;
                int reviewsCompleted = 0;
                boolean hasStudyData = false;

                for (Map<String, Object> daily : dailyResults) {
                    String resultDate = daily.get("date").toString();
                    if (resultDate.equals(dateStr)) {
                        readingTime = ((Number) daily.get("reading_time")).intValue();
                        wordsLearned = ((Number) daily.get("words_learned")).intValue();
                        reviewsCompleted = ((Number) daily.get("reviews_completed")).intValue();
                        hasStudyData = true;
                        totalStudyDays++;
                        break;
                    }
                }

                // 添加热力图数据（使用阅读时间作为热力值）
                heatmapData.put(dateStr, readingTime);

                days.add(new DayData(dateStr, readingTime, wordsLearned, reviewsCompleted, hasStudyData));
            }

            // 7. 查询连续学习天数
            int currentStreak = calculateCurrentStreak(userId);
            int longestStreak = calculateLongestStreak(userId);

            // 8. 查询月度统计
            String monthlyStatsSql = "SELECT " +
                    "COALESCE(SUM(TIMESTAMPDIFF(SECOND, start_time, end_time)), 0) as total_reading_time, " +
                    "COUNT(DISTINCT document_id) as documents_read, " +
                    "COUNT(DISTINCT CASE WHEN type = 'vocabulary' THEN target_id END) as words_learned " +
                    "FROM reading_history " +
                    "WHERE user_id = ? AND created_at >= ? AND created_at <= ?";

            Map<String, Object> monthlyStatsResult = jdbcTemplate.queryForMap(
                    monthlyStatsSql, userId, startDate, endDate);

            MonthlyStats monthlyStats = new MonthlyStats(
                    ((Number) monthlyStatsResult.get("total_reading_time")).intValue(),
                    ((Number) monthlyStatsResult.get("documents_read")).intValue(),
                    ((Number) monthlyStatsResult.get("words_learned")).intValue()
            );

            // 9. 构建日历数据
            CalendarData calendar = new CalendarData();
            calendar.setYear(year);
            calendar.setMonth(month);
            calendar.setDays(days);
            calendar.setTotalStudyDays(totalStudyDays);
            calendar.setLongestStreak(longestStreak);
            calendar.setCurrentStreak(currentStreak);
            calendar.setHeatmapData(heatmapData);
            calendar.setMonthlyStats(monthlyStats);

            printQueryResult(calendar);

            // 10. 准备响应数据
            LearningCalendarResponse response = new LearningCalendarResponse(
                    true, "获取学习日历成功", calendar);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取学习日历过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new LearningCalendarResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    // 计算当前连续学习天数
    private int calculateCurrentStreak(int userId) {
        try {
            String streakSql = "SELECT COUNT(DISTINCT DATE(created_at)) as streak " +
                    "FROM reading_history " +
                    "WHERE user_id = ? AND created_at >= DATE_SUB(CURDATE(), INTERVAL 30 DAY) " +
                    "AND created_at <= CURDATE() " +
                    "AND TIMESTAMPDIFF(SECOND, start_time, end_time) > 0 " +
                    "ORDER BY DATE(created_at) DESC";

            Map<String, Object> streakResult = jdbcTemplate.queryForMap(streakSql, userId);
            return ((Number) streakResult.get("streak")).intValue();
        } catch (Exception e) {
            return 0;
        }
    }

    // 计算最长连续学习天数
    private int calculateLongestStreak(int userId) {
        try {
            String longestStreakSql = "SELECT MAX(streak_days) as longest_streak " +
                    "FROM daily_learning_stats WHERE user_id = ?";

            Map<String, Object> longestStreakResult = jdbcTemplate.queryForMap(longestStreakSql, userId);
            return ((Number) longestStreakResult.get("longest_streak")).intValue();
        } catch (Exception e) {
            return 0;
        }
    }
}

--- 结束文件: UserGetLearningCalendar.java ---

--- 开始文件: UserGetLearningGoals.java ---
package com.vue.readingapp.user;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;

@RestController
@RequestMapping("/api/v1/user")
public class UserGetLearningGoals {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取学习目标请求 ===");
        System.out.println("请求信息");
        System.out.println("=================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class LearningGoalsResponse {
        private boolean success;
        private String message;
        private List<GoalData> goals;

        public LearningGoalsResponse(boolean success, String message, List<GoalData> goals) {
            this.success = success;
            this.message = message;
            this.goals = goals;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public List<GoalData> getGoals() { return goals; }
        public void setGoals(List<GoalData> goals) { this.goals = goals; }
    }

    public static class GoalData {
        private int goalId;
        private String type;
        private String title;
        private String description;
        private int targetValue;
        private int currentValue;
        private String unit;
        private String startDate;
        private String endDate;
        private String status;
        private String createdDate;
        private String updatedDate;

        // Getters and Setters
        public int getGoalId() { return goalId; }
        public void setGoalId(int goalId) { this.goalId = goalId; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public String getTitle() { return title; }
        public void setTitle(String title) { this.title = title; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }

        public int getTargetValue() { return targetValue; }
        public void setTargetValue(int targetValue) { this.targetValue = targetValue; }

        public int getCurrentValue() { return currentValue; }
        public void setCurrentValue(int currentValue) { this.currentValue = currentValue; }

        public String getUnit() { return unit; }
        public void setUnit(String unit) { this.unit = unit; }

        public String getStartDate() { return startDate; }
        public void setStartDate(String startDate) { this.startDate = startDate; }

        public String getEndDate() { return endDate; }
        public void setEndDate(String endDate) { this.endDate = endDate; }

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public String getCreatedDate() { return createdDate; }
        public void setCreatedDate(String createdDate) { this.createdDate = createdDate; }

        public String getUpdatedDate() { return updatedDate; }
        public void setUpdatedDate(String updatedDate) { this.updatedDate = updatedDate; }
    }

    @GetMapping("/goals")
    public ResponseEntity<LearningGoalsResponse> getLearningGoals(
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        // 打印接收到的请求
        printRequest("Authorization: " + authHeader);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new LearningGoalsResponse(false, "请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 验证token有效性
            String tokenSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new LearningGoalsResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            int userId = (int) session.get("user_id");

            // 3. 查询用户的学习目标
            // 假设有一个learning_goals表存储学习目标
            // 如果没有这个表，我们返回一些默认目标

            // 检查表是否存在（简化处理）
            boolean goalsTableExists = false;
            try {
                jdbcTemplate.queryForObject("SELECT 1 FROM learning_goals LIMIT 1", Integer.class);
                goalsTableExists = true;
            } catch (Exception e) {
                goalsTableExists = false;
            }

            List<GoalData> goals = new ArrayList<>();

            if (goalsTableExists) {
                // 查询用户的学习目标
                String goalsSql = "SELECT goal_id, type, title, description, target_value, current_value, " +
                        "unit, start_date, end_date, status, created_at, updated_at " +
                        "FROM learning_goals WHERE user_id = ? ORDER BY created_at DESC";

                List<Map<String, Object>> goalsResults = jdbcTemplate.queryForList(goalsSql, userId);

                for (Map<String, Object> goal : goalsResults) {
                    GoalData goalData = new GoalData();
                    goalData.setGoalId(((Number) goal.get("goal_id")).intValue());
                    goalData.setType((String) goal.get("type"));
                    goalData.setTitle((String) goal.get("title"));
                    goalData.setDescription((String) goal.get("description"));
                    goalData.setTargetValue(((Number) goal.get("target_value")).intValue());
                    goalData.setCurrentValue(((Number) goal.get("current_value")).intValue());
                    goalData.setUnit((String) goal.get("unit"));

                    // 格式化日期
                    DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");

                    if (goal.get("start_date") != null) {
                        goalData.setStartDate(((LocalDateTime) goal.get("start_date")).format(formatter));
                    }

                    if (goal.get("end_date") != null) {
                        goalData.setEndDate(((LocalDateTime) goal.get("end_date")).format(formatter));
                    }

                    goalData.setStatus((String) goal.get("status"));

                    if (goal.get("created_at") != null) {
                        goalData.setCreatedDate(((LocalDateTime) goal.get("created_at")).format(formatter));
                    }

                    if (goal.get("updated_at") != null) {
                        goalData.setUpdatedDate(((LocalDateTime) goal.get("updated_at")).format(formatter));
                    }

                    goals.add(goalData);
                }
            }

            // 如果没有学习目标，返回一些默认目标
            if (goals.isEmpty()) {
                // 创建默认学习目标
                GoalData readingGoal = new GoalData();
                readingGoal.setGoalId(1);
                readingGoal.setType("reading");
                readingGoal.setTitle("每日阅读");
                readingGoal.setDescription("每天至少阅读30分钟");
                readingGoal.setTargetValue(30);
                readingGoal.setCurrentValue(0); // 需要查询实际数据
                readingGoal.setUnit("分钟");
                readingGoal.setStartDate(LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));
                readingGoal.setEndDate(LocalDateTime.now().plusMonths(1).format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));
                readingGoal.setStatus("active");
                readingGoal.setCreatedDate(LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));
                readingGoal.setUpdatedDate(LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));

                GoalData vocabularyGoal = new GoalData();
                vocabularyGoal.setGoalId(2);
                vocabularyGoal.setType("vocabulary");
                vocabularyGoal.setTitle("每周学习新单词");
                vocabularyGoal.setDescription("每周学习至少50个新单词");
                vocabularyGoal.setTargetValue(50);
                vocabularyGoal.setCurrentValue(0); // 需要查询实际数据
                vocabularyGoal.setUnit("个");
                vocabularyGoal.setStartDate(LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));
                vocabularyGoal.setEndDate(LocalDateTime.now().plusWeeks(1).format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));
                vocabularyGoal.setStatus("active");
                vocabularyGoal.setCreatedDate(LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));
                vocabularyGoal.setUpdatedDate(LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));

                GoalData reviewGoal = new GoalData();
                reviewGoal.setGoalId(3);
                reviewGoal.setType("review");
                reviewGoal.setTitle("每日复习");
                reviewGoal.setDescription("每天复习至少20个单词");
                reviewGoal.setTargetValue(20);
                reviewGoal.setCurrentValue(0); // 需要查询实际数据
                reviewGoal.setUnit("个");
                reviewGoal.setStartDate(LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));
                reviewGoal.setEndDate(LocalDateTime.now().plusDays(1).format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));
                reviewGoal.setStatus("active");
                reviewGoal.setCreatedDate(LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));
                reviewGoal.setUpdatedDate(LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));

                goals.add(readingGoal);
                goals.add(vocabularyGoal);
                goals.add(reviewGoal);
            }

            printQueryResult("学习目标数量: " + goals.size());

            // 4. 准备响应数据
            LearningGoalsResponse response = new LearningGoalsResponse(
                    true, "获取学习目标成功", goals);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取学习目标过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new LearningGoalsResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: UserGetLearningGoals.java ---

--- 开始文件: UserGetLearningReport.java ---
package com.vue.readingapp.user;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;

@RestController
@RequestMapping("/api/v1/user")
public class UserGetLearningReport {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取学习报告请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("=================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class LearningReportResponse {
        private boolean success;
        private String message;
        private ReportData report;

        public LearningReportResponse(boolean success, String message, ReportData report) {
            this.success = success;
            this.message = message;
            this.report = report;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public ReportData getReport() { return report; }
        public void setReport(ReportData report) { this.report = report; }
    }

    public static class ReportData {
        private String period;
        private String startDate;
        private String endDate;
        private SummaryData summary;
        private List<DailyData> dailyBreakdown;
        private List<TopWordData> topWords;
        private Map<String, Object> readingPatterns;
        private List<String> recommendations;
        private String generatedAt;

        // Getters and Setters
        public String getPeriod() { return period; }
        public void setPeriod(String period) { this.period = period; }

        public String getStartDate() { return startDate; }
        public void setStartDate(String startDate) { this.startDate = startDate; }

        public String getEndDate() { return endDate; }
        public void setEndDate(String endDate) { this.endDate = endDate; }

        public SummaryData getSummary() { return summary; }
        public void setSummary(SummaryData summary) { this.summary = summary; }

        public List<DailyData> getDailyBreakdown() { return dailyBreakdown; }
        public void setDailyBreakdown(List<DailyData> dailyBreakdown) { this.dailyBreakdown = dailyBreakdown; }

        public List<TopWordData> getTopWords() { return topWords; }
        public void setTopWords(List<TopWordData> topWords) { this.topWords = topWords; }

        public Map<String, Object> getReadingPatterns() { return readingPatterns; }
        public void setReadingPatterns(Map<String, Object> readingPatterns) { this.readingPatterns = readingPatterns; }

        public List<String> getRecommendations() { return recommendations; }
        public void setRecommendations(List<String> recommendations) { this.recommendations = recommendations; }

        public String getGeneratedAt() { return generatedAt; }
        public void setGeneratedAt(String generatedAt) { this.generatedAt = generatedAt; }
    }

    public static class SummaryData {
        private int totalReadingTime;
        private int documentsRead;
        private int wordsLearned;
        private int reviewsCompleted;

        public SummaryData(int totalReadingTime, int documentsRead, int wordsLearned, int reviewsCompleted) {
            this.totalReadingTime = totalReadingTime;
            this.documentsRead = documentsRead;
            this.wordsLearned = wordsLearned;
            this.reviewsCompleted = reviewsCompleted;
        }

        public int getTotalReadingTime() { return totalReadingTime; }
        public void setTotalReadingTime(int totalReadingTime) { this.totalReadingTime = totalReadingTime; }

        public int getDocumentsRead() { return documentsRead; }
        public void setDocumentsRead(int documentsRead) { this.documentsRead = documentsRead; }

        public int getWordsLearned() { return wordsLearned; }
        public void setWordsLearned(int wordsLearned) { this.wordsLearned = wordsLearned; }

        public int getReviewsCompleted() { return reviewsCompleted; }
        public void setReviewsCompleted(int reviewsCompleted) { this.reviewsCompleted = reviewsCompleted; }
    }

    public static class DailyData {
        private String date;
        private int readingTime;
        private int wordsLearned;
        private int reviewsCompleted;

        public DailyData(String date, int readingTime, int wordsLearned, int reviewsCompleted) {
            this.date = date;
            this.readingTime = readingTime;
            this.wordsLearned = wordsLearned;
            this.reviewsCompleted = reviewsCompleted;
        }

        public String getDate() { return date; }
        public void setDate(String date) { this.date = date; }

        public int getReadingTime() { return readingTime; }
        public void setReadingTime(int readingTime) { this.readingTime = readingTime; }

        public int getWordsLearned() { return wordsLearned; }
        public void setWordsLearned(int wordsLearned) { this.wordsLearned = wordsLearned; }

        public int getReviewsCompleted() { return reviewsCompleted; }
        public void setReviewsCompleted(int reviewsCompleted) { this.reviewsCompleted = reviewsCompleted; }
    }

    public static class TopWordData {
        private String word;
        private int frequency;
        private String meaning;

        public TopWordData(String word, int frequency, String meaning) {
            this.word = word;
            this.frequency = frequency;
            this.meaning = meaning;
        }

        public String getWord() { return word; }
        public void setWord(String word) { this.word = word; }

        public int getFrequency() { return frequency; }
        public void setFrequency(int frequency) { this.frequency = frequency; }

        public String getMeaning() { return meaning; }
        public void setMeaning(String meaning) { this.meaning = meaning; }
    }

    @GetMapping("/learning-report")
    public ResponseEntity<LearningReportResponse> getLearningReport(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestParam(value = "period", defaultValue = "month") String period,
            @RequestParam(value = "language", required = false) String language) {

        // 打印接收到的请求
        Map<String, String> params = new HashMap<>();
        params.put("period", period);
        params.put("language", language);
        printRequest(params);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new LearningReportResponse(false, "请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 验证token有效性
            String tokenSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new LearningReportResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            int userId = (int) session.get("user_id");

            // 3. 验证周期参数
            String[] validPeriods = {"week", "month", "quarter", "year"};
            boolean validPeriod = false;
            for (String p : validPeriods) {
                if (p.equals(period)) {
                    validPeriod = true;
                    break;
                }
            }
            if (!validPeriod) {
                period = "month";
            }

            // 4. 根据周期计算日期范围
            LocalDateTime now = LocalDateTime.now();
            LocalDateTime startDate = now;
            LocalDateTime endDate = now;

            switch (period) {
                case "week":
                    startDate = now.minusDays(7);
                    break;
                case "month":
                    startDate = now.minusDays(30);
                    break;
                case "quarter":
                    startDate = now.minusDays(90);
                    break;
                case "year":
                    startDate = now.minusDays(365);
                    break;
            }

            DateTimeFormatter dateFormatter = DateTimeFormatter.ofPattern("yyyy-MM-dd");

            // 5. 构建报告数据
            ReportData report = new ReportData();
            report.setPeriod(period);
            report.setStartDate(startDate.format(dateFormatter));
            report.setEndDate(endDate.format(dateFormatter));
            report.setGeneratedAt(now.format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));

            // 6. 查询总结数据
            // 6.1 总阅读时间（秒）
            String readingTimeSql = "SELECT COALESCE(SUM(TIMESTAMPDIFF(SECOND, start_time, end_time)), 0) as total_seconds " +
                    "FROM reading_history WHERE user_id = ? AND created_at >= ? AND created_at <= ?";
            Map<String, Object> readingTimeResult = jdbcTemplate.queryForMap(readingTimeSql, userId, startDate, endDate);
            int totalReadingTime = ((Number) readingTimeResult.get("total_seconds")).intValue();

            // 6.2 已读文档数量
            String docsSql = "SELECT COUNT(DISTINCT document_id) as count FROM reading_history " +
                    "WHERE user_id = ? AND created_at >= ? AND created_at <= ?";
            Map<String, Object> docsResult = jdbcTemplate.queryForMap(docsSql, userId, startDate, endDate);
            int documentsRead = ((Number) docsResult.get("count")).intValue();

            // 6.3 已学单词数量（在这个时间段内添加的）
            String wordsSql = "SELECT COUNT(*) as count FROM user_vocabulary " +
                    "WHERE user_id = ? AND created_at >= ? AND created_at <= ?";
            Map<String, Object> wordsResult = jdbcTemplate.queryForMap(wordsSql, userId, startDate, endDate);
            int wordsLearned = ((Number) wordsResult.get("count")).intValue();

            // 6.4 已完成复习数量
            String reviewsSql = "SELECT COUNT(*) as count FROM review_sessions " +
                    "WHERE user_id = ? AND status = 'completed' AND created_at >= ? AND created_at <= ?";
            Map<String, Object> reviewsResult = jdbcTemplate.queryForMap(reviewsSql, userId, startDate, endDate);
            int reviewsCompleted = ((Number) reviewsResult.get("count")).intValue();

            SummaryData summary = new SummaryData(totalReadingTime, documentsRead, wordsLearned, reviewsCompleted);
            report.setSummary(summary);

            // 7. 查询每日数据
            List<DailyData> dailyBreakdown = new ArrayList<>();
            String dailySql = "SELECT DATE(created_at) as date, " +
                    "SUM(TIMESTAMPDIFF(SECOND, start_time, end_time)) as reading_time, " +
                    "COUNT(DISTINCT CASE WHEN type = 'vocabulary' THEN target_id END) as words_learned, " +
                    "COUNT(DISTINCT CASE WHEN type = 'review' THEN target_id END) as reviews_completed " +
                    "FROM reading_history " +
                    "WHERE user_id = ? AND created_at >= ? AND created_at <= ? " +
                    "GROUP BY DATE(created_at) ORDER BY date DESC";

            List<Map<String, Object>> dailyResults = jdbcTemplate.queryForList(dailySql, userId, startDate, endDate);

            for (Map<String, Object> daily : dailyResults) {
                String date = daily.get("date").toString();
                int readingTime = ((Number) daily.get("reading_time")).intValue();
                int wordsLearnedDaily = ((Number) daily.get("words_learned")).intValue();
                int reviewsCompletedDaily = ((Number) daily.get("reviews_completed")).intValue();

                dailyBreakdown.add(new DailyData(date, readingTime, wordsLearnedDaily, reviewsCompletedDaily));
            }

            report.setDailyBreakdown(dailyBreakdown);

            // 8. 查询热门单词
            List<TopWordData> topWords = new ArrayList<>();
            String topWordsSql = "SELECT w.word, COUNT(*) as frequency, wd.meaning " +
                    "FROM word_lookup_history wlh " +
                    "JOIN words w ON wlh.word_id = w.word_id " +
                    "LEFT JOIN word_definitions wd ON w.word_id = wd.word_id AND wd.is_primary = TRUE " +
                    "WHERE wlh.user_id = ? AND wlh.created_at >= ? AND wlh.created_at <= ? " +
                    "GROUP BY w.word_id, w.word, wd.meaning " +
                    "ORDER BY frequency DESC LIMIT 10";

            List<Map<String, Object>> topWordsResults = jdbcTemplate.queryForList(topWordsSql, userId, startDate, endDate);

            for (Map<String, Object> topWord : topWordsResults) {
                String word = (String) topWord.get("word");
                int frequency = ((Number) topWord.get("frequency")).intValue();
                String meaning = topWord.get("meaning") != null ? (String) topWord.get("meaning") : "";

                topWords.add(new TopWordData(word, frequency, meaning));
            }

            report.setTopWords(topWords);

            // 9. 阅读模式分析（简化处理）
            Map<String, Object> readingPatterns = new HashMap<>();

            // 9.1 最活跃的时间段
            String activeTimeSql = "SELECT HOUR(created_at) as hour, COUNT(*) as count " +
                    "FROM reading_history " +
                    "WHERE user_id = ? AND created_at >= ? AND created_at <= ? " +
                    "GROUP BY HOUR(created_at) ORDER BY count DESC LIMIT 1";

            List<Map<String, Object>> activeTimeResults = jdbcTemplate.queryForList(activeTimeSql, userId, startDate, endDate);
            if (!activeTimeResults.isEmpty()) {
                readingPatterns.put("mostActiveHour", activeTimeResults.get(0).get("hour"));
            }

            // 9.2 最常阅读的语言
            String languageSql = "SELECT d.language, COUNT(*) as count " +
                    "FROM reading_history rh " +
                    "JOIN documents d ON rh.document_id = d.document_id " +
                    "WHERE rh.user_id = ? AND rh.created_at >= ? AND rh.created_at <= ? " +
                    "GROUP BY d.language ORDER BY count DESC LIMIT 1";

            List<Map<String, Object>> languageResults = jdbcTemplate.queryForList(languageSql, userId, startDate, endDate);
            if (!languageResults.isEmpty()) {
                readingPatterns.put("mostReadLanguage", languageResults.get(0).get("language"));
            }

            report.setReadingPatterns(readingPatterns);

            // 10. 生成建议
            List<String> recommendations = new ArrayList<>();

            if (totalReadingTime < 3600) { // 少于1小时
                recommendations.add("建议增加每日阅读时间，目标每天至少阅读30分钟");
            }

            if (wordsLearned < 10) {
                recommendations.add("建议在学习过程中多标记生词，扩大词汇量");
            }

            if (reviewsCompleted < 5) {
                recommendations.add("定期复习已学单词，巩固记忆效果");
            }

            if (dailyBreakdown.size() < 7 && period.equals("week")) {
                recommendations.add("尝试保持每日学习的习惯，建立学习连续性");
            }

            report.setRecommendations(recommendations);

            printQueryResult(report);

            // 11. 准备响应数据
            LearningReportResponse response = new LearningReportResponse(true, "获取学习报告成功", report);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取学习报告过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new LearningReportResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: UserGetLearningReport.java ---

--- 开始文件: UserGetLearningStats.java ---
package com.vue.readingapp.user;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user")
public class UserGetLearningStats {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取学习统计请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("=================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class LearningStatsResponse {
        private boolean success;
        private String message;
        private LearningStatsData stats;

        public LearningStatsResponse(boolean success, String message, LearningStatsData stats) {
            this.success = success;
            this.message = message;
            this.stats = stats;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public LearningStatsData getStats() { return stats; }
        public void setStats(LearningStatsData stats) { this.stats = stats; }
    }

    public static class LearningStatsData {
        private int totalReadingTime;
        private String formattedReadingTime;
        private int documentsRead;
        private int wordsLearned;
        private int reviewsCompleted;
        private double reviewAccuracy;
        private String formattedReviewAccuracy;
        private int streakDays;
        private int longestStreak;
        private TodayProgress todayProgress;
        private WeeklyProgress weeklyProgress;
        private MonthlyProgress monthlyProgress;
        private Map<String, Object> byLanguage;
        private int achievementsUnlocked;
        private int totalAchievements;

        public LearningStatsData() {
            this.todayProgress = new TodayProgress();
            this.weeklyProgress = new WeeklyProgress();
            this.monthlyProgress = new MonthlyProgress();
            this.byLanguage = new HashMap<>();
        }

        // Getters and Setters
        public int getTotalReadingTime() { return totalReadingTime; }
        public void setTotalReadingTime(int totalReadingTime) { this.totalReadingTime = totalReadingTime; }

        public String getFormattedReadingTime() { return formattedReadingTime; }
        public void setFormattedReadingTime(String formattedReadingTime) { this.formattedReadingTime = formattedReadingTime; }

        public int getDocumentsRead() { return documentsRead; }
        public void setDocumentsRead(int documentsRead) { this.documentsRead = documentsRead; }

        public int getWordsLearned() { return wordsLearned; }
        public void setWordsLearned(int wordsLearned) { this.wordsLearned = wordsLearned; }

        public int getReviewsCompleted() { return reviewsCompleted; }
        public void setReviewsCompleted(int reviewsCompleted) { this.reviewsCompleted = reviewsCompleted; }

        public double getReviewAccuracy() { return reviewAccuracy; }
        public void setReviewAccuracy(double reviewAccuracy) { this.reviewAccuracy = reviewAccuracy; }

        public String getFormattedReviewAccuracy() { return formattedReviewAccuracy; }
        public void setFormattedReviewAccuracy(String formattedReviewAccuracy) { this.formattedReviewAccuracy = formattedReviewAccuracy; }

        public int getStreakDays() { return streakDays; }
        public void setStreakDays(int streakDays) { this.streakDays = streakDays; }

        public int getLongestStreak() { return longestStreak; }
        public void setLongestStreak(int longestStreak) { this.longestStreak = longestStreak; }

        public TodayProgress getTodayProgress() { return todayProgress; }
        public void setTodayProgress(TodayProgress todayProgress) { this.todayProgress = todayProgress; }

        public WeeklyProgress getWeeklyProgress() { return weeklyProgress; }
        public void setWeeklyProgress(WeeklyProgress weeklyProgress) { this.weeklyProgress = weeklyProgress; }

        public MonthlyProgress getMonthlyProgress() { return monthlyProgress; }
        public void setMonthlyProgress(MonthlyProgress monthlyProgress) { this.monthlyProgress = monthlyProgress; }

        public Map<String, Object> getByLanguage() { return byLanguage; }
        public void setByLanguage(Map<String, Object> byLanguage) { this.byLanguage = byLanguage; }

        public int getAchievementsUnlocked() { return achievementsUnlocked; }
        public void setAchievementsUnlocked(int achievementsUnlocked) { this.achievementsUnlocked = achievementsUnlocked; }

        public int getTotalAchievements() { return totalAchievements; }
        public void setTotalAchievements(int totalAchievements) { this.totalAchievements = totalAchievements; }
    }

    public static class TodayProgress {
        private int readingTime = 0;
        private int wordsLearned = 0;
        private int reviewsCompleted = 0;

        public int getReadingTime() { return readingTime; }
        public void setReadingTime(int readingTime) { this.readingTime = readingTime; }

        public int getWordsLearned() { return wordsLearned; }
        public void setWordsLearned(int wordsLearned) { this.wordsLearned = wordsLearned; }

        public int getReviewsCompleted() { return reviewsCompleted; }
        public void setReviewsCompleted(int reviewsCompleted) { this.reviewsCompleted = reviewsCompleted; }
    }

    public static class WeeklyProgress {
        private int readingTime = 0;
        private int wordsLearned = 0;
        private int reviewsCompleted = 0;

        public int getReadingTime() { return readingTime; }
        public void setReadingTime(int readingTime) { this.readingTime = readingTime; }

        public int getWordsLearned() { return wordsLearned; }
        public void setWordsLearned(int wordsLearned) { this.wordsLearned = wordsLearned; }

        public int getReviewsCompleted() { return reviewsCompleted; }
        public void setReviewsCompleted(int reviewsCompleted) { this.reviewsCompleted = reviewsCompleted; }
    }

    public static class MonthlyProgress {
        private int readingTime = 0;
        private int wordsLearned = 0;
        private int reviewsCompleted = 0;

        public int getReadingTime() { return readingTime; }
        public void setReadingTime(int readingTime) { this.readingTime = readingTime; }

        public int getWordsLearned() { return wordsLearned; }
        public void setWordsLearned(int wordsLearned) { this.wordsLearned = wordsLearned; }

        public int getReviewsCompleted() { return reviewsCompleted; }
        public void setReviewsCompleted(int reviewsCompleted) { this.reviewsCompleted = reviewsCompleted; }
    }

    @GetMapping("/learning-stats")
    public ResponseEntity<LearningStatsResponse> getLearningStats(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestParam(value = "period", defaultValue = "week") String period,
            @RequestParam(value = "language", required = false) String language,
            @RequestParam(value = "startDate", required = false) String startDate,
            @RequestParam(value = "endDate", required = false) String endDate) {

        // 打印接收到的请求
        Map<String, String> params = new HashMap<>();
        params.put("period", period);
        params.put("language", language);
        params.put("startDate", startDate);
        params.put("endDate", endDate);
        printRequest(params);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new LearningStatsResponse(false, "请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 验证token有效性
            String tokenSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new LearningStatsResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            int userId = (int) session.get("user_id");

            // 3. 验证周期参数
            String[] validPeriods = {"day", "week", "month", "year", "all"};
            boolean validPeriod = false;
            for (String p : validPeriods) {
                if (p.equals(period)) {
                    validPeriod = true;
                    break;
                }
            }
            if (!validPeriod) {
                period = "week";
            }

            // 4. 查询学习统计
            LearningStatsData stats = new LearningStatsData();

            // 4.1 查询总阅读时间（从reading_history表）
            String readingTimeSql = "SELECT COALESCE(SUM(TIMESTAMPDIFF(SECOND, start_time, end_time)), 0) as total_seconds " +
                    "FROM reading_history WHERE user_id = ?";
            Map<String, Object> readingTimeResult = jdbcTemplate.queryForMap(readingTimeSql, userId);
            int totalSeconds = ((Number) readingTimeResult.get("total_seconds")).intValue();
            stats.setTotalReadingTime(totalSeconds);
            stats.setFormattedReadingTime(formatDuration(totalSeconds));

            // 4.2 查询已读文档数量
            String docsSql = "SELECT COUNT(DISTINCT document_id) as count FROM reading_history WHERE user_id = ?";
            Map<String, Object> docsResult = jdbcTemplate.queryForMap(docsSql, userId);
            stats.setDocumentsRead(((Number) docsResult.get("count")).intValue());

            // 4.3 查询已学单词数量
            String wordsSql = "SELECT COUNT(*) as count FROM user_vocabulary WHERE user_id = ?";
            Map<String, Object> wordsResult = jdbcTemplate.queryForMap(wordsSql, userId);
            stats.setWordsLearned(((Number) wordsResult.get("count")).intValue());

            // 4.4 查询已完成复习数量
            String reviewsSql = "SELECT COUNT(*) as count FROM review_sessions WHERE user_id = ? AND status = 'completed'";
            Map<String, Object> reviewsResult = jdbcTemplate.queryForMap(reviewsSql, userId);
            stats.setReviewsCompleted(((Number) reviewsResult.get("count")).intValue());

            // 4.5 查询复习准确率
            String accuracySql = "SELECT COALESCE(AVG(accuracy), 0) as avg_accuracy FROM review_sessions " +
                    "WHERE user_id = ? AND status = 'completed'";
            Map<String, Object> accuracyResult = jdbcTemplate.queryForMap(accuracySql, userId);
            double accuracy = ((Number) accuracyResult.get("avg_accuracy")).doubleValue();
            stats.setReviewAccuracy(accuracy);
            stats.setFormattedReviewAccuracy(formatPercentage(accuracy, 100, 1));

            // 4.6 查询连续学习天数
            String streakSql = "SELECT MAX(streak_days) as max_streak FROM daily_learning_stats WHERE user_id = ?";
            Map<String, Object> streakResult = jdbcTemplate.queryForMap(streakSql, userId);
            stats.setLongestStreak(((Number) streakResult.get("max_streak")).intValue());

            // 4.7 查询今日进度
            String todaySql = "SELECT reading_time, words_learned, reviews_completed FROM daily_learning_stats " +
                    "WHERE user_id = ? AND date = CURDATE()";
            List<Map<String, Object>> todayResults = jdbcTemplate.queryForList(todaySql, userId);
            if (!todayResults.isEmpty()) {
                Map<String, Object> today = todayResults.get(0);
                stats.getTodayProgress().setReadingTime(((Number) today.get("reading_time")).intValue());
                stats.getTodayProgress().setWordsLearned(((Number) today.get("words_learned")).intValue());
                stats.getTodayProgress().setReviewsCompleted(((Number) today.get("reviews_completed")).intValue());
            }

            // 4.8 查询按语言统计
            String languageSql = "SELECT language, COUNT(*) as count FROM documents d " +
                    "JOIN reading_history rh ON d.document_id = rh.document_id " +
                    "WHERE rh.user_id = ? GROUP BY language";
            List<Map<String, Object>> languageResults = jdbcTemplate.queryForList(languageSql, userId);
            for (Map<String, Object> lang : languageResults) {
                stats.getByLanguage().put((String) lang.get("language"), lang.get("count"));
            }

            // 4.9 查询成就数量
            String achievementsSql = "SELECT COUNT(*) as unlocked FROM user_achievements WHERE user_id = ?";
            Map<String, Object> achievementsResult = jdbcTemplate.queryForMap(achievementsSql, userId);
            stats.setAchievementsUnlocked(((Number) achievementsResult.get("unlocked")).intValue());

            // 总成就数量
            String totalAchievementsSql = "SELECT COUNT(*) as total FROM learning_achievements";
            Map<String, Object> totalAchievementsResult = jdbcTemplate.queryForMap(totalAchievementsSql);
            stats.setTotalAchievements(((Number) totalAchievementsResult.get("total")).intValue());

            printQueryResult(stats);

            // 5. 准备响应数据
            LearningStatsResponse response = new LearningStatsResponse(true, "获取学习统计成功", stats);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取学习统计过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new LearningStatsResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    // 格式化持续时间
    private String formatDuration(int seconds) {
        if (seconds < 60) {
            return seconds + "秒";
        } else if (seconds < 3600) {
            int minutes = seconds / 60;
            return minutes + "分钟";
        } else if (seconds < 86400) {
            int hours = seconds / 3600;
            int remainingMinutes = (seconds % 3600) / 60;
            return hours + "小时" + (remainingMinutes > 0 ? remainingMinutes + "分钟" : "");
        } else {
            int days = seconds / 86400;
            int remainingHours = (seconds % 86400) / 3600;
            return days + "天" + (remainingHours > 0 ? remainingHours + "小时" : "");
        }
    }

    // 格式化百分比
    private String formatPercentage(double value, double total, int decimals) {
        if (total == 0) return "0%";
        double percentage = (value / total) * 100;
        return String.format("%." + decimals + "f%%", percentage);
    }
}

--- 结束文件: UserGetLearningStats.java ---

--- 开始文件: UserGetPointsAndLevel.java ---
package com.vue.readingapp.user;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.ArrayList;

@RestController
@RequestMapping("/api/v1/user")
public class UserGetPointsAndLevel {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取积分等级请求 ===");
        System.out.println("请求信息");
        System.out.println("=================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class PointsAndLevelResponse {
        private boolean success;
        private String message;
        private PointsData points;

        public PointsAndLevelResponse(boolean success, String message, PointsData points) {
            this.success = success;
            this.message = message;
            this.points = points;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public PointsData getPoints() { return points; }
        public void setPoints(PointsData points) { this.points = points; }
    }

    public static class PointsData {
        private int totalPoints;
        private int currentLevel;
        private String levelName;
        private int nextLevelPoints;
        private int currentLevelPoints;
        private double progressToNextLevel;
        private String formattedProgress;
        private String levelIcon;
        private List<BadgeData> badges;
        private List<PointsHistoryData> pointsHistory;

        // Getters and Setters
        public int getTotalPoints() { return totalPoints; }
        public void setTotalPoints(int totalPoints) { this.totalPoints = totalPoints; }

        public int getCurrentLevel() { return currentLevel; }
        public void setCurrentLevel(int currentLevel) { this.currentLevel = currentLevel; }

        public String getLevelName() { return levelName; }
        public void setLevelName(String levelName) { this.levelName = levelName; }

        public int getNextLevelPoints() { return nextLevelPoints; }
        public void setNextLevelPoints(int nextLevelPoints) { this.nextLevelPoints = nextLevelPoints; }

        public int getCurrentLevelPoints() { return currentLevelPoints; }
        public void setCurrentLevelPoints(int currentLevelPoints) { this.currentLevelPoints = currentLevelPoints; }

        public double getProgressToNextLevel() { return progressToNextLevel; }
        public void setProgressToNextLevel(double progressToNextLevel) { this.progressToNextLevel = progressToNextLevel; }

        public String getFormattedProgress() { return formattedProgress; }
        public void setFormattedProgress(String formattedProgress) { this.formattedProgress = formattedProgress; }

        public String getLevelIcon() { return levelIcon; }
        public void setLevelIcon(String levelIcon) { this.levelIcon = levelIcon; }

        public List<BadgeData> getBadges() { return badges; }
        public void setBadges(List<BadgeData> badges) { this.badges = badges; }

        public List<PointsHistoryData> getPointsHistory() { return pointsHistory; }
        public void setPointsHistory(List<PointsHistoryData> pointsHistory) { this.pointsHistory = pointsHistory; }
    }

    public static class BadgeData {
        private int id;
        private String name;
        private String description;
        private String icon;
        private String earnedDate;

        public BadgeData(int id, String name, String description, String icon, String earnedDate) {
            this.id = id;
            this.name = name;
            this.description = description;
            this.icon = icon;
            this.earnedDate = earnedDate;
        }

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }

        public String getIcon() { return icon; }
        public void setIcon(String icon) { this.icon = icon; }

        public String getEarnedDate() { return earnedDate; }
        public void setEarnedDate(String earnedDate) { this.earnedDate = earnedDate; }
    }

    public static class PointsHistoryData {
        private String date;
        private int points;
        private String reason;

        public PointsHistoryData(String date, int points, String reason) {
            this.date = date;
            this.points = points;
            this.reason = reason;
        }

        public String getDate() { return date; }
        public void setDate(String date) { this.date = date; }

        public int getPoints() { return points; }
        public void setPoints(int points) { this.points = points; }

        public String getReason() { return reason; }
        public void setReason(String reason) { this.reason = reason; }
    }

    @GetMapping("/points-level")
    public ResponseEntity<PointsAndLevelResponse> getUserPointsAndLevel(
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        // 打印接收到的请求
        printRequest("Authorization: " + authHeader);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new PointsAndLevelResponse(false, "请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 验证token有效性
            String tokenSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new PointsAndLevelResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            int userId = (int) session.get("user_id");

            // 3. 查询用户总积分
            // 假设积分存储在user_achievements表中，通过achievement的points字段累加
            String totalPointsSql = "SELECT COALESCE(SUM(la.points), 0) as total_points " +
                    "FROM user_achievements ua " +
                    "JOIN learning_achievements la ON ua.achievement_id = la.achievement_id " +
                    "WHERE ua.user_id = ?";
            Map<String, Object> totalPointsResult = jdbcTemplate.queryForMap(totalPointsSql, userId);
            int totalPoints = ((Number) totalPointsResult.get("total_points")).intValue();

            // 4. 计算用户等级
            // 假设等级规则：每100积分升一级
            int currentLevel = Math.max(1, totalPoints / 100 + 1);
            String levelName = getLevelName(currentLevel);

            // 当前等级所需积分
            int currentLevelPoints = (currentLevel - 1) * 100;

            // 下一等级所需积分
            int nextLevelPoints = currentLevel * 100;

            // 当前等级已获得积分
            int pointsInCurrentLevel = totalPoints - currentLevelPoints;

            // 升级进度百分比
            double progressToNextLevel = 0;
            if (nextLevelPoints > currentLevelPoints) {
                progressToNextLevel = (double) pointsInCurrentLevel / (nextLevelPoints - currentLevelPoints) * 100;
            }

            String formattedProgress = String.format("%.1f%%", progressToNextLevel);

            // 5. 查询用户徽章（简化处理，使用成就作为徽章）
            List<BadgeData> badges = new ArrayList<>();
            String badgesSql = "SELECT la.achievement_id, la.name, la.description, la.icon_url, ua.unlocked_at " +
                    "FROM user_achievements ua " +
                    "JOIN learning_achievements la ON ua.achievement_id = la.achievement_id " +
                    "WHERE ua.user_id = ? AND la.points >= 50 " + // 只显示50分以上的成就作为徽章
                    "ORDER BY ua.unlocked_at DESC LIMIT 10";

            List<Map<String, Object>> badgesResults = jdbcTemplate.queryForList(badgesSql, userId);

            for (Map<String, Object> badge : badgesResults) {
                int badgeId = ((Number) badge.get("achievement_id")).intValue();
                String badgeName = (String) badge.get("name");
                String badgeDescription = (String) badge.get("description");
                String badgeIcon = badge.get("icon_url") != null ? (String) badge.get("icon_url") : "";
                String earnedDate = badge.get("unlocked_at") != null ? badge.get("unlocked_at").toString() : "";

                badges.add(new BadgeData(badgeId, badgeName, badgeDescription, badgeIcon, earnedDate));
            }

            // 6. 查询积分历史（简化处理，使用成就解锁记录）
            List<PointsHistoryData> pointsHistory = new ArrayList<>();
            String historySql = "SELECT DATE(ua.unlocked_at) as date, la.points, la.name as reason " +
                    "FROM user_achievements ua " +
                    "JOIN learning_achievements la ON ua.achievement_id = la.achievement_id " +
                    "WHERE ua.user_id = ? " +
                    "ORDER BY ua.unlocked_at DESC LIMIT 20";

            List<Map<String, Object>> historyResults = jdbcTemplate.queryForList(historySql, userId);

            for (Map<String, Object> history : historyResults) {
                String date = history.get("date") != null ? history.get("date").toString() : "";
                int points = ((Number) history.get("points")).intValue();
                String reason = (String) history.get("reason");

                pointsHistory.add(new PointsHistoryData(date, points, reason));
            }

            // 7. 构建积分等级数据
            PointsData pointsData = new PointsData();
            pointsData.setTotalPoints(totalPoints);
            pointsData.setCurrentLevel(currentLevel);
            pointsData.setLevelName(levelName);
            pointsData.setNextLevelPoints(nextLevelPoints);
            pointsData.setCurrentLevelPoints(currentLevelPoints);
            pointsData.setProgressToNextLevel(progressToNextLevel);
            pointsData.setFormattedProgress(formattedProgress);
            pointsData.setLevelIcon(getLevelIcon(currentLevel));
            pointsData.setBadges(badges);
            pointsData.setPointsHistory(pointsHistory);

            printQueryResult(pointsData);

            // 8. 准备响应数据
            PointsAndLevelResponse response = new PointsAndLevelResponse(true, "获取积分等级信息成功", pointsData);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取用户积分等级过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new PointsAndLevelResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    // 根据等级获取等级名称
    private String getLevelName(int level) {
        if (level <= 5) {
            return "初学者";
        } else if (level <= 10) {
            return "学习者";
        } else if (level <= 20) {
            return "熟练者";
        } else if (level <= 30) {
            return "专家";
        } else if (level <= 40) {
            return "大师";
        } else if (level <= 50) {
            return "宗师";
        } else {
            return "传奇";
        }
    }

    // 根据等级获取等级图标（简化处理，返回固定字符串）
    private String getLevelIcon(int level) {
        if (level <= 5) {
            return "level_beginner";
        } else if (level <= 10) {
            return "level_learner";
        } else if (level <= 20) {
            return "level_proficient";
        } else if (level <= 30) {
            return "level_expert";
        } else if (level <= 40) {
            return "level_master";
        } else if (level <= 50) {
            return "level_grandmaster";
        } else {
            return "level_legend";
        }
    }
}

--- 结束文件: UserGetPointsAndLevel.java ---

--- 开始文件: UserGetProfile.java ---

package com.vue.readingapp.user;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user")
public class UserGetProfile {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取用户信息请求 ===");
        System.out.println("请求头信息");
        System.out.println("=================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class UserProfileResponse {
        private boolean success;
        private String message;
        private UserData user;

        public UserProfileResponse(boolean success, String message, UserData user) {
            this.success = success;
            this.message = message;
            this.user = user;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public UserData getUser() { return user; }
        public void setUser(UserData user) { this.user = user; }
    }

    public static class UserData {
        private int id;
        private String username;
        private String email;
        private String nickname;
        private String avatar;
        private String bio;
        private String location;
        private String website;
        private LocalDateTime joinDate;
        private LocalDateTime lastLogin;
        private boolean isVerified;
        private Preferences preferences;
        private PrivacySettings privacySettings;

        public UserData(int id, String username, String email, String nickname, String avatar,
                        String bio, String location, String website, LocalDateTime joinDate,
                        LocalDateTime lastLogin, boolean isVerified) {
            this.id = id;
            this.username = username;
            this.email = email;
            this.nickname = nickname;
            this.avatar = avatar;
            this.bio = bio;
            this.location = location;
            this.website = website;
            this.joinDate = joinDate;
            this.lastLogin = lastLogin;
            this.isVerified = isVerified;
            this.preferences = new Preferences();
            this.privacySettings = new PrivacySettings();
        }

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public String getUsername() { return username; }
        public void setUsername(String username) { this.username = username; }

        public String getEmail() { return email; }
        public void setEmail(String email) { this.email = email; }

        public String getNickname() { return nickname; }
        public void setNickname(String nickname) { this.nickname = nickname; }

        public String getAvatar() { return avatar; }
        public void setAvatar(String avatar) { this.avatar = avatar; }

        public String getBio() { return bio; }
        public void setBio(String bio) { this.bio = bio; }

        public String getLocation() { return location; }
        public void setLocation(String location) { this.location = location; }

        public String getWebsite() { return website; }
        public void setWebsite(String website) { this.website = website; }

        public LocalDateTime getJoinDate() { return joinDate; }
        public void setJoinDate(LocalDateTime joinDate) { this.joinDate = joinDate; }

        public LocalDateTime getLastLogin() { return lastLogin; }
        public void setLastLogin(LocalDateTime lastLogin) { this.lastLogin = lastLogin; }

        public boolean isVerified() { return isVerified; }
        public void setVerified(boolean verified) { isVerified = verified; }

        public Preferences getPreferences() { return preferences; }
        public void setPreferences(Preferences preferences) { this.preferences = preferences; }

        public PrivacySettings getPrivacySettings() { return privacySettings; }
        public void setPrivacySettings(PrivacySettings privacySettings) { this.privacySettings = privacySettings; }
    }

    public static class Preferences {
        private Reading reading = new Reading();
        private Review review = new Review();
        private Notification notification = new Notification();

        public Reading getReading() { return reading; }
        public void setReading(Reading reading) { this.reading = reading; }

        public Review getReview() { return review; }
        public void setReview(Review review) { this.review = review; }

        public Notification getNotification() { return notification; }
        public void setNotification(Notification notification) { this.notification = notification; }
    }

    public static class Reading {
        private int fontSize = 16;
        private String theme = "light";
        private double lineHeight = 1.6;

        public int getFontSize() { return fontSize; }
        public void setFontSize(int fontSize) { this.fontSize = fontSize; }

        public String getTheme() { return theme; }
        public void setTheme(String theme) { this.theme = theme; }

        public double getLineHeight() { return lineHeight; }
        public void setLineHeight(double lineHeight) { this.lineHeight = lineHeight; }
    }

    public static class Review {
        private int dailyGoal = 20;
        private String reminderTime = "20:00";

        public int getDailyGoal() { return dailyGoal; }
        public void setDailyGoal(int dailyGoal) { this.dailyGoal = dailyGoal; }

        public String getReminderTime() { return reminderTime; }
        public void setReminderTime(String reminderTime) { this.reminderTime = reminderTime; }
    }

    public static class Notification {
        private boolean email = true;
        private boolean push = true;

        public boolean isEmail() { return email; }
        public void setEmail(boolean email) { this.email = email; }

        public boolean isPush() { return push; }
        public void setPush(boolean push) { this.push = push; }
    }

    public static class PrivacySettings {
        private String profileVisibility = "public";
        private String activityVisibility = "friends";
        private String dataSharing = "limited";

        public String getProfileVisibility() { return profileVisibility; }
        public void setProfileVisibility(String profileVisibility) { this.profileVisibility = profileVisibility; }

        public String getActivityVisibility() { return activityVisibility; }
        public void setActivityVisibility(String activityVisibility) { this.activityVisibility = activityVisibility; }

        public String getDataSharing() { return dataSharing; }
        public void setDataSharing(String dataSharing) { this.dataSharing = dataSharing; }
    }

    @GetMapping("/profile")
    public ResponseEntity<UserProfileResponse> getUserProfile(@RequestHeader(value = "Authorization", required = false) String authHeader) {
        // 打印接收到的请求
        printRequest("Authorization: " + authHeader);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UserProfileResponse(false, "请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 验证token有效性
            String tokenSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UserProfileResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            int userId = (int) session.get("user_id");

            // 3. 查询用户信息
            String userSql = "SELECT user_id, username, email, nickname, avatar_url, bio, location, website, " +
                    "is_verified, created_at, last_login_at FROM users WHERE user_id = ?";

            List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, userId);
            printQueryResult(users);

            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new UserProfileResponse(false, "用户不存在", null)
                );
            }

            Map<String, Object> user = users.get(0);

            // 4. 格式化用户信息（保持LocalDateTime类型）
            UserData userData = new UserData(
                    (int) user.get("user_id"),
                    (String) user.get("username"),
                    (String) user.get("email"),
                    user.get("nickname") != null ? (String) user.get("nickname") : (String) user.get("username"),
                    user.get("avatar_url") != null ? (String) user.get("avatar_url") : "",
                    user.get("bio") != null ? (String) user.get("bio") : "",
                    user.get("location") != null ? (String) user.get("location") : "",
                    user.get("website") != null ? (String) user.get("website") : "",
                    (LocalDateTime) user.get("created_at"),
                    (LocalDateTime) user.get("last_login_at"),
                    user.get("is_verified") != null && (boolean) user.get("is_verified")
            );

            // 5. 准备响应数据
            UserProfileResponse response = new UserProfileResponse(true, "获取用户信息成功", userData);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取用户信息过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UserProfileResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: UserGetProfile.java ---

--- 开始文件: UserGetSubscriptionInfo.java ---
package com.vue.readingapp.user;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user")
public class UserGetSubscriptionInfo {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取订阅信息请求 ===");
        System.out.println("请求信息");
        System.out.println("=================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class SubscriptionInfoResponse {
        private boolean success;
        private String message;
        private SubscriptionData subscription;

        public SubscriptionInfoResponse(boolean success, String message, SubscriptionData subscription) {
            this.success = success;
            this.message = message;
            this.subscription = subscription;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public SubscriptionData getSubscription() { return subscription; }
        public void setSubscription(SubscriptionData subscription) { this.subscription = subscription; }
    }

    public static class SubscriptionData {
        private String type;
        private String status;
        private String startDate;
        private String endDate;
        private String renewalDate;
        private boolean autoRenew;
        private PlanData plan;
        private List<FeatureData> features;
        private BillingData billing;

        // Getters and Setters
        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public String getStatus() { return status; }
        public void setStatus(String status) { this.status = status; }

        public String getStartDate() { return startDate; }
        public void setStartDate(String startDate) { this.startDate = startDate; }

        public String getEndDate() { return endDate; }
        public void setEndDate(String endDate) { this.endDate = endDate; }

        public String getRenewalDate() { return renewalDate; }
        public void setRenewalDate(String renewalDate) { this.renewalDate = renewalDate; }

        public boolean isAutoRenew() { return autoRenew; }
        public void setAutoRenew(boolean autoRenew) { this.autoRenew = autoRenew; }

        public PlanData getPlan() { return plan; }
        public void setPlan(PlanData plan) { this.plan = plan; }

        public List<FeatureData> getFeatures() { return features; }
        public void setFeatures(List<FeatureData> features) { this.features = features; }

        public BillingData getBilling() { return billing; }
        public void setBilling(BillingData billing) { this.billing = billing; }
    }

    public static class PlanData {
        private String id;
        private String name;
        private double price;
        private String currency;
        private String billingCycle;
        private String description;

        public PlanData(String id, String name, double price, String currency, String billingCycle, String description) {
            this.id = id;
            this.name = name;
            this.price = price;
            this.currency = currency;
            this.billingCycle = billingCycle;
            this.description = description;
        }

        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public double getPrice() { return price; }
        public void setPrice(double price) { this.price = price; }

        public String getCurrency() { return currency; }
        public void setCurrency(String currency) { this.currency = currency; }

        public String getBillingCycle() { return billingCycle; }
        public void setBillingCycle(String billingCycle) { this.billingCycle = billingCycle; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }
    }

    public static class FeatureData {
        private String name;
        private String description;
        private boolean enabled;

        public FeatureData(String name, String description, boolean enabled) {
            this.name = name;
            this.description = description;
            this.enabled = enabled;
        }

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }

        public boolean isEnabled() { return enabled; }
        public void setEnabled(boolean enabled) { this.enabled = enabled; }
    }

    public static class BillingData {
        private String lastPaymentDate;
        private double lastPaymentAmount;
        private String nextPaymentDate;
        private double nextPaymentAmount;
        private String paymentMethod;

        public BillingData(String lastPaymentDate, double lastPaymentAmount, String nextPaymentDate,
                           double nextPaymentAmount, String paymentMethod) {
            this.lastPaymentDate = lastPaymentDate;
            this.lastPaymentAmount = lastPaymentAmount;
            this.nextPaymentDate = nextPaymentDate;
            this.nextPaymentAmount = nextPaymentAmount;
            this.paymentMethod = paymentMethod;
        }

        public String getLastPaymentDate() { return lastPaymentDate; }
        public void setLastPaymentDate(String lastPaymentDate) { this.lastPaymentDate = lastPaymentDate; }

        public double getLastPaymentAmount() { return lastPaymentAmount; }
        public void setLastPaymentAmount(double lastPaymentAmount) { this.lastPaymentAmount = lastPaymentAmount; }

        public String getNextPaymentDate() { return nextPaymentDate; }
        public void setNextPaymentDate(String nextPaymentDate) { this.nextPaymentDate = nextPaymentDate; }

        public double getNextPaymentAmount() { return nextPaymentAmount; }
        public void setNextPaymentAmount(double nextPaymentAmount) { this.nextPaymentAmount = nextPaymentAmount; }

        public String getPaymentMethod() { return paymentMethod; }
        public void setPaymentMethod(String paymentMethod) { this.paymentMethod = paymentMethod; }
    }

    @GetMapping("/subscription")
    public ResponseEntity<SubscriptionInfoResponse> getSubscriptionInfo(
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        // 打印接收到的请求
        printRequest("Authorization: " + authHeader);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new SubscriptionInfoResponse(false, "请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 验证token有效性
            String tokenSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new SubscriptionInfoResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            int userId = (int) session.get("user_id");

            // 3. 查询用户信息（假设用户类型存储在user_type字段）
            String userSql = "SELECT user_id, username, email, user_type, created_at FROM users WHERE user_id = ?";
            List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, userId);

            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new SubscriptionInfoResponse(false, "用户不存在", null)
                );
            }

            Map<String, Object> user = users.get(0);
            String userType = user.get("user_type") != null ? (String) user.get("user_type") : "free";

            // 4. 构建订阅数据
            SubscriptionData subscription = new SubscriptionData();

            // 设置订阅类型和状态
            subscription.setType(userType);
            subscription.setStatus("active".equals(userType) ? "active" : "inactive");

            // 设置日期信息
            LocalDateTime now = LocalDateTime.now();
            DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");

            // 假设订阅开始时间是用户注册时间
            LocalDateTime startDate = (LocalDateTime) user.get("created_at");
            subscription.setStartDate(startDate.format(formatter));

            // 如果是付费用户，设置结束时间和续订时间
            if ("premium".equals(userType)) {
                LocalDateTime endDate = startDate.plusMonths(1);
                subscription.setEndDate(endDate.format(formatter));
                subscription.setRenewalDate(endDate.format(formatter));
                subscription.setAutoRenew(true);
            } else {
                subscription.setEndDate("");
                subscription.setRenewalDate("");
                subscription.setAutoRenew(false);
            }

            // 5. 构建计划数据
            PlanData plan;
            if ("premium".equals(userType)) {
                plan = new PlanData(
                        "premium_monthly",
                        "高级会员（月付）",
                        29.99,
                        "CNY",
                        "monthly",
                        "享受所有高级功能，包括无限文档、高级词汇管理、个性化学习报告等"
                );
            } else {
                plan = new PlanData(
                        "free",
                        "免费版",
                        0.00,
                        "CNY",
                        "none",
                        "基础功能，包括有限文档管理、基础词汇学习、基本学习统计"
                );
            }
            subscription.setPlan(plan);

            // 6. 构建功能列表
            List<FeatureData> features = new java.util.ArrayList<>();

            if ("premium".equals(userType)) {
                features.add(new FeatureData("无限文档", "上传和管理无限数量的文档", true));
                features.add(new FeatureData("高级词汇管理", "使用智能分类和标签管理词汇", true));
                features.add(new FeatureData("个性化学习报告", "获取详细的学习分析和建议", true));
                features.add(new FeatureData("离线同步", "在所有设备上同步学习数据", true));
                features.add(new FeatureData("优先支持", "获得优先技术支持", true));
            } else {
                features.add(new FeatureData("有限文档", "最多上传10个文档", true));
                features.add(new FeatureData("基础词汇管理", "基本的词汇添加和查看", true));
                features.add(new FeatureData("基本学习统计", "查看基础的学习数据", true));
                features.add(new FeatureData("离线同步", "基础数据同步", false));
                features.add(new FeatureData("标准支持", "获得标准技术支持", true));
            }
            subscription.setFeatures(features);

            // 7. 构建账单数据
            BillingData billing;
            if ("premium".equals(userType)) {
                billing = new BillingData(
                        startDate.format(formatter),
                        29.99,
                        startDate.plusMonths(1).format(formatter),
                        29.99,
                        "credit_card"
                );
            } else {
                billing = new BillingData(
                        "",
                        0.00,
                        "",
                        0.00,
                        ""
                );
            }
            subscription.setBilling(billing);

            printQueryResult(subscription);

            // 8. 准备响应数据
            SubscriptionInfoResponse response = new SubscriptionInfoResponse(
                    true, "获取订阅信息成功", subscription);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取订阅信息过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new SubscriptionInfoResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: UserGetSubscriptionInfo.java ---

--- 开始文件: UserSetLearningGoal.java ---

package com.vue.readingapp.user;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user")
public class UserSetLearningGoal {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到设置学习目标请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class SetLearningGoalRequest {
        private String type;
        private String title;
        private String description;
        private int targetValue;
        private String unit;
        private String endDate;

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public String getTitle() { return title; }
        public void setTitle(String title) { this.title = title; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }

        public int getTargetValue() { return targetValue; }
        public void setTargetValue(int targetValue) { this.targetValue = targetValue; }

        public String getUnit() { return unit; }
        public void setUnit(String unit) { this.unit = unit; }

        public String getEndDate() { return endDate; }
        public void setEndDate(String endDate) { this.endDate = endDate; }
    }

    // 响应DTO
    public static class SetLearningGoalResponse {
        private boolean success;
        private String message;
        private UserGetLearningGoals.GoalData goal;

        public SetLearningGoalResponse(boolean success, String message, UserGetLearningGoals.GoalData goal) {
            this.success = success;
            this.message = message;
            this.goal = goal;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public UserGetLearningGoals.GoalData getGoal() { return goal; }
        public void setGoal(UserGetLearningGoals.GoalData goal) { this.goal = goal; }
    }

    @PostMapping("/goals")
    public ResponseEntity<SetLearningGoalResponse> setLearningGoal(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestBody SetLearningGoalRequest request) {

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new SetLearningGoalResponse(false, "请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 验证token有效性
            String tokenSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new SetLearningGoalResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            int userId = (int) session.get("user_id");

            // 3. 验证请求数据
            if (request.getType() == null || request.getType().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new SetLearningGoalResponse(false, "目标类型不能为空", null)
                );
            }

            if (request.getTitle() == null || request.getTitle().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new SetLearningGoalResponse(false, "目标标题不能为空", null)
                );
            }

            if (request.getTargetValue() <= 0) {
                return ResponseEntity.badRequest().body(
                        new SetLearningGoalResponse(false, "目标值必须大于0", null)
                );
            }

            // 4. 检查learning_goals表是否存在，如果不存在则创建
            String checkTableSql = "SELECT COUNT(*) FROM information_schema.tables " +
                    "WHERE table_schema = DATABASE() AND table_name = 'learning_goals'";

            int tableExists = jdbcTemplate.queryForObject(checkTableSql, Integer.class);

            if (tableExists == 0) {
                // 创建learning_goals表
                String createTableSql = "CREATE TABLE learning_goals (" +
                        "goal_id INT PRIMARY KEY AUTO_INCREMENT, " +
                        "user_id INT NOT NULL, " +
                        "type VARCHAR(50) NOT NULL, " +
                        "title VARCHAR(200) NOT NULL, " +
                        "description TEXT, " +
                        "target_value INT NOT NULL, " +
                        "current_value INT DEFAULT 0, " +
                        "unit VARCHAR(50), " +
                        "start_date DATETIME DEFAULT CURRENT_TIMESTAMP, " +
                        "end_date DATETIME, " +
                        "status VARCHAR(20) DEFAULT 'active', " +
                        "created_at DATETIME DEFAULT CURRENT_TIMESTAMP, " +
                        "updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, " +
                        "FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE" +
                        ")";

                jdbcTemplate.execute(createTableSql);
                System.out.println("已创建learning_goals表");
            }

            // 5. 插入新的学习目标
            LocalDateTime now = LocalDateTime.now();
            LocalDateTime endDate = null;

            if (request.getEndDate() != null && !request.getEndDate().trim().isEmpty()) {
                endDate = LocalDateTime.parse(request.getEndDate() + "T00:00:00");
            }

            String insertSql = "INSERT INTO learning_goals (user_id, type, title, description, " +
                    "target_value, current_value, unit, start_date, end_date, status) " +
                    "VALUES (?, ?, ?, ?, ?, 0, ?, ?, ?, 'active')";

            int rowsInserted = jdbcTemplate.update(insertSql,
                    userId,
                    request.getType(),
                    request.getTitle(),
                    request.getDescription(),
                    request.getTargetValue(),
                    request.getUnit(),
                    now,
                    endDate
            );

            printQueryResult("插入学习目标行数: " + rowsInserted);

            if (rowsInserted == 0) {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new SetLearningGoalResponse(false, "创建学习目标失败", null)
                );
            }

            // 6. 获取新插入的目标ID
            String lastIdSql = "SELECT LAST_INSERT_ID() as goal_id";
            Map<String, Object> lastIdResult = jdbcTemplate.queryForMap(lastIdSql);
            int goalId = ((Number) lastIdResult.get("goal_id")).intValue();

            // 7. 查询新创建的学习目标
            String selectSql = "SELECT goal_id, type, title, description, target_value, current_value, " +
                    "unit, start_date, end_date, status, created_at, updated_at " +
                    "FROM learning_goals WHERE goal_id = ?";

            List<Map<String, Object>> goalResults = jdbcTemplate.queryForList(selectSql, goalId);

            if (goalResults.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new SetLearningGoalResponse(false, "学习目标不存在", null)
                );
            }

            Map<String, Object> goal = goalResults.get(0);

            // 8. 构建目标数据
            UserGetLearningGoals.GoalData goalData = new UserGetLearningGoals.GoalData();
            goalData.setGoalId(((Number) goal.get("goal_id")).intValue());
            goalData.setType((String) goal.get("type"));
            goalData.setTitle((String) goal.get("title"));
            goalData.setDescription((String) goal.get("description"));
            goalData.setTargetValue(((Number) goal.get("target_value")).intValue());
            goalData.setCurrentValue(((Number) goal.get("current_value")).intValue());
            goalData.setUnit((String) goal.get("unit"));

            // 格式化日期
            DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");

            if (goal.get("start_date") != null) {
                goalData.setStartDate(((LocalDateTime) goal.get("start_date")).format(formatter));
            }

            if (goal.get("end_date") != null) {
                goalData.setEndDate(((LocalDateTime) goal.get("end_date")).format(formatter));
            }

            goalData.setStatus((String) goal.get("status"));

            if (goal.get("created_at") != null) {
                goalData.setCreatedDate(((LocalDateTime) goal.get("created_at")).format(formatter));
            }

            if (goal.get("updated_at") != null) {
                goalData.setUpdatedDate(((LocalDateTime) goal.get("updated_at")).format(formatter));
            }

            // 9. 准备响应数据
            SetLearningGoalResponse response = new SetLearningGoalResponse(
                    true, "学习目标设置成功", goalData);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("设置学习目标过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new SetLearningGoalResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: UserSetLearningGoal.java ---

--- 开始文件: UserUpdateAvatar.java ---
package com.vue.readingapp.user;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.multipart.MultipartFile;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.io.IOException;
import java.util.Base64;

@RestController
@RequestMapping("/api/v1/user")
public class UserUpdateAvatar {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到更新头像请求 ===");
        System.out.println("请求信息: " + request);
        System.out.println("=================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 用户数据DTO（内联于此）
    public static class UserData {
        private int id;
        private String username;
        private String email;
        private String nickname;
        private String avatar;
        private String bio;
        private String location;
        private String website;
        private java.time.LocalDateTime joinDate;
        private java.time.LocalDateTime lastLogin;
        private boolean isVerified;
        private Preferences preferences;
        private PrivacySettings privacySettings;

        public UserData(int id, String username, String email, String nickname, String avatar,
                        String bio, String location, String website, java.time.LocalDateTime joinDate,
                        java.time.LocalDateTime lastLogin, boolean isVerified) {
            this.id = id;
            this.username = username;
            this.email = email;
            this.nickname = nickname;
            this.avatar = avatar;
            this.bio = bio;
            this.location = location;
            this.website = website;
            this.joinDate = joinDate;
            this.lastLogin = lastLogin;
            this.isVerified = isVerified;
            this.preferences = new Preferences();
            this.privacySettings = new PrivacySettings();
        }

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public String getUsername() { return username; }
        public void setUsername(String username) { this.username = username; }

        public String getEmail() { return email; }
        public void setEmail(String email) { this.email = email; }

        public String getNickname() { return nickname; }
        public void setNickname(String nickname) { this.nickname = nickname; }

        public String getAvatar() { return avatar; }
        public void setAvatar(String avatar) { this.avatar = avatar; }

        public String getBio() { return bio; }
        public void setBio(String bio) { this.bio = bio; }

        public String getLocation() { return location; }
        public void setLocation(String location) { this.location = location; }

        public String getWebsite() { return website; }
        public void setWebsite(String website) { this.website = website; }

        public java.time.LocalDateTime getJoinDate() { return joinDate; }
        public void setJoinDate(java.time.LocalDateTime joinDate) { this.joinDate = joinDate; }

        public java.time.LocalDateTime getLastLogin() { return lastLogin; }
        public void setLastLogin(java.time.LocalDateTime lastLogin) { this.lastLogin = lastLogin; }

        public boolean isVerified() { return isVerified; }
        public void setVerified(boolean verified) { isVerified = verified; }

        public Preferences getPreferences() { return preferences; }
        public void setPreferences(Preferences preferences) { this.preferences = preferences; }

        public PrivacySettings getPrivacySettings() { return privacySettings; }
        public void setPrivacySettings(PrivacySettings privacySettings) { this.privacySettings = privacySettings; }
    }

    public static class Preferences {
        private Reading reading = new Reading();
        private Review review = new Review();
        private Notification notification = new Notification();

        public Reading getReading() { return reading; }
        public void setReading(Reading reading) { this.reading = reading; }

        public Review getReview() { return review; }
        public void setReview(Review review) { this.review = review; }

        public Notification getNotification() { return notification; }
        public void setNotification(Notification notification) { this.notification = notification; }
    }

    public static class Reading {
        private int fontSize = 16;
        private String theme = "light";
        private double lineHeight = 1.6;

        public int getFontSize() { return fontSize; }
        public void setFontSize(int fontSize) { this.fontSize = fontSize; }

        public String getTheme() { return theme; }
        public void setTheme(String theme) { this.theme = theme; }

        public double getLineHeight() { return lineHeight; }
        public void setLineHeight(double lineHeight) { this.lineHeight = lineHeight; }
    }

    public static class Review {
        private int dailyGoal = 20;
        private String reminderTime = "20:00";

        public int getDailyGoal() { return dailyGoal; }
        public void setDailyGoal(int dailyGoal) { this.dailyGoal = dailyGoal; }

        public String getReminderTime() { return reminderTime; }
        public void setReminderTime(String reminderTime) { this.reminderTime = reminderTime; }
    }

    public static class Notification {
        private boolean email = true;
        private boolean push = true;

        public boolean isEmail() { return email; }
        public void setEmail(boolean email) { this.email = email; }

        public boolean isPush() { return push; }
        public void setPush(boolean push) { this.push = push; }
    }

    public static class PrivacySettings {
        private String profileVisibility = "public";
        private String activityVisibility = "friends";
        private String dataSharing = "limited";

        public String getProfileVisibility() { return profileVisibility; }
        public void setProfileVisibility(String profileVisibility) { this.profileVisibility = profileVisibility; }

        public String getActivityVisibility() { return activityVisibility; }
        public void setActivityVisibility(String activityVisibility) { this.activityVisibility = activityVisibility; }

        public String getDataSharing() { return dataSharing; }
        public void setDataSharing(String dataSharing) { this.dataSharing = dataSharing; }
    }

    // 响应DTO
    public static class UpdateAvatarResponse {
        private boolean success;
        private String message;
        private UserData user;

        public UpdateAvatarResponse(boolean success, String message, UserData user) {
            this.success = success;
            this.message = message;
            this.user = user;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public UserData getUser() { return user; }
        public void setUser(UserData user) { this.user = user; }
    }

    @PostMapping("/avatar")
    public ResponseEntity<UpdateAvatarResponse> updateAvatar(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestParam("avatar") MultipartFile file) {

        // 打印接收到的请求
        printRequest("文件大小: " + file.getSize() + " bytes, 文件类型: " + file.getContentType());

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateAvatarResponse(false, "请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 验证token有效性
            String tokenSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateAvatarResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            int userId = (int) session.get("user_id");

            // 3. 验证文件
            if (file.isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new UpdateAvatarResponse(false, "请选择头像文件", null)
                );
            }

            // 验证文件大小（5MB限制）
            long maxSize = 5 * 1024 * 1024; // 5MB
            if (file.getSize() > maxSize) {
                return ResponseEntity.badRequest().body(
                        new UpdateAvatarResponse(false, "图片文件太大，请选择小于5MB的图片", null)
                );
            }

            // 验证文件类型
            String contentType = file.getContentType();
            if (contentType == null ||
                    (!contentType.equals("image/jpeg") &&
                            !contentType.equals("image/png") &&
                            !contentType.equals("image/gif"))) {
                return ResponseEntity.badRequest().body(
                        new UpdateAvatarResponse(false, "图片格式不支持，请选择JPG、PNG或GIF图片", null)
                );
            }

            // 4. 将图片转换为Base64字符串
            byte[] fileBytes = file.getBytes();
            String base64Image = Base64.getEncoder().encodeToString(fileBytes);

            // 构建完整的Data URL
            String avatarUrl = "data:" + contentType + ";base64," + base64Image;

            // 5. 更新用户头像
            String updateSql = "UPDATE users SET avatar_url = ? WHERE user_id = ?";
            int rowsUpdated = jdbcTemplate.update(updateSql, avatarUrl, userId);

            printQueryResult("更新头像行数: " + rowsUpdated);

            if (rowsUpdated == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new UpdateAvatarResponse(false, "用户不存在", null)
                );
            }

            // 6. 查询更新后的用户信息
            String userSql = "SELECT user_id, username, email, nickname, avatar_url, bio, location, website, " +
                    "is_verified, created_at, last_login_at FROM users WHERE user_id = ?";

            List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, userId);

            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new UpdateAvatarResponse(false, "用户不存在", null)
                );
            }

            Map<String, Object> user = users.get(0);

            // 7. 格式化用户信息（保持LocalDateTime类型）
            UserData userData = new UserData(
                    (int) user.get("user_id"),
                    (String) user.get("username"),
                    (String) user.get("email"),
                    user.get("nickname") != null ? (String) user.get("nickname") : (String) user.get("username"),
                    user.get("avatar_url") != null ? (String) user.get("avatar_url") : "",
                    user.get("bio") != null ? (String) user.get("bio") : "",
                    user.get("location") != null ? (String) user.get("location") : "",
                    user.get("website") != null ? (String) user.get("website") : "",
                    (LocalDateTime) user.get("created_at"),
                    (LocalDateTime) user.get("last_login_at"),
                    user.get("is_verified") != null && (boolean) user.get("is_verified")
            );

            // 8. 准备响应数据
            UpdateAvatarResponse response = new UpdateAvatarResponse(true, "头像更新成功", userData);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (IOException e) {
            System.err.println("读取图片文件过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdateAvatarResponse(false, "读取图片文件失败: " + e.getMessage(), null)
            );
        } catch (Exception e) {
            System.err.println("更新头像过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdateAvatarResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: UserUpdateAvatar.java ---

--- 开始文件: UserUpdatePreferences.java ---
package com.vue.readingapp.user;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user")
public class UserUpdatePreferences {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到更新偏好设置请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class UpdatePreferencesRequest {
        private ReadingPreferences reading;
        private ReviewPreferences review;
        private NotificationPreferences notification;

        public ReadingPreferences getReading() { return reading; }
        public void setReading(ReadingPreferences reading) { this.reading = reading; }

        public ReviewPreferences getReview() { return review; }
        public void setReview(ReviewPreferences review) { this.review = review; }

        public NotificationPreferences getNotification() { return notification; }
        public void setNotification(NotificationPreferences notification) { this.notification = notification; }
    }

    public static class ReadingPreferences {
        private Integer fontSize;
        private String theme;
        private Double lineHeight;

        public Integer getFontSize() { return fontSize; }
        public void setFontSize(Integer fontSize) { this.fontSize = fontSize; }

        public String getTheme() { return theme; }
        public void setTheme(String theme) { this.theme = theme; }

        public Double getLineHeight() { return lineHeight; }
        public void setLineHeight(Double lineHeight) { this.lineHeight = lineHeight; }
    }

    public static class ReviewPreferences {
        private Integer dailyGoal;
        private String reminderTime;

        public Integer getDailyGoal() { return dailyGoal; }
        public void setDailyGoal(Integer dailyGoal) { this.dailyGoal = dailyGoal; }

        public String getReminderTime() { return reminderTime; }
        public void setReminderTime(String reminderTime) { this.reminderTime = reminderTime; }
    }

    public static class NotificationPreferences {
        private Boolean email;
        private Boolean push;

        public Boolean getEmail() { return email; }
        public void setEmail(Boolean email) { this.email = email; }

        public Boolean getPush() { return push; }
        public void setPush(Boolean push) { this.push = push; }
    }

    // 用户数据DTO（内联于此）
    public static class UserData {
        private int id;
        private String username;
        private String email;
        private String nickname;
        private String avatar;
        private String bio;
        private String location;
        private String website;
        private java.time.LocalDateTime joinDate;
        private java.time.LocalDateTime lastLogin;
        private boolean isVerified;
        private Preferences preferences;
        private PrivacySettings privacySettings;

        public UserData(int id, String username, String email, String nickname, String avatar,
                        String bio, String location, String website, java.time.LocalDateTime joinDate,
                        java.time.LocalDateTime lastLogin, boolean isVerified) {
            this.id = id;
            this.username = username;
            this.email = email;
            this.nickname = nickname;
            this.avatar = avatar;
            this.bio = bio;
            this.location = location;
            this.website = website;
            this.joinDate = joinDate;
            this.lastLogin = lastLogin;
            this.isVerified = isVerified;
            this.preferences = new Preferences();
            this.privacySettings = new PrivacySettings();
        }

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public String getUsername() { return username; }
        public void setUsername(String username) { this.username = username; }

        public String getEmail() { return email; }
        public void setEmail(String email) { this.email = email; }

        public String getNickname() { return nickname; }
        public void setNickname(String nickname) { this.nickname = nickname; }

        public String getAvatar() { return avatar; }
        public void setAvatar(String avatar) { this.avatar = avatar; }

        public String getBio() { return bio; }
        public void setBio(String bio) { this.bio = bio; }

        public String getLocation() { return location; }
        public void setLocation(String location) { this.location = location; }

        public String getWebsite() { return website; }
        public void setWebsite(String website) { this.website = website; }

        public java.time.LocalDateTime getJoinDate() { return joinDate; }
        public void setJoinDate(java.time.LocalDateTime joinDate) { this.joinDate = joinDate; }

        public java.time.LocalDateTime getLastLogin() { return lastLogin; }
        public void setLastLogin(java.time.LocalDateTime lastLogin) { this.lastLogin = lastLogin; }

        public boolean isVerified() { return isVerified; }
        public void setVerified(boolean verified) { isVerified = verified; }

        public Preferences getPreferences() { return preferences; }
        public void setPreferences(Preferences preferences) { this.preferences = preferences; }

        public PrivacySettings getPrivacySettings() { return privacySettings; }
        public void setPrivacySettings(PrivacySettings privacySettings) { this.privacySettings = privacySettings; }
    }

    public static class Preferences {
        private Reading reading = new Reading();
        private Review review = new Review();
        private Notification notification = new Notification();

        public Reading getReading() { return reading; }
        public void setReading(Reading reading) { this.reading = reading; }

        public Review getReview() { return review; }
        public void setReview(Review review) { this.review = review; }

        public Notification getNotification() { return notification; }
        public void setNotification(Notification notification) { this.notification = notification; }
    }

    public static class Reading {
        private int fontSize = 16;
        private String theme = "light";
        private double lineHeight = 1.6;

        public int getFontSize() { return fontSize; }
        public void setFontSize(int fontSize) { this.fontSize = fontSize; }

        public String getTheme() { return theme; }
        public void setTheme(String theme) { this.theme = theme; }

        public double getLineHeight() { return lineHeight; }
        public void setLineHeight(double lineHeight) { this.lineHeight = lineHeight; }
    }

    public static class Review {
        private int dailyGoal = 20;
        private String reminderTime = "20:00";

        public int getDailyGoal() { return dailyGoal; }
        public void setDailyGoal(int dailyGoal) { this.dailyGoal = dailyGoal; }

        public String getReminderTime() { return reminderTime; }
        public void setReminderTime(String reminderTime) { this.reminderTime = reminderTime; }
    }

    public static class Notification {
        private boolean email = true;
        private boolean push = true;

        public boolean isEmail() { return email; }
        public void setEmail(boolean email) { this.email = email; }

        public boolean isPush() { return push; }
        public void setPush(boolean push) { this.push = push; }
    }

    public static class PrivacySettings {
        private String profileVisibility = "public";
        private String activityVisibility = "friends";
        private String dataSharing = "limited";

        public String getProfileVisibility() { return profileVisibility; }
        public void setProfileVisibility(String profileVisibility) { this.profileVisibility = profileVisibility; }

        public String getActivityVisibility() { return activityVisibility; }
        public void setActivityVisibility(String activityVisibility) { this.activityVisibility = activityVisibility; }

        public String getDataSharing() { return dataSharing; }
        public void setDataSharing(String dataSharing) { this.dataSharing = dataSharing; }
    }

    // 响应DTO
    public static class UpdatePreferencesResponse {
        private boolean success;
        private String message;
        private UserData user;

        public UpdatePreferencesResponse(boolean success, String message, UserData user) {
            this.success = success;
            this.message = message;
            this.user = user;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public UserData getUser() { return user; }
        public void setUser(UserData user) { this.user = user; }
    }

    @PutMapping("/preferences")
    public ResponseEntity<UpdatePreferencesResponse> updateUserPreferences(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestBody UpdatePreferencesRequest request) {

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdatePreferencesResponse(false, "请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 验证token有效性
            String tokenSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdatePreferencesResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            int userId = (int) session.get("user_id");

            // 3. 验证请求数据
            if (request == null || (request.getReading() == null && request.getReview() == null && request.getNotification() == null)) {
                return ResponseEntity.badRequest().body(
                        new UpdatePreferencesResponse(false, "偏好设置数据不能为空", null)
                );
            }

            // 4. 查询现有的用户偏好设置
            String userSql = "SELECT preferences FROM users WHERE user_id = ?";
            List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, userId);

            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new UpdatePreferencesResponse(false, "用户不存在", null)
                );
            }

            Map<String, Object> user = users.get(0);
            String existingPreferencesJson = (String) user.get("preferences");

            // 5. 解析现有的偏好设置（简化处理，实际应该使用JSON解析）
            // 这里我们假设preferences字段存储的是JSON字符串
            // 由于是课设，我们简化处理，直接构建新的JSON

            // 6. 构建新的偏好设置JSON
            Map<String, Object> newPreferences = new HashMap<>();

            // 6.1 阅读偏好
            Map<String, Object> readingPrefs = new HashMap<>();
            if (request.getReading() != null) {
                if (request.getReading().getFontSize() != null) {
                    readingPrefs.put("fontSize", request.getReading().getFontSize());
                } else {
                    readingPrefs.put("fontSize", 16);
                }

                if (request.getReading().getTheme() != null) {
                    readingPrefs.put("theme", request.getReading().getTheme());
                } else {
                    readingPrefs.put("theme", "light");
                }

                if (request.getReading().getLineHeight() != null) {
                    readingPrefs.put("lineHeight", request.getReading().getLineHeight());
                } else {
                    readingPrefs.put("lineHeight", 1.6);
                }
            } else {
                // 使用默认值
                readingPrefs.put("fontSize", 16);
                readingPrefs.put("theme", "light");
                readingPrefs.put("lineHeight", 1.6);
            }
            newPreferences.put("reading", readingPrefs);

            // 6.2 复习偏好
            Map<String, Object> reviewPrefs = new HashMap<>();
            if (request.getReview() != null) {
                if (request.getReview().getDailyGoal() != null) {
                    reviewPrefs.put("dailyGoal", request.getReview().getDailyGoal());
                } else {
                    reviewPrefs.put("dailyGoal", 20);
                }

                if (request.getReview().getReminderTime() != null) {
                    reviewPrefs.put("reminderTime", request.getReview().getReminderTime());
                } else {
                    reviewPrefs.put("reminderTime", "20:00");
                }
            } else {
                // 使用默认值
                reviewPrefs.put("dailyGoal", 20);
                reviewPrefs.put("reminderTime", "20:00");
            }
            newPreferences.put("review", reviewPrefs);

            // 6.3 通知偏好
            Map<String, Object> notificationPrefs = new HashMap<>();
            if (request.getNotification() != null) {
                if (request.getNotification().getEmail() != null) {
                    notificationPrefs.put("email", request.getNotification().getEmail());
                } else {
                    notificationPrefs.put("email", true);
                }

                if (request.getNotification().getPush() != null) {
                    notificationPrefs.put("push", request.getNotification().getPush());
                } else {
                    notificationPrefs.put("push", true);
                }
            } else {
                // 使用默认值
                notificationPrefs.put("email", true);
                notificationPrefs.put("push", true);
            }
            newPreferences.put("notification", notificationPrefs);

            // 7. 更新用户偏好设置
            // 将Map转换为JSON字符串（简化处理，使用toString）
            String newPreferencesJson = newPreferences.toString();

            String updateSql = "UPDATE users SET preferences = ? WHERE user_id = ?";
            int rowsUpdated = jdbcTemplate.update(updateSql, newPreferencesJson, userId);

            printQueryResult("更新偏好设置行数: " + rowsUpdated);

            if (rowsUpdated == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new UpdatePreferencesResponse(false, "用户不存在", null)
                );
            }

            // 8. 查询更新后的用户信息（确保日期字段以LocalDateTime类型返回）
            String updatedUserSql = "SELECT user_id, username, email, nickname, avatar_url, bio, location, website, " +
                    "is_verified, CAST(created_at AS DATETIME) as created_at, CAST(last_login_at AS DATETIME) as last_login_at FROM users WHERE user_id = ?";
            
            List<Map<String, Object>> updatedUsers = jdbcTemplate.queryForList(updatedUserSql, userId);

            if (updatedUsers.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new UpdatePreferencesResponse(false, "用户不存在", null)
                );
            }

            Map<String, Object> updatedUser = updatedUsers.get(0);

            // 9. 格式化用户信息（处理可能的类型转换问题）
            LocalDateTime createdAt = null;
            LocalDateTime lastLoginAt = null;
            
            try {
                createdAt = (LocalDateTime) updatedUser.get("created_at");
            } catch (ClassCastException e) {
                // 如果转换失败，尝试从字符串解析
                String dateStr = (String) updatedUser.get("created_at");
                if (dateStr != null && !dateStr.isEmpty()) {
                    createdAt = LocalDateTime.parse(dateStr.replace(" ", "T"));
                }
            }
            
            try {
                lastLoginAt = (LocalDateTime) updatedUser.get("last_login_at");
            } catch (ClassCastException e) {
                // 如果转换失败，尝试从字符串解析
                String dateStr = (String) updatedUser.get("last_login_at");
                if (dateStr != null && !dateStr.isEmpty()) {
                    lastLoginAt = LocalDateTime.parse(dateStr.replace(" ", "T"));
                }
            }
            
            UserData userData = new UserData(
                    (int) updatedUser.get("user_id"),
                    (String) updatedUser.get("username"),
                    (String) updatedUser.get("email"),
                    updatedUser.get("nickname") != null ? (String) updatedUser.get("nickname") : (String) updatedUser.get("username"),
                    updatedUser.get("avatar_url") != null ? (String) updatedUser.get("avatar_url") : "",
                    updatedUser.get("bio") != null ? (String) updatedUser.get("bio") : "",
                    updatedUser.get("location") != null ? (String) updatedUser.get("location") : "",
                    updatedUser.get("website") != null ? (String) updatedUser.get("website") : "",
                    createdAt,
                    lastLoginAt,
                    updatedUser.get("is_verified") != null && (boolean) updatedUser.get("is_verified")
            );

            // 10. 准备响应数据
            UpdatePreferencesResponse response = new UpdatePreferencesResponse(true, "偏好设置已更新", userData);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("更新用户偏好设置过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdatePreferencesResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: UserUpdatePreferences.java ---

--- 开始文件: UserUpdateProfile.java ---
package com.vue.readingapp.user;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user")
public class UserUpdateProfile {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到更新用户信息请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class UpdateProfileRequest {
        private String nickname;
        private String bio;
        private String location;
        private String website;

        public String getNickname() { return nickname; }
        public void setNickname(String nickname) { this.nickname = nickname; }

        public String getBio() { return bio; }
        public void setBio(String bio) { this.bio = bio; }

        public String getLocation() { return location; }
        public void setLocation(String location) { this.location = location; }

        public String getWebsite() { return website; }
        public void setWebsite(String website) { this.website = website; }
    }

    // 用户数据DTO（与UserGetProfile中的相同，但内联于此）
    public static class UserData {
        private int id;
        private String username;
        private String email;
        private String nickname;
        private String avatar;
        private String bio;
        private String location;
        private String website;
        private java.time.LocalDateTime joinDate;
        private java.time.LocalDateTime lastLogin;
        private boolean isVerified;
        private Preferences preferences;
        private PrivacySettings privacySettings;

        public UserData(int id, String username, String email, String nickname, String avatar,
                        String bio, String location, String website, java.time.LocalDateTime joinDate,
                        java.time.LocalDateTime lastLogin, boolean isVerified) {
            this.id = id;
            this.username = username;
            this.email = email;
            this.nickname = nickname;
            this.avatar = avatar;
            this.bio = bio;
            this.location = location;
            this.website = website;
            this.joinDate = joinDate;
            this.lastLogin = lastLogin;
            this.isVerified = isVerified;
            this.preferences = new Preferences();
            this.privacySettings = new PrivacySettings();
        }

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public String getUsername() { return username; }
        public void setUsername(String username) { this.username = username; }

        public String getEmail() { return email; }
        public void setEmail(String email) { this.email = email; }

        public String getNickname() { return nickname; }
        public void setNickname(String nickname) { this.nickname = nickname; }

        public String getAvatar() { return avatar; }
        public void setAvatar(String avatar) { this.avatar = avatar; }

        public String getBio() { return bio; }
        public void setBio(String bio) { this.bio = bio; }

        public String getLocation() { return location; }
        public void setLocation(String location) { this.location = location; }

        public String getWebsite() { return website; }
        public void setWebsite(String website) { this.website = website; }

        public java.time.LocalDateTime getJoinDate() { return joinDate; }
        public void setJoinDate(java.time.LocalDateTime joinDate) { this.joinDate = joinDate; }

        public java.time.LocalDateTime getLastLogin() { return lastLogin; }
        public void setLastLogin(java.time.LocalDateTime lastLogin) { this.lastLogin = lastLogin; }

        public boolean isVerified() { return isVerified; }
        public void setVerified(boolean verified) { isVerified = verified; }

        public Preferences getPreferences() { return preferences; }
        public void setPreferences(Preferences preferences) { this.preferences = preferences; }

        public PrivacySettings getPrivacySettings() { return privacySettings; }
        public void setPrivacySettings(PrivacySettings privacySettings) { this.privacySettings = privacySettings; }
    }

    public static class Preferences {
        private Reading reading = new Reading();
        private Review review = new Review();
        private Notification notification = new Notification();

        public Reading getReading() { return reading; }
        public void setReading(Reading reading) { this.reading = reading; }

        public Review getReview() { return review; }
        public void setReview(Review review) { this.review = review; }

        public Notification getNotification() { return notification; }
        public void setNotification(Notification notification) { this.notification = notification; }
    }

    public static class Reading {
        private int fontSize = 16;
        private String theme = "light";
        private double lineHeight = 1.6;

        public int getFontSize() { return fontSize; }
        public void setFontSize(int fontSize) { this.fontSize = fontSize; }

        public String getTheme() { return theme; }
        public void setTheme(String theme) { this.theme = theme; }

        public double getLineHeight() { return lineHeight; }
        public void setLineHeight(double lineHeight) { this.lineHeight = lineHeight; }
    }

    public static class Review {
        private int dailyGoal = 20;
        private String reminderTime = "20:00";

        public int getDailyGoal() { return dailyGoal; }
        public void setDailyGoal(int dailyGoal) { this.dailyGoal = dailyGoal; }

        public String getReminderTime() { return reminderTime; }
        public void setReminderTime(String reminderTime) { this.reminderTime = reminderTime; }
    }

    public static class Notification {
        private boolean email = true;
        private boolean push = true;

        public boolean isEmail() { return email; }
        public void setEmail(boolean email) { this.email = email; }

        public boolean isPush() { return push; }
        public void setPush(boolean push) { this.push = push; }
    }

    public static class PrivacySettings {
        private String profileVisibility = "public";
        private String activityVisibility = "friends";
        private String dataSharing = "limited";

        public String getProfileVisibility() { return profileVisibility; }
        public void setProfileVisibility(String profileVisibility) { this.profileVisibility = profileVisibility; }

        public String getActivityVisibility() { return activityVisibility; }
        public void setActivityVisibility(String activityVisibility) { this.activityVisibility = activityVisibility; }

        public String getDataSharing() { return dataSharing; }
        public void setDataSharing(String dataSharing) { this.dataSharing = dataSharing; }
    }

    // 响应DTO
    public static class UpdateProfileResponse {
        private boolean success;
        private String message;
        private UserData user;

        public UpdateProfileResponse(boolean success, String message, UserData user) {
            this.success = success;
            this.message = message;
            this.user = user;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public UserData getUser() { return user; }
        public void setUser(UserData user) { this.user = user; }
    }

    @PutMapping("/profile")
    public ResponseEntity<UpdateProfileResponse> updateUserProfile(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestBody UpdateProfileRequest request) {

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateProfileResponse(false, "请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 验证token有效性
            String tokenSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateProfileResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            int userId = (int) session.get("user_id");

            // 3. 验证请求数据
            if (request.getNickname() != null && (request.getNickname().length() < 2 || request.getNickname().length() > 30)) {
                return ResponseEntity.badRequest().body(
                        new UpdateProfileResponse(false, "昵称长度必须在2-30个字符之间", null)
                );
            }

            if (request.getBio() != null && request.getBio().length() > 500) {
                return ResponseEntity.badRequest().body(
                        new UpdateProfileResponse(false, "个人简介不能超过500个字符", null)
                );
            }

            // 4. 构建更新SQL
            StringBuilder updateSql = new StringBuilder("UPDATE users SET ");
            List<Object> params = new java.util.ArrayList<>();

            if (request.getNickname() != null) {
                updateSql.append("nickname = ?, ");
                params.add(request.getNickname());
            }

            if (request.getBio() != null) {
                updateSql.append("bio = ?, ");
                params.add(request.getBio());
            }

            if (request.getLocation() != null) {
                updateSql.append("location = ?, ");
                params.add(request.getLocation());
            }

            if (request.getWebsite() != null) {
                updateSql.append("website = ?, ");
                params.add(request.getWebsite());
            }

            // 移除最后一个逗号和空格
            if (params.size() > 0) {
                updateSql.setLength(updateSql.length() - 2);
                updateSql.append(" WHERE user_id = ?");
                params.add(userId);

                // 执行更新
                int rowsUpdated = jdbcTemplate.update(updateSql.toString(), params.toArray());
                printQueryResult("更新行数: " + rowsUpdated);

                if (rowsUpdated == 0) {
                    return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                            new UpdateProfileResponse(false, "用户不存在", null)
                    );
                }
            } else {
                // 没有要更新的字段
                return ResponseEntity.badRequest().body(
                        new UpdateProfileResponse(false, "没有提供更新数据", null)
                );
            }

            // 5. 查询更新后的用户信息
            String userSql = "SELECT user_id, username, email, nickname, avatar_url, bio, location, website, " +
                    "is_verified, created_at, last_login_at FROM users WHERE user_id = ?";

            List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, userId);

            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new UpdateProfileResponse(false, "用户不存在", null)
                );
            }

            Map<String, Object> user = users.get(0);

            // 6. 格式化用户信息（保持LocalDateTime类型）
            UserData userData = new UserData(
                    (int) user.get("user_id"),
                    (String) user.get("username"),
                    (String) user.get("email"),
                    user.get("nickname") != null ? (String) user.get("nickname") : (String) user.get("username"),
                    user.get("avatar_url") != null ? (String) user.get("avatar_url") : "",
                    user.get("bio") != null ? (String) user.get("bio") : "",
                    user.get("location") != null ? (String) user.get("location") : "",
                    user.get("website") != null ? (String) user.get("website") : "",
                    (LocalDateTime) user.get("created_at"),
                    (LocalDateTime) user.get("last_login_at"),
                    user.get("is_verified") != null && (boolean) user.get("is_verified")
            );

            // 7. 准备响应数据
            UpdateProfileResponse response = new UpdateProfileResponse(true, "个人信息更新成功", userData);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("更新用户信息过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdateProfileResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: UserUpdateProfile.java ---

--- 开始文件: UserUpdateSubscription.java ---
package com.vue.readingapp.user;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user")
public class UserUpdateSubscription {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到更新订阅计划请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class UpdateSubscriptionRequest {
        private String plan_id;

        public String getPlan_id() { return plan_id; }
        public void setPlan_id(String plan_id) { this.plan_id = plan_id; }
    }

    // 响应DTO
    public static class UpdateSubscriptionResponse {
        private boolean success;
        private String message;
        private UserGetSubscriptionInfo.SubscriptionData subscription;

        public UpdateSubscriptionResponse(boolean success, String message, UserGetSubscriptionInfo.SubscriptionData subscription) {
            this.success = success;
            this.message = message;
            this.subscription = subscription;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public UserGetSubscriptionInfo.SubscriptionData getSubscription() { return subscription; }
        public void setSubscription(UserGetSubscriptionInfo.SubscriptionData subscription) { this.subscription = subscription; }
    }

    @PutMapping("/subscription")
    public ResponseEntity<UpdateSubscriptionResponse> updateSubscription(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestBody UpdateSubscriptionRequest request) {

        // 打印接收到的请求
        printRequest(request);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateSubscriptionResponse(false, "请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 验证token有效性
            String tokenSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ? AND expires_at > NOW()";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(tokenSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateSubscriptionResponse(false, "登录已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            int userId = (int) session.get("user_id");

            // 3. 验证请求数据
            if (request.getPlan_id() == null || request.getPlan_id().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new UpdateSubscriptionResponse(false, "计划ID不能为空", null)
                );
            }

            // 4. 验证计划ID是否有效
            String[] validPlanIds = {"free", "premium_monthly", "premium_yearly"};
            boolean validPlanId = false;
            for (String planId : validPlanIds) {
                if (planId.equals(request.getPlan_id())) {
                    validPlanId = true;
                    break;
                }
            }

            if (!validPlanId) {
                return ResponseEntity.badRequest().body(
                        new UpdateSubscriptionResponse(false, "无效的计划ID", null)
                );
            }

            // 5. 确定用户类型
            String userType;
            if (request.getPlan_id().startsWith("premium")) {
                userType = "premium";
            } else {
                userType = "free";
            }

            // 6. 更新用户类型（假设users表有user_type字段）
            String updateSql = "UPDATE users SET user_type = ? WHERE user_id = ?";
            int rowsUpdated = jdbcTemplate.update(updateSql, userType, userId);

            printQueryResult("更新订阅行数: " + rowsUpdated);

            if (rowsUpdated == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new UpdateSubscriptionResponse(false, "用户不存在", null)
                );
            }

            // 7. 查询更新后的用户信息
            String userSql = "SELECT user_id, username, email, user_type, created_at FROM users WHERE user_id = ?";
            List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, userId);

            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new UpdateSubscriptionResponse(false, "用户不存在", null)
                );
            }

            Map<String, Object> user = users.get(0);

            // 8. 构建订阅数据
            UserGetSubscriptionInfo.SubscriptionData subscription = new UserGetSubscriptionInfo.SubscriptionData();

            // 设置订阅类型和状态
            subscription.setType(userType);
            subscription.setStatus("active".equals(userType) ? "active" : "inactive");

            // 设置日期信息
            LocalDateTime now = LocalDateTime.now();
            DateTimeFormatter formatter = DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss");

            // 假设订阅开始时间是用户注册时间
            LocalDateTime startDate = (LocalDateTime) user.get("created_at");
            subscription.setStartDate(startDate.format(formatter));

            // 如果是付费用户，设置结束时间和续订时间
            if ("premium".equals(userType)) {
                LocalDateTime endDate = startDate.plusMonths(1);
                subscription.setEndDate(endDate.format(formatter));
                subscription.setRenewalDate(endDate.format(formatter));
                subscription.setAutoRenew(true);
            } else {
                subscription.setEndDate("");
                subscription.setRenewalDate("");
                subscription.setAutoRenew(false);
            }

            // 9. 构建计划数据
            UserGetSubscriptionInfo.PlanData plan;
            if ("premium".equals(userType)) {
                if (request.getPlan_id().equals("premium_yearly")) {
                    plan = new UserGetSubscriptionInfo.PlanData(
                            "premium_yearly",
                            "高级会员（年付）",
                            299.99,
                            "CNY",
                            "yearly",
                            "享受所有高级功能，年付更优惠"
                    );
                } else {
                    plan = new UserGetSubscriptionInfo.PlanData(
                            "premium_monthly",
                            "高级会员（月付）",
                            29.99,
                            "CNY",
                            "monthly",
                            "享受所有高级功能，包括无限文档、高级词汇管理、个性化学习报告等"
                    );
                }
            } else {
                plan = new UserGetSubscriptionInfo.PlanData(
                        "free",
                        "免费版",
                        0.00,
                        "CNY",
                        "none",
                        "基础功能，包括有限文档管理、基础词汇学习、基本学习统计"
                );
            }
            subscription.setPlan(plan);

            // 10. 构建功能列表
            List<UserGetSubscriptionInfo.FeatureData> features = new java.util.ArrayList<>();

            if ("premium".equals(userType)) {
                features.add(new UserGetSubscriptionInfo.FeatureData("无限文档", "上传和管理无限数量的文档", true));
                features.add(new UserGetSubscriptionInfo.FeatureData("高级词汇管理", "使用智能分类和标签管理词汇", true));
                features.add(new UserGetSubscriptionInfo.FeatureData("个性化学习报告", "获取详细的学习分析和建议", true));
                features.add(new UserGetSubscriptionInfo.FeatureData("离线同步", "在所有设备上同步学习数据", true));
                features.add(new UserGetSubscriptionInfo.FeatureData("优先支持", "获得优先技术支持", true));
            } else {
                features.add(new UserGetSubscriptionInfo.FeatureData("有限文档", "最多上传10个文档", true));
                features.add(new UserGetSubscriptionInfo.FeatureData("基础词汇管理", "基本的词汇添加和查看", true));
                features.add(new UserGetSubscriptionInfo.FeatureData("基本学习统计", "查看基础的学习数据", true));
                features.add(new UserGetSubscriptionInfo.FeatureData("离线同步", "基础数据同步", false));
                features.add(new UserGetSubscriptionInfo.FeatureData("标准支持", "获得标准技术支持", true));
            }
            subscription.setFeatures(features);

            // 11. 构建账单数据
            UserGetSubscriptionInfo.BillingData billing;
            if ("premium".equals(userType)) {
                if (request.getPlan_id().equals("premium_yearly")) {
                    billing = new UserGetSubscriptionInfo.BillingData(
                            startDate.format(formatter),
                            299.99,
                            startDate.plusYears(1).format(formatter),
                            299.99,
                            "credit_card"
                    );
                } else {
                    billing = new UserGetSubscriptionInfo.BillingData(
                            startDate.format(formatter),
                            29.99,
                            startDate.plusMonths(1).format(formatter),
                            29.99,
                            "credit_card"
                    );
                }
            } else {
                billing = new UserGetSubscriptionInfo.BillingData(
                        "",
                        0.00,
                        "",
                        0.00,
                        ""
                );
            }
            subscription.setBilling(billing);

            // 12. 准备响应数据
            UpdateSubscriptionResponse response = new UpdateSubscriptionResponse(
                    true, "订阅计划更新成功", subscription);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("更新订阅计划过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdateSubscriptionResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: UserUpdateSubscription.java ---

