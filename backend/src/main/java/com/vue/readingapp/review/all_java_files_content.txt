--- 开始文件: ReviewBatchSubmit.java ---
package com.vue.readingapp.review;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.*;

@RestController
@RequestMapping("/api/v1/review")
public class ReviewBatchSubmit {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到批量提交复习结果请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("时间: " + LocalDateTime.now());
        System.out.println("==========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class BatchSubmitRequest {
        private List<BatchReviewResult> results;
        private String session_id;
        private Integer duration;
        private String mode;

        public List<BatchReviewResult> getResults() { return results; }
        public void setResults(List<BatchReviewResult> results) { this.results = results; }

        public String getSession_id() { return session_id; }
        public void setSession_id(String session_id) { this.session_id = session_id; }

        public Integer getDuration() { return duration; }
        public void setDuration(Integer duration) { this.duration = duration; }

        public String getMode() { return mode; }
        public void setMode(String mode) { this.mode = mode; }
    }

    public static class BatchReviewResult {
        private String word_id;
        private boolean correct;
        private Integer response_time;
        private String review_type;

        public String getWord_id() { return word_id; }
        public void setWord_id(String word_id) { this.word_id = word_id; }

        public boolean isCorrect() { return correct; }
        public void setCorrect(boolean correct) { this.correct = correct; }

        public Integer getResponse_time() { return response_time; }
        public void setResponse_time(Integer response_time) { this.response_time = response_time; }

        public String getReview_type() { return review_type; }
        public void setReview_type(String review_type) { this.review_type = review_type; }
    }

    public static class BatchSubmitResponse {
        private boolean success;
        private String message;
        private BatchResultData data;

        public BatchSubmitResponse(boolean success, String message, BatchResultData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public BatchResultData getData() { return data; }
        public void setData(BatchResultData data) { this.data = data; }
    }

    public static class BatchResultData {
        private String session_id;
        private int total_words;
        private int correct_words;
        private int incorrect_words;
        private double accuracy;
        private int duration;
        private double average_response_time;
        private int updated_words_count;
        private String timestamp;

        public BatchResultData(String session_id, int total_words, int correct_words,
                               int incorrect_words, double accuracy, int duration,
                               double average_response_time, int updated_words_count, String timestamp) {
            this.session_id = session_id;
            this.total_words = total_words;
            this.correct_words = correct_words;
            this.incorrect_words = incorrect_words;
            this.accuracy = accuracy;
            this.duration = duration;
            this.average_response_time = average_response_time;
            this.updated_words_count = updated_words_count;
            this.timestamp = timestamp;
        }

        public String getSession_id() { return session_id; }
        public void setSession_id(String session_id) { this.session_id = session_id; }

        public int getTotal_words() { return total_words; }
        public void setTotal_words(int total_words) { this.total_words = total_words; }

        public int getCorrect_words() { return correct_words; }
        public void setCorrect_words(int correct_words) { this.correct_words = correct_words; }

        public int getIncorrect_words() { return incorrect_words; }
        public void setIncorrect_words(int incorrect_words) { this.incorrect_words = incorrect_words; }

        public double getAccuracy() { return accuracy; }
        public void setAccuracy(double accuracy) { this.accuracy = accuracy; }

        public int getDuration() { return duration; }
        public void setDuration(int duration) { this.duration = duration; }

        public double getAverage_response_time() { return average_response_time; }
        public void setAverage_response_time(double average_response_time) { this.average_response_time = average_response_time; }

        public int getUpdated_words_count() { return updated_words_count; }
        public void setUpdated_words_count(int updated_words_count) { this.updated_words_count = updated_words_count; }

        public String getTimestamp() { return timestamp; }
        public void setTimestamp(String timestamp) { this.timestamp = timestamp; }
    }

    @PostMapping("/batch-submit")
    public ResponseEntity<BatchSubmitResponse> batchSubmitReview(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestBody BatchSubmitRequest request) {

        printRequest(request);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new BatchSubmitResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT u.user_id FROM users u " +
                    "JOIN user_sessions us ON u.user_id = us.user_id " +
                    "WHERE us.access_token = ? AND us.expires_at > NOW()";

            List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, token);
            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new BatchSubmitResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) users.get(0).get("user_id");
            System.out.println("当前用户ID: " + userId);

            // 2. 验证请求数据
            if (request.getResults() == null || request.getResults().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new BatchSubmitResponse(false, "复习结果不能为空", null)
                );
            }

            if (request.getSession_id() == null || request.getSession_id().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new BatchSubmitResponse(false, "会话ID不能为空", null)
                );
            }

            // 3. 处理批量复习结果
            int totalWords = request.getResults().size();
            int correctWords = 0;
            int totalResponseTime = 0;
            int responseTimeCount = 0;
            int updatedWordsCount = 0;
            LocalDateTime now = LocalDateTime.now();

            // 用于记录更新的单词
            List<Map<String, Object>> updatedWords = new ArrayList<>();

            for (BatchReviewResult result : request.getResults()) {
                // 验证单词ID
                if (result.getWord_id() == null || result.getWord_id().trim().isEmpty()) {
                    continue;
                }

                // 统计正确单词数
                if (result.isCorrect()) {
                    correctWords++;
                }

                // 统计响应时间
                if (result.getResponse_time() != null && result.getResponse_time() > 0) {
                    totalResponseTime += result.getResponse_time();
                    responseTimeCount++;
                }

                // 更新用户词汇状态
                try {
                    int userVocabId = Integer.parseInt(result.getWord_id());
                    Map<String, Object> updatedWord = updateUserVocabularyBatch(userId, userVocabId, result.isCorrect(), now);
                    if (updatedWord != null) {
                        updatedWords.add(updatedWord);
                        updatedWordsCount++;
                    }
                } catch (NumberFormatException e) {
                    System.err.println("单词ID格式错误: " + result.getWord_id());
                }
            }

            // 4. 计算统计数据
            int incorrectWords = totalWords - correctWords;
            double accuracy = totalWords > 0 ? (correctWords * 100.0 / totalWords) : 0;
            double averageResponseTime = responseTimeCount > 0 ? (totalResponseTime * 1.0 / responseTimeCount) : 0;

            // 5. 创建复习会话记录
            createReviewSessionBatch(userId, request.getSession_id(), totalWords, correctWords,
                    accuracy, request.getDuration() != null ? request.getDuration() : 0,
                    request.getMode() != null ? request.getMode() : "review", now);

            // 6. 更新每日学习统计
            updateDailyLearningStatsBatch(userId, correctWords, incorrectWords, now);

            // 7. 构建响应数据
            BatchResultData data = new BatchResultData(
                    request.getSession_id(),
                    totalWords,
                    correctWords,
                    incorrectWords,
                    Math.round(accuracy * 100.0) / 100.0,
                    request.getDuration() != null ? request.getDuration() : 0,
                    Math.round(averageResponseTime * 100.0) / 100.0,
                    updatedWordsCount,
                    now.toString()
            );

            BatchSubmitResponse response = new BatchSubmitResponse(true, "批量提交复习结果成功", data);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("批量提交复习结果过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new BatchSubmitResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private Map<String, Object> updateUserVocabularyBatch(int userId, int userVocabId, boolean correct, LocalDateTime now) {
        try {
            // 1. 获取当前词汇状态
            String selectSql = "SELECT uv.mastery_level, uv.review_count, w.word " +
                    "FROM user_vocabulary uv " +
                    "JOIN words w ON uv.word_id = w.word_id " +
                    "WHERE uv.user_vocab_id = ? AND uv.user_id = ?";

            List<Map<String, Object>> vocabList = jdbcTemplate.queryForList(selectSql, userVocabId, userId);
            if (vocabList.isEmpty()) {
                return null;
            }

            Map<String, Object> vocab = vocabList.get(0);
            int currentMasteryLevel = ((Number) vocab.get("mastery_level")).intValue();
            int currentReviewCount = ((Number) vocab.get("review_count")).intValue();
            String word = (String) vocab.get("word");

            // 2. 计算新的掌握等级（简单算法）
            int newMasteryLevel = currentMasteryLevel;
            if (correct) {
                newMasteryLevel = Math.min(currentMasteryLevel + 1, 10); // 最大10级
            } else {
                newMasteryLevel = Math.max(currentMasteryLevel - 1, 0); // 最小0级
            }

            // 3. 计算下次复习时间（基于掌握等级的间隔重复算法）
            int daysToAdd = calculateNextReviewDaysBatch(newMasteryLevel);
            LocalDateTime nextReviewDate = now.plusDays(daysToAdd);

            // 4. 更新数据库
            String updateSql = "UPDATE user_vocabulary SET " +
                    "mastery_level = ?, " +
                    "review_count = review_count + 1, " +
                    "last_reviewed_at = ?, " +
                    "next_review_date = ?, " +
                    "is_mastered = CASE WHEN mastery_level >= 8 THEN 1 ELSE 0 END " +
                    "WHERE user_vocab_id = ? AND user_id = ?";

            int updated = jdbcTemplate.update(updateSql,
                    newMasteryLevel,
                    now,
                    nextReviewDate,
                    userVocabId,
                    userId
            );

            if (updated > 0) {
                Map<String, Object> result = new HashMap<>();
                result.put("id", userVocabId);
                result.put("word", word);
                result.put("mastery_level", newMasteryLevel);
                result.put("review_count", currentReviewCount + 1);
                result.put("next_review_at", nextReviewDate.toString());
                return result;
            }

            return null;

        } catch (Exception e) {
            System.err.println("批量更新用户词汇状态失败: " + e.getMessage());
            return null;
        }
    }

    private int calculateNextReviewDaysBatch(int masteryLevel) {
        // 简单的间隔重复算法
        switch (masteryLevel) {
            case 0: return 1;   // 第1级：1天后复习
            case 1: return 2;   // 第2级：2天后复习
            case 2: return 4;   // 第3级：4天后复习
            case 3: return 7;   // 第4级：7天后复习
            case 4: return 14;  // 第5级：14天后复习
            case 5: return 30;  // 第6级：30天后复习
            case 6: return 60;  // 第7级：60天后复习
            case 7: return 90;  // 第8级：90天后复习
            case 8: return 180; // 第9级：180天后复习
            case 9: return 365; // 第10级：365天后复习
            default: return 30; // 默认30天
        }
    }

    private void createReviewSessionBatch(int userId, String sessionId, int totalWords,
                                          int correctWords, double accuracy, int duration,
                                          String mode, LocalDateTime now) {
        try {
            String sql = "INSERT INTO review_sessions " +
                    "(session_id, user_id, total_words, correct_words, accuracy, " +
                    "duration, mode, completed_at, created_at) " +
                    "VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)";

            jdbcTemplate.update(sql,
                    sessionId,
                    userId,
                    totalWords,
                    correctWords,
                    accuracy,
                    duration,
                    mode,
                    now,
                    now
            );

            System.out.println("批量创建复习会话记录成功: " + sessionId);

        } catch (Exception e) {
            System.err.println("批量创建复习会话记录失败: " + e.getMessage());
        }
    }

    private void updateDailyLearningStatsBatch(int userId, int correctWords, int incorrectWords, LocalDateTime now) {
        try {
            String dateStr = now.toLocalDate().toString();

            // 检查是否已有今日记录
            String checkSql = "SELECT COUNT(*) FROM daily_learning_stats " +
                    "WHERE user_id = ? AND learning_date = ?";

            int count = jdbcTemplate.queryForObject(checkSql, Integer.class, userId, dateStr);

            if (count > 0) {
                // 更新现有记录
                String updateSql = "UPDATE daily_learning_stats SET " +
                        "words_reviewed = words_reviewed + ?, " +
                        "words_correct = words_correct + ?, " +
                        "words_incorrect = words_incorrect + ?, " +
                        "updated_at = ? " +
                        "WHERE user_id = ? AND learning_date = ?";

                jdbcTemplate.update(updateSql,
                        correctWords + incorrectWords,
                        correctWords,
                        incorrectWords,
                        now,
                        userId,
                        dateStr
                );
            } else {
                // 创建新记录
                String insertSql = "INSERT INTO daily_learning_stats " +
                        "(user_id, learning_date, words_reviewed, " +
                        "words_correct, words_incorrect, created_at, updated_at) " +
                        "VALUES (?, ?, ?, ?, ?, ?, ?)";

                jdbcTemplate.update(insertSql,
                        userId,
                        dateStr,
                        correctWords + incorrectWords,
                        correctWords,
                        incorrectWords,
                        now,
                        now
                );
            }

            System.out.println("批量更新每日学习统计成功");

        } catch (Exception e) {
            System.err.println("批量更新每日学习统计失败: " + e.getMessage());
        }
    }
}

--- 结束文件: ReviewBatchSubmit.java ---

--- 开始文件: ReviewClearHistory.java ---
package com.vue.readingapp.review;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.*;

@RestController
@RequestMapping("/api/v1/review")
public class ReviewClearHistory {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到清空复习历史请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("时间: " + LocalDateTime.now());
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class ClearHistoryResponse {
        private boolean success;
        private String message;
        private ClearHistoryData data;

        public ClearHistoryResponse(boolean success, String message, ClearHistoryData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public ClearHistoryData getData() { return data; }
        public void setData(ClearHistoryData data) { this.data = data; }
    }

    public static class ClearHistoryData {
        private int deleted_count;

        public ClearHistoryData(int deleted_count) {
            this.deleted_count = deleted_count;
        }

        public int getDeleted_count() { return deleted_count; }
        public void setDeleted_count(int deleted_count) { this.deleted_count = deleted_count; }
    }

    @DeleteMapping("/history")
    public ResponseEntity<ClearHistoryResponse> clearAllReviewHistory(
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        printRequest("清空所有复习历史");

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ClearHistoryResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT u.user_id FROM users u " +
                    "JOIN user_sessions us ON u.user_id = us.user_id " +
                    "WHERE us.access_token = ? AND us.expires_at > NOW()";

            List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, token);
            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ClearHistoryResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) users.get(0).get("user_id");
            System.out.println("当前用户ID: " + userId);

            // 2. 获取删除前的记录数
            String countSql = "SELECT COUNT(*) FROM review_sessions WHERE user_id = ?";
            int beforeCount = jdbcTemplate.queryForObject(countSql, Integer.class, userId);

            // 3. 删除所有复习历史
            String deleteSql = "DELETE FROM review_sessions WHERE user_id = ?";
            int deleted = jdbcTemplate.update(deleteSql, userId);

            printQueryResult("删除前记录数: " + beforeCount + ", 删除记录数: " + deleted);

            if (deleted > 0) {
                ClearHistoryData data = new ClearHistoryData(deleted);
                ClearHistoryResponse response = new ClearHistoryResponse(true, "清空复习历史成功", data);
                printResponse(response);
                return ResponseEntity.ok(response);
            } else {
                ClearHistoryData data = new ClearHistoryData(0);
                ClearHistoryResponse response = new ClearHistoryResponse(true, "没有可删除的复习历史", data);
                printResponse(response);
                return ResponseEntity.ok(response);
            }

        } catch (Exception e) {
            System.err.println("清空复习历史过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ClearHistoryResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: ReviewClearHistory.java ---

--- 开始文件: ReviewDeleteHistory.java ---
package com.vue.readingapp.review;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.*;

@RestController
@RequestMapping("/api/v1/review")
public class ReviewDeleteHistory {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到删除复习历史请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("时间: " + LocalDateTime.now());
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class DeleteHistoryResponse {
        private boolean success;
        private String message;

        public DeleteHistoryResponse(boolean success, String message) {
            this.success = success;
            this.message = message;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }
    }

    @DeleteMapping("/sessions/{sessionId}")
    public ResponseEntity<DeleteHistoryResponse> deleteReviewHistory(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @PathVariable String sessionId) {

        printRequest("sessionId: " + sessionId);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new DeleteHistoryResponse(false, "请先登录")
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT u.user_id FROM users u " +
                    "JOIN user_sessions us ON u.user_id = us.user_id " +
                    "WHERE us.access_token = ? AND us.expires_at > NOW()";

            List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, token);
            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new DeleteHistoryResponse(false, "登录已过期，请重新登录")
                );
            }

            int userId = (int) users.get(0).get("user_id");
            System.out.println("当前用户ID: " + userId);

            // 2. 检查会话是否存在
            String checkSql = "SELECT COUNT(*) FROM review_sessions " +
                    "WHERE session_id = ? AND user_id = ?";

            int count = jdbcTemplate.queryForObject(checkSql, Integer.class, sessionId, userId);

            if (count == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new DeleteHistoryResponse(false, "复习会话不存在")
                );
            }

            // 3. 删除会话
            String deleteSql = "DELETE FROM review_sessions WHERE session_id = ? AND user_id = ?";
            int deleted = jdbcTemplate.update(deleteSql, sessionId, userId);

            printQueryResult("删除记录数: " + deleted);

            if (deleted > 0) {
                DeleteHistoryResponse response = new DeleteHistoryResponse(true, "删除复习历史成功");
                printResponse(response);
                return ResponseEntity.ok(response);
            } else {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new DeleteHistoryResponse(false, "删除复习历史失败")
                );
            }

        } catch (Exception e) {
            System.err.println("删除复习历史过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new DeleteHistoryResponse(false, "服务器内部错误: " + e.getMessage())
            );
        }
    }
}

--- 结束文件: ReviewDeleteHistory.java ---

--- 开始文件: ReviewGetCalendar.java ---
package com.vue.readingapp.review;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.*;
import java.time.LocalDate;
import java.time.YearMonth;
import java.time.format.DateTimeFormatter;

@RestController
@RequestMapping("/api/v1/review")
public class ReviewGetCalendar {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到获取复习日历请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("时间: " + LocalDateTime.now());
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class ReviewCalendarResponse {
        private boolean success;
        private String message;
        private CalendarData data;

        public ReviewCalendarResponse(boolean success, String message, CalendarData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public CalendarData getData() { return data; }
        public void setData(CalendarData data) { this.data = data; }
    }

    public static class CalendarData {
        private int year;
        private int month;
        private List<CalendarDay> days;
        private int total_reviews;
        private int average_daily_reviews;
        private int streak;
        private Map<String, Integer> heatmap_data;

        public CalendarData(int year, int month, List<CalendarDay> days, int total_reviews,
                            int average_daily_reviews, int streak, Map<String, Integer> heatmap_data) {
            this.year = year;
            this.month = month;
            this.days = days;
            this.total_reviews = total_reviews;
            this.average_daily_reviews = average_daily_reviews;
            this.streak = streak;
            this.heatmap_data = heatmap_data;
        }

        public int getYear() { return year; }
        public void setYear(int year) { this.year = year; }

        public int getMonth() { return month; }
        public void setMonth(int month) { this.month = month; }

        public List<CalendarDay> getDays() { return days; }
        public void setDays(List<CalendarDay> days) { this.days = days; }

        public int getTotal_reviews() { return total_reviews; }
        public void setTotal_reviews(int total_reviews) { this.total_reviews = total_reviews; }

        public int getAverage_daily_reviews() { return average_daily_reviews; }
        public void setAverage_daily_reviews(int average_daily_reviews) { this.average_daily_reviews = average_daily_reviews; }

        public int getStreak() { return streak; }
        public void setStreak(int streak) { this.streak = streak; }

        public Map<String, Integer> getHeatmap_data() { return heatmap_data; }
        public void setHeatmap_data(Map<String, Integer> heatmap_data) { this.heatmap_data = heatmap_data; }
    }

    public static class CalendarDay {
        private String date;
        private int review_count;
        private int word_count;
        private double accuracy;
        private boolean has_review;

        public CalendarDay(String date, int review_count, int word_count, double accuracy, boolean has_review) {
            this.date = date;
            this.review_count = review_count;
            this.word_count = word_count;
            this.accuracy = accuracy;
            this.has_review = has_review;
        }

        public String getDate() { return date; }
        public void setDate(String date) { this.date = date; }

        public int getReview_count() { return review_count; }
        public void setReview_count(int review_count) { this.review_count = review_count; }

        public int getWord_count() { return word_count; }
        public void setWord_count(int word_count) { this.word_count = word_count; }

        public double getAccuracy() { return accuracy; }
        public void setAccuracy(double accuracy) { this.accuracy = accuracy; }

        public boolean isHas_review() { return has_review; }
        public void setHas_review(boolean has_review) { this.has_review = has_review; }
    }

    @GetMapping("/calendar")
    public ResponseEntity<ReviewCalendarResponse> getReviewCalendar(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestParam(value = "year", required = false) Integer yearParam,
            @RequestParam(value = "month", required = false) Integer monthParam) {

        Map<String, Object> requestParams = new HashMap<>();
        requestParams.put("year", yearParam);
        requestParams.put("month", monthParam);
        printRequest(requestParams);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ReviewCalendarResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT u.user_id FROM users u " +
                    "JOIN user_sessions us ON u.user_id = us.user_id " +
                    "WHERE us.access_token = ? AND us.expires_at > NOW()";

            List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, token);
            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ReviewCalendarResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) users.get(0).get("user_id");
            System.out.println("当前用户ID: " + userId);

            // 2. 确定年份和月份
            LocalDateTime now = LocalDateTime.now();
            int year = yearParam != null ? yearParam : now.getYear();
            int month = monthParam != null ? monthParam : now.getMonthValue();

            // 验证年份和月份
            if (year < 2000 || year > 2100) year = now.getYear();
            if (month < 1 || month > 12) month = now.getMonthValue();

            // 3. 获取该月的所有日期
            YearMonth yearMonth = YearMonth.of(year, month);
            LocalDate firstDay = yearMonth.atDay(1);
            LocalDate lastDay = yearMonth.atEndOfMonth();

            // 4. 查询该月的复习数据
            String reviewSql = "SELECT DATE(completed_at) as review_date, " +
                    "COUNT(*) as session_count, " +
                    "SUM(total_words) as total_words, " +
                    "COALESCE(AVG(accuracy), 0) as avg_accuracy " +
                    "FROM review_sessions " +
                    "WHERE user_id = ? AND DATE(completed_at) BETWEEN ? AND ? " +
                    "GROUP BY DATE(completed_at)";

            List<Map<String, Object>> reviewData = jdbcTemplate.queryForList(
                    reviewSql, userId, firstDay.toString(), lastDay.toString());

            printQueryResult("查询到 " + reviewData.size() + " 天的复习数据");

            // 5. 构建日期数据映射
            Map<String, Map<String, Object>> dateDataMap = new HashMap<>();
            for (Map<String, Object> row : reviewData) {
                String date = ((java.sql.Date) row.get("review_date")).toString();
                dateDataMap.put(date, row);
            }

            // 6. 构建日历天数数据
            List<CalendarDay> days = new ArrayList<>();
            LocalDate currentDate = firstDay;
            int totalReviews = 0;
            int daysWithReviews = 0;

            while (!currentDate.isAfter(lastDay)) {
                String dateStr = currentDate.toString();
                Map<String, Object> dayData = dateDataMap.get(dateStr);

                int reviewCount = 0;
                int wordCount = 0;
                double accuracy = 0.0;
                boolean hasReview = false;

                if (dayData != null) {
                    reviewCount = ((Number) dayData.get("session_count")).intValue();
                    wordCount = ((Number) dayData.get("total_words")).intValue();
                    accuracy = ((Number) dayData.get("avg_accuracy")).doubleValue();
                    hasReview = true;

                    totalReviews += reviewCount;
                    daysWithReviews++;
                }

                CalendarDay day = new CalendarDay(
                        dateStr,
                        reviewCount,
                        wordCount,
                        Math.round(accuracy * 100.0) / 100.0,
                        hasReview
                );

                days.add(day);
                currentDate = currentDate.plusDays(1);
            }

            // 7. 计算平均每日复习次数
            int averageDailyReviews = daysWithReviews > 0 ? totalReviews / daysWithReviews : 0;

            // 8. 获取连续学习天数
            int streak = calculateStreakDays(userId);

            // 9. 构建热力图数据
            Map<String, Integer> heatmapData = new HashMap<>();
            for (CalendarDay day : days) {
                heatmapData.put(day.getDate(), day.getWord_count());
            }

            // 10. 构建响应数据
            CalendarData data = new CalendarData(
                    year,
                    month,
                    days,
                    totalReviews,
                    averageDailyReviews,
                    streak,
                    heatmapData
            );

            ReviewCalendarResponse response = new ReviewCalendarResponse(true, "获取复习日历成功", data);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取复习日历过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ReviewCalendarResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private int calculateStreakDays(int userId) {
        try {
            // 获取用户有复习记录的所有日期
            String sql = "SELECT DISTINCT DATE(completed_at) as review_date " +
                    "FROM review_sessions " +
                    "WHERE user_id = ? " +
                    "ORDER BY review_date DESC";

            List<Map<String, Object>> dates = jdbcTemplate.queryForList(sql, userId);

            if (dates.isEmpty()) {
                return 0;
            }

            LocalDateTime now = LocalDateTime.now();
            LocalDate today = now.toLocalDate();
            LocalDate yesterday = today.minusDays(1);
            int streak = 0;

            // 检查今天是否有复习
            boolean todayReviewed = false;
            for (Map<String, Object> dateRow : dates) {
                LocalDate reviewDate = ((java.sql.Date) dateRow.get("review_date")).toLocalDate();
                if (reviewDate.equals(today)) {
                    todayReviewed = true;
                    streak = 1;
                    break;
                }
            }

            // 如果今天没有复习，检查昨天是否有
            if (!todayReviewed) {
                for (Map<String, Object> dateRow : dates) {
                    LocalDate reviewDate = ((java.sql.Date) dateRow.get("review_date")).toLocalDate();
                    if (reviewDate.equals(yesterday)) {
                        streak = 1;
                        break;
                    }
                }
            }

            // 计算连续天数
            if (streak > 0) {
                LocalDate expectedDate = todayReviewed ? today.minusDays(1) : yesterday.minusDays(1);

                for (Map<String, Object> dateRow : dates) {
                    LocalDate reviewDate = ((java.sql.Date) dateRow.get("review_date")).toLocalDate();

                    if (reviewDate.equals(expectedDate)) {
                        streak++;
                        expectedDate = expectedDate.minusDays(1);
                    } else if (reviewDate.isBefore(expectedDate)) {
                        // 跳过中间缺失的日期
                        expectedDate = reviewDate.minusDays(1);
                    }
                }
            }

            return streak;

        } catch (Exception e) {
            System.err.println("计算连续学习天数失败: " + e.getMessage());
            return 0;
        }
    }
}

--- 结束文件: ReviewGetCalendar.java ---

--- 开始文件: ReviewGetDailyGoal.java ---
package com.vue.readingapp.review;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.time.LocalDate;
import java.util.*;

@RestController
@RequestMapping("/api/v1/review")
public class ReviewGetDailyGoal {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到获取每日目标请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("时间: " + LocalDateTime.now());
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class DailyGoalResponse {
        private boolean success;
        private String message;
        private DailyGoalData data;

        public DailyGoalResponse(boolean success, String message, DailyGoalData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public DailyGoalData getData() { return data; }
        public void setData(DailyGoalData data) { this.data = data; }
    }

    public static class DailyGoalData {
        private int target_words;
        private int streak_days;
        private int completed_today;
        private double today_progress;
        private double average_daily_words;
        private int best_day;
        private String reminder_time;
        private boolean is_reminder_enabled;

        public DailyGoalData(int target_words, int streak_days, int completed_today,
                             double today_progress, double average_daily_words, int best_day,
                             String reminder_time, boolean is_reminder_enabled) {
            this.target_words = target_words;
            this.streak_days = streak_days;
            this.completed_today = completed_today;
            this.today_progress = today_progress;
            this.average_daily_words = average_daily_words;
            this.best_day = best_day;
            this.reminder_time = reminder_time;
            this.is_reminder_enabled = is_reminder_enabled;
        }

        public int getTarget_words() { return target_words; }
        public void setTarget_words(int target_words) { this.target_words = target_words; }

        public int getStreak_days() { return streak_days; }
        public void setStreak_days(int streak_days) { this.streak_days = streak_days; }

        public int getCompleted_today() { return completed_today; }
        public void setCompleted_today(int completed_today) { this.completed_today = completed_today; }

        public double getToday_progress() { return today_progress; }
        public void setToday_progress(double today_progress) { this.today_progress = today_progress; }

        public double getAverage_daily_words() { return average_daily_words; }
        public void setAverage_daily_words(double average_daily_words) { this.average_daily_words = average_daily_words; }

        public int getBest_day() { return best_day; }
        public void setBest_day(int best_day) { this.best_day = best_day; }

        public String getReminder_time() { return reminder_time; }
        public void setReminder_time(String reminder_time) { this.reminder_time = reminder_time; }

        public boolean isIs_reminder_enabled() { return is_reminder_enabled; }
        public void setIs_reminder_enabled(boolean is_reminder_enabled) { this.is_reminder_enabled = is_reminder_enabled; }
    }

    @GetMapping("/daily-goal")
    public ResponseEntity<DailyGoalResponse> getDailyGoal(
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        printRequest("获取每日目标");

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new DailyGoalResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT u.user_id FROM users u " +
                    "JOIN user_sessions us ON u.user_id = us.user_id " +
                    "WHERE us.access_token = ? AND us.expires_at > NOW()";

            List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, token);
            printQueryResult(users);
            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new DailyGoalResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) users.get(0).get("user_id");
            System.out.println("当前用户ID: " + userId);

            // 2. 获取每日目标设置
            int targetWords = getTargetWords(userId);

            // 3. 获取连续学习天数
            int streakDays = calculateStreakDays(userId);

            // 4. 获取今日完成情况
            LocalDateTime now = LocalDateTime.now();
            String today = now.toLocalDate().toString();
            int completedToday = getTodayCompleted(userId, today);

            // 5. 计算今日进度
            double todayProgress = targetWords > 0 ? (double) completedToday / targetWords * 100 : 0;

            // 6. 获取平均每日单词数
            double averageDailyWords = getAverageDailyWords(userId);

            // 7. 获取最佳日单词数
            int bestDay = getBestDay(userId);

            // 8. 获取提醒设置
            String reminderTime = getReminderTime(userId);
            boolean isReminderEnabled = isReminderEnabled(userId);

            // 9. 构建响应数据
            DailyGoalData data = new DailyGoalData(
                    targetWords,
                    streakDays,
                    completedToday,
                    Math.round(todayProgress * 100.0) / 100.0,
                    Math.round(averageDailyWords * 100.0) / 100.0,
                    bestDay,
                    reminderTime,
                    isReminderEnabled
            );

            DailyGoalResponse response = new DailyGoalResponse(true, "获取每日目标成功", data);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取每日目标过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new DailyGoalResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private int getTargetWords(int userId) {
        try {
            String sql = "SELECT daily_target_words FROM review_settings WHERE user_id = ?";
            List<Map<String, Object>> settings = jdbcTemplate.queryForList(sql, userId);

            if (!settings.isEmpty()) {
                return ((Number) settings.get(0).get("daily_target_words")).intValue();
            }

            return 20; // 默认每日目标

        } catch (Exception e) {
            System.err.println("获取目标单词数失败: " + e.getMessage());
            return 20;
        }
    }

    private int calculateStreakDays(int userId) {
        try {
            // 获取用户有复习记录的所有日期
            String sql = "SELECT DISTINCT DATE(completed_at) as review_date " +
                    "FROM review_sessions " +
                    "WHERE user_id = ? " +
                    "ORDER BY review_date DESC";

            List<Map<String, Object>> dates = jdbcTemplate.queryForList(sql, userId);

            if (dates.isEmpty()) {
                return 0;
            }

            LocalDateTime now = LocalDateTime.now();
            LocalDate today = now.toLocalDate();
            LocalDate yesterday = today.minusDays(1);
            int streak = 0;

            // 检查今天是否有复习
            boolean todayReviewed = false;
            for (Map<String, Object> dateRow : dates) {
                LocalDate reviewDate = ((java.sql.Date) dateRow.get("review_date")).toLocalDate();
                if (reviewDate.equals(today)) {
                    todayReviewed = true;
                    streak = 1;
                    break;
                }
            }

            // 如果今天没有复习，检查昨天是否有
            if (!todayReviewed) {
                for (Map<String, Object> dateRow : dates) {
                    LocalDate reviewDate = ((java.sql.Date) dateRow.get("review_date")).toLocalDate();
                    if (reviewDate.equals(yesterday)) {
                        streak = 1;
                        break;
                    }
                }
            }

            // 计算连续天数
            if (streak > 0) {
                LocalDate expectedDate = todayReviewed ? today.minusDays(1) : yesterday.minusDays(1);

                for (Map<String, Object> dateRow : dates) {
                    LocalDate reviewDate = ((java.sql.Date) dateRow.get("review_date")).toLocalDate();

                    if (reviewDate.equals(expectedDate)) {
                        streak++;
                        expectedDate = expectedDate.minusDays(1);
                    } else if (reviewDate.isBefore(expectedDate)) {
                        // 跳过中间缺失的日期
                        expectedDate = reviewDate.minusDays(1);
                    }
                }
            }

            return streak;

        } catch (Exception e) {
            System.err.println("计算连续学习天数失败: " + e.getMessage());
            return 0;
        }
    }

    private int getTodayCompleted(int userId, String today) {
        try {
            String sql = "SELECT COALESCE(SUM(total_words), 0) as today_words " +
                    "FROM review_sessions " +
                    "WHERE user_id = ? AND DATE(completed_at) = ?";

            return jdbcTemplate.queryForObject(sql, Integer.class, userId, today);

        } catch (Exception e) {
            System.err.println("获取今日完成情况失败: " + e.getMessage());
            return 0;
        }
    }

    private double getAverageDailyWords(int userId) {
        try {
            // 获取总单词数和学习天数
            String sql = "SELECT " +
                    "COALESCE(SUM(total_words), 0) as total_words, " +
                    "COUNT(DISTINCT DATE(completed_at)) as days_count " +
                    "FROM review_sessions WHERE user_id = ?";

            Map<String, Object> stats = jdbcTemplate.queryForMap(sql, userId);
            int totalWords = ((Number) stats.get("total_words")).intValue();
            int daysCount = ((Number) stats.get("days_count")).intValue();

            return daysCount > 0 ? (double) totalWords / daysCount : 0;

        } catch (Exception e) {
            System.err.println("获取平均每日单词数失败: " + e.getMessage());
            return 0;
        }
    }

    private int getBestDay(int userId) {
        try {
            String sql = "SELECT COALESCE(MAX(total_words), 0) as best_day " +
                    "FROM review_sessions WHERE user_id = ?";

            return jdbcTemplate.queryForObject(sql, Integer.class, userId);

        } catch (Exception e) {
            System.err.println("获取最佳日单词数失败: " + e.getMessage());
            return 0;
        }
    }

    private String getReminderTime(int userId) {
        try {
            String sql = "SELECT reminder_time FROM review_settings WHERE user_id = ?";
            List<Map<String, Object>> settings = jdbcTemplate.queryForList(sql, userId);

            if (!settings.isEmpty() && settings.get(0).get("reminder_time") != null) {
                return (String) settings.get(0).get("reminder_time");
            }

            return "18:00"; // 默认提醒时间

        } catch (Exception e) {
            System.err.println("获取提醒时间失败: " + e.getMessage());
            return "18:00";
        }
    }

    private boolean isReminderEnabled(int userId) {
        try {
            String sql = "SELECT reminder_enabled FROM review_settings WHERE user_id = ?";
            List<Map<String, Object>> settings = jdbcTemplate.queryForList(sql, userId);

            if (!settings.isEmpty() && settings.get(0).get("reminder_enabled") != null) {
                return (boolean) settings.get(0).get("reminder_enabled");
            }

            return true; // 默认启用提醒

        } catch (Exception e) {
            System.err.println("获取提醒启用状态失败: " + e.getMessage());
            return true;
        }
    }
}

--- 结束文件: ReviewGetDailyGoal.java ---

--- 开始文件: ReviewGetDueWords.java ---
package com.vue.readingapp.review;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.*;
import java.util.stream.Collectors;

@RestController
@RequestMapping("/api/v1/review")
public class ReviewGetDueWords {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取待复习单词请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("时间: " + LocalDateTime.now());
        System.out.println("========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class DueWordsResponse {
        private boolean success;
        private String message;
        private DueWordsData data;

        public DueWordsResponse(boolean success, String message, DueWordsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public DueWordsData getData() { return data; }
        public void setData(DueWordsData data) { this.data = data; }
    }

    public static class DueWordsData {
        private List<DueWord> words;
        private int total;
        private int due_count;

        public DueWordsData(List<DueWord> words, int total, int due_count) {
            this.words = words;
            this.total = total;
            this.due_count = due_count;
        }

        public List<DueWord> getWords() { return words; }
        public void setWords(List<DueWord> words) { this.words = words; }

        public int getTotal() { return total; }
        public void setTotal(int total) { this.total = total; }

        public int getDue_count() { return due_count; }
        public void setDue_count(int due_count) { this.due_count = due_count; }
    }

    public static class DueWord {
        private int id;
        private String word;
        private String language;
        private String definition;
        private String example;
        private String phonetic;
        private String part_of_speech;
        private int mastery_level;
        private int review_count;
        private String last_reviewed_at;
        private String next_review_at;
        private String difficulty;
        private List<String> tags;
        private String source;
        private String due_reason;
        private int priority;

        // Getters and Setters
        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public String getWord() { return word; }
        public void setWord(String word) { this.word = word; }

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }

        public String getDefinition() { return definition; }
        public void setDefinition(String definition) { this.definition = definition; }

        public String getExample() { return example; }
        public void setExample(String example) { this.example = example; }

        public String getPhonetic() { return phonetic; }
        public void setPhonetic(String phonetic) { this.phonetic = phonetic; }

        public String getPart_of_speech() { return part_of_speech; }
        public void setPart_of_speech(String part_of_speech) { this.part_of_speech = part_of_speech; }

        public int getMastery_level() { return mastery_level; }
        public void setMastery_level(int mastery_level) { this.mastery_level = mastery_level; }

        public int getReview_count() { return review_count; }
        public void setReview_count(int review_count) { this.review_count = review_count; }

        public String getLast_reviewed_at() { return last_reviewed_at; }
        public void setLast_reviewed_at(String last_reviewed_at) { this.last_reviewed_at = last_reviewed_at; }

        public String getNext_review_at() { return next_review_at; }
        public void setNext_review_at(String next_review_at) { this.next_review_at = next_review_at; }

        public String getDifficulty() { return difficulty; }
        public void setDifficulty(String difficulty) { this.difficulty = difficulty; }

        public List<String> getTags() { return tags; }
        public void setTags(List<String> tags) { this.tags = tags; }

        public String getSource() { return source; }
        public void setSource(String source) { this.source = source; }

        public String getDue_reason() { return due_reason; }
        public void setDue_reason(String due_reason) { this.due_reason = due_reason; }

        public int getPriority() { return priority; }
        public void setPriority(int priority) { this.priority = priority; }
    }

    @GetMapping("/due-words")
    public ResponseEntity<DueWordsResponse> getDueWords(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestParam(value = "limit", defaultValue = "20") int limit,
            @RequestParam(value = "language", required = false) String language,
            @RequestParam(value = "tags", required = false) String tagsParam,
            @RequestParam(value = "difficulty", required = false) String difficulty) {

        // 打印接收到的请求
        Map<String, Object> requestParams = new HashMap<>();
        requestParams.put("limit", limit);
        requestParams.put("language", language);
        requestParams.put("tags", tagsParam);
        requestParams.put("difficulty", difficulty);
        printRequest(requestParams);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new DueWordsResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT u.user_id FROM users u " +
                    "JOIN user_sessions us ON u.user_id = us.user_id " +
                    "WHERE us.access_token = ? AND us.expires_at > NOW()";

            List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, token);
            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new DueWordsResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) users.get(0).get("user_id");
            System.out.println("当前用户ID: " + userId);

            // 2. 构建查询条件
            StringBuilder sqlBuilder = new StringBuilder();
            List<Object> params = new ArrayList<>();

            sqlBuilder.append("SELECT uv.user_vocab_id, w.word, w.language, ");
            sqlBuilder.append("wd.definition, we.example, w.phonetic, w.part_of_speech, ");
            sqlBuilder.append("uv.mastery_level, uv.review_count, uv.last_reviewed_at, ");
            sqlBuilder.append("uv.next_review_date, w.difficulty, uv.source, ");
            sqlBuilder.append("CASE ");
            sqlBuilder.append("  WHEN uv.next_review_date <= NOW() THEN 'overdue' ");
            sqlBuilder.append("  WHEN uv.next_review_date <= DATE_ADD(NOW(), INTERVAL 1 DAY) THEN 'due_today' ");
            sqlBuilder.append("  ELSE 'scheduled' ");
            sqlBuilder.append("END as due_reason, ");
            sqlBuilder.append("CASE ");
            sqlBuilder.append("  WHEN uv.next_review_date <= NOW() THEN 1 ");
            sqlBuilder.append("  WHEN uv.next_review_date <= DATE_ADD(NOW(), INTERVAL 1 DAY) THEN 2 ");
            sqlBuilder.append("  ELSE 3 ");
            sqlBuilder.append("END as priority ");
            sqlBuilder.append("FROM user_vocabulary uv ");
            sqlBuilder.append("JOIN words w ON uv.word_id = w.word_id ");
            sqlBuilder.append("LEFT JOIN word_definitions wd ON w.word_id = wd.word_id ");
            sqlBuilder.append("LEFT JOIN word_examples we ON w.word_id = we.word_id ");
            sqlBuilder.append("WHERE uv.user_id = ? ");
            sqlBuilder.append("AND uv.is_mastered = 0 ");
            sqlBuilder.append("AND uv.next_review_date <= DATE_ADD(NOW(), INTERVAL 7 DAY) ");

            params.add(userId);

            // 添加语言筛选
            if (language != null && !language.trim().isEmpty()) {
                sqlBuilder.append("AND w.language = ? ");
                params.add(language);
            }

            // 添加难度筛选
            if (difficulty != null && !difficulty.trim().isEmpty()) {
                sqlBuilder.append("AND w.difficulty = ? ");
                params.add(difficulty);
            }

            // 按优先级和复习时间排序
            sqlBuilder.append("ORDER BY priority ASC, uv.next_review_date ASC ");

            // 添加数量限制
            sqlBuilder.append("LIMIT ?");
            params.add(Math.min(limit, 100)); // 限制最大100个

            // 3. 执行查询
            System.out.println("执行SQL: " + sqlBuilder.toString());
            System.out.println("参数: " + params);

            List<Map<String, Object>> dueWordsList = jdbcTemplate.queryForList(
                    sqlBuilder.toString(), params.toArray());

            printQueryResult("查询到 " + dueWordsList.size() + " 个待复习单词");

            // 4. 处理查询结果
            List<DueWord> dueWords = new ArrayList<>();

            for (Map<String, Object> row : dueWordsList) {
                DueWord dueWord = new DueWord();
                dueWord.setId((int) row.get("user_vocab_id"));
                dueWord.setWord((String) row.get("word"));
                dueWord.setLanguage((String) row.get("language"));
                dueWord.setDefinition((String) row.get("definition"));
                dueWord.setExample((String) row.get("example"));
                dueWord.setPhonetic((String) row.get("phonetic"));
                dueWord.setPart_of_speech((String) row.get("part_of_speech"));
                dueWord.setMastery_level((int) row.get("mastery_level"));
                dueWord.setReview_count((int) row.get("review_count"));

                // 处理日期字段
                if (row.get("last_reviewed_at") != null) {
                    dueWord.setLast_reviewed_at(row.get("last_reviewed_at").toString());
                }

                if (row.get("next_review_date") != null) {
                    dueWord.setNext_review_at(row.get("next_review_date").toString());
                }

                dueWord.setDifficulty((String) row.get("difficulty"));
                dueWord.setSource((String) row.get("source"));
                dueWord.setDue_reason((String) row.get("due_reason"));
                dueWord.setPriority((int) row.get("priority"));

                // 获取标签
                List<String> tags = getTagsForUserVocabulary((int) row.get("user_vocab_id"));
                dueWord.setTags(tags);

                dueWords.add(dueWord);
            }

            // 5. 获取统计数据
            String countSql = "SELECT COUNT(*) as total FROM user_vocabulary WHERE user_id = ? AND is_mastered = 0";
            int total = jdbcTemplate.queryForObject(countSql, Integer.class, userId);

            String dueCountSql = "SELECT COUNT(*) as due_count FROM user_vocabulary " +
                    "WHERE user_id = ? AND is_mastered = 0 AND next_review_date <= NOW()";
            int dueCount = jdbcTemplate.queryForObject(dueCountSql, Integer.class, userId);

            // 6. 构建响应数据
            DueWordsData data = new DueWordsData(dueWords, total, dueCount);
            DueWordsResponse response = new DueWordsResponse(true, "获取待复习单词成功", data);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取待复习单词过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new DueWordsResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    // 获取用户生词的标签
    private List<String> getTagsForUserVocabulary(int userVocabId) {
        try {
            String sql = "SELECT vt.tag_name " +
                    "FROM user_vocabulary_tags uvt " +
                    "JOIN vocabulary_tags vt ON uvt.tag_id = vt.tag_id " +
                    "WHERE uvt.user_vocab_id = ?";

            List<Map<String, Object>> tagsList = jdbcTemplate.queryForList(sql, userVocabId);

            return tagsList.stream()
                    .map(row -> (String) row.get("tag_name"))
                    .collect(Collectors.toList());
        } catch (Exception e) {
            System.err.println("获取标签失败: " + e.getMessage());
            return new ArrayList<>();
        }
    }
}

--- 结束文件: ReviewGetDueWords.java ---

--- 开始文件: ReviewGetHistory.java ---
package com.vue.readingapp.review;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.*;
import java.time.LocalDate;

@RestController
@RequestMapping("/api/v1/review")
public class ReviewGetHistory {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到获取复习历史请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("时间: " + LocalDateTime.now());
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class ReviewHistoryResponse {
        private boolean success;
        private String message;
        private ReviewHistoryData data;

        public ReviewHistoryResponse(boolean success, String message, ReviewHistoryData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public ReviewHistoryData getData() { return data; }
        public void setData(ReviewHistoryData data) { this.data = data; }
    }

    public static class ReviewHistoryData {
        private List<ReviewSession> sessions;
        private Pagination pagination;

        public ReviewHistoryData(List<ReviewSession> sessions, Pagination pagination) {
            this.sessions = sessions;
            this.pagination = pagination;
        }

        public List<ReviewSession> getSessions() { return sessions; }
        public void setSessions(List<ReviewSession> sessions) { this.sessions = sessions; }

        public Pagination getPagination() { return pagination; }
        public void setPagination(Pagination pagination) { this.pagination = pagination; }
    }

    public static class ReviewSession {
        private String id;
        private String mode;
        private int total_words;
        private int correct_words;
        private double accuracy;
        private int duration;
        private String language;
        private String completed_at;
        private Map<String, Object> details;

        public ReviewSession(String id, String mode, int total_words, int correct_words,
                             double accuracy, int duration, String language, String completed_at,
                             Map<String, Object> details) {
            this.id = id;
            this.mode = mode;
            this.total_words = total_words;
            this.correct_words = correct_words;
            this.accuracy = accuracy;
            this.duration = duration;
            this.language = language;
            this.completed_at = completed_at;
            this.details = details;
        }

        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getMode() { return mode; }
        public void setMode(String mode) { this.mode = mode; }

        public int getTotal_words() { return total_words; }
        public void setTotal_words(int total_words) { this.total_words = total_words; }

        public int getCorrect_words() { return correct_words; }
        public void setCorrect_words(int correct_words) { this.correct_words = correct_words; }

        public double getAccuracy() { return accuracy; }
        public void setAccuracy(double accuracy) { this.accuracy = accuracy; }

        public int getDuration() { return duration; }
        public void setDuration(int duration) { this.duration = duration; }

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }

        public String getCompleted_at() { return completed_at; }
        public void setCompleted_at(String completed_at) { this.completed_at = completed_at; }

        public Map<String, Object> getDetails() { return details; }
        public void setDetails(Map<String, Object> details) { this.details = details; }
    }

    public static class Pagination {
        private int page;
        private int page_size;
        private int total;
        private int total_pages;

        public Pagination(int page, int page_size, int total, int total_pages) {
            this.page = page;
            this.page_size = page_size;
            this.total = total;
            this.total_pages = total_pages;
        }

        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public int getPage_size() { return page_size; }
        public void setPage_size(int page_size) { this.page_size = page_size; }

        public int getTotal() { return total; }
        public void setTotal(int total) { this.total = total; }

        public int getTotal_pages() { return total_pages; }
        public void setTotal_pages(int total_pages) { this.total_pages = total_pages; }
    }

    @GetMapping("/history")
    public ResponseEntity<ReviewHistoryResponse> getReviewHistory(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestParam(value = "page", defaultValue = "1") int page,
            @RequestParam(value = "pageSize", defaultValue = "20") int pageSize,
            @RequestParam(value = "startDate", required = false) String startDate,
            @RequestParam(value = "endDate", required = false) String endDate,
            @RequestParam(value = "language", required = false) String language) {

        Map<String, Object> requestParams = new HashMap<>();
        requestParams.put("page", page);
        requestParams.put("pageSize", pageSize);
        requestParams.put("startDate", startDate);
        requestParams.put("endDate", endDate);
        requestParams.put("language", language);
        printRequest(requestParams);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ReviewHistoryResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT u.user_id FROM users u " +
                    "JOIN user_sessions us ON u.user_id = us.user_id " +
                    "WHERE us.access_token = ? AND us.expires_at > NOW()";

            List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, token);
            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ReviewHistoryResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) users.get(0).get("user_id");
            System.out.println("当前用户ID: " + userId);

            // 2. 参数验证和默认值
            if (page < 1) page = 1;
            if (pageSize < 1 || pageSize > 100) pageSize = 20;

            // 3. 构建查询条件
            StringBuilder sqlBuilder = new StringBuilder();
            List<Object> params = new ArrayList<>();

            sqlBuilder.append("SELECT rs.session_id, rs.mode, rs.total_words, rs.correct_words, ");
            sqlBuilder.append("rs.accuracy, rs.duration, rs.completed_at, ");
            sqlBuilder.append("COALESCE(GROUP_CONCAT(DISTINCT w.language), 'mixed') as languages ");
            sqlBuilder.append("FROM review_sessions rs ");
            sqlBuilder.append("LEFT JOIN user_vocabulary uv ON rs.user_id = uv.user_id ");
            sqlBuilder.append("LEFT JOIN words w ON uv.word_id = w.word_id ");
            sqlBuilder.append("WHERE rs.user_id = ? ");

            params.add(userId);

            // 日期筛选
            if (startDate != null && !startDate.trim().isEmpty()) {
                sqlBuilder.append("AND DATE(rs.completed_at) >= ? ");
                params.add(startDate);
            }

            if (endDate != null && !endDate.trim().isEmpty()) {
                sqlBuilder.append("AND DATE(rs.completed_at) <= ? ");
                params.add(endDate);
            }

            sqlBuilder.append("GROUP BY rs.session_id, rs.mode, rs.total_words, rs.correct_words, ");
            sqlBuilder.append("rs.accuracy, rs.duration, rs.completed_at ");

            // 语言筛选
            if (language != null && !language.trim().isEmpty()) {
                sqlBuilder.append("HAVING languages LIKE ? ");
                params.add("%" + language + "%");
            }

            sqlBuilder.append("ORDER BY rs.completed_at DESC ");

            // 4. 获取总数
            String countSql = "SELECT COUNT(*) FROM (" + sqlBuilder.toString() + ") as temp";
            int total = jdbcTemplate.queryForObject(countSql, Integer.class, params.toArray());

            // 5. 添加分页
            sqlBuilder.append("LIMIT ? OFFSET ?");
            int offset = (page - 1) * pageSize;
            params.add(pageSize);
            params.add(offset);

            // 6. 执行查询
            System.out.println("执行SQL: " + sqlBuilder.toString());
            System.out.println("参数: " + params);

            List<Map<String, Object>> historyList = jdbcTemplate.queryForList(
                    sqlBuilder.toString(), params.toArray());

            printQueryResult("查询到 " + historyList.size() + " 条复习历史记录");

            // 7. 处理查询结果
            List<ReviewSession> sessions = new ArrayList<>();

            for (Map<String, Object> row : historyList) {
                String sessionId = (String) row.get("session_id");
                String languages = (String) row.get("languages");

                // 确定主要语言
                String primaryLanguage = "mixed";
                if (languages != null && !languages.isEmpty()) {
                    String[] langArray = languages.split(",");
                    if (langArray.length == 1) {
                        primaryLanguage = langArray[0];
                    }
                }

                // 构建详情信息
                Map<String, Object> details = new HashMap<>();
                details.put("languages", languages);

                ReviewSession session = new ReviewSession(
                        sessionId,
                        (String) row.get("mode"),
                        ((Number) row.get("total_words")).intValue(),
                        ((Number) row.get("correct_words")).intValue(),
                        Math.round(((Number) row.get("accuracy")).doubleValue() * 100.0) / 100.0,
                        ((Number) row.get("duration")).intValue(),
                        primaryLanguage,
                        row.get("completed_at").toString(),
                        details
                );

                sessions.add(session);
            }

            // 8. 计算分页信息
            int totalPages = (int) Math.ceil((double) total / pageSize);
            Pagination pagination = new Pagination(page, pageSize, total, totalPages);

            // 9. 构建响应数据
            ReviewHistoryData data = new ReviewHistoryData(sessions, pagination);
            ReviewHistoryResponse response = new ReviewHistoryResponse(true, "获取复习历史成功", data);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取复习历史过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ReviewHistoryResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: ReviewGetHistory.java ---

--- 开始文件: ReviewGetPlan.java ---
package com.vue.readingapp.review;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.*;
import java.time.LocalDate;
@RestController
@RequestMapping("/api/v1/review")
public class ReviewGetPlan {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到获取复习计划请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("时间: " + LocalDateTime.now());
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class ReviewPlanResponse {
        private boolean success;
        private String message;
        private ReviewPlanData data;

        public ReviewPlanResponse(boolean success, String message, ReviewPlanData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public ReviewPlanData getData() { return data; }
        public void setData(ReviewPlanData data) { this.data = data; }
    }

    public static class ReviewPlanData {
        private String plan_id;
        private String user_id;
        private String plan_name;
        private String description;
        private int daily_target_words;
        private int weekly_target_days;
        private String preferred_time;
        private List<String> preferred_days;
        private String language_focus;
        private String difficulty_level;
        private boolean is_active;
        private String created_at;
        private String updated_at;
        private PlanProgress progress;

        public ReviewPlanData(String plan_id, String user_id, String plan_name, String description,
                              int daily_target_words, int weekly_target_days, String preferred_time,
                              List<String> preferred_days, String language_focus, String difficulty_level,
                              boolean is_active, String created_at, String updated_at, PlanProgress progress) {
            this.plan_id = plan_id;
            this.user_id = user_id;
            this.plan_name = plan_name;
            this.description = description;
            this.daily_target_words = daily_target_words;
            this.weekly_target_days = weekly_target_days;
            this.preferred_time = preferred_time;
            this.preferred_days = preferred_days;
            this.language_focus = language_focus;
            this.difficulty_level = difficulty_level;
            this.is_active = is_active;
            this.created_at = created_at;
            this.updated_at = updated_at;
            this.progress = progress;
        }

        public String getPlan_id() { return plan_id; }
        public void setPlan_id(String plan_id) { this.plan_id = plan_id; }

        public String getUser_id() { return user_id; }
        public void setUser_id(String user_id) { this.user_id = user_id; }

        public String getPlan_name() { return plan_name; }
        public void setPlan_name(String plan_name) { this.plan_name = plan_name; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }

        public int getDaily_target_words() { return daily_target_words; }
        public void setDaily_target_words(int daily_target_words) { this.daily_target_words = daily_target_words; }

        public int getWeekly_target_days() { return weekly_target_days; }
        public void setWeekly_target_days(int weekly_target_days) { this.weekly_target_days = weekly_target_days; }

        public String getPreferred_time() { return preferred_time; }
        public void setPreferred_time(String preferred_time) { this.preferred_time = preferred_time; }

        public List<String> getPreferred_days() { return preferred_days; }
        public void setPreferred_days(List<String> preferred_days) { this.preferred_days = preferred_days; }

        public String getLanguage_focus() { return language_focus; }
        public void setLanguage_focus(String language_focus) { this.language_focus = language_focus; }

        public String getDifficulty_level() { return difficulty_level; }
        public void setDifficulty_level(String difficulty_level) { this.difficulty_level = difficulty_level; }

        public boolean isIs_active() { return is_active; }
        public void setIs_active(boolean is_active) { this.is_active = is_active; }

        public String getCreated_at() { return created_at; }
        public void setCreated_at(String created_at) { this.created_at = created_at; }

        public String getUpdated_at() { return updated_at; }
        public void setUpdated_at(String updated_at) { this.updated_at = updated_at; }

        public PlanProgress getProgress() { return progress; }
        public void setProgress(PlanProgress progress) { this.progress = progress; }
    }

    public static class PlanProgress {
        private int today_completed;
        private int today_target;
        private double today_percentage;
        private int week_completed;
        private int week_target;
        private double week_percentage;
        private int streak_days;
        private int total_words_reviewed;
        private double average_accuracy;

        public PlanProgress(int today_completed, int today_target, double today_percentage,
                            int week_completed, int week_target, double week_percentage,
                            int streak_days, int total_words_reviewed, double average_accuracy) {
            this.today_completed = today_completed;
            this.today_target = today_target;
            this.today_percentage = today_percentage;
            this.week_completed = week_completed;
            this.week_target = week_target;
            this.week_percentage = week_percentage;
            this.streak_days = streak_days;
            this.total_words_reviewed = total_words_reviewed;
            this.average_accuracy = average_accuracy;
        }

        public int getToday_completed() { return today_completed; }
        public void setToday_completed(int today_completed) { this.today_completed = today_completed; }

        public int getToday_target() { return today_target; }
        public void setToday_target(int today_target) { this.today_target = today_target; }

        public double getToday_percentage() { return today_percentage; }
        public void setToday_percentage(double today_percentage) { this.today_percentage = today_percentage; }

        public int getWeek_completed() { return week_completed; }
        public void setWeek_completed(int week_completed) { this.week_completed = week_completed; }

        public int getWeek_target() { return week_target; }
        public void setWeek_target(int week_target) { this.week_target = week_target; }

        public double getWeek_percentage() { return week_percentage; }
        public void setWeek_percentage(double week_percentage) { this.week_percentage = week_percentage; }

        public int getStreak_days() { return streak_days; }
        public void setStreak_days(int streak_days) { this.streak_days = streak_days; }

        public int getTotal_words_reviewed() { return total_words_reviewed; }
        public void setTotal_words_reviewed(int total_words_reviewed) { this.total_words_reviewed = total_words_reviewed; }

        public double getAverage_accuracy() { return average_accuracy; }
        public void setAverage_accuracy(double average_accuracy) { this.average_accuracy = average_accuracy; }
    }

    @GetMapping("/plan")
    public ResponseEntity<ReviewPlanResponse> getReviewPlan(
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        printRequest("获取复习计划");

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ReviewPlanResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT u.user_id FROM users u " +
                    "JOIN user_sessions us ON u.user_id = us.user_id " +
                    "WHERE us.access_token = ? AND us.expires_at > NOW()";

            List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, token);
            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ReviewPlanResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) users.get(0).get("user_id");
            System.out.println("当前用户ID: " + userId);

            // 2. 获取用户的复习设置（从review_settings表）
            String settingsSql = "SELECT * FROM review_settings WHERE user_id = ?";
            List<Map<String, Object>> settingsList = jdbcTemplate.queryForList(settingsSql, userId);

            // 3. 获取今日进度
            LocalDateTime now = LocalDateTime.now();
            String today = now.toLocalDate().toString();

            // 获取今日已复习单词数
            String todayReviewsSql = "SELECT COALESCE(SUM(total_words), 0) as today_words " +
                    "FROM review_sessions " +
                    "WHERE user_id = ? AND DATE(completed_at) = ?";

            int todayCompleted = jdbcTemplate.queryForObject(todayReviewsSql, Integer.class, userId, today);

            // 4. 获取本周进度
            LocalDateTime weekStart = now.minusDays(now.getDayOfWeek().getValue() - 1);
            String weekStartStr = weekStart.toLocalDate().toString();

            String weekReviewsSql = "SELECT COALESCE(SUM(total_words), 0) as week_words " +
                    "FROM review_sessions " +
                    "WHERE user_id = ? AND DATE(completed_at) BETWEEN ? AND ?";

            int weekCompleted = jdbcTemplate.queryForObject(weekReviewsSql, Integer.class,
                    userId, weekStartStr, today);

            // 5. 获取连续学习天数
            int streakDays = calculateStreakDays(userId);

            // 6. 获取总复习单词数和平均准确率
            String totalStatsSql = "SELECT COALESCE(SUM(total_words), 0) as total_words, " +
                    "COALESCE(AVG(accuracy), 0) as avg_accuracy " +
                    "FROM review_sessions WHERE user_id = ?";

            Map<String, Object> totalStats = jdbcTemplate.queryForMap(totalStatsSql, userId);
            int totalWordsReviewed = ((Number) totalStats.get("total_words")).intValue();
            double averageAccuracy = ((Number) totalStats.get("avg_accuracy")).doubleValue();

            // 7. 构建复习计划数据
            // 如果没有设置，使用默认值
            int dailyTargetWords = 20;
            int weeklyTargetDays = 5;
            String preferredTime = "18:00";
            List<String> preferredDays = Arrays.asList("Monday", "Tuesday", "Wednesday", "Thursday", "Friday");
            String languageFocus = "en";
            String difficultyLevel = "medium";

            if (!settingsList.isEmpty()) {
                Map<String, Object> settings = settingsList.get(0);
                dailyTargetWords = settings.get("daily_target_words") != null ?
                        ((Number) settings.get("daily_target_words")).intValue() : dailyTargetWords;
                weeklyTargetDays = settings.get("weekly_target_days") != null ?
                        ((Number) settings.get("weekly_target_days")).intValue() : weeklyTargetDays;
                preferredTime = settings.get("preferred_time") != null ?
                        (String) settings.get("preferred_time") : preferredTime;

                // 解析偏好日期（假设以逗号分隔）
                if (settings.get("preferred_days") != null) {
                    String daysStr = (String) settings.get("preferred_days");
                    preferredDays = Arrays.asList(daysStr.split(","));
                }

                languageFocus = settings.get("language_focus") != null ?
                        (String) settings.get("language_focus") : languageFocus;
                difficultyLevel = settings.get("difficulty_level") != null ?
                        (String) settings.get("difficulty_level") : difficultyLevel;
            }

            // 计算百分比
            double todayPercentage = dailyTargetWords > 0 ?
                    (double) todayCompleted / dailyTargetWords * 100 : 0;
            double weekPercentage = weeklyTargetDays > 0 ?
                    (double) weekCompleted / (dailyTargetWords * weeklyTargetDays) * 100 : 0;

            // 8. 构建响应数据
            PlanProgress progress = new PlanProgress(
                    todayCompleted,
                    dailyTargetWords,
                    Math.round(todayPercentage * 100.0) / 100.0,
                    weekCompleted,
                    dailyTargetWords * weeklyTargetDays,
                    Math.round(weekPercentage * 100.0) / 100.0,
                    streakDays,
                    totalWordsReviewed,
                    Math.round(averageAccuracy * 100.0) / 100.0
            );

            ReviewPlanData planData = new ReviewPlanData(
                    "plan_" + userId,
                    String.valueOf(userId),
                    "默认复习计划",
                    "每日复习" + dailyTargetWords + "个单词，每周学习" + weeklyTargetDays + "天",
                    dailyTargetWords,
                    weeklyTargetDays,
                    preferredTime,
                    preferredDays,
                    languageFocus,
                    difficultyLevel,
                    true,
                    now.minusDays(30).toString(),
                    now.toString(),
                    progress
            );

            ReviewPlanResponse response = new ReviewPlanResponse(true, "获取复习计划成功", planData);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取复习计划过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ReviewPlanResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private int calculateStreakDays(int userId) {
        try {
            // 获取用户有复习记录的所有日期
            String sql = "SELECT DISTINCT DATE(completed_at) as review_date " +
                    "FROM review_sessions " +
                    "WHERE user_id = ? " +
                    "ORDER BY review_date DESC";

            List<Map<String, Object>> dates = jdbcTemplate.queryForList(sql, userId);

            if (dates.isEmpty()) {
                return 0;
            }

            LocalDateTime now = LocalDateTime.now();
            LocalDate today = now.toLocalDate();
            LocalDate yesterday = today.minusDays(1);
            int streak = 0;

            // 检查今天是否有复习
            boolean todayReviewed = false;
            for (Map<String, Object> dateRow : dates) {
                LocalDate reviewDate = ((java.sql.Date) dateRow.get("review_date")).toLocalDate();
                if (reviewDate.equals(today)) {
                    todayReviewed = true;
                    streak = 1;
                    break;
                }
            }

            // 如果今天没有复习，检查昨天是否有
            if (!todayReviewed) {
                for (Map<String, Object> dateRow : dates) {
                    LocalDate reviewDate = ((java.sql.Date) dateRow.get("review_date")).toLocalDate();
                    if (reviewDate.equals(yesterday)) {
                        streak = 1;
                        break;
                    }
                }
            }

            // 计算连续天数
            if (streak > 0) {
                LocalDate expectedDate = todayReviewed ? today.minusDays(1) : yesterday.minusDays(1);

                for (Map<String, Object> dateRow : dates) {
                    LocalDate reviewDate = ((java.sql.Date) dateRow.get("review_date")).toLocalDate();

                    if (reviewDate.equals(expectedDate)) {
                        streak++;
                        expectedDate = expectedDate.minusDays(1);
                    } else if (reviewDate.isBefore(expectedDate)) {
                        // 跳过中间缺失的日期
                        expectedDate = reviewDate.minusDays(1);
                    }
                }
            }

            return streak;

        } catch (Exception e) {
            System.err.println("计算连续学习天数失败: " + e.getMessage());
            return 0;
        }
    }
}

--- 结束文件: ReviewGetPlan.java ---

--- 开始文件: ReviewGetProgress.java ---
package com.vue.readingapp.review;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.*;
import java.time.LocalDate;
@RestController
@RequestMapping("/api/v1/review")
public class ReviewGetProgress {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到获取复习进度请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("时间: " + LocalDateTime.now());
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class ReviewProgressResponse {
        private boolean success;
        private String message;
        private ProgressData data;

        public ReviewProgressResponse(boolean success, String message, ProgressData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public ProgressData getData() { return data; }
        public void setData(ProgressData data) { this.data = data; }
    }

    public static class ProgressData {
        private int daily_goal;
        private int daily_completed;
        private double daily_progress;
        private int weekly_goal;
        private int weekly_completed;
        private double weekly_progress;
        private int monthly_goal;
        private int monthly_completed;
        private double monthly_progress;
        private String next_milestone;
        private double milestone_progress;

        public ProgressData(int daily_goal, int daily_completed, double daily_progress,
                            int weekly_goal, int weekly_completed, double weekly_progress,
                            int monthly_goal, int monthly_completed, double monthly_progress,
                            String next_milestone, double milestone_progress) {
            this.daily_goal = daily_goal;
            this.daily_completed = daily_completed;
            this.daily_progress = daily_progress;
            this.weekly_goal = weekly_goal;
            this.weekly_completed = weekly_completed;
            this.weekly_progress = weekly_progress;
            this.monthly_goal = monthly_goal;
            this.monthly_completed = monthly_completed;
            this.monthly_progress = monthly_progress;
            this.next_milestone = next_milestone;
            this.milestone_progress = milestone_progress;
        }

        public int getDaily_goal() { return daily_goal; }
        public void setDaily_goal(int daily_goal) { this.daily_goal = daily_goal; }

        public int getDaily_completed() { return daily_completed; }
        public void setDaily_completed(int daily_completed) { this.daily_completed = daily_completed; }

        public double getDaily_progress() { return daily_progress; }
        public void setDaily_progress(double daily_progress) { this.daily_progress = daily_progress; }

        public int getWeekly_goal() { return weekly_goal; }
        public void setWeekly_goal(int weekly_goal) { this.weekly_goal = weekly_goal; }

        public int getWeekly_completed() { return weekly_completed; }
        public void setWeekly_completed(int weekly_completed) { this.weekly_completed = weekly_completed; }

        public double getWeekly_progress() { return weekly_progress; }
        public void setWeekly_progress(double weekly_progress) { this.weekly_progress = weekly_progress; }

        public int getMonthly_goal() { return monthly_goal; }
        public void setMonthly_goal(int monthly_goal) { this.monthly_goal = monthly_goal; }

        public int getMonthly_completed() { return monthly_completed; }
        public void setMonthly_completed(int monthly_completed) { this.monthly_completed = monthly_completed; }

        public double getMonthly_progress() { return monthly_progress; }
        public void setMonthly_progress(double monthly_progress) { this.monthly_progress = monthly_progress; }

        public String getNext_milestone() { return next_milestone; }
        public void setNext_milestone(String next_milestone) { this.next_milestone = next_milestone; }

        public double getMilestone_progress() { return milestone_progress; }
        public void setMilestone_progress(double milestone_progress) { this.milestone_progress = milestone_progress; }
    }

    @GetMapping("/progress")
    public ResponseEntity<ReviewProgressResponse> getReviewProgress(
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        printRequest("获取复习进度");

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ReviewProgressResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT u.user_id FROM users u " +
                    "JOIN user_sessions us ON u.user_id = us.user_id " +
                    "WHERE us.access_token = ? AND us.expires_at > NOW()";

            List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, token);
            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ReviewProgressResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) users.get(0).get("user_id");
            System.out.println("当前用户ID: " + userId);

            // 2. 获取每日目标
            int dailyGoal = getDailyGoal(userId);

            // 3. 获取今日完成情况
            LocalDateTime now = LocalDateTime.now();
            String today = now.toLocalDate().toString();
            int dailyCompleted = getTodayCompleted(userId, today);

            // 4. 计算每日进度
            double dailyProgress = dailyGoal > 0 ? (double) dailyCompleted / dailyGoal * 100 : 0;

            // 5. 获取本周完成情况
            LocalDateTime weekStart = now.minusDays(now.getDayOfWeek().getValue() - 1);
            String weekStartStr = weekStart.toLocalDate().toString();
            int weeklyCompleted = getWeekCompleted(userId, weekStartStr, today);

            // 6. 计算每周进度
            int weeklyGoal = dailyGoal * 5; // 假设每周目标为5天的每日目标
            double weeklyProgress = weeklyGoal > 0 ? (double) weeklyCompleted / weeklyGoal * 100 : 0;

            // 7. 获取本月完成情况
            LocalDateTime monthStart = LocalDate.of(now.getYear(), now.getMonth(), 1).atStartOfDay();
            String monthStartStr = monthStart.toLocalDate().toString();
            int monthlyCompleted = getMonthCompleted(userId, monthStartStr, today);

            // 8. 计算每月进度
            int monthlyGoal = dailyGoal * 20; // 假设每月目标为20天的每日目标
            double monthlyProgress = monthlyGoal > 0 ? (double) monthlyCompleted / monthlyGoal * 100 : 0;

            // 9. 获取下一个里程碑
            String nextMilestone = getNextMilestone(userId);
            double milestoneProgress = calculateMilestoneProgress(userId, nextMilestone);

            // 10. 构建响应数据
            ProgressData data = new ProgressData(
                    dailyGoal,
                    dailyCompleted,
                    Math.round(dailyProgress * 100.0) / 100.0,
                    weeklyGoal,
                    weeklyCompleted,
                    Math.round(weeklyProgress * 100.0) / 100.0,
                    monthlyGoal,
                    monthlyCompleted,
                    Math.round(monthlyProgress * 100.0) / 100.0,
                    nextMilestone,
                    Math.round(milestoneProgress * 100.0) / 100.0
            );

            ReviewProgressResponse response = new ReviewProgressResponse(true, "获取复习进度成功", data);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取复习进度过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ReviewProgressResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private int getDailyGoal(int userId) {
        try {
            String sql = "SELECT daily_target_words FROM review_settings WHERE user_id = ?";
            List<Map<String, Object>> settings = jdbcTemplate.queryForList(sql, userId);

            if (!settings.isEmpty()) {
                return ((Number) settings.get(0).get("daily_target_words")).intValue();
            }

            return 20; // 默认每日目标

        } catch (Exception e) {
            System.err.println("获取每日目标失败: " + e.getMessage());
            return 20;
        }
    }

    private int getTodayCompleted(int userId, String today) {
        try {
            String sql = "SELECT COALESCE(SUM(total_words), 0) as today_words " +
                    "FROM review_sessions " +
                    "WHERE user_id = ? AND DATE(completed_at) = ?";

            return jdbcTemplate.queryForObject(sql, Integer.class, userId, today);

        } catch (Exception e) {
            System.err.println("获取今日完成情况失败: " + e.getMessage());
            return 0;
        }
    }

    private int getWeekCompleted(int userId, String weekStart, String today) {
        try {
            String sql = "SELECT COALESCE(SUM(total_words), 0) as week_words " +
                    "FROM review_sessions " +
                    "WHERE user_id = ? AND DATE(completed_at) BETWEEN ? AND ?";

            return jdbcTemplate.queryForObject(sql, Integer.class, userId, weekStart, today);

        } catch (Exception e) {
            System.err.println("获取本周完成情况失败: " + e.getMessage());
            return 0;
        }
    }

    private int getMonthCompleted(int userId, String monthStart, String today) {
        try {
            String sql = "SELECT COALESCE(SUM(total_words), 0) as month_words " +
                    "FROM review_sessions " +
                    "WHERE user_id = ? AND DATE(completed_at) BETWEEN ? AND ?";

            return jdbcTemplate.queryForObject(sql, Integer.class, userId, monthStart, today);

        } catch (Exception e) {
            System.err.println("获取本月完成情况失败: " + e.getMessage());
            return 0;
        }
    }

    private String getNextMilestone(int userId) {
        try {
            // 获取总复习单词数
            String sql = "SELECT COALESCE(SUM(total_words), 0) as total_words " +
                    "FROM review_sessions WHERE user_id = ?";

            int totalWords = jdbcTemplate.queryForObject(sql, Integer.class, userId);

            // 定义里程碑
            if (totalWords < 100) {
                return "100个单词";
            } else if (totalWords < 500) {
                return "500个单词";
            } else if (totalWords < 1000) {
                return "1000个单词";
            } else if (totalWords < 5000) {
                return "5000个单词";
            } else {
                return "10000个单词";
            }

        } catch (Exception e) {
            System.err.println("获取下一个里程碑失败: " + e.getMessage());
            return "100个单词";
        }
    }

    private double calculateMilestoneProgress(int userId, String nextMilestone) {
        try {
            // 获取总复习单词数
            String sql = "SELECT COALESCE(SUM(total_words), 0) as total_words " +
                    "FROM review_sessions WHERE user_id = ?";

            int totalWords = jdbcTemplate.queryForObject(sql, Integer.class, userId);

            // 解析里程碑目标
            int milestoneTarget = 0;
            if (nextMilestone.contains("100")) {
                milestoneTarget = 100;
            } else if (nextMilestone.contains("500")) {
                milestoneTarget = 500;
            } else if (nextMilestone.contains("1000")) {
                milestoneTarget = 1000;
            } else if (nextMilestone.contains("5000")) {
                milestoneTarget = 5000;
            } else if (nextMilestone.contains("10000")) {
                milestoneTarget = 10000;
            }

            // 计算进度
            return milestoneTarget > 0 ? (double) totalWords / milestoneTarget * 100 : 0;

        } catch (Exception e) {
            System.err.println("计算里程碑进度失败: " + e.getMessage());
            return 0;
        }
    }
}

--- 结束文件: ReviewGetProgress.java ---

--- 开始文件: ReviewGetReminders.java ---
package com.vue.readingapp.review;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.*;

@RestController
@RequestMapping("/api/v1/review")
public class ReviewGetReminders {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到获取复习提醒设置请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("时间: " + LocalDateTime.now());
        System.out.println("==========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class RemindersResponse {
        private boolean success;
        private String message;
        private RemindersData data;

        public RemindersResponse(boolean success, String message, RemindersData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public RemindersData getData() { return data; }
        public void setData(RemindersData data) { this.data = data; }
    }

    public static class RemindersData {
        private boolean enabled;
        private String reminder_time;
        private List<String> reminder_days;
        private boolean sound_enabled;
        private boolean vibration_enabled;
        private String reminder_message;
        private String last_reminder_sent;
        private int snooze_minutes;

        public RemindersData(boolean enabled, String reminder_time, List<String> reminder_days,
                             boolean sound_enabled, boolean vibration_enabled, String reminder_message,
                             String last_reminder_sent, int snooze_minutes) {
            this.enabled = enabled;
            this.reminder_time = reminder_time;
            this.reminder_days = reminder_days;
            this.sound_enabled = sound_enabled;
            this.vibration_enabled = vibration_enabled;
            this.reminder_message = reminder_message;
            this.last_reminder_sent = last_reminder_sent;
            this.snooze_minutes = snooze_minutes;
        }

        public boolean isEnabled() { return enabled; }
        public void setEnabled(boolean enabled) { this.enabled = enabled; }

        public String getReminder_time() { return reminder_time; }
        public void setReminder_time(String reminder_time) { this.reminder_time = reminder_time; }

        public List<String> getReminder_days() { return reminder_days; }
        public void setReminder_days(List<String> reminder_days) { this.reminder_days = reminder_days; }

        public boolean isSound_enabled() { return sound_enabled; }
        public void setSound_enabled(boolean sound_enabled) { this.sound_enabled = sound_enabled; }

        public boolean isVibration_enabled() { return vibration_enabled; }
        public void setVibration_enabled(boolean vibration_enabled) { this.vibration_enabled = vibration_enabled; }

        public String getReminder_message() { return reminder_message; }
        public void setReminder_message(String reminder_message) { this.reminder_message = reminder_message; }

        public String getLast_reminder_sent() { return last_reminder_sent; }
        public void setLast_reminder_sent(String last_reminder_sent) { this.last_reminder_sent = last_reminder_sent; }

        public int getSnooze_minutes() { return snooze_minutes; }
        public void setSnooze_minutes(int snooze_minutes) { this.snooze_minutes = snooze_minutes; }
    }

    @GetMapping("/reminders")
    public ResponseEntity<RemindersResponse> getReviewReminders(
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        printRequest("获取复习提醒设置");

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new RemindersResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT u.user_id FROM users u " +
                    "JOIN user_sessions us ON u.user_id = us.user_id " +
                    "WHERE us.access_token = ? AND us.expires_at > NOW()";

            List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, token);
            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new RemindersResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) users.get(0).get("user_id");
            System.out.println("当前用户ID: " + userId);

            // 2. 从review_settings表获取提醒设置
            String settingsSql = "SELECT reminder_enabled, reminder_time, reminder_days, " +
                    "sound_enabled, vibration_enabled, reminder_message, " +
                    "last_reminder_sent, snooze_minutes " +
                    "FROM review_settings WHERE user_id = ?";

            List<Map<String, Object>> settingsList = jdbcTemplate.queryForList(settingsSql, userId);

            // 3. 如果没有设置，使用默认值
            boolean enabled = true;
            String reminderTime = "18:00";
            List<String> reminderDays = Arrays.asList("Monday", "Tuesday", "Wednesday", "Thursday", "Friday");
            boolean soundEnabled = true;
            boolean vibrationEnabled = true;
            String reminderMessage = "该复习单词啦！";
            String lastReminderSent = LocalDateTime.now().minusHours(2).toString();
            int snoozeMinutes = 15;

            if (!settingsList.isEmpty()) {
                Map<String, Object> settings = settingsList.get(0);

                if (settings.get("reminder_enabled") != null) {
                    enabled = (boolean) settings.get("reminder_enabled");
                }

                if (settings.get("reminder_time") != null) {
                    reminderTime = (String) settings.get("reminder_time");
                }

                if (settings.get("reminder_days") != null) {
                    String daysStr = (String) settings.get("reminder_days");
                    if (daysStr != null && !daysStr.isEmpty()) {
                        reminderDays = Arrays.asList(daysStr.split(","));
                    }
                }

                if (settings.get("sound_enabled") != null) {
                    soundEnabled = (boolean) settings.get("sound_enabled");
                }

                if (settings.get("vibration_enabled") != null) {
                    vibrationEnabled = (boolean) settings.get("vibration_enabled");
                }

                if (settings.get("reminder_message") != null) {
                    reminderMessage = (String) settings.get("reminder_message");
                }

                if (settings.get("last_reminder_sent") != null) {
                    lastReminderSent = settings.get("last_reminder_sent").toString();
                }

                if (settings.get("snooze_minutes") != null) {
                    snoozeMinutes = ((Number) settings.get("snooze_minutes")).intValue();
                }
            }

            // 4. 构建响应数据
            RemindersData data = new RemindersData(
                    enabled,
                    reminderTime,
                    reminderDays,
                    soundEnabled,
                    vibrationEnabled,
                    reminderMessage,
                    lastReminderSent,
                    snoozeMinutes
            );

            RemindersResponse response = new RemindersResponse(true, "获取复习提醒设置成功", data);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取复习提醒设置过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new RemindersResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: ReviewGetReminders.java ---

--- 开始文件: ReviewGetSession.java ---
package com.vue.readingapp.review;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.*;
import java.util.stream.Collectors;

@RestController
@RequestMapping("/api/v1/review")
public class ReviewGetSession {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到获取复习会话详情请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("时间: " + LocalDateTime.now());
        System.out.println("==========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class ReviewSessionResponse {
        private boolean success;
        private String message;
        private ReviewSessionDetail data;

        public ReviewSessionResponse(boolean success, String message, ReviewSessionDetail data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public ReviewSessionDetail getData() { return data; }
        public void setData(ReviewSessionDetail data) { this.data = data; }
    }

    public static class ReviewSessionDetail {
        private String id;
        private String mode;
        private int total_words;
        private int correct_words;
        private double accuracy;
        private int duration;
        private String language;
        private String completed_at;
        private String created_at;
        private List<SessionWord> words;
        private Map<String, Object> stats;

        public ReviewSessionDetail(String id, String mode, int total_words, int correct_words,
                                   double accuracy, int duration, String language, String completed_at,
                                   String created_at, List<SessionWord> words, Map<String, Object> stats) {
            this.id = id;
            this.mode = mode;
            this.total_words = total_words;
            this.correct_words = correct_words;
            this.accuracy = accuracy;
            this.duration = duration;
            this.language = language;
            this.completed_at = completed_at;
            this.created_at = created_at;
            this.words = words;
            this.stats = stats;
        }

        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getMode() { return mode; }
        public void setMode(String mode) { this.mode = mode; }

        public int getTotal_words() { return total_words; }
        public void setTotal_words(int total_words) { this.total_words = total_words; }

        public int getCorrect_words() { return correct_words; }
        public void setCorrect_words(int correct_words) { this.correct_words = correct_words; }

        public double getAccuracy() { return accuracy; }
        public void setAccuracy(double accuracy) { this.accuracy = accuracy; }

        public int getDuration() { return duration; }
        public void setDuration(int duration) { this.duration = duration; }

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }

        public String getCompleted_at() { return completed_at; }
        public void setCompleted_at(String completed_at) { this.completed_at = completed_at; }

        public String getCreated_at() { return created_at; }
        public void setCreated_at(String created_at) { this.created_at = created_at; }

        public List<SessionWord> getWords() { return words; }
        public void setWords(List<SessionWord> words) { this.words = words; }

        public Map<String, Object> getStats() { return stats; }
        public void setStats(Map<String, Object> stats) { this.stats = stats; }
    }

    public static class SessionWord {
        private int id;
        private String word;
        private String language;
        private String definition;
        private String example;
        private String phonetic;
        private String part_of_speech;
        private boolean correct;
        private Integer response_time;
        private String review_type;
        private int mastery_level_before;
        private int mastery_level_after;

        public SessionWord(int id, String word, String language, String definition, String example,
                           String phonetic, String part_of_speech, boolean correct, Integer response_time,
                           String review_type, int mastery_level_before, int mastery_level_after) {
            this.id = id;
            this.word = word;
            this.language = language;
            this.definition = definition;
            this.example = example;
            this.phonetic = phonetic;
            this.part_of_speech = part_of_speech;
            this.correct = correct;
            this.response_time = response_time;
            this.review_type = review_type;
            this.mastery_level_before = mastery_level_before;
            this.mastery_level_after = mastery_level_after;
        }

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public String getWord() { return word; }
        public void setWord(String word) { this.word = word; }

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }

        public String getDefinition() { return definition; }
        public void setDefinition(String definition) { this.definition = definition; }

        public String getExample() { return example; }
        public void setExample(String example) { this.example = example; }

        public String getPhonetic() { return phonetic; }
        public void setPhonetic(String phonetic) { this.phonetic = phonetic; }

        public String getPart_of_speech() { return part_of_speech; }
        public void setPart_of_speech(String part_of_speech) { this.part_of_speech = part_of_speech; }

        public boolean isCorrect() { return correct; }
        public void setCorrect(boolean correct) { this.correct = correct; }

        public Integer getResponse_time() { return response_time; }
        public void setResponse_time(Integer response_time) { this.response_time = response_time; }

        public String getReview_type() { return review_type; }
        public void setReview_type(String review_type) { this.review_type = review_type; }

        public int getMastery_level_before() { return mastery_level_before; }
        public void setMastery_level_before(int mastery_level_before) { this.mastery_level_before = mastery_level_before; }

        public int getMastery_level_after() { return mastery_level_after; }
        public void setMastery_level_after(int mastery_level_after) { this.mastery_level_after = mastery_level_after; }
    }

    @GetMapping("/sessions/{sessionId}")
    public ResponseEntity<ReviewSessionResponse> getReviewSession(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @PathVariable String sessionId) {

        printRequest("sessionId: " + sessionId);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ReviewSessionResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT u.user_id FROM users u " +
                    "JOIN user_sessions us ON u.user_id = us.user_id " +
                    "WHERE us.access_token = ? AND us.expires_at > NOW()";

            List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, token);
            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ReviewSessionResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) users.get(0).get("user_id");
            System.out.println("当前用户ID: " + userId);

            // 2. 获取会话基本信息
            String sessionSql = "SELECT session_id, mode, total_words, correct_words, " +
                    "accuracy, duration, completed_at, created_at " +
                    "FROM review_sessions " +
                    "WHERE session_id = ? AND user_id = ?";

            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(sessionSql, sessionId, userId);
            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new ReviewSessionResponse(false, "复习会话不存在", null)
                );
            }

            Map<String, Object> session = sessions.get(0);

            // 3. 获取会话中的单词详情
            List<SessionWord> sessionWords = getSessionWords(sessionId, userId);

            // 4. 计算统计信息
            Map<String, Object> stats = calculateSessionStats(sessionWords);

            // 5. 确定语言
            String language = determineSessionLanguage(sessionWords);

            // 6. 构建响应数据
            ReviewSessionDetail detail = new ReviewSessionDetail(
                    (String) session.get("session_id"),
                    (String) session.get("mode"),
                    ((Number) session.get("total_words")).intValue(),
                    ((Number) session.get("correct_words")).intValue(),
                    Math.round(((Number) session.get("accuracy")).doubleValue() * 100.0) / 100.0,
                    ((Number) session.get("duration")).intValue(),
                    language,
                    session.get("completed_at").toString(),
                    session.get("created_at").toString(),
                    sessionWords,
                    stats
            );

            ReviewSessionResponse response = new ReviewSessionResponse(true, "获取复习会话详情成功", detail);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取复习会话详情过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ReviewSessionResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private List<SessionWord> getSessionWords(String sessionId, int userId) {
        try {
            // 这里简化处理，实际应该从review_items表获取
            // 由于数据库设计中没有review_items表，我们返回空列表
            System.out.println("注意：数据库中没有review_items表，返回模拟数据");

            // 模拟数据
            List<SessionWord> words = new ArrayList<>();

            // 模拟3个单词
            words.add(new SessionWord(
                    1, "example", "en", "示例", "This is an example.",
                    "/ɪɡˈzæmpəl/", "noun", true, 1500, "recognition", 3, 4
            ));

            words.add(new SessionWord(
                    2, "practice", "en", "练习", "Practice makes perfect.",
                    "/ˈpræktɪs/", "noun", false, 2000, "recognition", 5, 4
            ));

            words.add(new SessionWord(
                    3, "review", "en", "复习", "I need to review my notes.",
                    "/rɪˈvjuː/", "verb", true, 1200, "recognition", 2, 3
            ));

            return words;

        } catch (Exception e) {
            System.err.println("获取会话单词失败: " + e.getMessage());
            return new ArrayList<>();
        }
    }

    private Map<String, Object> calculateSessionStats(List<SessionWord> words) {
        Map<String, Object> stats = new HashMap<>();

        if (words.isEmpty()) {
            stats.put("total_words", 0);
            stats.put("correct_words", 0);
            stats.put("incorrect_words", 0);
            stats.put("accuracy", 0);
            stats.put("average_response_time", 0);
            return stats;
        }

        int totalWords = words.size();
        int correctWords = 0;
        int totalResponseTime = 0;
        int responseTimeCount = 0;

        for (SessionWord word : words) {
            if (word.isCorrect()) {
                correctWords++;
            }

            if (word.getResponse_time() != null) {
                totalResponseTime += word.getResponse_time();
                responseTimeCount++;
            }
        }

        int incorrectWords = totalWords - correctWords;
        double accuracy = (double) correctWords / totalWords * 100;
        double averageResponseTime = responseTimeCount > 0 ?
                (double) totalResponseTime / responseTimeCount : 0;

        stats.put("total_words", totalWords);
        stats.put("correct_words", correctWords);
        stats.put("incorrect_words", incorrectWords);
        stats.put("accuracy", Math.round(accuracy * 100.0) / 100.0);
        stats.put("average_response_time", Math.round(averageResponseTime * 100.0) / 100.0);

        // 按语言统计
        Map<String, Integer> languageStats = new HashMap<>();
        for (SessionWord word : words) {
            String lang = word.getLanguage();
            languageStats.put(lang, languageStats.getOrDefault(lang, 0) + 1);
        }
        stats.put("by_language", languageStats);

        return stats;
    }

    private String determineSessionLanguage(List<SessionWord> words) {
        if (words.isEmpty()) {
            return "mixed";
        }

        // 统计语言出现次数
        Map<String, Integer> languageCount = new HashMap<>();
        for (SessionWord word : words) {
            String lang = word.getLanguage();
            languageCount.put(lang, languageCount.getOrDefault(lang, 0) + 1);
        }

        // 找到出现最多的语言
        String dominantLanguage = "mixed";
        int maxCount = 0;

        for (Map.Entry<String, Integer> entry : languageCount.entrySet()) {
            if (entry.getValue() > maxCount) {
                maxCount = entry.getValue();
                dominantLanguage = entry.getKey();
            }
        }

        // 如果所有单词都是同一种语言，返回该语言
        if (maxCount == words.size()) {
            return dominantLanguage;
        }

        return "mixed";
    }
}

--- 结束文件: ReviewGetSession.java ---

--- 开始文件: ReviewGetSmartWords.java ---

package com.vue.readingapp.review;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.*;
import java.util.stream.Collectors;

@RestController
@RequestMapping("/api/v1/review")
public class ReviewGetSmartWords {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到获取智能复习单词请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("时间: " + LocalDateTime.now());
        System.out.println("==========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class SmartWordsResponse {
        private boolean success;
        private String message;
        private SmartWordsData data;

        public SmartWordsResponse(boolean success, String message, SmartWordsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public SmartWordsData getData() { return data; }
        public void setData(SmartWordsData data) { this.data = data; }
    }

    public static class SmartWordsData {
        private List<SmartWord> words;
        private String algorithm;
        private int total_recommended;

        public SmartWordsData(List<SmartWord> words, String algorithm, int total_recommended) {
            this.words = words;
            this.algorithm = algorithm;
            this.total_recommended = total_recommended;
        }

        public List<SmartWord> getWords() { return words; }
        public void setWords(List<SmartWord> words) { this.words = words; }

        public String getAlgorithm() { return algorithm; }
        public void setAlgorithm(String algorithm) { this.algorithm = algorithm; }

        public int getTotal_recommended() { return total_recommended; }
        public void setTotal_recommended(int total_recommended) { this.total_recommended = total_recommended; }
    }

    public static class SmartWord {
        private int id;
        private String word;
        private String language;
        private String definition;
        private String example;
        private String phonetic;
        private String part_of_speech;
        private int mastery_level;
        private int review_count;
        private String last_reviewed_at;
        private String next_review_at;
        private String difficulty;
        private List<String> tags;
        private String source;
        private String algorithm;
        private double confidence;
        private int recommended_order;

        // Getters and Setters
        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public String getWord() { return word; }
        public void setWord(String word) { this.word = word; }

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }

        public String getDefinition() { return definition; }
        public void setDefinition(String definition) { this.definition = definition; }

        public String getExample() { return example; }
        public void setExample(String example) { this.example = example; }

        public String getPhonetic() { return phonetic; }
        public void setPhonetic(String phonetic) { this.phonetic = phonetic; }

        public String getPart_of_speech() { return part_of_speech; }
        public void setPart_of_speech(String part_of_speech) { this.part_of_speech = part_of_speech; }

        public int getMastery_level() { return mastery_level; }
        public void setMastery_level(int mastery_level) { this.mastery_level = mastery_level; }

        public int getReview_count() { return review_count; }
        public void setReview_count(int review_count) { this.review_count = review_count; }

        public String getLast_reviewed_at() { return last_reviewed_at; }
        public void setLast_reviewed_at(String last_reviewed_at) { this.last_reviewed_at = last_reviewed_at; }

        public String getNext_review_at() { return next_review_at; }
        public void setNext_review_at(String next_review_at) { this.next_review_at = next_review_at; }

        public String getDifficulty() { return difficulty; }
        public void setDifficulty(String difficulty) { this.difficulty = difficulty; }

        public List<String> getTags() { return tags; }
        public void setTags(List<String> tags) { this.tags = tags; }

        public String getSource() { return source; }
        public void setSource(String source) { this.source = source; }

        public String getAlgorithm() { return algorithm; }
        public void setAlgorithm(String algorithm) { this.algorithm = algorithm; }

        public double getConfidence() { return confidence; }
        public void setConfidence(double confidence) { this.confidence = confidence; }

        public int getRecommended_order() { return recommended_order; }
        public void setRecommended_order(int recommended_order) { this.recommended_order = recommended_order; }
    }

    @GetMapping("/smart-words")
    public ResponseEntity<SmartWordsResponse> getSmartWords(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestParam(value = "limit", defaultValue = "20") int limit,
            @RequestParam(value = "language", required = false) String language,
            @RequestParam(value = "algorithm", defaultValue = "spaced_repetition") String algorithm) {

        Map<String, Object> requestParams = new HashMap<>();
        requestParams.put("limit", limit);
        requestParams.put("language", language);
        requestParams.put("algorithm", algorithm);
        printRequest(requestParams);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new SmartWordsResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT u.user_id FROM users u " +
                    "JOIN user_sessions us ON u.user_id = us.user_id " +
                    "WHERE us.access_token = ? AND us.expires_at > NOW()";

            List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, token);
            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new SmartWordsResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) users.get(0).get("user_id");
            System.out.println("当前用户ID: " + userId);

            // 2. 构建查询条件
            StringBuilder sqlBuilder = new StringBuilder();
            List<Object> params = new ArrayList<>();

            sqlBuilder.append("SELECT uv.user_vocab_id, w.word, w.language, ");
            sqlBuilder.append("wd.definition, we.example, w.phonetic, w.part_of_speech, ");
            sqlBuilder.append("uv.mastery_level, uv.review_count, uv.last_reviewed_at, ");
            sqlBuilder.append("uv.next_review_date, w.difficulty, uv.source, ");
            sqlBuilder.append("CASE ");
            sqlBuilder.append("  WHEN uv.mastery_level <= 2 THEN 0.9 ");
            sqlBuilder.append("  WHEN uv.mastery_level <= 4 THEN 0.7 ");
            sqlBuilder.append("  ELSE 0.5 ");
            sqlBuilder.append("END as confidence, ");
            sqlBuilder.append("ROW_NUMBER() OVER (ORDER BY ");

            // 根据算法选择排序方式
            switch (algorithm) {
                case "adaptive":
                    sqlBuilder.append("uv.mastery_level ASC, uv.review_count ASC, uv.next_review_date ASC");
                    break;
                case "random":
                    sqlBuilder.append("RAND()");
                    break;
                case "spaced_repetition":
                default:
                    sqlBuilder.append("uv.next_review_date ASC, uv.mastery_level ASC");
                    break;
            }

            sqlBuilder.append(") as recommended_order ");
            sqlBuilder.append("FROM user_vocabulary uv ");
            sqlBuilder.append("JOIN words w ON uv.word_id = w.word_id ");
            sqlBuilder.append("LEFT JOIN word_definitions wd ON w.word_id = wd.word_id ");
            sqlBuilder.append("LEFT JOIN word_examples we ON w.word_id = we.word_id ");
            sqlBuilder.append("WHERE uv.user_id = ? ");
            sqlBuilder.append("AND uv.is_mastered = 0 ");
            sqlBuilder.append("AND uv.next_review_date <= DATE_ADD(NOW(), INTERVAL 30 DAY) ");

            params.add(userId);

            if (language != null && !language.trim().isEmpty()) {
                sqlBuilder.append("AND w.language = ? ");
                params.add(language);
            }

            sqlBuilder.append("ORDER BY recommended_order ");
            sqlBuilder.append("LIMIT ?");
            params.add(Math.min(limit, 50));

            // 3. 执行查询
            System.out.println("执行SQL: " + sqlBuilder.toString());
            System.out.println("参数: " + params);

            List<Map<String, Object>> smartWordsList = jdbcTemplate.queryForList(
                    sqlBuilder.toString(), params.toArray());

            printQueryResult("查询到 " + smartWordsList.size() + " 个智能复习单词");

            // 4. 处理查询结果
            List<SmartWord> smartWords = new ArrayList<>();
            int order = 1;

            for (Map<String, Object> row : smartWordsList) {
                SmartWord smartWord = new SmartWord();
                smartWord.setId((int) row.get("user_vocab_id"));
                smartWord.setWord((String) row.get("word"));
                smartWord.setLanguage((String) row.get("language"));
                smartWord.setDefinition((String) row.get("definition"));
                smartWord.setExample((String) row.get("example"));
                smartWord.setPhonetic((String) row.get("phonetic"));
                smartWord.setPart_of_speech((String) row.get("part_of_speech"));
                smartWord.setMastery_level((int) row.get("mastery_level"));
                smartWord.setReview_count((int) row.get("review_count"));

                if (row.get("last_reviewed_at") != null) {
                    smartWord.setLast_reviewed_at(row.get("last_reviewed_at").toString());
                }

                if (row.get("next_review_date") != null) {
                    smartWord.setNext_review_at(row.get("next_review_date").toString());
                }

                smartWord.setDifficulty((String) row.get("difficulty"));
                smartWord.setSource((String) row.get("source"));
                smartWord.setAlgorithm(algorithm);
                smartWord.setConfidence((double) row.get("confidence"));
                smartWord.setRecommended_order(order++);

                // 获取标签
                List<String> tags = getTagsForUserVocabulary((int) row.get("user_vocab_id"));
                smartWord.setTags(tags);

                smartWords.add(smartWord);
            }

            // 5. 构建响应数据
            SmartWordsData data = new SmartWordsData(smartWords, algorithm, smartWords.size());
            SmartWordsResponse response = new SmartWordsResponse(true, "获取智能复习单词成功", data);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取智能复习单词过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new SmartWordsResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private List<String> getTagsForUserVocabulary(int userVocabId) {
        try {
            String sql = "SELECT vt.tag_name " +
                    "FROM user_vocabulary_tags uvt " +
                    "JOIN vocabulary_tags vt ON uvt.tag_id = vt.tag_id " +
                    "WHERE uvt.user_vocab_id = ?";

            List<Map<String, Object>> tagsList = jdbcTemplate.queryForList(sql, userVocabId);

            return tagsList.stream()
                    .map(row -> (String) row.get("tag_name"))
                    .collect(Collectors.toList());
        } catch (Exception e) {
            System.err.println("获取标签失败: " + e.getMessage());
            return new ArrayList<>();
        }
    }
}
--- 结束文件: ReviewGetSmartWords.java ---

--- 开始文件: ReviewGetStats.java ---
package com.vue.readingapp.review;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.*;
import java.time.LocalDate;
import java.time.format.DateTimeFormatter;

@RestController
@RequestMapping("/api/v1/review")
public class ReviewGetStats {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到获取复习统计请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("时间: " + LocalDateTime.now());
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class ReviewStatsResponse {
        private boolean success;
        private String message;
        private ReviewStatsData data;

        public ReviewStatsResponse(boolean success, String message, ReviewStatsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public ReviewStatsData getData() { return data; }
        public void setData(ReviewStatsData data) { this.data = data; }
    }

    public static class ReviewStatsData {
        private int total_reviews;
        private int total_words_reviewed;
        private double average_accuracy;
        private int streak_days;
        private int longest_streak;
        private int today_reviews;
        private double today_accuracy;
        private int weekly_reviews;
        private double weekly_accuracy;
        private int monthly_reviews;
        private double monthly_accuracy;
        private Map<String, Object> by_language;
        private Map<String, Object> by_difficulty;
        private List<Map<String, Object>> review_history;

        public ReviewStatsData(int total_reviews, int total_words_reviewed, double average_accuracy,
                               int streak_days, int longest_streak, int today_reviews, double today_accuracy,
                               int weekly_reviews, double weekly_accuracy, int monthly_reviews, double monthly_accuracy,
                               Map<String, Object> by_language, Map<String, Object> by_difficulty,
                               List<Map<String, Object>> review_history) {
            this.total_reviews = total_reviews;
            this.total_words_reviewed = total_words_reviewed;
            this.average_accuracy = average_accuracy;
            this.streak_days = streak_days;
            this.longest_streak = longest_streak;
            this.today_reviews = today_reviews;
            this.today_accuracy = today_accuracy;
            this.weekly_reviews = weekly_reviews;
            this.weekly_accuracy = weekly_accuracy;
            this.monthly_reviews = monthly_reviews;
            this.monthly_accuracy = monthly_accuracy;
            this.by_language = by_language;
            this.by_difficulty = by_difficulty;
            this.review_history = review_history;
        }

        public int getTotal_reviews() { return total_reviews; }
        public void setTotal_reviews(int total_reviews) { this.total_reviews = total_reviews; }

        public int getTotal_words_reviewed() { return total_words_reviewed; }
        public void setTotal_words_reviewed(int total_words_reviewed) { this.total_words_reviewed = total_words_reviewed; }

        public double getAverage_accuracy() { return average_accuracy; }
        public void setAverage_accuracy(double average_accuracy) { this.average_accuracy = average_accuracy; }

        public int getStreak_days() { return streak_days; }
        public void setStreak_days(int streak_days) { this.streak_days = streak_days; }

        public int getLongest_streak() { return longest_streak; }
        public void setLongest_streak(int longest_streak) { this.longest_streak = longest_streak; }

        public int getToday_reviews() { return today_reviews; }
        public void setToday_reviews(int today_reviews) { this.today_reviews = today_reviews; }

        public double getToday_accuracy() { return today_accuracy; }
        public void setToday_accuracy(double today_accuracy) { this.today_accuracy = today_accuracy; }

        public int getWeekly_reviews() { return weekly_reviews; }
        public void setWeekly_reviews(int weekly_reviews) { this.weekly_reviews = weekly_reviews; }

        public double getWeekly_accuracy() { return weekly_accuracy; }
        public void setWeekly_accuracy(double weekly_accuracy) { this.weekly_accuracy = weekly_accuracy; }

        public int getMonthly_reviews() { return monthly_reviews; }
        public void setMonthly_reviews(int monthly_reviews) { this.monthly_reviews = monthly_reviews; }

        public double getMonthly_accuracy() { return monthly_accuracy; }
        public void setMonthly_accuracy(double monthly_accuracy) { this.monthly_accuracy = monthly_accuracy; }

        public Map<String, Object> getBy_language() { return by_language; }
        public void setBy_language(Map<String, Object> by_language) { this.by_language = by_language; }

        public Map<String, Object> getBy_difficulty() { return by_difficulty; }
        public void setBy_difficulty(Map<String, Object> by_difficulty) { this.by_difficulty = by_difficulty; }

        public List<Map<String, Object>> getReview_history() { return review_history; }
        public void setReview_history(List<Map<String, Object>> review_history) { this.review_history = review_history; }
    }

    @GetMapping("/stats")
    public ResponseEntity<ReviewStatsResponse> getReviewStats(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestParam(value = "period", defaultValue = "week") String period,
            @RequestParam(value = "language", required = false) String language,
            @RequestParam(value = "startDate", required = false) String startDate,
            @RequestParam(value = "endDate", required = false) String endDate) {

        Map<String, Object> requestParams = new HashMap<>();
        requestParams.put("period", period);
        requestParams.put("language", language);
        requestParams.put("startDate", startDate);
        requestParams.put("endDate", endDate);
        printRequest(requestParams);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ReviewStatsResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT u.user_id FROM users u " +
                    "JOIN user_sessions us ON u.user_id = us.user_id " +
                    "WHERE us.access_token = ? AND us.expires_at > NOW()";

            List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, token);
            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ReviewStatsResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) users.get(0).get("user_id");
            System.out.println("当前用户ID: " + userId);

            // 2. 获取总复习统计
            int totalReviews = getTotalReviews(userId);
            int totalWordsReviewed = getTotalWordsReviewed(userId);
            double averageAccuracy = getAverageAccuracy(userId);

            // 3. 获取连续学习天数
            int streakDays = calculateStreakDays(userId);
            int longestStreak = getLongestStreak(userId);

            // 4. 获取今日统计
            LocalDate today = LocalDate.now();
            int todayReviews = getReviewsByDate(userId, today.toString(), today.toString());
            double todayAccuracy = getAccuracyByDate(userId, today.toString(), today.toString());

            // 5. 获取本周统计
            LocalDate weekStart = today.minusDays(today.getDayOfWeek().getValue() - 1);
            int weeklyReviews = getReviewsByDate(userId, weekStart.toString(), today.toString());
            double weeklyAccuracy = getAccuracyByDate(userId, weekStart.toString(), today.toString());

            // 6. 获取本月统计
            LocalDate monthStart = LocalDate.of(today.getYear(), today.getMonth(), 1);
            int monthlyReviews = getReviewsByDate(userId, monthStart.toString(), today.toString());
            double monthlyAccuracy = getAccuracyByDate(userId, monthStart.toString(), today.toString());

            // 7. 按语言统计
            Map<String, Object> byLanguage = getStatsByLanguage(userId);

            // 8. 按难度统计
            Map<String, Object> byDifficulty = getStatsByDifficulty(userId);

            // 9. 获取复习历史（最近7天）
            List<Map<String, Object>> reviewHistory = getReviewHistory(userId, 7);

            // 10. 构建响应数据
            ReviewStatsData data = new ReviewStatsData(
                    totalReviews,
                    totalWordsReviewed,
                    Math.round(averageAccuracy * 100.0) / 100.0,
                    streakDays,
                    longestStreak,
                    todayReviews,
                    Math.round(todayAccuracy * 100.0) / 100.0,
                    weeklyReviews,
                    Math.round(weeklyAccuracy * 100.0) / 100.0,
                    monthlyReviews,
                    Math.round(monthlyAccuracy * 100.0) / 100.0,
                    byLanguage,
                    byDifficulty,
                    reviewHistory
            );

            ReviewStatsResponse response = new ReviewStatsResponse(true, "获取复习统计成功", data);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取复习统计过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ReviewStatsResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private int getTotalReviews(int userId) {
        try {
            String sql = "SELECT COUNT(*) FROM review_sessions WHERE user_id = ?";
            return jdbcTemplate.queryForObject(sql, Integer.class, userId);
        } catch (Exception e) {
            System.err.println("获取总复习次数失败: " + e.getMessage());
            return 0;
        }
    }

    private int getTotalWordsReviewed(int userId) {
        try {
            String sql = "SELECT COALESCE(SUM(total_words), 0) FROM review_sessions WHERE user_id = ?";
            return jdbcTemplate.queryForObject(sql, Integer.class, userId);
        } catch (Exception e) {
            System.err.println("获取总复习单词数失败: " + e.getMessage());
            return 0;
        }
    }

    private double getAverageAccuracy(int userId) {
        try {
            String sql = "SELECT COALESCE(AVG(accuracy), 0) FROM review_sessions WHERE user_id = ?";
            Double result = jdbcTemplate.queryForObject(sql, Double.class, userId);
            return result != null ? result : 0.0;
        } catch (Exception e) {
            System.err.println("获取平均准确率失败: " + e.getMessage());
            return 0.0;
        }
    }

    private int calculateStreakDays(int userId) {
        try {
            // 获取用户有复习记录的所有日期
            String sql = "SELECT DISTINCT DATE(completed_at) as review_date " +
                    "FROM review_sessions " +
                    "WHERE user_id = ? " +
                    "ORDER BY review_date DESC";

            List<Map<String, Object>> dates = jdbcTemplate.queryForList(sql, userId);

            if (dates.isEmpty()) {
                return 0;
            }

            LocalDate today = LocalDate.now();
            LocalDate yesterday = today.minusDays(1);
            int streak = 0;

            // 检查今天是否有复习
            boolean todayReviewed = false;
            for (Map<String, Object> dateRow : dates) {
                LocalDate reviewDate = ((java.sql.Date) dateRow.get("review_date")).toLocalDate();
                if (reviewDate.equals(today)) {
                    todayReviewed = true;
                    streak = 1;
                    break;
                }
            }

            // 如果今天没有复习，检查昨天是否有
            if (!todayReviewed) {
                for (Map<String, Object> dateRow : dates) {
                    LocalDate reviewDate = ((java.sql.Date) dateRow.get("review_date")).toLocalDate();
                    if (reviewDate.equals(yesterday)) {
                        streak = 1;
                        break;
                    }
                }
            }

            // 计算连续天数
            if (streak > 0) {
                LocalDate expectedDate = todayReviewed ? today.minusDays(1) : yesterday.minusDays(1);

                for (Map<String, Object> dateRow : dates) {
                    LocalDate reviewDate = ((java.sql.Date) dateRow.get("review_date")).toLocalDate();

                    if (reviewDate.equals(expectedDate)) {
                        streak++;
                        expectedDate = expectedDate.minusDays(1);
                    } else if (reviewDate.isBefore(expectedDate)) {
                        // 跳过中间缺失的日期
                        expectedDate = reviewDate.minusDays(1);
                    }
                }
            }

            return streak;

        } catch (Exception e) {
            System.err.println("计算连续学习天数失败: " + e.getMessage());
            return 0;
        }
    }

    private int getLongestStreak(int userId) {
        try {
            // 简化处理：返回当前连续天数或30天
            int streak = calculateStreakDays(userId);
            return Math.max(streak, 30);
        } catch (Exception e) {
            System.err.println("获取最长连续天数失败: " + e.getMessage());
            return 30;
        }
    }

    private int getReviewsByDate(int userId, String startDate, String endDate) {
        try {
            String sql = "SELECT COUNT(*) FROM review_sessions " +
                    "WHERE user_id = ? AND DATE(completed_at) BETWEEN ? AND ?";
            return jdbcTemplate.queryForObject(sql, Integer.class, userId, startDate, endDate);
        } catch (Exception e) {
            System.err.println("获取日期范围内复习次数失败: " + e.getMessage());
            return 0;
        }
    }

    private double getAccuracyByDate(int userId, String startDate, String endDate) {
        try {
            String sql = "SELECT COALESCE(AVG(accuracy), 0) FROM review_sessions " +
                    "WHERE user_id = ? AND DATE(completed_at) BETWEEN ? AND ?";
            Double result = jdbcTemplate.queryForObject(sql, Double.class, userId, startDate, endDate);
            return result != null ? result : 0.0;
        } catch (Exception e) {
            System.err.println("获取日期范围内准确率失败: " + e.getMessage());
            return 0.0;
        }
    }

    private Map<String, Object> getStatsByLanguage(int userId) {
        try {
            String sql = "SELECT w.language, COUNT(*) as review_count, " +
                    "COALESCE(AVG(rs.accuracy), 0) as avg_accuracy " +
                    "FROM review_sessions rs " +
                    "JOIN user_vocabulary uv ON rs.user_id = uv.user_id " +
                    "JOIN words w ON uv.word_id = w.word_id " +
                    "WHERE rs.user_id = ? " +
                    "GROUP BY w.language";

            List<Map<String, Object>> languageStats = jdbcTemplate.queryForList(sql, userId);

            Map<String, Object> result = new HashMap<>();
            for (Map<String, Object> stat : languageStats) {
                String lang = (String) stat.get("language");
                Map<String, Object> langData = new HashMap<>();
                langData.put("review_count", stat.get("review_count"));
                langData.put("avg_accuracy", Math.round(((Number) stat.get("avg_accuracy")).doubleValue() * 100.0) / 100.0);
                result.put(lang, langData);
            }

            return result;

        } catch (Exception e) {
            System.err.println("获取按语言统计失败: " + e.getMessage());
            return new HashMap<>();
        }
    }

    private Map<String, Object> getStatsByDifficulty(int userId) {
        try {
            String sql = "SELECT w.difficulty, COUNT(*) as review_count, " +
                    "COALESCE(AVG(rs.accuracy), 0) as avg_accuracy " +
                    "FROM review_sessions rs " +
                    "JOIN user_vocabulary uv ON rs.user_id = uv.user_id " +
                    "JOIN words w ON uv.word_id = w.word_id " +
                    "WHERE rs.user_id = ? AND w.difficulty IS NOT NULL " +
                    "GROUP BY w.difficulty";

            List<Map<String, Object>> difficultyStats = jdbcTemplate.queryForList(sql, userId);

            Map<String, Object> result = new HashMap<>();
            for (Map<String, Object> stat : difficultyStats) {
                String diff = (String) stat.get("difficulty");
                Map<String, Object> diffData = new HashMap<>();
                diffData.put("review_count", stat.get("review_count"));
                diffData.put("avg_accuracy", Math.round(((Number) stat.get("avg_accuracy")).doubleValue() * 100.0) / 100.0);
                result.put(diff, diffData);
            }

            return result;

        } catch (Exception e) {
            System.err.println("获取按难度统计失败: " + e.getMessage());
            return new HashMap<>();
        }
    }

    private List<Map<String, Object>> getReviewHistory(int userId, int days) {
        try {
            LocalDate endDate = LocalDate.now();
            LocalDate startDate = endDate.minusDays(days - 1);

            String sql = "SELECT DATE(completed_at) as review_date, " +
                    "COUNT(*) as session_count, " +
                    "SUM(total_words) as total_words, " +
                    "COALESCE(AVG(accuracy), 0) as avg_accuracy " +
                    "FROM review_sessions " +
                    "WHERE user_id = ? AND DATE(completed_at) BETWEEN ? AND ? " +
                    "GROUP BY DATE(completed_at) " +
                    "ORDER BY review_date DESC";

            List<Map<String, Object>> history = jdbcTemplate.queryForList(
                    sql, userId, startDate.toString(), endDate.toString());

            // 格式化日期和数字
            for (Map<String, Object> day : history) {
                if (day.get("avg_accuracy") != null) {
                    double accuracy = ((Number) day.get("avg_accuracy")).doubleValue();
                    day.put("avg_accuracy", Math.round(accuracy * 100.0) / 100.0);
                }
            }

            return history;

        } catch (Exception e) {
            System.err.println("获取复习历史失败: " + e.getMessage());
            return new ArrayList<>();
        }
    }
}

--- 结束文件: ReviewGetStats.java ---

--- 开始文件: ReviewResetProgress.java ---
package com.vue.readingapp.review;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.*;

@RestController
@RequestMapping("/api/v1/review")
public class ReviewResetProgress {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到重置复习进度请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("时间: " + LocalDateTime.now());
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class ResetProgressRequest {
        private String reset_reason;
        private Boolean reset_mastery;
        private Boolean reset_review_count;

        public String getReset_reason() { return reset_reason; }
        public void setReset_reason(String reset_reason) { this.reset_reason = reset_reason; }

        public Boolean getReset_mastery() { return reset_mastery; }
        public void setReset_mastery(Boolean reset_mastery) { this.reset_mastery = reset_mastery; }

        public Boolean getReset_review_count() { return reset_review_count; }
        public void setReset_review_count(Boolean reset_review_count) { this.reset_review_count = reset_review_count; }
    }

    public static class ResetProgressResponse {
        private boolean success;
        private String message;
        private ResetData data;

        public ResetProgressResponse(boolean success, String message, ResetData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public ResetData getData() { return data; }
        public void setData(ResetData data) { this.data = data; }
    }

    public static class ResetData {
        private int user_vocab_id;
        private String word;
        private int new_mastery_level;
        private int new_review_count;
        private String new_next_review_date;
        private String reset_reason;

        public ResetData(int user_vocab_id, String word, int new_mastery_level,
                         int new_review_count, String new_next_review_date, String reset_reason) {
            this.user_vocab_id = user_vocab_id;
            this.word = word;
            this.new_mastery_level = new_mastery_level;
            this.new_review_count = new_review_count;
            this.new_next_review_date = new_next_review_date;
            this.reset_reason = reset_reason;
        }

        public int getUser_vocab_id() { return user_vocab_id; }
        public void setUser_vocab_id(int user_vocab_id) { this.user_vocab_id = user_vocab_id; }

        public String getWord() { return word; }
        public void setWord(String word) { this.word = word; }

        public int getNew_mastery_level() { return new_mastery_level; }
        public void setNew_mastery_level(int new_mastery_level) { this.new_mastery_level = new_mastery_level; }

        public int getNew_review_count() { return new_review_count; }
        public void setNew_review_count(int new_review_count) { this.new_review_count = new_review_count; }

        public String getNew_next_review_date() { return new_next_review_date; }
        public void setNew_next_review_date(String new_next_review_date) { this.new_next_review_date = new_next_review_date; }

        public String getReset_reason() { return reset_reason; }
        public void setReset_reason(String reset_reason) { this.reset_reason = reset_reason; }
    }

    @PutMapping("/reset/{userVocabId}")
    public ResponseEntity<ResetProgressResponse> resetReviewProgress(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @PathVariable String userVocabId,
            @RequestBody(required = false) ResetProgressRequest request) {

        Map<String, Object> requestParams = new HashMap<>();
        requestParams.put("userVocabId", userVocabId);
        requestParams.put("request", request);
        printRequest(requestParams);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ResetProgressResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT u.user_id FROM users u " +
                    "JOIN user_sessions us ON u.user_id = us.user_id " +
                    "WHERE us.access_token = ? AND us.expires_at > NOW()";

            List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, token);
            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ResetProgressResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) users.get(0).get("user_id");
            System.out.println("当前用户ID: " + userId);

            // 2. 验证用户词汇ID
            int vocabId;
            try {
                vocabId = Integer.parseInt(userVocabId);
            } catch (NumberFormatException e) {
                return ResponseEntity.badRequest().body(
                        new ResetProgressResponse(false, "无效的用户词汇ID", null)
                );
            }

            // 3. 检查用户词汇是否存在且属于当前用户
            String checkSql = "SELECT uv.user_vocab_id, w.word, uv.mastery_level, " +
                    "uv.review_count, uv.next_review_date " +
                    "FROM user_vocabulary uv " +
                    "JOIN words w ON uv.word_id = w.word_id " +
                    "WHERE uv.user_vocab_id = ? AND uv.user_id = ?";

            List<Map<String, Object>> vocabList = jdbcTemplate.queryForList(checkSql, vocabId, userId);
            if (vocabList.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new ResetProgressResponse(false, "用户词汇不存在", null)
                );
            }

            Map<String, Object> vocab = vocabList.get(0);
            String word = (String) vocab.get("word");
            int currentMasteryLevel = ((Number) vocab.get("mastery_level")).intValue();
            int currentReviewCount = ((Number) vocab.get("review_count")).intValue();

            // 4. 确定重置参数
            boolean resetMastery = request != null && request.getReset_mastery() != null ?
                    request.getReset_mastery() : true;
            boolean resetReviewCount = request != null && request.getReset_review_count() != null ?
                    request.getReset_review_count() : false;
            String resetReason = request != null && request.getReset_reason() != null ?
                    request.getReset_reason() : "user_reset";

            // 5. 计算新的值
            int newMasteryLevel = resetMastery ? 0 : currentMasteryLevel;
            int newReviewCount = resetReviewCount ? 0 : currentReviewCount;

            LocalDateTime now = LocalDateTime.now();
            LocalDateTime newNextReviewDate;

            if (resetMastery) {
                // 如果重置了掌握等级，下次复习时间设为明天
                newNextReviewDate = now.plusDays(1);
            } else {
                // 否则保持原样
                newNextReviewDate = ((java.sql.Timestamp) vocab.get("next_review_date")).toLocalDateTime();
            }

            // 6. 更新数据库
            StringBuilder updateSql = new StringBuilder("UPDATE user_vocabulary SET ");
            List<Object> params = new ArrayList<>();

            if (resetMastery) {
                updateSql.append("mastery_level = ?, ");
                params.add(newMasteryLevel);

                // 如果掌握等级重置为0，也重置已掌握状态
                updateSql.append("is_mastered = ?, ");
                params.add(0);
            }

            if (resetReviewCount) {
                updateSql.append("review_count = ?, ");
                params.add(newReviewCount);
            }

            if (resetMastery) {
                updateSql.append("next_review_date = ?, ");
                params.add(newNextReviewDate);
            }

            updateSql.append("last_reset_at = ?, reset_count = COALESCE(reset_count, 0) + 1 ");
            params.add(now);

            updateSql.append("WHERE user_vocab_id = ? AND user_id = ?");
            params.add(vocabId);
            params.add(userId);

            System.out.println("执行更新SQL: " + updateSql.toString());
            System.out.println("参数: " + params);

            int updated = jdbcTemplate.update(updateSql.toString(), params.toArray());

            printQueryResult("更新记录数: " + updated);

            if (updated > 0) {
                // 7. 记录重置历史
                recordResetHistory(userId, vocabId, resetReason, resetMastery, resetReviewCount, now);

                // 8. 构建响应数据
                ResetData data = new ResetData(
                        vocabId,
                        word,
                        newMasteryLevel,
                        newReviewCount,
                        newNextReviewDate.toString(),
                        resetReason
                );

                ResetProgressResponse response = new ResetProgressResponse(true, "重置复习进度成功", data);
                printResponse(response);
                return ResponseEntity.ok(response);
            } else {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new ResetProgressResponse(false, "重置复习进度失败", null)
                );
            }

        } catch (Exception e) {
            System.err.println("重置复习进度过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ResetProgressResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private void recordResetHistory(int userId, int userVocabId, String resetReason,
                                    boolean resetMastery, boolean resetReviewCount, LocalDateTime now) {
        try {
            // 检查是否有reset_history表，如果没有就不记录
            // 这里简化处理，只打印日志
            System.out.println("记录重置历史: 用户ID=" + userId +
                    ", 词汇ID=" + userVocabId +
                    ", 原因=" + resetReason +
                    ", 重置掌握等级=" + resetMastery +
                    ", 重置复习次数=" + resetReviewCount);
        } catch (Exception e) {
            System.err.println("记录重置历史失败: " + e.getMessage());
        }
    }
}

--- 结束文件: ReviewResetProgress.java ---

--- 开始文件: ReviewSetReminder.java ---
package com.vue.readingapp.review;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.*;

@RestController
@RequestMapping("/api/v1/review")
public class ReviewSetReminder {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到设置复习提醒请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("时间: " + LocalDateTime.now());
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 在 ReviewSetReminder.java 中重新定义 RemindersData 类
    public static class RemindersData {
        private boolean enabled;
        private String reminder_time;
        private List<String> reminder_days;
        private boolean sound_enabled;
        private boolean vibration_enabled;
        private String reminder_message;
        private String last_reminder_sent;
        private int snooze_minutes;

        public RemindersData(boolean enabled, String reminder_time, List<String> reminder_days,
                             boolean sound_enabled, boolean vibration_enabled, String reminder_message,
                             String last_reminder_sent, int snooze_minutes) {
            this.enabled = enabled;
            this.reminder_time = reminder_time;
            this.reminder_days = reminder_days;
            this.sound_enabled = sound_enabled;
            this.vibration_enabled = vibration_enabled;
            this.reminder_message = reminder_message;
            this.last_reminder_sent = last_reminder_sent;
            this.snooze_minutes = snooze_minutes;
        }

        public boolean isEnabled() { return enabled; }
        public void setEnabled(boolean enabled) { this.enabled = enabled; }

        public String getReminder_time() { return reminder_time; }
        public void setReminder_time(String reminder_time) { this.reminder_time = reminder_time; }

        public List<String> getReminder_days() { return reminder_days; }
        public void setReminder_days(List<String> reminder_days) { this.reminder_days = reminder_days; }

        public boolean isSound_enabled() { return sound_enabled; }
        public void setSound_enabled(boolean sound_enabled) { this.sound_enabled = sound_enabled; }

        public boolean isVibration_enabled() { return vibration_enabled; }
        public void setVibration_enabled(boolean vibration_enabled) { this.vibration_enabled = vibration_enabled; }

        public String getReminder_message() { return reminder_message; }
        public void setReminder_message(String reminder_message) { this.reminder_message = reminder_message; }

        public String getLast_reminder_sent() { return last_reminder_sent; }
        public void setLast_reminder_sent(String last_reminder_sent) { this.last_reminder_sent = last_reminder_sent; }

        public int getSnooze_minutes() { return snooze_minutes; }
        public void setSnooze_minutes(int snooze_minutes) { this.snooze_minutes = snooze_minutes; }
    }

    public static class SetReminderRequest {
        private Boolean enabled;
        private String reminder_time;
        private List<String> reminder_days;
        private Boolean sound_enabled;
        private Boolean vibration_enabled;
        private String reminder_message;
        private Integer snooze_minutes;

        public Boolean getEnabled() { return enabled; }
        public void setEnabled(Boolean enabled) { this.enabled = enabled; }

        public String getReminder_time() { return reminder_time; }
        public void setReminder_time(String reminder_time) { this.reminder_time = reminder_time; }

        public List<String> getReminder_days() { return reminder_days; }
        public void setReminder_days(List<String> reminder_days) { this.reminder_days = reminder_days; }

        public Boolean getSound_enabled() { return sound_enabled; }
        public void setSound_enabled(Boolean sound_enabled) { this.sound_enabled = sound_enabled; }

        public Boolean getVibration_enabled() { return vibration_enabled; }
        public void setVibration_enabled(Boolean vibration_enabled) { this.vibration_enabled = vibration_enabled; }

        public String getReminder_message() { return reminder_message; }
        public void setReminder_message(String reminder_message) { this.reminder_message = reminder_message; }

        public Integer getSnooze_minutes() { return snooze_minutes; }
        public void setSnooze_minutes(Integer snooze_minutes) { this.snooze_minutes = snooze_minutes; }
    }

    public static class SetReminderResponse {
        private boolean success;
        private String message;
        private RemindersData data;

        public SetReminderResponse(boolean success, String message, RemindersData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public RemindersData getData() { return data; }
        public void setData(RemindersData data) { this.data = data; }
    }

    @PostMapping("/reminders")
    public ResponseEntity<SetReminderResponse> setReviewReminder(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestBody SetReminderRequest request) {

        printRequest(request);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new SetReminderResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT u.user_id FROM users u " +
                    "JOIN user_sessions us ON u.user_id = us.user_id " +
                    "WHERE us.access_token = ? AND us.expires_at > NOW()";

            List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, token);
            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new SetReminderResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) users.get(0).get("user_id");
            System.out.println("当前用户ID: " + userId);

            // 2. 验证请求数据
            if (request.getReminder_time() != null) {
                // 简单验证时间格式
                String timePattern = "^([01]?[0-9]|2[0-3]):[0-5][0-9]$";
                if (!request.getReminder_time().matches(timePattern)) {
                    return ResponseEntity.badRequest().body(
                            new SetReminderResponse(false, "提醒时间格式无效，请使用HH:mm格式", null)
                    );
                }
            }

            if (request.getSnooze_minutes() != null &&
                    (request.getSnooze_minutes() < 1 || request.getSnooze_minutes() > 60)) {
                return ResponseEntity.badRequest().body(
                        new SetReminderResponse(false, "延迟分钟数必须在1-60之间", null)
                );
            }

            // 3. 检查是否已有设置记录
            String checkSql = "SELECT COUNT(*) FROM review_settings WHERE user_id = ?";
            int count = jdbcTemplate.queryForObject(checkSql, Integer.class, userId);

            LocalDateTime now = LocalDateTime.now();

            if (count > 0) {
                // 更新现有记录
                StringBuilder updateSql = new StringBuilder("UPDATE review_settings SET ");
                List<Object> params = new ArrayList<>();
                List<String> updates = new ArrayList<>();

                if (request.getEnabled() != null) {
                    updates.add("reminder_enabled = ?");
                    params.add(request.getEnabled());
                }

                if (request.getReminder_time() != null) {
                    updates.add("reminder_time = ?");
                    params.add(request.getReminder_time());
                }

                if (request.getReminder_days() != null) {
                    updates.add("reminder_days = ?");
                    params.add(String.join(",", request.getReminder_days()));
                }

                if (request.getSound_enabled() != null) {
                    updates.add("sound_enabled = ?");
                    params.add(request.getSound_enabled());
                }

                if (request.getVibration_enabled() != null) {
                    updates.add("vibration_enabled = ?");
                    params.add(request.getVibration_enabled());
                }

                if (request.getReminder_message() != null) {
                    updates.add("reminder_message = ?");
                    params.add(request.getReminder_message());
                }

                if (request.getSnooze_minutes() != null) {
                    updates.add("snooze_minutes = ?");
                    params.add(request.getSnooze_minutes());
                }

                updates.add("updated_at = ?");
                params.add(now);

                updateSql.append(String.join(", ", updates));
                updateSql.append(" WHERE user_id = ?");
                params.add(userId);

                System.out.println("执行更新SQL: " + updateSql.toString());
                System.out.println("参数: " + params);

                int updated = jdbcTemplate.update(updateSql.toString(), params.toArray());
                printQueryResult("更新记录数: " + updated);

            } else {
                // 创建新记录
                String insertSql = "INSERT INTO review_settings " +
                        "(user_id, reminder_enabled, reminder_time, reminder_days, " +
                        "sound_enabled, vibration_enabled, reminder_message, " +
                        "snooze_minutes, created_at, updated_at) " +
                        "VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";

                boolean enabled = request.getEnabled() != null ? request.getEnabled() : true;
                String reminderTime = request.getReminder_time() != null ? request.getReminder_time() : "18:00";
                String reminderDays = request.getReminder_days() != null ?
                        String.join(",", request.getReminder_days()) : "Monday,Tuesday,Wednesday,Thursday,Friday";
                boolean soundEnabled = request.getSound_enabled() != null ? request.getSound_enabled() : true;
                boolean vibrationEnabled = request.getVibration_enabled() != null ? request.getVibration_enabled() : true;
                String reminderMessage = request.getReminder_message() != null ?
                        request.getReminder_message() : "该复习单词啦！";
                int snoozeMinutes = request.getSnooze_minutes() != null ? request.getSnooze_minutes() : 15;

                int inserted = jdbcTemplate.update(insertSql,
                        userId,
                        enabled,
                        reminderTime,
                        reminderDays,
                        soundEnabled,
                        vibrationEnabled,
                        reminderMessage,
                        snoozeMinutes,
                        now,
                        now
                );

                printQueryResult("插入记录数: " + inserted);
            }

            // 4. 获取更新后的提醒设置
            RemindersData data = getUpdatedRemindersData(userId, request);

            SetReminderResponse response = new SetReminderResponse(true, "设置复习提醒成功", data);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("设置复习提醒过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new SetReminderResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private RemindersData getUpdatedRemindersData(int userId, SetReminderRequest request) {
        // 获取当前设置值或使用默认值
        boolean enabled = request.getEnabled() != null ? request.getEnabled() : true;
        String reminderTime = request.getReminder_time() != null ? request.getReminder_time() : "18:00";
        List<String> reminderDays = request.getReminder_days() != null ?
                request.getReminder_days() : Arrays.asList("Monday", "Tuesday", "Wednesday", "Thursday", "Friday");
        boolean soundEnabled = request.getSound_enabled() != null ? request.getSound_enabled() : true;
        boolean vibrationEnabled = request.getVibration_enabled() != null ? request.getVibration_enabled() : true;
        String reminderMessage = request.getReminder_message() != null ?
                request.getReminder_message() : "该复习单词啦！";
        int snoozeMinutes = request.getSnooze_minutes() != null ? request.getSnooze_minutes() : 15;

        return new RemindersData(
                enabled,
                reminderTime,
                reminderDays,
                soundEnabled,
                vibrationEnabled,
                reminderMessage,
                LocalDateTime.now().minusHours(2).toString(),
                snoozeMinutes
        );
    }
}
--- 结束文件: ReviewSetReminder.java ---

--- 开始文件: ReviewSkip.java ---
package com.vue.readingapp.review;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.*;

@RestController
@RequestMapping("/api/v1/review")
public class ReviewSkip {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到跳过复习请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("时间: " + LocalDateTime.now());
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class SkipReviewRequest {
        private String skip_reason;
        private Integer skip_days;

        public String getSkip_reason() { return skip_reason; }
        public void setSkip_reason(String skip_reason) { this.skip_reason = skip_reason; }

        public Integer getSkip_days() { return skip_days; }
        public void setSkip_days(Integer skip_days) { this.skip_days = skip_days; }
    }

    public static class SkipReviewResponse {
        private boolean success;
        private String message;
        private SkipData data;

        public SkipReviewResponse(boolean success, String message, SkipData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public SkipData getData() { return data; }
        public void setData(SkipData data) { this.data = data; }
    }

    public static class SkipData {
        private int user_vocab_id;
        private String word;
        private String new_next_review_date;
        private String skip_reason;

        public SkipData(int user_vocab_id, String word, String new_next_review_date, String skip_reason) {
            this.user_vocab_id = user_vocab_id;
            this.word = word;
            this.new_next_review_date = new_next_review_date;
            this.skip_reason = skip_reason;
        }

        public int getUser_vocab_id() { return user_vocab_id; }
        public void setUser_vocab_id(int user_vocab_id) { this.user_vocab_id = user_vocab_id; }

        public String getWord() { return word; }
        public void setWord(String word) { this.word = word; }

        public String getNew_next_review_date() { return new_next_review_date; }
        public void setNew_next_review_date(String new_next_review_date) { this.new_next_review_date = new_next_review_date; }

        public String getSkip_reason() { return skip_reason; }
        public void setSkip_reason(String skip_reason) { this.skip_reason = skip_reason; }
    }

    @PostMapping("/skip/{userVocabId}")
    public ResponseEntity<SkipReviewResponse> skipReview(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @PathVariable String userVocabId,
            @RequestBody(required = false) SkipReviewRequest request) {

        Map<String, Object> requestParams = new HashMap<>();
        requestParams.put("userVocabId", userVocabId);
        requestParams.put("request", request);
        printRequest(requestParams);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new SkipReviewResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT u.user_id FROM users u " +
                    "JOIN user_sessions us ON u.user_id = us.user_id " +
                    "WHERE us.access_token = ? AND us.expires_at > NOW()";

            List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, token);
            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new SkipReviewResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) users.get(0).get("user_id");
            System.out.println("当前用户ID: " + userId);

            // 2. 验证用户词汇ID
            int vocabId;
            try {
                vocabId = Integer.parseInt(userVocabId);
            } catch (NumberFormatException e) {
                return ResponseEntity.badRequest().body(
                        new SkipReviewResponse(false, "无效的用户词汇ID", null)
                );
            }

            // 3. 检查用户词汇是否存在且属于当前用户
            String checkSql = "SELECT uv.user_vocab_id, w.word, uv.next_review_date " +
                    "FROM user_vocabulary uv " +
                    "JOIN words w ON uv.word_id = w.word_id " +
                    "WHERE uv.user_vocab_id = ? AND uv.user_id = ?";

            List<Map<String, Object>> vocabList = jdbcTemplate.queryForList(checkSql, vocabId, userId);
            if (vocabList.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new SkipReviewResponse(false, "用户词汇不存在", null)
                );
            }

            Map<String, Object> vocab = vocabList.get(0);
            String word = (String) vocab.get("word");
            LocalDateTime currentNextReview = ((java.sql.Timestamp) vocab.get("next_review_date")).toLocalDateTime();

            // 4. 确定跳过的天数
            int skipDays = 1; // 默认跳过1天
            if (request != null && request.getSkip_days() != null) {
                skipDays = request.getSkip_days();
                if (skipDays < 1) skipDays = 1;
                if (skipDays > 30) skipDays = 30; // 限制最大跳过30天
            }

            // 5. 确定跳过原因
            String skipReason = "user_skipped";
            if (request != null && request.getSkip_reason() != null) {
                skipReason = request.getSkip_reason();
            }

            // 6. 计算新的复习日期
            LocalDateTime newNextReviewDate = currentNextReview.plusDays(skipDays);
            LocalDateTime now = LocalDateTime.now();

            // 确保新的复习日期至少是明天
            if (newNextReviewDate.isBefore(now.plusDays(1))) {
                newNextReviewDate = now.plusDays(1);
            }

            // 7. 更新数据库
            String updateSql = "UPDATE user_vocabulary SET next_review_date = ?, " +
                    "last_skipped_at = ?, skip_count = COALESCE(skip_count, 0) + 1 " +
                    "WHERE user_vocab_id = ? AND user_id = ?";

            int updated = jdbcTemplate.update(updateSql,
                    newNextReviewDate,
                    now,
                    vocabId,
                    userId
            );

            printQueryResult("更新记录数: " + updated);

            if (updated > 0) {
                // 8. 记录跳过历史（如果有相关表）
                recordSkipHistory(userId, vocabId, skipReason, skipDays, now);

                // 9. 构建响应数据
                SkipData data = new SkipData(
                        vocabId,
                        word,
                        newNextReviewDate.toString(),
                        skipReason
                );

                SkipReviewResponse response = new SkipReviewResponse(true, "跳过复习成功", data);
                printResponse(response);
                return ResponseEntity.ok(response);
            } else {
                return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                        new SkipReviewResponse(false, "跳过复习失败", null)
                );
            }

        } catch (Exception e) {
            System.err.println("跳过复习过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new SkipReviewResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private void recordSkipHistory(int userId, int userVocabId, String skipReason, int skipDays, LocalDateTime now) {
        try {
            // 检查是否有skip_history表，如果没有就不记录
            // 这里简化处理，只打印日志
            System.out.println("记录跳过历史: 用户ID=" + userId +
                    ", 词汇ID=" + userVocabId +
                    ", 原因=" + skipReason +
                    ", 天数=" + skipDays);
        } catch (Exception e) {
            System.err.println("记录跳过历史失败: " + e.getMessage());
        }
    }
}

--- 结束文件: ReviewSkip.java ---

--- 开始文件: ReviewSubmit.java ---
package com.vue.readingapp.review;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.*;
import java.util.stream.Collectors;

@RestController
@RequestMapping("/api/v1/review")
public class ReviewSubmit {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到提交复习结果请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("时间: " + LocalDateTime.now());
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class SubmitReviewRequest {
        private List<ReviewResult> results;
        private String sessionId;
        private Integer duration;
        private String mode;

        public List<ReviewResult> getResults() { return results; }
        public void setResults(List<ReviewResult> results) { this.results = results; }

        public String getSessionId() { return sessionId; }
        public void setSessionId(String sessionId) { this.sessionId = sessionId; }

        public Integer getDuration() { return duration; }
        public void setDuration(Integer duration) { this.duration = duration; }

        public String getMode() { return mode; }
        public void setMode(String mode) { this.mode = mode; }
    }

    public static class ReviewResult {
        private String wordId;
        private boolean correct;
        private Integer responseTime;
        private String reviewType;

        public String getWordId() { return wordId; }
        public void setWordId(String wordId) { this.wordId = wordId; }

        public boolean isCorrect() { return correct; }
        public void setCorrect(boolean correct) { this.correct = correct; }

        public Integer getResponseTime() { return responseTime; }
        public void setResponseTime(Integer responseTime) { this.responseTime = responseTime; }

        public String getReviewType() { return reviewType; }
        public void setReviewType(String reviewType) { this.reviewType = reviewType; }
    }

    public static class SubmitReviewResponse {
        private boolean success;
        private String message;
        private ReviewResultData data;

        public SubmitReviewResponse(boolean success, String message, ReviewResultData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public ReviewResultData getData() { return data; }
        public void setData(ReviewResultData data) { this.data = data; }
    }

    public static class ReviewResultData {
        private String session_id;
        private int total_words;
        private int correct_words;
        private int incorrect_words;
        private double accuracy;
        private int duration;
        private double average_response_time;
        private List<UpdatedWord> updated_words;
        private String timestamp;

        public ReviewResultData(String session_id, int total_words, int correct_words,
                                int incorrect_words, double accuracy, int duration,
                                double average_response_time, List<UpdatedWord> updated_words,
                                String timestamp) {
            this.session_id = session_id;
            this.total_words = total_words;
            this.correct_words = correct_words;
            this.incorrect_words = incorrect_words;
            this.accuracy = accuracy;
            this.duration = duration;
            this.average_response_time = average_response_time;
            this.updated_words = updated_words;
            this.timestamp = timestamp;
        }

        public String getSession_id() { return session_id; }
        public void setSession_id(String session_id) { this.session_id = session_id; }

        public int getTotal_words() { return total_words; }
        public void setTotal_words(int total_words) { this.total_words = total_words; }

        public int getCorrect_words() { return correct_words; }
        public void setCorrect_words(int correct_words) { this.correct_words = correct_words; }

        public int getIncorrect_words() { return incorrect_words; }
        public void setIncorrect_words(int incorrect_words) { this.incorrect_words = incorrect_words; }

        public double getAccuracy() { return accuracy; }
        public void setAccuracy(double accuracy) { this.accuracy = accuracy; }

        public int getDuration() { return duration; }
        public void setDuration(int duration) { this.duration = duration; }

        public double getAverage_response_time() { return average_response_time; }
        public void setAverage_response_time(double average_response_time) { this.average_response_time = average_response_time; }

        public List<UpdatedWord> getUpdated_words() { return updated_words; }
        public void setUpdated_words(List<UpdatedWord> updated_words) { this.updated_words = updated_words; }

        public String getTimestamp() { return timestamp; }
        public void setTimestamp(String timestamp) { this.timestamp = timestamp; }
    }

    public static class UpdatedWord {
        private int id;
        private String word;
        private int mastery_level;
        private int review_count;
        private String next_review_at;

        public UpdatedWord(int id, String word, int mastery_level, int review_count, String next_review_at) {
            this.id = id;
            this.word = word;
            this.mastery_level = mastery_level;
            this.review_count = review_count;
            this.next_review_at = next_review_at;
        }

        public int getId() { return id; }
        public void setId(int id) { this.id = id; }

        public String getWord() { return word; }
        public void setWord(String word) { this.word = word; }

        public int getMastery_level() { return mastery_level; }
        public void setMastery_level(int mastery_level) { this.mastery_level = mastery_level; }

        public int getReview_count() { return review_count; }
        public void setReview_count(int review_count) { this.review_count = review_count; }

        public String getNext_review_at() { return next_review_at; }
        public void setNext_review_at(String next_review_at) { this.next_review_at = next_review_at; }
    }

    @PostMapping("/submit")
    public ResponseEntity<SubmitReviewResponse> submitReview(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestBody SubmitReviewRequest request) {

        printRequest(request);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new SubmitReviewResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT u.user_id FROM users u " +
                    "JOIN user_sessions us ON u.user_id = us.user_id " +
                    "WHERE us.access_token = ? AND us.expires_at > NOW()";

            List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, token);
            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new SubmitReviewResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) users.get(0).get("user_id");
            System.out.println("当前用户ID: " + userId);

            // 2. 验证请求数据
            if (request.getResults() == null || request.getResults().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new SubmitReviewResponse(false, "复习结果不能为空", null)
                );
            }

            if (request.getSessionId() == null || request.getSessionId().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new SubmitReviewResponse(false, "会话ID不能为空", null)
                );
            }

            // 3. 处理每个复习结果
            int totalWords = request.getResults().size();
            int correctWords = 0;
            int totalResponseTime = 0;
            int responseTimeCount = 0;
            List<UpdatedWord> updatedWords = new ArrayList<>();
            LocalDateTime now = LocalDateTime.now();

            for (ReviewResult result : request.getResults()) {
                // 验证单词ID
                if (result.getWordId() == null || result.getWordId().trim().isEmpty()) {
                    continue;
                }

                // 统计正确单词数
                if (result.isCorrect()) {
                    correctWords++;
                }

                // 统计响应时间
                if (result.getResponseTime() != null && result.getResponseTime() > 0) {
                    totalResponseTime += result.getResponseTime();
                    responseTimeCount++;
                }

                // 更新用户词汇状态
                try {
                    int userVocabId = Integer.parseInt(result.getWordId());
                    UpdatedWord updatedWord = updateUserVocabulary(userId, userVocabId, result.isCorrect(), now);
                    if (updatedWord != null) {
                        updatedWords.add(updatedWord);
                    }
                } catch (NumberFormatException e) {
                    System.err.println("单词ID格式错误: " + result.getWordId());
                }
            }

            // 4. 计算统计数据
            int incorrectWords = totalWords - correctWords;
            double accuracy = totalWords > 0 ? (correctWords * 100.0 / totalWords) : 0;
            double averageResponseTime = responseTimeCount > 0 ? (totalResponseTime * 1.0 / responseTimeCount) : 0;

            // 5. 创建复习会话记录
            createReviewSession(userId, request.getSessionId(), totalWords, correctWords,
                    accuracy, request.getDuration() != null ? request.getDuration() : 0,
                    request.getMode() != null ? request.getMode() : "review", now);

            // 6. 更新每日学习统计
            updateDailyLearningStats(userId, correctWords, incorrectWords, now);

            // 7. 构建响应数据
            ReviewResultData data = new ReviewResultData(
                    request.getSessionId(),
                    totalWords,
                    correctWords,
                    incorrectWords,
                    Math.round(accuracy * 100.0) / 100.0,
                    request.getDuration() != null ? request.getDuration() : 0,
                    Math.round(averageResponseTime * 100.0) / 100.0,
                    updatedWords,
                    now.toString()
            );

            SubmitReviewResponse response = new SubmitReviewResponse(true, "复习结果提交成功", data);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("提交复习结果过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new SubmitReviewResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private UpdatedWord updateUserVocabulary(int userId, int userVocabId, boolean correct, LocalDateTime now) {
        try {
            // 1. 获取当前词汇状态
            String selectSql = "SELECT uv.mastery_level, uv.review_count, w.word " +
                    "FROM user_vocabulary uv " +
                    "JOIN words w ON uv.word_id = w.word_id " +
                    "WHERE uv.user_vocab_id = ? AND uv.user_id = ?";

            List<Map<String, Object>> vocabList = jdbcTemplate.queryForList(selectSql, userVocabId, userId);
            if (vocabList.isEmpty()) {
                return null;
            }

            Map<String, Object> vocab = vocabList.get(0);
            int currentMasteryLevel = (int) vocab.get("mastery_level");
            int currentReviewCount = (int) vocab.get("review_count");
            String word = (String) vocab.get("word");

            // 2. 计算新的掌握等级（简单算法）
            int newMasteryLevel = currentMasteryLevel;
            if (correct) {
                newMasteryLevel = Math.min(currentMasteryLevel + 1, 10); // 最大10级
            } else {
                newMasteryLevel = Math.max(currentMasteryLevel - 1, 0); // 最小0级
            }

            // 3. 计算下次复习时间（基于掌握等级的间隔重复算法）
            int daysToAdd = calculateNextReviewDays(newMasteryLevel);
            LocalDateTime nextReviewDate = now.plusDays(daysToAdd);

            // 4. 更新数据库
            String updateSql = "UPDATE user_vocabulary SET " +
                    "mastery_level = ?, " +
                    "review_count = review_count + 1, " +
                    "last_reviewed_at = ?, " +
                    "next_review_date = ?, " +
                    "is_mastered = CASE WHEN mastery_level >= 8 THEN 1 ELSE 0 END " +
                    "WHERE user_vocab_id = ? AND user_id = ?";

            int updated = jdbcTemplate.update(updateSql,
                    newMasteryLevel,
                    now,
                    nextReviewDate,
                    userVocabId,
                    userId
            );

            if (updated > 0) {
                return new UpdatedWord(
                        userVocabId,
                        word,
                        newMasteryLevel,
                        currentReviewCount + 1,
                        nextReviewDate.toString()
                );
            }

            return null;

        } catch (Exception e) {
            System.err.println("更新用户词汇状态失败: " + e.getMessage());
            return null;
        }
    }

    private int calculateNextReviewDays(int masteryLevel) {
        // 简单的间隔重复算法
        switch (masteryLevel) {
            case 0: return 1;   // 第1级：1天后复习
            case 1: return 2;   // 第2级：2天后复习
            case 2: return 4;   // 第3级：4天后复习
            case 3: return 7;   // 第4级：7天后复习
            case 4: return 14;  // 第5级：14天后复习
            case 5: return 30;  // 第6级：30天后复习
            case 6: return 60;  // 第7级：60天后复习
            case 7: return 90;  // 第8级：90天后复习
            case 8: return 180; // 第9级：180天后复习
            case 9: return 365; // 第10级：365天后复习
            default: return 30; // 默认30天
        }
    }

    private void createReviewSession(int userId, String sessionId, int totalWords,
                                     int correctWords, double accuracy, int duration,
                                     String mode, LocalDateTime now) {
        try {
            String sql = "INSERT INTO review_sessions " +
                    "(session_id, user_id, total_words, correct_words, accuracy, " +
                    "duration, mode, completed_at, created_at) " +
                    "VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)";

            jdbcTemplate.update(sql,
                    sessionId,
                    userId,
                    totalWords,
                    correctWords,
                    accuracy,
                    duration,
                    mode,
                    now,
                    now
            );

            System.out.println("创建复习会话记录成功: " + sessionId);

        } catch (Exception e) {
            System.err.println("创建复习会话记录失败: " + e.getMessage());
        }
    }

    private void updateDailyLearningStats(int userId, int correctWords, int incorrectWords, LocalDateTime now) {
        try {
            String dateStr = now.toLocalDate().toString();

            // 检查是否已有今日记录
            String checkSql = "SELECT COUNT(*) FROM daily_learning_stats " +
                    "WHERE user_id = ? AND learning_date = ?";

            int count = jdbcTemplate.queryForObject(checkSql, Integer.class, userId, dateStr);

            if (count > 0) {
                // 更新现有记录
                String updateSql = "UPDATE daily_learning_stats SET " +
                        "words_reviewed = words_reviewed + ?, " +
                        "words_correct = words_correct + ?, " +
                        "words_incorrect = words_incorrect + ?, " +
                        "updated_at = ? " +
                        "WHERE user_id = ? AND learning_date = ?";

                jdbcTemplate.update(updateSql,
                        correctWords + incorrectWords,
                        correctWords,
                        incorrectWords,
                        now,
                        userId,
                        dateStr
                );
            } else {
                // 创建新记录
                String insertSql = "INSERT INTO daily_learning_stats " +
                        "(user_id, learning_date, words_reviewed, " +
                        "words_correct, words_incorrect, created_at, updated_at) " +
                        "VALUES (?, ?, ?, ?, ?, ?, ?)";

                jdbcTemplate.update(insertSql,
                        userId,
                        dateStr,
                        correctWords + incorrectWords,
                        correctWords,
                        incorrectWords,
                        now,
                        now
                );
            }

            System.out.println("更新每日学习统计成功");

        } catch (Exception e) {
            System.err.println("更新每日学习统计失败: " + e.getMessage());
        }
    }
}

--- 结束文件: ReviewSubmit.java ---

--- 开始文件: ReviewUpdateDailyGoal.java ---
package com.vue.readingapp.review;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.*;
import java.time.LocalDate;

@RestController
@RequestMapping("/api/v1/review")
public class ReviewUpdateDailyGoal {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到更新每日目标请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("时间: " + LocalDateTime.now());
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 在 ReviewUpdateDailyGoal.java 中重新定义 DailyGoalData 类
    public static class DailyGoalData {
        private int target_words;
        private int streak_days;
        private int completed_today;
        private double today_progress;
        private double average_daily_words;
        private int best_day;
        private String reminder_time;
        private boolean is_reminder_enabled;

        public DailyGoalData(int target_words, int streak_days, int completed_today,
                             double today_progress, double average_daily_words, int best_day,
                             String reminder_time, boolean is_reminder_enabled) {
            this.target_words = target_words;
            this.streak_days = streak_days;
            this.completed_today = completed_today;
            this.today_progress = today_progress;
            this.average_daily_words = average_daily_words;
            this.best_day = best_day;
            this.reminder_time = reminder_time;
            this.is_reminder_enabled = is_reminder_enabled;
        }

        public int getTarget_words() { return target_words; }
        public void setTarget_words(int target_words) { this.target_words = target_words; }

        public int getStreak_days() { return streak_days; }
        public void setStreak_days(int streak_days) { this.streak_days = streak_days; }

        public int getCompleted_today() { return completed_today; }
        public void setCompleted_today(int completed_today) { this.completed_today = completed_today; }

        public double getToday_progress() { return today_progress; }
        public void setToday_progress(double today_progress) { this.today_progress = today_progress; }

        public double getAverage_daily_words() { return average_daily_words; }
        public void setAverage_daily_words(double average_daily_words) { this.average_daily_words = average_daily_words; }

        public int getBest_day() { return best_day; }
        public void setBest_day(int best_day) { this.best_day = best_day; }

        public String getReminder_time() { return reminder_time; }
        public void setReminder_time(String reminder_time) { this.reminder_time = reminder_time; }

        public boolean isIs_reminder_enabled() { return is_reminder_enabled; }
        public void setIs_reminder_enabled(boolean is_reminder_enabled) { this.is_reminder_enabled = is_reminder_enabled; }
    }

    public static class UpdateDailyGoalRequest {
        private Integer target_words;
        private String reminder_time;
        private Boolean is_reminder_enabled;

        public Integer getTarget_words() { return target_words; }
        public void setTarget_words(Integer target_words) { this.target_words = target_words; }

        public String getReminder_time() { return reminder_time; }
        public void setReminder_time(String reminder_time) { this.reminder_time = reminder_time; }

        public Boolean getIs_reminder_enabled() { return is_reminder_enabled; }
        public void setIs_reminder_enabled(Boolean is_reminder_enabled) { this.is_reminder_enabled = is_reminder_enabled; }
    }

    public static class UpdateDailyGoalResponse {
        private boolean success;
        private String message;
        private DailyGoalData data;

        public UpdateDailyGoalResponse(boolean success, String message, DailyGoalData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public DailyGoalData getData() { return data; }
        public void setData(DailyGoalData data) { this.data = data; }
    }

    @PutMapping("/daily-goal")
    public ResponseEntity<UpdateDailyGoalResponse> updateDailyGoal(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestBody UpdateDailyGoalRequest request) {

        printRequest(request);

        try {
            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateDailyGoalResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            String userSql = "SELECT u.user_id FROM users u " +
                    "JOIN user_sessions us ON u.user_id = us.user_id " +
                    "WHERE us.access_token = ? AND us.expires_at > NOW()";

            List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, token);
            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateDailyGoalResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) users.get(0).get("user_id");
            System.out.println("当前用户ID: " + userId);

            // 2. 验证请求数据
            if (request.getTarget_words() != null && request.getTarget_words() < 1) {
                return ResponseEntity.badRequest().body(
                        new UpdateDailyGoalResponse(false, "目标单词数必须大于0", null)
                );
            }

            if (request.getTarget_words() != null && request.getTarget_words() > 1000) {
                return ResponseEntity.badRequest().body(
                        new UpdateDailyGoalResponse(false, "目标单词数不能超过1000", null)
                );
            }

            if (request.getReminder_time() != null) {
                // 简单验证时间格式
                String timePattern = "^([01]?[0-9]|2[0-3]):[0-5][0-9]$";
                if (!request.getReminder_time().matches(timePattern)) {
                    return ResponseEntity.badRequest().body(
                            new UpdateDailyGoalResponse(false, "提醒时间格式无效，请使用HH:mm格式", null)
                    );
                }
            }

            // 3. 检查是否已有设置记录
            String checkSql = "SELECT COUNT(*) FROM review_settings WHERE user_id = ?";
            int count = jdbcTemplate.queryForObject(checkSql, Integer.class, userId);

            LocalDateTime now = LocalDateTime.now();

            if (count > 0) {
                // 更新现有记录
                StringBuilder updateSql = new StringBuilder("UPDATE review_settings SET ");
                List<Object> params = new ArrayList<>();
                List<String> updates = new ArrayList<>();

                if (request.getTarget_words() != null) {
                    updates.add("daily_target_words = ?");
                    params.add(request.getTarget_words());
                }

                if (request.getReminder_time() != null) {
                    updates.add("reminder_time = ?");
                    params.add(request.getReminder_time());
                }

                if (request.getIs_reminder_enabled() != null) {
                    updates.add("reminder_enabled = ?");
                    params.add(request.getIs_reminder_enabled());
                }

                updates.add("updated_at = ?");
                params.add(now);

                updateSql.append(String.join(", ", updates));
                updateSql.append(" WHERE user_id = ?");
                params.add(userId);

                System.out.println("执行更新SQL: " + updateSql.toString());
                System.out.println("参数: " + params);

                int updated = jdbcTemplate.update(updateSql.toString(), params.toArray());
                printQueryResult("更新记录数: " + updated);

            } else {
                // 创建新记录
                String insertSql = "INSERT INTO review_settings " +
                        "(user_id, daily_target_words, reminder_time, " +
                        "reminder_enabled, created_at, updated_at) " +
                        "VALUES (?, ?, ?, ?, ?, ?)";

                int targetWords = request.getTarget_words() != null ? request.getTarget_words() : 20;
                String reminderTime = request.getReminder_time() != null ? request.getReminder_time() : "18:00";
                boolean isReminderEnabled = request.getIs_reminder_enabled() != null ?
                        request.getIs_reminder_enabled() : true;

                int inserted = jdbcTemplate.update(insertSql,
                        userId,
                        targetWords,
                        reminderTime,
                        isReminderEnabled,
                        now,
                        now
                );

                printQueryResult("插入记录数: " + inserted);
            }

            // 4. 获取更新后的每日目标数据
            DailyGoalData data = getUpdatedDailyGoalData(userId, request);

            UpdateDailyGoalResponse response = new UpdateDailyGoalResponse(true, "更新每日目标成功", data);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("更新每日目标过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdateDailyGoalResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private DailyGoalData getUpdatedDailyGoalData(int userId, UpdateDailyGoalRequest request) {
        // 获取当前设置值或使用默认值
        int targetWords = request.getTarget_words() != null ? request.getTarget_words() : 20;
        String reminderTime = request.getReminder_time() != null ? request.getReminder_time() : "18:00";
        boolean isReminderEnabled = request.getIs_reminder_enabled() != null ?
                request.getIs_reminder_enabled() : true;

        // 获取连续学习天数
        int streakDays = calculateStreakDays(userId);

        // 获取今日完成情况
        LocalDateTime now = LocalDateTime.now();
        String today = now.toLocalDate().toString();
        int completedToday = getTodayCompleted(userId, today);

        // 计算今日进度
        double todayProgress = targetWords > 0 ? (double) completedToday / targetWords * 100 : 0;

        // 获取平均每日单词数
        double averageDailyWords = getAverageDailyWords(userId);

        // 获取最佳日单词数
        int bestDay = getBestDay(userId);

        return new DailyGoalData(
                targetWords,
                streakDays,
                completedToday,
                Math.round(todayProgress * 100.0) / 100.0,
                Math.round(averageDailyWords * 100.0) / 100.0,
                bestDay,
                reminderTime,
                isReminderEnabled
        );
    }

    private int calculateStreakDays(int userId) {
        try {
            // 获取用户有复习记录的所有日期
            String sql = "SELECT DISTINCT DATE(completed_at) as review_date " +
                    "FROM review_sessions " +
                    "WHERE user_id = ? " +
                    "ORDER BY review_date DESC";

            List<Map<String, Object>> dates = jdbcTemplate.queryForList(sql, userId);

            if (dates.isEmpty()) {
                return 0;
            }

            LocalDateTime now = LocalDateTime.now();
            LocalDate today = now.toLocalDate();
            LocalDate yesterday = today.minusDays(1);
            int streak = 0;

            // 检查今天是否有复习
            boolean todayReviewed = false;
            for (Map<String, Object> dateRow : dates) {
                LocalDate reviewDate = ((java.sql.Date) dateRow.get("review_date")).toLocalDate();
                if (reviewDate.equals(today)) {
                    todayReviewed = true;
                    streak = 1;
                    break;
                }
            }

            // 如果今天没有复习，检查昨天是否有
            if (!todayReviewed) {
                for (Map<String, Object> dateRow : dates) {
                    LocalDate reviewAddress = ((java.sql.Date) dateRow.get("review_date")).toLocalDate();
                    if (reviewAddress.equals(yesterday)) {
                        streak = 1;
                        break;
                    }
                }
            }

            // 计算连续天数
            if (streak > 0) {
                LocalDate expectedDate = todayReviewed ? today.minusDays(1) : yesterday.minusDays(1);

                for (Map<String, Object> dateRow : dates) {
                    LocalDate reviewDate = ((java.sql.Date) dateRow.get("review_date")).toLocalDate();

                    if (reviewDate.equals(expectedDate)) {
                        streak++;
                        expectedDate = expectedDate.minusDays(1);
                    } else if (reviewDate.isBefore(expectedDate)) {
                        // 跳过中间缺失的日期
                        expectedDate = reviewDate.minusDays(1);
                    }
                }
            }

            return streak;

        } catch (Exception e) {
            System.err.println("计算连续学习天数失败: " + e.getMessage());
            return 0;
        }
    }

    private int getTodayCompleted(int userId, String today) {
        try {
            String sql = "SELECT COALESCE(SUM(total_words), 0) as today_words " +
                    "FROM review_sessions " +
                    "WHERE user_id = ? AND DATE(completed_at) = ?";

            return jdbcTemplate.queryForObject(sql, Integer.class, userId, today);

        } catch (Exception e) {
            System.err.println("获取今日完成情况失败: " + e.getMessage());
            return 0;
        }
    }

    private double getAverageDailyWords(int userId) {
        try {
            // 获取总单词数和学习天数
            String sql = "SELECT " +
                    "COALESCE(SUM(total_words), 0) as total_words, " +
                    "COUNT(DISTINCT DATE(completed_at)) as days_count " +
                    "FROM review_sessions WHERE user_id = ?";

            Map<String, Object> stats = jdbcTemplate.queryForMap(sql, userId);
            int totalWords = ((Number) stats.get("total_words")).intValue();
            int daysCount = ((Number) stats.get("days_count")).intValue();

            return daysCount > 0 ? (double) totalWords / daysCount : 0;

        } catch (Exception e) {
            System.err.println("获取平均每日单词数失败: " + e.getMessage());
            return 0;
        }
    }

    private int getBestDay(int userId) {
        try {
            String sql = "SELECT COALESCE(MAX(total_words), 0) as best_day " +
                    "FROM review_sessions WHERE user_id = ?";

            return jdbcTemplate.queryForObject(sql, Integer.class, userId);

        } catch (Exception e) {
            System.err.println("获取最佳日单词数失败: " + e.getMessage());
            return 0;
        }
    }
}
--- 结束文件: ReviewUpdateDailyGoal.java ---

--- 开始文件: ReviewUpdatePlan.java ---
package com.vue.readingapp.review;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.*;
import java.time.LocalDate;
import java.util.stream.Collectors; // 用于 Stream API

@RestController
@RequestMapping("/api/v1/review")
public class ReviewUpdatePlan {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // --- 辅助打印方法 ---
    private void printRequest(Object request) {
        System.out.println("=== 收到更新复习计划请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("时间: " + LocalDateTime.now());
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // --- 请求 DTO ---
    public static class UpdatePlanRequest {
        private Integer daily_target_words;
        private Integer weekly_target_days;
        private String preferred_time;
        private List<String> preferred_days;
        private String language_focus;
        private String difficulty_level;
        private Boolean is_active;

        public Integer getDaily_target_words() { return daily_target_words; }
        public void setDaily_target_words(Integer daily_target_words) { this.daily_target_words = daily_target_words; }

        public Integer getWeekly_target_days() { return weekly_target_days; }
        public void setWeekly_target_days(Integer weekly_target_days) { this.weekly_target_days = weekly_target_days; }

        public String getPreferred_time() { return preferred_time; }
        public void setPreferred_time(String preferred_time) { this.preferred_time = preferred_time; }

        public List<String> getPreferred_days() { return preferred_days; }
        public void setPreferred_days(List<String> preferred_days) { this.preferred_days = preferred_days; }

        public String getLanguage_focus() { return language_focus; }
        public void setLanguage_focus(String language_focus) { this.language_focus = language_focus; }

        public String getDifficulty_level() { return difficulty_level; }
        public void setDifficulty_level(String difficulty_level) { this.difficulty_level = difficulty_level; }

        public Boolean getIs_active() { return is_active; }
        public void setIs_active(Boolean is_active) { this.is_active = is_active; }

        @Override
        public String toString() {
            return "UpdatePlanRequest{" +
                    "daily_target_words=" + daily_target_words +
                    ", weekly_target_days=" + weekly_target_days +
                    ", preferred_time='" + preferred_time + '\'' +
                    ", preferred_days=" + preferred_days +
                    ", language_focus='" + language_focus + '\'' +
                    ", difficulty_level='" + difficulty_level + '\'' +
                    ", is_active=" + is_active +
                    '}';
        }
    }

    // --- 响应 DTO ---
    public static class UpdatePlanResponse {
        private boolean success;
        private String message;
        private ReviewPlanData data; // 使用内部定义的 ReviewPlanData

        public UpdatePlanResponse(boolean success, String message, ReviewPlanData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public ReviewPlanData getData() { return data; }
        public void setData(ReviewPlanData data) { this.data = data; }

        @Override
        public String toString() {
            return "UpdatePlanResponse{" +
                    "success=" + success +
                    ", message='" + message + '\'' +
                    ", data=" + data +
                    '}';
        }
    }

    // --- 内部定义的 Response Data DTO ---
    public static class ReviewPlanData {
        private String id; // 计划的唯一标识，例如 "plan_" + userId
        private String userId;
        private String name; // 复习计划的名称
        private String description; // 复习计划的描述
        private Integer dailyTargetWords;
        private Integer weeklyTargetDays;
        private String preferredTime;
        private List<String> preferredDays;
        private String languageFocus;
        private String difficultyLevel;
        private Boolean isActive;
        private String createdAt; // ISO 8601 格式的日期时间字符串
        private String updatedAt; // ISO 8601 格式的日期时间字符串

        // 嵌套的进度统计类
        private PlanProgress progress;

        public ReviewPlanData(String id, String userId, String name, String description, Integer dailyTargetWords, Integer weeklyTargetDays, String preferredTime, List<String> preferredDays, String languageFocus, String difficultyLevel, Boolean isActive, String createdAt, String updatedAt, PlanProgress progress) {
            this.id = id;
            this.userId = userId;
            this.name = name;
            this.description = description;
            this.dailyTargetWords = dailyTargetWords;
            this.weeklyTargetDays = weeklyTargetDays;
            this.preferredTime = preferredTime;
            this.preferredDays = preferredDays;
            this.languageFocus = languageFocus;
            this.difficultyLevel = difficultyLevel;
            this.isActive = isActive;
            this.createdAt = createdAt;
            this.updatedAt = updatedAt;
            this.progress = progress;
        }

        // Getters
        public String getId() { return id; }
        public String getUserId() { return userId; }
        public String getName() { return name; }
        public String getDescription() { return description; }
        public Integer getDailyTargetWords() { return dailyTargetWords; }
        public Integer getWeeklyTargetDays() { return weeklyTargetDays; }
        public String getPreferredTime() { return preferredTime; }
        public List<String> getPreferredDays() { return preferredDays; }
        public String getLanguageFocus() { return languageFocus; }
        public String getDifficultyLevel() { return difficultyLevel; }
        public Boolean getIsActive() { return isActive; }
        public String getCreatedAt() { return createdAt; }
        public String getUpdatedAt() { return updatedAt; }
        public PlanProgress getProgress() { return progress; }

        // Setters (仅为满足JavaBean规范，实际逻辑中不需要频繁调用)
        public void setId(String id) { this.id = id; }
        public void setUserId(String userId) { this.userId = userId; }
        public void setName(String name) { this.name = name; }
        public void setDescription(String description) { this.description = description; }
        public void setDailyTargetWords(Integer dailyTargetWords) { this.dailyTargetWords = dailyTargetWords; }
        public void setWeeklyTargetDays(Integer weeklyTargetDays) { this.weeklyTargetDays = weeklyTargetDays; }
        public void setPreferredTime(String preferredTime) { this.preferredTime = preferredTime; }
        public void setPreferredDays(List<String> preferredDays) { this.preferredDays = preferredDays; }
        public void setLanguageFocus(String languageFocus) { this.languageFocus = languageFocus; }
        public void setDifficultyLevel(String difficultyLevel) { this.difficultyLevel = difficultyLevel; }
        public void setIsActive(Boolean active) { isActive = active; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }
        public void setProgress(PlanProgress progress) { this.progress = progress; }


        @Override
        public String toString() {
            return "ReviewPlanData{" +
                    "id='" + id + '\'' +
                    ", userId='" + userId + '\'' +
                    ", name='" + name + '\'' +
                    ", description='" + description + '\'' +
                    ", dailyTargetWords=" + dailyTargetWords +
                    ", weeklyTargetDays=" + weeklyTargetDays +
                    ", preferredTime='" + preferredTime + '\'' +
                    ", preferredDays=" + preferredDays +
                    ", languageFocus='" + languageFocus + '\'' +
                    ", difficultyLevel='" + difficultyLevel + '\'' +
                    ", isActive=" + isActive +
                    ", createdAt='" + createdAt + '\'' +
                    ", updatedAt='" + updatedAt + '\'' +
                    ", progress=" + progress +
                    '}';
        }

        // Equals and HashCode (用于潜在的测试或比较，此处省略以保持简洁，但实际项目可能需要)
    }

    // --- 内部定义的 Progress DTO ---
    public static class PlanProgress {
        private Integer todayWordsCompleted;
        private Integer dailyTargetWords;
        private Double todayProgressPercentage;
        private Integer weekWordsCompleted;
        private Integer weeklyTargetTotalWords; // 假设是 dailyTargetWords * weeklyTargetDays
        private Double weekProgressPercentage;
        private Integer consecutiveDaysStreak;
        private Integer totalWordsReviewed;
        private Double averageAccuracy;

        public PlanProgress(Integer todayWordsCompleted, Integer dailyTargetWords, Double todayProgressPercentage, Integer weekWordsCompleted, Integer weeklyTargetTotalWords, Double weekProgressPercentage, Integer consecutiveDaysStreak, Integer totalWordsReviewed, Double averageAccuracy) {
            this.todayWordsCompleted = todayWordsCompleted;
            this.dailyTargetWords = dailyTargetWords;
            this.todayProgressPercentage = todayProgressPercentage;
            this.weekWordsCompleted = weekWordsCompleted;
            this.weeklyTargetTotalWords = weeklyTargetTotalWords;
            this.weekProgressPercentage = weekProgressPercentage;
            this.consecutiveDaysStreak = consecutiveDaysStreak;
            this.totalWordsReviewed = totalWordsReviewed;
            this.averageAccuracy = averageAccuracy;
        }

        // Getters
        public Integer getTodayWordsCompleted() { return todayWordsCompleted; }
        public Integer getDailyTargetWords() { return dailyTargetWords; }
        public Double getTodayProgressPercentage() { return todayProgressPercentage; }
        public Integer getWeekWordsCompleted() { return weekWordsCompleted; }
        public Integer getWeeklyTargetTotalWords() { return weeklyTargetTotalWords; }
        public Double getWeekProgressPercentage() { return weekProgressPercentage; }
        public Integer getConsecutiveDaysStreak() { return consecutiveDaysStreak; }
        public Integer getTotalWordsReviewed() { return totalWordsReviewed; }
        public Double getAverageAccuracy() { return averageAccuracy; }

        // Setters (仅为满足JavaBean规范)
        public void setTodayWordsCompleted(Integer todayWordsCompleted) { this.todayWordsCompleted = todayWordsCompleted; }
        public void setDailyTargetWords(Integer dailyTargetWords) { this.dailyTargetWords = dailyTargetWords; }
        public void setTodayProgressPercentage(Double todayProgressPercentage) { this.todayProgressPercentage = todayProgressPercentage; }
        public void setWeekWordsCompleted(Integer weekWordsCompleted) { this.weekWordsCompleted = weekWordsCompleted; }
        public void setWeeklyTargetTotalWords(Integer weeklyTargetTotalWords) { this.weeklyTargetTotalWords = weeklyTargetTotalWords; }
        public void setWeekProgressPercentage(Double weekProgressPercentage) { this.weekProgressPercentage = weekProgressPercentage; }
        public void setConsecutiveDaysStreak(Integer consecutiveDaysStreak) { this.consecutiveDaysStreak = consecutiveDaysStreak; }
        public void setTotalWordsReviewed(Integer totalWordsReviewed) { this.totalWordsReviewed = totalWordsReviewed; }
        public void setAverageAccuracy(Double averageAccuracy) { this.averageAccuracy = averageAccuracy; }

        @Override
        public String toString() {
            return "PlanProgress{" +
                    "todayWordsCompleted=" + todayWordsCompleted +
                    ", dailyTargetWords=" + dailyTargetWords +
                    ", todayProgressPercentage=" + todayProgressPercentage +
                    ", weekWordsCompleted=" + weekWordsCompleted +
                    ", weeklyTargetTotalWords=" + weeklyTargetTotalWords +
                    ", weekProgressPercentage=" + weekProgressPercentage +
                    ", consecutiveDaysStreak=" + consecutiveDaysStreak +
                    ", totalWordsReviewed=" + totalWordsReviewed +
                    ", averageAccuracy=" + averageAccuracy +
                    '}';
        }

        // Equals and HashCode (用于潜在的测试或比较)
    }

    // --- API Endpoint ---
    @PutMapping("/plan")
    public ResponseEntity<UpdatePlanResponse> updateReviewPlan(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestBody UpdatePlanRequest request) {

        printRequest(request);

        try {
            // 1. 验证 token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdatePlanResponse(false, "请先登录", null)
                );
            }

            String token = authHeader.substring(7);
            // 注意：这里的 SQL 是为了演示，实际项目中不应直接硬编码 Token，应使用更安全的 Session/Token 管理机制
            String userSql = "SELECT u.user_id FROM users u JOIN user_sessions us ON u.user_id = us.user_id WHERE us.access_token = ? AND us.expires_at > NOW()";

            List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, token);
            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdatePlanResponse(false, "登录已过期，请重新登录", null)
                );
            }

            int userId = (int) users.get(0).get("user_id");
            System.out.println("当前用户ID: " + userId);

            // 2. 验证请求数据
            if (request.getDaily_target_words() != null && request.getDaily_target_words() < 1) {
                return ResponseEntity.badRequest().body(
                        new UpdatePlanResponse(false, "每日目标单词数必须大于0", null)
                );
            }

            if (request.getWeekly_target_days() != null &&
                    (request.getWeekly_target_days() < 1 || request.getWeekly_target_days() > 7)) {
                return ResponseEntity.badRequest().body(
                        new UpdatePlanResponse(false, "每周目标天数必须在1-7之间", null)
                );
            }

            // 3. 检查是否已有设置记录 (使用 review_settings 表)
            String checkSql = "SELECT COUNT(*) FROM review_settings WHERE user_id = ?";
            int count = jdbcTemplate.queryForObject(checkSql, Integer.class, userId);

            LocalDateTime now = LocalDateTime.now();
            String nowIso = now.toString(); // for database insertion/update

            // --- 准备更新或插入数据 ---
            // 为方便代码逻辑，先将请求参数和默认值合并
            int dailyTargetWords = request.getDaily_target_words() != null ? request.getDaily_target_words() : 20;
            int weeklyTargetDays = request.getWeekly_target_days() != null ? request.getWeekly_target_days() : 5;
            String preferredTime = request.getPreferred_time() != null ? request.getPreferred_time() : "18:00";
            List<String> preferredDays = request.getPreferred_days() != null ? request.getPreferred_days() : Arrays.asList("Monday", "Tuesday", "Wednesday", "Thursday", "Friday");
            String preferredDaysString = String.join(",", preferredDays); // 数据库存储格式
            String languageFocus = request.getLanguage_focus() != null ? request.getLanguage_focus() : "en";
            String difficultyLevel = request.getDifficulty_level() != null ? request.getDifficulty_level() : "medium";
            boolean isActive = request.getIs_active() != null ? request.getIs_active() : true;

            if (count > 0) {
                // 更新现有记录
                StringBuilder updateSql = new StringBuilder("UPDATE review_settings SET ");
                List<Object> params = new ArrayList<>();
                List<String> updates = new ArrayList<>();

                // 动态构建 SET 子句，只更新传入的字段
                if (request.getDaily_target_words() != null) {
                    updates.add("daily_target_words = ?");
                    params.add(dailyTargetWords);
                }
                if (request.getWeekly_target_days() != null) {
                    updates.add("weekly_target_days = ?");
                    params.add(weeklyTargetDays);
                }
                if (request.getPreferred_time() != null) {
                    updates.add("preferred_time = ?");
                    params.add(preferredTime);
                }
                if (request.getPreferred_days() != null) {
                    updates.add("preferred_days = ?");
                    params.add(preferredDaysString);
                }
                if (request.getLanguage_focus() != null) {
                    updates.add("language_focus = ?");
                    params.add(languageFocus);
                }
                if (request.getDifficulty_level() != null) {
                    updates.add("difficulty_level = ?");
                    params.add(difficultyLevel);
                }
                if (request.getIs_active() != null) {
                    updates.add("is_active = ?");
                    params.add(isActive);
                }

                // 无论是否更新，都更新 updated_at
                updates.add("updated_at = ?");
                params.add(now);

                updateSql.append(String.join(", ", updates));
                updateSql.append(" WHERE user_id = ?");
                params.add(userId);

                System.out.println("执行更新SQL: " + updateSql.toString());
                //printQueryResult("参数: " + params); // 打印参数可能过于冗长，仅打印SQL

                int updated = jdbcTemplate.update(updateSql.toString(), params.toArray());
                printQueryResult("更新 review_settings 记录数: " + updated);

            } else {
                // 创建新记录
                String insertSql = "INSERT INTO review_settings " +
                        "(user_id, daily_target_words, weekly_target_days, " +
                        "preferred_time, preferred_days, language_focus, " +
                        "difficulty_level, is_active, created_at, updated_at) " +
                        "VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)";

                int inserted = jdbcTemplate.update(insertSql,
                        userId,
                        dailyTargetWords,
                        weeklyTargetDays,
                        preferredTime,
                        preferredDaysString,
                        languageFocus,
                        difficultyLevel,
                        isActive,
                        now, // created_at
                        now  // updated_at
                );
                printQueryResult("插入 review_settings 记录数: " + inserted);
            }

            // 4. 获取更新后的计划数据
            // 使用一个内部方法来模拟 'ReviewGetPlan' 的部分逻辑，以获取最新的计划和进度
            ReviewPlanData updatedPlanData = getUpdatedPlanData(userId, dailyTargetWords, weeklyTargetDays, preferredTime, preferredDays, languageFocus, difficultyLevel, isActive, now);

            UpdatePlanResponse response = new UpdatePlanResponse(true, "更新复习计划成功", updatedPlanData);

            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("更新复习计划过程中发生错误: " + e.getMessage());
            e.printStackTrace(); // 打印详细堆栈信息
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdatePlanResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    /**
     * 模拟获取最新复习计划和进度数据的方法。
     * 实际上，这部分逻辑可能会被单独的 'ReviewGetPlanRequestHandler' 调用。
     * 这里为了 complete the UpdatePlanResponse，将相关逻辑合并。
     * @param userId 当前用户ID
     * @param dailyTargetWords 每日目标单词数
     * @param weeklyTargetDays 每周目标天数
     * @param preferredTime 偏好时间
     * @param preferredDays 偏好日期列表
     * @param languageFocus 语言焦点
     * @param difficultyLevel 难度级别
     * @param isActive 是否激活
     * @param now 当前时间，用于生成 updated_at 和计算进度
     * @return 构建好的 ReviewPlanData 对象
     */
    private ReviewPlanData getUpdatedPlanData(int userId,
                                              int dailyTargetWords, int weeklyTargetDays,
                                              String preferredTime, List<String> preferredDays,
                                              String languageFocus, String difficultyLevel,
                                              boolean isActive, LocalDateTime now) {

        // --- 获取统计数据 ---
        String today = now.toLocalDate().toString();

        // 获取今日已完成复习单词数
        String todayReviewsSql = "SELECT COALESCE(SUM(total_words), 0) as today_words FROM review_sessions WHERE user_id = ? AND DATE(completed_at) = ?";
        Integer todayCompleted = jdbcTemplate.queryForObject(todayReviewsSql, Integer.class, userId, today);
        if (todayCompleted == null) todayCompleted = 0; // 确保不为null

        // 获取本周已完成复习单词数
        // 计算本周的开始日期（假设周一为一周的开始）
        LocalDate weekStartDate = now.toLocalDate().minusDays(now.getDayOfWeek().getValue() - 1);
        String weekStartStr = weekStartDate.toString();

        String weekReviewsSql = "SELECT COALESCE(SUM(total_words), 0) as week_words FROM review_sessions WHERE user_id = ? AND DATE(completed_at) BETWEEN ? AND ?";
        Integer weekCompleted = jdbcTemplate.queryForObject(weekReviewsSql, Integer.class, userId, weekStartStr, today);
        if (weekCompleted == null) weekCompleted = 0; // 确保不为null

        // 获取连续学习天数 (调用内部方法)
        int streakDays = calculateStreakDays(userId, now.toLocalDate());

        // 获取总复习单词数和平均准确率
        String totalStatsSql = "SELECT COALESCE(SUM(total_words), 0) as total_words, COALESCE(AVG(accuracy), 0) as avg_accuracy FROM review_sessions WHERE user_id = ?";
        Map<String, Object> totalStats = jdbcTemplate.queryForMap(totalStatsSql, userId);

        int totalWordsReviewed = 0;
        double averageAccuracy = 0.0;
        if (totalStats != null) {
            totalWordsReviewed = ((Number) totalStats.get("total_words")).intValue();
            // SQLite 的 AVG 返回 Double，其他数据库可能不同，需要类型转换
            Object avgObj = totalStats.get("avg_accuracy");
            if (avgObj != null) {
                averageAccuracy = ((Number) avgObj).doubleValue();
            }
        }

        // --- 计算百分比 ---
        double todayPercentage = (dailyTargetWords > 0) ? ((double) todayCompleted / dailyTargetWords * 100) : 0;
        // 本周目标总单词数
        int weeklyTargetTotalWords = dailyTargetWords * weeklyTargetDays;
        double weekPercentage = (weeklyTargetTotalWords > 0) ? ((double) weekCompleted / weeklyTargetTotalWords * 100) : 0;

        // 格式化百分比，保留两位小数
        todayPercentage = Math.round(todayPercentage * 100.0) / 100.0;
        weekPercentage = Math.round(weekPercentage * 100.0) / 100.0;

        // --- 构建进度数据 ---
        PlanProgress progress = new PlanProgress(
                todayCompleted,
                dailyTargetWords,
                todayPercentage,
                weekCompleted,
                weeklyTargetTotalWords,
                weekPercentage,
                streakDays,
                totalWordsReviewed,
                Math.round(averageAccuracy * 100.0) / 100.0 // 格式化平均准确率
        );

        // --- 构建复习计划数据 ---
        // 假设 plan ID 为 "plan_" + userId
        // 假设 description 动态生成
        String description = String.format("每日复习 %d 个单词，每周学习 %d 天。偏好时间 %s，每周目标 %s。",
                dailyTargetWords,
                weeklyTargetDays,
                preferredTime,
                String.join(",", preferredDays));

        return new ReviewPlanData(
                "plan_" + userId,
                String.valueOf(userId),
                "用户自定义复习计划", // 计划名称
                description,
                dailyTargetWords,
                weeklyTargetDays,
                preferredTime,
                preferredDays,
                languageFocus,
                difficultyLevel,
                isActive,
                now.toString(), // Assuming created_at from the DB or a default if new
                now.toString(), // This is the updated_at time
                progress
        );
    }

    /**
     * 计算连续学习天数。
     * @param userId 用户ID
     * @param todayLocalDate 当前日期 (LocalDate)
     * @return 连续学习天数
     */
    private int calculateStreakDays(int userId, LocalDate todayLocalDate) {
        try {
            // 获取用户所有复习会话的日期，去重并排序
            String sql = "SELECT DISTINCT DATE(completed_at) as review_date FROM review_sessions WHERE user_id = ? ORDER BY review_date DESC";
            List<Map<String, Object>> dates = jdbcTemplate.queryForList(sql, userId);

            if (dates.isEmpty()) {
                return 0; // 没有复习记录
            }

            // 检查今天是否复习过
            boolean todayReviewed = false;
            LocalDate lastReviewDate = null;
            for (Map<String, Object> dateRow : dates) {
                // 数据库日期类型可能不同，这里尝试转换为 LocalDate
                Object dateObj = dateRow.get("review_date");
                LocalDate reviewDate = null;
                if (dateObj instanceof LocalDate) {
                    reviewDate = (LocalDate) dateObj;
                } else if (dateObj instanceof java.sql.Date) {
                    reviewDate = ((java.sql.Date) dateObj).toLocalDate();
                } else if (dateObj instanceof LocalDateTime) {
                    reviewDate = ((LocalDateTime) dateObj).toLocalDate();
                } else {
                    // 尝试解析字符串，如果日期格式固定
                    // reviewDate = LocalDate.parse(dateObj.toString());
                }

                if (reviewDate != null) {
                    if (reviewDate.equals(todayLocalDate)) {
                        todayReviewed = true;
                    }
                    // 记录最后一次复习日期
                    if (lastReviewDate == null || reviewDate.isAfter(lastReviewDate)) {
                        lastReviewDate = reviewDate;
                    }
                }
            }

            // 如果今天没有复习，则连续天数为0
            if (!todayReviewed) {
                return 0;
            }

            // 如果今天复习过，开始计算连续天数
            int streak = 1; // 今天算一天
            LocalDate expectedDate = todayLocalDate.minusDays(1); // 期望的昨天日期

            for (Map<String, Object> dateRow : dates) {
                Object dateObj = dateRow.get("review_date");
                LocalDate reviewDate = null;
                if (dateObj instanceof LocalDate) {
                    reviewDate = (LocalDate) dateObj;
                } else if (dateObj instanceof java.sql.Date) {
                    reviewDate = ((java.sql.Date) dateObj).toLocalDate();
                } else if (dateObj instanceof LocalDateTime) {
                    reviewDate = ((LocalDateTime) dateObj).toLocalDate();
                }

                if (reviewDate != null) {
                    if (reviewDate.equals(expectedDate)) {
                        streak++;
                        expectedDate = expectedDate.minusDays(1); // 期望再往前一天
                    } else if (reviewDate.isBefore(expectedDate)) {
                        // 如果找到的日期比期望的日期早，说明中间有断层，停止计算
                        // 但需要找到比 expectedDate 更早但日期有效的记录，更新 expectedDate
                        expectedDate = reviewDate.minusDays(1);
                        // 这里需要一个逻辑来跳过已经检查过的日期，避免重复计算
                        // 实际上，我们只需要检查 dates 中的日期是否连续
                    }
                }
            }
            // 重新梳理逻辑：
            // 1. 确保今天复习了
            // 2. 从昨天的日期开始，往前遍历 dates 列表
            // 3. 如果 dates 中的日期等于 expectedDate，则 streak++，expectedDate--
            // 4. 如果 dates 中的日期早于 expectedDate，说明有断层，停止
            // 5. 如果 dates 中的日期晚于 expectedDate (不可能，因为已排序)，忽略

            streak = 0; // 重置
            LocalDate currentDate = todayLocalDate;
            boolean foundToday = false;
            for(Map<String, Object> dateRow : dates) {
                Object dateObj = dateRow.get("review_date");
                LocalDate reviewDate = null;
                if (dateObj instanceof LocalDate) { reviewDate = (LocalDate) dateObj; }
                else if (dateObj instanceof java.sql.Date) { reviewDate = ((java.sql.Date) dateObj).toLocalDate(); }
                else if (dateObj instanceof LocalDateTime) { reviewDate = ((LocalDateTime) dateObj).toLocalDate(); }

                if (reviewDate != null) {
                    if (reviewDate.equals(currentDate)) {
                        foundToday = true;
                        streak++;
                        currentDate = currentDate.minusDays(1);
                    } else if (reviewDate.isBefore(currentDate)) {
                        // 如果日期是早于我们期望的 currentDate，说明中间断开了
                        break;
                    }
                    // 如果 reviewDate == currentDate, 并且streak已经计算过，则继续
                }
            }

            return foundToday ? streak : 0; // 必须今天有复习才算 streak

        } catch (Exception e) {
            System.err.println("计算连续学习天数失败: " + e.getMessage());
            e.printStackTrace();
            return 0;
        }
    }
}
--- 结束文件: ReviewUpdatePlan.java ---

