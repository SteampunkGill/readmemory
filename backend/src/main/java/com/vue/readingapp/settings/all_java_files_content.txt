--- 开始文件: SettingsExport.java ---
package com.vue.readingapp.settings;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.SerializationFeature;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.Date;
import java.text.SimpleDateFormat;

@RestController
@RequestMapping("/api/v1/user/settings/export")
public class SettingsExport {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();

    private void printRequest(Object request) {
        System.out.println("=== 收到导出设置请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=====================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    @GetMapping("")
    public ResponseEntity<?> exportSettings(
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        try {
            printRequest("Authorization: " + authHeader);

            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new HashMap<String, Object>() {{
                            put("success", false);
                            put("message", "未授权访问，请先登录");
                        }}
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 查询会话信息
            String sessionSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ?";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(sessionSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new HashMap<String, Object>() {{
                            put("success", false);
                            put("message", "会话已过期，请重新登录");
                        }}
                );
            }

            Map<String, Object> session = sessions.get(0);
            Integer userId = (Integer) session.get("user_id");
            LocalDateTime expiresAt = (LocalDateTime) session.get("expires_at");

            if (expiresAt.isBefore(LocalDateTime.now())) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new HashMap<String, Object>() {{
                            put("success", false);
                            put("message", "会话已过期，请重新登录");
                        }}
                );
            }

            // 3. 查询用户信息
            String userSql = "SELECT username, email, nickname, avatar_url FROM users WHERE user_id = ?";
            List<Map<String, Object>> users = jdbcTemplate.queryForList(userSql, userId);

            if (users.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new HashMap<String, Object>() {{
                            put("success", false);
                            put("message", "用户不存在");
                        }}
                );
            }

            Map<String, Object> user = users.get(0);

            // 4. 查询所有设置
            String settingsSql = "SELECT setting_type, setting_key, setting_value, created_at, updated_at FROM user_settings WHERE user_id = ?";
            List<Map<String, Object>> settingsList = jdbcTemplate.queryForList(settingsSql, userId);
            printQueryResult(settingsList);

            // 5. 构建导出数据
            Map<String, Object> exportData = new HashMap<>();

            // 添加导出元数据
            exportData.put("export_version", "1.0");
            exportData.put("export_date", new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date()));
            exportData.put("app_name", "Vue Reading App");
            exportData.put("app_version", "1.0.0");

            // 添加用户信息
            exportData.put("user_info", new HashMap<String, Object>() {{
                put("username", user.get("username"));
                put("email", user.get("email"));
                put("nickname", user.get("nickname"));
                put("avatar_url", user.get("avatar_url"));
            }});

            // 按类型分组设置
            Map<String, Map<String, String>> groupedSettings = new HashMap<>();

            for (Map<String, Object> setting : settingsList) {
                String settingType = (String) setting.get("setting_type");
                String key = (String) setting.get("setting_key");
                String value = (String) setting.get("setting_value");

                if (!groupedSettings.containsKey(settingType)) {
                    groupedSettings.put(settingType, new HashMap<>());
                }

                groupedSettings.get(settingType).put(key, value);
            }

            // 添加设置数据
            exportData.put("settings", groupedSettings);

            // 6. 将数据转换为JSON字符串
            objectMapper.enable(SerializationFeature.INDENT_OUTPUT);
            String jsonData = objectMapper.writeValueAsString(exportData);

            // 7. 创建文件名
            String fileName = "settings_export_" + userId + "_" +
                    new SimpleDateFormat("yyyyMMdd_HHmmss").format(new Date()) + ".json";

            // 8. 设置响应头
            return ResponseEntity.ok()
                    .header("Content-Type", "application/json")
                    .header("Content-Disposition", "attachment; filename=\"" + fileName + "\"")
                    .body(jsonData);

        } catch (Exception e) {
            System.err.println("导出设置过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new HashMap<String, Object>() {{
                        put("success", false);
                        put("message", "服务器内部错误: " + e.getMessage());
                    }}
            );
        }
    }
}

--- 结束文件: SettingsExport.java ---

--- 开始文件: SettingsGet.java ---

package com.vue.readingapp.settings;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user/settings")
public class SettingsGet {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取用户设置请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应DTO
    public static class SettingsResponse {
        private boolean success;
        private String message;
        private SettingsData data;

        public SettingsResponse(boolean success, String message, SettingsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public SettingsData getData() { return data; }
        public void setData(SettingsData data) { this.data = data; }
    }

    public static class SettingsData {
        private String language;
        private String theme;
        private int fontSize;
        private String timezone;
        private String dateFormat;
        private String timeFormat;
        private boolean autoSave;
        private int autoSaveInterval;
        private boolean syncEnabled;
        private int syncInterval;
        private int dataRetentionDays;
        private String privacyLevel;
        private String createdAt;
        private String updatedAt;

        // 默认构造函数
        public SettingsData() {
            // 设置默认值
            this.language = "zh-CN";
            this.theme = "light";
            this.fontSize = 14;
            this.timezone = "Asia/Shanghai";
            this.dateFormat = "YYYY-MM-DD";
            this.timeFormat = "24h";
            this.autoSave = true;
            this.autoSaveInterval = 30;
            this.syncEnabled = true;
            this.syncInterval = 5;
            this.dataRetentionDays = 90;
            this.privacyLevel = "standard";
        }

        // Getters and Setters
        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }

        public String getTheme() { return theme; }
        public void setTheme(String theme) { this.theme = theme; }

        public int getFontSize() { return fontSize; }
        public void setFontSize(int fontSize) { this.fontSize = fontSize; }

        public String getTimezone() { return timezone; }
        public void setTimezone(String timezone) { this.timezone = timezone; }

        public String getDateFormat() { return dateFormat; }
        public void setDateFormat(String dateFormat) { this.dateFormat = dateFormat; }

        public String getTimeFormat() { return timeFormat; }
        public void setTimeFormat(String timeFormat) { this.timeFormat = timeFormat; }

        public boolean isAutoSave() { return autoSave; }
        public void setAutoSave(boolean autoSave) { this.autoSave = autoSave; }

        public int getAutoSaveInterval() { return autoSaveInterval; }
        public void setAutoSaveInterval(int autoSaveInterval) { this.autoSaveInterval = autoSaveInterval; }

        public boolean isSyncEnabled() { return syncEnabled; }
        public void setSyncEnabled(boolean syncEnabled) { this.syncEnabled = syncEnabled; }

        public int getSyncInterval() { return syncInterval; }
        public void setSyncInterval(int syncInterval) { this.syncInterval = syncInterval; }

        public int getDataRetentionDays() { return dataRetentionDays; }
        public void setDataRetentionDays(int dataRetentionDays) { this.dataRetentionDays = dataRetentionDays; }

        public String getPrivacyLevel() { return privacyLevel; }
        public void setPrivacyLevel(String privacyLevel) { this.privacyLevel = privacyLevel; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }
    }

    @GetMapping("")
    public ResponseEntity<SettingsResponse> getSettings(@RequestHeader(value = "Authorization", required = false) String authHeader) {
        try {
            // 打印接收到的请求
            printRequest("Authorization: " + authHeader);

            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new SettingsResponse(false, "未授权访问，请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 查询会话信息
            String sessionSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ?";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(sessionSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new SettingsResponse(false, "会话已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            Integer userId = (Integer) session.get("user_id");
            LocalDateTime expiresAt = (LocalDateTime) session.get("expires_at");

            // 检查token是否过期
            if (expiresAt.isBefore(LocalDateTime.now())) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new SettingsResponse(false, "会话已过期，请重新登录", null)
                );
            }

            // 3. 查询用户设置
            String settingsSql = "SELECT setting_key, setting_value, created_at, updated_at FROM user_settings WHERE user_id = ? AND setting_type = 'general'";
            List<Map<String, Object>> settingsList = jdbcTemplate.queryForList(settingsSql, userId);
            printQueryResult(settingsList);

            // 4. 构建响应数据
            SettingsData settingsData = new SettingsData();

            // 如果有设置，覆盖默认值
            for (Map<String, Object> setting : settingsList) {
                String key = (String) setting.get("setting_key");
                String value = (String) setting.get("setting_value");

                switch (key) {
                    case "language":
                        settingsData.setLanguage(value);
                        break;
                    case "theme":
                        settingsData.setTheme(value);
                        break;
                    case "fontSize":
                        try {
                            settingsData.setFontSize(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setFontSize(14);
                        }
                        break;
                    case "timezone":
                        settingsData.setTimezone(value);
                        break;
                    case "dateFormat":
                        settingsData.setDateFormat(value);
                        break;
                    case "timeFormat":
                        settingsData.setTimeFormat(value);
                        break;
                    case "autoSave":
                        settingsData.setAutoSave("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "autoSaveInterval":
                        try {
                            settingsData.setAutoSaveInterval(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setAutoSaveInterval(30);
                        }
                        break;
                    case "syncEnabled":
                        settingsData.setSyncEnabled("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "syncInterval":
                        try {
                            settingsData.setSyncInterval(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setSyncInterval(5);
                        }
                        break;
                    case "dataRetentionDays":
                        try {
                            settingsData.setDataRetentionDays(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setDataRetentionDays(90);
                        }
                        break;
                    case "privacyLevel":
                        settingsData.setPrivacyLevel(value);
                        break;
                }

                // 设置创建和更新时间（取第一条记录的）
                if (settingsData.getCreatedAt() == null && setting.get("created_at") != null) {
                    settingsData.setCreatedAt(setting.get("created_at").toString());
                }
                if (settingsData.getUpdatedAt() == null && setting.get("updated_at") != null) {
                    settingsData.setUpdatedAt(setting.get("updated_at").toString());
                }
            }

            // 5. 准备响应
            SettingsResponse response = new SettingsResponse(true, "获取用户设置成功", settingsData);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取用户设置过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new SettingsResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: SettingsGet.java ---

--- 开始文件: SettingsGetAll.java ---
package com.vue.readingapp.settings;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user/settings/all")
public class SettingsGetAll {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到获取所有设置请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class AllSettingsResponse {
        private boolean success;
        private String message;
        private AllSettingsData data;

        public AllSettingsResponse(boolean success, String message, AllSettingsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public AllSettingsData getData() { return data; }
        public void setData(AllSettingsData data) { this.data = data; }
    }

    public static class AllSettingsData {
        private SettingsGet.SettingsData settings;
        private SettingsGetReading.ReadingSettingsData readingSettings;
        private SettingsGetReview.ReviewSettingsData reviewSettings;
        private SettingsGetNotification.NotificationSettingsData notificationSettings;

        public AllSettingsData() {
            this.settings = new SettingsGet.SettingsData();
            this.readingSettings = new SettingsGetReading.ReadingSettingsData();
            this.reviewSettings = new SettingsGetReview.ReviewSettingsData();
            this.notificationSettings = new SettingsGetNotification.NotificationSettingsData();
        }

        // Getters and Setters
        public SettingsGet.SettingsData getSettings() { return settings; }
        public void setSettings(SettingsGet.SettingsData settings) { this.settings = settings; }

        public SettingsGetReading.ReadingSettingsData getReadingSettings() { return readingSettings; }
        public void setReadingSettings(SettingsGetReading.ReadingSettingsData readingSettings) { this.readingSettings = readingSettings; }

        public SettingsGetReview.ReviewSettingsData getReviewSettings() { return reviewSettings; }
        public void setReviewSettings(SettingsGetReview.ReviewSettingsData reviewSettings) { this.reviewSettings = reviewSettings; }

        public SettingsGetNotification.NotificationSettingsData getNotificationSettings() { return notificationSettings; }
        public void setNotificationSettings(SettingsGetNotification.NotificationSettingsData notificationSettings) { this.notificationSettings = notificationSettings; }
    }

    @GetMapping("")
    public ResponseEntity<AllSettingsResponse> getAllSettings(
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        try {
            printRequest("Authorization: " + authHeader);

            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new AllSettingsResponse(false, "未授权访问，请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 查询会话信息
            String sessionSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ?";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(sessionSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new AllSettingsResponse(false, "会话已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            Integer userId = (Integer) session.get("user_id");
            LocalDateTime expiresAt = (LocalDateTime) session.get("expires_at");

            if (expiresAt.isBefore(LocalDateTime.now())) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new AllSettingsResponse(false, "会话已过期，请重新登录", null)
                );
            }

            // 3. 查询所有设置
            String settingsSql = "SELECT setting_type, setting_key, setting_value, created_at, updated_at FROM user_settings WHERE user_id = ?";
            List<Map<String, Object>> settingsList = jdbcTemplate.queryForList(settingsSql, userId);
            printQueryResult(settingsList);

            // 4. 构建响应数据
            AllSettingsData allSettingsData = new AllSettingsData();

            // 按设置类型分组
            Map<String, List<Map<String, Object>>> groupedSettings = new HashMap<>();

            for (Map<String, Object> setting : settingsList) {
                String settingType = (String) setting.get("setting_type");
                String key = (String) setting.get("setting_key");
                String value = (String) setting.get("setting_value");

                // 根据设置类型处理
                switch (settingType) {
                    case "general":
                        updateGeneralSettings(allSettingsData.getSettings(), key, value);
                        break;
                    case "reading":
                        updateReadingSettings(allSettingsData.getReadingSettings(), key, value);
                        break;
                    case "review":
                        updateReviewSettings(allSettingsData.getReviewSettings(), key, value);
                        break;
                    case "notification":
                        updateNotificationSettings(allSettingsData.getNotificationSettings(), key, value);
                        break;
                }
            }

            // 5. 准备响应
            AllSettingsResponse response = new AllSettingsResponse(true, "获取所有设置成功", allSettingsData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取所有设置过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new AllSettingsResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private void updateGeneralSettings(SettingsGet.SettingsData settings, String key, String value) {
        if (value == null) return;

        switch (key) {
            case "language":
                settings.setLanguage(value);
                break;
            case "theme":
                settings.setTheme(value);
                break;
            case "fontSize":
                try {
                    settings.setFontSize(Integer.parseInt(value));
                } catch (NumberFormatException e) {
                    settings.setFontSize(14);
                }
                break;
            case "timezone":
                settings.setTimezone(value);
                break;
            case "dateFormat":
                settings.setDateFormat(value);
                break;
            case "timeFormat":
                settings.setTimeFormat(value);
                break;
            case "autoSave":
                settings.setAutoSave("true".equalsIgnoreCase(value) || "1".equals(value));
                break;
            case "autoSaveInterval":
                try {
                    settings.setAutoSaveInterval(Integer.parseInt(value));
                } catch (NumberFormatException e) {
                    settings.setAutoSaveInterval(30);
                }
                break;
            case "syncEnabled":
                settings.setSyncEnabled("true".equalsIgnoreCase(value) || "1".equals(value));
                break;
            case "syncInterval":
                try {
                    settings.setSyncInterval(Integer.parseInt(value));
                } catch (NumberFormatException e) {
                    settings.setSyncInterval(5);
                }
                break;
            case "dataRetentionDays":
                try {
                    settings.setDataRetentionDays(Integer.parseInt(value));
                } catch (NumberFormatException e) {
                    settings.setDataRetentionDays(90);
                }
                break;
            case "privacyLevel":
                settings.setPrivacyLevel(value);
                break;
        }
    }

    private void updateReadingSettings(SettingsGetReading.ReadingSettingsData readingSettings, String key, String value) {
        if (value == null) return;

        switch (key) {
            case "fontFamily":
                readingSettings.setFontFamily(value);
                break;
            case "fontSize":
                try {
                    readingSettings.setFontSize(Integer.parseInt(value));
                } catch (NumberFormatException e) {
                    readingSettings.setFontSize(16);
                }
                break;
            case "lineHeight":
                try {
                    readingSettings.setLineHeight(Double.parseDouble(value));
                } catch (NumberFormatException e) {
                    readingSettings.setLineHeight(1.6);
                }
                break;
            case "paragraphSpacing":
                try {
                    readingSettings.setParagraphSpacing(Double.parseDouble(value));
                } catch (NumberFormatException e) {
                    readingSettings.setParagraphSpacing(1.2);
                }
                break;
            case "theme":
                readingSettings.setTheme(value);
                break;
            case "contrast":
                readingSettings.setContrast(value);
                break;
            case "highlightColor":
                readingSettings.setHighlightColor(value);
                break;
            case "noteColor":
                readingSettings.setNoteColor(value);
                break;
            case "autoScroll":
                readingSettings.setAutoScroll("true".equalsIgnoreCase(value) || "1".equals(value));
                break;
            case "scrollSpeed":
                try {
                    readingSettings.setScrollSpeed(Double.parseDouble(value));
                } catch (NumberFormatException e) {
                    readingSettings.setScrollSpeed(1.0);
                }
                break;
            case "showTranslation":
                readingSettings.setShowTranslation("true".equalsIgnoreCase(value) || "1".equals(value));
                break;
            case "translationPosition":
                readingSettings.setTranslationPosition(value);
                break;
            case "showPhonetic":
                readingSettings.setShowPhonetic("true".equalsIgnoreCase(value) || "1".equals(value));
                break;
            case "showDefinition":
                readingSettings.setShowDefinition("true".equalsIgnoreCase(value) || "1".equals(value));
                break;
            case "autoPlayAudio":
                readingSettings.setAutoPlayAudio("true".equalsIgnoreCase(value) || "1".equals(value));
                break;
            case "audioVolume":
                try {
                    readingSettings.setAudioVolume(Double.parseDouble(value));
                } catch (NumberFormatException e) {
                    readingSettings.setAudioVolume(0.7);
                }
                break;
            case "textSelection":
                readingSettings.setTextSelection("true".equalsIgnoreCase(value) || "1".equals(value));
                break;
            case "doubleClickTranslate":
                readingSettings.setDoubleClickTranslate("true".equalsIgnoreCase(value) || "1".equals(value));
                break;
            case "wordBreak":
                readingSettings.setWordBreak(value);
                break;
            case "textAlign":
                readingSettings.setTextAlign(value);
                break;
            case "maxWidth":
                try {
                    readingSettings.setMaxWidth(Integer.parseInt(value));
                } catch (NumberFormatException e) {
                    readingSettings.setMaxWidth(800);
                }
                break;
            case "margin":
                try {
                    readingSettings.setMargin(Integer.parseInt(value));
                } catch (NumberFormatException e) {
                    readingSettings.setMargin(20);
                }
                break;
        }
    }

    private void updateReviewSettings(SettingsGetReview.ReviewSettingsData reviewSettings, String key, String value) {
        if (value == null) return;

        switch (key) {
            case "dailyGoal":
                try {
                    reviewSettings.setDailyGoal(Integer.parseInt(value));
                } catch (NumberFormatException e) {
                    reviewSettings.setDailyGoal(20);
                }
                break;
            case "reviewTime":
                reviewSettings.setReviewTime(value);
                break;
            case "reminderEnabled":
                reviewSettings.setReminderEnabled("true".equalsIgnoreCase(value) || "1".equals(value));
                break;
            case "reminderTime":
                reviewSettings.setReminderTime(value);
                break;
            case "difficultyAlgorithm":
                reviewSettings.setDifficultyAlgorithm(value);
                break;
            case "newWordsPerDay":
                try {
                    reviewSettings.setNewWordsPerDay(Integer.parseInt(value));
                } catch (NumberFormatException e) {
                    reviewSettings.setNewWordsPerDay(10);
                }
                break;
            case "reviewWordsPerDay":
                try {
                    reviewSettings.setReviewWordsPerDay(Integer.parseInt(value));
                } catch (NumberFormatException e) {
                    reviewSettings.setReviewWordsPerDay(50);
                }
                break;
            case "autoGenerateReviews":
                reviewSettings.setAutoGenerateReviews("true".equalsIgnoreCase(value) || "1".equals(value));
                break;
            case "reviewInterval_again":
                try {
                    reviewSettings.getReviewInterval().setAgain(Integer.parseInt(value));
                } catch (NumberFormatException e) {
                    reviewSettings.getReviewInterval().setAgain(1);
                }
                break;
            case "reviewInterval_hard":
                try {
                    reviewSettings.getReviewInterval().setHard(Integer.parseInt(value));
                } catch (NumberFormatException e) {
                    reviewSettings.getReviewInterval().setHard(10);
                }
                break;
            case "reviewInterval_good":
                try {
                    reviewSettings.getReviewInterval().setGood(Integer.parseInt(value));
                } catch (NumberFormatException e) {
                    reviewSettings.getReviewInterval().setGood(1);
                }
                break;
            case "reviewInterval_easy":
                try {
                    reviewSettings.getReviewInterval().setEasy(Integer.parseInt(value));
                } catch (NumberFormatException e) {
                    reviewSettings.getReviewInterval().setEasy(3);
                }
                break;
            case "showExamples":
                reviewSettings.setShowExamples("true".equalsIgnoreCase(value) || "1".equals(value));
                break;
            case "showImages":
                reviewSettings.setShowImages("true".equalsIgnoreCase(value) || "1".equals(value));
                break;
            case "autoPlayAudioInReview":
                reviewSettings.setAutoPlayAudioInReview("true".equalsIgnoreCase(value) || "1".equals(value));
                break;
            case "shuffleQuestions":
                reviewSettings.setShuffleQuestions("true".equalsIgnoreCase(value) || "1".equals(value));
                break;
            case "enableStreak":
                reviewSettings.setEnableStreak("true".equalsIgnoreCase(value) || "1".equals(value));
                break;
            case "streakGoal":
                try {
                    reviewSettings.setStreakGoal(Integer.parseInt(value));
                } catch (NumberFormatException e) {
                    reviewSettings.setStreakGoal(7);
                }
                break;
            case "enableNotifications":
                reviewSettings.setEnableNotifications("true".equalsIgnoreCase(value) || "1".equals(value));
                break;
        }
    }

    private void updateNotificationSettings(SettingsGetNotification.NotificationSettingsData notificationSettings, String key, String value) {
        if (value == null) return;

        String[] parts = key.split("_");
        if (parts.length >= 2) {
            String category = parts[0];
            String subKey = parts[1];

            switch (category) {
                case "email":
                    updateEmailSetting(notificationSettings.getEmailNotifications(), subKey, value);
                    break;
                case "push":
                    updatePushSetting(notificationSettings.getPushNotifications(), subKey, value);
                    break;
                case "inApp":
                    updateInAppSetting(notificationSettings.getInAppNotifications(), subKey, value);
                    break;
                case "quietHours":
                    updateQuietHoursSetting(notificationSettings.getQuietHours(), subKey, value);
                    break;
            }
        }
    }

    private void updateEmailSetting(SettingsGetNotification.EmailNotifications email, String key, String value) {
        boolean boolValue = "true".equalsIgnoreCase(value) || "1".equals(value);

        switch (key) {
            case "enabled":
                email.setEnabled(boolValue);
                break;
            case "dailyDigest":
                email.setDailyDigest(boolValue);
                break;
            case "weeklyReport":
                email.setWeeklyReport(boolValue);
                break;
            case "achievementUnlocked":
                email.setAchievementUnlocked(boolValue);
                break;
            case "reviewReminder":
                email.setReviewReminder(boolValue);
                break;
            case "systemUpdates":
                email.setSystemUpdates(boolValue);
                break;
        }
    }

    private void updatePushSetting(SettingsGetNotification.PushNotifications push, String key, String value) {
        boolean boolValue = "true".equalsIgnoreCase(value) || "1".equals(value);

        switch (key) {
            case "enabled":
                push.setEnabled(boolValue);
                break;
            case "reviewReminder":
                push.setReviewReminder(boolValue);
                break;
            case "dailyGoalReminder":
                push.setDailyGoalReminder(boolValue);
                break;
            case "streakReminder":
                push.setStreakReminder(boolValue);
                break;
            case "newFeature":
                push.setNewFeature(boolValue);
                break;
            case "promotional":
                push.setPromotional(boolValue);
                break;
        }
    }

    private void updateInAppSetting(SettingsGetNotification.InAppNotifications inApp, String key, String value) {
        boolean boolValue = "true".equalsIgnoreCase(value) || "1".equals(value);

        switch (key) {
            case "enabled":
                inApp.setEnabled(boolValue);
                break;
            case "showBadge":
                inApp.setShowBadge(boolValue);
                break;
            case "soundEnabled":
                inApp.setSoundEnabled(boolValue);
                break;
            case "vibrationEnabled":
                inApp.setVibrationEnabled(boolValue);
                break;
        }
    }

    private void updateQuietHoursSetting(SettingsGetNotification.QuietHours quietHours, String key, String value) {
        if (key.equals("enabled")) {
            quietHours.setEnabled("true".equalsIgnoreCase(value) || "1".equals(value));
        } else if (key.equals("startTime")) {
            quietHours.setStartTime(value);
        } else if (key.equals("endTime")) {
            quietHours.setEndTime(value);
        }
    }
}

--- 结束文件: SettingsGetAll.java ---

--- 开始文件: SettingsGetBackup.java ---
package com.vue.readingapp.settings;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user/settings/backup")
public class SettingsGetBackup {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到获取备份设置请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class BackupSettingsResponse {
        private boolean success;
        private String message;
        private BackupSettingsData data;

        public BackupSettingsResponse(boolean success, String message, BackupSettingsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public BackupSettingsData getData() { return data; }
        public void setData(BackupSettingsData data) { this.data = data; }
    }

    public static class BackupSettingsData {
        private boolean autoBackup;
        private String backupFrequency;
        private String backupTime;
        private int backupRetentionDays;
        private boolean backupToCloud;
        private String cloudService;
        private boolean backupEncryption;
        private boolean includeDocuments;
        private boolean includeVocabulary;
        private boolean includeNotes;
        private boolean includeHighlights;
        private String lastBackupDate;
        private String nextBackupDate;

        public BackupSettingsData() {
            // 设置默认值
            this.autoBackup = true;
            this.backupFrequency = "weekly";
            this.backupTime = "02:00";
            this.backupRetentionDays = 30;
            this.backupToCloud = false;
            this.cloudService = "google_drive";
            this.backupEncryption = true;
            this.includeDocuments = true;
            this.includeVocabulary = true;
            this.includeNotes = true;
            this.includeHighlights = true;
            this.lastBackupDate = null;
            this.nextBackupDate = null;
        }

        // Getters and Setters
        public boolean isAutoBackup() { return autoBackup; }
        public void setAutoBackup(boolean autoBackup) { this.autoBackup = autoBackup; }

        public String getBackupFrequency() { return backupFrequency; }
        public void setBackupFrequency(String backupFrequency) { this.backupFrequency = backupFrequency; }

        public String getBackupTime() { return backupTime; }
        public void setBackupTime(String backupTime) { this.backupTime = backupTime; }

        public int getBackupRetentionDays() { return backupRetentionDays; }
        public void setBackupRetentionDays(int backupRetentionDays) { this.backupRetentionDays = backupRetentionDays; }

        public boolean isBackupToCloud() { return backupToCloud; }
        public void setBackupToCloud(boolean backupToCloud) { this.backupToCloud = backupToCloud; }

        public String getCloudService() { return cloudService; }
        public void setCloudService(String cloudService) { this.cloudService = cloudService; }

        public boolean isBackupEncryption() { return backupEncryption; }
        public void setBackupEncryption(boolean backupEncryption) { this.backupEncryption = backupEncryption; }

        public boolean isIncludeDocuments() { return includeDocuments; }
        public void setIncludeDocuments(boolean includeDocuments) { this.includeDocuments = includeDocuments; }

        public boolean isIncludeVocabulary() { return includeVocabulary; }
        public void setIncludeVocabulary(boolean includeVocabulary) { this.includeVocabulary = includeVocabulary; }

        public boolean isIncludeNotes() { return includeNotes; }
        public void setIncludeNotes(boolean includeNotes) { this.includeNotes = includeNotes; }

        public boolean isIncludeHighlights() { return includeHighlights; }
        public void setIncludeHighlights(boolean includeHighlights) { this.includeHighlights = includeHighlights; }

        public String getLastBackupDate() { return lastBackupDate; }
        public void setLastBackupDate(String lastBackupDate) { this.lastBackupDate = lastBackupDate; }

        public String getNextBackupDate() { return nextBackupDate; }
        public void setNextBackupDate(String nextBackupDate) { this.nextBackupDate = nextBackupDate; }
    }

    @GetMapping("")
    public ResponseEntity<BackupSettingsResponse> getBackupSettings(
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        try {
            printRequest("Authorization: " + authHeader);

            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new BackupSettingsResponse(false, "未授权访问，请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 查询会话信息
            String sessionSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ?";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(sessionSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new BackupSettingsResponse(false, "会话已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            Integer userId = (Integer) session.get("user_id");
            LocalDateTime expiresAt = (LocalDateTime) session.get("expires_at");

            if (expiresAt.isBefore(LocalDateTime.now())) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new BackupSettingsResponse(false, "会话已过期，请重新登录", null)
                );
            }

            // 3. 查询备份设置
            String settingsSql = "SELECT setting_key, setting_value, created_at, updated_at FROM user_settings WHERE user_id = ? AND setting_type = 'backup'";
            List<Map<String, Object>> settingsList = jdbcTemplate.queryForList(settingsSql, userId);
            printQueryResult(settingsList);

            // 4. 构建响应数据
            BackupSettingsData settingsData = new BackupSettingsData();

            for (Map<String, Object> setting : settingsList) {
                String key = (String) setting.get("setting_key");
                String value = (String) setting.get("setting_value");

                switch (key) {
                    case "autoBackup":
                        settingsData.setAutoBackup("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "backupFrequency":
                        settingsData.setBackupFrequency(value);
                        break;
                    case "backupTime":
                        settingsData.setBackupTime(value);
                        break;
                    case "backupRetentionDays":
                        try {
                            settingsData.setBackupRetentionDays(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setBackupRetentionDays(30);
                        }
                        break;
                    case "backupToCloud":
                        settingsData.setBackupToCloud("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "cloudService":
                        settingsData.setCloudService(value);
                        break;
                    case "backupEncryption":
                        settingsData.setBackupEncryption("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "includeDocuments":
                        settingsData.setIncludeDocuments("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "includeVocabulary":
                        settingsData.setIncludeVocabulary("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "includeNotes":
                        settingsData.setIncludeNotes("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "includeHighlights":
                        settingsData.setIncludeHighlights("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "lastBackupDate":
                        settingsData.setLastBackupDate(value);
                        break;
                    case "nextBackupDate":
                        settingsData.setNextBackupDate(value);
                        break;
                }
            }

            // 5. 准备响应
            BackupSettingsResponse response = new BackupSettingsResponse(true, "获取备份设置成功", settingsData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取备份设置过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new BackupSettingsResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: SettingsGetBackup.java ---

--- 开始文件: SettingsGetFont.java ---
package com.vue.readingapp.settings;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user/settings/font")
public class SettingsGetFont {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到获取字体设置请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class FontSettingsResponse {
        private boolean success;
        private String message;
        private FontSettingsData data;

        public FontSettingsResponse(boolean success, String message, FontSettingsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public FontSettingsData getData() { return data; }
        public void setData(FontSettingsData data) { this.data = data; }
    }

    public static class FontSettingsData {
        private String fontFamily;
        private int fontSize;
        private double lineHeight;
        private double letterSpacing;
        private String fontWeight;
        private String fontStyle;
        private boolean useCustomFont;
        private String customFontUrl;
        private String fontDisplay;
        private boolean optimizeForReadability;

        public FontSettingsData() {
            // 设置默认值
            this.fontFamily = "system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif";
            this.fontSize = 16;
            this.lineHeight = 1.6;
            this.letterSpacing = 0;
            this.fontWeight = "normal";
            this.fontStyle = "normal";
            this.useCustomFont = false;
            this.customFontUrl = "";
            this.fontDisplay = "swap";
            this.optimizeForReadability = true;
        }

        // Getters and Setters
        public String getFontFamily() { return fontFamily; }
        public void setFontFamily(String fontFamily) { this.fontFamily = fontFamily; }

        public int getFontSize() { return fontSize; }
        public void setFontSize(int fontSize) { this.fontSize = fontSize; }

        public double getLineHeight() { return lineHeight; }
        public void setLineHeight(double lineHeight) { this.lineHeight = lineHeight; }

        public double getLetterSpacing() { return letterSpacing; }
        public void setLetterSpacing(double letterSpacing) { this.letterSpacing = letterSpacing; }

        public String getFontWeight() { return fontWeight; }
        public void setFontWeight(String fontWeight) { this.fontWeight = fontWeight; }

        public String getFontStyle() { return fontStyle; }
        public void setFontStyle(String fontStyle) { this.fontStyle = fontStyle; }

        public boolean isUseCustomFont() { return useCustomFont; }
        public void setUseCustomFont(boolean useCustomFont) { this.useCustomFont = useCustomFont; }

        public String getCustomFontUrl() { return customFontUrl; }
        public void setCustomFontUrl(String customFontUrl) { this.customFontUrl = customFontUrl; }

        public String getFontDisplay() { return fontDisplay; }
        public void setFontDisplay(String fontDisplay) { this.fontDisplay = fontDisplay; }

        public boolean isOptimizeForReadability() { return optimizeForReadability; }
        public void setOptimizeForReadability(boolean optimizeForReadability) { this.optimizeForReadability = optimizeForReadability; }
    }

    @GetMapping("")
    public ResponseEntity<FontSettingsResponse> getFontSettings(
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        try {
            printRequest("Authorization: " + authHeader);

            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new FontSettingsResponse(false, "未授权访问，请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 查询会话信息
            String sessionSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ?";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(sessionSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new FontSettingsResponse(false, "会话已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            Integer userId = (Integer) session.get("user_id");
            LocalDateTime expiresAt = (LocalDateTime) session.get("expires_at");

            if (expiresAt.isBefore(LocalDateTime.now())) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new FontSettingsResponse(false, "会话已过期，请重新登录", null)
                );
            }

            // 3. 查询字体设置
            String settingsSql = "SELECT setting_key, setting_value, created_at, updated_at FROM user_settings WHERE user_id = ? AND setting_type = 'font'";
            List<Map<String, Object>> settingsList = jdbcTemplate.queryForList(settingsSql, userId);
            printQueryResult(settingsList);

            // 4. 构建响应数据
            FontSettingsData settingsData = new FontSettingsData();

            for (Map<String, Object> setting : settingsList) {
                String key = (String) setting.get("setting_key");
                String value = (String) setting.get("setting_value");

                switch (key) {
                    case "fontFamily":
                        settingsData.setFontFamily(value);
                        break;
                    case "fontSize":
                        try {
                            settingsData.setFontSize(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setFontSize(16);
                        }
                        break;
                    case "lineHeight":
                        try {
                            settingsData.setLineHeight(Double.parseDouble(value));
                        } catch (NumberFormatException e) {
                            settingsData.setLineHeight(1.6);
                        }
                        break;
                    case "letterSpacing":
                        try {
                            settingsData.setLetterSpacing(Double.parseDouble(value));
                        } catch (NumberFormatException e) {
                            settingsData.setLetterSpacing(0);
                        }
                        break;
                    case "fontWeight":
                        settingsData.setFontWeight(value);
                        break;
                    case "fontStyle":
                        settingsData.setFontStyle(value);
                        break;
                    case "useCustomFont":
                        settingsData.setUseCustomFont("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "customFontUrl":
                        settingsData.setCustomFontUrl(value);
                        break;
                    case "fontDisplay":
                        settingsData.setFontDisplay(value);
                        break;
                    case "optimizeForReadability":
                        settingsData.setOptimizeForReadability("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                }
            }

            // 5. 准备响应
            FontSettingsResponse response = new FontSettingsResponse(true, "获取字体设置成功", settingsData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取字体设置过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new FontSettingsResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: SettingsGetFont.java ---

--- 开始文件: SettingsGetLanguage.java ---
package com.vue.readingapp.settings;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user/settings/language")
public class SettingsGetLanguage {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到获取语言设置请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class LanguageSettingsResponse {
        private boolean success;
        private String message;
        private LanguageSettingsData data;

        public LanguageSettingsResponse(boolean success, String message, LanguageSettingsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public LanguageSettingsData getData() { return data; }
        public void setData(LanguageSettingsData data) { this.data = data; }
    }

    public static class LanguageSettingsData {
        private String language;
        private String defaultDictionary;
        private boolean autoDetectLanguage;
        private boolean showPhonetic;
        private boolean showDefinition;
        private boolean showExamples;
        private String translationEngine;
        private boolean autoPlayAudio;
        private String audioVoice;
        private double audioSpeed;

        public LanguageSettingsData() {
            // 设置默认值
            this.language = "zh-CN";
            this.defaultDictionary = "en-zh";
            this.autoDetectLanguage = true;
            this.showPhonetic = true;
            this.showDefinition = true;
            this.showExamples = true;
            this.translationEngine = "google";
            this.autoPlayAudio = false;
            this.audioVoice = "en-US-Wavenet-A";
            this.audioSpeed = 1.0;
        }

        // Getters and Setters
        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }

        public String getDefaultDictionary() { return defaultDictionary; }
        public void setDefaultDictionary(String defaultDictionary) { this.defaultDictionary = defaultDictionary; }

        public boolean isAutoDetectLanguage() { return autoDetectLanguage; }
        public void setAutoDetectLanguage(boolean autoDetectLanguage) { this.autoDetectLanguage = autoDetectLanguage; }

        public boolean isShowPhonetic() { return showPhonetic; }
        public void setShowPhonetic(boolean showPhonetic) { this.showPhonetic = showPhonetic; }

        public boolean isShowDefinition() { return showDefinition; }
        public void setShowDefinition(boolean showDefinition) { this.showDefinition = showDefinition; }

        public boolean isShowExamples() { return showExamples; }
        public void setShowExamples(boolean showExamples) { this.showExamples = showExamples; }

        public String getTranslationEngine() { return translationEngine; }
        public void setTranslationEngine(String translationEngine) { this.translationEngine = translationEngine; }

        public boolean isAutoPlayAudio() { return autoPlayAudio; }
        public void setAutoPlayAudio(boolean autoPlayAudio) { this.autoPlayAudio = autoPlayAudio; }

        public String getAudioVoice() { return audioVoice; }
        public void setAudioVoice(String audioVoice) { this.audioVoice = audioVoice; }

        public double getAudioSpeed() { return audioSpeed; }
        public void setAudioSpeed(double audioSpeed) { this.audioSpeed = audioSpeed; }
    }

    @GetMapping("")
    public ResponseEntity<LanguageSettingsResponse> getLanguageSettings(
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        try {
            printRequest("Authorization: " + authHeader);

            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new LanguageSettingsResponse(false, "未授权访问，请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 查询会话信息
            String sessionSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ?";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(sessionSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new LanguageSettingsResponse(false, "会话已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            Integer userId = (Integer) session.get("user_id");
            LocalDateTime expiresAt = (LocalDateTime) session.get("expires_at");

            if (expiresAt.isBefore(LocalDateTime.now())) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new LanguageSettingsResponse(false, "会话已过期，请重新登录", null)
                );
            }

            // 3. 查询语言设置
            String settingsSql = "SELECT setting_key, setting_value, created_at, updated_at FROM user_settings WHERE user_id = ? AND setting_type = 'language'";
            List<Map<String, Object>> settingsList = jdbcTemplate.queryForList(settingsSql, userId);
            printQueryResult(settingsList);

            // 4. 构建响应数据
            LanguageSettingsData settingsData = new LanguageSettingsData();

            for (Map<String, Object> setting : settingsList) {
                String key = (String) setting.get("setting_key");
                String value = (String) setting.get("setting_value");

                switch (key) {
                    case "language":
                        settingsData.setLanguage(value);
                        break;
                    case "defaultDictionary":
                        settingsData.setDefaultDictionary(value);
                        break;
                    case "autoDetectLanguage":
                        settingsData.setAutoDetectLanguage("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "showPhonetic":
                        settingsData.setShowPhonetic("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "showDefinition":
                        settingsData.setShowDefinition("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "showExamples":
                        settingsData.setShowExamples("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "translationEngine":
                        settingsData.setTranslationEngine(value);
                        break;
                    case "autoPlayAudio":
                        settingsData.setAutoPlayAudio("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "audioVoice":
                        settingsData.setAudioVoice(value);
                        break;
                    case "audioSpeed":
                        try {
                            settingsData.setAudioSpeed(Double.parseDouble(value));
                        } catch (NumberFormatException e) {
                            settingsData.setAudioSpeed(1.0);
                        }
                        break;
                }
            }

            // 5. 准备响应
            LanguageSettingsResponse response = new LanguageSettingsResponse(true, "获取语言设置成功", settingsData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取语言设置过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new LanguageSettingsResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: SettingsGetLanguage.java ---

--- 开始文件: SettingsGetNotification.java ---
package com.vue.readingapp.settings;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user/settings/notifications")
public class SettingsGetNotification {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到获取通知设置请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class NotificationSettingsResponse {
        private boolean success;
        private String message;
        private NotificationSettingsData data;

        public NotificationSettingsResponse(boolean success, String message, NotificationSettingsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public NotificationSettingsData getData() { return data; }
        public void setData(NotificationSettingsData data) { this.data = data; }
    }

    public static class NotificationSettingsData {
        private EmailNotifications emailNotifications;
        private PushNotifications pushNotifications;
        private InAppNotifications inAppNotifications;
        private QuietHours quietHours;

        public NotificationSettingsData() {
            // 设置默认值
            this.emailNotifications = new EmailNotifications();
            this.pushNotifications = new PushNotifications();
            this.inAppNotifications = new InAppNotifications();
            this.quietHours = new QuietHours();
        }

        // Getters and Setters
        public EmailNotifications getEmailNotifications() { return emailNotifications; }
        public void setEmailNotifications(EmailNotifications emailNotifications) { this.emailNotifications = emailNotifications; }

        public PushNotifications getPushNotifications() { return pushNotifications; }
        public void setPushNotifications(PushNotifications pushNotifications) { this.pushNotifications = pushNotifications; }

        public InAppNotifications getInAppNotifications() { return inAppNotifications; }
        public void setInAppNotifications(InAppNotifications inAppNotifications) { this.inAppNotifications = inAppNotifications; }

        public QuietHours getQuietHours() { return quietHours; }
        public void setQuietHours(QuietHours quietHours) { this.quietHours = quietHours; }
    }

    public static class EmailNotifications {
        private boolean enabled;
        private boolean dailyDigest;
        private boolean weeklyReport;
        private boolean achievementUnlocked;
        private boolean reviewReminder;
        private boolean systemUpdates;

        public EmailNotifications() {
            this.enabled = true;
            this.dailyDigest = true;
            this.weeklyReport = true;
            this.achievementUnlocked = true;
            this.reviewReminder = true;
            this.systemUpdates = true;
        }

        // Getters and Setters
        public boolean isEnabled() { return enabled; }
        public void setEnabled(boolean enabled) { this.enabled = enabled; }

        public boolean isDailyDigest() { return dailyDigest; }
        public void setDailyDigest(boolean dailyDigest) { this.dailyDigest = dailyDigest; }

        public boolean isWeeklyReport() { return weeklyReport; }
        public void setWeeklyReport(boolean weeklyReport) { this.weeklyReport = weeklyReport; }

        public boolean isAchievementUnlocked() { return achievementUnlocked; }
        public void setAchievementUnlocked(boolean achievementUnlocked) { this.achievementUnlocked = achievementUnlocked; }

        public boolean isReviewReminder() { return reviewReminder; }
        public void setReviewReminder(boolean reviewReminder) { this.reviewReminder = reviewReminder; }

        public boolean isSystemUpdates() { return systemUpdates; }
        public void setSystemUpdates(boolean systemUpdates) { this.systemUpdates = systemUpdates; }
    }

    public static class PushNotifications {
        private boolean enabled;
        private boolean reviewReminder;
        private boolean dailyGoalReminder;
        private boolean streakReminder;
        private boolean newFeature;
        private boolean promotional;

        public PushNotifications() {
            this.enabled = true;
            this.reviewReminder = true;
            this.dailyGoalReminder = true;
            this.streakReminder = true;
            this.newFeature = true;
            this.promotional = false;
        }

        // Getters and Setters
        public boolean isEnabled() { return enabled; }
        public void setEnabled(boolean enabled) { this.enabled = enabled; }

        public boolean isReviewReminder() { return reviewReminder; }
        public void setReviewReminder(boolean reviewReminder) { this.reviewReminder = reviewReminder; }

        public boolean isDailyGoalReminder() { return dailyGoalReminder; }
        public void setDailyGoalReminder(boolean dailyGoalReminder) { this.dailyGoalReminder = dailyGoalReminder; }

        public boolean isStreakReminder() { return streakReminder; }
        public void setStreakReminder(boolean streakReminder) { this.streakReminder = streakReminder; }

        public boolean isNewFeature() { return newFeature; }
        public void setNewFeature(boolean newFeature) { this.newFeature = newFeature; }

        public boolean isPromotional() { return promotional; }
        public void setPromotional(boolean promotional) { this.promotional = promotional; }
    }

    public static class InAppNotifications {
        private boolean enabled;
        private boolean showBadge;
        private boolean soundEnabled;
        private boolean vibrationEnabled;

        public InAppNotifications() {
            this.enabled = true;
            this.showBadge = true;
            this.soundEnabled = true;
            this.vibrationEnabled = true;
        }

        // Getters and Setters
        public boolean isEnabled() { return enabled; }
        public void setEnabled(boolean enabled) { this.enabled = enabled; }

        public boolean isShowBadge() { return showBadge; }
        public void setShowBadge(boolean showBadge) { this.showBadge = showBadge; }

        public boolean isSoundEnabled() { return soundEnabled; }
        public void setSoundEnabled(boolean soundEnabled) { this.soundEnabled = soundEnabled; }

        public boolean isVibrationEnabled() { return vibrationEnabled; }
        public void setVibrationEnabled(boolean vibrationEnabled) { this.vibrationEnabled = vibrationEnabled; }
    }

    public static class QuietHours {
        private boolean enabled;
        private String startTime;
        private String endTime;

        public QuietHours() {
            this.enabled = false;
            this.startTime = "22:00";
            this.endTime = "07:00";
        }

        // Getters and Setters
        public boolean isEnabled() { return enabled; }
        public void setEnabled(boolean enabled) { this.enabled = enabled; }

        public String getStartTime() { return startTime; }
        public void setStartTime(String startTime) { this.startTime = startTime; }

        public String getEndTime() { return endTime; }
        public void setEndTime(String endTime) { this.endTime = endTime; }
    }

    @GetMapping("")
    public ResponseEntity<NotificationSettingsResponse> getNotificationSettings(
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        try {
            printRequest("Authorization: " + authHeader);

            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new NotificationSettingsResponse(false, "未授权访问，请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 查询会话信息
            String sessionSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ?";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(sessionSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new NotificationSettingsResponse(false, "会话已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            Integer userId = (Integer) session.get("user_id");
            LocalDateTime expiresAt = (LocalDateTime) session.get("expires_at");

            if (expiresAt.isBefore(LocalDateTime.now())) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new NotificationSettingsResponse(false, "会话已过期，请重新登录", null)
                );
            }

            // 3. 查询通知设置
            String settingsSql = "SELECT setting_key, setting_value, created_at, updated_at FROM user_settings WHERE user_id = ? AND setting_type = 'notification'";
            List<Map<String, Object>> settingsList = jdbcTemplate.queryForList(settingsSql, userId);
            printQueryResult(settingsList);

            // 4. 构建响应数据
            NotificationSettingsData settingsData = new NotificationSettingsData();

            for (Map<String, Object> setting : settingsList) {
                String key = (String) setting.get("setting_key");
                String value = (String) setting.get("setting_value");

                // 解析设置键，格式如：email_enabled, push_reviewReminder, quietHours_startTime
                String[] parts = key.split("_");
                if (parts.length >= 2) {
                    String category = parts[0];
                    String subKey = parts[1];

                    switch (category) {
                        case "email":
                            updateEmailSetting(settingsData.getEmailNotifications(), subKey, value);
                            break;
                        case "push":
                            updatePushSetting(settingsData.getPushNotifications(), subKey, value);
                            break;
                        case "inApp":
                            updateInAppSetting(settingsData.getInAppNotifications(), subKey, value);
                            break;
                        case "quietHours":
                            updateQuietHoursSetting(settingsData.getQuietHours(), subKey, value);
                            break;
                    }
                }
            }

            // 5. 准备响应
            NotificationSettingsResponse response = new NotificationSettingsResponse(true, "获取通知设置成功", settingsData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取通知设置过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new NotificationSettingsResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private void updateEmailSetting(EmailNotifications email, String key, String value) {
        if (value == null) return;

        boolean boolValue = "true".equalsIgnoreCase(value) || "1".equals(value);

        switch (key) {
            case "enabled":
                email.setEnabled(boolValue);
                break;
            case "dailyDigest":
                email.setDailyDigest(boolValue);
                break;
            case "weeklyReport":
                email.setWeeklyReport(boolValue);
                break;
            case "achievementUnlocked":
                email.setAchievementUnlocked(boolValue);
                break;
            case "reviewReminder":
                email.setReviewReminder(boolValue);
                break;
            case "systemUpdates":
                email.setSystemUpdates(boolValue);
                break;
        }
    }

    private void updatePushSetting(PushNotifications push, String key, String value) {
        if (value == null) return;

        boolean boolValue = "true".equalsIgnoreCase(value) || "1".equals(value);

        switch (key) {
            case "enabled":
                push.setEnabled(boolValue);
                break;
            case "reviewReminder":
                push.setReviewReminder(boolValue);
                break;
            case "dailyGoalReminder":
                push.setDailyGoalReminder(boolValue);
                break;
            case "streakReminder":
                push.setStreakReminder(boolValue);
                break;
            case "newFeature":
                push.setNewFeature(boolValue);
                break;
            case "promotional":
                push.setPromotional(boolValue);
                break;
        }
    }

    private void updateInAppSetting(InAppNotifications inApp, String key, String value) {
        if (value == null) return;

        boolean boolValue = "true".equalsIgnoreCase(value) || "1".equals(value);

        switch (key) {
            case "enabled":
                inApp.setEnabled(boolValue);
                break;
            case "showBadge":
                inApp.setShowBadge(boolValue);
                break;
            case "soundEnabled":
                inApp.setSoundEnabled(boolValue);
                break;
            case "vibrationEnabled":
                inApp.setVibrationEnabled(boolValue);
                break;
        }
    }

    private void updateQuietHoursSetting(QuietHours quietHours, String key, String value) {
        if (value == null) return;

        if (key.equals("enabled")) {
            quietHours.setEnabled("true".equalsIgnoreCase(value) || "1".equals(value));
        } else if (key.equals("startTime")) {
            quietHours.setStartTime(value);
        } else if (key.equals("endTime")) {
            quietHours.setEndTime(value);
        }
    }
}

--- 结束文件: SettingsGetNotification.java ---

--- 开始文件: SettingsGetReading.java ---
package com.vue.readingapp.settings;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user/settings/reading")
public class SettingsGetReading {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到获取阅读设置请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class ReadingSettingsResponse {
        private boolean success;
        private String message;
        private ReadingSettingsData data;

        public ReadingSettingsResponse(boolean success, String message, ReadingSettingsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public ReadingSettingsData getData() { return data; }
        public void setData(ReadingSettingsData data) { this.data = data; }
    }

    public static class ReadingSettingsData {
        private String fontFamily;
        private int fontSize;
        private double lineHeight;
        private double paragraphSpacing;
        private String theme;
        private String contrast;
        private String highlightColor;
        private String noteColor;
        private boolean autoScroll;
        private double scrollSpeed;
        private boolean showTranslation;
        private String translationPosition;
        private boolean showPhonetic;
        private boolean showDefinition;
        private boolean autoPlayAudio;
        private double audioVolume;
        private boolean textSelection;
        private boolean doubleClickTranslate;
        private String wordBreak;
        private String textAlign;
        private int maxWidth;
        private int margin;

        public ReadingSettingsData() {
            // 设置默认值
            this.fontFamily = "system-ui";
            this.fontSize = 16;
            this.lineHeight = 1.6;
            this.paragraphSpacing = 1.2;
            this.theme = "light";
            this.contrast = "normal";
            this.highlightColor = "#FFEB3B";
            this.noteColor = "#4CAF50";
            this.autoScroll = false;
            this.scrollSpeed = 1.0;
            this.showTranslation = true;
            this.translationPosition = "inline";
            this.showPhonetic = true;
            this.showDefinition = true;
            this.autoPlayAudio = false;
            this.audioVolume = 0.7;
            this.textSelection = true;
            this.doubleClickTranslate = true;
            this.wordBreak = "normal";
            this.textAlign = "left";
            this.maxWidth = 800;
            this.margin = 20;
        }

        // Getters and Setters
        public String getFontFamily() { return fontFamily; }
        public void setFontFamily(String fontFamily) { this.fontFamily = fontFamily; }

        public int getFontSize() { return fontSize; }
        public void setFontSize(int fontSize) { this.fontSize = fontSize; }

        public double getLineHeight() { return lineHeight; }
        public void setLineHeight(double lineHeight) { this.lineHeight = lineHeight; }

        public double getParagraphSpacing() { return paragraphSpacing; }
        public void setParagraphSpacing(double paragraphSpacing) { this.paragraphSpacing = paragraphSpacing; }

        public String getTheme() { return theme; }
        public void setTheme(String theme) { this.theme = theme; }

        public String getContrast() { return contrast; }
        public void setContrast(String contrast) { this.contrast = contrast; }

        public String getHighlightColor() { return highlightColor; }
        public void setHighlightColor(String highlightColor) { this.highlightColor = highlightColor; }

        public String getNoteColor() { return noteColor; }
        public void setNoteColor(String noteColor) { this.noteColor = noteColor; }

        public boolean isAutoScroll() { return autoScroll; }
        public void setAutoScroll(boolean autoScroll) { this.autoScroll = autoScroll; }

        public double getScrollSpeed() { return scrollSpeed; }
        public void setScrollSpeed(double scrollSpeed) { this.scrollSpeed = scrollSpeed; }

        public boolean isShowTranslation() { return showTranslation; }
        public void setShowTranslation(boolean showTranslation) { this.showTranslation = showTranslation; }

        public String getTranslationPosition() { return translationPosition; }
        public void setTranslationPosition(String translationPosition) { this.translationPosition = translationPosition; }

        public boolean isShowPhonetic() { return showPhonetic; }
        public void setShowPhonetic(boolean showPhonetic) { this.showPhonetic = showPhonetic; }

        public boolean isShowDefinition() { return showDefinition; }
        public void setShowDefinition(boolean showDefinition) { this.showDefinition = showDefinition; }

        public boolean isAutoPlayAudio() { return autoPlayAudio; }
        public void setAutoPlayAudio(boolean autoPlayAudio) { this.autoPlayAudio = autoPlayAudio; }

        public double getAudioVolume() { return audioVolume; }
        public void setAudioVolume(double audioVolume) { this.audioVolume = audioVolume; }

        public boolean isTextSelection() { return textSelection; }
        public void setTextSelection(boolean textSelection) { this.textSelection = textSelection; }

        public boolean isDoubleClickTranslate() { return doubleClickTranslate; }
        public void setDoubleClickTranslate(boolean doubleClickTranslate) { this.doubleClickTranslate = doubleClickTranslate; }

        public String getWordBreak() { return wordBreak; }
        public void setWordBreak(String wordBreak) { this.wordBreak = wordBreak; }

        public String getTextAlign() { return textAlign; }
        public void setTextAlign(String textAlign) { this.textAlign = textAlign; }

        public int getMaxWidth() { return maxWidth; }
        public void setMaxWidth(int maxWidth) { this.maxWidth = maxWidth; }

        public int getMargin() { return margin; }
        public void setMargin(int margin) { this.margin = margin; }
    }

    @GetMapping("")
    public ResponseEntity<ReadingSettingsResponse> getReadingSettings(
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        try {
            printRequest("Authorization: " + authHeader);

            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ReadingSettingsResponse(false, "未授权访问，请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 查询会话信息
            String sessionSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ?";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(sessionSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ReadingSettingsResponse(false, "会话已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            Integer userId = (Integer) session.get("user_id");
            LocalDateTime expiresAt = (LocalDateTime) session.get("expires_at");

            if (expiresAt.isBefore(LocalDateTime.now())) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ReadingSettingsResponse(false, "会话已过期，请重新登录", null)
                );
            }

            // 3. 查询阅读设置
            String settingsSql = "SELECT setting_key, setting_value, created_at, updated_at FROM user_settings WHERE user_id = ? AND setting_type = 'reading'";
            List<Map<String, Object>> settingsList = jdbcTemplate.queryForList(settingsSql, userId);
            printQueryResult(settingsList);

            // 4. 构建响应数据
            ReadingSettingsData settingsData = new ReadingSettingsData();

            for (Map<String, Object> setting : settingsList) {
                String key = (String) setting.get("setting_key");
                String value = (String) setting.get("setting_value");

                switch (key) {
                    case "fontFamily":
                        settingsData.setFontFamily(value);
                        break;
                    case "fontSize":
                        try {
                            settingsData.setFontSize(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setFontSize(16);
                        }
                        break;
                    case "lineHeight":
                        try {
                            settingsData.setLineHeight(Double.parseDouble(value));
                        } catch (NumberFormatException e) {
                            settingsData.setLineHeight(1.6);
                        }
                        break;
                    case "paragraphSpacing":
                        try {
                            settingsData.setParagraphSpacing(Double.parseDouble(value));
                        } catch (NumberFormatException e) {
                            settingsData.setParagraphSpacing(1.2);
                        }
                        break;
                    case "theme":
                        settingsData.setTheme(value);
                        break;
                    case "contrast":
                        settingsData.setContrast(value);
                        break;
                    case "highlightColor":
                        settingsData.setHighlightColor(value);
                        break;
                    case "noteColor":
                        settingsData.setNoteColor(value);
                        break;
                    case "autoScroll":
                        settingsData.setAutoScroll("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "scrollSpeed":
                        try {
                            settingsData.setScrollSpeed(Double.parseDouble(value));
                        } catch (NumberFormatException e) {
                            settingsData.setScrollSpeed(1.0);
                        }
                        break;
                    case "showTranslation":
                        settingsData.setShowTranslation("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "translationPosition":
                        settingsData.setTranslationPosition(value);
                        break;
                    case "showPhonetic":
                        settingsData.setShowPhonetic("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "showDefinition":
                        settingsData.setShowDefinition("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "autoPlayAudio":
                        settingsData.setAutoPlayAudio("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "audioVolume":
                        try {
                            settingsData.setAudioVolume(Double.parseDouble(value));
                        } catch (NumberFormatException e) {
                            settingsData.setAudioVolume(0.7);
                        }
                        break;
                    case "textSelection":
                        settingsData.setTextSelection("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "doubleClickTranslate":
                        settingsData.setDoubleClickTranslate("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "wordBreak":
                        settingsData.setWordBreak(value);
                        break;
                    case "textAlign":
                        settingsData.setTextAlign(value);
                        break;
                    case "maxWidth":
                        try {
                            settingsData.setMaxWidth(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setMaxWidth(800);
                        }
                        break;
                    case "margin":
                        try {
                            settingsData.setMargin(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setMargin(20);
                        }
                        break;
                }
            }

            // 5. 准备响应
            ReadingSettingsResponse response = new ReadingSettingsResponse(true, "获取阅读设置成功", settingsData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取阅读设置过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ReadingSettingsResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: SettingsGetReading.java ---

--- 开始文件: SettingsGetReview.java ---
package com.vue.readingapp.settings;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user/settings/review")
public class SettingsGetReview {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到获取复习设置请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class ReviewSettingsResponse {
        private boolean success;
        private String message;
        private ReviewSettingsData data;

        public ReviewSettingsResponse(boolean success, String message, ReviewSettingsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public ReviewSettingsData getData() { return data; }
        public void setData(ReviewSettingsData data) { this.data = data; }
    }

    public static class ReviewSettingsData {
        private int dailyGoal;
        private String reviewTime;
        private boolean reminderEnabled;
        private String reminderTime;
        private String difficultyAlgorithm;
        private int newWordsPerDay;
        private int reviewWordsPerDay;
        private boolean autoGenerateReviews;
        private ReviewInterval reviewInterval;
        private boolean showExamples;
        private boolean showImages;
        private boolean autoPlayAudioInReview;
        private boolean shuffleQuestions;
        private boolean enableStreak;
        private int streakGoal;
        private boolean enableNotifications;

        public ReviewSettingsData() {
            // 设置默认值
            this.dailyGoal = 20;
            this.reviewTime = "09:00";
            this.reminderEnabled = true;
            this.reminderTime = "20:00";
            this.difficultyAlgorithm = "sm2";
            this.newWordsPerDay = 10;
            this.reviewWordsPerDay = 50;
            this.autoGenerateReviews = true;
            this.reviewInterval = new ReviewInterval(1, 10, 1, 3);
            this.showExamples = true;
            this.showImages = true;
            this.autoPlayAudioInReview = false;
            this.shuffleQuestions = true;
            this.enableStreak = true;
            this.streakGoal = 7;
            this.enableNotifications = true;
        }

        // Getters and Setters
        public int getDailyGoal() { return dailyGoal; }
        public void setDailyGoal(int dailyGoal) { this.dailyGoal = dailyGoal; }

        public String getReviewTime() { return reviewTime; }
        public void setReviewTime(String reviewTime) { this.reviewTime = reviewTime; }

        public boolean isReminderEnabled() { return reminderEnabled; }
        public void setReminderEnabled(boolean reminderEnabled) { this.reminderEnabled = reminderEnabled; }

        public String getReminderTime() { return reminderTime; }
        public void setReminderTime(String reminderTime) { this.reminderTime = reminderTime; }

        public String getDifficultyAlgorithm() { return difficultyAlgorithm; }
        public void setDifficultyAlgorithm(String difficultyAlgorithm) { this.difficultyAlgorithm = difficultyAlgorithm; }

        public int getNewWordsPerDay() { return newWordsPerDay; }
        public void setNewWordsPerDay(int newWordsPerDay) { this.newWordsPerDay = newWordsPerDay; }

        public int getReviewWordsPerDay() { return reviewWordsPerDay; }
        public void setReviewWordsPerDay(int reviewWordsPerDay) { this.reviewWordsPerDay = reviewWordsPerDay; }

        public boolean isAutoGenerateReviews() { return autoGenerateReviews; }
        public void setAutoGenerateReviews(boolean autoGenerateReviews) { this.autoGenerateReviews = autoGenerateReviews; }

        public ReviewInterval getReviewInterval() { return reviewInterval; }
        public void setReviewInterval(ReviewInterval reviewInterval) { this.reviewInterval = reviewInterval; }

        public boolean isShowExamples() { return showExamples; }
        public void setShowExamples(boolean showExamples) { this.showExamples = showExamples; }

        public boolean isShowImages() { return showImages; }
        public void setShowImages(boolean showImages) { this.showImages = showImages; }

        public boolean isAutoPlayAudioInReview() { return autoPlayAudioInReview; }
        public void setAutoPlayAudioInReview(boolean autoPlayAudioInReview) { this.autoPlayAudioInReview = autoPlayAudioInReview; }

        public boolean isShuffleQuestions() { return shuffleQuestions; }
        public void setShuffleQuestions(boolean shuffleQuestions) { this.shuffleQuestions = shuffleQuestions; }

        public boolean isEnableStreak() { return enableStreak; }
        public void setEnableStreak(boolean enableStreak) { this.enableStreak = enableStreak; }

        public int getStreakGoal() { return streakGoal; }
        public void setStreakGoal(int streakGoal) { this.streakGoal = streakGoal; }

        public boolean isEnableNotifications() { return enableNotifications; }
        public void setEnableNotifications(boolean enableNotifications) { this.enableNotifications = enableNotifications; }
    }

    public static class ReviewInterval {
        private int again;
        private int hard;
        private int good;
        private int easy;

        public ReviewInterval() {}

        public ReviewInterval(int again, int hard, int good, int easy) {
            this.again = again;
            this.hard = hard;
            this.good = good;
            this.easy = easy;
        }

        public int getAgain() { return again; }
        public void setAgain(int again) { this.again = again; }

        public int getHard() { return hard; }
        public void setHard(int hard) { this.hard = hard; }

        public int getGood() { return good; }
        public void setGood(int good) { this.good = good; }

        public int getEasy() { return easy; }
        public void setEasy(int easy) { this.easy = easy; }
    }

    @GetMapping("")
    public ResponseEntity<ReviewSettingsResponse> getReviewSettings(
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        try {
            printRequest("Authorization: " + authHeader);

            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ReviewSettingsResponse(false, "未授权访问，请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 查询会话信息
            String sessionSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ?";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(sessionSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ReviewSettingsResponse(false, "会话已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            Integer userId = (Integer) session.get("user_id");
            LocalDateTime expiresAt = (LocalDateTime) session.get("expires_at");

            if (expiresAt.isBefore(LocalDateTime.now())) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ReviewSettingsResponse(false, "会话已过期，请重新登录", null)
                );
            }

            // 3. 查询复习设置
            String settingsSql = "SELECT setting_key, setting_value, created_at, updated_at FROM user_settings WHERE user_id = ? AND setting_type = 'review'";
            List<Map<String, Object>> settingsList = jdbcTemplate.queryForList(settingsSql, userId);
            printQueryResult(settingsList);

            // 4. 构建响应数据
            ReviewSettingsData settingsData = new ReviewSettingsData();
            ReviewInterval interval = new ReviewInterval();

            for (Map<String, Object> setting : settingsList) {
                String key = (String) setting.get("setting_key");
                String value = (String) setting.get("setting_value");

                switch (key) {
                    case "dailyGoal":
                        try {
                            settingsData.setDailyGoal(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setDailyGoal(20);
                        }
                        break;
                    case "reviewTime":
                        settingsData.setReviewTime(value);
                        break;
                    case "reminderEnabled":
                        settingsData.setReminderEnabled("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "reminderTime":
                        settingsData.setReminderTime(value);
                        break;
                    case "difficultyAlgorithm":
                        settingsData.setDifficultyAlgorithm(value);
                        break;
                    case "newWordsPerDay":
                        try {
                            settingsData.setNewWordsPerDay(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setNewWordsPerDay(10);
                        }
                        break;
                    case "reviewWordsPerDay":
                        try {
                            settingsData.setReviewWordsPerDay(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setReviewWordsPerDay(50);
                        }
                        break;
                    case "autoGenerateReviews":
                        settingsData.setAutoGenerateReviews("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "reviewInterval_again":
                        try {
                            interval.setAgain(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            interval.setAgain(1);
                        }
                        break;
                    case "reviewInterval_hard":
                        try {
                            interval.setHard(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            interval.setHard(10);
                        }
                        break;
                    case "reviewInterval_good":
                        try {
                            interval.setGood(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            interval.setGood(1);
                        }
                        break;
                    case "reviewInterval_easy":
                        try {
                            interval.setEasy(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            interval.setEasy(3);
                        }
                        break;
                    case "showExamples":
                        settingsData.setShowExamples("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "showImages":
                        settingsData.setShowImages("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "autoPlayAudioInReview":
                        settingsData.setAutoPlayAudioInReview("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "shuffleQuestions":
                        settingsData.setShuffleQuestions("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "enableStreak":
                        settingsData.setEnableStreak("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "streakGoal":
                        try {
                            settingsData.setStreakGoal(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setStreakGoal(7);
                        }
                        break;
                    case "enableNotifications":
                        settingsData.setEnableNotifications("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                }
            }

            settingsData.setReviewInterval(interval);

            // 5. 准备响应
            ReviewSettingsResponse response = new ReviewSettingsResponse(true, "获取复习设置成功", settingsData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取复习设置过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ReviewSettingsResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: SettingsGetReview.java ---

--- 开始文件: SettingsGetTheme.java ---
package com.vue.readingapp.settings;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user/settings/theme")
public class SettingsGetTheme {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到获取主题设置请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class ThemeSettingsResponse {
        private boolean success;
        private String message;
        private ThemeSettingsData data;

        public ThemeSettingsResponse(boolean success, String message, ThemeSettingsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public ThemeSettingsData getData() { return data; }
        public void setData(ThemeSettingsData data) { this.data = data; }
    }

    public static class ThemeSettingsData {
        private String theme;
        private String primaryColor;
        private String secondaryColor;
        private String backgroundColor;
        private String textColor;
        private String accentColor;
        private boolean darkMode;
        private boolean autoSwitchTheme;
        private String themeSchedule;

        public ThemeSettingsData() {
            // 设置默认值
            this.theme = "light";
            this.primaryColor = "#1976D2";
            this.secondaryColor = "#424242";
            this.backgroundColor = "#FFFFFF";
            this.textColor = "#000000";
            this.accentColor = "#FF4081";
            this.darkMode = false;
            this.autoSwitchTheme = false;
            this.themeSchedule = "sunset";
        }

        // Getters and Setters
        public String getTheme() { return theme; }
        public void setTheme(String theme) { this.theme = theme; }

        public String getPrimaryColor() { return primaryColor; }
        public void setPrimaryColor(String primaryColor) { this.primaryColor = primaryColor; }

        public String getSecondaryColor() { return secondaryColor; }
        public void setSecondaryColor(String secondaryColor) { this.secondaryColor = secondaryColor; }

        public String getBackgroundColor() { return backgroundColor; }
        public void setBackgroundColor(String backgroundColor) { this.backgroundColor = backgroundColor; }

        public String getTextColor() { return textColor; }
        public void setTextColor(String textColor) { this.textColor = textColor; }

        public String getAccentColor() { return accentColor; }
        public void setAccentColor(String accentColor) { this.accentColor = accentColor; }

        public boolean isDarkMode() { return darkMode; }
        public void setDarkMode(boolean darkMode) { this.darkMode = darkMode; }

        public boolean isAutoSwitchTheme() { return autoSwitchTheme; }
        public void setAutoSwitchTheme(boolean autoSwitchTheme) { this.autoSwitchTheme = autoSwitchTheme; }

        public String getThemeSchedule() { return themeSchedule; }
        public void setThemeSchedule(String themeSchedule) { this.themeSchedule = themeSchedule; }
    }

    @GetMapping("")
    public ResponseEntity<ThemeSettingsResponse> getThemeSettings(
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        try {
            printRequest("Authorization: " + authHeader);

            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ThemeSettingsResponse(false, "未授权访问，请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 查询会话信息
            String sessionSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ?";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(sessionSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ThemeSettingsResponse(false, "会话已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            Integer userId = (Integer) session.get("user_id");
            LocalDateTime expiresAt = (LocalDateTime) session.get("expires_at");

            if (expiresAt.isBefore(LocalDateTime.now())) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ThemeSettingsResponse(false, "会话已过期，请重新登录", null)
                );
            }

            // 3. 查询主题设置
            String settingsSql = "SELECT setting_key, setting_value, created_at, updated_at FROM user_settings WHERE user_id = ? AND setting_type = 'theme'";
            List<Map<String, Object>> settingsList = jdbcTemplate.queryForList(settingsSql, userId);
            printQueryResult(settingsList);

            // 4. 构建响应数据
            ThemeSettingsData settingsData = new ThemeSettingsData();

            for (Map<String, Object> setting : settingsList) {
                String key = (String) setting.get("setting_key");
                String value = (String) setting.get("setting_value");

                switch (key) {
                    case "theme":
                        settingsData.setTheme(value);
                        break;
                    case "primaryColor":
                        settingsData.setPrimaryColor(value);
                        break;
                    case "secondaryColor":
                        settingsData.setSecondaryColor(value);
                        break;
                    case "backgroundColor":
                        settingsData.setBackgroundColor(value);
                        break;
                    case "textColor":
                        settingsData.setTextColor(value);
                        break;
                    case "accentColor":
                        settingsData.setAccentColor(value);
                        break;
                    case "darkMode":
                        settingsData.setDarkMode("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "autoSwitchTheme":
                        settingsData.setAutoSwitchTheme("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "themeSchedule":
                        settingsData.setThemeSchedule(value);
                        break;
                }
            }

            // 5. 准备响应
            ThemeSettingsResponse response = new ThemeSettingsResponse(true, "获取主题设置成功", settingsData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取主题设置过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ThemeSettingsResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: SettingsGetTheme.java ---

--- 开始文件: SettingsImport.java ---

package com.vue.readingapp.settings;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.multipart.MultipartFile;
import com.fasterxml.jackson.databind.ObjectMapper;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;
import java.util.Date;
import java.text.SimpleDateFormat;

@RestController
@RequestMapping("/api/v1/user/settings/import")
public class SettingsImport {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private ObjectMapper objectMapper = new ObjectMapper();

    private void printRequest(Object request) {
        System.out.println("=== 收到导入设置请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=====================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class ImportResponse {
        private boolean success;
        private String message;
        private ImportData data;

        public ImportResponse(boolean success, String message, ImportData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public ImportData getData() { return data; }
        public void setData(ImportData data) { this.data = data; }
    }

    public static class ImportData {
        private int importedCount;
        private String importDate;
        private String fileName;
        private String fileSize;

        public ImportData(int importedCount, String importDate, String fileName, String fileSize) {
            this.importedCount = importedCount;
            this.importDate = importDate;
            this.fileName = fileName;
            this.fileSize = fileSize;
        }

        public int getImportedCount() { return importedCount; }
        public void setImportedCount(int importedCount) { this.importedCount = importedCount; }

        public String getImportDate() { return importDate; }
        public void setImportDate(String importDate) { this.importDate = importDate; }

        public String getFileName() { return fileName; }
        public void setFileName(String fileName) { this.fileName = fileName; }

        public String getFileSize() { return fileSize; }
        public void setFileSize(String fileSize) { this.fileSize = fileSize; }
    }

    @PostMapping("")
    public ResponseEntity<ImportResponse> importSettings(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestParam("file") MultipartFile file) {

        try {
            printRequest("文件名: " + file.getOriginalFilename() + ", 大小: " + file.getSize() + " bytes");

            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ImportResponse(false, "未授权访问，请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 查询会话信息
            String sessionSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ?";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(sessionSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ImportResponse(false, "会话已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            Integer userId = (Integer) session.get("user_id");
            LocalDateTime expiresAt = (LocalDateTime) session.get("expires_at");

            if (expiresAt.isBefore(LocalDateTime.now())) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ImportResponse(false, "会话已过期，请重新登录", null)
                );
            }

            // 3. 验证文件
            if (file.isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new ImportResponse(false, "文件为空", null)
                );
            }

            if (file.getSize() > 10 * 1024 * 1024) { // 10MB限制
                return ResponseEntity.badRequest().body(
                        new ImportResponse(false, "文件大小不能超过10MB", null)
                );
            }

            String originalFilename = file.getOriginalFilename();
            if (originalFilename == null || !originalFilename.toLowerCase().endsWith(".json")) {
                return ResponseEntity.badRequest().body(
                        new ImportResponse(false, "只支持JSON格式文件", null)
                );
            }

            // 4. 读取并解析文件内容
            String fileContent = new String(file.getBytes(), "UTF-8");
            Map<String, Object> importData = objectMapper.readValue(fileContent, Map.class);

            // 5. 验证导入数据格式
            if (!importData.containsKey("settings")) {
                return ResponseEntity.badRequest().body(
                        new ImportResponse(false, "导入文件格式不正确，缺少settings字段", null)
                );
            }

            // 6. 开始导入设置
            LocalDateTime now = LocalDateTime.now();
            int importedCount = 0;

            Map<String, Map<String, String>> settingsMap = (Map<String, Map<String, String>>) importData.get("settings");

            // 遍历每种设置类型
            for (Map.Entry<String, Map<String, String>> entry : settingsMap.entrySet()) {
                String settingType = entry.getKey();
                Map<String, String> settings = entry.getValue();

                // 删除该类型下的所有现有设置
                String deleteSql = "DELETE FROM user_settings WHERE user_id = ? AND setting_type = ?";
                jdbcTemplate.update(deleteSql, userId, settingType);

                // 插入新的设置
                for (Map.Entry<String, String> settingEntry : settings.entrySet()) {
                    String key = settingEntry.getKey();
                    String value = settingEntry.getValue();

                    String insertSql = "INSERT INTO user_settings (user_id, setting_type, setting_key, setting_value, created_at, updated_at) VALUES (?, ?, ?, ?, ?, ?)";
                    jdbcTemplate.update(insertSql, userId, settingType, key, value, now, now);
                    importedCount++;
                }
            }

            // 7. 记录导入历史
            String insertHistorySql = "INSERT INTO import_history (user_id, file_name, file_size, imported_count, import_date) VALUES (?, ?, ?, ?, ?)";
            jdbcTemplate.update(insertHistorySql, userId, originalFilename, file.getSize(), importedCount, now);

            // 8. 构建响应数据
            ImportData importResult = new ImportData(
                    importedCount,
                    new SimpleDateFormat("yyyy-MM-dd HH:mm:ss").format(new Date()),
                    originalFilename,
                    formatFileSize(file.getSize())
            );

            ImportResponse response = new ImportResponse(true, "设置导入成功", importResult);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("导入设置过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ImportResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private String formatFileSize(long size) {
        if (size < 1024) {
            return size + " B";
        } else if (size < 1024 * 1024) {
            return String.format("%.2f KB", size / 1024.0);
        } else {
            return String.format("%.2f MB", size / (1024.0 * 1024.0));
        }
    }
}
--- 结束文件: SettingsImport.java ---

--- 开始文件: SettingsResetToDefault.java ---
package com.vue.readingapp.settings;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user/settings")
public class SettingsResetToDefault {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到重置设置请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=====================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class ResetResponse {
        private boolean success;
        private String message;
        private ResetData data;

        public ResetResponse(boolean success, String message, ResetData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public ResetData getData() { return data; }
        public void setData(ResetData data) { this.data = data; }
    }

    public static class ResetData {
        private boolean reset;

        public ResetData(boolean reset) {
            this.reset = reset;
        }

        public boolean isReset() { return reset; }
        public void setReset(boolean reset) { this.reset = reset; }
    }

    @DeleteMapping("")
    public ResponseEntity<ResetResponse> resetSettingsToDefault(
            @RequestHeader(value = "Authorization", required = false) String authHeader) {

        try {
            printRequest("Authorization: " + authHeader);

            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ResetResponse(false, "未授权访问，请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 查询会话信息
            String sessionSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ?";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(sessionSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ResetResponse(false, "会话已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            Integer userId = (Integer) session.get("user_id");
            LocalDateTime expiresAt = (LocalDateTime) session.get("expires_at");

            if (expiresAt.isBefore(LocalDateTime.now())) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new ResetResponse(false, "会话已过期，请重新登录", null)
                );
            }

            // 3. 删除用户的所有设置
            String deleteSql = "DELETE FROM user_settings WHERE user_id = ?";
            int deletedRows = jdbcTemplate.update(deleteSql, userId);
            printQueryResult("删除了 " + deletedRows + " 条设置记录");

            // 4. 准备响应
            ResetData resetData = new ResetData(true);
            ResetResponse response = new ResetResponse(true, "所有设置已重置为默认值", resetData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("重置设置过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new ResetResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}

--- 结束文件: SettingsResetToDefault.java ---

--- 开始文件: SettingsUpdate.java ---
package com.vue.readingapp.settings;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user/settings")
public class SettingsUpdate {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到更新用户设置请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class UpdateRequest {
        private String language;
        private String theme;
        private Integer fontSize;
        private String timezone;
        private String dateFormat;
        private String timeFormat;
        private Boolean autoSave;
        private Integer autoSaveInterval;
        private Boolean syncEnabled;
        private Integer syncInterval;
        private Integer dataRetentionDays;
        private String privacyLevel;

        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }

        public String getTheme() { return theme; }
        public void setTheme(String theme) { this.theme = theme; }

        public Integer getFontSize() { return fontSize; }
        public void setFontSize(Integer fontSize) { this.fontSize = fontSize; }

        public String getTimezone() { return timezone; }
        public void setTimezone(String timezone) { this.timezone = timezone; }

        public String getDateFormat() { return dateFormat; }
        public void setDateFormat(String dateFormat) { this.dateFormat = dateFormat; }

        public String getTimeFormat() { return timeFormat; }
        public void setTimeFormat(String timeFormat) { this.timeFormat = timeFormat; }

        public Boolean getAutoSave() { return autoSave; }
        public void setAutoSave(Boolean autoSave) { this.autoSave = autoSave; }

        public Integer getAutoSaveInterval() { return autoSaveInterval; }
        public void setAutoSaveInterval(Integer autoSaveInterval) { this.autoSaveInterval = autoSaveInterval; }

        public Boolean getSyncEnabled() { return syncEnabled; }
        public void setSyncEnabled(Boolean syncEnabled) { this.syncEnabled = syncEnabled; }

        public Integer getSyncInterval() { return syncInterval; }
        public void setSyncInterval(Integer syncInterval) { this.syncInterval = syncInterval; }

        public Integer getDataRetentionDays() { return dataRetentionDays; }
        public void setDataRetentionDays(Integer dataRetentionDays) { this.dataRetentionDays = dataRetentionDays; }

        public String getPrivacyLevel() { return privacyLevel; }
        public void setPrivacyLevel(String privacyLevel) { this.privacyLevel = privacyLevel; }
    }

    public static class UpdateResponse {
        private boolean success;
        private String message;
        private SettingsGet.SettingsData data;

        public UpdateResponse(boolean success, String message, SettingsGet.SettingsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public SettingsGet.SettingsData getData() { return data; }
        public void setData(SettingsGet.SettingsData data) { this.data = data; }
    }

    @PutMapping("")
    public ResponseEntity<UpdateResponse> updateSettings(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestBody UpdateRequest request) {

        try {
            printRequest(request);

            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateResponse(false, "未授权访问，请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 查询会话信息
            String sessionSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ?";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(sessionSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateResponse(false, "会话已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            Integer userId = (Integer) session.get("user_id");
            LocalDateTime expiresAt = (LocalDateTime) session.get("expires_at");

            if (expiresAt.isBefore(LocalDateTime.now())) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateResponse(false, "会话已过期，请重新登录", null)
                );
            }

            // 3. 验证设置数据
            if (request.getTheme() != null && !isValidTheme(request.getTheme())) {
                return ResponseEntity.badRequest().body(
                        new UpdateResponse(false, "无效的主题设置", null)
                );
            }

            if (request.getTimeFormat() != null && !isValidTimeFormat(request.getTimeFormat())) {
                return ResponseEntity.badRequest().body(
                        new UpdateResponse(false, "无效的时间格式", null)
                );
            }

            if (request.getPrivacyLevel() != null && !isValidPrivacyLevel(request.getPrivacyLevel())) {
                return ResponseEntity.badRequest().body(
                        new UpdateResponse(false, "无效的隐私级别", null)
                );
            }

            if (request.getFontSize() != null && (request.getFontSize() < 8 || request.getFontSize() > 32)) {
                return ResponseEntity.badRequest().body(
                        new UpdateResponse(false, "字体大小必须在8-32之间", null)
                );
            }

            // 4. 更新设置
            LocalDateTime now = LocalDateTime.now();

            // 检查并更新每个设置项
            updateSetting(userId, "language", request.getLanguage(), now);
            updateSetting(userId, "theme", request.getTheme(), now);
            updateSetting(userId, "fontSize", request.getFontSize() != null ? request.getFontSize().toString() : null, now);
            updateSetting(userId, "timezone", request.getTimezone(), now);
            updateSetting(userId, "dateFormat", request.getDateFormat(), now);
            updateSetting(userId, "timeFormat", request.getTimeFormat(), now);
            updateSetting(userId, "autoSave", request.getAutoSave() != null ? request.getAutoSave().toString() : null, now);
            updateSetting(userId, "autoSaveInterval", request.getAutoSaveInterval() != null ? request.getAutoSaveInterval().toString() : null, now);
            updateSetting(userId, "syncEnabled", request.getSyncEnabled() != null ? request.getSyncEnabled().toString() : null, now);
            updateSetting(userId, "syncInterval", request.getSyncInterval() != null ? request.getSyncInterval().toString() : null, now);
            updateSetting(userId, "dataRetentionDays", request.getDataRetentionDays() != null ? request.getDataRetentionDays().toString() : null, now);
            updateSetting(userId, "privacyLevel", request.getPrivacyLevel(), now);

            // 5. 查询更新后的设置
            String settingsSql = "SELECT setting_key, setting_value, created_at, updated_at FROM user_settings WHERE user_id = ? AND setting_type = 'general'";
            List<Map<String, Object>> settingsList = jdbcTemplate.queryForList(settingsSql, userId);
            printQueryResult(settingsList);

            // 6. 构建响应数据
            SettingsGet.SettingsData settingsData = new SettingsGet.SettingsData();

            for (Map<String, Object> setting : settingsList) {
                String key = (String) setting.get("setting_key");
                String value = (String) setting.get("setting_value");

                switch (key) {
                    case "language":
                        settingsData.setLanguage(value);
                        break;
                    case "theme":
                        settingsData.setTheme(value);
                        break;
                    case "fontSize":
                        try {
                            settingsData.setFontSize(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setFontSize(14);
                        }
                        break;
                    case "timezone":
                        settingsData.setTimezone(value);
                        break;
                    case "dateFormat":
                        settingsData.setDateFormat(value);
                        break;
                    case "timeFormat":
                        settingsData.setTimeFormat(value);
                        break;
                    case "autoSave":
                        settingsData.setAutoSave("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "autoSaveInterval":
                        try {
                            settingsData.setAutoSaveInterval(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setAutoSaveInterval(30);
                        }
                        break;
                    case "syncEnabled":
                        settingsData.setSyncEnabled("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "syncInterval":
                        try {
                            settingsData.setSyncInterval(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setSyncInterval(5);
                        }
                        break;
                    case "dataRetentionDays":
                        try {
                            settingsData.setDataRetentionDays(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setDataRetentionDays(90);
                        }
                        break;
                    case "privacyLevel":
                        settingsData.setPrivacyLevel(value);
                        break;
                }

                if (settingsData.getCreatedAt() == null && setting.get("created_at") != null) {
                    settingsData.setCreatedAt(setting.get("created_at").toString());
                }
                if (settingsData.getUpdatedAt() == null && setting.get("updated_at") != null) {
                    settingsData.setUpdatedAt(setting.get("updated_at").toString());
                }
            }

            // 7. 准备响应
            UpdateResponse response = new UpdateResponse(true, "用户设置更新成功", settingsData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("更新用户设置过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdateResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private void updateSetting(Integer userId, String key, String value, LocalDateTime now) {
        if (value != null) {
            // 检查设置是否存在
            String checkSql = "SELECT setting_id FROM user_settings WHERE user_id = ? AND setting_type = 'general' AND setting_key = ?";
            List<Map<String, Object>> existing = jdbcTemplate.queryForList(checkSql, userId, key);

            if (existing.isEmpty()) {
                // 插入新设置
                String insertSql = "INSERT INTO user_settings (user_id, setting_type, setting_key, setting_value, created_at, updated_at) VALUES (?, 'general', ?, ?, ?, ?)";
                jdbcTemplate.update(insertSql, userId, key, value, now, now);
            } else {
                // 更新现有设置
                String updateSql = "UPDATE user_settings SET setting_value = ?, updated_at = ? WHERE user_id = ? AND setting_type = 'general' AND setting_key = ?";
                jdbcTemplate.update(updateSql, value, now, userId, key);
            }
        }
    }

    private boolean isValidTheme(String theme) {
        return theme.equals("light") || theme.equals("dark") || theme.equals("auto");
    }

    private boolean isValidTimeFormat(String timeFormat) {
        return timeFormat.equals("12h") || timeFormat.equals("24h");
    }

    private boolean isValidPrivacyLevel(String privacyLevel) {
        return privacyLevel.equals("minimal") || privacyLevel.equals("standard") || privacyLevel.equals("strict");
    }
}

--- 结束文件: SettingsUpdate.java ---

--- 开始文件: SettingsUpdateBackup.java ---
package com.vue.readingapp.settings;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user/settings/backup")
public class SettingsUpdateBackup {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到更新备份设置请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class UpdateBackupRequest {
        private Boolean autoBackup;
        private String backupFrequency;
        private String backupTime;
        private Integer backupRetentionDays;
        private Boolean backupToCloud;
        private String cloudService;
        private Boolean backupEncryption;
        private Boolean includeDocuments;
        private Boolean includeVocabulary;
        private Boolean includeNotes;
        private Boolean includeHighlights;

        // Getters and Setters
        public Boolean getAutoBackup() { return autoBackup; }
        public void setAutoBackup(Boolean autoBackup) { this.autoBackup = autoBackup; }

        public String getBackupFrequency() { return backupFrequency; }
        public void setBackupFrequency(String backupFrequency) { this.backupFrequency = backupFrequency; }

        public String getBackupTime() { return backupTime; }
        public void setBackupTime(String backupTime) { this.backupTime = backupTime; }

        public Integer getBackupRetentionDays() { return backupRetentionDays; }
        public void setBackupRetentionDays(Integer backupRetentionDays) { this.backupRetentionDays = backupRetentionDays; }

        public Boolean getBackupToCloud() { return backupToCloud; }
        public void setBackupToCloud(Boolean backupToCloud) { this.backupToCloud = backupToCloud; }

        public String getCloudService() { return cloudService; }
        public void setCloudService(String cloudService) { this.cloudService = cloudService; }

        public Boolean getBackupEncryption() { return backupEncryption; }
        public void setBackupEncryption(Boolean backupEncryption) { this.backupEncryption = backupEncryption; }

        public Boolean getIncludeDocuments() { return includeDocuments; }
        public void setIncludeDocuments(Boolean includeDocuments) { this.includeDocuments = includeDocuments; }

        public Boolean getIncludeVocabulary() { return includeVocabulary; }
        public void setIncludeVocabulary(Boolean includeVocabulary) { this.includeVocabulary = includeVocabulary; }

        public Boolean getIncludeNotes() { return includeNotes; }
        public void setIncludeNotes(Boolean includeNotes) { this.includeNotes = includeNotes; }

        public Boolean getIncludeHighlights() { return includeHighlights; }
        public void setIncludeHighlights(Boolean includeHighlights) { this.includeHighlights = includeHighlights; }
    }

    public static class UpdateBackupResponse {
        private boolean success;
        private String message;
        private SettingsGetBackup.BackupSettingsData data;

        public UpdateBackupResponse(boolean success, String message, SettingsGetBackup.BackupSettingsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public SettingsGetBackup.BackupSettingsData getData() { return data; }
        public void setData(SettingsGetBackup.BackupSettingsData data) { this.data = data; }
    }

    @PutMapping("")
    public ResponseEntity<UpdateBackupResponse> updateBackupSettings(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestBody UpdateBackupRequest request) {

        try {
            printRequest(request);

            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateBackupResponse(false, "未授权访问，请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 查询会话信息
            String sessionSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ?";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(sessionSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateBackupResponse(false, "会话已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            Integer userId = (Integer) session.get("user_id");
            LocalDateTime expiresAt = (LocalDateTime) session.get("expires_at");

            if (expiresAt.isBefore(LocalDateTime.now())) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateBackupResponse(false, "会话已过期，请重新登录", null)
                );
            }

            // 3. 验证备份设置数据
            if (request.getBackupRetentionDays() != null && (request.getBackupRetentionDays() < 1 || request.getBackupRetentionDays() > 365)) {
                return ResponseEntity.badRequest().body(
                        new UpdateBackupResponse(false, "备份保留天数必须在1-365之间", null)
                );
            }

            // 验证备份频率
            if (request.getBackupFrequency() != null && !isValidBackupFrequency(request.getBackupFrequency())) {
                return ResponseEntity.badRequest().body(
                        new UpdateBackupResponse(false, "无效的备份频率", null)
                );
            }

            // 验证云服务
            if (request.getCloudService() != null && !isValidCloudService(request.getCloudService())) {
                return ResponseEntity.badRequest().body(
                        new UpdateBackupResponse(false, "无效的云服务", null)
                );
            }

            // 验证备份时间格式
            if (request.getBackupTime() != null && !isValidTimeFormat(request.getBackupTime())) {
                return ResponseEntity.badRequest().body(
                        new UpdateBackupResponse(false, "无效的备份时间格式", null)
                );
            }

            // 4. 更新备份设置
            LocalDateTime now = LocalDateTime.now();

            updateBackupSetting(userId, "autoBackup", request.getAutoBackup() != null ? request.getAutoBackup().toString() : null, now);
            updateBackupSetting(userId, "backupFrequency", request.getBackupFrequency(), now);
            updateBackupSetting(userId, "backupTime", request.getBackupTime(), now);
            updateBackupSetting(userId, "backupRetentionDays", request.getBackupRetentionDays() != null ? request.getBackupRetentionDays().toString() : null, now);
            updateBackupSetting(userId, "backupToCloud", request.getBackupToCloud() != null ? request.getBackupToCloud().toString() : null, now);
            updateBackupSetting(userId, "cloudService", request.getCloudService(), now);
            updateBackupSetting(userId, "backupEncryption", request.getBackupEncryption() != null ? request.getBackupEncryption().toString() : null, now);
            updateBackupSetting(userId, "includeDocuments", request.getIncludeDocuments() != null ? request.getIncludeDocuments().toString() : null, now);
            updateBackupSetting(userId, "includeVocabulary", request.getIncludeVocabulary() != null ? request.getIncludeVocabulary().toString() : null, now);
            updateBackupSetting(userId, "includeNotes", request.getIncludeNotes() != null ? request.getIncludeNotes().toString() : null, now);
            updateBackupSetting(userId, "includeHighlights", request.getIncludeHighlights() != null ? request.getIncludeHighlights().toString() : null, now);

            // 5. 查询更新后的设置
            String settingsSql = "SELECT setting_key, setting_value, created_at, updated_at FROM user_settings WHERE user_id = ? AND setting_type = 'backup'";
            List<Map<String, Object>> settingsList = jdbcTemplate.queryForList(settingsSql, userId);
            printQueryResult(settingsList);

            // 6. 构建响应数据
            SettingsGetBackup.BackupSettingsData settingsData = new SettingsGetBackup.BackupSettingsData();

            for (Map<String, Object> setting : settingsList) {
                String key = (String) setting.get("setting_key");
                String value = (String) setting.get("setting_value");

                switch (key) {
                    case "autoBackup":
                        settingsData.setAutoBackup("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "backupFrequency":
                        settingsData.setBackupFrequency(value);
                        break;
                    case "backupTime":
                        settingsData.setBackupTime(value);
                        break;
                    case "backupRetentionDays":
                        try {
                            settingsData.setBackupRetentionDays(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setBackupRetentionDays(30);
                        }
                        break;
                    case "backupToCloud":
                        settingsData.setBackupToCloud("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "cloudService":
                        settingsData.setCloudService(value);
                        break;
                    case "backupEncryption":
                        settingsData.setBackupEncryption("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "includeDocuments":
                        settingsData.setIncludeDocuments("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "includeVocabulary":
                        settingsData.setIncludeVocabulary("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "includeNotes":
                        settingsData.setIncludeNotes("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "includeHighlights":
                        settingsData.setIncludeHighlights("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "lastBackupDate":
                        settingsData.setLastBackupDate(value);
                        break;
                    case "nextBackupDate":
                        settingsData.setNextBackupDate(value);
                        break;
                }
            }

            // 7. 准备响应
            UpdateBackupResponse response = new UpdateBackupResponse(true, "备份设置更新成功", settingsData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("更新备份设置过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdateBackupResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private void updateBackupSetting(Integer userId, String key, String value, LocalDateTime now) {
        if (value != null) {
            // 检查设置是否存在
            String checkSql = "SELECT setting_id FROM user_settings WHERE user_id = ? AND setting_type = 'backup' AND setting_key = ?";
            List<Map<String, Object>> existing = jdbcTemplate.queryForList(checkSql, userId, key);

            if (existing.isEmpty()) {
                // 插入新设置
                String insertSql = "INSERT INTO user_settings (user_id, setting_type, setting_key, setting_value, created_at, updated_at) VALUES (?, 'backup', ?, ?, ?, ?)";
                jdbcTemplate.update(insertSql, userId, key, value, now, now);
            } else {
                // 更新现有设置
                String updateSql = "UPDATE user_settings SET setting_value = ?, updated_at = ? WHERE user_id = ? AND setting_type = 'backup' AND setting_key = ?";
                jdbcTemplate.update(updateSql, value, now, userId, key);
            }
        }
    }

    private boolean isValidBackupFrequency(String frequency) {
        return frequency.equals("daily") || frequency.equals("weekly") ||
                frequency.equals("monthly") || frequency.equals("never");
    }

    private boolean isValidCloudService(String service) {
        return service.equals("google_drive") || service.equals("dropbox") ||
                service.equals("onedrive") || service.equals("icloud");
    }

    private boolean isValidTimeFormat(String time) {
        return time.matches("^([01]?[0-9]|2[0-3]):[0-5][0-9]$");
    }
}

--- 结束文件: SettingsUpdateBackup.java ---

--- 开始文件: SettingsUpdateFont.java ---
package com.vue.readingapp.settings;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user/settings/font")
public class SettingsUpdateFont {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到更新字体设置请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class UpdateFontRequest {
        private String fontFamily;
        private Integer fontSize;
        private Double lineHeight;
        private Double letterSpacing;
        private String fontWeight;
        private String fontStyle;
        private Boolean useCustomFont;
        private String customFontUrl;
        private String fontDisplay;
        private Boolean optimizeForReadability;

        // Getters and Setters
        public String getFontFamily() { return fontFamily; }
        public void setFontFamily(String fontFamily) { this.fontFamily = fontFamily; }

        public Integer getFontSize() { return fontSize; }
        public void setFontSize(Integer fontSize) { this.fontSize = fontSize; }

        public Double getLineHeight() { return lineHeight; }
        public void setLineHeight(Double lineHeight) { this.lineHeight = lineHeight; }

        public Double getLetterSpacing() { return letterSpacing; }
        public void setLetterSpacing(Double letterSpacing) { this.letterSpacing = letterSpacing; }

        public String getFontWeight() { return fontWeight; }
        public void setFontWeight(String fontWeight) { this.fontWeight = fontWeight; }

        public String getFontStyle() { return fontStyle; }
        public void setFontStyle(String fontStyle) { this.fontStyle = fontStyle; }

        public Boolean getUseCustomFont() { return useCustomFont; }
        public void setUseCustomFont(Boolean useCustomFont) { this.useCustomFont = useCustomFont; }

        public String getCustomFontUrl() { return customFontUrl; }
        public void setCustomFontUrl(String customFontUrl) { this.customFontUrl = customFontUrl; }

        public String getFontDisplay() { return fontDisplay; }
        public void setFontDisplay(String fontDisplay) { this.fontDisplay = fontDisplay; }

        public Boolean getOptimizeForReadability() { return optimizeForReadability; }
        public void setOptimizeForReadability(Boolean optimizeForReadability) { this.optimizeForReadability = optimizeForReadability; }
    }

    public static class UpdateFontResponse {
        private boolean success;
        private String message;
        private SettingsGetFont.FontSettingsData data;

        public UpdateFontResponse(boolean success, String message, SettingsGetFont.FontSettingsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public SettingsGetFont.FontSettingsData getData() { return data; }
        public void setData(SettingsGetFont.FontSettingsData data) { this.data = data; }
    }

    @PutMapping("")
    public ResponseEntity<UpdateFontResponse> updateFontSettings(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestBody UpdateFontRequest request) {

        try {
            printRequest(request);

            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateFontResponse(false, "未授权访问，请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 查询会话信息
            String sessionSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ?";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(sessionSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateFontResponse(false, "会话已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            Integer userId = (Integer) session.get("user_id");
            LocalDateTime expiresAt = (LocalDateTime) session.get("expires_at");

            if (expiresAt.isBefore(LocalDateTime.now())) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateFontResponse(false, "会话已过期，请重新登录", null)
                );
            }

            // 3. 验证字体设置数据
            if (request.getFontSize() != null && (request.getFontSize() < 8 || request.getFontSize() > 48)) {
                return ResponseEntity.badRequest().body(
                        new UpdateFontResponse(false, "字体大小必须在8-48之间", null)
                );
            }

            if (request.getLineHeight() != null && (request.getLineHeight() < 1.0 || request.getLineHeight() > 3.0)) {
                return ResponseEntity.badRequest().body(
                        new UpdateFontResponse(false, "行高必须在1.0-3.0之间", null)
                );
            }

            if (request.getLetterSpacing() != null && (request.getLetterSpacing() < -0.1 || request.getLetterSpacing() > 0.5)) {
                return ResponseEntity.badRequest().body(
                        new UpdateFontResponse(false, "字间距必须在-0.1到0.5之间", null)
                );
            }

            // 验证字体粗细
            if (request.getFontWeight() != null && !isValidFontWeight(request.getFontWeight())) {
                return ResponseEntity.badRequest().body(
                        new UpdateFontResponse(false, "无效的字体粗细", null)
                );
            }

            // 验证字体样式
            if (request.getFontStyle() != null && !isValidFontStyle(request.getFontStyle())) {
                return ResponseEntity.badRequest().body(
                        new UpdateFontResponse(false, "无效的字体样式", null)
                );
            }

            // 验证字体显示方式
            if (request.getFontDisplay() != null && !isValidFontDisplay(request.getFontDisplay())) {
                return ResponseEntity.badRequest().body(
                        new UpdateFontResponse(false, "无效的字体显示方式", null)
                );
            }

            // 4. 更新字体设置
            LocalDateTime now = LocalDateTime.now();

            updateFontSetting(userId, "fontFamily", request.getFontFamily(), now);
            updateFontSetting(userId, "fontSize", request.getFontSize() != null ? request.getFontSize().toString() : null, now);
            updateFontSetting(userId, "lineHeight", request.getLineHeight() != null ? request.getLineHeight().toString() : null, now);
            updateFontSetting(userId, "letterSpacing", request.getLetterSpacing() != null ? request.getLetterSpacing().toString() : null, now);
            updateFontSetting(userId, "fontWeight", request.getFontWeight(), now);
            updateFontSetting(userId, "fontStyle", request.getFontStyle(), now);
            updateFontSetting(userId, "useCustomFont", request.getUseCustomFont() != null ? request.getUseCustomFont().toString() : null, now);
            updateFontSetting(userId, "customFontUrl", request.getCustomFontUrl(), now);
            updateFontSetting(userId, "fontDisplay", request.getFontDisplay(), now);
            updateFontSetting(userId, "optimizeForReadability", request.getOptimizeForReadability() != null ? request.getOptimizeForReadability().toString() : null, now);

            // 5. 查询更新后的设置
            String settingsSql = "SELECT setting_key, setting_value, created_at, updated_at FROM user_settings WHERE user_id = ? AND setting_type = 'font'";
            List<Map<String, Object>> settingsList = jdbcTemplate.queryForList(settingsSql, userId);
            printQueryResult(settingsList);

            // 6. 构建响应数据
            SettingsGetFont.FontSettingsData settingsData = new SettingsGetFont.FontSettingsData();

            for (Map<String, Object> setting : settingsList) {
                String key = (String) setting.get("setting_key");
                String value = (String) setting.get("setting_value");

                switch (key) {
                    case "fontFamily":
                        settingsData.setFontFamily(value);
                        break;
                    case "fontSize":
                        try {
                            settingsData.setFontSize(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setFontSize(16);
                        }
                        break;
                    case "lineHeight":
                        try {
                            settingsData.setLineHeight(Double.parseDouble(value));
                        } catch (NumberFormatException e) {
                            settingsData.setLineHeight(1.6);
                        }
                        break;
                    case "letterSpacing":
                        try {
                            settingsData.setLetterSpacing(Double.parseDouble(value));
                        } catch (NumberFormatException e) {
                            settingsData.setLetterSpacing(0);
                        }
                        break;
                    case "fontWeight":
                        settingsData.setFontWeight(value);
                        break;
                    case "fontStyle":
                        settingsData.setFontStyle(value);
                        break;
                    case "useCustomFont":
                        settingsData.setUseCustomFont("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "customFontUrl":
                        settingsData.setCustomFontUrl(value);
                        break;
                    case "fontDisplay":
                        settingsData.setFontDisplay(value);
                        break;
                    case "optimizeForReadability":
                        settingsData.setOptimizeForReadability("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                }
            }

            // 7. 准备响应
            UpdateFontResponse response = new UpdateFontResponse(true, "字体设置更新成功", settingsData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("更新字体设置过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdateFontResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private void updateFontSetting(Integer userId, String key, String value, LocalDateTime now) {
        if (value != null) {
            // 检查设置是否存在
            String checkSql = "SELECT setting_id FROM user_settings WHERE user_id = ? AND setting_type = 'font' AND setting_key = ?";
            List<Map<String, Object>> existing = jdbcTemplate.queryForList(checkSql, userId, key);

            if (existing.isEmpty()) {
                // 插入新设置
                String insertSql = "INSERT INTO user_settings (user_id, setting_type, setting_key, setting_value, created_at, updated_at) VALUES (?, 'font', ?, ?, ?, ?)";
                jdbcTemplate.update(insertSql, userId, key, value, now, now);
            } else {
                // 更新现有设置
                String updateSql = "UPDATE user_settings SET setting_value = ?, updated_at = ? WHERE user_id = ? AND setting_type = 'font' AND setting_key = ?";
                jdbcTemplate.update(updateSql, value, now, userId, key);
            }
        }
    }

    private boolean isValidFontWeight(String fontWeight) {
        return fontWeight.equals("normal") || fontWeight.equals("bold") ||
                fontWeight.equals("lighter") || fontWeight.equals("bolder") ||
                fontWeight.matches("^[1-9]00$"); // 100, 200, ..., 900
    }

    private boolean isValidFontStyle(String fontStyle) {
        return fontStyle.equals("normal") || fontStyle.equals("italic") ||
                fontStyle.equals("oblique");
    }

    private boolean isValidFontDisplay(String fontDisplay) {
        return fontDisplay.equals("auto") || fontDisplay.equals("block") ||
                fontDisplay.equals("swap") || fontDisplay.equals("fallback") ||
                fontDisplay.equals("optional");
    }
}

--- 结束文件: SettingsUpdateFont.java ---

--- 开始文件: SettingsUpdateGeneral.java ---
package com.vue.readingapp.settings;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user/settings/general")
public class SettingsUpdateGeneral {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到更新通用设置请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class UpdateGeneralRequest {
        private String language;
        private String theme;
        private Integer fontSize;
        private String timezone;
        private String dateFormat;
        private String timeFormat;
        private Boolean autoSave;
        private Integer autoSaveInterval;
        private Boolean syncEnabled;
        private Integer syncInterval;
        private Integer dataRetentionDays;
        private String privacyLevel;

        // Getters and Setters
        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }

        public String getTheme() { return theme; }
        public void setTheme(String theme) { this.theme = theme; }

        public Integer getFontSize() { return fontSize; }
        public void setFontSize(Integer fontSize) { this.fontSize = fontSize; }

        public String getTimezone() { return timezone; }
        public void setTimezone(String timezone) { this.timezone = timezone; }

        public String getDateFormat() { return dateFormat; }
        public void setDateFormat(String dateFormat) { this.dateFormat = dateFormat; }

        public String getTimeFormat() { return timeFormat; }
        public void setTimeFormat(String timeFormat) { this.timeFormat = timeFormat; }

        public Boolean getAutoSave() { return autoSave; }
        public void setAutoSave(Boolean autoSave) { this.autoSave = autoSave; }

        public Integer getAutoSaveInterval() { return autoSaveInterval; }
        public void setAutoSaveInterval(Integer autoSaveInterval) { this.autoSaveInterval = autoSaveInterval; }

        public Boolean getSyncEnabled() { return syncEnabled; }
        public void setSyncEnabled(Boolean syncEnabled) { this.syncEnabled = syncEnabled; }

        public Integer getSyncInterval() { return syncInterval; }
        public void setSyncInterval(Integer syncInterval) { this.syncInterval = syncInterval; }

        public Integer getDataRetentionDays() { return dataRetentionDays; }
        public void setDataRetentionDays(Integer dataRetentionDays) { this.dataRetentionDays = dataRetentionDays; }

        public String getPrivacyLevel() { return privacyLevel; }
        public void setPrivacyLevel(String privacyLevel) { this.privacyLevel = privacyLevel; }
    }

    public static class UpdateGeneralResponse {
        private boolean success;
        private String message;
        private SettingsGet.SettingsData data;

        public UpdateGeneralResponse(boolean success, String message, SettingsGet.SettingsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public SettingsGet.SettingsData getData() { return data; }
        public void setData(SettingsGet.SettingsData data) { this.data = data; }
    }

    @PutMapping("")
    public ResponseEntity<UpdateGeneralResponse> updateGeneralSettings(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestBody UpdateGeneralRequest request) {

        try {
            printRequest(request);

            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateGeneralResponse(false, "未授权访问，请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 查询会话信息
            String sessionSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ?";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(sessionSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateGeneralResponse(false, "会话已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            Integer userId = (Integer) session.get("user_id");
            LocalDateTime expiresAt = (LocalDateTime) session.get("expires_at");

            if (expiresAt.isBefore(LocalDateTime.now())) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateGeneralResponse(false, "会话已过期，请重新登录", null)
                );
            }

            // 3. 验证通用设置数据
            if (request.getTheme() != null && !isValidTheme(request.getTheme())) {
                return ResponseEntity.badRequest().body(
                        new UpdateGeneralResponse(false, "无效的主题设置", null)
                );
            }

            if (request.getTimeFormat() != null && !isValidTimeFormat(request.getTimeFormat())) {
                return ResponseEntity.badRequest().body(
                        new UpdateGeneralResponse(false, "无效的时间格式", null)
                );
            }

            if (request.getPrivacyLevel() != null && !isValidPrivacyLevel(request.getPrivacyLevel())) {
                return ResponseEntity.badRequest().body(
                        new UpdateGeneralResponse(false, "无效的隐私级别", null)
                );
            }

            if (request.getFontSize() != null && (request.getFontSize() < 8 || request.getFontSize() > 32)) {
                return ResponseEntity.badRequest().body(
                        new UpdateGeneralResponse(false, "字体大小必须在8-32之间", null)
                );
            }

            // 4. 更新通用设置
            LocalDateTime now = LocalDateTime.now();

            updateGeneralSetting(userId, "language", request.getLanguage(), now);
            updateGeneralSetting(userId, "theme", request.getTheme(), now);
            updateGeneralSetting(userId, "fontSize", request.getFontSize() != null ? request.getFontSize().toString() : null, now);
            updateGeneralSetting(userId, "timezone", request.getTimezone(), now);
            updateGeneralSetting(userId, "dateFormat", request.getDateFormat(), now);
            updateGeneralSetting(userId, "timeFormat", request.getTimeFormat(), now);
            updateGeneralSetting(userId, "autoSave", request.getAutoSave() != null ? request.getAutoSave().toString() : null, now);
            updateGeneralSetting(userId, "autoSaveInterval", request.getAutoSaveInterval() != null ? request.getAutoSaveInterval().toString() : null, now);
            updateGeneralSetting(userId, "syncEnabled", request.getSyncEnabled() != null ? request.getSyncEnabled().toString() : null, now);
            updateGeneralSetting(userId, "syncInterval", request.getSyncInterval() != null ? request.getSyncInterval().toString() : null, now);
            updateGeneralSetting(userId, "dataRetentionDays", request.getDataRetentionDays() != null ? request.getDataRetentionDays().toString() : null, now);
            updateGeneralSetting(userId, "privacyLevel", request.getPrivacyLevel(), now);

            // 5. 查询更新后的设置
            String settingsSql = "SELECT setting_key, setting_value, created_at, updated_at FROM user_settings WHERE user_id = ? AND setting_type = 'general'";
            List<Map<String, Object>> settingsList = jdbcTemplate.queryForList(settingsSql, userId);
            printQueryResult(settingsList);

            // 6. 构建响应数据
            SettingsGet.SettingsData settingsData = new SettingsGet.SettingsData();

            for (Map<String, Object> setting : settingsList) {
                String key = (String) setting.get("setting_key");
                String value = (String) setting.get("setting_value");

                switch (key) {
                    case "language":
                        settingsData.setLanguage(value);
                        break;
                    case "theme":
                        settingsData.setTheme(value);
                        break;
                    case "fontSize":
                        try {
                            settingsData.setFontSize(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setFontSize(14);
                        }
                        break;
                    case "timezone":
                        settingsData.setTimezone(value);
                        break;
                    case "dateFormat":
                        settingsData.setDateFormat(value);
                        break;
                    case "timeFormat":
                        settingsData.setTimeFormat(value);
                        break;
                    case "autoSave":
                        settingsData.setAutoSave("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "autoSaveInterval":
                        try {
                            settingsData.setAutoSaveInterval(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setAutoSaveInterval(30);
                        }
                        break;
                    case "syncEnabled":
                        settingsData.setSyncEnabled("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "syncInterval":
                        try {
                            settingsData.setSyncInterval(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setSyncInterval(5);
                        }
                        break;
                    case "dataRetentionDays":
                        try {
                            settingsData.setDataRetentionDays(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setDataRetentionDays(90);
                        }
                        break;
                    case "privacyLevel":
                        settingsData.setPrivacyLevel(value);
                        break;
                }

                if (settingsData.getCreatedAt() == null && setting.get("created_at") != null) {
                    settingsData.setCreatedAt(setting.get("created_at").toString());
                }
                if (settingsData.getUpdatedAt() == null && setting.get("updated_at") != null) {
                    settingsData.setUpdatedAt(setting.get("updated_at").toString());
                }
            }

            // 7. 准备响应
            UpdateGeneralResponse response = new UpdateGeneralResponse(true, "通用设置更新成功", settingsData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("更新通用设置过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdateGeneralResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private void updateGeneralSetting(Integer userId, String key, String value, LocalDateTime now) {
        if (value != null) {
            // 检查设置是否存在
            String checkSql = "SELECT setting_id FROM user_settings WHERE user_id = ? AND setting_type = 'general' AND setting_key = ?";
            List<Map<String, Object>> existing = jdbcTemplate.queryForList(checkSql, userId, key);

            if (existing.isEmpty()) {
                // 插入新设置
                String insertSql = "INSERT INTO user_settings (user_id, setting_type, setting_key, setting_value, created_at, updated_at) VALUES (?, 'general', ?, ?, ?, ?)";
                jdbcTemplate.update(insertSql, userId, key, value, now, now);
            } else {
                // 更新现有设置
                String updateSql = "UPDATE user_settings SET setting_value = ?, updated_at = ? WHERE user_id = ? AND setting_type = 'general' AND setting_key = ?";
                jdbcTemplate.update(updateSql, value, now, userId, key);
            }
        }
    }

    private boolean isValidTheme(String theme) {
        return theme.equals("light") || theme.equals("dark") || theme.equals("auto");
    }

    private boolean isValidTimeFormat(String timeFormat) {
        return timeFormat.equals("12h") || timeFormat.equals("24h");
    }

    private boolean isValidPrivacyLevel(String privacyLevel) {
        return privacyLevel.equals("minimal") || privacyLevel.equals("standard") || privacyLevel.equals("strict");
    }
}

--- 结束文件: SettingsUpdateGeneral.java ---

--- 开始文件: SettingsUpdateLanguage.java ---
package com.vue.readingapp.settings;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user/settings/language")
public class SettingsUpdateLanguage {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到更新语言设置请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class UpdateLanguageRequest {
        private String language;
        private String defaultDictionary;
        private Boolean autoDetectLanguage;
        private Boolean showPhonetic;
        private Boolean showDefinition;
        private Boolean showExamples;
        private String translationEngine;
        private Boolean autoPlayAudio;
        private String audioVoice;
        private Double audioSpeed;

        // Getters and Setters
        public String getLanguage() { return language; }
        public void setLanguage(String language) { this.language = language; }

        public String getDefaultDictionary() { return defaultDictionary; }
        public void setDefaultDictionary(String defaultDictionary) { this.defaultDictionary = defaultDictionary; }

        public Boolean getAutoDetectLanguage() { return autoDetectLanguage; }
        public void setAutoDetectLanguage(Boolean autoDetectLanguage) { this.autoDetectLanguage = autoDetectLanguage; }

        public Boolean getShowPhonetic() { return showPhonetic; }
        public void setShowPhonetic(Boolean showPhonetic) { this.showPhonetic = showPhonetic; }

        public Boolean getShowDefinition() { return showDefinition; }
        public void setShowDefinition(Boolean showDefinition) { this.showDefinition = showDefinition; }

        public Boolean getShowExamples() { return showExamples; }
        public void setShowExamples(Boolean showExamples) { this.showExamples = showExamples; }

        public String getTranslationEngine() { return translationEngine; }
        public void setTranslationEngine(String translationEngine) { this.translationEngine = translationEngine; }

        public Boolean getAutoPlayAudio() { return autoPlayAudio; }
        public void setAutoPlayAudio(Boolean autoPlayAudio) { this.autoPlayAudio = autoPlayAudio; }

        public String getAudioVoice() { return audioVoice; }
        public void setAudioVoice(String audioVoice) { this.audioVoice = audioVoice; }

        public Double getAudioSpeed() { return audioSpeed; }
        public void setAudioSpeed(Double audioSpeed) { this.audioSpeed = audioSpeed; }
    }

    public static class UpdateLanguageResponse {
        private boolean success;
        private String message;
        private SettingsGetLanguage.LanguageSettingsData data;

        public UpdateLanguageResponse(boolean success, String message, SettingsGetLanguage.LanguageSettingsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public SettingsGetLanguage.LanguageSettingsData getData() { return data; }
        public void setData(SettingsGetLanguage.LanguageSettingsData data) { this.data = data; }
    }

    @PutMapping("")
    public ResponseEntity<UpdateLanguageResponse> updateLanguageSettings(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestBody UpdateLanguageRequest request) {

        try {
            printRequest(request);

            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateLanguageResponse(false, "未授权访问，请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 查询会话信息
            String sessionSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ?";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(sessionSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateLanguageResponse(false, "会话已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            Integer userId = (Integer) session.get("user_id");
            LocalDateTime expiresAt = (LocalDateTime) session.get("expires_at");

            if (expiresAt.isBefore(LocalDateTime.now())) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateLanguageResponse(false, "会话已过期，请重新登录", null)
                );
            }

            // 3. 验证语言设置数据
            if (request.getAudioSpeed() != null && (request.getAudioSpeed() < 0.5 || request.getAudioSpeed() > 2.0)) {
                return ResponseEntity.badRequest().body(
                        new UpdateLanguageResponse(false, "音频速度必须在0.5-2.0之间", null)
                );
            }

            // 验证翻译引擎
            if (request.getTranslationEngine() != null && !isValidTranslationEngine(request.getTranslationEngine())) {
                return ResponseEntity.badRequest().body(
                        new UpdateLanguageResponse(false, "无效的翻译引擎", null)
                );
            }

            // 4. 更新语言设置
            LocalDateTime now = LocalDateTime.now();

            updateLanguageSetting(userId, "language", request.getLanguage(), now);
            updateLanguageSetting(userId, "defaultDictionary", request.getDefaultDictionary(), now);
            updateLanguageSetting(userId, "autoDetectLanguage", request.getAutoDetectLanguage() != null ? request.getAutoDetectLanguage().toString() : null, now);
            updateLanguageSetting(userId, "showPhonetic", request.getShowPhonetic() != null ? request.getShowPhonetic().toString() : null, now);
            updateLanguageSetting(userId, "showDefinition", request.getShowDefinition() != null ? request.getShowDefinition().toString() : null, now);
            updateLanguageSetting(userId, "showExamples", request.getShowExamples() != null ? request.getShowExamples().toString() : null, now);
            updateLanguageSetting(userId, "translationEngine", request.getTranslationEngine(), now);
            updateLanguageSetting(userId, "autoPlayAudio", request.getAutoPlayAudio() != null ? request.getAutoPlayAudio().toString() : null, now);
            updateLanguageSetting(userId, "audioVoice", request.getAudioVoice(), now);
            updateLanguageSetting(userId, "audioSpeed", request.getAudioSpeed() != null ? request.getAudioSpeed().toString() : null, now);

            // 5. 查询更新后的设置
            String settingsSql = "SELECT setting_key, setting_value, created_at, updated_at FROM user_settings WHERE user_id = ? AND setting_type = 'language'";
            List<Map<String, Object>> settingsList = jdbcTemplate.queryForList(settingsSql, userId);
            printQueryResult(settingsList);

            // 6. 构建响应数据
            SettingsGetLanguage.LanguageSettingsData settingsData = new SettingsGetLanguage.LanguageSettingsData();

            for (Map<String, Object> setting : settingsList) {
                String key = (String) setting.get("setting_key");
                String value = (String) setting.get("setting_value");

                switch (key) {
                    case "language":
                        settingsData.setLanguage(value);
                        break;
                    case "defaultDictionary":
                        settingsData.setDefaultDictionary(value);
                        break;
                    case "autoDetectLanguage":
                        settingsData.setAutoDetectLanguage("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "showPhonetic":
                        settingsData.setShowPhonetic("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "showDefinition":
                        settingsData.setShowDefinition("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "showExamples":
                        settingsData.setShowExamples("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "translationEngine":
                        settingsData.setTranslationEngine(value);
                        break;
                    case "autoPlayAudio":
                        settingsData.setAutoPlayAudio("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "audioVoice":
                        settingsData.setAudioVoice(value);
                        break;
                    case "audioSpeed":
                        try {
                            settingsData.setAudioSpeed(Double.parseDouble(value));
                        } catch (NumberFormatException e) {
                            settingsData.setAudioSpeed(1.0);
                        }
                        break;
                }
            }

            // 7. 准备响应
            UpdateLanguageResponse response = new UpdateLanguageResponse(true, "语言设置更新成功", settingsData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("更新语言设置过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdateLanguageResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private void updateLanguageSetting(Integer userId, String key, String value, LocalDateTime now) {
        if (value != null) {
            // 检查设置是否存在
            String checkSql = "SELECT setting_id FROM user_settings WHERE user_id = ? AND setting_type = 'language' AND setting_key = ?";
            List<Map<String, Object>> existing = jdbcTemplate.queryForList(checkSql, userId, key);

            if (existing.isEmpty()) {
                // 插入新设置
                String insertSql = "INSERT INTO user_settings (user_id, setting_type, setting_key, setting_value, created_at, updated_at) VALUES (?, 'language', ?, ?, ?, ?)";
                jdbcTemplate.update(insertSql, userId, key, value, now, now);
            } else {
                // 更新现有设置
                String updateSql = "UPDATE user_settings SET setting_value = ?, updated_at = ? WHERE user_id = ? AND setting_type = 'language' AND setting_key = ?";
                jdbcTemplate.update(updateSql, value, now, userId, key);
            }
        }
    }

    private boolean isValidTranslationEngine(String engine) {
        return engine.equals("google") || engine.equals("bing") ||
                engine.equals("youdao") || engine.equals("baidu");
    }
}

--- 结束文件: SettingsUpdateLanguage.java ---

--- 开始文件: SettingsUpdateNotification.java ---
package com.vue.readingapp.settings;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user/settings/notifications")
public class SettingsUpdateNotification {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到更新通知设置请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class UpdateNotificationRequest {
        private EmailNotificationsRequest emailNotifications;
        private PushNotificationsRequest pushNotifications;
        private InAppNotificationsRequest inAppNotifications;
        private QuietHoursRequest quietHours;

        // Getters and Setters
        public EmailNotificationsRequest getEmailNotifications() { return emailNotifications; }
        public void setEmailNotifications(EmailNotificationsRequest emailNotifications) { this.emailNotifications = emailNotifications; }

        public PushNotificationsRequest getPushNotifications() { return pushNotifications; }
        public void setPushNotifications(PushNotificationsRequest pushNotifications) { this.pushNotifications = pushNotifications; }

        public InAppNotificationsRequest getInAppNotifications() { return inAppNotifications; }
        public void setInAppNotifications(InAppNotificationsRequest inAppNotifications) { this.inAppNotifications = inAppNotifications; }

        public QuietHoursRequest getQuietHours() { return quietHours; }
        public void setQuietHours(QuietHoursRequest quietHours) { this.quietHours = quietHours; }
    }

    public static class EmailNotificationsRequest {
        private Boolean enabled;
        private Boolean dailyDigest;
        private Boolean weeklyReport;
        private Boolean achievementUnlocked;
        private Boolean reviewReminder;
        private Boolean systemUpdates;

        // Getters and Setters
        public Boolean getEnabled() { return enabled; }
        public void setEnabled(Boolean enabled) { this.enabled = enabled; }

        public Boolean getDailyDigest() { return dailyDigest; }
        public void setDailyDigest(Boolean dailyDigest) { this.dailyDigest = dailyDigest; }

        public Boolean getWeeklyReport() { return weeklyReport; }
        public void setWeeklyReport(Boolean weeklyReport) { this.weeklyReport = weeklyReport; }

        public Boolean getAchievementUnlocked() { return achievementUnlocked; }
        public void setAchievementUnlocked(Boolean achievementUnlocked) { this.achievementUnlocked = achievementUnlocked; }

        public Boolean getReviewReminder() { return reviewReminder; }
        public void setReviewReminder(Boolean reviewReminder) { this.reviewReminder = reviewReminder; }

        public Boolean getSystemUpdates() { return systemUpdates; }
        public void setSystemUpdates(Boolean systemUpdates) { this.systemUpdates = systemUpdates; }
    }

    public static class PushNotificationsRequest {
        private Boolean enabled;
        private Boolean reviewReminder;
        private Boolean dailyGoalReminder;
        private Boolean streakReminder;
        private Boolean newFeature;
        private Boolean promotional;

        // Getters and Setters
        public Boolean getEnabled() { return enabled; }
        public void setEnabled(Boolean enabled) { this.enabled = enabled; }

        public Boolean getReviewReminder() { return reviewReminder; }
        public void setReviewReminder(Boolean reviewReminder) { this.reviewReminder = reviewReminder; }

        public Boolean getDailyGoalReminder() { return dailyGoalReminder; }
        public void setDailyGoalReminder(Boolean dailyGoalReminder) { this.dailyGoalReminder = dailyGoalReminder; }

        public Boolean getStreakReminder() { return streakReminder; }
        public void setStreakReminder(Boolean streakReminder) { this.streakReminder = streakReminder; }

        public Boolean getNewFeature() { return newFeature; }
        public void setNewFeature(Boolean newFeature) { this.newFeature = newFeature; }

        public Boolean getPromotional() { return promotional; }
        public void setPromotional(Boolean promotional) { this.promotional = promotional; }
    }

    public static class InAppNotificationsRequest {
        private Boolean enabled;
        private Boolean showBadge;
        private Boolean soundEnabled;
        private Boolean vibrationEnabled;

        // Getters and Setters
        public Boolean getEnabled() { return enabled; }
        public void setEnabled(Boolean enabled) { this.enabled = enabled; }

        public Boolean getShowBadge() { return showBadge; }
        public void setShowBadge(Boolean showBadge) { this.showBadge = showBadge; }

        public Boolean getSoundEnabled() { return soundEnabled; }
        public void setSoundEnabled(Boolean soundEnabled) { this.soundEnabled = soundEnabled; }

        public Boolean getVibrationEnabled() { return vibrationEnabled; }
        public void setVibrationEnabled(Boolean vibrationEnabled) { this.vibrationEnabled = vibrationEnabled; }
    }

    public static class QuietHoursRequest {
        private Boolean enabled;
        private String startTime;
        private String endTime;

        // Getters and Setters
        public Boolean getEnabled() { return enabled; }
        public void setEnabled(Boolean enabled) { this.enabled = enabled; }

        public String getStartTime() { return startTime; }
        public void setStartTime(String startTime) { this.startTime = startTime; }

        public String getEndTime() { return endTime; }
        public void setEndTime(String endTime) { this.endTime = endTime; }
    }

    public static class UpdateNotificationResponse {
        private boolean success;
        private String message;
        private SettingsGetNotification.NotificationSettingsData data;

        public UpdateNotificationResponse(boolean success, String message, SettingsGetNotification.NotificationSettingsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public SettingsGetNotification.NotificationSettingsData getData() { return data; }
        public void setData(SettingsGetNotification.NotificationSettingsData data) { this.data = data; }
    }

    @PutMapping("")
    public ResponseEntity<UpdateNotificationResponse> updateNotificationSettings(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestBody UpdateNotificationRequest request) {

        try {
            printRequest(request);

            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateNotificationResponse(false, "未授权访问，请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 查询会话信息
            String sessionSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ?";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(sessionSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateNotificationResponse(false, "会话已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            Integer userId = (Integer) session.get("user_id");
            LocalDateTime expiresAt = (LocalDateTime) session.get("expires_at");

            if (expiresAt.isBefore(LocalDateTime.now())) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateNotificationResponse(false, "会话已过期，请重新登录", null)
                );
            }

            // 3. 验证通知设置数据
            if (request.getQuietHours() != null) {
                QuietHoursRequest quietHours = request.getQuietHours();
                if (quietHours.getStartTime() != null && !isValidTimeFormat(quietHours.getStartTime())) {
                    return ResponseEntity.badRequest().body(
                            new UpdateNotificationResponse(false, "无效的静默时段开始时间格式", null)
                    );
                }
                if (quietHours.getEndTime() != null && !isValidTimeFormat(quietHours.getEndTime())) {
                    return ResponseEntity.badRequest().body(
                            new UpdateNotificationResponse(false, "无效的静默时段结束时间格式", null)
                    );
                }
            }

            // 4. 更新通知设置
            LocalDateTime now = LocalDateTime.now();

            // 更新邮件通知设置
            if (request.getEmailNotifications() != null) {
                EmailNotificationsRequest email = request.getEmailNotifications();
                updateNotificationSetting(userId, "email_enabled", email.getEnabled() != null ? email.getEnabled().toString() : null, now);
                updateNotificationSetting(userId, "email_dailyDigest", email.getDailyDigest() != null ? email.getDailyDigest().toString() : null, now);
                updateNotificationSetting(userId, "email_weeklyReport", email.getWeeklyReport() != null ? email.getWeeklyReport().toString() : null, now);
                updateNotificationSetting(userId, "email_achievementUnlocked", email.getAchievementUnlocked() != null ? email.getAchievementUnlocked().toString() : null, now);
                updateNotificationSetting(userId, "email_reviewReminder", email.getReviewReminder() != null ? email.getReviewReminder().toString() : null, now);
                updateNotificationSetting(userId, "email_systemUpdates", email.getSystemUpdates() != null ? email.getSystemUpdates().toString() : null, now);
            }

            // 更新推送通知设置
            if (request.getPushNotifications() != null) {
                PushNotificationsRequest push = request.getPushNotifications();
                updateNotificationSetting(userId, "push_enabled", push.getEnabled() != null ? push.getEnabled().toString() : null, now);
                updateNotificationSetting(userId, "push_reviewReminder", push.getReviewReminder() != null ? push.getReviewReminder().toString() : null, now);
                updateNotificationSetting(userId, "push_dailyGoalReminder", push.getDailyGoalReminder() != null ? push.getDailyGoalReminder().toString() : null, now);
                updateNotificationSetting(userId, "push_streakReminder", push.getStreakReminder() != null ? push.getStreakReminder().toString() : null, now);
                updateNotificationSetting(userId, "push_newFeature", push.getNewFeature() != null ? push.getNewFeature().toString() : null, now);
                updateNotificationSetting(userId, "push_promotional", push.getPromotional() != null ? push.getPromotional().toString() : null, now);
            }

            // 更新应用内通知设置
            if (request.getInAppNotifications() != null) {
                InAppNotificationsRequest inApp = request.getInAppNotifications();
                updateNotificationSetting(userId, "inApp_enabled", inApp.getEnabled() != null ? inApp.getEnabled().toString() : null, now);
                updateNotificationSetting(userId, "inApp_showBadge", inApp.getShowBadge() != null ? inApp.getShowBadge().toString() : null, now);
                updateNotificationSetting(userId, "inApp_soundEnabled", inApp.getSoundEnabled() != null ? inApp.getSoundEnabled().toString() : null, now);
                updateNotificationSetting(userId, "inApp_vibrationEnabled", inApp.getVibrationEnabled() != null ? inApp.getVibrationEnabled().toString() : null, now);
            }

            // 更新静默时段设置
            if (request.getQuietHours() != null) {
                QuietHoursRequest quietHours = request.getQuietHours();
                updateNotificationSetting(userId, "quietHours_enabled", quietHours.getEnabled() != null ? quietHours.getEnabled().toString() : null, now);
                updateNotificationSetting(userId, "quietHours_startTime", quietHours.getStartTime(), now);
                updateNotificationSetting(userId, "quietHours_endTime", quietHours.getEndTime(), now);
            }

            // 5. 查询更新后的设置
            String settingsSql = "SELECT setting_key, setting_value, created_at, updated_at FROM user_settings WHERE user_id = ? AND setting_type = 'notification'";
            List<Map<String, Object>> settingsList = jdbcTemplate.queryForList(settingsSql, userId);
            printQueryResult(settingsList);

            // 6. 构建响应数据
            SettingsGetNotification.NotificationSettingsData settingsData = new SettingsGetNotification.NotificationSettingsData();

            for (Map<String, Object> setting : settingsList) {
                String key = (String) setting.get("setting_key");
                String value = (String) setting.get("setting_value");

                String[] parts = key.split("_");
                if (parts.length >= 2) {
                    String category = parts[0];
                    String subKey = parts[1];

                    switch (category) {
                        case "email":
                            updateEmailSetting(settingsData.getEmailNotifications(), subKey, value);
                            break;
                        case "push":
                            updatePushSetting(settingsData.getPushNotifications(), subKey, value);
                            break;
                        case "inApp":
                            updateInAppSetting(settingsData.getInAppNotifications(), subKey, value);
                            break;
                        case "quietHours":
                            updateQuietHoursSetting(settingsData.getQuietHours(), subKey, value);
                            break;
                    }
                }
            }

            // 7. 准备响应
            UpdateNotificationResponse response = new UpdateNotificationResponse(true, "通知设置更新成功", settingsData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("更新通知设置过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdateNotificationResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private void updateNotificationSetting(Integer userId, String key, String value, LocalDateTime now) {
        if (value != null) {
            // 检查设置是否存在
            String checkSql = "SELECT setting_id FROM user_settings WHERE user_id = ? AND setting_type = 'notification' AND setting_key = ?";
            List<Map<String, Object>> existing = jdbcTemplate.queryForList(checkSql, userId, key);

            if (existing.isEmpty()) {
                // 插入新设置
                String insertSql = "INSERT INTO user_settings (user_id, setting_type, setting_key, setting_value, created_at, updated_at) VALUES (?, 'notification', ?, ?, ?, ?)";
                jdbcTemplate.update(insertSql, userId, key, value, now, now);
            } else {
                // 更新现有设置
                String updateSql = "UPDATE user_settings SET setting_value = ?, updated_at = ? WHERE user_id = ? AND setting_type = 'notification' AND setting_key = ?";
                jdbcTemplate.update(updateSql, value, now, userId, key);
            }
        }
    }

    private void updateEmailSetting(SettingsGetNotification.EmailNotifications email, String key, String value) {
        if (value == null) return;

        boolean boolValue = "true".equalsIgnoreCase(value) || "1".equals(value);

        switch (key) {
            case "enabled":
                email.setEnabled(boolValue);
                break;
            case "dailyDigest":
                email.setDailyDigest(boolValue);
                break;
            case "weeklyReport":
                email.setWeeklyReport(boolValue);
                break;
            case "achievementUnlocked":
                email.setAchievementUnlocked(boolValue);
                break;
            case "reviewReminder":
                email.setReviewReminder(boolValue);
                break;
            case "systemUpdates":
                email.setSystemUpdates(boolValue);
                break;
        }
    }

    private void updatePushSetting(SettingsGetNotification.PushNotifications push, String key, String value) {
        if (value == null) return;

        boolean boolValue = "true".equalsIgnoreCase(value) || "1".equals(value);

        switch (key) {
            case "enabled":
                push.setEnabled(boolValue);
                break;
            case "reviewReminder":
                push.setReviewReminder(boolValue);
                break;
            case "dailyGoalReminder":
                push.setDailyGoalReminder(boolValue);
                break;
            case "streakReminder":
                push.setStreakReminder(boolValue);
                break;
            case "newFeature":
                push.setNewFeature(boolValue);
                break;
            case "promotional":
                push.setPromotional(boolValue);
                break;
        }
    }

    private void updateInAppSetting(SettingsGetNotification.InAppNotifications inApp, String key, String value) {
        if (value == null) return;

        boolean boolValue = "true".equalsIgnoreCase(value) || "1".equals(value);

        switch (key) {
            case "enabled":
                inApp.setEnabled(boolValue);
                break;
            case "showBadge":
                inApp.setShowBadge(boolValue);
                break;
            case "soundEnabled":
                inApp.setSoundEnabled(boolValue);
                break;
            case "vibrationEnabled":
                inApp.setVibrationEnabled(boolValue);
                break;
        }
    }

    private void updateQuietHoursSetting(SettingsGetNotification.QuietHours quietHours, String key, String value) {
        if (value == null) return;

        if (key.equals("enabled")) {
            quietHours.setEnabled("true".equalsIgnoreCase(value) || "1".equals(value));
        } else if (key.equals("startTime")) {
            quietHours.setStartTime(value);
        } else if (key.equals("endTime")) {
            quietHours.setEndTime(value);
        }
    }

    private boolean isValidTimeFormat(String time) {
        return time.matches("^([01]?[0-9]|2[0-3]):[0-5][0-9]$");
    }
}

--- 结束文件: SettingsUpdateNotification.java ---

--- 开始文件: SettingsUpdatePrivacy.java ---
package com.vue.readingapp.settings;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user/settings/privacy")
public class SettingsUpdatePrivacy {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到更新隐私设置请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class UpdatePrivacyRequest {
        private String privacyLevel;
        private Boolean shareReadingData;
        private Boolean shareVocabularyData;
        private Boolean shareAchievements;
        private Boolean allowDataCollection;
        private Boolean showOnlineStatus;
        private Boolean allowFriendRequests;
        private Boolean allowMessages;
        private Boolean showLearningStats;
        private Boolean showRecentActivity;

        // Getters and Setters
        public String getPrivacyLevel() { return privacyLevel; }
        public void setPrivacyLevel(String privacyLevel) { this.privacyLevel = privacyLevel; }

        public Boolean getShareReadingData() { return shareReadingData; }
        public void setShareReadingData(Boolean shareReadingData) { this.shareReadingData = shareReadingData; }

        public Boolean getShareVocabularyData() { return shareVocabularyData; }
        public void setShareVocabularyData(Boolean shareVocabularyData) { this.shareVocabularyData = shareVocabularyData; }

        public Boolean getShareAchievements() { return shareAchievements; }
        public void setShareAchievements(Boolean shareAchievements) { this.shareAchievements = shareAchievements; }

        public Boolean getAllowDataCollection() { return allowDataCollection; }
        public void setAllowDataCollection(Boolean allowDataCollection) { this.allowDataCollection = allowDataCollection; }

        public Boolean getShowOnlineStatus() { return showOnlineStatus; }
        public void setShowOnlineStatus(Boolean showOnlineStatus) { this.showOnlineStatus = showOnlineStatus; }

        public Boolean getAllowFriendRequests() { return allowFriendRequests; }
        public void setAllowFriendRequests(Boolean allowFriendRequests) { this.allowFriendRequests = allowFriendRequests; }

        public Boolean getAllowMessages() { return allowMessages; }
        public void setAllowMessages(Boolean allowMessages) { this.allowMessages = allowMessages; }

        public Boolean getShowLearningStats() { return showLearningStats; }
        public void setShowLearningStats(Boolean showLearningStats) { this.showLearningStats = showLearningStats; }

        public Boolean getShowRecentActivity() { return showRecentActivity; }
        public void setShowRecentActivity(Boolean showRecentActivity) { this.showRecentActivity = showRecentActivity; }
    }

    public static class UpdatePrivacyResponse {
        private boolean success;
        private String message;
        private PrivacySettingsData data;

        public UpdatePrivacyResponse(boolean success, String message, PrivacySettingsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public PrivacySettingsData getData() { return data; }
        public void setData(PrivacySettingsData data) { this.data = data; }
    }

    public static class PrivacySettingsData {
        private String privacyLevel;
        private boolean shareReadingData;
        private boolean shareVocabularyData;
        private boolean shareAchievements;
        private boolean allowDataCollection;
        private boolean showOnlineStatus;
        private boolean allowFriendRequests;
        private boolean allowMessages;
        private boolean showLearningStats;
        private boolean showRecentActivity;

        public PrivacySettingsData() {
            // 设置默认值
            this.privacyLevel = "standard";
            this.shareReadingData = true;
            this.shareVocabularyData = true;
            this.shareAchievements = true;
            this.allowDataCollection = true;
            this.showOnlineStatus = true;
            this.allowFriendRequests = true;
            this.allowMessages = true;
            this.showLearningStats = true;
            this.showRecentActivity = true;
        }

        // Getters and Setters
        public String getPrivacyLevel() { return privacyLevel; }
        public void setPrivacyLevel(String privacyLevel) { this.privacyLevel = privacyLevel; }

        public boolean isShareReadingData() { return shareReadingData; }
        public void setShareReadingData(boolean shareReadingData) { this.shareReadingData = shareReadingData; }

        public boolean isShareVocabularyData() { return shareVocabularyData; }
        public void setShareVocabularyData(boolean shareVocabularyData) { this.shareVocabularyData = shareVocabularyData; }

        public boolean isShareAchievements() { return shareAchievements; }
        public void setShareAchievements(boolean shareAchievements) { this.shareAchievements = shareAchievements; }

        public boolean isAllowDataCollection() { return allowDataCollection; }
        public void setAllowDataCollection(boolean allowDataCollection) { this.allowDataCollection = allowDataCollection; }

        public boolean isShowOnlineStatus() { return showOnlineStatus; }
        public void setShowOnlineStatus(boolean showOnlineStatus) { this.showOnlineStatus = showOnlineStatus; }

        public boolean isAllowFriendRequests() { return allowFriendRequests; }
        public void setAllowFriendRequests(boolean allowFriendRequests) { this.allowFriendRequests = allowFriendRequests; }

        public boolean isAllowMessages() { return allowMessages; }
        public void setAllowMessages(boolean allowMessages) { this.allowMessages = allowMessages; }

        public boolean isShowLearningStats() { return showLearningStats; }
        public void setShowLearningStats(boolean showLearningStats) { this.showLearningStats = showLearningStats; }

        public boolean isShowRecentActivity() { return showRecentActivity; }
        public void setShowRecentActivity(boolean showRecentActivity) { this.showRecentActivity = showRecentActivity; }
    }

    @PutMapping("")
    public ResponseEntity<UpdatePrivacyResponse> updatePrivacySettings(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestBody UpdatePrivacyRequest request) {

        try {
            printRequest(request);

            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdatePrivacyResponse(false, "未授权访问，请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 查询会话信息
            String sessionSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ?";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(sessionSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdatePrivacyResponse(false, "会话已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            Integer userId = (Integer) session.get("user_id");
            LocalDateTime expiresAt = (LocalDateTime) session.get("expires_at");

            if (expiresAt.isBefore(LocalDateTime.now())) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdatePrivacyResponse(false, "会话已过期，请重新登录", null)
                );
            }

            // 3. 验证隐私设置数据
            if (request.getPrivacyLevel() != null && !isValidPrivacyLevel(request.getPrivacyLevel())) {
                return ResponseEntity.badRequest().body(
                        new UpdatePrivacyResponse(false, "无效的隐私级别", null)
                );
            }

            // 4. 更新隐私设置
            LocalDateTime now = LocalDateTime.now();

            updatePrivacySetting(userId, "privacyLevel", request.getPrivacyLevel(), now);
            updatePrivacySetting(userId, "shareReadingData", request.getShareReadingData() != null ? request.getShareReadingData().toString() : null, now);
            updatePrivacySetting(userId, "shareVocabularyData", request.getShareVocabularyData() != null ? request.getShareVocabularyData().toString() : null, now);
            updatePrivacySetting(userId, "shareAchievements", request.getShareAchievements() != null ? request.getShareAchievements().toString() : null, now);
            updatePrivacySetting(userId, "allowDataCollection", request.getAllowDataCollection() != null ? request.getAllowDataCollection().toString() : null, now);
            updatePrivacySetting(userId, "showOnlineStatus", request.getShowOnlineStatus() != null ? request.getShowOnlineStatus().toString() : null, now);
            updatePrivacySetting(userId, "allowFriendRequests", request.getAllowFriendRequests() != null ? request.getAllowFriendRequests().toString() : null, now);
            updatePrivacySetting(userId, "allowMessages", request.getAllowMessages() != null ? request.getAllowMessages().toString() : null, now);
            updatePrivacySetting(userId, "showLearningStats", request.getShowLearningStats() != null ? request.getShowLearningStats().toString() : null, now);
            updatePrivacySetting(userId, "showRecentActivity", request.getShowRecentActivity() != null ? request.getShowRecentActivity().toString() : null, now);

            // 5. 查询更新后的设置
            String settingsSql = "SELECT setting_key, setting_value, created_at, updated_at FROM user_settings WHERE user_id = ? AND setting_type = 'privacy'";
            List<Map<String, Object>> settingsList = jdbcTemplate.queryForList(settingsSql, userId);
            printQueryResult(settingsList);

            // 6. 构建响应数据
            PrivacySettingsData settingsData = new PrivacySettingsData();

            for (Map<String, Object> setting : settingsList) {
                String key = (String) setting.get("setting_key");
                String value = (String) setting.get("setting_value");

                switch (key) {
                    case "privacyLevel":
                        settingsData.setPrivacyLevel(value);
                        break;
                    case "shareReadingData":
                        settingsData.setShareReadingData("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "shareVocabularyData":
                        settingsData.setShareVocabularyData("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "shareAchievements":
                        settingsData.setShareAchievements("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "allowDataCollection":
                        settingsData.setAllowDataCollection("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "showOnlineStatus":
                        settingsData.setShowOnlineStatus("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "allowFriendRequests":
                        settingsData.setAllowFriendRequests("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "allowMessages":
                        settingsData.setAllowMessages("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "showLearningStats":
                        settingsData.setShowLearningStats("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "showRecentActivity":
                        settingsData.setShowRecentActivity("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                }
            }

            // 7. 准备响应
            UpdatePrivacyResponse response = new UpdatePrivacyResponse(true, "隐私设置更新成功", settingsData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("更新隐私设置过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdatePrivacyResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private void updatePrivacySetting(Integer userId, String key, String value, LocalDateTime now) {
        if (value != null) {
            // 检查设置是否存在
            String checkSql = "SELECT setting_id FROM user_settings WHERE user_id = ? AND setting_type = 'privacy' AND setting_key = ?";
            List<Map<String, Object>> existing = jdbcTemplate.queryForList(checkSql, userId, key);

            if (existing.isEmpty()) {
                // 插入新设置
                String insertSql = "INSERT INTO user_settings (user_id, setting_type, setting_key, setting_value, created_at, updated_at) VALUES (?, 'privacy', ?, ?, ?, ?)";
                jdbcTemplate.update(insertSql, userId, key, value, now, now);
            } else {
                // 更新现有设置
                String updateSql = "UPDATE user_settings SET setting_value = ?, updated_at = ? WHERE user_id = ? AND setting_type = 'privacy' AND setting_key = ?";
                jdbcTemplate.update(updateSql, value, now, userId, key);
            }
        }
    }

    private boolean isValidPrivacyLevel(String privacyLevel) {
        return privacyLevel.equals("minimal") || privacyLevel.equals("standard") || privacyLevel.equals("strict");
    }
}

--- 结束文件: SettingsUpdatePrivacy.java ---

--- 开始文件: SettingsUpdateReading.java ---
package com.vue.readingapp.settings;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user/settings/reading")
public class SettingsUpdateReading {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到更新阅读设置请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class UpdateReadingRequest {
        private String fontFamily;
        private Integer fontSize;
        private Double lineHeight;
        private Double paragraphSpacing;
        private String theme;
        private String contrast;
        private String highlightColor;
        private String noteColor;
        private Boolean autoScroll;
        private Double scrollSpeed;
        private Boolean showTranslation;
        private String translationPosition;
        private Boolean showPhonetic;
        private Boolean showDefinition;
        private Boolean autoPlayAudio;
        private Double audioVolume;
        private Boolean textSelection;
        private Boolean doubleClickTranslate;
        private String wordBreak;
        private String textAlign;
        private Integer maxWidth;
        private Integer margin;

        // Getters and Setters
        public String getFontFamily() { return fontFamily; }
        public void setFontFamily(String fontFamily) { this.fontFamily = fontFamily; }

        public Integer getFontSize() { return fontSize; }
        public void setFontSize(Integer fontSize) { this.fontSize = fontSize; }

        public Double getLineHeight() { return lineHeight; }
        public void setLineHeight(Double lineHeight) { this.lineHeight = lineHeight; }

        public Double getParagraphSpacing() { return paragraphSpacing; }
        public void setParagraphSpacing(Double paragraphSpacing) { this.paragraphSpacing = paragraphSpacing; }

        public String getTheme() { return theme; }
        public void setTheme(String theme) { this.theme = theme; }

        public String getContrast() { return contrast; }
        public void setContrast(String contrast) { this.contrast = contrast; }

        public String getHighlightColor() { return highlightColor; }
        public void setHighlightColor(String highlightColor) { this.highlightColor = highlightColor; }

        public String getNoteColor() { return noteColor; }
        public void setNoteColor(String noteColor) { this.noteColor = noteColor; }

        public Boolean getAutoScroll() { return autoScroll; }
        public void setAutoScroll(Boolean autoScroll) { this.autoScroll = autoScroll; }

        public Double getScrollSpeed() { return scrollSpeed; }
        public void setScrollSpeed(Double scrollSpeed) { this.scrollSpeed = scrollSpeed; }

        public Boolean getShowTranslation() { return showTranslation; }
        public void setShowTranslation(Boolean showTranslation) { this.showTranslation = showTranslation; }

        public String getTranslationPosition() { return translationPosition; }
        public void setTranslationPosition(String translationPosition) { this.translationPosition = translationPosition; }

        public Boolean getShowPhonetic() { return showPhonetic; }
        public void setShowPhonetic(Boolean showPhonetic) { this.showPhonetic = showPhonetic; }

        public Boolean getShowDefinition() { return showDefinition; }
        public void setShowDefinition(Boolean showDefinition) { this.showDefinition = showDefinition; }

        public Boolean getAutoPlayAudio() { return autoPlayAudio; }
        public void setAutoPlayAudio(Boolean autoPlayAudio) { this.autoPlayAudio = autoPlayAudio; }

        public Double getAudioVolume() { return audioVolume; }
        public void setAudioVolume(Double audioVolume) { this.audioVolume = audioVolume; }

        public Boolean getTextSelection() { return textSelection; }
        public void setTextSelection(Boolean textSelection) { this.textSelection = textSelection; }

        public Boolean getDoubleClickTranslate() { return doubleClickTranslate; }
        public void setDoubleClickTranslate(Boolean doubleClickTranslate) { this.doubleClickTranslate = doubleClickTranslate; }

        public String getWordBreak() { return wordBreak; }
        public void setWordBreak(String wordBreak) { this.wordBreak = wordBreak; }

        public String getTextAlign() { return textAlign; }
        public void setTextAlign(String textAlign) { this.textAlign = textAlign; }

        public Integer getMaxWidth() { return maxWidth; }
        public void setMaxWidth(Integer maxWidth) { this.maxWidth = maxWidth; }

        public Integer getMargin() { return margin; }
        public void setMargin(Integer margin) { this.margin = margin; }
    }

    public static class UpdateReadingResponse {
        private boolean success;
        private String message;
        private SettingsGetReading.ReadingSettingsData data;

        public UpdateReadingResponse(boolean success, String message, SettingsGetReading.ReadingSettingsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public SettingsGetReading.ReadingSettingsData getData() { return data; }
        public void setData(SettingsGetReading.ReadingSettingsData data) { this.data = data; }
    }

    @PutMapping("")
    public ResponseEntity<UpdateReadingResponse> updateReadingSettings(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestBody UpdateReadingRequest request) {

        try {
            printRequest(request);

            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateReadingResponse(false, "未授权访问，请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 查询会话信息
            String sessionSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ?";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(sessionSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateReadingResponse(false, "会话已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            Integer userId = (Integer) session.get("user_id");
            LocalDateTime expiresAt = (LocalDateTime) session.get("expires_at");

            if (expiresAt.isBefore(LocalDateTime.now())) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateReadingResponse(false, "会话已过期，请重新登录", null)
                );
            }

            // 3. 验证阅读设置数据
            if (request.getTheme() != null && !isValidReadingTheme(request.getTheme())) {
                return ResponseEntity.badRequest().body(
                        new UpdateReadingResponse(false, "无效的阅读主题", null)
                );
            }

            if (request.getContrast() != null && !isValidContrast(request.getContrast())) {
                return ResponseEntity.badRequest().body(
                        new UpdateReadingResponse(false, "无效的对比度设置", null)
                );
            }

            if (request.getTranslationPosition() != null && !isValidTranslationPosition(request.getTranslationPosition())) {
                return ResponseEntity.badRequest().body(
                        new UpdateReadingResponse(false, "无效的翻译位置", null)
                );
            }

            if (request.getTextAlign() != null && !isValidTextAlign(request.getTextAlign())) {
                return ResponseEntity.badRequest().body(
                        new UpdateReadingResponse(false, "无效的文本对齐方式", null)
                );
            }

            if (request.getFontSize() != null && (request.getFontSize() < 10 || request.getFontSize() > 32)) {
                return ResponseEntity.badRequest().body(
                        new UpdateReadingResponse(false, "阅读字体大小必须在10-32之间", null)
                );
            }

            if (request.getAudioVolume() != null && (request.getAudioVolume() < 0 || request.getAudioVolume() > 1)) {
                return ResponseEntity.badRequest().body(
                        new UpdateReadingResponse(false, "音量必须在0-1之间", null)
                );
            }

            // 4. 更新阅读设置
            LocalDateTime now = LocalDateTime.now();

            // 检查并更新每个设置项
            updateReadingSetting(userId, "fontFamily", request.getFontFamily(), now);
            updateReadingSetting(userId, "fontSize", request.getFontSize() != null ? request.getFontSize().toString() : null, now);
            updateReadingSetting(userId, "lineHeight", request.getLineHeight() != null ? request.getLineHeight().toString() : null, now);
            updateReadingSetting(userId, "paragraphSpacing", request.getParagraphSpacing() != null ? request.getParagraphSpacing().toString() : null, now);
            updateReadingSetting(userId, "theme", request.getTheme(), now);
            updateReadingSetting(userId, "contrast", request.getContrast(), now);
            updateReadingSetting(userId, "highlightColor", request.getHighlightColor(), now);
            updateReadingSetting(userId, "noteColor", request.getNoteColor(), now);
            updateReadingSetting(userId, "autoScroll", request.getAutoScroll() != null ? request.getAutoScroll().toString() : null, now);
            updateReadingSetting(userId, "scrollSpeed", request.getScrollSpeed() != null ? request.getScrollSpeed().toString() : null, now);
            updateReadingSetting(userId, "showTranslation", request.getShowTranslation() != null ? request.getShowTranslation().toString() : null, now);
            updateReadingSetting(userId, "translationPosition", request.getTranslationPosition(), now);
            updateReadingSetting(userId, "showPhonetic", request.getShowPhonetic() != null ? request.getShowPhonetic().toString() : null, now);
            updateReadingSetting(userId, "showDefinition", request.getShowDefinition() != null ? request.getShowDefinition().toString() : null, now);
            updateReadingSetting(userId, "autoPlayAudio", request.getAutoPlayAudio() != null ? request.getAutoPlayAudio().toString() : null, now);
            updateReadingSetting(userId, "audioVolume", request.getAudioVolume() != null ? request.getAudioVolume().toString() : null, now);
            updateReadingSetting(userId, "textSelection", request.getTextSelection() != null ? request.getTextSelection().toString() : null, now);
            updateReadingSetting(userId, "doubleClickTranslate", request.getDoubleClickTranslate() != null ? request.getDoubleClickTranslate().toString() : null, now);
            updateReadingSetting(userId, "wordBreak", request.getWordBreak(), now);
            updateReadingSetting(userId, "textAlign", request.getTextAlign(), now);
            updateReadingSetting(userId, "maxWidth", request.getMaxWidth() != null ? request.getMaxWidth().toString() : null, now);
            updateReadingSetting(userId, "margin", request.getMargin() != null ? request.getMargin().toString() : null, now);

            // 5. 查询更新后的设置
            String settingsSql = "SELECT setting_key, setting_value, created_at, updated_at FROM user_settings WHERE user_id = ? AND setting_type = 'reading'";
            List<Map<String, Object>> settingsList = jdbcTemplate.queryForList(settingsSql, userId);
            printQueryResult(settingsList);

            // 6. 构建响应数据
            SettingsGetReading.ReadingSettingsData settingsData = new SettingsGetReading.ReadingSettingsData();

            for (Map<String, Object> setting : settingsList) {
                String key = (String) setting.get("setting_key");
                String value = (String) setting.get("setting_value");

                switch (key) {
                    case "fontFamily":
                        settingsData.setFontFamily(value);
                        break;
                    case "fontSize":
                        try {
                            settingsData.setFontSize(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setFontSize(16);
                        }
                        break;
                    case "lineHeight":
                        try {
                            settingsData.setLineHeight(Double.parseDouble(value));
                        } catch (NumberFormatException e) {
                            settingsData.setLineHeight(1.6);
                        }
                        break;
                    case "paragraphSpacing":
                        try {
                            settingsData.setParagraphSpacing(Double.parseDouble(value));
                        } catch (NumberFormatException e) {
                            settingsData.setParagraphSpacing(1.2);
                        }
                        break;
                    case "theme":
                        settingsData.setTheme(value);
                        break;
                    case "contrast":
                        settingsData.setContrast(value);
                        break;
                    case "highlightColor":
                        settingsData.setHighlightColor(value);
                        break;
                    case "noteColor":
                        settingsData.setNoteColor(value);
                        break;
                    case "autoScroll":
                        settingsData.setAutoScroll("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "scrollSpeed":
                        try {
                            settingsData.setScrollSpeed(Double.parseDouble(value));
                        } catch (NumberFormatException e) {
                            settingsData.setScrollSpeed(1.0);
                        }
                        break;
                    case "showTranslation":
                        settingsData.setShowTranslation("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "translationPosition":
                        settingsData.setTranslationPosition(value);
                        break;
                    case "showPhonetic":
                        settingsData.setShowPhonetic("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "showDefinition":
                        settingsData.setShowDefinition("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "autoPlayAudio":
                        settingsData.setAutoPlayAudio("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "audioVolume":
                        try {
                            settingsData.setAudioVolume(Double.parseDouble(value));
                        } catch (NumberFormatException e) {
                            settingsData.setAudioVolume(0.7);
                        }
                        break;
                    case "textSelection":
                        settingsData.setTextSelection("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "doubleClickTranslate":
                        settingsData.setDoubleClickTranslate("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "wordBreak":
                        settingsData.setWordBreak(value);
                        break;
                    case "textAlign":
                        settingsData.setTextAlign(value);
                        break;
                    case "maxWidth":
                        try {
                            settingsData.setMaxWidth(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setMaxWidth(800);
                        }
                        break;
                    case "margin":
                        try {
                            settingsData.setMargin(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setMargin(20);
                        }
                        break;
                }
            }

            // 7. 准备响应
            UpdateReadingResponse response = new UpdateReadingResponse(true, "阅读设置更新成功", settingsData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("更新阅读设置过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdateReadingResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private void updateReadingSetting(Integer userId, String key, String value, LocalDateTime now) {
        if (value != null) {
            // 检查设置是否存在
            String checkSql = "SELECT setting_id FROM user_settings WHERE user_id = ? AND setting_type = 'reading' AND setting_key = ?";
            List<Map<String, Object>> existing = jdbcTemplate.queryForList(checkSql, userId, key);

            if (existing.isEmpty()) {
                // 插入新设置
                String insertSql = "INSERT INTO user_settings (user_id, setting_type, setting_key, setting_value, created_at, updated_at) VALUES (?, 'reading', ?, ?, ?, ?)";
                jdbcTemplate.update(insertSql, userId, key, value, now, now);
            } else {
                // 更新现有设置
                String updateSql = "UPDATE user_settings SET setting_value = ?, updated_at = ? WHERE user_id = ? AND setting_type = 'reading' AND setting_key = ?";
                jdbcTemplate.update(updateSql, value, now, userId, key);
            }
        }
    }

    private boolean isValidReadingTheme(String theme) {
        return theme.equals("light") || theme.equals("dark") || theme.equals("sepia") || theme.equals("night");
    }

    private boolean isValidContrast(String contrast) {
        return contrast.equals("normal") || contrast.equals("high") || contrast.equals("low");
    }

    private boolean isValidTranslationPosition(String position) {
        return position.equals("inline") || position.equals("sidebar") || position.equals("popup");
    }

    private boolean isValidTextAlign(String align) {
        return align.equals("left") || align.equals("right") || align.equals("center") || align.equals("justify");
    }
}

--- 结束文件: SettingsUpdateReading.java ---

--- 开始文件: SettingsUpdateReview.java ---
package com.vue.readingapp.settings;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user/settings/review")
public class SettingsUpdateReview {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到更新复习设置请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class UpdateReviewRequest {
        private Integer dailyGoal;
        private String reviewTime;
        private Boolean reminderEnabled;
        private String reminderTime;
        private String difficultyAlgorithm;
        private Integer newWordsPerDay;
        private Integer reviewWordsPerDay;
        private Boolean autoGenerateReviews;
        private ReviewIntervalRequest reviewInterval;
        private Boolean showExamples;
        private Boolean showImages;
        private Boolean autoPlayAudioInReview;
        private Boolean shuffleQuestions;
        private Boolean enableStreak;
        private Integer streakGoal;
        private Boolean enableNotifications;

        // Getters and Setters
        public Integer getDailyGoal() { return dailyGoal; }
        public void setDailyGoal(Integer dailyGoal) { this.dailyGoal = dailyGoal; }

        public String getReviewTime() { return reviewTime; }
        public void setReviewTime(String reviewTime) { this.reviewTime = reviewTime; }

        public Boolean getReminderEnabled() { return reminderEnabled; }
        public void setReminderEnabled(Boolean reminderEnabled) { this.reminderEnabled = reminderEnabled; }

        public String getReminderTime() { return reminderTime; }
        public void setReminderTime(String reminderTime) { this.reminderTime = reminderTime; }

        public String getDifficultyAlgorithm() { return difficultyAlgorithm; }
        public void setDifficultyAlgorithm(String difficultyAlgorithm) { this.difficultyAlgorithm = difficultyAlgorithm; }

        public Integer getNewWordsPerDay() { return newWordsPerDay; }
        public void setNewWordsPerDay(Integer newWordsPerDay) { this.newWordsPerDay = newWordsPerDay; }

        public Integer getReviewWordsPerDay() { return reviewWordsPerDay; }
        public void setReviewWordsPerDay(Integer reviewWordsPerDay) { this.reviewWordsPerDay = reviewWordsPerDay; }

        public Boolean getAutoGenerateReviews() { return autoGenerateReviews; }
        public void setAutoGenerateReviews(Boolean autoGenerateReviews) { this.autoGenerateReviews = autoGenerateReviews; }

        public ReviewIntervalRequest getReviewInterval() { return reviewInterval; }
        public void setReviewInterval(ReviewIntervalRequest reviewInterval) { this.reviewInterval = reviewInterval; }

        public Boolean getShowExamples() { return showExamples; }
        public void setShowExamples(Boolean showExamples) { this.showExamples = showExamples; }

        public Boolean getShowImages() { return showImages; }
        public void setShowImages(Boolean showImages) { this.showImages = showImages; }

        public Boolean getAutoPlayAudioInReview() { return autoPlayAudioInReview; }
        public void setAutoPlayAudioInReview(Boolean autoPlayAudioInReview) { this.autoPlayAudioInReview = autoPlayAudioInReview; }

        public Boolean getShuffleQuestions() { return shuffleQuestions; }
        public void setShuffleQuestions(Boolean shuffleQuestions) { this.shuffleQuestions = shuffleQuestions; }

        public Boolean getEnableStreak() { return enableStreak; }
        public void setEnableStreak(Boolean enableStreak) { this.enableStreak = enableStreak; }

        public Integer getStreakGoal() { return streakGoal; }
        public void setStreakGoal(Integer streakGoal) { this.streakGoal = streakGoal; }

        public Boolean getEnableNotifications() { return enableNotifications; }
        public void setEnableNotifications(Boolean enableNotifications) { this.enableNotifications = enableNotifications; }
    }

    public static class ReviewIntervalRequest {
        private Integer again;
        private Integer hard;
        private Integer good;
        private Integer easy;

        public Integer getAgain() { return again; }
        public void setAgain(Integer again) { this.again = again; }

        public Integer getHard() { return hard; }
        public void setHard(Integer hard) { this.hard = hard; }

        public Integer getGood() { return good; }
        public void setGood(Integer good) { this.good = good; }

        public Integer getEasy() { return easy; }
        public void setEasy(Integer easy) { this.easy = easy; }
    }

    public static class UpdateReviewResponse {
        private boolean success;
        private String message;
        private SettingsGetReview.ReviewSettingsData data;

        public UpdateReviewResponse(boolean success, String message, SettingsGetReview.ReviewSettingsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public SettingsGetReview.ReviewSettingsData getData() { return data; }
        public void setData(SettingsGetReview.ReviewSettingsData data) { this.data = data; }
    }

    @PutMapping("")
    public ResponseEntity<UpdateReviewResponse> updateReviewSettings(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestBody UpdateReviewRequest request) {

        try {
            printRequest(request);

            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateReviewResponse(false, "未授权访问，请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 查询会话信息
            String sessionSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ?";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(sessionSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateReviewResponse(false, "会话已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            Integer userId = (Integer) session.get("user_id");
            LocalDateTime expiresAt = (LocalDateTime) session.get("expires_at");

            if (expiresAt.isBefore(LocalDateTime.now())) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateReviewResponse(false, "会话已过期，请重新登录", null)
                );
            }

            // 3. 验证复习设置数据
            if (request.getDifficultyAlgorithm() != null && !isValidAlgorithm(request.getDifficultyAlgorithm())) {
                return ResponseEntity.badRequest().body(
                        new UpdateReviewResponse(false, "无效的复习算法", null)
                );
            }

            if (request.getDailyGoal() != null && (request.getDailyGoal() < 1 || request.getDailyGoal() > 200)) {
                return ResponseEntity.badRequest().body(
                        new UpdateReviewResponse(false, "每日目标必须在1-200之间", null)
                );
            }

            if (request.getNewWordsPerDay() != null && (request.getNewWordsPerDay() < 0 || request.getNewWordsPerDay() > 100)) {
                return ResponseEntity.badRequest().body(
                        new UpdateReviewResponse(false, "每日新词数量必须在0-100之间", null)
                );
            }

            // 验证时间格式
            if (request.getReviewTime() != null && !isValidTimeFormat(request.getReviewTime())) {
                return ResponseEntity.badRequest().body(
                        new UpdateReviewResponse(false, "无效的复习时间格式，请使用HH:MM格式", null)
                );
            }

            if (request.getReminderTime() != null && !isValidTimeFormat(request.getReminderTime())) {
                return ResponseEntity.badRequest().body(
                        new UpdateReviewResponse(false, "无效的提醒时间格式，请使用HH:MM格式", null)
                );
            }

            // 4. 更新复习设置
            LocalDateTime now = LocalDateTime.now();

            // 更新基本设置
            updateReviewSetting(userId, "dailyGoal", request.getDailyGoal() != null ? request.getDailyGoal().toString() : null, now);
            updateReviewSetting(userId, "reviewTime", request.getReviewTime(), now);
            updateReviewSetting(userId, "reminderEnabled", request.getReminderEnabled() != null ? request.getReminderEnabled().toString() : null, now);
            updateReviewSetting(userId, "reminderTime", request.getReminderTime(), now);
            updateReviewSetting(userId, "difficultyAlgorithm", request.getDifficultyAlgorithm(), now);
            updateReviewSetting(userId, "newWordsPerDay", request.getNewWordsPerDay() != null ? request.getNewWordsPerDay().toString() : null, now);
            updateReviewSetting(userId, "reviewWordsPerDay", request.getReviewWordsPerDay() != null ? request.getReviewWordsPerDay().toString() : null, now);
            updateReviewSetting(userId, "autoGenerateReviews", request.getAutoGenerateReviews() != null ? request.getAutoGenerateReviews().toString() : null, now);
            updateReviewSetting(userId, "showExamples", request.getShowExamples() != null ? request.getShowExamples().toString() : null, now);
            updateReviewSetting(userId, "showImages", request.getShowImages() != null ? request.getShowImages().toString() : null, now);
            updateReviewSetting(userId, "autoPlayAudioInReview", request.getAutoPlayAudioInReview() != null ? request.getAutoPlayAudioInReview().toString() : null, now);
            updateReviewSetting(userId, "shuffleQuestions", request.getShuffleQuestions() != null ? request.getShuffleQuestions().toString() : null, now);
            updateReviewSetting(userId, "enableStreak", request.getEnableStreak() != null ? request.getEnableStreak().toString() : null, now);
            updateReviewSetting(userId, "streakGoal", request.getStreakGoal() != null ? request.getStreakGoal().toString() : null, now);
            updateReviewSetting(userId, "enableNotifications", request.getEnableNotifications() != null ? request.getEnableNotifications().toString() : null, now);

            // 更新复习间隔设置
            if (request.getReviewInterval() != null) {
                ReviewIntervalRequest interval = request.getReviewInterval();
                updateReviewSetting(userId, "reviewInterval_again", interval.getAgain() != null ? interval.getAgain().toString() : null, now);
                updateReviewSetting(userId, "reviewInterval_hard", interval.getHard() != null ? interval.getHard().toString() : null, now);
                updateReviewSetting(userId, "reviewInterval_good", interval.getGood() != null ? interval.getGood().toString() : null, now);
                updateReviewSetting(userId, "reviewInterval_easy", interval.getEasy() != null ? interval.getEasy().toString() : null, now);
            }

            // 5. 查询更新后的设置
            String settingsSql = "SELECT setting_key, setting_value, created_at, updated_at FROM user_settings WHERE user_id = ? AND setting_type = 'review'";
            List<Map<String, Object>> settingsList = jdbcTemplate.queryForList(settingsSql, userId);
            printQueryResult(settingsList);

            // 6. 构建响应数据
            SettingsGetReview.ReviewSettingsData settingsData = new SettingsGetReview.ReviewSettingsData();
            SettingsGetReview.ReviewInterval interval = new SettingsGetReview.ReviewInterval();

            for (Map<String, Object> setting : settingsList) {
                String key = (String) setting.get("setting_key");
                String value = (String) setting.get("setting_value");

                switch (key) {
                    case "dailyGoal":
                        try {
                            settingsData.setDailyGoal(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setDailyGoal(20);
                        }
                        break;
                    case "reviewTime":
                        settingsData.setReviewTime(value);
                        break;
                    case "reminderEnabled":
                        settingsData.setReminderEnabled("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "reminderTime":
                        settingsData.setReminderTime(value);
                        break;
                    case "difficultyAlgorithm":
                        settingsData.setDifficultyAlgorithm(value);
                        break;
                    case "newWordsPerDay":
                        try {
                            settingsData.setNewWordsPerDay(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setNewWordsPerDay(10);
                        }
                        break;
                    case "reviewWordsPerDay":
                        try {
                            settingsData.setReviewWordsPerDay(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setReviewWordsPerDay(50);
                        }
                        break;
                    case "autoGenerateReviews":
                        settingsData.setAutoGenerateReviews("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "reviewInterval_again":
                        try {
                            interval.setAgain(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            interval.setAgain(1);
                        }
                        break;
                    case "reviewInterval_hard":
                        try {
                            interval.setHard(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            interval.setHard(10);
                        }
                        break;
                    case "reviewInterval_good":
                        try {
                            interval.setGood(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            interval.setGood(1);
                        }
                        break;
                    case "reviewInterval_easy":
                        try {
                            interval.setEasy(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            interval.setEasy(3);
                        }
                        break;
                    case "showExamples":
                        settingsData.setShowExamples("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "showImages":
                        settingsData.setShowImages("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "autoPlayAudioInReview":
                        settingsData.setAutoPlayAudioInReview("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "shuffleQuestions":
                        settingsData.setShuffleQuestions("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "enableStreak":
                        settingsData.setEnableStreak("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "streakGoal":
                        try {
                            settingsData.setStreakGoal(Integer.parseInt(value));
                        } catch (NumberFormatException e) {
                            settingsData.setStreakGoal(7);
                        }
                        break;
                    case "enableNotifications":
                        settingsData.setEnableNotifications("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                }
            }

            settingsData.setReviewInterval(interval);

            // 7. 准备响应
            UpdateReviewResponse response = new UpdateReviewResponse(true, "复习设置更新成功", settingsData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("更新复习设置过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdateReviewResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private void updateReviewSetting(Integer userId, String key, String value, LocalDateTime now) {
        if (value != null) {
            // 检查设置是否存在
            String checkSql = "SELECT setting_id FROM user_settings WHERE user_id = ? AND setting_type = 'review' AND setting_key = ?";
            List<Map<String, Object>> existing = jdbcTemplate.queryForList(checkSql, userId, key);

            if (existing.isEmpty()) {
                // 插入新设置
                String insertSql = "INSERT INTO user_settings (user_id, setting_type, setting_key, setting_value, created_at, updated_at) VALUES (?, 'review', ?, ?, ?, ?)";
                jdbcTemplate.update(insertSql, userId, key, value, now, now);
            } else {
                // 更新现有设置
                String updateSql = "UPDATE user_settings SET setting_value = ?, updated_at = ? WHERE user_id = ? AND setting_type = 'review' AND setting_key = ?";
                jdbcTemplate.update(updateSql, value, now, userId, key);
            }
        }
    }

    private boolean isValidAlgorithm(String algorithm) {
        return algorithm.equals("sm2") || algorithm.equals("fsrs") || algorithm.equals("custom");
    }

    private boolean isValidTimeFormat(String time) {
        return time.matches("^([01]?[0-9]|2[0-3]):[0-5][0-9]$");
    }
}

--- 结束文件: SettingsUpdateReview.java ---

--- 开始文件: SettingsUpdateTheme.java ---
package com.vue.readingapp.settings;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;
import java.util.List;

@RestController
@RequestMapping("/api/v1/user/settings/theme")
public class SettingsUpdateTheme {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    private void printRequest(Object request) {
        System.out.println("=== 收到更新主题设置请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("========================");
    }

    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    public static class UpdateThemeRequest {
        private String theme;
        private String primaryColor;
        private String secondaryColor;
        private String backgroundColor;
        private String textColor;
        private String accentColor;
        private Boolean darkMode;
        private Boolean autoSwitchTheme;
        private String themeSchedule;

        // Getters and Setters
        public String getTheme() { return theme; }
        public void setTheme(String theme) { this.theme = theme; }

        public String getPrimaryColor() { return primaryColor; }
        public void setPrimaryColor(String primaryColor) { this.primaryColor = primaryColor; }

        public String getSecondaryColor() { return secondaryColor; }
        public void setSecondaryColor(String secondaryColor) { this.secondaryColor = secondaryColor; }

        public String getBackgroundColor() { return backgroundColor; }
        public void setBackgroundColor(String backgroundColor) { this.backgroundColor = backgroundColor; }

        public String getTextColor() { return textColor; }
        public void setTextColor(String textColor) { this.textColor = textColor; }

        public String getAccentColor() { return accentColor; }
        public void setAccentColor(String accentColor) { this.accentColor = accentColor; }

        public Boolean getDarkMode() { return darkMode; }
        public void setDarkMode(Boolean darkMode) { this.darkMode = darkMode; }

        public Boolean getAutoSwitchTheme() { return autoSwitchTheme; }
        public void setAutoSwitchTheme(Boolean autoSwitchTheme) { this.autoSwitchTheme = autoSwitchTheme; }

        public String getThemeSchedule() { return themeSchedule; }
        public void setThemeSchedule(String themeSchedule) { this.themeSchedule = themeSchedule; }
    }

    public static class UpdateThemeResponse {
        private boolean success;
        private String message;
        private SettingsGetTheme.ThemeSettingsData data;

        public UpdateThemeResponse(boolean success, String message, SettingsGetTheme.ThemeSettingsData data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public SettingsGetTheme.ThemeSettingsData getData() { return data; }
        public void setData(SettingsGetTheme.ThemeSettingsData data) { this.data = data; }
    }

    @PutMapping("")
    public ResponseEntity<UpdateThemeResponse> updateThemeSettings(
            @RequestHeader(value = "Authorization", required = false) String authHeader,
            @RequestBody UpdateThemeRequest request) {

        try {
            printRequest(request);

            // 1. 验证token
            if (authHeader == null || !authHeader.startsWith("Bearer ")) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateThemeResponse(false, "未授权访问，请先登录", null)
                );
            }

            String accessToken = authHeader.substring(7);

            // 2. 查询会话信息
            String sessionSql = "SELECT user_id, expires_at FROM user_sessions WHERE access_token = ?";
            List<Map<String, Object>> sessions = jdbcTemplate.queryForList(sessionSql, accessToken);

            if (sessions.isEmpty()) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateThemeResponse(false, "会话已过期，请重新登录", null)
                );
            }

            Map<String, Object> session = sessions.get(0);
            Integer userId = (Integer) session.get("user_id");
            LocalDateTime expiresAt = (LocalDateTime) session.get("expires_at");

            if (expiresAt.isBefore(LocalDateTime.now())) {
                return ResponseEntity.status(HttpStatus.UNAUTHORIZED).body(
                        new UpdateThemeResponse(false, "会话已过期，请重新登录", null)
                );
            }

            // 3. 验证主题设置数据
            if (request.getTheme() != null && !isValidTheme(request.getTheme())) {
                return ResponseEntity.badRequest().body(
                        new UpdateThemeResponse(false, "无效的主题设置", null)
                );
            }

            // 验证颜色格式（简单的16进制颜色验证）
            if (request.getPrimaryColor() != null && !isValidColor(request.getPrimaryColor())) {
                return ResponseEntity.badRequest().body(
                        new UpdateThemeResponse(false, "无效的主颜色格式", null)
                );
            }

            if (request.getSecondaryColor() != null && !isValidColor(request.getSecondaryColor())) {
                return ResponseEntity.badRequest().body(
                        new UpdateThemeResponse(false, "无效的次颜色格式", null)
                );
            }

            if (request.getBackgroundColor() != null && !isValidColor(request.getBackgroundColor())) {
                return ResponseEntity.badRequest().body(
                        new UpdateThemeResponse(false, "无效的背景颜色格式", null)
                );
            }

            if (request.getTextColor() != null && !isValidColor(request.getTextColor())) {
                return ResponseEntity.badRequest().body(
                        new UpdateThemeResponse(false, "无效的文本颜色格式", null)
                );
            }

            if (request.getAccentColor() != null && !isValidColor(request.getAccentColor())) {
                return ResponseEntity.badRequest().body(
                        new UpdateThemeResponse(false, "无效的强调颜色格式", null)
                );
            }

            // 4. 更新主题设置
            LocalDateTime now = LocalDateTime.now();

            updateThemeSetting(userId, "theme", request.getTheme(), now);
            updateThemeSetting(userId, "primaryColor", request.getPrimaryColor(), now);
            updateThemeSetting(userId, "secondaryColor", request.getSecondaryColor(), now);
            updateThemeSetting(userId, "backgroundColor", request.getBackgroundColor(), now);
            updateThemeSetting(userId, "textColor", request.getTextColor(), now);
            updateThemeSetting(userId, "accentColor", request.getAccentColor(), now);
            updateThemeSetting(userId, "darkMode", request.getDarkMode() != null ? request.getDarkMode().toString() : null, now);
            updateThemeSetting(userId, "autoSwitchTheme", request.getAutoSwitchTheme() != null ? request.getAutoSwitchTheme().toString() : null, now);
            updateThemeSetting(userId, "themeSchedule", request.getThemeSchedule(), now);

            // 5. 查询更新后的设置
            String settingsSql = "SELECT setting_key, setting_value, created_at, updated_at FROM user_settings WHERE user_id = ? AND setting_type = 'theme'";
            List<Map<String, Object>> settingsList = jdbcTemplate.queryForList(settingsSql, userId);
            printQueryResult(settingsList);

            // 6. 构建响应数据
            SettingsGetTheme.ThemeSettingsData settingsData = new SettingsGetTheme.ThemeSettingsData();

            for (Map<String, Object> setting : settingsList) {
                String key = (String) setting.get("setting_key");
                String value = (String) setting.get("setting_value");

                switch (key) {
                    case "theme":
                        settingsData.setTheme(value);
                        break;
                    case "primaryColor":
                        settingsData.setPrimaryColor(value);
                        break;
                    case "secondaryColor":
                        settingsData.setSecondaryColor(value);
                        break;
                    case "backgroundColor":
                        settingsData.setBackgroundColor(value);
                        break;
                    case "textColor":
                        settingsData.setTextColor(value);
                        break;
                    case "accentColor":
                        settingsData.setAccentColor(value);
                        break;
                    case "darkMode":
                        settingsData.setDarkMode("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "autoSwitchTheme":
                        settingsData.setAutoSwitchTheme("true".equalsIgnoreCase(value) || "1".equals(value));
                        break;
                    case "themeSchedule":
                        settingsData.setThemeSchedule(value);
                        break;
                }
            }

            // 7. 准备响应
            UpdateThemeResponse response = new UpdateThemeResponse(true, "主题设置更新成功", settingsData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("更新主题设置过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdateThemeResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }

    private void updateThemeSetting(Integer userId, String key, String value, LocalDateTime now) {
        if (value != null) {
            // 检查设置是否存在
            String checkSql = "SELECT setting_id FROM user_settings WHERE user_id = ? AND setting_type = 'theme' AND setting_key = ?";
            List<Map<String, Object>> existing = jdbcTemplate.queryForList(checkSql, userId, key);

            if (existing.isEmpty()) {
                // 插入新设置
                String insertSql = "INSERT INTO user_settings (user_id, setting_type, setting_key, setting_value, created_at, updated_at) VALUES (?, 'theme', ?, ?, ?, ?)";
                jdbcTemplate.update(insertSql, userId, key, value, now, now);
            } else {
                // 更新现有设置
                String updateSql = "UPDATE user_settings SET setting_value = ?, updated_at = ? WHERE user_id = ? AND setting_type = 'theme' AND setting_key = ?";
                jdbcTemplate.update(updateSql, value, now, userId, key);
            }
        }
    }

    private boolean isValidTheme(String theme) {
        return theme.equals("light") || theme.equals("dark") || theme.equals("auto") ||
                theme.equals("sepia") || theme.equals("night");
    }

    private boolean isValidColor(String color) {
        // 简单的16进制颜色验证，支持 #RGB, #RRGGBB, #RRGGBBAA 格式
        return color.matches("^#([A-Fa-f0-9]{3}|[A-Fa-f0-9]{6}|[A-Fa-f0-9]{8})$");
    }
}

--- 结束文件: SettingsUpdateTheme.java ---

