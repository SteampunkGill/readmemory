--- 开始文件: TagAddToDocument.java ---
package com.vue.readingapp.tags;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.support.GeneratedKeyHolder;
import org.springframework.jdbc.support.KeyHolder;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.PreparedStatement;
import java.sql.Statement;
import java.sql.Timestamp;
import java.time.LocalDateTime;
import java.util.Map;

@RestController
@RequestMapping("/api/v1/documents")
public class TagAddToDocument {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到为文档添加标签请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("===========================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应类
    public static class AddTagToDocumentResponse {
        private boolean success;
        private String message;

        public AddTagToDocumentResponse(boolean success, String message) {
            this.success = success;
            this.message = message;
        }

        // Getters and Setters
        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }
    }

    @PostMapping("/{documentId}/tags/{tagId}")
    public ResponseEntity<AddTagToDocumentResponse> addTagToDocument(
            @PathVariable("documentId") String documentId,
            @PathVariable("tagId") String tagId) {

        Map<String, Object> requestData = new java.util.HashMap<>();
        requestData.put("documentId", documentId);
        requestData.put("tagId", tagId);
        printRequest(requestData);

        try {
            // 验证文档是否存在
            String checkDocumentSql = "SELECT COUNT(*) FROM documents WHERE document_id = ?";
            int documentCount = jdbcTemplate.queryForObject(checkDocumentSql, Integer.class, Integer.parseInt(documentId));
            if (documentCount == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new AddTagToDocumentResponse(false, "文档不存在")
                );
            }

            // 验证标签是否存在（在document_tags中）
            String checkTagSql = "SELECT COUNT(*) FROM document_tags WHERE tag_id = ?";
            int tagCount = jdbcTemplate.queryForObject(checkTagSql, Integer.class, Integer.parseInt(tagId));
            if (tagCount == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new AddTagToDocumentResponse(false, "标签不存在")
                );
            }

            // 检查是否已经存在该关系
            String checkRelationSql = "SELECT COUNT(*) FROM document_tag_relations WHERE document_id = ? AND tag_id = ?";
            int relationCount = jdbcTemplate.queryForObject(checkRelationSql, Integer.class,
                    Integer.parseInt(documentId), Integer.parseInt(tagId));

            if (relationCount > 0) {
                return ResponseEntity.status(HttpStatus.CONFLICT).body(
                        new AddTagToDocumentResponse(false, "该标签已经添加到文档")
                );
            }

            // 添加标签到文档
            LocalDateTime now = LocalDateTime.now();
            Timestamp timestamp = Timestamp.valueOf(now);

            String insertSql = "INSERT INTO document_tag_relations (document_id, tag_id, created_at) VALUES (?, ?, ?)";

            KeyHolder keyHolder = new GeneratedKeyHolder();
            jdbcTemplate.update(connection -> {
                PreparedStatement ps = connection.prepareStatement(insertSql, Statement.RETURN_GENERATED_KEYS);
                ps.setInt(1, Integer.parseInt(documentId));
                ps.setInt(2, Integer.parseInt(tagId));
                ps.setTimestamp(3, timestamp);
                return ps;
            }, keyHolder);

            // 创建响应
            AddTagToDocumentResponse response = new AddTagToDocumentResponse(true, "标签添加成功");
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (NumberFormatException e) {
            System.err.println("ID格式错误: " + e.getMessage());
            return ResponseEntity.badRequest().body(
                    new AddTagToDocumentResponse(false, "ID格式错误")
            );
        } catch (Exception e) {
            System.err.println("为文档添加标签过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new AddTagToDocumentResponse(false, "服务器内部错误: " + e.getMessage())
            );
        }
    }
}

--- 结束文件: TagAddToDocument.java ---

--- 开始文件: TagBatchDocumentTags.java ---
package com.vue.readingapp.tags;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/v1/tags/document/batch")
public class TagBatchDocumentTags {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到批量文档标签操作请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=============================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class BatchDocumentTagsRequest {
        private List<String> tagIds;
        private String operation; // delete, update, etc.
        private Map<String, Object> data;

        // Getters and Setters
        public List<String> getTagIds() { return tagIds; }
        public void setTagIds(List<String> tagIds) { this.tagIds = tagIds; }

        public String getOperation() { return operation; }
        public void setOperation(String operation) { this.operation = operation; }

        public Map<String, Object> getData() { return data; }
        public void setData(Map<String, Object> data) { this.data = data; }
    }

    // 响应类
    public static class BatchDocumentTagsResponse {
        private boolean success;
        private String message;
        private int processedCount;
        private int failedCount;

        public BatchDocumentTagsResponse(boolean success, String message, int processedCount, int failedCount) {
            this.success = success;
            this.message = message;
            this.processedCount = processedCount;
            this.failedCount = failedCount;
        }

        // Getters and Setters
        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public int getProcessedCount() { return processedCount; }
        public void setProcessedCount(int processedCount) { this.processedCount = processedCount; }

        public int getFailedCount() { return failedCount; }
        public void setFailedCount(int failedCount) { this.failedCount = failedCount; }
    }

    @PostMapping("/")
    public ResponseEntity<BatchDocumentTagsResponse> batchDocumentTags(@RequestBody BatchDocumentTagsRequest request) {
        printRequest(request);

        try {
            // 验证请求数据
            if (request.getTagIds() == null || request.getTagIds().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new BatchDocumentTagsResponse(false, "标签ID列表不能为空", 0, 0)
                );
            }

            if (request.getOperation() == null || request.getOperation().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new BatchDocumentTagsResponse(false, "操作类型不能为空", 0, 0)
                );
            }

            int processedCount = 0;
            int failedCount = 0;

            // 根据操作类型处理
            switch (request.getOperation().toLowerCase()) {
                case "delete":
                    // 批量删除标签
                    for (String tagId : request.getTagIds()) {
                        try {
                            // 检查标签是否被使用
                            String usageCheckSql = "SELECT COUNT(*) FROM document_tag_relations WHERE tag_id = ?";
                            int usageCount = jdbcTemplate.queryForObject(usageCheckSql, Integer.class, Integer.parseInt(tagId));

                            if (usageCount > 0) {
                                failedCount++;
                                continue;
                            }

                            // 删除标签
                            String deleteSql = "DELETE FROM document_tags WHERE tag_id = ?";
                            int deleted = jdbcTemplate.update(deleteSql, Integer.parseInt(tagId));

                            if (deleted > 0) {
                                processedCount++;
                            } else {
                                failedCount++;
                            }
                        } catch (Exception e) {
                            failedCount++;
                            System.err.println("删除标签 " + tagId + " 时发生错误: " + e.getMessage());
                        }
                    }
                    break;

                case "update":
                    // 批量更新标签
                    if (request.getData() == null) {
                        return ResponseEntity.badRequest().body(
                                new BatchDocumentTagsResponse(false, "更新数据不能为空", 0, 0)
                        );
                    }

                    String newName = (String) request.getData().get("name");
                    String newColor = (String) request.getData().get("color");
                    String newDescription = (String) request.getData().get("description");

                    for (String tagId : request.getTagIds()) {
                        try {
                            // 检查标签是否存在
                            String checkSql = "SELECT COUNT(*) FROM document_tags WHERE tag_id = ?";
                            int count = jdbcTemplate.queryForObject(checkSql, Integer.class, Integer.parseInt(tagId));

                            if (count == 0) {
                                failedCount++;
                                continue;
                            }

                            // 构建更新SQL
                            StringBuilder updateSqlBuilder = new StringBuilder("UPDATE document_tags SET ");
                            java.util.List<Object> params = new java.util.ArrayList<>();

                            if (newName != null) {
                                updateSqlBuilder.append("tag_name = ?, ");
                                params.add(newName);
                            }

                            if (newColor != null) {
                                updateSqlBuilder.append("color = ?, ");
                                params.add(newColor);
                            }

                            if (newDescription != null) {
                                updateSqlBuilder.append("description = ?, ");
                                params.add(newDescription);
                            }

                            updateSqlBuilder.append("updated_at = NOW() WHERE tag_id = ?");
                            params.add(Integer.parseInt(tagId));

                            int updated = jdbcTemplate.update(updateSqlBuilder.toString(), params.toArray());

                            if (updated > 0) {
                                processedCount++;
                            } else {
                                failedCount++;
                            }
                        } catch (Exception e) {
                            failedCount++;
                            System.err.println("更新标签 " + tagId + " 时发生错误: " + e.getMessage());
                        }
                    }
                    break;

                default:
                    return ResponseEntity.badRequest().body(
                            new BatchDocumentTagsResponse(false, "不支持的操作类型: " + request.getOperation(), 0, 0)
                    );
            }

            // 创建响应
            String message = String.format("批量操作完成，成功处理 %d 个标签，失败 %d 个", processedCount, failedCount);
            BatchDocumentTagsResponse response = new BatchDocumentTagsResponse(
                    true, message, processedCount, failedCount);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("批量文档标签操作过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new BatchDocumentTagsResponse(false, "服务器内部错误: " + e.getMessage(), 0, 0)
            );
        }
    }
}

--- 结束文件: TagBatchDocumentTags.java ---

--- 开始文件: TagBatchUpdateDocument.java ---
package com.vue.readingapp.tags;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/v1/documents/tags")
public class TagBatchUpdateDocument {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到批量更新文档标签请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=============================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class BatchUpdateDocumentTagsRequest {
        private List<String> documentIds;
        private List<String> tagIds;
        private String operation; // add, remove, replace

        // Getters and Setters
        public List<String> getDocumentIds() { return documentIds; }
        public void setDocumentIds(List<String> documentIds) { this.documentIds = documentIds; }

        public List<String> getTagIds() { return tagIds; }
        public void setTagIds(List<String> tagIds) { this.tagIds = tagIds; }

        public String getOperation() { return operation; }
        public void setOperation(String operation) { this.operation = operation; }
    }

    // 响应类
    public static class BatchUpdateDocumentTagsResponse {
        private boolean success;
        private String message;
        private int updatedCount;

        public BatchUpdateDocumentTagsResponse(boolean success, String message, int updatedCount) {
            this.success = success;
            this.message = message;
            this.updatedCount = updatedCount;
        }

        // Getters and Setters
        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public int getUpdatedCount() { return updatedCount; }
        public void setUpdatedCount(int updatedCount) { this.updatedCount = updatedCount; }
    }

    @PostMapping("/batch")
    public ResponseEntity<BatchUpdateDocumentTagsResponse> batchUpdateDocumentTags(
            @RequestBody BatchUpdateDocumentTagsRequest request) {

        printRequest(request);

        try {
            // 验证请求数据
            if (request.getDocumentIds() == null || request.getDocumentIds().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new BatchUpdateDocumentTagsResponse(false, "文档ID列表不能为空", 0)
                );
            }

            if (request.getTagIds() == null || request.getTagIds().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new BatchUpdateDocumentTagsResponse(false, "标签ID列表不能为空", 0)
                );
            }

            if (request.getOperation() == null || request.getOperation().trim().isEmpty()) {
                request.setOperation("replace"); // 默认操作
            }

            int updatedCount = 0;

            // 根据操作类型处理
            switch (request.getOperation().toLowerCase()) {
                case "add":
                    // 为多个文档添加多个标签
                    for (String documentId : request.getDocumentIds()) {
                        for (String tagId : request.getTagIds()) {
                            try {
                                // 检查文档是否存在
                                String checkDocumentSql = "SELECT COUNT(*) FROM documents WHERE document_id = ?";
                                int docCount = jdbcTemplate.queryForObject(checkDocumentSql, Integer.class, Integer.parseInt(documentId));

                                // 检查标签是否存在
                                String checkTagSql = "SELECT COUNT(*) FROM document_tags WHERE tag_id = ?";
                                int tagCount = jdbcTemplate.queryForObject(checkTagSql, Integer.class, Integer.parseInt(tagId));

                                if (docCount > 0 && tagCount > 0) {
                                    // 检查是否已经存在该关系
                                    String checkRelationSql = "SELECT COUNT(*) FROM document_tag_relations WHERE document_id = ? AND tag_id = ?";
                                    int relationCount = jdbcTemplate.queryForObject(checkRelationSql, Integer.class,
                                            Integer.parseInt(documentId), Integer.parseInt(tagId));

                                    if (relationCount == 0) {
                                        // 添加关系
                                        String insertSql = "INSERT INTO document_tag_relations (document_id, tag_id, created_at) VALUES (?, ?, NOW())";
                                        jdbcTemplate.update(insertSql, Integer.parseInt(documentId), Integer.parseInt(tagId));
                                        updatedCount++;
                                    }
                                }
                            } catch (Exception e) {
                                System.err.println("为文档 " + documentId + " 添加标签 " + tagId + " 时发生错误: " + e.getMessage());
                            }
                        }
                    }
                    break;

                case "remove":
                    // 从多个文档移除多个标签
                    for (String documentId : request.getDocumentIds()) {
                        for (String tagId : request.getTagIds()) {
                            try {
                                // 检查是否存在该关系
                                String checkRelationSql = "SELECT COUNT(*) FROM document_tag_relations WHERE document_id = ? AND tag_id = ?";
                                int relationCount = jdbcTemplate.queryForObject(checkRelationSql, Integer.class,
                                        Integer.parseInt(documentId), Integer.parseInt(tagId));

                                if (relationCount > 0) {
                                    // 移除关系
                                    String deleteSql = "DELETE FROM document_tag_relations WHERE document_id = ? AND tag_id = ?";
                                    jdbcTemplate.update(deleteSql, Integer.parseInt(documentId), Integer.parseInt(tagId));
                                    updatedCount++;
                                }
                            } catch (Exception e) {
                                System.err.println("从文档 " + documentId + " 移除标签 " + tagId + " 时发生错误: " + e.getMessage());
                            }
                        }
                    }
                    break;

                case "replace":
                    // 替换多个文档的标签（先删除所有旧标签，再添加新标签）
                    for (String documentId : request.getDocumentIds()) {
                        try {
                            // 先删除文档的所有标签
                            String deleteAllSql = "DELETE FROM document_tag_relations WHERE document_id = ?";
                            jdbcTemplate.update(deleteAllSql, Integer.parseInt(documentId));

                            // 然后添加新标签
                            for (String tagId : request.getTagIds()) {
                                // 检查文档和标签是否存在
                                String checkDocumentSql = "SELECT COUNT(*) FROM documents WHERE document_id = ?";
                                int docCount = jdbcTemplate.queryForObject(checkDocumentSql, Integer.class, Integer.parseInt(documentId));

                                String checkTagSql = "SELECT COUNT(*) FROM document_tags WHERE tag_id = ?";
                                int tagCount = jdbcTemplate.queryForObject(checkTagSql, Integer.class, Integer.parseInt(tagId));

                                if (docCount > 0 && tagCount > 0) {
                                    String insertSql = "INSERT INTO document_tag_relations (document_id, tag_id, created_at) VALUES (?, ?, NOW())";
                                    jdbcTemplate.update(insertSql, Integer.parseInt(documentId), Integer.parseInt(tagId));
                                    updatedCount++;
                                }
                            }
                        } catch (Exception e) {
                            System.err.println("替换文档 " + documentId + " 的标签时发生错误: " + e.getMessage());
                        }
                    }
                    break;

                default:
                    return ResponseEntity.badRequest().body(
                            new BatchUpdateDocumentTagsResponse(false, "不支持的操作类型: " + request.getOperation(), 0)
                    );
            }

            // 创建响应
            String message = String.format("批量操作完成，成功更新 %d 个文档标签关系", updatedCount);
            BatchUpdateDocumentTagsResponse response = new BatchUpdateDocumentTagsResponse(
                    true, message, updatedCount);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("批量更新文档标签过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new BatchUpdateDocumentTagsResponse(false, "服务器内部错误: " + e.getMessage(), 0)
            );
        }
    }
}

--- 结束文件: TagBatchUpdateDocument.java ---

--- 开始文件: TagBatchVocabularyTags.java ---
package com.vue.readingapp.tags;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/v1/tags/vocabulary/batch")
public class TagBatchVocabularyTags {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到批量生词标签操作请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=============================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class BatchVocabularyTagsRequest {
        private List<String> tagIds;
        private String operation; // delete, update, etc.
        private Map<String, Object> data;

        // Getters and Setters
        public List<String> getTagIds() { return tagIds; }
        public void setTagIds(List<String> tagIds) { this.tagIds = tagIds; }

        public String getOperation() { return operation; }
        public void setOperation(String operation) { this.operation = operation; }

        public Map<String, Object> getData() { return data; }
        public void setData(Map<String, Object> data) { this.data = data; }
    }

    // 响应类
    public static class BatchVocabularyTagsResponse {
        private boolean success;
        private String message;
        private int processedCount;
        private int failedCount;

        public BatchVocabularyTagsResponse(boolean success, String message, int processedCount, int failedCount) {
            this.success = success;
            this.message = message;
            this.processedCount = processedCount;
            this.failedCount = failedCount;
        }

        // Getters and Setters
        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public int getProcessedCount() { return processedCount; }
        public void setProcessedCount(int processedCount) { this.processedCount = processedCount; }

        public int getFailedCount() { return failedCount; }
        public void setFailedCount(int failedCount) { this.failedCount = failedCount; }
    }

    @PostMapping("/")
    public ResponseEntity<BatchVocabularyTagsResponse> batchVocabularyTags(@RequestBody BatchVocabularyTagsRequest request) {
        printRequest(request);

        try {
            // 验证请求数据
            if (request.getTagIds() == null || request.getTagIds().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new BatchVocabularyTagsResponse(false, "标签ID列表不能为空", 0, 0)
                );
            }

            if (request.getOperation() == null || request.getOperation().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new BatchVocabularyTagsResponse(false, "操作类型不能为空", 0, 0)
                );
            }

            int processedCount = 0;
            int failedCount = 0;

            // 根据操作类型处理
            switch (request.getOperation().toLowerCase()) {
                case "delete":
                    // 批量删除标签
                    for (String tagId : request.getTagIds()) {
                        try {
                            // 检查标签是否被使用
                            String usageCheckSql = "SELECT COUNT(*) FROM user_vocabulary_tags WHERE tag_id = ?";
                            int usageCount = jdbcTemplate.queryForObject(usageCheckSql, Integer.class, Integer.parseInt(tagId));

                            if (usageCount > 0) {
                                failedCount++;
                                continue;
                            }

                            // 删除标签
                            String deleteSql = "DELETE FROM vocabulary_tags WHERE tag_id = ?";
                            int deleted = jdbcTemplate.update(deleteSql, Integer.parseInt(tagId));

                            if (deleted > 0) {
                                processedCount++;
                            } else {
                                failedCount++;
                            }
                        } catch (Exception e) {
                            failedCount++;
                            System.err.println("删除标签 " + tagId + " 时发生错误: " + e.getMessage());
                        }
                    }
                    break;

                case "update":
                    // 批量更新标签
                    if (request.getData() == null) {
                        return ResponseEntity.badRequest().body(
                                new BatchVocabularyTagsResponse(false, "更新数据不能为空", 0, 0)
                        );
                    }

                    String newName = (String) request.getData().get("name");
                    String newColor = (String) request.getData().get("color");
                    String newDescription = (String) request.getData().get("description");

                    for (String tagId : request.getTagIds()) {
                        try {
                            // 检查标签是否存在
                            String checkSql = "SELECT COUNT(*) FROM vocabulary_tags WHERE tag_id = ?";
                            int count = jdbcTemplate.queryForObject(checkSql, Integer.class, Integer.parseInt(tagId));

                            if (count == 0) {
                                failedCount++;
                                continue;
                            }

                            // 构建更新SQL
                            StringBuilder updateSqlBuilder = new StringBuilder("UPDATE vocabulary_tags SET ");
                            java.util.List<Object> params = new java.util.ArrayList<>();

                            if (newName != null) {
                                updateSqlBuilder.append("tag_name = ?, ");
                                params.add(newName);
                            }

                            if (newColor != null) {
                                updateSqlBuilder.append("color = ?, ");
                                params.add(newColor);
                            }

                            if (newDescription != null) {
                                updateSqlBuilder.append("description = ?, ");
                                params.add(newDescription);
                            }

                            updateSqlBuilder.append("updated_at = NOW() WHERE tag_id = ?");
                            params.add(Integer.parseInt(tagId));

                            int updated = jdbcTemplate.update(updateSqlBuilder.toString(), params.toArray());

                            if (updated > 0) {
                                processedCount++;
                            } else {
                                failedCount++;
                            }
                        } catch (Exception e) {
                            failedCount++;
                            System.err.println("更新标签 " + tagId + " 时发生错误: " + e.getMessage());
                        }
                    }
                    break;

                default:
                    return ResponseEntity.badRequest().body(
                            new BatchVocabularyTagsResponse(false, "不支持的操作类型: " + request.getOperation(), 0, 0)
                    );
            }

            // 创建响应
            String message = String.format("批量操作完成，成功处理 %d 个标签，失败 %d 个", processedCount, failedCount);
            BatchVocabularyTagsResponse response = new BatchVocabularyTagsResponse(
                    true, message, processedCount, failedCount);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("批量生词标签操作过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new BatchVocabularyTagsResponse(false, "服务器内部错误: " + e.getMessage(), 0, 0)
            );
        }
    }
}

--- 结束文件: TagBatchVocabularyTags.java ---

--- 开始文件: TagCreate.java ---
package com.vue.readingapp.tags;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.support.GeneratedKeyHolder;
import org.springframework.jdbc.support.KeyHolder;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.PreparedStatement;
import java.sql.Statement;
import java.sql.Timestamp;
import java.time.LocalDateTime;
import java.util.Map;
import java.util.HashMap;

@RestController
@RequestMapping("/api/v1/tags")
public class TagCreate {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到创建标签请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=====================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class CreateTagRequest {
        private String name;
        private String color;
        private String description;
        private String type;

        // Getters and Setters
        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }
    }

    // 标签响应DTO
    public static class Tag {
        private String id;
        private String name;
        private String color;
        private String description;
        private String type;
        private int documentCount;
        private String createdAt;
        private String updatedAt;

        // Getters and Setters
        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public int getDocumentCount() { return documentCount; }
        public void setDocumentCount(int documentCount) { this.documentCount = documentCount; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }
    }

    // 响应类
    public static class CreateTagResponse {
        private boolean success;
        private Tag data;

        public CreateTagResponse(boolean success, Tag data) {
            this.success = success;
            this.data = data;
        }

        // Getters and Setters
        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public Tag getData() { return data; }
        public void setData(Tag data) { this.data = data; }
    }

    @PostMapping("/")
    public ResponseEntity<CreateTagResponse> createTag(@RequestBody CreateTagRequest request) {
        printRequest(request);

        try {
            // 验证请求数据
            if (request.getName() == null || request.getName().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new CreateTagResponse(false, null)
                );
            }

            if (request.getType() == null || (!request.getType().equals("document") && !request.getType().equals("vocabulary"))) {
                return ResponseEntity.badRequest().body(
                        new CreateTagResponse(false, null)
                );
            }

            // 检查标签名是否已存在（在同一类型中）
            String checkSql = "";
            if ("document".equals(request.getType())) {
                checkSql = "SELECT COUNT(*) FROM document_tags WHERE tag_name = ?";
            } else {
                checkSql = "SELECT COUNT(*) FROM vocabulary_tags WHERE tag_name = ?";
            }

            int count = jdbcTemplate.queryForObject(checkSql, Integer.class, request.getName());
            if (count > 0) {
                return ResponseEntity.status(HttpStatus.CONFLICT).body(
                        new CreateTagResponse(false, null)
                );
            }

            // 插入标签
            String insertSql = "";
            String tableName = "";
            if ("document".equals(request.getType())) {
                insertSql = "INSERT INTO document_tags (tag_name, color, description, created_at, updated_at) VALUES (?, ?, ?, ?, ?)";
                tableName = "document_tags";
            } else {
                insertSql = "INSERT INTO vocabulary_tags (tag_name, color, description, created_at, updated_at) VALUES (?, ?, ?, ?, ?)";
                tableName = "vocabulary_tags";
            }

            LocalDateTime now = LocalDateTime.now();
            Timestamp timestamp = Timestamp.valueOf(now);

            KeyHolder keyHolder = new GeneratedKeyHolder();
            String finalInsertSql = insertSql;
            jdbcTemplate.update(connection -> {
                PreparedStatement ps = connection.prepareStatement(finalInsertSql, Statement.RETURN_GENERATED_KEYS);
                ps.setString(1, request.getName());
                ps.setString(2, request.getColor());
                ps.setString(3, request.getDescription());
                ps.setTimestamp(4, timestamp);
                ps.setTimestamp(5, timestamp);
                return ps;
            }, keyHolder);

            // 获取生成的ID
            Number key = keyHolder.getKey();
            if (key == null) {
                throw new RuntimeException("创建标签失败，未获取到ID");
            }
            int tagId = key.intValue();

            // 查询刚创建的标签
            String selectSql = "";
            if ("document".equals(request.getType())) {
                selectSql = "SELECT * FROM document_tags WHERE tag_id = ?";
            } else {
                selectSql = "SELECT * FROM vocabulary_tags WHERE tag_id = ?";
            }

            Map<String, Object> tagMap = jdbcTemplate.queryForMap(selectSql, tagId);

            // 构建返回的标签对象
            Tag tag = new Tag();
            tag.setId(String.valueOf(tagMap.get("tag_id")));
            tag.setName((String) tagMap.get("tag_name"));
            tag.setColor((String) tagMap.get("color"));
            tag.setDescription((String) tagMap.get("description"));
            tag.setType(request.getType());
            tag.setDocumentCount(0);
            tag.setCreatedAt(tagMap.get("created_at").toString());
            tag.setUpdatedAt(tagMap.get("updated_at").toString());

            // 创建响应
            CreateTagResponse response = new CreateTagResponse(true, tag);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("创建标签过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new CreateTagResponse(false, null)
            );
        }
    }
}

--- 结束文件: TagCreate.java ---

--- 开始文件: TagCreateDocumentTag.java ---
package com.vue.readingapp.tags;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.support.GeneratedKeyHolder;
import org.springframework.jdbc.support.KeyHolder;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.PreparedStatement;
import java.sql.Statement;
import java.sql.Timestamp;
import java.time.LocalDateTime;
import java.util.Map;

@RestController
@RequestMapping("/api/v1/tags/document")
public class TagCreateDocumentTag {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到创建文档标签请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=========================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class CreateDocumentTagRequest {
        private String name;
        private String color;
        private String description;

        // Getters and Setters
        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }
    }

    // 标签响应DTO
    public static class Tag {
        private String id;
        private String name;
        private String color;
        private String description;
        private String type;
        private int documentCount;
        private String createdAt;

        // Getters and Setters
        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public int getDocumentCount() { return documentCount; }
        public void setDocumentCount(int documentCount) { this.documentCount = documentCount; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }
    }

    // 响应类
    public static class CreateDocumentTagResponse {
        private boolean success;
        private Tag data;

        public CreateDocumentTagResponse(boolean success, Tag data) {
            this.success = success;
            this.data = data;
        }

        // Getters and Setters
        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public Tag getData() { return data; }
        public void setData(Tag data) { this.data = data; }
    }

    @PostMapping("/")
    public ResponseEntity<CreateDocumentTagResponse> createDocumentTag(@RequestBody CreateDocumentTagRequest request) {
        printRequest(request);

        try {
            // 验证请求数据
            if (request.getName() == null || request.getName().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new CreateDocumentTagResponse(false, null)
                );
            }

            // 检查标签名是否已存在
            String checkSql = "SELECT COUNT(*) FROM document_tags WHERE tag_name = ?";
            int count = jdbcTemplate.queryForObject(checkSql, Integer.class, request.getName());
            if (count > 0) {
                return ResponseEntity.status(HttpStatus.CONFLICT).body(
                        new CreateDocumentTagResponse(false, null)
                );
            }

            // 插入文档标签
            LocalDateTime now = LocalDateTime.now();
            Timestamp timestamp = Timestamp.valueOf(now);

            String insertSql = "INSERT INTO document_tags (tag_name, color, description, created_at, updated_at) VALUES (?, ?, ?, ?, ?)";

            KeyHolder keyHolder = new GeneratedKeyHolder();
            jdbcTemplate.update(connection -> {
                PreparedStatement ps = connection.prepareStatement(insertSql, Statement.RETURN_GENERATED_KEYS);
                ps.setString(1, request.getName());
                ps.setString(2, request.getColor());
                ps.setString(3, request.getDescription());
                ps.setTimestamp(4, timestamp);
                ps.setTimestamp(5, timestamp);
                return ps;
            }, keyHolder);

            // 获取生成的ID
            Number key = keyHolder.getKey();
            if (key == null) {
                throw new RuntimeException("创建文档标签失败，未获取到ID");
            }
            int tagId = key.intValue();

            // 查询刚创建的标签
            String selectSql = "SELECT * FROM document_tags WHERE tag_id = ?";
            Map<String, Object> tagMap = jdbcTemplate.queryForMap(selectSql, tagId);

            // 构建返回的标签对象
            Tag tag = new Tag();
            tag.setId(String.valueOf(tagMap.get("tag_id")));
            tag.setName((String) tagMap.get("tag_name"));
            tag.setColor((String) tagMap.get("color"));
            tag.setDescription((String) tagMap.get("description"));
            tag.setType("document");
            tag.setDocumentCount(0);
            tag.setCreatedAt(tagMap.get("created_at").toString());

            // 创建响应
            CreateDocumentTagResponse response = new CreateDocumentTagResponse(true, tag);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("创建文档标签过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new CreateDocumentTagResponse(false, null)
            );
        }
    }
}

--- 结束文件: TagCreateDocumentTag.java ---

--- 开始文件: TagCreateVocabularyTag.java ---

package com.vue.readingapp.tags;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.support.GeneratedKeyHolder;
import org.springframework.jdbc.support.KeyHolder;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.PreparedStatement;
import java.sql.Statement;
import java.sql.Timestamp;
import java.time.LocalDateTime;
import java.util.Map;

@RestController
@RequestMapping("/api/v1/tags/vocabulary")
public class TagCreateVocabularyTag {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到创建生词标签请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=========================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class CreateVocabularyTagRequest {
        private String name;
        private String color;
        private String description;

        // Getters and Setters
        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }
    }

    // 标签响应DTO
    public static class Tag {
        private String id;
        private String name;
        private String color;
        private String description;
        private String type;
        private int vocabularyCount;
        private String createdAt;

        // Getters and Setters
        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public int getVocabularyCount() { return vocabularyCount; }
        public void setVocabularyCount(int vocabularyCount) { this.vocabularyCount = vocabularyCount; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }
    }

    // 响应类
    public static class CreateVocabularyTagResponse {
        private boolean success;
        private Tag data;

        public CreateVocabularyTagResponse(boolean success, Tag data) {
            this.success = success;
            this.data = data;
        }

        // Getters and Setters
        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public Tag getData() { return data; }
        public void setData(Tag data) { this.data = data; }
    }

    @PostMapping("/")
    public ResponseEntity<CreateVocabularyTagResponse> createVocabularyTag(@RequestBody CreateVocabularyTagRequest request) {
        printRequest(request);

        try {
            // 验证请求数据
            if (request.getName() == null || request.getName().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new CreateVocabularyTagResponse(false, null)
                );
            }

            // 检查标签名是否已存在
            String checkSql = "SELECT COUNT(*) FROM vocabulary_tags WHERE tag_name = ?";
            int count = jdbcTemplate.queryForObject(checkSql, Integer.class, request.getName());
            if (count > 0) {
                return ResponseEntity.status(HttpStatus.CONFLICT).body(
                        new CreateVocabularyTagResponse(false, null)
                );
            }

            // 插入生词标签
            LocalDateTime now = LocalDateTime.now();
            Timestamp timestamp = Timestamp.valueOf(now);

            String insertSql = "INSERT INTO vocabulary_tags (tag_name, color, description, created_at, updated_at) VALUES (?, ?, ?, ?, ?)";

            KeyHolder keyHolder = new GeneratedKeyHolder();
            jdbcTemplate.update(connection -> {
                PreparedStatement ps = connection.prepareStatement(insertSql, Statement.RETURN_GENERATED_KEYS);
                ps.setString(1, request.getName());
                ps.setString(2, request.getColor());
                ps.setString(3, request.getDescription());
                ps.setTimestamp(4, timestamp);
                ps.setTimestamp(5, timestamp);
                return ps;
            }, keyHolder);

            // 获取生成的ID
            Number key = keyHolder.getKey();
            if (key == null) {
                throw new RuntimeException("创建生词标签失败，未获取到ID");
            }
            int tagId = key.intValue();

            // 查询刚创建的标签
            String selectSql = "SELECT * FROM vocabulary_tags WHERE tag_id = ?";
            Map<String, Object> tagMap = jdbcTemplate.queryForMap(selectSql, tagId);

            // 构建返回的标签对象
            Tag tag = new Tag();
            tag.setId(String.valueOf(tagMap.get("tag_id")));
            tag.setName((String) tagMap.get("tag_name"));
            tag.setColor((String) tagMap.get("color"));
            tag.setDescription((String) tagMap.get("description"));
            tag.setType("vocabulary");
            tag.setVocabularyCount(0);
            tag.setCreatedAt(tagMap.get("created_at").toString());

            // 创建响应
            CreateVocabularyTagResponse response = new CreateVocabularyTagResponse(true, tag);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("创建生词标签过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new CreateVocabularyTagResponse(false, null)
            );
        }
    }
}
--- 结束文件: TagCreateVocabularyTag.java ---

--- 开始文件: TagDelete.java ---
package com.vue.readingapp.tags;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.Map;

@RestController
@RequestMapping("/api/v1/tags")
public class TagDelete {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到删除标签请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=====================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应类
    public static class DeleteTagResponse {
        private boolean success;
        private String message;

        public DeleteTagResponse(boolean success, String message) {
            this.success = success;
            this.message = message;
        }

        // Getters and Setters
        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }
    }

    @DeleteMapping("/{tagId}")
    public ResponseEntity<DeleteTagResponse> deleteTag(
            @PathVariable("tagId") String tagId,
            @RequestParam(value = "force", defaultValue = "false") boolean force) {

        Map<String, Object> requestData = new java.util.HashMap<>();
        requestData.put("tagId", tagId);
        requestData.put("force", force);
        printRequest(requestData);

        try {
            // 先检查标签是否存在（在document_tags中）
            String checkSql = "SELECT COUNT(*) FROM document_tags WHERE tag_id = ?";
            int count = jdbcTemplate.queryForObject(checkSql, Integer.class, Integer.parseInt(tagId));

            String tableName = "document_tags";
            if (count == 0) {
                // 如果在document_tags中不存在，检查vocabulary_tags
                checkSql = "SELECT COUNT(*) FROM vocabulary_tags WHERE tag_id = ?";
                count = jdbcTemplate.queryForObject(checkSql, Integer.class, Integer.parseInt(tagId));
                if (count == 0) {
                    return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                            new DeleteTagResponse(false, "标签不存在")
                    );
                }
                tableName = "vocabulary_tags";
            }

            // 检查标签是否被使用
            String usageCheckSql = "";
            if ("document_tags".equals(tableName)) {
                usageCheckSql = "SELECT COUNT(*) FROM document_tag_relations WHERE tag_id = ?";
            } else {
                usageCheckSql = "SELECT COUNT(*) FROM user_vocabulary_tags WHERE tag_id = ?";
            }

            int usageCount = jdbcTemplate.queryForObject(usageCheckSql, Integer.class, Integer.parseInt(tagId));

            // 如果标签被使用且不是强制删除，则返回错误
            if (usageCount > 0 && !force) {
                return ResponseEntity.status(HttpStatus.CONFLICT).body(
                        new DeleteTagResponse(false, "标签正在被使用，无法删除。请使用force=true强制删除")
                );
            }

            // 如果是强制删除，先删除关联关系
            if (force && usageCount > 0) {
                String deleteRelationsSql = "";
                if ("document_tags".equals(tableName)) {
                    deleteRelationsSql = "DELETE FROM document_tag_relations WHERE tag_id = ?";
                } else {
                    deleteRelationsSql = "DELETE FROM user_vocabulary_tags WHERE tag_id = ?";
                }
                jdbcTemplate.update(deleteRelationsSql, Integer.parseInt(tagId));
            }

            // 删除标签
            String deleteSql = "DELETE FROM " + tableName + " WHERE tag_id = ?";
            int deleted = jdbcTemplate.update(deleteSql, Integer.parseInt(tagId));

            if (deleted == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new DeleteTagResponse(false, "标签删除失败")
                );
            }

            // 创建响应
            DeleteTagResponse response = new DeleteTagResponse(true, "标签删除成功");
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (NumberFormatException e) {
            System.err.println("标签ID格式错误: " + e.getMessage());
            return ResponseEntity.badRequest().body(
                    new DeleteTagResponse(false, "标签ID格式错误")
            );
        } catch (Exception e) {
            System.err.println("删除标签过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new DeleteTagResponse(false, "服务器内部错误: " + e.getMessage())
            );
        }
    }
}

--- 结束文件: TagDelete.java ---

--- 开始文件: TagDeleteDocumentTag.java ---
package com.vue.readingapp.tags;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.Map;

@RestController
@RequestMapping("/api/v1/tags/document")
public class TagDeleteDocumentTag {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到删除文档标签请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=========================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应类
    public static class DeleteDocumentTagResponse {
        private boolean success;
        private String message;

        public DeleteDocumentTagResponse(boolean success, String message) {
            this.success = success;
            this.message = message;
        }

        // Getters and Setters
        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }
    }

    @DeleteMapping("/{tagId}")
    public ResponseEntity<DeleteDocumentTagResponse> deleteDocumentTag(@PathVariable("tagId") String tagId) {
        printRequest(tagId);

        try {
            // 检查标签是否存在
            String checkSql = "SELECT COUNT(*) FROM document_tags WHERE tag_id = ?";
            int count = jdbcTemplate.queryForObject(checkSql, Integer.class, Integer.parseInt(tagId));
            if (count == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new DeleteDocumentTagResponse(false, "文档标签不存在")
                );
            }

            // 检查标签是否被使用
            String usageCheckSql = "SELECT COUNT(*) FROM document_tag_relations WHERE tag_id = ?";
            int usageCount = jdbcTemplate.queryForObject(usageCheckSql, Integer.class, Integer.parseInt(tagId));

            if (usageCount > 0) {
                return ResponseEntity.status(HttpStatus.CONFLICT).body(
                        new DeleteDocumentTagResponse(false, "文档标签正在被使用，无法删除")
                );
            }

            // 删除文档标签
            String deleteSql = "DELETE FROM document_tags WHERE tag_id = ?";
            int deleted = jdbcTemplate.update(deleteSql, Integer.parseInt(tagId));

            if (deleted == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new DeleteDocumentTagResponse(false, "文档标签删除失败")
                );
            }

            // 创建响应
            DeleteDocumentTagResponse response = new DeleteDocumentTagResponse(true, "文档标签删除成功");
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (NumberFormatException e) {
            System.err.println("标签ID格式错误: " + e.getMessage());
            return ResponseEntity.badRequest().body(
                    new DeleteDocumentTagResponse(false, "标签ID格式错误")
            );
        } catch (Exception e) {
            System.err.println("删除文档标签过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new DeleteDocumentTagResponse(false, "服务器内部错误: " + e.getMessage())
            );
        }
    }
}

--- 结束文件: TagDeleteDocumentTag.java ---

--- 开始文件: TagDeleteVocabularyTag.java ---
package com.vue.readingapp.tags;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.Map;

@RestController
@RequestMapping("/api/v1/tags/vocabulary")
public class TagDeleteVocabularyTag {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到删除生词标签请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=========================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应类
    public static class DeleteVocabularyTagResponse {
        private boolean success;
        private String message;

        public DeleteVocabularyTagResponse(boolean success, String message) {
            this.success = success;
            this.message = message;
        }

        // Getters and Setters
        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }
    }

    @DeleteMapping("/{tagId}")
    public ResponseEntity<DeleteVocabularyTagResponse> deleteVocabularyTag(@PathVariable("tagId") String tagId) {
        printRequest(tagId);

        try {
            // 检查标签是否存在
            String checkSql = "SELECT COUNT(*) FROM vocabulary_tags WHERE tag_id = ?";
            int count = jdbcTemplate.queryForObject(checkSql, Integer.class, Integer.parseInt(tagId));
            if (count == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new DeleteVocabularyTagResponse(false, "生词标签不存在")
                );
            }

            // 检查标签是否被使用
            String usageCheckSql = "SELECT COUNT(*) FROM user_vocabulary_tags WHERE tag_id = ?";
            int usageCount = jdbcTemplate.queryForObject(usageCheckSql, Integer.class, Integer.parseInt(tagId));

            if (usageCount > 0) {
                return ResponseEntity.status(HttpStatus.CONFLICT).body(
                        new DeleteVocabularyTagResponse(false, "生词标签正在被使用，无法删除")
                );
            }

            // 删除生词标签
            String deleteSql = "DELETE FROM vocabulary_tags WHERE tag_id = ?";
            int deleted = jdbcTemplate.update(deleteSql, Integer.parseInt(tagId));

            if (deleted == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new DeleteVocabularyTagResponse(false, "生词标签删除失败")
                );
            }

            // 创建响应
            DeleteVocabularyTagResponse response = new DeleteVocabularyTagResponse(true, "生词标签删除成功");
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (NumberFormatException e) {
            System.err.println("标签ID格式错误: " + e.getMessage());
            return ResponseEntity.badRequest().body(
                    new DeleteVocabularyTagResponse(false, "标签ID格式错误")
            );
        } catch (Exception e) {
            System.err.println("删除生词标签过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new DeleteVocabularyTagResponse(false, "服务器内部错误: " + e.getMessage())
            );
        }
    }
}

--- 结束文件: TagDeleteVocabularyTag.java ---

--- 开始文件: TagGetAll.java ---
package com.vue.readingapp.tags;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Map;
import java.util.HashMap;

@RestController
@RequestMapping("/api/v1/tags")
public class TagGetAll {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取所有标签请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 标签实体类
    public static class Tag {
        private String id;
        private String name;
        private String color;
        private String description;
        private String type;
        private int documentCount;
        private String createdAt;
        private String updatedAt;

        public Tag() {}

        public Tag(String id, String name, String color, String description, String type,
                   int documentCount, String createdAt, String updatedAt) {
            this.id = id;
            this.name = name;
            this.color = color;
            this.description = description;
            this.type = type;
            this.documentCount = documentCount;
            this.createdAt = createdAt;
            this.updatedAt = updatedAt;
        }

        // Getters and Setters
        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public int getDocumentCount() { return documentCount; }
        public void setDocumentCount(int documentCount) { this.documentCount = documentCount; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }
    }

    // 分页信息类
    public static class Pagination {
        private int page;
        private int limit;
        private int total;

        public Pagination(int page, int limit, int total) {
            this.page = page;
            this.limit = limit;
            this.total = total;
        }

        // Getters and Setters
        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public int getLimit() { return limit; }
        public void setLimit(int limit) { this.limit = limit; }

        public int getTotal() { return total; }
        public void setTotal(int total) { this.total = total; }
    }

    // 响应类
    public static class TagResponse {
        private boolean success;
        private List<Tag> data;
        private Pagination pagination;

        public TagResponse(boolean success, List<Tag> data, Pagination pagination) {
            this.success = success;
            this.data = data;
            this.pagination = pagination;
        }

        // Getters and Setters
        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public List<Tag> getData() { return data; }
        public void setData(List<Tag> data) { this.data = data; }

        public Pagination getPagination() { return pagination; }
        public void setPagination(Pagination pagination) { this.pagination = pagination; }
    }

    @GetMapping("/")
    public ResponseEntity<TagResponse> getAllTags(
            @RequestParam(value = "page", defaultValue = "1") int page,
            @RequestParam(value = "limit", defaultValue = "20") int limit,
            @RequestParam(value = "sort", defaultValue = "name") String sort,
            @RequestParam(value = "order", defaultValue = "asc") String order,
            @RequestParam(value = "type", defaultValue = "all") String type) {

        // 打印请求参数
        Map<String, Object> requestParams = new HashMap<>();
        requestParams.put("page", page);
        requestParams.put("limit", limit);
        requestParams.put("sort", sort);
        requestParams.put("order", order);
        requestParams.put("type", type);
        printRequest(requestParams);

        try {
            // 验证页码和限制
            if (page < 1) {
                page = 1;
            }
            if (limit < 1 || limit > 100) {
                limit = 20;
            }

            // 计算偏移量
            int offset = (page - 1) * limit;

            // 构建基础查询
            StringBuilder queryBuilder = new StringBuilder();
            queryBuilder.append("SELECT * FROM document_tags WHERE 1=1");

            // 添加类型筛选
            if (!"all".equals(type)) {
                queryBuilder.append(" AND tag_type = ?");
            }

            // 添加排序
            String orderBy = "tag_name";
            if ("createdAt".equals(sort)) {
                orderBy = "created_at";
            } else if ("updatedAt".equals(sort)) {
                orderBy = "updated_at";
            }

            queryBuilder.append(" ORDER BY ").append(orderBy);
            queryBuilder.append(" ").append("asc".equalsIgnoreCase(order) ? "ASC" : "DESC");
            queryBuilder.append(" LIMIT ? OFFSET ?");

            // 查询标签数据
            List<Tag> tags;
            if (!"all".equals(type)) {
                tags = jdbcTemplate.query(queryBuilder.toString(),
                        new Object[]{type, limit, offset},
                        new RowMapper<Tag>() {
                            @Override
                            public Tag mapRow(ResultSet rs, int rowNum) throws SQLException {
                                Tag tag = new Tag();
                                tag.setId(String.valueOf(rs.getInt("tag_id")));
                                tag.setName(rs.getString("tag_name"));
                                tag.setColor(rs.getString("color"));
                                tag.setDescription(rs.getString("description"));
                                tag.setType(rs.getString("tag_type"));
                                tag.setCreatedAt(rs.getTimestamp("created_at").toString());
                                tag.setUpdatedAt(rs.getTimestamp("updated_at").toString());

                                // 查询文档数量
                                String countSql = "SELECT COUNT(*) FROM document_tag_relations WHERE tag_id = ?";
                                int count = jdbcTemplate.queryForObject(countSql, Integer.class, rs.getInt("tag_id"));
                                tag.setDocumentCount(count);

                                return tag;
                            }
                        });
            } else {
                tags = jdbcTemplate.query(queryBuilder.toString(),
                        new Object[]{limit, offset},
                        new RowMapper<Tag>() {
                            @Override
                            public Tag mapRow(ResultSet rs, int rowNum) throws SQLException {
                                Tag tag = new Tag();
                                tag.setId(String.valueOf(rs.getInt("tag_id")));
                                tag.setName(rs.getString("tag_name"));
                                tag.setColor(rs.getString("color"));
                                tag.setDescription(rs.getString("description"));
                                tag.setType(rs.getString("tag_type"));
                                tag.setCreatedAt(rs.getTimestamp("created_at").toString());
                                tag.setUpdatedAt(rs.getTimestamp("updated_at").toString());

                                // 查询文档数量
                                String countSql = "SELECT COUNT(*) FROM document_tag_relations WHERE tag_id = ?";
                                int count = jdbcTemplate.queryForObject(countSql, Integer.class, rs.getInt("tag_id"));
                                tag.setDocumentCount(count);

                                return tag;
                            }
                        });
            }

            printQueryResult(tags);

            // 查询总数
            String countQuery = "SELECT COUNT(*) FROM document_tags";
            if (!"all".equals(type)) {
                countQuery += " WHERE tag_type = ?";
            }

            int total;
            if (!"all".equals(type)) {
                total = jdbcTemplate.queryForObject(countQuery, Integer.class, type);
            } else {
                total = jdbcTemplate.queryForObject(countQuery, Integer.class);
            }

            // 创建分页信息
            Pagination pagination = new Pagination(page, limit, total);

            // 创建响应
            TagResponse response = new TagResponse(true, tags, pagination);

            // 打印返回数据
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取标签列表过程中发生错误: " + e.getMessage());
            e.printStackTrace();

            // 返回错误响应
            TagResponse errorResponse = new TagResponse(false, null, null);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(errorResponse);
        }
    }
}

--- 结束文件: TagGetAll.java ---

--- 开始文件: TagGetDetail.java ---
package com.vue.readingapp.tags;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.Map;
import java.util.List;
import java.util.ArrayList;

@RestController
@RequestMapping("/api/v1/tags")
public class TagGetDetail {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取标签详情请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 文档DTO
    public static class Document {
        private String id;
        private String title;
        private String createdAt;

        // Getters and Setters
        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getTitle() { return title; }
        public void setTitle(String title) { this.title = title; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }
    }

    // 标签响应DTO
    public static class Tag {
        private String id;
        private String name;
        private String color;
        private String description;
        private String type;
        private int documentCount;
        private String createdAt;
        private String updatedAt;
        private List<Document> documents;

        // Getters and Setters
        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public int getDocumentCount() { return documentCount; }
        public void setDocumentCount(int documentCount) { this.documentCount = documentCount; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }

        public List<Document> getDocuments() { return documents; }
        public void setDocuments(List<Document> documents) { this.documents = documents; }
    }

    // 响应类
    public static class TagDetailResponse {
        private boolean success;
        private Tag data;

        public TagDetailResponse(boolean success, Tag data) {
            this.success = success;
            this.data = data;
        }

        // Getters and Setters
        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public Tag getData() { return data; }
        public void setData(Tag data) { this.data = data; }
    }

    @GetMapping("/{tagId}")
    public ResponseEntity<TagDetailResponse> getTagDetail(@PathVariable("tagId") String tagId) {
        printRequest(tagId);

        try {
            // 先检查标签是否存在（在document_tags中）
            String checkSql = "SELECT * FROM document_tags WHERE tag_id = ?";
            List<Map<String, Object>> results = jdbcTemplate.queryForList(checkSql, Integer.parseInt(tagId));

            String tableName = "document_tags";
            if (results.isEmpty()) {
                // 如果在document_tags中不存在，检查vocabulary_tags
                checkSql = "SELECT * FROM vocabulary_tags WHERE tag_id = ?";
                results = jdbcTemplate.queryForList(checkSql, Integer.parseInt(tagId));
                if (results.isEmpty()) {
                    return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                            new TagDetailResponse(false, null)
                    );
                }
                tableName = "vocabulary_tags";
            }

            Map<String, Object> tagMap = results.get(0);
            printQueryResult(tagMap);

            // 构建标签对象
            Tag tag = new Tag();
            tag.setId(String.valueOf(tagMap.get("tag_id")));
            tag.setName((String) tagMap.get("tag_name"));
            tag.setColor((String) tagMap.get("color"));
            tag.setDescription((String) tagMap.get("description"));
            tag.setType("document".equals(tableName) ? "document" : "vocabulary");
            tag.setCreatedAt(tagMap.get("created_at").toString());
            tag.setUpdatedAt(tagMap.get("updated_at").toString());

            // 查询关联的文档（如果是文档标签）
            if ("document_tags".equals(tableName)) {
                // 查询文档数量
                String countSql = "SELECT COUNT(*) FROM document_tag_relations WHERE tag_id = ?";
                int docCount = jdbcTemplate.queryForObject(countSql, Integer.class, Integer.parseInt(tagId));
                tag.setDocumentCount(docCount);

                // 查询关联的文档详情
                String docSql = "SELECT d.document_id, d.title, d.created_at " +
                        "FROM documents d " +
                        "JOIN document_tag_relations r ON d.document_id = r.document_id " +
                        "WHERE r.tag_id = ? " +
                        "ORDER BY d.created_at DESC " +
                        "LIMIT 10";

                List<Map<String, Object>> docResults = jdbcTemplate.queryForList(docSql, Integer.parseInt(tagId));
                List<Document> documents = new ArrayList<>();

                for (Map<String, Object> docMap : docResults) {
                    Document doc = new Document();
                    doc.setId(String.valueOf(docMap.get("document_id")));
                    doc.setTitle((String) docMap.get("title"));
                    doc.setCreatedAt(docMap.get("created_at").toString());
                    documents.add(doc);
                }

                tag.setDocuments(documents);
            } else {
                tag.setDocumentCount(0);
                tag.setDocuments(new ArrayList<>());
            }

            // 创建响应
            TagDetailResponse response = new TagDetailResponse(true, tag);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (NumberFormatException e) {
            System.err.println("标签ID格式错误: " + e.getMessage());
            return ResponseEntity.badRequest().body(
                    new TagDetailResponse(false, null)
            );
        } catch (Exception e) {
            System.err.println("获取标签详情过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new TagDetailResponse(false, null)
            );
        }
    }
}

--- 结束文件: TagGetDetail.java ---

--- 开始文件: TagGetDocumentTagById.java ---
package com.vue.readingapp.tags;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.Map;
import java.util.List;
import java.util.ArrayList;

@RestController
@RequestMapping("/api/v1/tags/document")
public class TagGetDocumentTagById {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取文档标签详情请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=============================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 文档DTO
    public static class Document {
        private String id;
        private String title;
        private String createdAt;

        // Getters and Setters
        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getTitle() { return title; }
        public void setTitle(String title) { this.title = title; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }
    }

    // 标签响应DTO
    public static class Tag {
        private String id;
        private String name;
        private String color;
        private String description;
        private String type;
        private int documentCount;
        private String createdAt;
        private String updatedAt;
        private List<Document> documents;

        // Getters and Setters
        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public int getDocumentCount() { return documentCount; }
        public void setDocumentCount(int documentCount) { this.documentCount = documentCount; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }

        public List<Document> getDocuments() { return documents; }
        public void setDocuments(List<Document> documents) { this.documents = documents; }
    }

    // 响应类
    public static class DocumentTagDetailResponse {
        private boolean success;
        private Tag data;

        public DocumentTagDetailResponse(boolean success, Tag data) {
            this.success = success;
            this.data = data;
        }

        // Getters and Setters
        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public Tag getData() { return data; }
        public void setData(Tag data) { this.data = data; }
    }

    @GetMapping("/{tagId}")
    public ResponseEntity<DocumentTagDetailResponse> getDocumentTagById(@PathVariable("tagId") String tagId) {
        printRequest(tagId);

        try {
            // 查询文档标签
            String sql = "SELECT * FROM document_tags WHERE tag_id = ?";
            List<Map<String, Object>> results = jdbcTemplate.queryForList(sql, Integer.parseInt(tagId));

            if (results.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new DocumentTagDetailResponse(false, null)
                );
            }

            Map<String, Object> tagMap = results.get(0);
            printQueryResult(tagMap);

            // 构建标签对象
            Tag tag = new Tag();
            tag.setId(String.valueOf(tagMap.get("tag_id")));
            tag.setName((String) tagMap.get("tag_name"));
            tag.setColor((String) tagMap.get("color"));
            tag.setDescription((String) tagMap.get("description"));
            tag.setType("document");
            tag.setCreatedAt(tagMap.get("created_at").toString());
            tag.setUpdatedAt(tagMap.get("updated_at").toString());

            // 查询关联的文档数量
            String countSql = "SELECT COUNT(*) FROM document_tag_relations WHERE tag_id = ?";
            int docCount = jdbcTemplate.queryForObject(countSql, Integer.class, Integer.parseInt(tagId));
            tag.setDocumentCount(docCount);

            // 查询关联的文档详情
            String docSql = "SELECT d.document_id, d.title, d.created_at " +
                    "FROM documents d " +
                    "JOIN document_tag_relations r ON d.document_id = r.document_id " +
                    "WHERE r.tag_id = ? " +
                    "ORDER BY d.created_at DESC " +
                    "LIMIT 10";

            List<Map<String, Object>> docResults = jdbcTemplate.queryForList(docSql, Integer.parseInt(tagId));
            List<Document> documents = new ArrayList<>();

            for (Map<String, Object> docMap : docResults) {
                Document doc = new Document();
                doc.setId(String.valueOf(docMap.get("document_id")));
                doc.setTitle((String) docMap.get("title"));
                doc.setCreatedAt(docMap.get("created_at").toString());
                documents.add(doc);
            }

            tag.setDocuments(documents);

            // 创建响应
            DocumentTagDetailResponse response = new DocumentTagDetailResponse(true, tag);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (NumberFormatException e) {
            System.err.println("标签ID格式错误: " + e.getMessage());
            return ResponseEntity.badRequest().body(
                    new DocumentTagDetailResponse(false, null)
            );
        } catch (Exception e) {
            System.err.println("获取文档标签详情过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new DocumentTagDetailResponse(false, null)
            );
        }
    }
}

--- 结束文件: TagGetDocumentTagById.java ---

--- 开始文件: TagGetDocumentTags.java ---
package com.vue.readingapp.tags;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.List;
import java.util.Map;
import java.util.HashMap;

@RestController
@RequestMapping("/api/v1/documents")
public class TagGetDocumentTags {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取文档标签请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("=========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 标签实体类
    public static class Tag {
        private String id;
        private String name;
        private String color;
        private String description;
        private String type;
        private String createdAt;

        public Tag() {}

        public Tag(String id, String name, String color, String description, String type, String createdAt) {
            this.id = id;
            this.name = name;
            this.color = color;
            this.description = description;
            this.type = type;
            this.createdAt = createdAt;
        }

        // Getters and Setters
        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }
    }

    // 响应类
    public static class DocumentTagsResponse {
        private boolean success;
        private List<Tag> data;

        public DocumentTagsResponse(boolean success, List<Tag> data) {
            this.success = success;
            this.data = data;
        }

        // Getters and Setters
        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public List<Tag> getData() { return data; }
        public void setData(List<Tag> data) { this.data = data; }
    }

    @GetMapping("/{documentId}/tags")
    public ResponseEntity<DocumentTagsResponse> getDocumentTags(@PathVariable("documentId") String documentId) {
        printRequest(documentId);

        try {
            // 验证文档是否存在
            String checkDocumentSql = "SELECT COUNT(*) FROM documents WHERE document_id = ?";
            int documentCount = jdbcTemplate.queryForObject(checkDocumentSql, Integer.class, Integer.parseInt(documentId));
            if (documentCount == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new DocumentTagsResponse(false, null)
                );
            }

            // 查询文档的所有标签
            String sql =
                    "SELECT dt.tag_id, dt.tag_name, dt.color, dt.description, dt.created_at " +
                            "FROM document_tags dt " +
                            "JOIN document_tag_relations dtr ON dt.tag_id = dtr.tag_id " +
                            "WHERE dtr.document_id = ? " +
                            "ORDER BY dt.tag_name";

            List<Tag> tags = jdbcTemplate.query(sql,
                    new Object[]{Integer.parseInt(documentId)},
                    new RowMapper<Tag>() {
                        @Override
                        public Tag mapRow(ResultSet rs, int rowNum) throws SQLException {
                            Tag tag = new Tag();
                            tag.setId(String.valueOf(rs.getInt("tag_id")));
                            tag.setName(rs.getString("tag_name"));
                            tag.setColor(rs.getString("color"));
                            tag.setDescription(rs.getString("description"));
                            tag.setType("document");
                            tag.setCreatedAt(rs.getTimestamp("created_at").toString());
                            return tag;
                        }
                    });

            printQueryResult(tags);

            // 创建响应
            DocumentTagsResponse response = new DocumentTagsResponse(true, tags);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (NumberFormatException e) {
            System.err.println("文档ID格式错误: " + e.getMessage());
            return ResponseEntity.badRequest().body(
                    new DocumentTagsResponse(false, null)
            );
        } catch (Exception e) {
            System.err.println("获取文档标签过程中发生错误: " + e.getMessage());
            e.printStackTrace();

            // 返回错误响应
            DocumentTagsResponse errorResponse = new DocumentTagsResponse(false, null);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(errorResponse);
        }
    }
}

--- 结束文件: TagGetDocumentTags.java ---

--- 开始文件: TagGetPopular.java ---
package com.vue.readingapp.tags;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.List;
import java.util.Map;
import java.util.ArrayList;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

@RestController
@RequestMapping("/api/v1/tags")
public class TagGetPopular {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取热门标签请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=========================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 标签响应DTO
    public static class Tag {
        private String id;
        private String name;
        private String color;
        private String type;
        private int documentCount;
        private int usageCount;

        // Getters and Setters
        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public int getDocumentCount() { return documentCount; }
        public void setDocumentCount(int documentCount) { this.documentCount = documentCount; }

        public int getUsageCount() { return usageCount; }
        public void setUsageCount(int usageCount) { this.usageCount = usageCount; }
    }

    // 响应类
    public static class PopularTagsResponse {
        private boolean success;
        private List<Tag> data;

        public PopularTagsResponse(boolean success, List<Tag> data) {
            this.success = success;
            this.data = data;
        }

        // Getters and Setters
        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public List<Tag> getData() { return data; }
        public void setData(List<Tag> data) { this.data = data; }
    }

    @GetMapping("/popular")
    public ResponseEntity<PopularTagsResponse> getPopularTags(
            @RequestParam(value = "limit", defaultValue = "10") int limit,
            @RequestParam(value = "timeRange", defaultValue = "month") String timeRange) {

        Map<String, Object> requestData = new java.util.HashMap<>();
        requestData.put("limit", limit);
        requestData.put("timeRange", timeRange);
        printRequest(requestData);

        try {
            // 验证参数
            if (limit < 1 || limit > 50) {
                limit = 10;
            }

            // 计算时间范围
            LocalDateTime startDate = calculateStartDate(timeRange);

            // 查询热门文档标签（按使用次数排序）
            String popularDocTagsSql =
                    "SELECT dt.tag_id, dt.tag_name, dt.color, COUNT(dtr.relation_id) as usage_count " +
                            "FROM document_tags dt " +
                            "LEFT JOIN document_tag_relations dtr ON dt.tag_id = dtr.tag_id " +
                            "LEFT JOIN documents d ON dtr.document_id = d.document_id " +
                            "WHERE d.created_at >= ? OR d.created_at IS NULL " +
                            "GROUP BY dt.tag_id, dt.tag_name, dt.color " +
                            "ORDER BY usage_count DESC " +
                            "LIMIT ?";

            List<Map<String, Object>> docResults = jdbcTemplate.queryForList(
                    popularDocTagsSql, startDate, limit);

            List<Tag> popularTags = new ArrayList<>();

            for (Map<String, Object> result : docResults) {
                Tag tag = new Tag();
                tag.setId(String.valueOf(result.get("tag_id")));
                tag.setName((String) result.get("tag_name"));
                tag.setColor((String) result.get("color"));
                tag.setType("document");
                tag.setUsageCount(((Number) result.get("usage_count")).intValue());

                // 查询文档数量
                String countSql = "SELECT COUNT(*) FROM document_tag_relations WHERE tag_id = ?";
                int docCount = jdbcTemplate.queryForObject(countSql, Integer.class, result.get("tag_id"));
                tag.setDocumentCount(docCount);

                popularTags.add(tag);
            }

            // 如果文档标签不够，补充词汇标签
            if (popularTags.size() < limit) {
                int remaining = limit - popularTags.size();

                String popularVocabTagsSql =
                        "SELECT vt.tag_id, vt.tag_name, vt.color, COUNT(uvt.relation_id) as usage_count " +
                                "FROM vocabulary_tags vt " +
                                "LEFT JOIN user_vocabulary_tags uvt ON vt.tag_id = uvt.tag_id " +
                                "GROUP BY vt.tag_id, vt.tag_name, vt.color " +
                                "ORDER BY usage_count DESC " +
                                "LIMIT ?";

                List<Map<String, Object>> vocabResults = jdbcTemplate.queryForList(
                        popularVocabTagsSql, remaining);

                for (Map<String, Object> result : vocabResults) {
                    Tag tag = new Tag();
                    tag.setId(String.valueOf(result.get("tag_id")));
                    tag.setName((String) result.get("tag_name"));
                    tag.setColor((String) result.get("color"));
                    tag.setType("vocabulary");
                    tag.setUsageCount(((Number) result.get("usage_count")).intValue());
                    tag.setDocumentCount(0);

                    popularTags.add(tag);
                }
            }

            printQueryResult(popularTags);

            // 创建响应
            PopularTagsResponse response = new PopularTagsResponse(true, popularTags);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取热门标签过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new PopularTagsResponse(false, new ArrayList<>())
            );
        }
    }

    // 计算开始日期
    private LocalDateTime calculateStartDate(String timeRange) {
        LocalDateTime now = LocalDateTime.now();

        switch (timeRange.toLowerCase()) {
            case "day":
                return now.minusDays(1);
            case "week":
                return now.minusWeeks(1);
            case "month":
                return now.minusMonths(1);
            case "year":
                return now.minusYears(1);
            default:
                return now.minusMonths(1); // 默认一个月
        }
    }
}

--- 结束文件: TagGetPopular.java ---

--- 开始文件: TagGetStatistics.java ---
package com.vue.readingapp.tags;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.Map;
import java.util.HashMap;

@RestController
@RequestMapping("/api/v1/tags")
public class TagGetStatistics {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取标签统计信息请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("=============================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 最常用标签DTO
    public static class MostUsedTag {
        private String id;
        private String name;
        private int usageCount;

        public MostUsedTag() {}

        public MostUsedTag(String id, String name, int usageCount) {
            this.id = id;
            this.name = name;
            this.usageCount = usageCount;
        }

        // Getters and Setters
        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public int getUsageCount() { return usageCount; }
        public void setUsageCount(int usageCount) { this.usageCount = usageCount; }
    }

    // 标签分布DTO
    public static class TagDistribution {
        private int document;
        private int vocabulary;

        public TagDistribution() {}

        public TagDistribution(int document, int vocabulary) {
            this.document = document;
            this.vocabulary = vocabulary;
        }

        // Getters and Setters
        public int getDocument() { return document; }
        public void setDocument(int document) { this.document = document; }

        public int getVocabulary() { return vocabulary; }
        public void setVocabulary(int vocabulary) { this.vocabulary = vocabulary; }
    }

    // 统计信息DTO
    public static class StatisticsData {
        private int totalTags;
        private int documentTags;
        private int vocabularyTags;
        private MostUsedTag mostUsedTag;
        private TagDistribution tagDistribution;

        public StatisticsData() {}

        public StatisticsData(int totalTags, int documentTags, int vocabularyTags,
                              MostUsedTag mostUsedTag, TagDistribution tagDistribution) {
            this.totalTags = totalTags;
            this.documentTags = documentTags;
            this.vocabularyTags = vocabularyTags;
            this.mostUsedTag = mostUsedTag;
            this.tagDistribution = tagDistribution;
        }

        // Getters and Setters
        public int getTotalTags() { return totalTags; }
        public void setTotalTags(int totalTags) { this.totalTags = totalTags; }

        public int getDocumentTags() { return documentTags; }
        public void setDocumentTags(int documentTags) { this.documentTags = documentTags; }

        public int getVocabularyTags() { return vocabularyTags; }
        public void setVocabularyTags(int vocabularyTags) { this.vocabularyTags = vocabularyTags; }

        public MostUsedTag getMostUsedTag() { return mostUsedTag; }
        public void setMostUsedTag(MostUsedTag mostUsedTag) { this.mostUsedTag = mostUsedTag; }

        public TagDistribution getTagDistribution() { return tagDistribution; }
        public void setTagDistribution(TagDistribution tagDistribution) { this.tagDistribution = tagDistribution; }
    }

    // 响应类
    public static class StatisticsResponse {
        private boolean success;
        private StatisticsData data;

        public StatisticsResponse(boolean success, StatisticsData data) {
            this.success = success;
            this.data = data;
        }

        // Getters and Setters
        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public StatisticsData getData() { return data; }
        public void setData(StatisticsData data) { this.data = data; }
    }

    @GetMapping("/statistics")
    public ResponseEntity<StatisticsResponse> getTagStatistics(
            @RequestParam(value = "type", defaultValue = "all") String type,
            @RequestParam(value = "timeRange", defaultValue = "month") String timeRange) {

        // 打印请求参数
        Map<String, Object> requestParams = new HashMap<>();
        requestParams.put("type", type);
        requestParams.put("timeRange", timeRange);
        printRequest(requestParams);

        try {
            // 查询文档标签总数
            String docTagCountSql = "SELECT COUNT(*) FROM document_tags";
            int documentTags = jdbcTemplate.queryForObject(docTagCountSql, Integer.class);

            // 查询词汇标签总数
            String vocabTagCountSql = "SELECT COUNT(*) FROM vocabulary_tags";
            int vocabularyTags = jdbcTemplate.queryForObject(vocabTagCountSql, Integer.class);

            // 计算总标签数
            int totalTags = documentTags + vocabularyTags;

            // 查询最常用的文档标签
            String mostUsedDocTagSql =
                    "SELECT dt.tag_id, dt.tag_name, COUNT(dtr.relation_id) as usage_count " +
                            "FROM document_tags dt " +
                            "LEFT JOIN document_tag_relations dtr ON dt.tag_id = dtr.tag_id " +
                            "GROUP BY dt.tag_id, dt.tag_name " +
                            "ORDER BY usage_count DESC " +
                            "LIMIT 1";

            MostUsedTag mostUsedTag = null;
            try {
                Map<String, Object> mostUsedTagMap = jdbcTemplate.queryForMap(mostUsedDocTagSql);
                mostUsedTag = new MostUsedTag(
                        String.valueOf(mostUsedTagMap.get("tag_id")),
                        (String) mostUsedTagMap.get("tag_name"),
                        ((Number) mostUsedTagMap.get("usage_count")).intValue()
                );
            } catch (Exception e) {
                // 如果没有文档标签，尝试查询词汇标签
                String mostUsedVocabTagSql =
                        "SELECT vt.tag_id, vt.tag_name, COUNT(uvt.relation_id) as usage_count " +
                                "FROM vocabulary_tags vt " +
                                "LEFT JOIN user_vocabulary_tags uvt ON vt.tag_id = uvt.tag_id " +
                                "GROUP BY vt.tag_id, vt.tag_name " +
                                "ORDER BY usage_count DESC " +
                                "LIMIT 1";

                try {
                    Map<String, Object> mostUsedTagMap = jdbcTemplate.queryForMap(mostUsedVocabTagSql);
                    mostUsedTag = new MostUsedTag(
                            String.valueOf(mostUsedTagMap.get("tag_id")),
                            (String) mostUsedTagMap.get("tag_name"),
                            ((Number) mostUsedTagMap.get("usage_count")).intValue()
                    );
                } catch (Exception ex) {
                    // 如果没有标签，创建一个空的
                    mostUsedTag = new MostUsedTag("0", "无标签", 0);
                }
            }

            // 创建标签分布
            TagDistribution tagDistribution = new TagDistribution(documentTags, vocabularyTags);

            // 创建统计信息
            StatisticsData statisticsData = new StatisticsData(
                    totalTags, documentTags, vocabularyTags, mostUsedTag, tagDistribution
            );

            printQueryResult(statisticsData);

            // 创建响应
            StatisticsResponse response = new StatisticsResponse(true, statisticsData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取标签统计信息过程中发生错误: " + e.getMessage());
            e.printStackTrace();

            // 返回错误响应
            StatisticsResponse errorResponse = new StatisticsResponse(false, null);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(errorResponse);
        }
    }
}

--- 结束文件: TagGetStatistics.java ---

--- 开始文件: TagGetVocabularyTagById.java ---
package com.vue.readingapp.tags;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.Map;
import java.util.List;
import java.util.ArrayList;

@RestController
@RequestMapping("/api/v1/tags/vocabulary")
public class TagGetVocabularyTagById {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取生词标签详情请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=============================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 词汇DTO
    public static class Vocabulary {
        private String id;
        private String word;
        private String createdAt;

        // Getters and Setters
        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getWord() { return word; }
        public void setWord(String word) { this.word = word; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }
    }

    // 标签响应DTO
    public static class Tag {
        private String id;
        private String name;
        private String color;
        private String description;
        private String type;
        private int vocabularyCount;
        private String createdAt;
        private String updatedAt;
        private List<Vocabulary> vocabularies;

        // Getters and Setters
        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public int getVocabularyCount() { return vocabularyCount; }
        public void setVocabularyCount(int vocabularyCount) { this.vocabularyCount = vocabularyCount; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }

        public List<Vocabulary> getVocabularies() { return vocabularies; }
        public void setVocabularies(List<Vocabulary> vocabularies) { this.vocabularies = vocabularies; }
    }

    // 响应类
    public static class VocabularyTagDetailResponse {
        private boolean success;
        private Tag data;

        public VocabularyTagDetailResponse(boolean success, Tag data) {
            this.success = success;
            this.data = data;
        }

        // Getters and Setters
        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public Tag getData() { return data; }
        public void setData(Tag data) { this.data = data; }
    }

    @GetMapping("/{tagId}")
    public ResponseEntity<VocabularyTagDetailResponse> getVocabularyTagById(@PathVariable("tagId") String tagId) {
        printRequest(tagId);

        try {
            // 查询生词标签
            String sql = "SELECT * FROM vocabulary_tags WHERE tag_id = ?";
            List<Map<String, Object>> results = jdbcTemplate.queryForList(sql, Integer.parseInt(tagId));

            if (results.isEmpty()) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new VocabularyTagDetailResponse(false, null)
                );
            }

            Map<String, Object> tagMap = results.get(0);
            printQueryResult(tagMap);

            // 构建标签对象
            Tag tag = new Tag();
            tag.setId(String.valueOf(tagMap.get("tag_id")));
            tag.setName((String) tagMap.get("tag_name"));
            tag.setColor((String) tagMap.get("color"));
            tag.setDescription((String) tagMap.get("description"));
            tag.setType("vocabulary");
            tag.setCreatedAt(tagMap.get("created_at").toString());
            tag.setUpdatedAt(tagMap.get("updated_at").toString());

            // 查询关联的词汇数量
            String countSql = "SELECT COUNT(*) FROM user_vocabulary_tags WHERE tag_id = ?";
            int vocabCount = jdbcTemplate.queryForObject(countSql, Integer.class, Integer.parseInt(tagId));
            tag.setVocabularyCount(vocabCount);

            // 查询关联的词汇详情
            String vocabSql = "SELECT uv.user_vocabulary_id, w.word, uv.created_at " +
                    "FROM user_vocabulary uv " +
                    "JOIN words w ON uv.word_id = w.word_id " +
                    "JOIN user_vocabulary_tags uvt ON uv.user_vocabulary_id = uvt.user_vocabulary_id " +
                    "WHERE uvt.tag_id = ? " +
                    "ORDER BY uv.created_at DESC " +
                    "LIMIT 10";

            List<Map<String, Object>> vocabResults = jdbcTemplate.queryForList(vocabSql, Integer.parseInt(tagId));
            List<Vocabulary> vocabularies = new ArrayList<>();

            for (Map<String, Object> vocabMap : vocabResults) {
                Vocabulary vocab = new Vocabulary();
                vocab.setId(String.valueOf(vocabMap.get("user_vocabulary_id")));
                vocab.setWord((String) vocabMap.get("word"));
                vocab.setCreatedAt(vocabMap.get("created_at").toString());
                vocabularies.add(vocab);
            }

            tag.setVocabularies(vocabularies);

            // 创建响应
            VocabularyTagDetailResponse response = new VocabularyTagDetailResponse(true, tag);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (NumberFormatException e) {
            System.err.println("标签ID格式错误: " + e.getMessage());
            return ResponseEntity.badRequest().body(
                    new VocabularyTagDetailResponse(false, null)
            );
        } catch (Exception e) {
            System.err.println("获取生词标签详情过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new VocabularyTagDetailResponse(false, null)
            );
        }
    }
}

--- 结束文件: TagGetVocabularyTagById.java ---

--- 开始文件: TagGetVocabularyTags.java ---

package com.vue.readingapp.tags;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.jdbc.core.RowMapper;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.List;
import java.util.Map;
import java.util.HashMap;

@RestController
@RequestMapping("/api/v1/tags/vocabulary")
public class TagGetVocabularyTags {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到获取生词标签列表请求 ===");
        System.out.println("请求参数: " + request);
        System.out.println("=============================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 标签实体类
    public static class Tag {
        private String id;
        private String name;
        private String color;
        private String description;
        private String type;
        private int vocabularyCount;
        private String createdAt;

        public Tag() {}

        public Tag(String id, String name, String color, String description, String type,
                   int vocabularyCount, String createdAt) {
            this.id = id;
            this.name = name;
            this.color = color;
            this.description = description;
            this.type = type;
            this.vocabularyCount = vocabularyCount;
            this.createdAt = createdAt;
        }

        // Getters and Setters
        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public int getVocabularyCount() { return vocabularyCount; }
        public void setVocabularyCount(int vocabularyCount) { this.vocabularyCount = vocabularyCount; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }
    }

    // 分页信息类
    public static class Pagination {
        private int page;
        private int limit;
        private int total;

        public Pagination(int page, int limit, int total) {
            this.page = page;
            this.limit = limit;
            this.total = total;
        }

        // Getters and Setters
        public int getPage() { return page; }
        public void setPage(int page) { this.page = page; }

        public int getLimit() { return limit; }
        public void setLimit(int limit) { this.limit = limit; }

        public int getTotal() { return total; }
        public void setTotal(int total) { this.total = total; }
    }

    // 响应类
    public static class VocabularyTagsResponse {
        private boolean success;
        private List<Tag> data;
        private Pagination pagination;

        public VocabularyTagsResponse(boolean success, List<Tag> data, Pagination pagination) {
            this.success = success;
            this.data = data;
            this.pagination = pagination;
        }

        // Getters and Setters
        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public List<Tag> getData() { return data; }
        public void setData(List<Tag> data) { this.data = data; }

        public Pagination getPagination() { return pagination; }
        public void setPagination(Pagination pagination) { this.pagination = pagination; }
    }

    @GetMapping("/")
    public ResponseEntity<VocabularyTagsResponse> getVocabularyTags(
            @RequestParam(value = "page", defaultValue = "1") int page,
            @RequestParam(value = "limit", defaultValue = "20") int limit,
            @RequestParam(value = "sort", defaultValue = "name") String sort,
            @RequestParam(value = "order", defaultValue = "asc") String order) {

        // 打印请求参数
        Map<String, Object> requestParams = new HashMap<>();
        requestParams.put("page", page);
        requestParams.put("limit", limit);
        requestParams.put("sort", sort);
        requestParams.put("order", order);
        printRequest(requestParams);

        try {
            // 验证页码和限制
            if (page < 1) {
                page = 1;
            }
            if (limit < 1 || limit > 100) {
                limit = 20;
            }

            // 计算偏移量
            int offset = (page - 1) * limit;

            // 构建查询
            StringBuilder queryBuilder = new StringBuilder();
            queryBuilder.append("SELECT * FROM vocabulary_tags WHERE 1=1");

            // 添加排序
            String orderBy = "tag_name";
            if ("createdAt".equals(sort)) {
                orderBy = "created_at";
            }

            queryBuilder.append(" ORDER BY ").append(orderBy);
            queryBuilder.append(" ").append("asc".equalsIgnoreCase(order) ? "ASC" : "DESC");
            queryBuilder.append(" LIMIT ? OFFSET ?");

            // 查询标签数据
            List<Tag> tags = jdbcTemplate.query(queryBuilder.toString(),
                    new Object[]{limit, offset},
                    new RowMapper<Tag>() {
                        @Override
                        public Tag mapRow(ResultSet rs, int rowNum) throws SQLException {
                            Tag tag = new Tag();
                            tag.setId(String.valueOf(rs.getInt("tag_id")));
                            tag.setName(rs.getString("tag_name"));
                            tag.setColor(rs.getString("color"));
                            tag.setDescription(rs.getString("description"));
                            tag.setType("vocabulary");
                            tag.setCreatedAt(rs.getTimestamp("created_at").toString());

                            // 查询词汇数量
                            String countSql = "SELECT COUNT(*) FROM user_vocabulary_tags WHERE tag_id = ?";
                            int count = jdbcTemplate.queryForObject(countSql, Integer.class, rs.getInt("tag_id"));
                            tag.setVocabularyCount(count);

                            return tag;
                        }
                    });

            printQueryResult(tags);

            // 查询总数
            String countQuery = "SELECT COUNT(*) FROM vocabulary_tags";
            int total = jdbcTemplate.queryForObject(countQuery, Integer.class);

            // 创建分页信息
            Pagination pagination = new Pagination(page, limit, total);

            // 创建响应
            VocabularyTagsResponse response = new VocabularyTagsResponse(true, tags, pagination);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("获取生词标签列表过程中发生错误: " + e.getMessage());
            e.printStackTrace();

            // 返回错误响应
            VocabularyTagsResponse errorResponse = new VocabularyTagsResponse(false, null, null);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(errorResponse);
        }
    }
}
--- 结束文件: TagGetVocabularyTags.java ---

--- 开始文件: TagMerge.java ---

package com.vue.readingapp.tags;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.Map;

@RestController
@RequestMapping("/api/v1/tags")
public class TagMerge {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到合并标签请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=====================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class MergeTagsRequest {
        private String sourceTagId;
        private String targetTagId;

        // Getters and Setters
        public String getSourceTagId() { return sourceTagId; }
        public void setSourceTagId(String sourceTagId) { this.sourceTagId = sourceTagId; }

        public String getTargetTagId() { return targetTagId; }
        public void setTargetTagId(String targetTagId) { this.targetTagId = targetTagId; }
    }

    // 响应类
    public static class MergeTagsResponse {
        private boolean success;
        private String message;
        private Map<String, Object> data;

        public MergeTagsResponse(boolean success, String message, Map<String, Object> data) {
            this.success = success;
            this.message = message;
            this.data = data;
        }

        // Getters and Setters
        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }

        public Map<String, Object> getData() { return data; }
        public void setData(Map<String, Object> data) { this.data = data; }
    }

    @PostMapping("/merge")
    public ResponseEntity<MergeTagsResponse> mergeTags(@RequestBody MergeTagsRequest request) {
        printRequest(request);

        try {
            // 验证请求数据
            if (request.getSourceTagId() == null || request.getSourceTagId().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new MergeTagsResponse(false, "源标签ID不能为空", null)
                );
            }

            if (request.getTargetTagId() == null || request.getTargetTagId().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new MergeTagsResponse(false, "目标标签ID不能为空", null)
                );
            }

            if (request.getSourceTagId().equals(request.getTargetTagId())) {
                return ResponseEntity.badRequest().body(
                        new MergeTagsResponse(false, "源标签和目标标签不能相同", null)
                );
            }

            int sourceId = Integer.parseInt(request.getSourceTagId());
            int targetId = Integer.parseInt(request.getTargetTagId());

            // 检查两个标签是否存在且类型相同
            String checkSourceSql = "SELECT tag_type FROM (SELECT 'document' as tag_type FROM document_tags WHERE tag_id = ? " +
                    "UNION ALL SELECT 'vocabulary' as tag_type FROM vocabulary_tags WHERE tag_id = ?) as t LIMIT 1";
            String sourceType = null;
            try {
                sourceType = jdbcTemplate.queryForObject(checkSourceSql, String.class, sourceId, sourceId);
            } catch (Exception e) {
                // 标签不存在
            }

            if (sourceType == null) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new MergeTagsResponse(false, "源标签不存在", null)
                );
            }

            String checkTargetSql = "SELECT tag_type FROM (SELECT 'document' as tag_type FROM document_tags WHERE tag_id = ? " +
                    "UNION ALL SELECT 'vocabulary' as tag_type FROM vocabulary_tags WHERE tag_id = ?) as t LIMIT 1";
            String targetType = null;
            try {
                targetType = jdbcTemplate.queryForObject(checkTargetSql, String.class, targetId, targetId);
            } catch (Exception e) {
                // 标签不存在
            }

            if (targetType == null) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new MergeTagsResponse(false, "目标标签不存在", null)
                );
            }

            if (!sourceType.equals(targetType)) {
                return ResponseEntity.badRequest().body(
                        new MergeTagsResponse(false, "标签类型不同，无法合并", null)
                );
            }

            int mergedCount = 0;

            // 根据标签类型执行合并操作
            if ("document".equals(sourceType)) {
                // 合并文档标签
                // 1. 更新document_tag_relations表，将源标签的关系转移到目标标签
                String updateRelationsSql =
                        "UPDATE document_tag_relations SET tag_id = ? WHERE tag_id = ? " +
                                "AND NOT EXISTS (SELECT 1 FROM document_tag_relations WHERE document_id = document_tag_relations.document_id AND tag_id = ?)";

                mergedCount = jdbcTemplate.update(updateRelationsSql, targetId, sourceId, targetId);

                // 2. 删除源标签的剩余关系（重复关系）
                String deleteDuplicateSql = "DELETE FROM document_tag_relations WHERE tag_id = ?";
                jdbcTemplate.update(deleteDuplicateSql, sourceId);

                // 3. 删除源标签
                String deleteSourceSql = "DELETE FROM document_tags WHERE tag_id = ?";
                jdbcTemplate.update(deleteSourceSql, sourceId);
            } else {
                // 合并词汇标签
                // 1. 更新user_vocabulary_tags表，将源标签的关系转移到目标标签
                String updateRelationsSql =
                        "UPDATE user_vocabulary_tags SET tag_id = ? WHERE tag_id = ? " +
                                "AND NOT EXISTS (SELECT 1 FROM user_vocabulary_tags WHERE user_vocabulary_id = user_vocabulary_tags.user_vocabulary_id AND tag_id = ?)";

                mergedCount = jdbcTemplate.update(updateRelationsSql, targetId, sourceId, targetId);

                // 2. 删除源标签的剩余关系（重复关系）
                String deleteDuplicateSql = "DELETE FROM user_vocabulary_tags WHERE tag_id = ?";
                jdbcTemplate.update(deleteDuplicateSql, sourceId);

                // 3. 删除源标签
                String deleteSourceSql = "DELETE FROM vocabulary_tags WHERE tag_id = ?";
                jdbcTemplate.update(deleteSourceSql, sourceId);
            }

            // 创建响应数据
            Map<String, Object> responseData = new java.util.HashMap<>();
            responseData.put("sourceTagId", request.getSourceTagId());
            responseData.put("targetTagId", request.getTargetTagId());
            responseData.put("mergedCount", mergedCount);

            // 创建响应
            MergeTagsResponse response = new MergeTagsResponse(
                    true, "标签合并成功", responseData);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (NumberFormatException e) {
            System.err.println("标签ID格式错误: " + e.getMessage());
            return ResponseEntity.badRequest().body(
                    new MergeTagsResponse(false, "标签ID格式错误", null)
            );
        } catch (Exception e) {
            System.err.println("合并标签过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new MergeTagsResponse(false, "服务器内部错误: " + e.getMessage(), null)
            );
        }
    }
}
--- 结束文件: TagMerge.java ---

--- 开始文件: TagRemoveFromDocument.java ---
package com.vue.readingapp.tags;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.Map;

@RestController
@RequestMapping("/api/v1/documents")
public class TagRemoveFromDocument {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到从文档移除标签请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("===========================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 响应类
    public static class RemoveTagFromDocumentResponse {
        private boolean success;
        private String message;

        public RemoveTagFromDocumentResponse(boolean success, String message) {
            this.success = success;
            this.message = message;
        }

        // Getters and Setters
        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public String getMessage() { return message; }
        public void setMessage(String message) { this.message = message; }
    }

    @DeleteMapping("/{documentId}/tags/{tagId}")
    public ResponseEntity<RemoveTagFromDocumentResponse> removeTagFromDocument(
            @PathVariable("documentId") String documentId,
            @PathVariable("tagId") String tagId) {

        Map<String, Object> requestData = new java.util.HashMap<>();
        requestData.put("documentId", documentId);
        requestData.put("tagId", tagId);
        printRequest(requestData);

        try {
            // 验证文档是否存在
            String checkDocumentSql = "SELECT COUNT(*) FROM documents WHERE document_id = ?";
            int documentCount = jdbcTemplate.queryForObject(checkDocumentSql, Integer.class, Integer.parseInt(documentId));
            if (documentCount == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new RemoveTagFromDocumentResponse(false, "文档不存在")
                );
            }

            // 验证标签是否存在（在document_tags中）
            String checkTagSql = "SELECT COUNT(*) FROM document_tags WHERE tag_id = ?";
            int tagCount = jdbcTemplate.queryForObject(checkTagSql, Integer.class, Integer.parseInt(tagId));
            if (tagCount == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new RemoveTagFromDocumentResponse(false, "标签不存在")
                );
            }

            // 检查是否存在该关系
            String checkRelationSql = "SELECT COUNT(*) FROM document_tag_relations WHERE document_id = ? AND tag_id = ?";
            int relationCount = jdbcTemplate.queryForObject(checkRelationSql, Integer.class,
                    Integer.parseInt(documentId), Integer.parseInt(tagId));

            if (relationCount == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new RemoveTagFromDocumentResponse(false, "该标签未添加到文档")
                );
            }

            // 从文档移除标签
            String deleteSql = "DELETE FROM document_tag_relations WHERE document_id = ? AND tag_id = ?";
            int deleted = jdbcTemplate.update(deleteSql,
                    Integer.parseInt(documentId), Integer.parseInt(tagId));

            if (deleted == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new RemoveTagFromDocumentResponse(false, "标签移除失败")
                );
            }

            // 创建响应
            RemoveTagFromDocumentResponse response = new RemoveTagFromDocumentResponse(true, "标签移除成功");
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (NumberFormatException e) {
            System.err.println("ID格式错误: " + e.getMessage());
            return ResponseEntity.badRequest().body(
                    new RemoveTagFromDocumentResponse(false, "ID格式错误")
            );
        } catch (Exception e) {
            System.err.println("从文档移除标签过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new RemoveTagFromDocumentResponse(false, "服务器内部错误: " + e.getMessage())
            );
        }
    }
}

--- 结束文件: TagRemoveFromDocument.java ---

--- 开始文件: TagSearch.java ---
package com.vue.readingapp.tags;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.util.List;
import java.util.Map;
import java.util.ArrayList;

@RestController
@RequestMapping("/api/v1/tags")
public class TagSearch {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到搜索标签请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=====================");
    }

    // 打印查询结果
    private void printQueryResult(Object result) {
        System.out.println("=== 数据库查询结果 ===");
        System.out.println("查询结果: " + result);
        System.out.println("===================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 标签响应DTO
    public static class Tag {
        private String id;
        private String name;
        private String color;
        private String description;
        private String type;
        private int documentCount;
        private double relevanceScore;

        // Getters and Setters
        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public int getDocumentCount() { return documentCount; }
        public void setDocumentCount(int documentCount) { this.documentCount = documentCount; }

        public double getRelevanceScore() { return relevanceScore; }
        public void setRelevanceScore(double relevanceScore) { this.relevanceScore = relevanceScore; }
    }

    // 响应类
    public static class TagSearchResponse {
        private boolean success;
        private List<Tag> data;

        public TagSearchResponse(boolean success, List<Tag> data) {
            this.success = success;
            this.data = data;
        }

        // Getters and Setters
        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public List<Tag> getData() { return data; }
        public void setData(List<Tag> data) { this.data = data; }
    }

    @GetMapping("/search")
    public ResponseEntity<TagSearchResponse> searchTags(
            @RequestParam("query") String query,
            @RequestParam(value = "type", defaultValue = "all") String type) {

        Map<String, Object> requestData = new java.util.HashMap<>();
        requestData.put("query", query);
        requestData.put("type", type);
        printRequest(requestData);

        try {
            // 验证查询参数
            if (query == null || query.trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new TagSearchResponse(false, new ArrayList<>())
                );
            }

            // 构建搜索条件
            String searchPattern = "%" + query + "%";
            List<Tag> allTags = new ArrayList<>();

            // 搜索文档标签
            if ("all".equals(type) || "document".equals(type)) {
                String docSql = "SELECT * FROM document_tags WHERE tag_name LIKE ? OR description LIKE ?";
                List<Map<String, Object>> docResults = jdbcTemplate.queryForList(docSql, searchPattern, searchPattern);

                for (Map<String, Object> tagMap : docResults) {
                    Tag tag = new Tag();
                    tag.setId(String.valueOf(tagMap.get("tag_id")));
                    tag.setName((String) tagMap.get("tag_name"));
                    tag.setColor((String) tagMap.get("color"));
                    tag.setDescription((String) tagMap.get("description"));
                    tag.setType("document");

                    // 查询文档数量
                    String countSql = "SELECT COUNT(*) FROM document_tag_relations WHERE tag_id = ?";
                    int docCount = jdbcTemplate.queryForObject(countSql, Integer.class, tagMap.get("tag_id"));
                    tag.setDocumentCount(docCount);

                    // 计算相关性分数（简单实现：名称匹配度）
                    double relevance = calculateRelevance(query, (String) tagMap.get("tag_name"), (String) tagMap.get("description"));
                    tag.setRelevanceScore(relevance);

                    allTags.add(tag);
                }
            }

            // 搜索词汇标签
            if ("all".equals(type) || "vocabulary".equals(type)) {
                String vocabSql = "SELECT * FROM vocabulary_tags WHERE tag_name LIKE ? OR description LIKE ?";
                List<Map<String, Object>> vocabResults = jdbcTemplate.queryForList(vocabSql, searchPattern, searchPattern);

                for (Map<String, Object> tagMap : vocabResults) {
                    Tag tag = new Tag();
                    tag.setId(String.valueOf(tagMap.get("tag_id")));
                    tag.setName((String) tagMap.get("tag_name"));
                    tag.setColor((String) tagMap.get("color"));
                    tag.setDescription((String) tagMap.get("description"));
                    tag.setType("vocabulary");
                    tag.setDocumentCount(0);

                    // 计算相关性分数
                    double relevance = calculateRelevance(query, (String) tagMap.get("tag_name"), (String) tagMap.get("description"));
                    tag.setRelevanceScore(relevance);

                    allTags.add(tag);
                }
            }

            printQueryResult(allTags);

            // 按相关性分数排序
            allTags.sort((a, b) -> Double.compare(b.getRelevanceScore(), a.getRelevanceScore()));

            // 创建响应
            TagSearchResponse response = new TagSearchResponse(true, allTags);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (Exception e) {
            System.err.println("搜索标签过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new TagSearchResponse(false, new ArrayList<>())
            );
        }
    }

    // 计算相关性分数（简单实现）
    private double calculateRelevance(String query, String name, String description) {
        double score = 0.0;

        // 名称完全匹配
        if (name.equalsIgnoreCase(query)) {
            score += 1.0;
        }
        // 名称包含查询词
        else if (name.toLowerCase().contains(query.toLowerCase())) {
            score += 0.8;
        }
        // 描述包含查询词
        else if (description != null && description.toLowerCase().contains(query.toLowerCase())) {
            score += 0.3;
        }

        return score;
    }
}

--- 结束文件: TagSearch.java ---

--- 开始文件: TagUpdate.java ---
package com.vue.readingapp.tags;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.Timestamp;
import java.time.LocalDateTime;
import java.util.Map;

@RestController
@RequestMapping("/api/v1/tags")
public class TagUpdate {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到更新标签请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=====================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class UpdateTagRequest {
        private String name;
        private String color;
        private String description;

        // Getters and Setters
        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }
    }

    // 标签响应DTO
    public static class Tag {
        private String id;
        private String name;
        private String color;
        private String description;
        private String type;
        private int documentCount;
        private String createdAt;
        private String updatedAt;

        // Getters and Setters
        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public int getDocumentCount() { return documentCount; }
        public void setDocumentCount(int documentCount) { this.documentCount = documentCount; }

        public String getCreatedAt() { return createdAt; }
        public void setCreatedAt(String createdAt) { this.createdAt = createdAt; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }
    }

    // 响应类
    public static class UpdateTagResponse {
        private boolean success;
        private Tag data;

        public UpdateTagResponse(boolean success, Tag data) {
            this.success = success;
            this.data = data;
        }

        // Getters and Setters
        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public Tag getData() { return data; }
        public void setData(Tag data) { this.data = data; }
    }

    @PutMapping("/{tagId}")
    public ResponseEntity<UpdateTagResponse> updateTag(
            @PathVariable("tagId") String tagId,
            @RequestBody UpdateTagRequest request) {

        Map<String, Object> requestData = new java.util.HashMap<>();
        requestData.put("tagId", tagId);
        requestData.put("request", request);
        printRequest(requestData);

        try {
            // 验证请求数据
            if (request.getName() == null || request.getName().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new UpdateTagResponse(false, null)
                );
            }

            // 先检查标签是否存在（在document_tags中）
            String checkSql = "SELECT COUNT(*) FROM document_tags WHERE tag_id = ?";
            int count = jdbcTemplate.queryForObject(checkSql, Integer.class, Integer.parseInt(tagId));

            String tableName = "document_tags";
            if (count == 0) {
                // 如果在document_tags中不存在，检查vocabulary_tags
                checkSql = "SELECT COUNT(*) FROM vocabulary_tags WHERE tag_id = ?";
                count = jdbcTemplate.queryForObject(checkSql, Integer.class, Integer.parseInt(tagId));
                if (count == 0) {
                    return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                            new UpdateTagResponse(false, null)
                    );
                }
                tableName = "vocabulary_tags";
            }

            // 检查新名称是否与其他标签冲突（在同一表中）
            String nameCheckSql = "SELECT COUNT(*) FROM " + tableName + " WHERE tag_name = ? AND tag_id != ?";
            int nameCount = jdbcTemplate.queryForObject(nameCheckSql, Integer.class,
                    request.getName(), Integer.parseInt(tagId));

            if (nameCount > 0) {
                return ResponseEntity.status(HttpStatus.CONFLICT).body(
                        new UpdateTagResponse(false, null)
                );
            }

            // 更新标签
            LocalDateTime now = LocalDateTime.now();
            Timestamp timestamp = Timestamp.valueOf(now);

            String updateSql = "UPDATE " + tableName + " SET tag_name = ?, color = ?, description = ?, updated_at = ? WHERE tag_id = ?";
            int updated = jdbcTemplate.update(updateSql,
                    request.getName(),
                    request.getColor(),
                    request.getDescription(),
                    timestamp,
                    Integer.parseInt(tagId)
            );

            if (updated == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new UpdateTagResponse(false, null)
                );
            }

            // 查询更新后的标签
            String selectSql = "SELECT * FROM " + tableName + " WHERE tag_id = ?";
            Map<String, Object> tagMap = jdbcTemplate.queryForMap(selectSql, Integer.parseInt(tagId));

            // 构建返回的标签对象
            Tag tag = new Tag();
            tag.setId(String.valueOf(tagMap.get("tag_id")));
            tag.setName((String) tagMap.get("tag_name"));
            tag.setColor((String) tagMap.get("color"));
            tag.setDescription((String) tagMap.get("description"));
            tag.setType("document".equals(tableName) ? "document" : "vocabulary");

            // 查询文档数量（如果是文档标签）
            if ("document_tags".equals(tableName)) {
                String countSql = "SELECT COUNT(*) FROM document_tag_relations WHERE tag_id = ?";
                int docCount = jdbcTemplate.queryForObject(countSql, Integer.class, Integer.parseInt(tagId));
                tag.setDocumentCount(docCount);
            } else {
                tag.setDocumentCount(0);
            }

            tag.setCreatedAt(tagMap.get("created_at").toString());
            tag.setUpdatedAt(tagMap.get("updated_at").toString());

            // 创建响应
            UpdateTagResponse response = new UpdateTagResponse(true, tag);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (NumberFormatException e) {
            System.err.println("标签ID格式错误: " + e.getMessage());
            return ResponseEntity.badRequest().body(
                    new UpdateTagResponse(false, null)
            );
        } catch (Exception e) {
            System.err.println("更新标签过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdateTagResponse(false, null)
            );
        }
    }
}

--- 结束文件: TagUpdate.java ---

--- 开始文件: TagUpdateDocumentTag.java ---
package com.vue.readingapp.tags;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.Timestamp;
import java.time.LocalDateTime;
import java.util.Map;

@RestController
@RequestMapping("/api/v1/tags/document")
public class TagUpdateDocumentTag {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到更新文档标签请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=========================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class UpdateDocumentTagRequest {
        private String name;
        private String color;
        private String description;

        // Getters and Setters
        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }
    }

    // 标签响应DTO
    public static class Tag {
        private String id;
        private String name;
        private String color;
        private String description;
        private String type;
        private int documentCount;
        private String updatedAt;

        // Getters and Setters
        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public int getDocumentCount() { return documentCount; }
        public void setDocumentCount(int documentCount) { this.documentCount = documentCount; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }
    }

    // 响应类
    public static class UpdateDocumentTagResponse {
        private boolean success;
        private Tag data;

        public UpdateDocumentTagResponse(boolean success, Tag data) {
            this.success = success;
            this.data = data;
        }

        // Getters and Setters
        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public Tag getData() { return data; }
        public void setData(Tag data) { this.data = data; }
    }

    @PutMapping("/{tagId}")
    public ResponseEntity<UpdateDocumentTagResponse> updateDocumentTag(
            @PathVariable("tagId") String tagId,
            @RequestBody UpdateDocumentTagRequest request) {

        Map<String, Object> requestData = new java.util.HashMap<>();
        requestData.put("tagId", tagId);
        requestData.put("request", request);
        printRequest(requestData);

        try {
            // 验证请求数据
            if (request.getName() == null || request.getName().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new UpdateDocumentTagResponse(false, null)
                );
            }

            // 检查标签是否存在
            String checkSql = "SELECT COUNT(*) FROM document_tags WHERE tag_id = ?";
            int count = jdbcTemplate.queryForObject(checkSql, Integer.class, Integer.parseInt(tagId));
            if (count == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new UpdateDocumentTagResponse(false, null)
                );
            }

            // 检查新名称是否与其他标签冲突
            String nameCheckSql = "SELECT COUNT(*) FROM document_tags WHERE tag_name = ? AND tag_id != ?";
            int nameCount = jdbcTemplate.queryForObject(nameCheckSql, Integer.class,
                    request.getName(), Integer.parseInt(tagId));

            if (nameCount > 0) {
                return ResponseEntity.status(HttpStatus.CONFLICT).body(
                        new UpdateDocumentTagResponse(false, null)
                );
            }

            // 更新文档标签
            LocalDateTime now = LocalDateTime.now();
            Timestamp timestamp = Timestamp.valueOf(now);

            String updateSql = "UPDATE document_tags SET tag_name = ?, color = ?, description = ?, updated_at = ? WHERE tag_id = ?";
            int updated = jdbcTemplate.update(updateSql,
                    request.getName(),
                    request.getColor(),
                    request.getDescription(),
                    timestamp,
                    Integer.parseInt(tagId)
            );

            if (updated == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new UpdateDocumentTagResponse(false, null)
                );
            }

            // 查询更新后的标签
            String selectSql = "SELECT * FROM document_tags WHERE tag_id = ?";
            Map<String, Object> tagMap = jdbcTemplate.queryForMap(selectSql, Integer.parseInt(tagId));

            // 查询文档数量
            String countSql = "SELECT COUNT(*) FROM document_tag_relations WHERE tag_id = ?";
            int docCount = jdbcTemplate.queryForObject(countSql, Integer.class, Integer.parseInt(tagId));

            // 构建返回的标签对象
            Tag tag = new Tag();
            tag.setId(String.valueOf(tagMap.get("tag_id")));
            tag.setName((String) tagMap.get("tag_name"));
            tag.setColor((String) tagMap.get("color"));
            tag.setDescription((String) tagMap.get("description"));
            tag.setType("document");
            tag.setDocumentCount(docCount);
            tag.setUpdatedAt(tagMap.get("updated_at").toString());

            // 创建响应
            UpdateDocumentTagResponse response = new UpdateDocumentTagResponse(true, tag);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (NumberFormatException e) {
            System.err.println("标签ID格式错误: " + e.getMessage());
            return ResponseEntity.badRequest().body(
                    new UpdateDocumentTagResponse(false, null)
            );
        } catch (Exception e) {
            System.err.println("更新文档标签过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdateDocumentTagResponse(false, null)
            );
        }
    }
}

--- 结束文件: TagUpdateDocumentTag.java ---

--- 开始文件: TagUpdateVocabularyTag.java ---
package com.vue.readingapp.tags;

import org.springframework.web.bind.annotation.*;
import org.springframework.http.ResponseEntity;
import org.springframework.http.HttpStatus;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import java.sql.Timestamp;
import java.time.LocalDateTime;
import java.util.Map;

@RestController
@RequestMapping("/api/v1/tags/vocabulary")
public class TagUpdateVocabularyTag {

    @Autowired
    private JdbcTemplate jdbcTemplate;

    // 打印接收到的请求
    private void printRequest(Object request) {
        System.out.println("=== 收到更新生词标签请求 ===");
        System.out.println("请求数据: " + request);
        System.out.println("=========================");
    }

    // 打印返回数据
    private void printResponse(Object response) {
        System.out.println("=== 准备返回的响应 ===");
        System.out.println("响应数据: " + response);
        System.out.println("===================");
    }

    // 请求DTO
    public static class UpdateVocabularyTagRequest {
        private String name;
        private String color;
        private String description;

        // Getters and Setters
        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }
    }

    // 标签响应DTO
    public static class Tag {
        private String id;
        private String name;
        private String color;
        private String description;
        private String type;
        private int vocabularyCount;
        private String updatedAt;

        // Getters and Setters
        public String getId() { return id; }
        public void setId(String id) { this.id = id; }

        public String getName() { return name; }
        public void setName(String name) { this.name = name; }

        public String getColor() { return color; }
        public void setColor(String color) { this.color = color; }

        public String getDescription() { return description; }
        public void setDescription(String description) { this.description = description; }

        public String getType() { return type; }
        public void setType(String type) { this.type = type; }

        public int getVocabularyCount() { return vocabularyCount; }
        public void setVocabularyCount(int vocabularyCount) { this.vocabularyCount = vocabularyCount; }

        public String getUpdatedAt() { return updatedAt; }
        public void setUpdatedAt(String updatedAt) { this.updatedAt = updatedAt; }
    }

    // 响应类
    public static class UpdateVocabularyTagResponse {
        private boolean success;
        private Tag data;

        public UpdateVocabularyTagResponse(boolean success, Tag data) {
            this.success = success;
            this.data = data;
        }

        // Getters and Setters
        public boolean isSuccess() { return success; }
        public void setSuccess(boolean success) { this.success = success; }

        public Tag getData() { return data; }
        public void setData(Tag data) { this.data = data; }
    }

    @PutMapping("/{tagId}")
    public ResponseEntity<UpdateVocabularyTagResponse> updateVocabularyTag(
            @PathVariable("tagId") String tagId,
            @RequestBody UpdateVocabularyTagRequest request) {

        Map<String, Object> requestData = new java.util.HashMap<>();
        requestData.put("tagId", tagId);
        requestData.put("request", request);
        printRequest(requestData);

        try {
            // 验证请求数据
            if (request.getName() == null || request.getName().trim().isEmpty()) {
                return ResponseEntity.badRequest().body(
                        new UpdateVocabularyTagResponse(false, null)
                );
            }

            // 检查标签是否存在
            String checkSql = "SELECT COUNT(*) FROM vocabulary_tags WHERE tag_id = ?";
            int count = jdbcTemplate.queryForObject(checkSql, Integer.class, Integer.parseInt(tagId));
            if (count == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new UpdateVocabularyTagResponse(false, null)
                );
            }

            // 检查新名称是否与其他标签冲突
            String nameCheckSql = "SELECT COUNT(*) FROM vocabulary_tags WHERE tag_name = ? AND tag_id != ?";
            int nameCount = jdbcTemplate.queryForObject(nameCheckSql, Integer.class,
                    request.getName(), Integer.parseInt(tagId));

            if (nameCount > 0) {
                return ResponseEntity.status(HttpStatus.CONFLICT).body(
                        new UpdateVocabularyTagResponse(false, null)
                );
            }

            // 更新生词标签
            LocalDateTime now = LocalDateTime.now();
            Timestamp timestamp = Timestamp.valueOf(now);

            String updateSql = "UPDATE vocabulary_tags SET tag_name = ?, color = ?, description = ?, updated_at = ? WHERE tag_id = ?";
            int updated = jdbcTemplate.update(updateSql,
                    request.getName(),
                    request.getColor(),
                    request.getDescription(),
                    timestamp,
                    Integer.parseInt(tagId)
            );

            if (updated == 0) {
                return ResponseEntity.status(HttpStatus.NOT_FOUND).body(
                        new UpdateVocabularyTagResponse(false, null)
                );
            }

            // 查询更新后的标签
            String selectSql = "SELECT * FROM vocabulary_tags WHERE tag_id = ?";
            Map<String, Object> tagMap = jdbcTemplate.queryForMap(selectSql, Integer.parseInt(tagId));

            // 查询词汇数量
            String countSql = "SELECT COUNT(*) FROM user_vocabulary_tags WHERE tag_id = ?";
            int vocabCount = jdbcTemplate.queryForObject(countSql, Integer.class, Integer.parseInt(tagId));

            // 构建返回的标签对象
            Tag tag = new Tag();
            tag.setId(String.valueOf(tagMap.get("tag_id")));
            tag.setName((String) tagMap.get("tag_name"));
            tag.setColor((String) tagMap.get("color"));
            tag.setDescription((String) tagMap.get("description"));
            tag.setType("vocabulary");
            tag.setVocabularyCount(vocabCount);
            tag.setUpdatedAt(tagMap.get("updated_at").toString());

            // 创建响应
            UpdateVocabularyTagResponse response = new UpdateVocabularyTagResponse(true, tag);
            printResponse(response);

            return ResponseEntity.ok(response);

        } catch (NumberFormatException e) {
            System.err.println("标签ID格式错误: " + e.getMessage());
            return ResponseEntity.badRequest().body(
                    new UpdateVocabularyTagResponse(false, null)
            );
        } catch (Exception e) {
            System.err.println("更新生词标签过程中发生错误: " + e.getMessage());
            e.printStackTrace();
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).body(
                    new UpdateVocabularyTagResponse(false, null)
            );
        }
    }
}

--- 结束文件: TagUpdateVocabularyTag.java ---

